From c1669b236b00da0acd69842d21b7912a0a55e1c1 Mon Sep 17 00:00:00 2001
From: Shanavas M <shanavas.m2@gmail.com>
Date: Thu, 3 Jan 2019 11:48:57 +0530
Subject: [PATCH 001/297] Add ThreadState::current_buffer_unchecked method

This will make ThreadState::current_buffer method to return an Option
which is useful for null check
---
 rust_src/src/base64.rs     |  4 +--
 rust_src/src/buffers.rs    | 22 ++++++++++-------
 rust_src/src/callproc.rs   |  2 +-
 rust_src/src/casefiddle.rs |  2 +-
 rust_src/src/casetab.rs    |  2 +-
 rust_src/src/category.rs   |  2 +-
 rust_src/src/character.rs  |  2 +-
 rust_src/src/cmds.rs       | 12 ++++-----
 rust_src/src/crypto/mod.rs |  4 +--
 rust_src/src/data.rs       |  4 +--
 rust_src/src/decompress.rs |  2 +-
 rust_src/src/editfns.rs    | 50 +++++++++++++++++++-------------------
 rust_src/src/fileio.rs     |  4 +--
 rust_src/src/keymap.rs     |  4 +--
 rust_src/src/lread.rs      |  2 +-
 rust_src/src/marker.rs     | 14 +++++------
 rust_src/src/minibuf.rs    | 12 ++++++---
 rust_src/src/syntax.rs     |  6 ++---
 rust_src/src/threads.rs    |  8 +++++-
 rust_src/src/windows.rs    |  2 +-
 20 files changed, 88 insertions(+), 72 deletions(-)

diff --git a/rust_src/src/base64.rs b/rust_src/src/base64.rs
index 9c4d77c94a..c1e733798a 100644
--- a/rust_src/src/base64.rs
+++ b/rust_src/src/base64.rs
@@ -259,7 +259,7 @@ pub fn base64_encode_region(
     no_line_break: bool,
 ) -> EmacsInt {
     unsafe { validate_region(&mut beg, &mut end) };
-    let mut current_buffer = ThreadState::current_buffer();
+    let mut current_buffer = ThreadState::current_buffer_unchecked();
     let old_pos = current_buffer.pt;
 
     let ibeg = beg.as_natnum_or_error() as isize;
@@ -303,7 +303,7 @@ pub fn base64_encode_region(
 pub fn base64_decode_region(mut beg: LispObject, mut end: LispObject) -> EmacsInt {
     unsafe { validate_region(&mut beg, &mut end) };
 
-    let mut current_buffer = ThreadState::current_buffer();
+    let mut current_buffer = ThreadState::current_buffer_unchecked();
     let mut old_pos = current_buffer.pt;
 
     let ibeg = beg.as_natnum_or_error() as isize;
diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 422d46e535..56876feb69 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -52,7 +52,7 @@ pub const BEG_BYTE: ptrdiff_t = 1;
 /// Return value of point, in bytes, as an integer.
 /// Beginning of buffer is position (point-min).
 pub fn point_byte() -> EmacsInt {
-    let buffer_ref = ThreadState::current_buffer();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
     buffer_ref.pt_byte as EmacsInt
 }
 
@@ -60,7 +60,7 @@ pub fn point_byte() -> EmacsInt {
 /// buffer.  This is 1, unless narrowing (a buffer restriction) is in
 /// effect.
 pub fn point_min_byte() -> EmacsInt {
-    ThreadState::current_buffer().begv_byte as EmacsInt
+    ThreadState::current_buffer_unchecked().begv_byte as EmacsInt
 }
 
 /// Maximum number of bytes in a buffer.
@@ -529,7 +529,10 @@ pub enum LispBufferOrName {
 impl LispBufferOrName {
     pub fn as_buffer_or_current_buffer(self) -> Option<LispBufferRef> {
         let obj = LispObject::from(self);
-        obj.map_or_else(|| Some(ThreadState::current_buffer()), |o| o.as_buffer())
+        obj.map_or_else(
+            || Some(ThreadState::current_buffer_unchecked()),
+            |o| o.as_buffer(),
+        )
     }
 }
 
@@ -616,7 +619,7 @@ impl From<LispBufferOrCurrent> for LispBufferRef {
     fn from(buffer: LispBufferOrCurrent) -> LispBufferRef {
         match buffer {
             LispBufferOrCurrent::Buffer(buf) => buf,
-            LispBufferOrCurrent::Current => ThreadState::current_buffer(),
+            LispBufferOrCurrent::Current => ThreadState::current_buffer_unchecked(),
         }
     }
 }
@@ -767,7 +770,7 @@ pub unsafe extern "C" fn validate_region(b: *mut LispObject, e: *mut LispObject)
     *b = LispObject::from(beg);
     *e = LispObject::from(end);
 
-    let buf = ThreadState::current_buffer();
+    let buf = ThreadState::current_buffer_unchecked();
     let begv = buf.begv as EmacsInt;
     let zv = buf.zv as EmacsInt;
 
@@ -803,7 +806,8 @@ pub fn barf_if_buffer_read_only(position: Option<EmacsInt>) {
     let inhibit_read_only: bool = unsafe { globals.Vinhibit_read_only.into() };
     let prop = unsafe { Fget_text_property(LispObject::from(pos), Qinhibit_read_only, Qnil) };
 
-    if ThreadState::current_buffer().is_read_only() && !inhibit_read_only && prop.is_nil() {
+    if ThreadState::current_buffer_unchecked().is_read_only() && !inhibit_read_only && prop.is_nil()
+    {
         xsignal!(Qbuffer_read_only, current_buffer())
     }
 }
@@ -831,7 +835,7 @@ pub fn overlay_lists() -> LispObject {
         ol.iter().fold(Qnil, |accum, n| LispObject::cons(n, accum))
     };
 
-    let cur_buf = ThreadState::current_buffer();
+    let cur_buf = ThreadState::current_buffer_unchecked();
     let before = cur_buf.overlays_before().map_or(Qnil, &list_overlays);
     let after = cur_buf.overlays_after().map_or(Qnil, &list_overlays);
     unsafe { LispObject::cons(Fnreverse(before), Fnreverse(after)) }
@@ -950,7 +954,7 @@ pub fn buffer_base_buffer(buffer: LispBufferOrCurrent) -> Option<LispBufferRef>
 /// menu bar menus and the frame title.
 #[lisp_fn(min = "0")]
 pub fn force_mode_line_update(all: bool) -> bool {
-    let mut current_buffer = ThreadState::current_buffer();
+    let mut current_buffer = ThreadState::current_buffer_unchecked();
     if all {
         unsafe {
             update_mode_lines = 10;
@@ -1052,7 +1056,7 @@ pub fn erase_buffer() {
     unsafe {
         Fwiden();
 
-        let mut cur_buf = ThreadState::current_buffer();
+        let mut cur_buf = ThreadState::current_buffer_unchecked();
         del_range(cur_buf.beg(), cur_buf.z());
 
         cur_buf.last_window_start = 1;
diff --git a/rust_src/src/callproc.rs b/rust_src/src/callproc.rs
index f99c9ead0b..f759ea6a29 100644
--- a/rust_src/src/callproc.rs
+++ b/rust_src/src/callproc.rs
@@ -48,7 +48,7 @@ pub fn call_process_lisp(args: &mut [LispObject]) -> LispObject {
     let count = c_specpdl_index();
 
     let infile = if args.len() >= 2 && args[1].is_not_nil() {
-        unsafe { Fexpand_file_name(args[1], ThreadState::current_buffer().directory_) }
+        unsafe { Fexpand_file_name(args[1], ThreadState::current_buffer_unchecked().directory_) }
     } else {
         unsafe { build_string(NULL_DEVICE.as_ptr() as *const i8) }
     };
diff --git a/rust_src/src/casefiddle.rs b/rust_src/src/casefiddle.rs
index 853b7b2d8d..c6e099d7af 100644
--- a/rust_src/src/casefiddle.rs
+++ b/rust_src/src/casefiddle.rs
@@ -19,7 +19,7 @@ use crate::{
 };
 
 fn casify_word(flag: case_action, words: EmacsInt) {
-    let buffer_ref = ThreadState::current_buffer();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
 
     let far_end = match unsafe { scan_words(buffer_ref.pt, words) } {
         0 => {
diff --git a/rust_src/src/casetab.rs b/rust_src/src/casetab.rs
index bc9cb18aa8..35463663f8 100644
--- a/rust_src/src/casetab.rs
+++ b/rust_src/src/casetab.rs
@@ -37,7 +37,7 @@ pub fn case_table_p(object: LispObject) -> bool {
 /// Return the case table of the current buffer.
 #[lisp_fn]
 pub fn current_case_table() -> LispObject {
-    ThreadState::current_buffer().downcase_table_
+    ThreadState::current_buffer_unchecked().downcase_table_
 }
 
 /// Return the standard case table.
diff --git a/rust_src/src/category.rs b/rust_src/src/category.rs
index bda8bc100b..2aa7e940f4 100644
--- a/rust_src/src/category.rs
+++ b/rust_src/src/category.rs
@@ -19,7 +19,7 @@ pub fn category_table_p(arg: Option<LispCharTableRef>) -> bool {
 /// This is the one specified by the current buffer.
 #[lisp_fn]
 pub fn category_table() -> LispObject {
-    let buffer_ref = ThreadState::current_buffer();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
     buffer_ref.category_table_
 }
 
diff --git a/rust_src/src/character.rs b/rust_src/src/character.rs
index 330a7f1370..0088749407 100644
--- a/rust_src/src/character.rs
+++ b/rust_src/src/character.rs
@@ -43,7 +43,7 @@ pub fn char_head_p(byte: c_uchar) -> bool {
 ///
 /// Can be used instead of the `DEC_POS` macro.
 pub unsafe fn dec_pos(pos_byte: ptrdiff_t) -> ptrdiff_t {
-    let buffer_ref = ThreadState::current_buffer();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
 
     let mut new_pos = pos_byte - 1;
     let mut offset = new_pos - buffer_ref.beg_byte();
diff --git a/rust_src/src/cmds.rs b/rust_src/src/cmds.rs
index 2d9f9c5f6d..470ec47adf 100644
--- a/rust_src/src/cmds.rs
+++ b/rust_src/src/cmds.rs
@@ -56,7 +56,7 @@ fn move_point(n: LispObject, forward: bool) {
         n = -n;
     }
 
-    let buffer = ThreadState::current_buffer();
+    let buffer = ThreadState::current_buffer_unchecked();
     let mut signal = Qnil;
     let mut new_point = buffer.pt + n;
 
@@ -103,7 +103,7 @@ pub fn backward_char(n: LispObject) {
 /// Return buffer position N characters after (before if N negative) point.
 #[lisp_fn]
 pub fn forward_point(n: EmacsInt) -> EmacsInt {
-    let pt = ThreadState::current_buffer().pt;
+    let pt = ThreadState::current_buffer_unchecked().pt;
     n + pt as EmacsInt
 }
 
@@ -141,7 +141,7 @@ pub fn end_of_line(n: Option<EmacsInt>) {
     let mut num = n.unwrap_or(1);
     let mut newpos: isize;
     let mut pt: isize;
-    let cur_buf = ThreadState::current_buffer();
+    let cur_buf = ThreadState::current_buffer_unchecked();
     loop {
         newpos = line_end_position(Some(num)) as isize;
         unsafe { set_point(newpos) };
@@ -183,7 +183,7 @@ pub fn end_of_line(n: Option<EmacsInt>) {
 pub fn forward_line(n: Option<EmacsInt>) -> EmacsInt {
     let count: isize = n.unwrap_or(1) as isize;
 
-    let cur_buf = ThreadState::current_buffer();
+    let cur_buf = ThreadState::current_buffer_unchecked();
     let opoint = cur_buf.pt;
 
     let (mut pos, mut pos_byte) = (0, 0);
@@ -222,7 +222,7 @@ pub fn delete_char(n: EmacsInt, killflag: bool) {
         call!(Qundo_auto_amalgamate);
     }
 
-    let buffer = ThreadState::current_buffer();
+    let buffer = ThreadState::current_buffer_unchecked();
     let pos = buffer.pt + n as isize;
     if killflag {
         call!(Qkill_forward_chars, LispObject::from(n));
@@ -303,7 +303,7 @@ fn internal_self_insert(mut c: Codepoint, n: usize) -> EmacsInt {
     let mut chars_to_delete: usize = 0;
     let mut spaces_to_insert: usize = 0;
 
-    let mut current_buffer = ThreadState::current_buffer();
+    let mut current_buffer = ThreadState::current_buffer_unchecked();
     let overwrite = current_buffer.overwrite_mode_;
     if unsafe { globals.Vbefore_change_functions }.is_not_nil()
         || unsafe { globals.Vafter_change_functions }.is_not_nil()
diff --git a/rust_src/src/crypto/mod.rs b/rust_src/src/crypto/mod.rs
index 5ccdf77265..234842db65 100755
--- a/rust_src/src/crypto/mod.rs
+++ b/rust_src/src/crypto/mod.rs
@@ -193,7 +193,7 @@ fn get_input_from_buffer(
     start_byte: &mut ptrdiff_t,
     end_byte: &mut ptrdiff_t,
 ) -> LispObject {
-    let prev_buffer = ThreadState::current_buffer().as_mut();
+    let prev_buffer = ThreadState::current_buffer_unchecked().as_mut();
     unsafe { record_unwind_current_buffer() };
     unsafe { set_buffer_internal(buffer.as_mut()) };
 
@@ -450,7 +450,7 @@ fn sha512_buffer(buffer: &[u8], dest_buf: &mut [u8]) {
 /// disregarding any coding systems.  If nil, use the current buffer.
 #[lisp_fn(min = "0")]
 pub fn buffer_hash(buffer_or_name: Option<LispBufferOrName>) -> LispObject {
-    let b = buffer_or_name.map_or_else(ThreadState::current_buffer, |b| b.into());
+    let b = buffer_or_name.map_or_else(ThreadState::current_buffer_unchecked, |b| b.into());
     let mut ctx = sha1::Sha1::new();
 
     ctx.update(unsafe {
diff --git a/rust_src/src/data.rs b/rust_src/src/data.rs
index 2377f63135..bf7cfd1902 100644
--- a/rust_src/src/data.rs
+++ b/rust_src/src/data.rs
@@ -521,7 +521,7 @@ pub unsafe extern "C" fn do_symval_forwarding(valcontents: *const Lisp_Fwd) -> L
         Lisp_Fwd_Buffer_Obj => *(*valcontents)
             .u_buffer_objfwd
             .offset
-            .apply_ptr(ThreadState::current_buffer().as_mut()),
+            .apply_ptr(ThreadState::current_buffer_unchecked().as_mut()),
         Lisp_Fwd_Kboard_Obj => {
             // We used to simply use current_kboard here, but from Lisp
             // code, its value is often unexpected.  It seems nicer to
@@ -589,7 +589,7 @@ pub unsafe extern "C" fn store_symval_forwarding(
             }
 
             if buf.is_null() {
-                buf = ThreadState::current_buffer().as_mut();
+                buf = ThreadState::current_buffer_unchecked().as_mut();
             }
             *(*valcontents).u_buffer_objfwd.offset.apply_ptr_mut(buf) = newval;
         }
diff --git a/rust_src/src/decompress.rs b/rust_src/src/decompress.rs
index 1fd1f8239a..d399d763ec 100644
--- a/rust_src/src/decompress.rs
+++ b/rust_src/src/decompress.rs
@@ -44,7 +44,7 @@ fn create_buffer_decoder<'a>(buffer: &'a [u8]) -> Box<Read + 'a> {
 pub fn zlib_decompress_region(mut start: LispObject, mut end: LispObject) -> bool {
     unsafe { validate_region(&mut start, &mut end) };
 
-    let mut current_buffer = ThreadState::current_buffer();
+    let mut current_buffer = ThreadState::current_buffer_unchecked();
 
     if current_buffer.multibyte_characters_enabled() {
         error!("This function can be called only in unibyte buffers");
diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index 640fe49936..1e6037dae0 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -53,7 +53,7 @@ use crate::{
 /// Beginning of buffer is position (point-min).
 #[lisp_fn]
 pub fn point() -> EmacsInt {
-    let buffer_ref = ThreadState::current_buffer();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
     buffer_ref.pt as EmacsInt
 }
 
@@ -76,7 +76,7 @@ pub fn buffer_size(buffer: LispBufferOrCurrent) -> EmacsInt {
 /// If the buffer is narrowed, this means the end of the narrowed part.
 #[lisp_fn]
 pub fn eobp() -> bool {
-    let buffer_ref = ThreadState::current_buffer();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
     buffer_ref.zv == buffer_ref.pt
 }
 
@@ -84,14 +84,14 @@ pub fn eobp() -> bool {
 /// buffer is narrowed, this means the beginning of the narrowed part.
 #[lisp_fn]
 pub fn bobp() -> bool {
-    let buffer_ref = ThreadState::current_buffer();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
     buffer_ref.pt == buffer_ref.begv
 }
 
 /// Return t if point is at the beginning of a line.
 #[lisp_fn]
 pub fn bolp() -> bool {
-    let buffer_ref = ThreadState::current_buffer();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
     buffer_ref.pt == buffer_ref.begv || buffer_ref.fetch_byte(buffer_ref.pt_byte - 1) == b'\n'
 }
 
@@ -99,7 +99,7 @@ pub fn bolp() -> bool {
 /// `End of a line' includes point being at the end of the buffer.
 #[lisp_fn]
 pub fn eolp() -> bool {
-    let buffer_ref = ThreadState::current_buffer();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
     buffer_ref.pt == buffer_ref.zv || buffer_ref.fetch_byte(buffer_ref.pt_byte) == b'\n'
 }
 
@@ -107,7 +107,7 @@ pub fn eolp() -> bool {
 /// See also `gap-size'.
 #[lisp_fn]
 pub fn gap_position() -> EmacsInt {
-    let buffer_ref = ThreadState::current_buffer();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
     buffer_ref.gap_position() as EmacsInt
 }
 
@@ -115,7 +115,7 @@ pub fn gap_position() -> EmacsInt {
 /// See also `gap-position'.
 #[lisp_fn]
 pub fn gap_size() -> EmacsInt {
-    let buffer_ref = ThreadState::current_buffer();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
     buffer_ref.gap_size() as EmacsInt
 }
 
@@ -123,7 +123,7 @@ pub fn gap_size() -> EmacsInt {
 /// BEGINNINGP means return the start.
 /// If there is no region active, signal an error.
 fn region_limit(beginningp: bool) -> EmacsInt {
-    let current_buf = ThreadState::current_buffer();
+    let current_buf = ThreadState::current_buffer_unchecked();
     if unsafe { globals.Vtransient_mark_mode }.is_not_nil()
         && unsafe { globals.Vmark_even_if_inactive }.is_nil()
         && current_buf.mark_active().is_nil()
@@ -159,7 +159,7 @@ pub fn region_end() -> EmacsInt {
 /// If you set the marker not to point anywhere, the buffer will have no mark.
 #[lisp_fn]
 pub fn mark_marker() -> LispObject {
-    ThreadState::current_buffer().mark()
+    ThreadState::current_buffer_unchecked().mark()
 }
 
 /// Return the minimum permissible value of point in the current
@@ -167,7 +167,7 @@ pub fn mark_marker() -> LispObject {
 /// effect.
 #[lisp_fn]
 pub fn point_min() -> EmacsInt {
-    ThreadState::current_buffer().begv as EmacsInt
+    ThreadState::current_buffer_unchecked().begv as EmacsInt
 }
 
 /// Return the maximum permissible value of point in the current
@@ -175,7 +175,7 @@ pub fn point_min() -> EmacsInt {
 /// restriction) is in effect, in which case it is less.
 #[lisp_fn]
 pub fn point_max() -> EmacsInt {
-    ThreadState::current_buffer().zv as EmacsInt
+    ThreadState::current_buffer_unchecked().zv as EmacsInt
 }
 
 /// Set point to POSITION, a number or marker.
@@ -187,7 +187,7 @@ pub fn goto_char(position: LispObject) -> LispObject {
     if position.is_marker() {
         set_point_from_marker(position);
     } else if let Some(num) = position.as_fixnum() {
-        let mut cur_buf = ThreadState::current_buffer();
+        let mut cur_buf = ThreadState::current_buffer_unchecked();
         let pos = clip_to_bounds(cur_buf.begv, num, cur_buf.zv);
         let bytepos = unsafe { buf_charpos_to_bytepos(cur_buf.as_mut(), pos) };
         unsafe { set_point_both(pos, bytepos) };
@@ -202,7 +202,7 @@ pub fn goto_char(position: LispObject) -> LispObject {
 #[lisp_fn]
 pub fn position_bytes(position: LispNumber) -> Option<EmacsInt> {
     let pos = position.to_fixnum() as ptrdiff_t;
-    let mut cur_buf = ThreadState::current_buffer();
+    let mut cur_buf = ThreadState::current_buffer_unchecked();
 
     if pos >= cur_buf.begv && pos <= cur_buf.zv {
         let bytepos = unsafe { buf_charpos_to_bytepos(cur_buf.as_mut(), pos) };
@@ -228,7 +228,7 @@ pub fn insert_byte(byte: EmacsInt, count: Option<EmacsInt>, inherit: bool) {
     if byte < 0 || byte > 255 {
         args_out_of_range!(byte, 0, 255)
     }
-    let buf = ThreadState::current_buffer();
+    let buf = ThreadState::current_buffer_unchecked();
     let toinsert = if byte >= 128 && buf.multibyte_characters_enabled() {
         EmacsInt::from(raw_byte_codepoint(byte as c_uchar))
     } else {
@@ -310,7 +310,7 @@ pub fn insert_char(character: Codepoint, count: Option<EmacsInt>, inherit: bool)
 /// the buffer or accessible region, return 0.
 #[lisp_fn]
 pub fn following_char() -> EmacsInt {
-    let buffer_ref = ThreadState::current_buffer();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
 
     if buffer_ref.pt >= buffer_ref.zv {
         0
@@ -323,7 +323,7 @@ pub fn following_char() -> EmacsInt {
 /// beginning of the buffer or accessible region, return 0.
 #[lisp_fn(c_name = "previous_char")]
 pub fn preceding_char() -> EmacsInt {
-    let buffer_ref = ThreadState::current_buffer();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
 
     if buffer_ref.pt <= buffer_ref.begv {
         return EmacsInt::from(0);
@@ -342,7 +342,7 @@ pub fn preceding_char() -> EmacsInt {
 /// If POS is out of range, the value is nil.
 #[lisp_fn(min = "0")]
 pub fn char_before(pos: LispObject) -> Option<EmacsInt> {
-    let mut buffer_ref = ThreadState::current_buffer();
+    let mut buffer_ref = ThreadState::current_buffer_unchecked();
     let pos_byte: isize;
 
     if pos.is_nil() {
@@ -379,7 +379,7 @@ pub fn char_before(pos: LispObject) -> Option<EmacsInt> {
 /// If POS is out of range, the value is nil.
 #[lisp_fn(min = "0")]
 pub fn char_after(mut pos: LispObject) -> Option<EmacsInt> {
-    let mut buffer_ref = ThreadState::current_buffer();
+    let mut buffer_ref = ThreadState::current_buffer_unchecked();
     if pos.is_nil() {
         pos = LispObject::from(point());
     }
@@ -638,7 +638,7 @@ pub fn constrain_to_field(
 
     let prev_old = old_pos - 1;
     let prev_new = new_pos - 1;
-    let begv = ThreadState::current_buffer().begv as EmacsInt;
+    let begv = ThreadState::current_buffer_unchecked().begv as EmacsInt;
 
     if unsafe { globals.Vinhibit_field_text_motion == Qnil }
         && new_pos != old_pos
@@ -743,7 +743,7 @@ pub fn constrain_to_field(
 /// If BYTEPOS is out of range, the value is nil.
 #[lisp_fn]
 pub fn byte_to_position(bytepos: EmacsInt) -> Option<EmacsInt> {
-    let mut cur_buf = ThreadState::current_buffer();
+    let mut cur_buf = ThreadState::current_buffer_unchecked();
     let mut pos_byte = bytepos as isize;
     if pos_byte < cur_buf.beg_byte() || pos_byte > cur_buf.z_byte() {
         return None;
@@ -775,7 +775,7 @@ pub fn char_equal(c1: LispObject, c2: LispObject) -> bool {
         return true;
     }
 
-    let cur_buf = ThreadState::current_buffer();
+    let cur_buf = ThreadState::current_buffer_unchecked();
     if cur_buf.case_fold_search().is_nil() {
         return false;
     }
@@ -870,7 +870,7 @@ pub fn insert_buffer_substring(
         args_out_of_range!(beg, end);
     }
 
-    let mut cur_buf = ThreadState::current_buffer();
+    let mut cur_buf = ThreadState::current_buffer_unchecked();
     unsafe {
         set_buffer_internal_1(buf_ref.as_mut());
         update_buffer_properties(b, e);
@@ -1077,7 +1077,7 @@ pub fn format_message(args: &mut [LispObject]) -> LispObject {
 /// of the buffer.
 #[lisp_fn]
 pub fn buffer_string() -> LispObject {
-    let cur_buf = ThreadState::current_buffer();
+    let cur_buf = ThreadState::current_buffer_unchecked();
 
     let begv = cur_buf.begv;
     let begv_byte = cur_buf.begv_byte;
@@ -1218,7 +1218,7 @@ pub fn find_field(
     beg_limit: Option<EmacsInt>,
     end_limit: Option<EmacsInt>,
 ) -> (ptrdiff_t, ptrdiff_t) {
-    let current_buffer = ThreadState::current_buffer();
+    let current_buffer = ThreadState::current_buffer_unchecked();
     let pos = pos.map_or(current_buffer.pt, |p| p.to_fixnum() as ptrdiff_t);
 
     // Fields right before and after the point.
@@ -1442,7 +1442,7 @@ pub fn time_less_p(t1: LispObject, t2: LispObject) -> bool {
 /// This allows the buffer's full text to be seen and edited.
 #[lisp_fn(intspec = "")]
 pub fn widen() {
-    let mut buffer_ref = ThreadState::current_buffer();
+    let mut buffer_ref = ThreadState::current_buffer_unchecked();
 
     if buffer_ref.beg() != buffer_ref.begv || buffer_ref.z() != buffer_ref.zv {
         buffer_ref.set_clip_changed(true);
diff --git a/rust_src/src/fileio.rs b/rust_src/src/fileio.rs
index 6e7efefa56..44cf06d7c7 100644
--- a/rust_src/src/fileio.rs
+++ b/rust_src/src/fileio.rs
@@ -41,7 +41,7 @@ pub fn directory_name_p(name: LispStringRef) -> bool {
 /// Clear any record of a recent auto-save failure in the current buffer.
 #[lisp_fn]
 pub fn clear_buffer_auto_save_failure() {
-    ThreadState::current_buffer().auto_save_failure_time = 0;
+    ThreadState::current_buffer_unchecked().auto_save_failure_time = 0;
 }
 
 /// Return t if current buffer has been auto-saved recently.
@@ -50,7 +50,7 @@ pub fn clear_buffer_auto_save_failure() {
 /// then any auto-save counts as "recent".
 #[lisp_fn]
 pub fn recent_auto_save_p() -> bool {
-    let cur_buf = ThreadState::current_buffer();
+    let cur_buf = ThreadState::current_buffer_unchecked();
 
     // FIXME: maybe we should return nil for indirect buffers since
     //  they're never autosaved.
diff --git a/rust_src/src/keymap.rs b/rust_src/src/keymap.rs
index 520f30c81b..68715fd6bc 100644
--- a/rust_src/src/keymap.rs
+++ b/rust_src/src/keymap.rs
@@ -421,7 +421,7 @@ pub fn local_key_binding(keys: LispObject, accept_default: LispObject) -> LispOb
 /// Normally the local keymap is set by the major mode with `use-local-map'.
 #[lisp_fn]
 pub fn current_local_map() -> LispObject {
-    ThreadState::current_buffer().keymap_
+    ThreadState::current_buffer_unchecked().keymap_
 }
 
 /// Select KEYMAP as the local keymap.
@@ -433,7 +433,7 @@ pub fn use_local_map(mut keymap: LispObject) {
         keymap = map;
     }
 
-    ThreadState::current_buffer().keymap_ = keymap;
+    ThreadState::current_buffer_unchecked().keymap_ = keymap;
 }
 
 /// Return the binding for command KEYS in current global keymap only.
diff --git a/rust_src/src/lread.rs b/rust_src/src/lread.rs
index b46d337f3a..53a393d9f4 100644
--- a/rust_src/src/lread.rs
+++ b/rust_src/src/lread.rs
@@ -212,7 +212,7 @@ pub fn eval_region(
 ) {
     // FIXME: Do the eval-sexp-add-defvars dance!
     let count = c_specpdl_index();
-    let cur_buf = ThreadState::current_buffer();
+    let cur_buf = ThreadState::current_buffer_unchecked();
     let cur_buf_obj = cur_buf.into();
 
     let tem = if printflag.is_nil() {
diff --git a/rust_src/src/marker.rs b/rust_src/src/marker.rs
index debfc365aa..94317041b2 100644
--- a/rust_src/src/marker.rs
+++ b/rust_src/src/marker.rs
@@ -219,7 +219,7 @@ pub unsafe extern "C" fn build_marker(
 /// Return value of point, as a marker object.
 #[lisp_fn]
 pub fn point_marker() -> LispObject {
-    let mut cur_buf = ThreadState::current_buffer();
+    let mut cur_buf = ThreadState::current_buffer_unchecked();
     unsafe { build_marker(cur_buf.as_mut(), cur_buf.pt, cur_buf.pt_byte) }
 }
 
@@ -227,7 +227,7 @@ pub fn point_marker() -> LispObject {
 /// This is the beginning, unless narrowing (a buffer restriction) is in effect.
 #[lisp_fn]
 pub fn point_min_marker() -> LispObject {
-    let mut cur_buf = ThreadState::current_buffer();
+    let mut cur_buf = ThreadState::current_buffer_unchecked();
     unsafe { build_marker(cur_buf.as_mut(), cur_buf.begv, cur_buf.begv_byte) }
 }
 
@@ -236,7 +236,7 @@ pub fn point_min_marker() -> LispObject {
 /// is in effect, in which case it is less.
 #[lisp_fn]
 pub fn point_max_marker() -> LispObject {
-    let mut cur_buf = ThreadState::current_buffer();
+    let mut cur_buf = ThreadState::current_buffer_unchecked();
     unsafe { build_marker(cur_buf.as_mut(), cur_buf.zv, cur_buf.zv_byte) }
 }
 
@@ -244,7 +244,7 @@ pub fn point_max_marker() -> LispObject {
 #[no_mangle]
 pub extern "C" fn set_point_from_marker(marker: LispObject) {
     let marker = marker.as_marker_or_error();
-    let mut cur_buf = ThreadState::current_buffer();
+    let mut cur_buf = ThreadState::current_buffer_unchecked();
     let charpos = clip_to_bounds(
         cur_buf.begv,
         marker.charpos_or_error() as EmacsInt,
@@ -319,7 +319,7 @@ pub fn copy_marker(marker: LispObject, itype: LispObject) -> LispObject {
 /// Return t if there are markers pointing at POSITION in the current buffer.
 #[lisp_fn]
 pub fn buffer_has_markers_at(position: EmacsInt) -> bool {
-    let cur_buf = ThreadState::current_buffer();
+    let cur_buf = ThreadState::current_buffer_unchecked();
     let position = clip_to_bounds(cur_buf.begv, position, cur_buf.zv);
 
     if let Some(marker) = cur_buf.markers() {
@@ -463,7 +463,7 @@ pub extern "C" fn set_marker_restricted_both(
         .as_live_buffer()
         .or_else(|| current_buffer().as_live_buffer())
     {
-        let cur_buf = ThreadState::current_buffer();
+        let cur_buf = ThreadState::current_buffer_unchecked();
         let clipped_charpos = clip_to_bounds(cur_buf.begv, charpos as EmacsInt, cur_buf.zv);
         let clipped_bytepos =
             clip_to_bounds(cur_buf.begv_byte, bytepos as EmacsInt, cur_buf.zv_byte);
@@ -898,7 +898,7 @@ fn count_markers(buf: LispBufferRef) -> u8 {
 fn verify_bytepos(charpos: isize) -> isize {
     let mut below: isize = 1;
     let mut below_byte: isize = 1;
-    let cur_buf = ThreadState::current_buffer();
+    let cur_buf = ThreadState::current_buffer_unchecked();
 
     while below != charpos {
         below += 1;
diff --git a/rust_src/src/minibuf.rs b/rust_src/src/minibuf.rs
index da7e38d8cd..66414b9c5d 100644
--- a/rust_src/src/minibuf.rs
+++ b/rust_src/src/minibuf.rs
@@ -77,7 +77,7 @@ pub fn minibuffer_prompt() -> LispObject {
 /// Return (point-min) if current buffer is not a minibuffer.
 #[lisp_fn]
 pub fn minibuffer_prompt_end() -> EmacsInt {
-    let buffer = ThreadState::current_buffer();
+    let buffer = ThreadState::current_buffer_unchecked();
     let beg = buffer.beg() as EmacsInt;
     if memq(buffer.into(), unsafe { Vminibuffer_list }).is_nil() {
         return beg;
@@ -97,7 +97,7 @@ pub fn minibuffer_prompt_end() -> EmacsInt {
 #[lisp_fn]
 pub fn minibuffer_contents() -> LispObject {
     let prompt_end = minibuffer_prompt_end() as isize;
-    unsafe { make_buffer_string(prompt_end, ThreadState::current_buffer().zv, true) }
+    unsafe { make_buffer_string(prompt_end, ThreadState::current_buffer_unchecked().zv, true) }
 }
 
 /// Return the user input in a minibuffer as a string, without text-properties.
@@ -105,7 +105,13 @@ pub fn minibuffer_contents() -> LispObject {
 #[lisp_fn]
 pub fn minibuffer_contents_no_properties() -> LispObject {
     let prompt_end = minibuffer_prompt_end() as isize;
-    unsafe { make_buffer_string(prompt_end, ThreadState::current_buffer().zv, false) }
+    unsafe {
+        make_buffer_string(
+            prompt_end,
+            ThreadState::current_buffer_unchecked().zv,
+            false,
+        )
+    }
 }
 
 /// Read a string from the minibuffer, prompting with string PROMPT.
diff --git a/rust_src/src/syntax.rs b/rust_src/src/syntax.rs
index 89eae41410..d0bdc83832 100644
--- a/rust_src/src/syntax.rs
+++ b/rust_src/src/syntax.rs
@@ -21,7 +21,7 @@ use crate::{
 /// current buffer.
 #[lisp_fn]
 pub fn syntax_table() -> LispObject {
-    ThreadState::current_buffer().syntax_table_
+    ThreadState::current_buffer_unchecked().syntax_table_
 }
 
 /// Return t if OBJECT is a syntax table.
@@ -66,7 +66,7 @@ pub fn scan_lists_defun(from: EmacsInt, count: EmacsInt, depth: EmacsInt) -> Lis
 #[lisp_fn]
 pub fn set_syntax_table(table: LispCharTableRef) -> LispCharTableRef {
     check_syntax_table_p(table);
-    let mut buf = ThreadState::current_buffer();
+    let mut buf = ThreadState::current_buffer_unchecked();
     buf.set_syntax_table(table);
     let idx = per_buffer_var_idx!(syntax_table_);
     buf.set_per_buffer_value_p(idx, 1);
@@ -135,7 +135,7 @@ pub fn copy_syntax_table(mut table: LispObject) -> LispObject {
 #[lisp_fn(min = "0", intspec = "^p")]
 pub fn forward_word(arg: Option<EmacsInt>) -> bool {
     let arg = arg.unwrap_or(1);
-    let cur_buf = ThreadState::current_buffer();
+    let cur_buf = ThreadState::current_buffer_unchecked();
     let point = cur_buf.pt;
 
     let (mut val, orig_val) = match unsafe { scan_words(point, arg) } {
diff --git a/rust_src/src/threads.rs b/rust_src/src/threads.rs
index 052419241d..241816e311 100644
--- a/rust_src/src/threads.rs
+++ b/rust_src/src/threads.rs
@@ -21,10 +21,16 @@ pub type ThreadStateRef = ExternalPtr<thread_state>;
 pub struct ThreadState {}
 
 impl ThreadState {
-    pub fn current_buffer() -> LispBufferRef {
+    pub fn current_buffer_unchecked() -> LispBufferRef {
         unsafe { mem::transmute((*current_thread_pointer).m_current_buffer) }
     }
 
+    pub fn current_buffer() -> Option<LispBufferRef> {
+        unsafe {
+            LispBufferRef::from_ptr((*current_thread_pointer).m_current_buffer as *mut libc::c_void)
+        }
+    }
+
     pub fn current_thread() -> ThreadStateRef {
         unsafe { mem::transmute(current_thread_pointer) }
     }
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index a5b529078d..3170acc6ec 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -909,7 +909,7 @@ pub fn set_window_point(window: LispWindowLiveOrSelected, pos: LispObject) -> Li
 
     // Type of POS is checked by Fgoto_char or set_marker_restricted ...
     if win == selected_window().as_window_or_error() {
-        let mut current_buffer = ThreadState::current_buffer();
+        let mut current_buffer = ThreadState::current_buffer_unchecked();
 
         if win
             .contents
-- 
2.21.0


From 8883ea012fd98f8376aa15d2e7a115db627cb68f Mon Sep 17 00:00:00 2001
From: Shanavas M <shanavas.m2@gmail.com>
Date: Mon, 7 Jan 2019 18:29:12 +0530
Subject: [PATCH 002/297] Port reset_buffer

---
 rust_src/src/buffers.rs | 54 ++++++++++++++++++++++++++++++++++++++---
 src/buffer.c            | 43 --------------------------------
 2 files changed, 50 insertions(+), 47 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index dceb6c825a..df4a4e7e5e 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -27,12 +27,12 @@ use crate::{
     remacs_sys::{
         allocate_misc, bset_update_mode_line, buffer_local_flags, buffer_local_value,
         buffer_window_count, concat2, del_range, delete_all_overlays, globals, internal_equal,
-        last_per_buffer_idx, lookup_char_property, marker_position, modify_overlay,
+        last_per_buffer_idx, lookup_char_property, make_timespec, marker_position, modify_overlay,
         set_buffer_internal_1, specbind, unchain_both, unchain_marker, update_mode_lines,
     },
     remacs_sys::{
-        equal_kind, pvec_type, EmacsInt, Lisp_Buffer, Lisp_Buffer_Local_Value, Lisp_Misc_Type,
-        Lisp_Overlay, Lisp_Type, Vbuffer_alist,
+        buffer_defaults, equal_kind, pvec_type, EmacsInt, Lisp_Buffer, Lisp_Buffer_Local_Value,
+        Lisp_Misc_Type, Lisp_Overlay, Lisp_Type, Vbuffer_alist,
     },
     remacs_sys::{
         windows_or_buffers_changed, Fcopy_sequence, Fexpand_file_name, Ffind_file_name_handler,
@@ -40,7 +40,7 @@ use crate::{
     },
     remacs_sys::{
         Qafter_string, Qbefore_string, Qbuffer_read_only, Qbufferp, Qget_file_buffer,
-        Qinhibit_quit, Qinhibit_read_only, Qnil, Qoverlayp, Qt, Qunbound,
+        Qinhibit_quit, Qinhibit_read_only, Qnil, Qoverlayp, Qt, Qunbound, UNKNOWN_MODTIME_NSECS,
     },
     strings::string_equal,
     threads::{c_specpdl_index, ThreadState},
@@ -383,6 +383,47 @@ impl LispBufferRef {
         let pos = buffer_bytes.add(offset) as *mut LispObject;
         *pos = value;
     }
+
+    // Reinitialize everything about a buffer except its name and contents
+    // and local variables.
+    // If called on an already-initialized buffer, the list of overlays
+    // should be deleted before calling this function, otherwise we end up
+    // with overlays that claim to belong to the buffer but the buffer
+    // claims it doesn't belong to it.
+    pub fn reset(&mut self) {
+        self.filename_ = Qnil;
+        self.file_truename_ = Qnil;
+        self.directory_ = match ThreadState::current_buffer() {
+            Some(current_buff) => current_buff.directory_,
+            None => Qnil,
+        };
+        self.modtime = unsafe { make_timespec(0, UNKNOWN_MODTIME_NSECS.into()) };
+        self.modtime_size = -1;
+        self.save_length_ = 0.into();
+        self.last_window_start = 1;
+        // It is more conservative to start out "changed" than "unchanged".
+        self.set_clip_changed(false);
+        self.set_prevent_redisplay_optimizations_p(true);
+        self.backed_up_ = Qnil;
+        self.auto_save_modified = 0;
+        self.auto_save_failure_time = 0;
+        self.auto_save_file_name_ = Qnil;
+        self.read_only_ = Qnil;
+        self.overlays_before = ptr::null_mut();
+        self.overlays_after = ptr::null_mut();
+        self.overlay_center = BEG;
+        self.mark_active_ = Qnil;
+        self.point_before_scroll_ = Qnil;
+        self.file_format_ = Qnil;
+        self.auto_save_file_format_ = Qt;
+        self.last_selected_window_ = Qnil;
+        self.display_count_ = 0.into();
+        self.display_time_ = Qnil;
+        self.enable_multibyte_characters_ = unsafe { buffer_defaults.enable_multibyte_characters_ };
+        self.cursor_type_ = unsafe { buffer_defaults.cursor_type_ };
+        self.extra_line_spacing_ = unsafe { buffer_defaults.extra_line_spacing_ };
+        self.display_error_modiff = 0;
+    }
 }
 
 impl LispObject {
@@ -1173,6 +1214,11 @@ pub unsafe extern "C" fn copy_overlays(
     result
 }
 
+#[no_mangle]
+pub extern "C" fn reset_buffer(mut buffer: LispBufferRef) {
+    buffer.reset();
+}
+
 #[no_mangle]
 pub extern "C" fn rust_syms_of_buffer() {
     def_lisp_sym!(Qget_file_buffer, "get-file-buffer");
diff --git a/src/buffer.c b/src/buffer.c
index 49dca3e74c..2d219b185c 100644
--- a/src/buffer.c
+++ b/src/buffer.c
@@ -695,49 +695,6 @@ delete_all_overlays (struct buffer *b)
   set_buffer_overlays_after (b, NULL);
 }
 
-/* Reinitialize everything about a buffer except its name and contents
-   and local variables.
-   If called on an already-initialized buffer, the list of overlays
-   should be deleted before calling this function, otherwise we end up
-   with overlays that claim to belong to the buffer but the buffer
-   claims it doesn't belong to it.  */
-
-void
-reset_buffer (register struct buffer *b)
-{
-  bset_filename (b, Qnil);
-  bset_file_truename (b, Qnil);
-  bset_directory (b, current_buffer ? BVAR (current_buffer, directory) : Qnil);
-  b->modtime = make_timespec (0, UNKNOWN_MODTIME_NSECS);
-  b->modtime_size = -1;
-  XSETFASTINT (BVAR (b, save_length), 0);
-  b->last_window_start = 1;
-  /* It is more conservative to start out "changed" than "unchanged".  */
-  b->clip_changed = 0;
-  b->prevent_redisplay_optimizations_p = 1;
-  bset_backed_up (b, Qnil);
-  BUF_AUTOSAVE_MODIFF (b) = 0;
-  b->auto_save_failure_time = 0;
-  bset_auto_save_file_name (b, Qnil);
-  bset_read_only (b, Qnil);
-  set_buffer_overlays_before (b, NULL);
-  set_buffer_overlays_after (b, NULL);
-  b->overlay_center = BEG;
-  bset_mark_active (b, Qnil);
-  bset_point_before_scroll (b, Qnil);
-  bset_file_format (b, Qnil);
-  bset_auto_save_file_format (b, Qt);
-  bset_last_selected_window (b, Qnil);
-  bset_display_count (b, make_number (0));
-  bset_display_time (b, Qnil);
-  bset_enable_multibyte_characters
-    (b, BVAR (&buffer_defaults, enable_multibyte_characters));
-  bset_cursor_type (b, BVAR (&buffer_defaults, cursor_type));
-  bset_extra_line_spacing (b, BVAR (&buffer_defaults, extra_line_spacing));
-
-  b->display_error_modiff = 0;
-}
-
 /* Reset buffer B's local variables info.
    Don't use this on a buffer that has already been in use;
    it does not treat permanent locals consistently.
-- 
2.21.0


From 45b27a8423618f958ab961896591e75b85289a24 Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Mon, 7 Jan 2019 09:17:38 -0800
Subject: [PATCH 003/297] Sync from Emacs 2018-03-15 (#1218)

The conflicts were in the docs mostly.
The C code is preparing for bignum support but it is mostly in our ported
code and we already call it fixnum.
---
 Makefile.in                                   |    1 +
 admin/automerge                               |    2 +-
 admin/grammars/scheme.by                      |    5 +
 build-aux/config.guess                        |    4 +-
 build-aux/config.sub                          |    6 +-
 build-aux/install-sh                          |    4 +-
 build-aux/move-if-change                      |    4 +-
 build-aux/update-copyright                    |    4 +-
 configure.ac                                  |   27 +-
 doc/emacs/basic.texi                          |   10 +-
 doc/emacs/buffers.texi                        |   22 +-
 doc/emacs/building.texi                       |   13 +-
 doc/emacs/commands.texi                       |   12 +-
 doc/emacs/custom.texi                         |   23 +-
 doc/emacs/dired.texi                          |    6 +-
 doc/emacs/display.texi                        |   57 +-
 doc/emacs/emacs.texi                          |    4 +-
 doc/emacs/files.texi                          |    7 +-
 doc/emacs/fixit.texi                          |   23 +-
 doc/emacs/frames.texi                         |   28 +-
 doc/emacs/glossary.texi                       |   78 +-
 doc/emacs/help.texi                           |    1 -
 doc/emacs/killing.texi                        |    5 +-
 doc/emacs/macos.texi                          |    2 +-
 doc/emacs/maintaining.texi                    |   20 +-
 doc/emacs/mini.texi                           |   28 +-
 doc/emacs/misc.texi                           |   10 +-
 doc/emacs/msdos.texi                          |   16 +-
 doc/emacs/mule.texi                           |   25 +-
 doc/emacs/programs.texi                       |   37 +-
 doc/emacs/rmail.texi                          |    4 +-
 doc/emacs/search.texi                         |   26 +-
 doc/emacs/text.texi                           |   79 +-
 doc/emacs/trouble.texi                        |    4 +-
 doc/emacs/xresources.texi                     |  130 +-
 doc/lispintro/emacs-lisp-intro.texi           |   18 +-
 doc/lispref/display.texi                      |   13 +-
 doc/lispref/files.texi                        |    4 +-
 doc/lispref/frames.texi                       |    6 +
 doc/lispref/hooks.texi                        |    1 +
 doc/lispref/keymaps.texi                      |    2 +-
 doc/lispref/numbers.texi                      |    5 +-
 doc/lispref/streams.texi                      |    8 +
 doc/lispref/strings.texi                      |    2 +-
 doc/lispref/text.texi                         |    2 +-
 doc/lispref/tips.texi                         |    3 +-
 doc/lispref/variables.texi                    |    5 +-
 doc/misc/calc.texi                            |   73 +-
 doc/misc/cc-mode.texi                         |   42 +-
 doc/misc/dbus.texi                            |    6 +-
 doc/misc/dired-x.texi                         |    2 +-
 doc/misc/ebrowse.texi                         |    6 +-
 doc/misc/ede.texi                             |   32 +-
 doc/misc/ediff.texi                           |    4 +-
 doc/misc/edt.texi                             |    4 +-
 doc/misc/efaq-w32.texi                        |   34 +-
 doc/misc/efaq.texi                            |   14 +-
 doc/misc/eieio.texi                           |    6 +-
 doc/misc/emacs-mime.texi                      |    8 +-
 doc/misc/epa.texi                             |   24 +-
 doc/misc/erc.texi                             |   24 +-
 doc/misc/ert.texi                             |   10 +-
 doc/misc/eshell.texi                          |   18 +-
 doc/misc/eww.texi                             |    2 +-
 doc/misc/forms.texi                           |   24 +-
 doc/misc/gnus-faq.texi                        |   36 +-
 doc/misc/gnus-news.texi                       |    2 +-
 doc/misc/gnus.texi                            | 1555 ++++++++---------
 doc/misc/htmlfontify.texi                     |   12 +-
 doc/misc/idlwave.texi                         |    8 +-
 doc/misc/ido.texi                             |    4 +-
 doc/misc/mairix-el.texi                       |   24 +-
 doc/misc/message.texi                         |   20 +-
 doc/misc/mh-e.texi                            |  169 +-
 doc/misc/newsticker.texi                      |   20 +-
 doc/misc/org.texi                             | 1035 +++++------
 doc/misc/pcl-cvs.texi                         |   11 +-
 doc/misc/reftex.texi                          |    2 +-
 doc/misc/sem-user.texi                        |    6 +-
 doc/misc/ses.texi                             |   16 +-
 doc/misc/sieve.texi                           |   10 +-
 doc/misc/smtpmail.texi                        |    2 +-
 doc/misc/speedbar.texi                        |   12 +-
 doc/misc/srecode.texi                         |   17 +-
 doc/misc/texinfo.tex                          |    4 +-
 doc/misc/tramp.texi                           |   18 +-
 doc/misc/url.texi                             |   13 -
 doc/misc/vhdl-mode.texi                       |   14 +-
 doc/misc/vip.texi                             |  446 ++---
 doc/misc/viper.texi                           |  436 ++---
 etc/NEWS                                      |   87 +-
 etc/NEWS.26                                   |   14 +-
 etc/ORG-NEWS                                  |   12 +-
 etc/TODO                                      |    1 -
 lib-src/make-docfile.c                        |   95 +-
 lib/binary-io.h                               |    6 +-
 lib/fpending.c                                |    3 +-
 lib/stdio-impl.h                              |    6 +
 lisp/allout.el                                |    4 +-
 lisp/arc-mode.el                              |    2 -
 lisp/auth-source.el                           |    4 +-
 lisp/autoinsert.el                            |    2 +-
 lisp/bookmark.el                              |    2 -
 lisp/calendar/icalendar.el                    |   10 +-
 lisp/cedet/ede.el                             |    1 +
 lisp/cedet/semantic/bovine/grammar.el         |    9 +-
 lisp/cedet/semantic/sb.el                     |    6 +-
 lisp/cedet/semantic/texi.el                   |    2 +
 lisp/comint.el                                |    7 +-
 lisp/cus-edit.el                              |    4 -
 lisp/descr-text.el                            |    2 -
 lisp/desktop.el                               |   64 +-
 lisp/dired-aux.el                             |    3 +-
 lisp/dired-x.el                               |    2 -
 lisp/emacs-lisp/autoload.el                   |    5 +-
 lisp/emacs-lisp/bytecomp.el                   |    8 +-
 lisp/emacs-lisp/cl-macs.el                    |   16 +-
 lisp/emacs-lisp/derived.el                    |   13 -
 lisp/emacs-lisp/eieio.el                      |    2 +-
 lisp/emacs-lisp/ert.el                        |   26 +-
 lisp/emacs-lisp/ewoc.el                       |    2 +-
 lisp/emacs-lisp/generic.el                    |    2 -
 lisp/emacs-lisp/syntax.el                     |    6 -
 lisp/emacs-lisp/timer.el                      |   14 -
 lisp/emacs-lisp/unsafep.el                    |    2 +-
 lisp/emulation/cua-base.el                    |    8 +-
 lisp/emulation/viper-ex.el                    |   10 +-
 lisp/emulation/viper.el                       |    4 +-
 lisp/epa-hook.el                              |    2 +-
 lisp/epa-mail.el                              |    2 +-
 lisp/erc/erc-dcc.el                           |    4 +-
 lisp/eshell/em-cmpl.el                        |   10 +-
 lisp/eshell/em-dirs.el                        |    8 +-
 lisp/eshell/em-pred.el                        |    2 +-
 lisp/eshell/em-script.el                      |    2 +-
 lisp/eshell/em-tramp.el                       |    1 +
 lisp/eshell/em-unix.el                        |    2 +-
 lisp/eshell/em-xtra.el                        |    6 +-
 lisp/eshell/esh-ext.el                        |    2 +-
 lisp/eshell/esh-opt.el                        |    6 +-
 lisp/eshell/esh-proc.el                       |    6 +-
 lisp/eshell/esh-util.el                       |    5 +-
 lisp/eshell/esh-var.el                        |    2 +
 lisp/ffap.el                                  |    2 +-
 lisp/filenotify.el                            |    2 +-
 lisp/files.el                                 |   19 +-
 lisp/frame.el                                 |   13 +-
 lisp/generic-x.el                             |   25 +-
 lisp/gnus/gnus-score.el                       |    7 +-
 lisp/gnus/gnus-sum.el                         |    2 +-
 lisp/gnus/gnus.el                             |    1 +
 lisp/gnus/mm-decode.el                        |  125 +-
 lisp/gnus/mm-extern.el                        |   19 +-
 lisp/gnus/mml-sec.el                          |    3 +-
 lisp/gnus/nnheader.el                         |    2 +-
 lisp/gnus/nnir.el                             |   40 +-
 lisp/gnus/nnmaildir.el                        |   13 +-
 lisp/gnus/smime.el                            |    4 +-
 lisp/gnus/spam.el                             |  103 +-
 lisp/help.el                                  |    5 -
 lisp/hfy-cmap.el                              |   35 +-
 lisp/hilit-chg.el                             |    7 +-
 lisp/htmlfontify.el                           |   53 +-
 lisp/ibuffer.el                               |   22 +-
 lisp/ido.el                                   |   13 +-
 lisp/image.el                                 |    8 +-
 lisp/imenu.el                                 |   12 +-
 lisp/international/latin1-disp.el             |    4 -
 lisp/isearch.el                               |   85 +-
 lisp/ldefs-boot.el                            |   74 +-
 lisp/loadhist.el                              |    2 -
 lisp/mail/rmail.el                            |    6 -
 lisp/mh-e/mh-acros.el                         |    7 +-
 lisp/mh-e/mh-comp.el                          |   25 +-
 lisp/mh-e/mh-compat.el                        |    6 +-
 lisp/mh-e/mh-e.el                             |    7 +
 lisp/mh-e/mh-folder.el                        |    2 +-
 lisp/mh-e/mh-thread.el                        |   25 +-
 lisp/mh-e/mh-utils.el                         |    1 +
 lisp/minibuffer.el                            |    5 +-
 lisp/mwheel.el                                |   49 +-
 lisp/net/ange-ftp.el                          |    2 +-
 lisp/net/eudc-bob.el                          |    2 +-
 lisp/net/eww.el                               |    3 +-
 lisp/net/goto-addr.el                         |    4 -
 lisp/net/net-utils.el                         |    5 -
 lisp/net/quickurl.el                          |    9 +-
 lisp/net/tramp-adb.el                         |    4 +-
 lisp/net/tramp-archive.el                     |    8 +-
 lisp/net/tramp-sh.el                          |   12 +-
 lisp/net/tramp.el                             |    3 +-
 lisp/novice.el                                |    3 -
 lisp/obsolete/iswitchb.el                     |    2 -
 lisp/obsolete/options.el                      |  140 --
 lisp/obsolete/tpu-mapper.el                   |    4 +-
 lisp/org/org-agenda.el                        |   12 +-
 lisp/org/org-element.el                       |    2 +-
 lisp/org/org-indent.el                        |   25 +-
 lisp/org/org-pcomplete.el                     |   20 +-
 lisp/org/org-table.el                         |    2 +-
 lisp/org/org.el                               |    9 +-
 lisp/org/ox-odt.el                            |    4 +
 lisp/outline.el                               |   42 +-
 lisp/pcmpl-cvs.el                             |    8 +-
 lisp/pcmpl-gnu.el                             |    2 +-
 lisp/pcmpl-linux.el                           |    6 +-
 lisp/pcmpl-rpm.el                             |    2 +-
 lisp/pcmpl-unix.el                            |    2 +-
 lisp/pcomplete.el                             |   73 +-
 lisp/play/dunnet.el                           |    1 -
 lisp/play/gametree.el                         |    3 +-
 lisp/progmodes/ada-mode.el                    |    2 +-
 lisp/progmodes/bat-mode.el                    |    2 +
 lisp/progmodes/compile.el                     |   14 -
 lisp/progmodes/cperl-mode.el                  |   12 +-
 lisp/progmodes/ebrowse.el                     |    4 +-
 lisp/progmodes/flymake.el                     |    4 +
 lisp/progmodes/gdb-mi.el                      |    2 +-
 lisp/progmodes/glasses.el                     |    4 +-
 lisp/progmodes/grep.el                        |   57 +-
 lisp/progmodes/gud.el                         |   11 +-
 lisp/progmodes/idlw-help.el                   |    5 +-
 lisp/progmodes/meta-mode.el                   |    4 +-
 lisp/progmodes/octave.el                      |    2 +
 lisp/progmodes/pascal.el                      |    3 +-
 lisp/progmodes/perl-mode.el                   |    4 +-
 lisp/progmodes/python.el                      |   21 +-
 lisp/progmodes/sql.el                         |    3 +-
 lisp/progmodes/verilog-mode.el                |    4 +-
 lisp/progmodes/vhdl-mode.el                   |    4 +-
 lisp/progmodes/xref.el                        |    9 +-
 lisp/recentf.el                               |    4 -
 lisp/savehist.el                              |   23 -
 lisp/server.el                                |    9 +
 lisp/ses.el                                   |    4 +-
 lisp/simple.el                                |    7 +
 lisp/speedbar.el                              |   23 -
 lisp/subr.el                                  |   38 -
 lisp/term.el                                  |   19 +-
 lisp/term/pc-win.el                           |    2 +-
 lisp/textmodes/flyspell.el                    |    4 +
 lisp/textmodes/nroff-mode.el                  |    7 -
 lisp/textmodes/reftex-toc.el                  |    2 +-
 lisp/url/url-auth.el                          |    2 +-
 lisp/url/url-handlers.el                      |    3 +
 lisp/vc/add-log.el                            |    2 +-
 lisp/vc/ediff-merg.el                         |    2 +-
 lisp/vc/ediff-util.el                         |    6 +-
 lisp/vc/log-edit.el                           |   10 -
 lisp/vc/pcvs-info.el                          |    5 -
 lisp/vc/vc-dir.el                             |    2 +-
 lisp/vc/vc.el                                 |    5 -
 lisp/w32-fns.el                               |    2 +-
 lisp/woman.el                                 |    4 +-
 src/alloc.c                                   |   20 +-
 src/data.c                                    |    2 +-
 src/dispextern.h                              |   10 +
 src/editfns.c                                 |  150 +-
 src/fns.c                                     |    5 +-
 src/frame.c                                   |    2 +-
 src/lread.c                                   |    4 +-
 src/nsterm.m                                  |   26 +-
 src/print.c                                   |   57 +-
 src/process.c                                 |    8 +-
 src/term.c                                    |    4 +-
 src/w32term.c                                 |   36 +-
 src/window.c                                  |    3 +
 src/xdisp.c                                   |  103 +-
 src/xfaces.c                                  |    4 +-
 src/xterm.c                                   |   37 +-
 test/Makefile.in                              |   21 +-
 test/README                                   |    5 +
 test/lisp/dired-tests.el                      |   23 +-
 test/lisp/emacs-lisp/benchmark-tests.el       |   14 +-
 .../emacs-lisp/eieio-tests/eieio-tests.el     |   21 +-
 test/lisp/emacs-lisp/package-tests.el         |    4 +-
 test/lisp/eshell/em-ls-tests.el               |    1 +
 test/lisp/hi-lock-tests.el                    |    4 +-
 test/lisp/international/mule-tests.el         |    3 +
 test/lisp/ls-lisp-tests.el                    |    1 +
 test/lisp/net/tramp-archive-tests.el          |    4 +-
 test/lisp/net/tramp-tests.el                  |    3 +
 test/lisp/progmodes/bat-mode-tests.el         |    5 +-
 test/lisp/progmodes/ruby-mode-tests.el        |    6 +-
 test/lisp/ses-tests.el                        |   80 +-
 test/lisp/simple-tests.el                     |   13 +-
 test/lisp/term-tests.el                       |   12 +
 test/lisp/vc/diff-mode-tests.el               |    2 +-
 test/lisp/vc/vc-tests.el                      |    2 +-
 test/src/eval-tests.el                        |   20 +
 test/src/json-tests.el                        |    5 +
 291 files changed, 4005 insertions(+), 3865 deletions(-)
 delete mode 100644 lisp/obsolete/options.el

diff --git a/Makefile.in b/Makefile.in
index 7a178004cd..95771e0193 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -1180,6 +1180,7 @@ check-declare:
 	  exit 1; \
 	fi
 	$(MAKE) -C lisp $@
+	$(MAKE) -C test $@
 
 .PHONY: rustfmt
 
diff --git a/admin/automerge b/admin/automerge
index 520961f1e8..e88711f8d6 100755
--- a/admin/automerge
+++ b/admin/automerge
@@ -138,7 +138,7 @@ trap "rm -f $tempfile 2> /dev/null" EXIT
 
 [ "$reset" ] && {
     echo "Resetting..."
-    git reset --hard origin/master || die "reset error"
+    git reset -q --hard origin/master || die "reset error"
 
     echo "Pulling..."
     git pull -q --ff-only || die "pull error"
diff --git a/admin/grammars/scheme.by b/admin/grammars/scheme.by
index ce9fff0286..5ea25508fd 100644
--- a/admin/grammars/scheme.by
+++ b/admin/grammars/scheme.by
@@ -20,6 +20,11 @@
 %package semantic-scm-by
 %provide semantic/bovine/scm-by
 
+%{
+(declare-function semantic-parse-region "semantic"
+		  (start end &optional nonterminal depth returnonerror))
+}
+
 %languagemode  scheme-mode
 %start         scheme
 
diff --git a/build-aux/config.guess b/build-aux/config.guess
index f50dcdb6de..958a24cdf4 100755
--- a/build-aux/config.guess
+++ b/build-aux/config.guess
@@ -2,7 +2,7 @@
 # Attempt to guess a canonical system name.
 #   Copyright 1992-2018 Free Software Foundation, Inc.
 
-timestamp='2018-02-24'
+timestamp='2018-03-08'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -1473,7 +1473,7 @@ EOF
 exit 1
 
 # Local variables:
-# eval: (add-hook 'write-file-functions 'time-stamp)
+# eval: (add-hook 'before-save-hook 'time-stamp)
 # time-stamp-start: "timestamp='"
 # time-stamp-format: "%:y-%02m-%02d"
 # time-stamp-end: "'"
diff --git a/build-aux/config.sub b/build-aux/config.sub
index 1d8e98bcee..9ccf09a7a3 100755
--- a/build-aux/config.sub
+++ b/build-aux/config.sub
@@ -2,7 +2,7 @@
 # Configuration validation subroutine script.
 #   Copyright 1992-2018 Free Software Foundation, Inc.
 
-timestamp='2018-02-22'
+timestamp='2018-03-08'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -1376,7 +1376,7 @@ case $os in
 	      | -ekkobsd* | -kfreebsd* | -freebsd* | -riscix* | -lynxos* \
 	      | -bosx* | -nextstep* | -cxux* | -aout* | -elf* | -oabi* \
 	      | -ptx* | -coff* | -ecoff* | -winnt* | -domain* | -vsta* \
-	      | -udi* | -eabi* | -lites* | -ieee* | -go32* | -aux* \
+	      | -udi* | -eabi* | -lites* | -ieee* | -go32* | -aux* | -hcos* \
 	      | -chorusos* | -chorusrdb* | -cegcc* | -glidix* \
 	      | -cygwin* | -msys* | -pe* | -psos* | -moss* | -proelf* | -rtems* \
 	      | -midipix* | -mingw32* | -mingw64* | -linux-gnu* | -linux-android* \
@@ -1794,7 +1794,7 @@ echo "$basic_machine$os"
 exit
 
 # Local variables:
-# eval: (add-hook 'write-file-functions 'time-stamp)
+# eval: (add-hook 'before-save-hook 'time-stamp)
 # time-stamp-start: "timestamp='"
 # time-stamp-format: "%:y-%02m-%02d"
 # time-stamp-end: "'"
diff --git a/build-aux/install-sh b/build-aux/install-sh
index ac159ceda4..5f3d36cb76 100755
--- a/build-aux/install-sh
+++ b/build-aux/install-sh
@@ -1,7 +1,7 @@
 #!/bin/sh
 # install - install a program, script, or datafile
 
-scriptversion=2017-09-23.17; # UTC
+scriptversion=2018-03-07.03; # UTC
 
 # This originates from X11R5 (mit/util/scripts/install.sh), which was
 # later released in X11R6 (xc/config/util/install.sh) with the
@@ -501,7 +501,7 @@ do
 done
 
 # Local variables:
-# eval: (add-hook 'write-file-hooks 'time-stamp)
+# eval: (add-hook 'before-save-hook 'time-stamp)
 # time-stamp-start: "scriptversion="
 # time-stamp-format: "%:y-%02m-%02d.%02H"
 # time-stamp-time-zone: "UTC0"
diff --git a/build-aux/move-if-change b/build-aux/move-if-change
index f15923613c..5da3eae80a 100755
--- a/build-aux/move-if-change
+++ b/build-aux/move-if-change
@@ -2,7 +2,7 @@
 # Like mv $1 $2, but if the files are the same, just delete $1.
 # Status is zero if successful, nonzero otherwise.
 
-VERSION='2017-09-13 06:45'; # UTC
+VERSION='2018-03-07 03:47'; # UTC
 # The definition above must lie within the first 8 lines in order
 # for the Emacs time-stamp write hook (at end) to update it.
 # If you change this file with Emacs, please let the write hook
@@ -75,7 +75,7 @@ else
 fi
 
 ## Local Variables:
-## eval: (add-hook 'write-file-hooks 'time-stamp)
+## eval: (add-hook 'before-save-hook 'time-stamp)
 ## time-stamp-start: "VERSION='"
 ## time-stamp-format: "%:y-%02m-%02d %02H:%02M"
 ## time-stamp-time-zone: "UTC0"
diff --git a/build-aux/update-copyright b/build-aux/update-copyright
index 3bb26abea1..f2fc97e368 100755
--- a/build-aux/update-copyright
+++ b/build-aux/update-copyright
@@ -3,7 +3,7 @@ eval '(exit $?0)' && eval 'exec perl -wS -0777 -pi "$0" "$@"'
     if 0;
 # Update an FSF copyright year list to include the current year.
 
-my $VERSION = '2018-01-04.14:48'; # UTC
+my $VERSION = '2018-03-07.03:47'; # UTC
 
 # Copyright (C) 2009-2018 Free Software Foundation, Inc.
 #
@@ -269,7 +269,7 @@ else
 # coding: utf-8
 # mode: perl
 # indent-tabs-mode: nil
-# eval: (add-hook 'write-file-hooks 'time-stamp)
+# eval: (add-hook 'before-save-hook 'time-stamp)
 # time-stamp-start: "my $VERSION = '"
 # time-stamp-format: "%:y-%02m-%02d.%02H:%02M"
 # time-stamp-time-zone: "UTC0"
diff --git a/configure.ac b/configure.ac
index 141cfe2b0f..34b9bcffee 100644
--- a/configure.ac
+++ b/configure.ac
@@ -365,7 +365,12 @@ OPTION_DEFAULT_OFF([w32], [use native MS Windows GUI in a Cygwin build])
 OPTION_DEFAULT_ON([gpm],[don't use -lgpm for mouse support on a GNU/Linux console])
 OPTION_DEFAULT_ON([dbus],[don't compile with D-Bus support])
 AC_ARG_WITH([gconf],[AS_HELP_STRING([--with-gconf],
-[compile with Gconf support (Gsettings replaces this)])],[],[with_gconf=maybe])
+[compile with Gconf support (Gsettings replaces this)])],[],
+[if test $with_features = yes; then
+with_gconf=maybe
+else
+with_gconf=no
+fi])
 OPTION_DEFAULT_ON([gsettings],[don't compile with GSettings support])
 OPTION_DEFAULT_ON([selinux],[don't compile with SELinux support])
 OPTION_DEFAULT_ON([gnutls],[don't use -lgnutls for SSL/TLS support])
@@ -3381,6 +3386,26 @@ fi
 AC_SUBST(LCMS2_CFLAGS)
 AC_SUBST(LCMS2_LIBS)
 
+HAVE_ZLIB=no
+LIBZ=
+if test "${with_zlib}" != "no"; then
+  OLIBS=$LIBS
+  AC_SEARCH_LIBS([inflateEnd], [z], [HAVE_ZLIB=yes])
+  LIBS=$OLIBS
+  case $ac_cv_search_inflateEnd in
+    -*) LIBZ=$ac_cv_search_inflateEnd ;;
+  esac
+fi
+if test "${HAVE_ZLIB}" = "yes"; then
+  AC_DEFINE([HAVE_ZLIB], 1, [Define to 1 if you have the zlib library (-lz).])
+  ### mingw32 doesn't use -lz, since it loads the library dynamically.
+  if test "${opsys}" = "mingw32"; then
+     LIBZ=
+  fi
+fi
+AC_SUBST(ZLIB_CFLAGS)
+AC_SUBST(ZLIB_LIBS)
+
 ### Dynamic modules support
 LIBMODULES=
 HAVE_MODULES=no
diff --git a/doc/emacs/basic.texi b/doc/emacs/basic.texi
index aa91f0555e..3fec5f44de 100644
--- a/doc/emacs/basic.texi
+++ b/doc/emacs/basic.texi
@@ -218,14 +218,14 @@ preserves position within the line, like @kbd{C-n}.
 @item C-a
 @itemx @key{Home}
 @kindex C-a
-@kindex HOME key
+@kindex HOME
 @findex move-beginning-of-line
 Move to the beginning of the line (@code{move-beginning-of-line}).
 
 @item C-e
 @itemx @key{End}
 @kindex C-e
-@kindex END key
+@kindex END
 @findex move-end-of-line
 Move to the end of the line (@code{move-end-of-line}).
 
@@ -277,7 +277,7 @@ On graphical displays, @kbd{C-@key{HOME}} does the same.
 
 @item M->
 @kindex M->
-@kindex C-@key{END}
+@kindex C-END
 @findex end-of-buffer
 Move to the end of the buffer (@code{end-of-buffer}).  On graphical
 displays, @kbd{C-@key{END}} does the same.
@@ -728,7 +728,7 @@ direction.
 @findex digit-argument
 @findex negative-argument
   The easiest way to specify a numeric argument is to type a digit
-and/or a minus sign while holding down the @key{META} key.  For
+and/or a minus sign while holding down the @key{Meta} key.  For
 example,
 
 @example
@@ -742,7 +742,7 @@ well as @kbd{M--}, are bound to commands (@code{digit-argument} and
 command.  @kbd{M--} without digits normally means @minus{}1.
 
 If you enter more than one digit, you need not hold down the
-@key{META} key for the second and subsequent digits.  Thus, to move
+@key{Meta} key for the second and subsequent digits.  Thus, to move
 down fifty lines, type
 
 @example
diff --git a/doc/emacs/buffers.texi b/doc/emacs/buffers.texi
index f8c1856058..dd7a653186 100644
--- a/doc/emacs/buffers.texi
+++ b/doc/emacs/buffers.texi
@@ -32,6 +32,13 @@ buffer.  When there is only one Emacs window, the buffer displayed in
 that window is current.  When there are multiple windows, the buffer
 displayed in the @dfn{selected window} is current.  @xref{Windows}.
 
+@cindex buffer contents
+@cindex contents of a buffer
+  A buffer's @dfn{contents} consist of a series of characters, each of
+which optionally carries a set of text properties
+(@pxref{International Chars, Text properties}) that can specify more
+information about that character.
+
   Aside from its textual contents, each buffer records several pieces
 of information, such as what file it is visiting (if any), whether it
 is modified, and what major mode and minor modes are in effect
@@ -231,13 +238,14 @@ Scroll through buffer @var{buffer}.  @xref{View Mode}.
 @kindex C-x C-q
 @vindex buffer-read-only
 @cindex read-only buffer
-  A buffer can be @dfn{read-only}, which means that commands to change
-its contents are not allowed.  The mode line indicates read-only
-buffers with @samp{%%} or @samp{%*} near the left margin.  @xref{Mode
-Line}.  Read-only buffers are usually made by subsystems such as Dired
-and Rmail that have special commands to operate on the text.  Visiting
-a file whose access control says you cannot write it also makes the
-buffer read-only.
+  A buffer can be @dfn{read-only}, which means that commands to insert
+or delete its text are not allowed.  (However, other commands, like
+@kbd{C-x @key{RET} f}, can still mark it as modified, @pxref{Text
+Coding}).  The mode line indicates read-only buffers with @samp{%%} or
+@samp{%*} near the left margin.  @xref{Mode Line}.  Read-only buffers
+are usually made by subsystems such as Dired and Rmail that have
+special commands to operate on the text.  Visiting a file whose access
+control says you cannot write it also makes the buffer read-only.
 
 @findex read-only-mode
 @vindex view-read-only
diff --git a/doc/emacs/building.texi b/doc/emacs/building.texi
index d79efd089f..d751cb4c48 100644
--- a/doc/emacs/building.texi
+++ b/doc/emacs/building.texi
@@ -427,14 +427,17 @@ the variable @code{grep-files-aliases}.
 @kbd{M-x rgrep}.  The default value includes the data directories used
 by various version control systems.
 
-@vindex grep-find-hide
+@vindex grep-find-abbreviate
+@findex grep-find-toggle-abbreviation
   By default, the shell commands constructed for @code{lgrep},
 @code{rgrep}, and @code{zgrep} are abbreviated for display by
 concealing the part that contains a long list of files and directories
 to ignore.  You can reveal the concealed part by clicking on the
-button with ellipsis, which represents them.  To disable this
-abbreviation of the shell commands, customize the option
-@code{grep-find-hide} to a @code{nil} value.
+button with ellipsis, which represents them.  You can also
+interactively toggle viewing the concealed part by typing @kbd{M-x
+grep-find-toggle-abbreviation}.  To disable this abbreviation of the
+shell commands, customize the option @code{grep-find-abbreviate} to a
+@code{nil} value.
 
 @node Flymake
 @section Finding Syntax Errors On The Fly
@@ -1492,7 +1495,7 @@ Evaluate all the Emacs Lisp expressions in the buffer.
 @ifinfo
 @c This uses 'colon' instead of a literal ':' because Info cannot
 @c cope with a ':' in a menu.
-@kindex M-@key{colon}
+@kindex M-colon
 @end ifinfo
 @ifnotinfo
 @kindex M-:
diff --git a/doc/emacs/commands.texi b/doc/emacs/commands.texi
index 8b8b0c7aad..a992dedc92 100644
--- a/doc/emacs/commands.texi
+++ b/doc/emacs/commands.texi
@@ -44,25 +44,25 @@ are certain characters found on non-English keyboards
 @cindex M-
   Emacs also recognizes control characters that are entered using
 @dfn{modifier keys}.  Two commonly-used modifier keys are
-@key{Control} (usually labeled @key{Ctrl}), and @key{META} (usually
-labeled @key{Alt})@footnote{We refer to @key{Alt} as @key{META} for
+@key{Control} (usually labeled @key{Ctrl}), and @key{Meta} (usually
+labeled @key{Alt})@footnote{We refer to @key{Alt} as @key{Meta} for
 historical reasons.}.  For example, @kbd{Control-a} is entered by
 holding down the @key{Ctrl} key while pressing @kbd{a}; we will refer
-to this as @kbd{C-a} for short.  Similarly, @kbd{@key{META}-a}, or @kbd{M-a}
+to this as @kbd{C-a} for short.  Similarly, @kbd{@key{Meta}-a}, or @kbd{M-a}
 for short, is entered by holding down the @key{Alt} key and pressing
 @kbd{a}.  Modifier keys can also be applied to non-alphanumerical
 characters, e.g., @kbd{C-@key{F1}} or @kbd{M-@key{LEFT}}.
 
-@cindex @key{ESC} replacing @key{META} key
+@cindex @key{ESC} replacing @key{Meta} key
   You can also type Meta characters using two-character sequences
 starting with @key{ESC}.  Thus, you can enter @kbd{M-a} by typing
 @kbd{@key{ESC} a}.  You can enter @kbd{C-M-a} (holding down both
 @key{Ctrl} and @key{Alt}, then pressing @kbd{a}) by typing
-@kbd{@key{ESC} C-a}.  Unlike @key{META}, @key{ESC} is entered as a
+@kbd{@key{ESC} C-a}.  Unlike @key{Meta}, @key{ESC} is entered as a
 separate character.  You don't hold down @key{ESC} while typing the
 next character; instead, press @key{ESC} and release it, then enter
 the next character.  This feature is useful on certain text terminals
-where the @key{META} key does not function reliably.
+where the @key{Meta} key does not function reliably.
 
 @cindex keys stolen by window manager
 @cindex window manager, keys stolen by
diff --git a/doc/emacs/custom.texi b/doc/emacs/custom.texi
index 05925f043c..a5ce85440a 100644
--- a/doc/emacs/custom.texi
+++ b/doc/emacs/custom.texi
@@ -1414,6 +1414,8 @@ commands, and @dfn{keymaps}, which record key bindings.  It also
 explains how to customize key bindings, which is done by editing your
 init file (@pxref{Init Rebinding}).
 
+@cindex reserved key bindings
+@cindex keys, reserved
   Since most modes define their own key bindings, activating a mode
 might override your custom key bindings.  A small number of keys are
 reserved for user-defined bindings, and should not be used by modes,
@@ -1740,10 +1742,11 @@ characters.  For example, here's how to bind @kbd{C-x M-l} to
 (global-set-key "\C-x\M-l" 'make-symbolic-link)
 @end example
 
-  To put @key{TAB}, @key{RET}, @key{ESC}, or @key{DEL} in the string,
-use the Emacs Lisp escape sequences @samp{\t}, @samp{\r}, @samp{\e},
-and @samp{\d} respectively.  Here is an example which binds @kbd{C-x
-@key{TAB}} to @code{indent-rigidly} (@pxref{Indentation}):
+  To bind a key sequence including @key{TAB}, @key{RET}, @key{ESC}, or
+@key{DEL}, the string should contain the Emacs Lisp escape sequence
+@samp{\t}, @samp{\r}, @samp{\e}, or @samp{\d} respectively.  Here is
+an example which binds @kbd{C-x @key{TAB}} to @code{indent-rigidly}
+(@pxref{Indentation}):
 
 @example
 (global-set-key "\C-x\t" 'indent-rigidly)
@@ -1817,11 +1820,11 @@ historical.
 characters case-sensitive when you customize Emacs.  For instance, you
 could make @kbd{M-a} and @kbd{M-A} run different commands.
 
-  Although only the @key{Control} and @key{META} modifier keys are
+  Although only the @key{Control} and @key{Meta} modifier keys are
 commonly used, Emacs supports three other modifier keys.  These are
 called @key{Super}, @key{Hyper}, and @key{Alt}.  Few terminals provide
 ways to use these modifiers; the key labeled @key{Alt} on most
-keyboards usually issues the @key{META} modifier, not @key{Alt}.  The
+keyboards usually issues the @key{Meta} modifier, not @key{Alt}.  The
 standard key bindings in Emacs do not include any characters with
 these modifiers.  However, you can customize Emacs to assign meanings
 to them.  The modifier bits are labeled as @samp{s-}, @samp{H-} and
@@ -1891,7 +1894,7 @@ the numeric keypad produces @code{kp-8}, which is translated to
 such as @kbd{8} or @key{UP}, it affects the equivalent keypad key too.
 However, if you rebind a @samp{kp-} key directly, that won't affect
 its non-keypad equivalent.  Note that the modified keys are not
-translated: for instance, if you hold down the @key{META} key while
+translated: for instance, if you hold down the @key{Meta} key while
 pressing the @samp{8} key on the numeric keypad, that generates
 @kbd{M-@key{kp-8}}.
 
@@ -2159,7 +2162,7 @@ loading of this library, use the option @samp{--no-site-file}.
 better to put them in @file{default.el}, so that users can more easily
 override them.
 
-@cindex site-lisp directories
+@cindex @file{site-lisp} directories
   You can place @file{default.el} and @file{site-start.el} in any of
 the directories which Emacs searches for Lisp libraries.  The variable
 @code{load-path} (@pxref{Lisp Libraries}) specifies these directories.
@@ -2237,8 +2240,8 @@ sequences are mandatory.
 
 @samp{\C-} can be used as a prefix for a control character, as in
 @samp{\C-s} for @acronym{ASCII} control-S, and @samp{\M-} can be used as a prefix for
-a Meta character, as in @samp{\M-a} for @kbd{@key{META}-A} or
-@samp{\M-\C-a} for @kbd{@key{Ctrl}-@key{META}-A}.
+a Meta character, as in @samp{\M-a} for @kbd{@key{Meta}-A} or
+@samp{\M-\C-a} for @kbd{@key{Ctrl}-@key{Meta}-A}.
 
 @xref{Init Non-ASCII}, for information about including
 non-@acronym{ASCII} in your init file.
diff --git a/doc/emacs/dired.texi b/doc/emacs/dired.texi
index b924a6d16b..f99377d1f7 100644
--- a/doc/emacs/dired.texi
+++ b/doc/emacs/dired.texi
@@ -1240,7 +1240,7 @@ contents of the corresponding subdirectory.
   If you use @kbd{C-x d} or some other Dired command to visit a
 directory that is already being shown in a Dired buffer, Dired
 switches to that buffer but does not update it.  If the buffer is not
-up-to-date, Dired displays a warning telling you to type @key{g} to
+up-to-date, Dired displays a warning telling you to type @kbd{g} to
 update it.  You can also tell Emacs to revert each Dired buffer
 automatically when you revisit it, by setting the variable
 @code{dired-auto-revert-buffer} to a non-@code{nil} value.
@@ -1370,8 +1370,8 @@ C-c}.
 
 @node Image-Dired
 @section Viewing Image Thumbnails in Dired
-@cindex image-dired mode
-@cindex image-dired
+@cindex @code{image-dired} mode
+@cindex @code{image-dired}
 
   Image-Dired is a facility for browsing image files.  It provides viewing
 the images either as thumbnails or in full size, either inside Emacs
diff --git a/doc/emacs/display.texi b/doc/emacs/display.texi
index 64a1d4b5fa..42a5227983 100644
--- a/doc/emacs/display.texi
+++ b/doc/emacs/display.texi
@@ -526,7 +526,7 @@ frames as if they have a dark background, whereas a value of
 background.
 
 @cindex background color
-@cindex default face
+@cindex @code{default face}
   You can customize a face to alter its attributes, and save those
 customizations for future Emacs sessions.  @xref{Face Customization},
 for details.
@@ -535,7 +535,7 @@ for details.
 of its attributes are specified.  Its background color is also used as
 the frame's background color.  @xref{Colors}.
 
-@cindex cursor face
+@cindex @code{cursor} face
   Another special face is the @code{cursor} face.  On graphical
 displays, the background color of this face is used to draw the text
 cursor.  None of the other attributes of this face have any effect;
@@ -627,10 +627,10 @@ but you should not make it a variable-width font.
 @item fixed-pitch-serif
 This face is like @code{fixed-pitch}, except the font has serifs and
 looks more like traditional typewriting.
-@cindex variable-pitch face
+@cindex @code{variable-pitch} face
 @item variable-pitch
 This face forces use of a variable-width font.
-@cindex shadow face
+@cindex @code{shadow} face
 @item shadow
 This face is used for making the text less noticeable than the surrounding
 ordinary text.  Usually this can be achieved by using shades of gray in
@@ -656,8 +656,8 @@ This face is used to highlight lazy matches for Isearch and Query
 Replace (matches other than the current one).
 @item region
 This face is used for displaying an active region (@pxref{Mark}).
-When Emacs is built with GTK support, its colors are taken from the
-current GTK theme.
+When Emacs is built with GTK+ support, its colors are taken from the
+current GTK+ theme.
 @item secondary-selection
 This face is used for displaying a secondary X selection (@pxref{Secondary
 Selection}).
@@ -685,40 +685,40 @@ frame:
 
 @table @code
 @item mode-line
-@cindex mode-line face
+@cindex @code{mode-line} face
 @cindex faces for mode lines
 This face is used for the mode line of the currently selected window,
 and for menu bars when toolkit menus are not used.  By default, it's
 drawn with shadows for a raised effect on graphical displays, and
 drawn as the inverse of the default face on non-windowed terminals.
 @item mode-line-inactive
-@cindex mode-line-inactive face
+@cindex @code{mode-line-inactive} face
 Like @code{mode-line}, but used for mode lines of the windows other
 than the selected one (if @code{mode-line-in-non-selected-windows} is
 non-@code{nil}).  This face inherits from @code{mode-line}, so changes
 in that face affect mode lines in all windows.
 @item mode-line-highlight
-@cindex mode-line-highlight face
+@cindex @code{mode-line-highlight} face
 Like @code{highlight}, but used for mouse-sensitive portions of text
 on mode lines.  Such portions of text typically pop up tooltips
 (@pxref{Tooltips}) when the mouse pointer hovers above them.
 @item mode-line-buffer-id
-@cindex mode-line-buffer-id face
+@cindex @code{mode-line-buffer-id} face
 This face is used for buffer identification parts in the mode line.
 @item header-line
-@cindex header-line face
+@cindex @code{header-line} face
 Similar to @code{mode-line} for a window's header line, which appears
 at the top of a window just as the mode line appears at the bottom.
 Most windows do not have a header line---only some special modes, such
 Info mode, create one.
 @item header-line-highlight
-@cindex header-line-highlight face
+@cindex @code{header-line-highlight} face
 Similar to @code{highlight} and @code{mode-line-highlight}, but used
 for mouse-sensitive portions of text on header lines.  This is a
 separate face because the @code{header-line} face might be customized
 in a way that does not interact well with @code{highlight}.
 @item vertical-border
-@cindex vertical-border face
+@cindex @code{vertical-border} face
 This face is used for the vertical divider between windows on text
 terminals.
 @item minibuffer-prompt
@@ -741,7 +741,7 @@ The @code{:background} attribute of this face specifies the color of
 the text cursor.  @xref{Cursor Display}.
 @item tooltip
 This face is used for tooltip text.  By default, if Emacs is built
-with GTK support, tooltips are drawn via GTK and this face has no
+with GTK+ support, tooltips are drawn via GTK+ and this face has no
 effect.  @xref{Tooltips}.
 @item mouse
 This face determines the color of the mouse pointer.
@@ -971,7 +971,7 @@ version.)
 Highlight text that matches @var{regexp} using face @var{face}
 (@code{highlight-regexp}).  The highlighting will remain as long as
 the buffer is loaded.  For example, to highlight all occurrences of
-the word ``whim'' using the default face (a yellow background)
+the word ``whim'' using the default face (a yellow background), type
 @kbd{M-s h r whim @key{RET} @key{RET}}.  Any face can be used for
 highlighting, Hi Lock provides several of its own and these are
 pre-loaded into a list of default values.  While being prompted
@@ -1177,7 +1177,7 @@ empty lines at the end of a buffer, without realizing it.  In most
 cases, this @dfn{trailing whitespace} has no effect, but sometimes it
 can be a nuisance.
 
-@cindex trailing-whitespace face
+@cindex @code{trailing-whitespace} face
   You can make trailing whitespace at the end of a line visible by
 setting the buffer-local variable @code{show-trailing-whitespace} to
 @code{t}.  Then Emacs displays trailing whitespace, using the face
@@ -1258,7 +1258,7 @@ Highlight empty lines.
 @item big-indent
 @vindex whitespace-big-indent-regexp
 Highlight too-deep indentation.  By default any sequence of at least 4
-consecutive TAB characters or 32 consecutive SPC characters is
+consecutive tab characters or 32 consecutive space characters is
 highlighted.  To change that, customize the regular expression
 @code{whitespace-big-indent-regexp}.
 
@@ -1508,8 +1508,8 @@ as octal escape sequences instead of caret escape sequences.
 @cindex non-breaking space
 @cindex non-breaking hyphen
 @cindex soft hyphen
-@cindex escape-glyph face
-@cindex nobreak-space face
+@cindex @code{escape-glyph} face
+@cindex @code{nobreak-space} face
   Some non-@acronym{ASCII} characters have the same appearance as an
 @acronym{ASCII} space or hyphen (minus) character.  Such characters
 can cause problems if they are entered into a buffer without your
@@ -1531,7 +1531,7 @@ elisp, The Emacs Lisp Reference Manual}.
 
 @cindex glyphless characters
 @cindex characters with no font glyphs
-@cindex glyphless-char face
+@cindex @code{glyphless-char} face
   On graphical displays, some characters may have no glyphs in any of
 the fonts available to Emacs.  These @dfn{glyphless characters} are
 normally displayed as boxes containing the hexadecimal character code.
@@ -1546,7 +1546,7 @@ for details.
 
 @cindex curly quotes, and terminal capabilities
 @cindex curved quotes, and terminal capabilities
-@cindex homoglyph face
+@cindex @code{homoglyph} face
 
 Emacs tries to determine if the curved quotes @samp{‘} and @samp{’}
 can be displayed on the current display.  By default, if this seems to
@@ -1649,8 +1649,8 @@ Emacs can display long lines by @dfn{truncation}.  This means that all
 the characters that do not fit in the width of the screen or window do
 not appear at all.  On graphical displays, a small straight arrow in
 the fringe indicates truncation at either end of the line.  On text
-terminals, this is indicated with @samp{$} signs in the leftmost
-and/or rightmost columns.
+terminals, this is indicated with @samp{$} signs in the rightmost
+and/or leftmost columns.
 
 @vindex truncate-lines
 @findex toggle-truncate-lines
@@ -1676,8 +1676,9 @@ line truncation.  @xref{Split Window}, for the variable
 @dfn{word wrap}.  Here, each long logical line is divided into two or
 more screen lines, like in ordinary line continuation.  However, Emacs
 attempts to wrap the line at word boundaries near the right window
-edge.  This makes the text easier to read, as wrapping does not occur
-in the middle of words.
+edge.  (If the line's direction is right-to-left, it is wrapped at the
+left window edge instead.)  This makes the text easier to read, as
+wrapping does not occur in the middle of words.
 
 @cindex mode, Visual Line
 @cindex Visual Line mode
@@ -1688,8 +1689,8 @@ To turn on Visual Line mode in the current buffer, type @kbd{M-x
 visual-line-mode}; repeating this command turns it off.  You can also
 turn on Visual Line mode using the menu bar: in the Options menu,
 select the @samp{Line Wrapping in this Buffer} submenu, followed by
-the @samp{Word Wrap (Visual Line Mode)} menu item.  While Visual Line
-mode is enabled, the mode-line shows the string @samp{wrap} in the
+the @samp{Word Wrap (Visual Line mode)} menu item.  While Visual Line
+mode is enabled, the mode line shows the string @samp{wrap} in the
 mode display.  The command @kbd{M-x global-visual-line-mode} toggles
 Visual Line mode in all buffers.
 
@@ -1801,7 +1802,7 @@ may wish to customize the variables
 @code{display-line-numbers-width} to a large enough value, to avoid
 occasional miscalculations of space reserved for the line numbers.
 
-@cindex line-number face
+@cindex @code{line-number} face
 The line numbers are displayed in a special face @code{line-number}.
 The current line number is displayed in a different face,
 @code{line-number-current-line}, so you can make the current line's
diff --git a/doc/emacs/emacs.texi b/doc/emacs/emacs.texi
index e289cb5802..a9be170241 100644
--- a/doc/emacs/emacs.texi
+++ b/doc/emacs/emacs.texi
@@ -1223,8 +1223,8 @@ GTK resources
 
 * GTK Resource Basics::   Basic usage of GTK+ resources.
 * GTK Widget Names::      How GTK+ widgets are named.
-* GTK Names in Emacs::    GTK widgets used by Emacs.
-* GTK styles::            What can be customized in a GTK widget.
+* GTK Names in Emacs::    GTK+ widgets used by Emacs.
+* GTK styles::            What can be customized in a GTK+ widget.
 
 Emacs and macOS / GNUstep
 
diff --git a/doc/emacs/files.texi b/doc/emacs/files.texi
index 3fc0dc915e..034a4edfd6 100644
--- a/doc/emacs/files.texi
+++ b/doc/emacs/files.texi
@@ -281,7 +281,7 @@ files.  Firstly, when Emacs is built with a suitable GUI toolkit,
 commands invoked with the mouse (by clicking on the menu bar or tool
 bar) use the toolkit's standard file selection dialog instead of
 prompting for the file name in the minibuffer.  On GNU/Linux and Unix
-platforms, Emacs does this when built with GTK, LessTif, and Motif
+platforms, Emacs does this when built with GTK+, LessTif, and Motif
 toolkits; on MS-Windows and Mac, the GUI version does that by default.
 For information on how to customize this, see @ref{Dialog Boxes}.
 
@@ -400,11 +400,14 @@ possible responses are analogous to those of @code{query-replace}:
 
 @table @kbd
 @item y
+@item @key{SPC}
 Save this buffer and ask about the rest of the buffers.
 @item n
+@item @key{DEL}
 Don't save this buffer, but ask about the rest of the buffers.
 @item !
 Save this buffer and all the rest with no more questions.
+@item q
 @c following generates acceptable underfull hbox
 @item @key{RET}
 Terminate @code{save-some-buffers} without any more saving.
@@ -1857,7 +1860,7 @@ variable @code{tramp-mode} to @code{nil}.  You can turn off the
 feature in individual cases by quoting the file name with @samp{/:}
 (@pxref{Quoted File Names}).
 
-@cindex ange-ftp
+@cindex @code{ange-ftp}
   Remote file access through FTP is handled by the Ange-FTP package, which
 is documented in the following.  Remote file access through the other
 methods is handled by the Tramp package, which has its own manual.
diff --git a/doc/emacs/fixit.texi b/doc/emacs/fixit.texi
index 7cacac4240..0cb8565c6a 100644
--- a/doc/emacs/fixit.texi
+++ b/doc/emacs/fixit.texi
@@ -149,6 +149,12 @@ Transpose two words (@code{transpose-words}).
 Transpose two balanced expressions (@code{transpose-sexps}).
 @item C-x C-t
 Transpose two lines (@code{transpose-lines}).
+@item M-x transpose-sentences
+Transpose two sentences (@code{transpose-sentences}).
+@item M-x transpose-paragraphs
+Transpose two paragraphs (@code{transpose-paragraphs}).
+@item M-x transpose-regions
+Transpose two regions.
 @end table
 
 @kindex C-t
@@ -183,10 +189,14 @@ punctuation characters between the words do not move.  For example,
 @samp{@w{BAR FOO,}}.  When point is at the end of the line, it will
 transpose the word before point with the first word on the next line.
 
+@findex transpose-sentences
+@findex transpose-paragraphs
   @kbd{C-M-t} (@code{transpose-sexps}) is a similar command for
 transposing two expressions (@pxref{Expressions}), and @kbd{C-x C-t}
-(@code{transpose-lines}) exchanges lines.  They work like @kbd{M-t}
-except as regards the units of text they transpose.
+(@code{transpose-lines}) exchanges lines.  @kbd{M-x
+transpose-sentences} and @kbd{M-x transpose-paragraphs} transpose
+sentences and paragraphs, respectively.  These commands work like
+@kbd{M-t} except as regards the units of text they transpose.
 
   A numeric argument to a transpose command serves as a repeat count: it
 tells the transpose command to move the character (or word or
@@ -204,6 +214,15 @@ otherwise a command with a repeat count of zero would do nothing): to
 transpose the character (or word or expression or line) ending after
 point with the one ending after the mark.
 
+@findex transpose-regions
+  @kbd{M-x transpose-regions} transposes the text between point and
+mark with the text between the last two marks pushed to the mark ring
+(@pxref{Setting Mark}).  With a numeric prefix argument, it transposes
+the text between point and mark with the text between two successive
+marks that many entries back in the mark ring.  This command is best
+used for transposing multiple characters (or words or sentences or
+paragraphs) in one go.
+
 @node Fixing Case
 @section Case Conversion
 
diff --git a/doc/emacs/frames.texi b/doc/emacs/frames.texi
index 84e0fb2d25..35ffe95e49 100644
--- a/doc/emacs/frames.texi
+++ b/doc/emacs/frames.texi
@@ -200,13 +200,13 @@ buffers are scrolled.  The variable
 @code{mouse-wheel-progressive-speed} determines whether the scroll
 speed is linked to how fast you move the wheel.
 
-@vindex mwheel-tilt-scroll-p
-@vindex mwheel-flip-direction
+@vindex mouse-wheel-tilt-scroll
+@vindex mouse-wheel-flip-direction
 Emacs can also support horizontal scrolling if your mouse's wheel can
 be tilted.  This feature is off by default; the variable
-@code{mwheel-tilt-scroll-p} turns it on.  If you'd like to reverse the
-direction of horizontal scrolling, customize the variable
-@code{mwheel-flip-direction} to a non-@code{nil} value.
+@code{mouse-wheel-tilt-scroll} turns it on.  If you'd like to reverse
+the direction of horizontal scrolling, customize the variable
+@code{mouse-wheel-flip-direction} to a non-@code{nil} value.
 
 
 @node Word and Line Mouse
@@ -472,14 +472,14 @@ cycles through all the frames on your terminal.
 @findex delete-other-frames
 Delete all frames on the current terminal, except the selected one.
 
-@item M-<F10>
-@kindex M-<F10>
+@item M-@key{F10}
+@kindex M-F10
 @findex toggle-frame-maximized
 Toggle the maximization state of the current frame.  When a frame is
 maximized, it fills the screen.
 
-@item <F11>
-@kindex <F11>
+@item @key{F11>}
+@kindex F11
 @findex toggle-frame-fullscreen
 Toggle full-screen mode for the current frame.  (The difference
 between full-screen and maximized is normally that the former
@@ -894,7 +894,7 @@ that server's selected frame.
 
 @node Frame Parameters
 @section Frame Parameters
-@cindex default-frame-alist
+@vindex default-frame-alist
 
   You can control the default appearance and behavior of all frames by
 specifying a default list of @dfn{frame parameters} in the variable
@@ -918,7 +918,7 @@ default font to @samp{Monospace-10}:
   For a list of frame parameters and their effects, see @ref{Frame
 Parameters,,, elisp, The Emacs Lisp Reference Manual}.
 
-@cindex initial-frame-alist
+@vindex initial-frame-alist
   You can also specify a list of frame parameters which apply to just
 the initial frame, by customizing the variable
 @code{initial-frame-alist}.
@@ -992,11 +992,11 @@ end of the buffer is shown; if @code{nil}, the thumb will be at the
 bottom when the end of the buffer is shown.  You cannot over-scroll
 when the entire buffer is visible.
 
-@cindex scroll-bar face
+@cindex @code{scroll-bar} face
   The visual appearance of the scroll bars is controlled by the
-@code{scroll-bar} face.  (Some toolkits, such as GTK and MS-Windows,
+@code{scroll-bar} face.  (Some toolkits, such as GTK+ and MS-Windows,
 ignore this face; the scroll-bar appearance there can only be
-customized system-wide, for GTK @pxref{GTK resources}).
+customized system-wide, for GTK+ @pxref{GTK resources}).
 
 @cindex vertical border
   On graphical frames, vertical scroll bars implicitly serve to separate
diff --git a/doc/emacs/glossary.texi b/doc/emacs/glossary.texi
index 94f2c27cbc..2d2f14efda 100644
--- a/doc/emacs/glossary.texi
+++ b/doc/emacs/glossary.texi
@@ -29,7 +29,7 @@ Alt is the name of a modifier bit that a keyboard input character may
 have.  To make a character Alt, type it while holding down the @key{Alt}
 key.  Such characters are given names that start with @kbd{@key{Alt}-}
 (usually written @kbd{A-} for short).  (Note that many terminals have a
-key labeled @key{Alt} that is really a @key{META} key.)  @xref{User
+key labeled @key{Alt} that is really a @key{Meta} key.)  @xref{User
 Input, Alt}.
 
 @item Argument
@@ -103,13 +103,14 @@ supports both of these forms, as well as any mixture of them---this
 is ``bidirectional text''.  @xref{Bidirectional Editing}.
 
 @item Bind
+@anchor{Glossary---Bind}
 To bind a key sequence means to give it a binding (q.v.).
 @xref{Rebinding}.
 
 @anchor{Glossary---Binding}
 @item Binding
 A key sequence gets its meaning in Emacs by having a binding, which is a
-command (q.v.), a Lisp function that is run when you type that
+command (q.v.)---a Lisp function that is run when you type that
 sequence.  @xref{Commands,Binding}.  Customization often involves
 rebinding a character to a different command function.  The bindings of
 all key sequences are recorded in the keymaps (q.v.).  @xref{Keymaps}.
@@ -141,8 +142,8 @@ are visiting (q.v.@:) some file.  @xref{Buffers}.
 
 @item Buffer Selection History
 Emacs keeps a buffer selection history that records how recently each
-Emacs buffer has been selected.  This is used for choosing a buffer to
-select.  @xref{Buffers}.
+Emacs buffer has been selected.  This is used for choosing which
+buffer to select.  @xref{Buffers}.
 
 @item Bug
 A bug is an incorrect or unreasonable behavior of a program, or
@@ -173,7 +174,7 @@ misspelling.
 
 @item @kbd{C-M-}
 @kbd{C-M-} in the name of a character is an abbreviation for
-Control-Meta.  If your terminal lacks a real @key{META} key, you type
+Control-Meta.  If your terminal lacks a real @key{Meta} key, you type
 a Control-Meta character by typing @key{ESC} and then typing the
 corresponding Control character.  @xref{User Input,C-M-}.
 
@@ -220,9 +221,9 @@ the clipboard is used @emph{instead} of the primary selection.
 @xref{Clipboard}.
 
 @item Coding System
-A coding system is an encoding for representing text characters in a
-file or in a stream of information.  Emacs has the ability to convert
-text to or from a variety of coding systems when reading or writing it.
+A coding system is a way to encode text characters in a file or in a
+stream of information.  Emacs has the ability to convert text to or
+from a variety of coding systems when reading or writing it.
 @xref{Coding Systems}.
 
 @item Command
@@ -263,12 +264,12 @@ executes faster.
 
 @item Complete Key
 A complete key is a key sequence that fully specifies one action to be
-performed by Emacs.  For example, @kbd{X} and @kbd{C-f} and @kbd{C-x m}
-are complete keys.  Complete keys derive their meanings from being bound
-(q.v.@:) to commands (q.v.).  Thus, @kbd{X} is conventionally bound to
-a command to insert @samp{X} in the buffer; @kbd{C-x m} is
-conventionally bound to a command to begin composing a mail message.
-@xref{Keys}.
+performed by Emacs.  For example, @kbd{X} and @kbd{C-f} and @kbd{C-x
+m} are complete keys.  Complete keys derive their meanings from being
+bound (@pxref{Glossary---Bind}) to commands (q.v.).  Thus, @kbd{X} is
+conventionally bound to a command to insert @samp{X} in the buffer;
+@kbd{C-x m} is conventionally bound to a command to begin composing a
+mail message.  @xref{Keys}.
 
 @item Completion
 Completion is what Emacs does when it automatically expands an
@@ -281,11 +282,11 @@ file names.  Completion usually occurs when @key{TAB}, @key{SPC} or
 @anchor{Glossary---Continuation Line}
 @item Continuation Line
 When a line of text is longer than the width of the window, it
-normally (but see @ref{Glossary---Truncation}) takes up more than one
-screen line when displayed.  We say that the text line is continued, and all
-screen lines used for it after the first are called continuation
-lines.  @xref{Continuation Lines}.  A related Emacs feature is
-filling (q.v.).
+normally takes up more than one screen line when displayed (but see
+@ref{Glossary---Truncation}).  We say that the text line is continued,
+and all screen lines used for it after the first are called
+continuation lines.  @xref{Continuation Lines}.  A related Emacs
+feature is filling (q.v.).
 
 @item Control Character
 A control character is a character that you type by holding down the
@@ -418,7 +419,7 @@ Variables}.
 On GNU and other Unix-like systems, directory names are strings that
 end in @samp{/}.  For example, @file{/no-such-dir/} is a directory
 name whereas @file{/tmp} is not, even though @file{/tmp} names a file
-that happens to be a directory.  On MS-DOS the relationship is more
+that happens to be a directory.  On MS-Windows the relationship is more
 complicated.  @xref{Directory Names,,, elisp, the Emacs Lisp Reference
 Manual}.
 
@@ -506,7 +507,7 @@ Such messages appear in the echo area, accompanied by a beep.
 
 @item @key{ESC}
 @key{ESC} is a character used as a prefix for typing Meta characters on
-keyboards lacking a @key{META} key.  Unlike the @key{META} key (which,
+keyboards lacking a @key{Meta} key.  Unlike the @key{Meta} key (which,
 like the @key{SHIFT} key, is held down while another character is
 typed), you press the @key{ESC} key as you would press a letter key, and
 it applies to the next character you type.
@@ -719,10 +720,11 @@ customizing the various hooks, you can modify Emacs's behavior without
 changing any of its code.  @xref{Hooks}.
 
 @item Hyper
-Hyper is the name of a modifier bit that a keyboard input character may
-have.  To make a character Hyper, type it while holding down the
+Hyper is the name of a modifier bit that a keyboard input character
+may have.  To make a character Hyper, type it while holding down the
 @key{Hyper} key.  Such characters are given names that start with
-@kbd{Hyper-} (usually written @kbd{H-} for short).  @xref{User Input}.
+@kbd{Hyper-} (usually written @kbd{H-} for short).  @xref{Modifier
+Keys}.
 
 @item i.e.
 Short for ``id est'' in Latin, which means ``that is''.
@@ -879,7 +881,7 @@ A local value of a variable (q.v.@:) applies to only one buffer.
 @xref{Locals}.
 
 @item @kbd{M-}
-@kbd{M-} in the name of a character is an abbreviation for @key{META},
+@kbd{M-} in the name of a character is an abbreviation for @key{Meta},
 one of the modifier keys that can accompany any character.
 @xref{User Input,M-}.
 
@@ -937,15 +939,15 @@ a keyboard interface to navigate it.  @xref{Menu Bars}.
 
 @item Meta
 Meta is the name of a modifier bit which you can use in a command
-character.  To enter a meta character, you hold down the @key{META}
+character.  To enter a meta character, you hold down the @key{Meta}
 key while typing the character.  We refer to such characters with
 names that start with @kbd{Meta-} (usually written @kbd{M-} for
-short).  For example, @kbd{M-<} is typed by holding down @key{META}
+short).  For example, @kbd{M-<} is typed by holding down @key{Meta}
 and at the same time typing @kbd{<} (which itself is done, on most
 terminals, by holding down @key{SHIFT} and typing @kbd{,}).
 @xref{User Input,Meta}.
 
-On some terminals, the @key{META} key is actually labeled @key{Alt}
+On some terminals, the @key{Meta} key is actually labeled @key{Alt}
 or @key{Edit}.
 
 @item Meta Character
@@ -1089,8 +1091,9 @@ The primary selection is one particular X selection (q.v.); it is the
 selection that most X applications use for transferring text to and from
 other applications.
 
-The Emacs kill commands set the primary selection and the yank command
-uses the primary selection when appropriate.  @xref{Killing}.
+The Emacs commands that mark or select text set the primary selection,
+and clicking the mouse inserts text from the primary selection when
+appropriate.  @xref{Shift Selection}.
 
 @item Prompt
 A prompt is text used to ask you for input.  Displaying a prompt
@@ -1341,10 +1344,11 @@ which characters balance each other like parentheses, etc.
 Manual}.
 
 @item Super
-Super is the name of a modifier bit that a keyboard input character may
-have.  To make a character Super, type it while holding down the
+Super is the name of a modifier bit that a keyboard input character
+may have.  To make a character Super, type it while holding down the
 @key{SUPER} key.  Such characters are given names that start with
-@kbd{Super-} (usually written @kbd{s-} for short).  @xref{User Input}.
+@kbd{Super-} (usually written @kbd{s-} for short).  @xref{Modifier
+Keys}.
 
 @item Suspending
 Suspending Emacs means stopping it temporarily and returning control
@@ -1491,13 +1495,13 @@ Emacs divides a frame (q.v.@:) into one or more windows, each of which
 can display the contents of one buffer (q.v.@:) at any time.
 @xref{Screen}, for basic information on how Emacs uses the screen.
 @xref{Windows}, for commands to control the use of windows.  Some
-other editors use the term ``window'' for what we call a ``frame''
-(q.v.@:) in Emacs.
+other editors use the term ``window'' for what we call a ``frame'' in
+Emacs.
 
 @item Window System
 A window system is software that operates on a graphical display
-(q.v.), to subdivide the screen so that multiple applications can
-have their] own windows at the same time.  All modern operating systems
+(q.v.), to subdivide the screen so that multiple applications can have
+their own windows at the same time.  All modern operating systems
 include a window system.
 
 @item Word Abbrev
diff --git a/doc/emacs/help.texi b/doc/emacs/help.texi
index e005fe358d..a5700760d4 100644
--- a/doc/emacs/help.texi
+++ b/doc/emacs/help.texi
@@ -4,7 +4,6 @@
 @c See file emacs.texi for copying conditions.
 @node Help
 @chapter Help
-@kindex Help
 @cindex help
 @cindex self-documentation
 @findex help-command
diff --git a/doc/emacs/killing.texi b/doc/emacs/killing.texi
index 19aa9077d7..4c47c8b047 100644
--- a/doc/emacs/killing.texi
+++ b/doc/emacs/killing.texi
@@ -590,7 +590,7 @@ you can access it using the following Emacs commands:
 @table @kbd
 @findex mouse-set-secondary
 @kindex M-Drag-mouse-1
-@cindex secondary-selection face
+@cindex @code{secondary-selection} face
 @item M-Drag-mouse-1
 Set the secondary selection, with one end at the place where you press
 down the button, and the other end at the place where you release it
@@ -857,7 +857,8 @@ region is active.
 
 Unlike the standard region, the region-rectangle can have its corners
 extended past the end of buffer, or inside stretches of white space
-that point normally cannot enter, like the TAB.
+that point normally cannot enter, like in the middle of a TAB
+character.
 
 @findex rectangle-exchange-point-and-mark
 @findex exchange-point-and-mark@r{, in rectangle-mark-mode}
diff --git a/doc/emacs/macos.texi b/doc/emacs/macos.texi
index bf37d67b64..4982c78f2e 100644
--- a/doc/emacs/macos.texi
+++ b/doc/emacs/macos.texi
@@ -35,7 +35,7 @@ Support}), but we hope to improve it in the future.
 @section Basic Emacs usage under macOS and GNUstep
 
   By default, the @key{Alt} and @key{Option} keys are the same as
-@key{META}.  The Mac @key{Cmd} key is the same as @key{Super}, and
+@key{Meta}.  The Mac @key{Cmd} key is the same as @key{Super}, and
 Emacs provides a set of key bindings using this modifier key that mimic
 other Mac / GNUstep applications (@pxref{Mac / GNUstep Events}).  You
 can change these bindings in the usual way (@pxref{Key Bindings}).
diff --git a/doc/emacs/maintaining.texi b/doc/emacs/maintaining.texi
index 29ded9e3a3..824f1b0f7f 100644
--- a/doc/emacs/maintaining.texi
+++ b/doc/emacs/maintaining.texi
@@ -628,7 +628,7 @@ they use the concept of checking out individual files.
 @node Log Buffer
 @subsection Features of the Log Entry Buffer
 
-@cindex C-c C-c @r{(Log Edit mode)}
+@kindex C-c C-c @r{(Log Edit mode)}
 @findex log-edit-done
   When you tell VC to commit a change, it pops up a buffer named
 @file{*vc-log*}.  In this buffer, you should write a @dfn{log entry}
@@ -1078,7 +1078,7 @@ Revert the work file(s) in the current VC fileset to the last revision
 @findex vc-revert
 @vindex vc-revert-show-diff
   If you want to discard all the changes you have made to the current
-VC fileset, type @kbd{C-x v u} (@code{vc-revert-buffer}).  This shows
+VC fileset, type @kbd{C-x v u} (@code{vc-revert}).  This shows
 you a diff between the work file(s) and the revision from which you
 started editing, and asks for confirmation for discarding the changes.
 If you agree, the fileset is reverted.  If you don't want @kbd{C-x v
@@ -1812,6 +1812,8 @@ Find definition of identifier, and display it in a new frame
 @item M-,
 Go back to where you previously invoked @kbd{M-.} and friends
 (@code{xref-pop-marker-stack}).
+@item M-x xref-etags-mode
+Switch @code{xref} to use the @code{etags} backend.
 @end table
 
 @kindex M-.
@@ -1871,6 +1873,20 @@ where you were with @kbd{M-,}.  @kbd{M-,} allows you to retrace your
 steps to a depth determined by the variable
 @code{xref-marker-ring-length}, which defaults to 16.
 
+@findex xref-etags-mode
+  Some major modes install @code{xref} support facilities that might
+sometimes fail to find certain identifiers.  For example, in Emacs
+Lisp mode (@pxref{Lisp Eval}) @kbd{M-.} will by default find only
+functions and variables from Lisp packages which are loaded into the
+current Emacs session or are auto-loaded (@pxref{Autoload,,, elisp,
+The Emacs Lisp Reference Manual}).  If @kbd{M-.} fails to find some
+identifiers, you can try forcing @code{xref} to use the @code{etags}
+backend (@pxref{Xref}).  To this end, turn on the Xref Etags minor
+mode with @w{@kbd{M-x xref-etags-mode}}, then invoke @kbd{M-.} again.
+(For this to work, be sure to run @command{etags} to create the tags
+table in the directory tree of the source files, see @ref{Create Tags
+Table}.)
+
 @node Xref Commands
 @subsubsection Commands Available in the @file{*xref*} Buffer
 @cindex commands in @file{*xref*} buffers
diff --git a/doc/emacs/mini.texi b/doc/emacs/mini.texi
index 8278de7f31..0dd7cde6cf 100644
--- a/doc/emacs/mini.texi
+++ b/doc/emacs/mini.texi
@@ -337,12 +337,6 @@ window.  You can display the same list with @kbd{?}
 used with the completion list:
 
 @table @kbd
-@findex mouse-choose-completion
-@item mouse-1
-@itemx mouse-2
-Clicking mouse button 1 or 2 on a completion alternative chooses it
-(@code{mouse-choose-completion}).
-
 @findex switch-to-completions
 @item M-v
 @itemx @key{PageUp}
@@ -355,18 +349,32 @@ the same.  You can also select the window in other ways
 
 @findex choose-completion
 @item @key{RET}
+@itemx mouse-1
+@itemx mouse-2
 While in the completion list buffer, this chooses the completion at
 point (@code{choose-completion}).
 
 @findex next-completion
+@item @key{TAB}
 @item @key{RIGHT}
-While in the completion list buffer, this moves point to the following
-completion alternative (@code{next-completion}).
+While in the completion list buffer, these keys move point to the
+following completion alternative (@code{next-completion}).
 
 @findex previous-completion
+@item @key{S-TAB}
 @item @key{LEFT}
-While in the completion list buffer, this moves point to the previous
-completion alternative (@code{previous-completion}).
+While in the completion list buffer, these keys move point to the
+previous completion alternative (@code{previous-completion}).
+
+@findex quit-window
+@item @kbd{q}
+While in the completion list buffer, this quits the window showing it
+and selects the window showing the minibuffer (@code{quit-window}).
+
+@findex kill-current-buffer
+@item @kbd{z}
+While in the completion list buffer, kill it and delete the window
+showing it (@code{kill-current-buffer}).
 @end table
 
 @node Completion Exit
diff --git a/doc/emacs/misc.texi b/doc/emacs/misc.texi
index d8f202f684..68bd308983 100644
--- a/doc/emacs/misc.texi
+++ b/doc/emacs/misc.texi
@@ -409,7 +409,7 @@ is needed.  For OpenDocument and Microsoft Office documents, the
 @code{unoconv} tool is needed.}, and displaying those images.
 
 @findex doc-view-toggle-display
-@cindex doc-view-minor-mode
+@findex doc-view-minor-mode
   When you visit a document file that can be displayed with DocView
 mode, Emacs automatically uses DocView mode @footnote{The needed
 external tools for the document type must be available, and Emacs must
@@ -2463,12 +2463,6 @@ sessions, or add this line in your init file (@pxref{Init File}):
 (desktop-save-mode 1)
 @end example
 
-@vindex desktop-auto-save-timeout
-@noindent
-When @code{desktop-save-mode} is active and the desktop file exists,
-Emacs auto-saves it every @code{desktop-auto-save-timeout}
-seconds, if that is non-@code{nil} and non-zero.
-
 @findex desktop-change-dir
 @findex desktop-revert
 @vindex desktop-path
@@ -2535,7 +2529,7 @@ e.g., the daemon cannot use GUI features, so parameters such as frame
 position, size, and decorations cannot be restored.  For that reason,
 you may wish to delay restoring the desktop in daemon mode until the
 first client connects, by calling @code{desktop-read} in a hook
-function that you add to @code{after-make-frame-functions}
+function that you add to @code{server-after-make-frame-hook}
 (@pxref{Creating Frames,,, elisp, The Emacs Lisp Reference Manual}).
 
 @node Recursive Edit
diff --git a/doc/emacs/msdos.texi b/doc/emacs/msdos.texi
index e49280e88d..dc282e18d5 100644
--- a/doc/emacs/msdos.texi
+++ b/doc/emacs/msdos.texi
@@ -116,7 +116,7 @@ invoked---that will always give you an editor.  When invoked via
 the program that invoked @command{emacsclient}.
 @end enumerate
 
-@cindex emacsclient, on MS-Windows
+@cindex @command{emacsclient}, on MS-Windows
 Note that, due to limitations of MS-Windows, Emacs cannot have both
 GUI and text-mode frames in the same session.  It also cannot open
 text-mode frames on more than a single @dfn{Command Prompt} window,
@@ -533,7 +533,7 @@ Windows-specific variables in this category.
 @ifnottex
 @vindex w32-alt-is-meta
 @cindex @code{Alt} key (MS-Windows)
-  By default, the key labeled @key{Alt} is mapped as the @key{META}
+  By default, the key labeled @key{Alt} is mapped as the @key{Meta}
 key.  If you wish it to produce the @code{Alt} modifier instead, set
 the variable @code{w32-alt-is-meta} to a @code{nil} value.
 
@@ -591,8 +591,8 @@ Windows key and @key{R} opens the Windows @code{Run} dialog.
 
   The hotkey registrations always also include all the shift and
 control modifier combinations for the given hotkey; that is,
-registering @kbd{s-@key{a}} as a hotkey gives you @kbd{S-s-@key{a}},
-@kbd{C-s-@key{a}} and @kbd{C-S-s-@key{a}} as well.
+registering @kbd{s-a} as a hotkey gives you @kbd{S-s-a},
+@kbd{C-s-a} and @kbd{C-S-s-a} as well.
 
   On Windows 98 and ME, the hotkey registration is more restricted.
 The desired hotkey must always be fully specified, and
@@ -656,8 +656,8 @@ value other than the above modifier symbols.
 @cindex @code{Alt} key invokes menu (Windows)
   Emacs compiled as a native Windows application normally turns off
 the Windows feature that tapping the @key{Alt} key invokes the Windows
-menu.  The reason is that the @key{Alt} serves as @key{META} in Emacs.
-When using Emacs, users often press the @key{META} key temporarily and
+menu.  The reason is that the @key{Alt} serves as @key{Meta} in Emacs.
+When using Emacs, users often press the @key{Meta} key temporarily and
 then change their minds; if this has the effect of bringing up the
 Windows menu, it alters the meaning of subsequent commands.  Many
 users find this frustrating.
@@ -680,14 +680,14 @@ its normal effect: for example, @kbd{@key{Lwindow}} opens the
 
 @vindex w32-recognize-altgr
 @kindex AltGr @r{(MS-Windows)}
-@cindex AltGr key (MS-Windows)
+@cindex @key{AltGr} key (MS-Windows)
   The variable @code{w32-recognize-altgr} controls whether the
 @key{AltGr} key (if it exists on your keyboard), or its equivalent,
 the combination of the right @key{Alt} and left @key{Ctrl} keys
 pressed together, is recognized as the @key{AltGr} key.  The default
 is @code{t}, which means these keys produce @code{AltGr}; setting it
 to @code{nil} causes @key{AltGr} or the equivalent key combination to
-be interpreted as the combination of @key{Ctrl} and @key{META}
+be interpreted as the combination of @key{Ctrl} and @key{Meta}
 modifiers.
 @end ifnottex
 
diff --git a/doc/emacs/mule.texi b/doc/emacs/mule.texi
index 01184e2ae1..d05ec1afee 100644
--- a/doc/emacs/mule.texi
+++ b/doc/emacs/mule.texi
@@ -51,7 +51,7 @@ others.
 @item
 You can insert non-@acronym{ASCII} characters or search for them.  To do that,
 you can specify an input method (@pxref{Select Input Method}) suitable
-for your language, or use the default input method set up when you chose
+for your language, or use the default input method set up when you choose
 your language environment.  If
 your keyboard can produce non-@acronym{ASCII} characters, you can select an
 appropriate keyboard coding system (@pxref{Terminal Coding}), and Emacs
@@ -698,7 +698,7 @@ carriage-return (Mac).
 Describe coding system @var{coding} (@code{describe-coding-system}).
 
 @item C-h C @key{RET}
-Describe the coding systems currently in use.
+Describe the coding systems currently in use (@code{describe-coding-system}).
 
 @item M-x list-coding-systems
 Display a list of all the supported coding systems.
@@ -935,7 +935,7 @@ or a local variables list at the end (@pxref{File Variables}).  You do
 this by defining a value for the ``variable'' named @code{coding}.
 Emacs does not really have a variable @code{coding}; instead of
 setting a variable, this uses the specified coding system for the
-file.  For example, @samp{-*-mode: C; coding: latin-1;-*-} specifies
+file.  For example, @w{@samp{-*-mode: C; coding: latin-1; -*-}} specifies
 use of the Latin-1 coding system, as well as C mode.  When you specify
 the coding explicitly in the file, that overrides
 @code{file-coding-system-alist}.
@@ -1206,13 +1206,13 @@ using the internal Emacs representation.
 @cindex file-name encoding, MS-Windows
 @vindex w32-unicode-filenames
   When Emacs runs on MS-Windows versions that are descendants of the
-NT family (Windows 2000, XP, Vista, Windows 7, and all the later
-versions), the value of @code{file-name-coding-system} is largely
-ignored, as Emacs by default uses APIs that allow passing Unicode file
-names directly.  By contrast, on Windows 9X, file names are encoded
-using @code{file-name-coding-system}, which should be set to the
-codepage (@pxref{Coding Systems, codepage}) pertinent for the current
-system locale.  The value of the variable @code{w32-unicode-filenames}
+NT family (Windows 2000, XP, and all the later versions), the value of
+@code{file-name-coding-system} is largely ignored, as Emacs by default
+uses APIs that allow passing Unicode file names directly.  By
+contrast, on Windows 9X, file names are encoded using
+@code{file-name-coding-system}, which should be set to the codepage
+(@pxref{Coding Systems, codepage}) pertinent for the current system
+locale.  The value of the variable @code{w32-unicode-filenames}
 controls whether Emacs uses the Unicode APIs when it calls OS
 functions that accept file names.  This variable is set by the startup
 code to @code{nil} on Windows 9X, and to @code{t} on newer versions of
@@ -1778,8 +1778,9 @@ of the first character you read precedes that of the next character.
 Reordering of bidirectional text into the @dfn{visual} order happens
 at display time.  As a result, character positions no longer increase
 monotonically with their positions on display.  Emacs implements the
-Unicode Bidirectional Algorithm (UBA) described in the Unicode
-Standard Annex #9, for reordering of bidirectional text for display.
+Unicode Bidirectional Algorithm (UBA) described in the
+@uref{http://unicode.org/reports/tr9/, Unicode Standard Annex #9}, for
+reordering of bidirectional text for display.
 It deviates from the UBA only in how continuation lines are displayed
 when text direction is opposite to the base paragraph direction,
 e.g., when a long line of English text appears in a right-to-left
diff --git a/doc/emacs/programs.texi b/doc/emacs/programs.texi
index 6af661ec02..13f4656fe8 100644
--- a/doc/emacs/programs.texi
+++ b/doc/emacs/programs.texi
@@ -86,13 +86,14 @@ mode for the C programming language is @code{c-mode}.
 @cindex Awk mode
   Emacs has programming language modes for Lisp, Scheme, the
 Scheme-based DSSSL expression language, Ada, ASM, AWK, C, C++,
-Fortran, Icon, IDL (CORBA), IDLWAVE, Java, Javascript, Metafont
-(@TeX{}'s companion for font creation), Modula2, Object Pascal, Objective-C,
-Octave, Pascal, Perl, Pike, PostScript, Prolog, Python, Ruby, Simula, Tcl,
-and VHDL@.  An alternative mode for Perl is called CPerl mode.  Modes are
-also available for the scripting languages of the common GNU and Unix
-shells, and MS-Windows @samp{BAT} files, and for makefiles,
-DNS master files, and various sorts of configuration files.
+Fortran, Icon, IDL (CORBA), IDLWAVE, Java, Javascript, M4, Makefiles,
+Metafont (@TeX{}'s companion for font creation), Modula2, Object
+Pascal, Objective-C, Octave, Pascal, Perl, Pike, PostScript, Prolog,
+Python, Ruby, Simula, SQL, Tcl, Verilog, and VHDL@.  An alternative
+mode for Perl is called CPerl mode.  Modes are also available for the
+scripting languages of the common GNU and Unix shells, and
+MS-Windows @samp{BAT} files, and for makefiles, DNS master
+files, and various sorts of configuration files.
 
   Ideally, Emacs should have a major mode for each programming
 language that you might want to edit.  If it doesn't have a mode for
@@ -815,11 +816,13 @@ options which control the operation of this mode include:
 
 @itemize @bullet
 @item
-@code{show-paren-highlight-open-paren} controls whether to highlight
+@vindex show-paren-highlight-openparen
+@code{show-paren-highlight-openparen} controls whether to highlight
 an open paren when point stands just before it, and hence its position
 is marked by the cursor anyway.  The default is non-@code{nil} (yes).
 
 @item
+@vindex show-paren-style
 @code{show-paren-style} controls whether just the two parens, or also
 the space between them get highlighted.  The valid options here are
 @code{parenthesis} (show the matching paren), @code{expression}
@@ -828,10 +831,12 @@ the space between them get highlighted.  The valid options here are
 expression otherwise).
 
 @item
+@vindex show-paren-when-point-inside-paren
 @code{show-paren-when-point-inside-paren}, when non-@code{nil}, causes
 highlighting also when point is on the inside of a parenthesis.
 
 @item
+@vindex show-paren-when-point-in-periphery
 @code{show-paren-when-point-in-periphery}, when non-@code{nil}, causes
 highlighting also when point is in whitespace at the beginning or end
 of a line, and there is a paren at, respectively, the first or last,
@@ -1008,7 +1013,7 @@ effect as @kbd{C-u M-;} by typing @kbd{M-x comment-kill}
 (@code{comment-dwim} actually calls @code{comment-kill} as a
 subroutine when it is given a prefix argument).
 
-@kindex C-c C-c (C mode)
+@kindex C-c C-c @r{(C mode)}
 @findex comment-region
 @findex uncomment-region
   The command @kbd{M-x comment-region} is equivalent to calling
@@ -1625,7 +1630,7 @@ behind.  A prefix argument acts as a repeat count.  With a negative
 argument, move backward.
 
 @item M-a
-@kindex M-a (C mode)
+@kindex M-a @r{(C mode)}
 @findex c-beginning-of-statement
 Move point to the beginning of the innermost C statement
 (@code{c-beginning-of-statement}).  If point is already at the beginning
@@ -1636,7 +1641,7 @@ In comments or in strings which span more than one line, this command
 moves by sentences instead of statements.
 
 @item M-e
-@kindex M-e (C mode)
+@kindex M-e @r{(C mode)}
 @findex c-end-of-statement
 Move point to the end of the innermost C statement or sentence; like
 @kbd{M-a} except that it moves in the other direction
@@ -1701,17 +1706,17 @@ preprocessor commands.
 @item C-c C-@key{DEL}
 @itemx C-c @key{DEL}
 @findex c-hungry-delete-backwards
-@kindex C-c C-DEL (C Mode)
-@kindex C-c DEL (C Mode)
+@kindex C-c C-DEL @r{(C Mode)}
+@kindex C-c DEL @r{(C Mode)}
 Delete the entire block of whitespace preceding point (@code{c-hungry-delete-backwards}).
 
 @item C-c C-d
 @itemx C-c C-@key{Delete}
 @itemx C-c @key{Delete}
 @findex c-hungry-delete-forward
-@kindex C-c C-d (C Mode)
-@kindex C-c C-Delete (C Mode)
-@kindex C-c Delete (C Mode)
+@kindex C-c C-d @r{(C Mode)}
+@kindex C-c C-Delete @r{(C Mode)}
+@kindex C-c Delete @r{(C Mode)}
 Delete the entire block of whitespace after point (@code{c-hungry-delete-forward}).
 @end table
 
diff --git a/doc/emacs/rmail.texi b/doc/emacs/rmail.texi
index e9371f39a9..cb62ce3652 100644
--- a/doc/emacs/rmail.texi
+++ b/doc/emacs/rmail.texi
@@ -802,7 +802,7 @@ its contents.
 @vindex rmail-enable-mime-composing
 @findex unforward-rmail-message
   Rmail offers two formats for forwarded messages.  The default is to
-use MIME (@pxref{Rmail Display}) format.  This includes the original
+use the MIME format (@pxref{Rmail Display}).  This includes the original
 message as a separate part.  You can use a simpler format if you
 prefer, by setting the variable @code{rmail-enable-mime-composing} to
 @code{nil}.  In this case, Rmail just includes the original message
@@ -1092,7 +1092,7 @@ Sort messages of current Rmail buffer by author's name.
 @findex rmail-sort-by-recipient
 @item C-c C-s C-r
 @itemx M-x rmail-sort-by-recipient
-Sort messages of current Rmail buffer by recipient's names.
+Sort messages of current Rmail buffer by recipient's name.
 
 @findex rmail-sort-by-correspondent
 @item C-c C-s C-c
diff --git a/doc/emacs/search.texi b/doc/emacs/search.texi
index 9d7ff59bee..8ac9794c37 100644
--- a/doc/emacs/search.texi
+++ b/doc/emacs/search.texi
@@ -92,7 +92,7 @@ the first @samp{F} previously found.  After another @kbd{O}, the
 cursor moves to just after the first @samp{FOO}.
 
 @cindex faces for highlighting search matches
-@cindex isearch face
+@cindex @code{isearch} face
   At each step, Emacs highlights the @dfn{current match}---the buffer
 text that matches the search string---using the @code{isearch} face
 (@pxref{Faces}).  @xref{Search Customizations}, for various options
@@ -280,7 +280,7 @@ down-casing.
 @node Error in Isearch
 @subsection Errors in Incremental Search
 
-@cindex isearch-fail face
+@cindex @code{isearch-fail} face
   If your string is not found at all, the echo area says @samp{Failing
 I-Search}, and the cursor moves past the place where Emacs found as
 much of your string as it could.  Thus, if you search for @samp{FOOT},
@@ -437,7 +437,7 @@ of the keymap @code{isearch-mode-map} (@pxref{Keymaps}).
 
 This subsection describes how to control whether typing a command not
 specifically meaningful in searches exits the search before executing
-the command.  It also describes two categories of commands which you
+the command.  It also describes three categories of commands which you
 can type without exiting the current incremental search, even though
 they are not themselves part of incremental search.
 
@@ -446,7 +446,7 @@ they are not themselves part of incremental search.
 search exits the search before executing the command.  Thus, the
 command operates on the buffer from which you invoked the search.
 However, if you customize the variable @code{search-exit-option} to
-@code{nil}, the characters which you type that are not interpreted by
+@code{append}, the characters which you type that are not interpreted by
 the incremental search are simply appended to the search string.  This
 is so you could include in the search string control characters, such
 as @kbd{C-a}, that would normally exit the search and invoke the
@@ -507,6 +507,18 @@ change point, the buffer contents, the match data, the current buffer,
 or the selected window and frame.  The command must not itself attempt
 an incremental search.  This feature is disabled if
 @code{isearch-allow-scroll} is @code{nil} (which it is by default).
+
+@item Motion Commands
+@cindex motion commands, during incremental search
+When @code{search-exit-option} is customized to @code{shift-move},
+you can extend the search string by holding down the shift key while
+typing cursor motion commands.  It will yank text that ends at the new
+position after moving point in the current buffer.
+
+When @code{search-exit-option} is @code{move}, you can extend the
+search string without using the shift key for cursor motion commands,
+but it applies only for certain motion command that have the
+@code{isearch-move} property on their symbols.
 @end table
 
 @node Isearch Minibuffer
@@ -1552,8 +1564,8 @@ replacements are not added to the command history, and cannot be
 reused.
 
 @cindex faces for highlighting query replace
-@cindex query-replace face
-@cindex lazy-highlight face, in replace
+@cindex @code{query-replace} face
+@cindex @code{lazy-highlight} face, in replace
 @vindex query-replace-highlight
 @vindex query-replace-lazy-highlight
 @vindex query-replace-show-replacement
@@ -1869,7 +1881,7 @@ setting the variable @code{search-highlight} to @code{nil}.
 
 @cindex lazy highlighting customizations
 @vindex isearch-lazy-highlight
-@cindex lazy-highlight face
+@cindex @code{lazy-highlight} face
   The other matches for the search string that are visible on display
 are highlighted using the @code{lazy-highlight} face.  Setting the
 variable @code{isearch-lazy-highlight} to @code{nil} disables this
diff --git a/doc/emacs/text.texi b/doc/emacs/text.texi
index d32bb3c768..6a5fc7c6f6 100644
--- a/doc/emacs/text.texi
+++ b/doc/emacs/text.texi
@@ -117,7 +117,7 @@ cognate to @kbd{C-@@}, which is an alias for @kbd{C-@key{SPC}}.
 @findex backward-word
   The commands @kbd{M-f} (@code{forward-word}) and @kbd{M-b}
 (@code{backward-word}) move forward and backward over words.  These
-@key{META}-based key sequences are analogous to the key sequences
+@key{Meta}-based key sequences are analogous to the key sequences
 @kbd{C-f} and @kbd{C-b}, which move over single characters.  The
 analogy extends to numeric arguments, which serve as repeat counts.
 @kbd{M-f} with a negative argument moves backward, and @kbd{M-b} with
@@ -1331,7 +1331,7 @@ quad click: exit all folds and hide text.
 @c FIXME not marked as a user variable
 @vindex foldout-mouse-modifiers
   You can specify different modifier keys (instead of
-@kbd{@key{Ctrl}-@key{META}-}) by setting @code{foldout-mouse-modifiers}; but if
+@kbd{@key{Ctrl}-@key{Meta}-}) by setting @code{foldout-mouse-modifiers}; but if
 you have already loaded the @file{foldout.el} library, you must reload
 it in order for this to take effect.
 
@@ -1380,19 +1380,19 @@ buffer cycles the visibility of the entire outline structure, between
 (i) showing only top-level heading lines, (ii) showing all heading
 lines but no body lines, and (iii) showing everything.
 
-@kindex M-<up> @r{(Org Mode)}
-@kindex M-<down> @r{(Org Mode)}
-@kindex M-<left> @r{(Org Mode)}
-@kindex M-<right> @r{(Org Mode)}
+@kindex M-UP @r{(Org Mode)}
+@kindex M-DOWN @r{(Org Mode)}
+@kindex M-LEFT @r{(Org Mode)}
+@kindex M-RIGHT @r{(Org Mode)}
 @findex org-metaup
 @findex org-metadown
 @findex org-metaleft
 @findex org-metaright
   You can move an entire entry up or down in the buffer, including its
-body lines and subtree (if any), by typing @kbd{M-<up>}
-(@code{org-metaup}) or @kbd{M-<down>} (@code{org-metadown}) on the
+body lines and subtree (if any), by typing @kbd{M-@key{UP}}
+(@code{org-metaup}) or @kbd{M-@key{DOWN}} (@code{org-metadown}) on the
 heading line.  Similarly, you can promote or demote a heading line
-with @kbd{M-<left>} (@code{org-metaleft}) and @kbd{M-<right>}
+with @kbd{M-@key{LEFT}} (@code{org-metaleft}) and @kbd{M-@key{RIGHT}}
 (@code{org-metaright}).  These commands execute their global bindings
 if invoked on a body line.
 
@@ -1461,8 +1461,9 @@ etc.
 export and publication.  To export the current buffer, type @kbd{C-c
 C-e} (@code{org-export}) anywhere in an Org buffer.  This command
 prompts for an export format; currently supported formats include
-HTML, @LaTeX{}, OpenDocument (@file{.odt}), and PDF@.  Some formats,
-such as PDF, require certain system tools to be installed.
+HTML, @LaTeX{}, Texinfo, OpenDocument (@file{.odt}), iCalendar,
+Markdown, man-page, and PDF@.  Some formats, such as PDF, require
+certain system tools to be installed.
 
 @vindex org-publish-project-alist
   To export several files at once to a specific directory, either
@@ -1521,14 +1522,14 @@ with @LaTeX{}.}.
   Emacs provides a @TeX{} major mode for each of these variants: Plain
 @TeX{} mode, @LaTeX{} mode, Doc@TeX{} mode, and Sli@TeX{} mode.  Emacs
 selects the appropriate mode by looking at the contents of the buffer.
-(This is done by the @code{tex-mode} command, which is normally called
-automatically when you visit a @TeX{}-like file.  @xref{Choosing
-Modes}.)  If the contents are insufficient to determine this, Emacs
-chooses the mode specified by the variable @code{tex-default-mode};
-its default value is @code{latex-mode}.  If Emacs does not guess
-right, you can select the correct variant of @TeX{} mode using the
-command @kbd{M-x plain-tex-mode}, @kbd{M-x latex-mode}, @kbd{M-x
-slitex-mode}, or @kbd{doctex-mode}.
+(This is done by invoking the @code{tex-mode} command, which is
+normally called automatically when you visit a @TeX{}-like file.
+@xref{Choosing Modes}.)  If the contents are insufficient to determine
+this, Emacs chooses the mode specified by the variable
+@code{tex-default-mode}; its default value is @code{latex-mode}.  If
+Emacs does not guess right, you can select the correct variant of
+@TeX{} mode using the commands @code{plain-tex-mode},
+@code{latex-mode}, @code{slitex-mode}, or @code{doctex-mode}.
 
   The following sections document the features of @TeX{} mode and its
 variants.  There are several other @TeX{}-related Emacs packages,
@@ -1701,14 +1702,16 @@ chapter of a larger document).
 @table @kbd
 @item C-c C-b
 Invoke @TeX{} on the entire current buffer (@code{tex-buffer}).
+
 @item C-c C-r
 Invoke @TeX{} on the current region, together with the buffer's header
 (@code{tex-region}).
+
 @item C-c C-f
 Invoke @TeX{} on the current file (@code{tex-file}).
 
 @item C-c C-v
-Preview the output from the last @kbd{C-c C-r}, @kbd{C-c C-b}, or @kbd{C-c
+Preview the output from the last @kbd{C-c C-b}, @kbd{C-c C-r}, or @kbd{C-c
 C-f} command (@code{tex-view}).
 
 @item C-c C-p
@@ -1743,7 +1746,7 @@ C-p} (@code{tex-print}) to print a hardcopy of the output file.
 @cindex @env{TEXINPUTS} environment variable
 @vindex tex-directory
   By default, @kbd{C-c C-b} runs @TeX{} in the current directory.  The
-output of @TeX{} also goes in this directory.  To run @TeX{} in a
+output of @TeX{} is also created in this directory.  To run @TeX{} in a
 different directory, change the variable @code{tex-directory} to
 the desired directory.  If your environment variable @env{TEXINPUTS}
 contains relative names, or if your files contain
@@ -1889,14 +1892,16 @@ keys (@pxref{Completion}).
 
 @vindex tex-shell-hook
 @vindex tex-mode-hook
+@vindex doctex-mode-hook
 @vindex latex-mode-hook
 @vindex slitex-mode-hook
 @vindex plain-tex-mode-hook
   Entering any variant of @TeX{} mode runs the hooks
 @code{text-mode-hook} and @code{tex-mode-hook}.  Then it runs either
-@code{plain-tex-mode-hook}, @code{latex-mode-hook}, or
-@code{slitex-mode-hook}, whichever is appropriate.  Starting the
-@TeX{} shell runs the hook @code{tex-shell-hook}.  @xref{Hooks}.
+@code{plain-tex-mode-hook}, @code{doctex-mode-hook},
+@code{latex-mode-hook}, or @code{slitex-mode-hook}, whichever is
+appropriate.  Starting the @TeX{} shell runs the hook
+@code{tex-shell-hook}.  @xref{Hooks}.
 
 @findex iso-iso2tex
 @findex iso-tex2iso
@@ -2002,7 +2007,8 @@ characters themselves (@code{sgml-name-8bit-mode}).
 @kindex C-c C-v @r{(SGML mode)}
 @findex sgml-validate
 Run a shell command (which you must specify) to validate the current
-buffer as SGML (@code{sgml-validate}).
+buffer as SGML (@code{sgml-validate}).  (In HTML mode this key
+sequence runs a different command.)
 
 @item C-c @key{TAB}
 @kindex C-c TAB @r{(SGML mode)}
@@ -2061,27 +2067,27 @@ hook @code{text-mode-hook}, then @code{nroff-mode-hook}
 separators, pages are separated by @samp{.bp} commands, and comments
 start with backslash-doublequote.  It also defines these commands:
 
-@findex forward-text-line
-@findex backward-text-line
-@findex count-text-lines
+@findex nroff-forward-text-line
+@findex nroff-backward-text-line
+@findex nroff-count-text-lines
 @kindex M-n @r{(Nroff mode)}
 @kindex M-p @r{(Nroff mode)}
 @kindex M-? @r{(Nroff mode)}
 @table @kbd
 @item M-n
 Move to the beginning of the next line that isn't an nroff command
-(@code{forward-text-line}).  An argument is a repeat count.
+(@code{nroff-forward-text-line}).  An argument is a repeat count.
 @item M-p
-Like @kbd{M-n} but move up (@code{backward-text-line}).
+Like @kbd{M-n} but move up (@code{nroff-backward-text-line}).
 @item M-?
 Displays in the echo area the number of text lines (lines that are not
-nroff commands) in the region (@code{count-text-lines}).
+nroff commands) in the region (@code{nroff-count-text-lines}).
 @end table
 
-@findex electric-nroff-mode
+@findex nroff-electric-mode
   Electric Nroff mode is a buffer-local minor mode that can be used
 with Nroff mode.  To toggle this minor mode, type @kbd{M-x
-electric-nroff-mode} (@pxref{Minor Modes}).  When the mode is on, each
+nroff-electric-mode} (@pxref{Minor Modes}).  When the mode is on, each
 time you type @key{RET} to end a line containing an nroff command that
 opens a kind of grouping, the nroff command to close that grouping is
 automatically inserted on the following line.
@@ -2175,7 +2181,7 @@ text properties.
 @cindex soft newline
 @cindex newlines, hard and soft
 
-@cindex use-hard-newlines
+@findex use-hard-newlines
   In Enriched mode, Emacs distinguishes between two different kinds of
 newlines, @dfn{hard} newlines and @dfn{soft} newlines.  You can also
 enable or disable this feature in other buffers, by typing @kbd{M-x
@@ -2759,8 +2765,7 @@ Invoking @kbd{M-x table-capture} on that text produces this table:
 to plain text, removing its cell borders.
 
   One application of this pair of commands is to edit a text in
-layout.  Look at the following three paragraphs (the latter two are
-indented with header lines):
+layout.  Look at the following three paragraphs:
 
 @example
 table-capture is a powerful command.
@@ -2913,7 +2918,7 @@ right-hand buffer.)
 @kindex F2 RET
 @kindex C-x 6 RET
 @findex 2C-newline
-  The command @kbd{C-x 6 @key{RET}} or @kbd{@key{F2} @key{RET}}
+  The command @kbd{@key{F2} @key{RET}} or @kbd{C-x 6 @key{RET}}
 (@code{2C-newline}) inserts a newline in each of the two buffers at
 corresponding positions.  This is the easiest way to add a new line to
 the two-column text while editing it in split buffers.
diff --git a/doc/emacs/trouble.texi b/doc/emacs/trouble.texi
index efe26cf7bf..ea02bb8da8 100644
--- a/doc/emacs/trouble.texi
+++ b/doc/emacs/trouble.texi
@@ -1394,8 +1394,8 @@ patches) over all your contributions.
 @node Service
 @section How To Get Help with GNU Emacs
 @cindex help in using Emacs
-@cindex help-gnu-emacs mailing list
-@cindex gnu.emacs.help newsgroup
+@cindex @samp{help-gnu-emacs} mailing list
+@cindex @samp{gnu.emacs.help} newsgroup
 
 If you need help installing, using or changing GNU Emacs, there are
 two ways to find it:
diff --git a/doc/emacs/xresources.texi b/doc/emacs/xresources.texi
index 096e747a04..db2c6ffafd 100644
--- a/doc/emacs/xresources.texi
+++ b/doc/emacs/xresources.texi
@@ -12,10 +12,10 @@ resources, as is usual for programs that use X.
 graphical widgets, such as the menu-bar, scroll-bar, and dialog boxes,
 is determined by
 @ifnottex
-GTK resources, which we will also describe.
+GTK+ resources, which we will also describe.
 @end ifnottex
 @iftex
-GTK resources.
+GTK+ resources.
 @end iftex
 When Emacs is built without GTK+ support, the appearance of these
 widgets is determined by additional X resources.
@@ -28,7 +28,7 @@ system registry (@pxref{MS-Windows Registry}).
 * Table of Resources::  Table of specific X resources that affect Emacs.
 * Lucid Resources::     X resources for Lucid menus.
 * Motif Resources::     X resources for Motif and LessTif menus.
-* GTK resources::       Resources for GTK widgets.
+* GTK resources::       Resources for GTK+ widgets.
 @end menu
 
 @node Resources
@@ -119,28 +119,29 @@ named @samp{Emacs}.  If you write @samp{Emacs} instead of
 regardless of frame titles and regardless of the name of the
 executable file.
 
-@item -xrm @var{resource-values}
+@item -xrm @var{resource-value}
 @opindex --xrm
-@itemx --xrm=@var{resource-values}
+@itemx --xrm=@var{resource-value}
 @cindex resource values, command-line argument
 This option specifies X resource values for the present Emacs job.
 
-@var{resource-values} should have the same format that you would use
-inside a file of X resources.  To include multiple resource
-specifications in @var{resource-values}, put a newline between them,
-just as you would in a file.  You can also use @samp{#include
-"@var{filename}"} to include a file full of resource specifications.
-Resource values specified with @samp{-xrm} take precedence over all
-other resource specifications.
+@var{resource-value} should have the same format that you would use
+inside a file of X resources.  Several @samp{-xrm} options are
+possible to include multiple resource specifications.  You can also
+use @samp{#include "@var{filename}"} as @var{resource-value} to
+include a file full of resource specifications.  Resource values
+specified with @samp{-xrm} take precedence over all other resource
+specifications.
 @end table
 @end ifnottex
 
 @node Table of Resources
 @appendixsec Table of X Resources for Emacs
 
-  This table lists the X resource names that Emacs recognizes,
-excluding those that control the appearance of graphical widgets like
-the menu bar:
+  The table below lists the X resource names that Emacs recognizes.
+Note that some of the resources have no effect in Emacs compiled with
+various X toolkits (GTK+, Lucid, etc.)---we indicate below when this
+is the case.
 
 @table @asis
 @item @code{background} (class @code{Background})
@@ -160,16 +161,16 @@ Width of the frame's external border, in pixels.  This has no effect
 if Emacs is compiled with GTK+ support.
 @end ifnottex
 
-@item @code{cursorColor} (class @code{Foreground})
-Text cursor color.  If this resource is specified when Emacs starts
-up, Emacs sets its value as the background color of the @code{cursor}
-face (@pxref{Faces}).
-
 @item @code{cursorBlink} (class @code{CursorBlink})
 If the value of this resource is @samp{off} or @samp{false} or
 @samp{0} at startup, Emacs disables Blink Cursor mode (@pxref{Cursor
 Display}).
 
+@item @code{cursorColor} (class @code{Foreground})
+Text cursor color.  If this resource is specified when Emacs starts
+up, Emacs sets its value as the background color of the @code{cursor}
+face (@pxref{Faces}).
+
 @item @code{font} (class @code{Font})
 Font name for the @code{default} face (@pxref{Fonts}).  You can also
 specify a fontset name (@pxref{Fontsets}).
@@ -184,6 +185,13 @@ in which case Emacs tries using all available font backends.
 @item @code{foreground} (class @code{Foreground})
 Default foreground color for text.
 
+@item @code{fullscreen} (class @code{Fullscreen})
+The desired fullscreen size.  The value can be one of @code{fullboth},
+@code{maximized}, @code{fullwidth} or @code{fullheight}, which
+correspond to the command-line options @samp{-fs}, @samp{-mm},
+@samp{-fw}, and @samp{-fh} (@pxref{Window Size X}).  Note that this
+applies to the initial frame only.
+
 @item @code{geometry} (class @code{Geometry})
 Window size and position.  The value should be a size and position
 specification, of the same form as in the @samp{-g} or
@@ -193,18 +201,15 @@ The size applies to all frames in the Emacs session, but the position
 applies only to the initial Emacs frame (or, in the case of a resource
 for a specific frame name, only that frame).
 
-
 Be careful not to specify this resource as @samp{emacs*geometry}, as
 that may affect individual menus as well as the main Emacs frame.
 
-@item @code{fullscreen} (class @code{Fullscreen})
-The desired fullscreen size.  The value can be one of @code{fullboth},
-@code{maximized}, @code{fullwidth} or @code{fullheight}, which
-correspond to the command-line options @samp{-fs}, @samp{-mm},
-@samp{-fw}, and @samp{-fh} (@pxref{Window Size X}).  Note that this
-applies to the initial frame only.
-
 @ifnottex
+@item @code{horizontalScrollBars} (class @code{ScrollBars})
+If the value of this resource is @samp{off} or @samp{false} or
+@samp{0}, Emacs disables Horizontal Scroll Bar mode at startup
+(@pxref{Scroll Bars}).
+
 @item @code{iconName} (class @code{Title})
 Name to display in the icon.
 
@@ -318,8 +323,8 @@ This is only relevant if your Emacs is built with XIM support.  It
 might be useful to turn off XIM on slow X client/server links.
 
 @item @code{verticalScrollBars} (class @code{ScrollBars})
-Give frames scroll bars if @samp{on}; don't have scroll bars if
-@samp{off}.
+Give frames scroll bars on the left if @samp{left}, on the right if
+@samp{right}; don't have scroll bars if @samp{off} (@pxref{Scroll Bars}).
 
 @ifnottex
 @item @code{visualClass} (class @code{VisualClass})
@@ -346,13 +351,13 @@ resources.  @xref{Face Customization}.
 @cindex Lucid Widget X Resources
 
   If Emacs is compiled with the X toolkit support using Lucid widgets,
-you can use X resources to customize the appearance of the menu bar,
-pop-up menus, and dialog boxes.  The resources for the menu bar fall
-in the @samp{pane.menubar} class (following, as always, either the
-name of the Emacs executable or @samp{Emacs} for all Emacs
-invocations).  The resources for the pop-up menu are in the
-@samp{menu*} class.  The resources for dialog boxes are in the
-@samp{dialog*} class.
+you can use X resources to customize the appearance of the menu bar
+(@pxref{Menu Bar}), pop-up menus, and dialog boxes (@pxref{Dialog
+Boxes}).  The resources for the menu bar fall in the
+@samp{pane.menubar} class (following, as always, either the name of
+the Emacs executable or @samp{Emacs} for all Emacs invocations).  The
+resources for the pop-up menu are in the @samp{menu*} class.  The
+resources for dialog boxes are in the @samp{dialog*} class.
 
   For example, to display menu bar entries with the @samp{Courier-12}
 font (@pxref{Fonts}), write this:
@@ -374,12 +379,12 @@ Here is a list of resources for menu bars, pop-up menus, and dialogs:
 Font for menu item text.
 @item fontSet
 Fontset for menu item text.
-@item foreground
-Foreground color.
 @item background
 Background color.
 @item buttonForeground
 Foreground color for a selected item.
+@item foreground
+Foreground color.
 @ifnottex
 @item horizontalSpacing
 Horizontal spacing in pixels between items.  Default is 3.
@@ -403,14 +408,15 @@ Margin of the menu bar, in characters.  Default is 1.
 
   If Emacs is compiled with the X toolkit support using Motif or
 LessTif widgets, you can use X resources to customize the appearance
-of the menu bar, pop-up menus, and dialog boxes.  However, the
-resources are organized differently from Lucid widgets.
+of the menu bar (@pxref{Menu Bar}), pop-up menus, and dialog boxes
+(@pxref{Dialog Boxes}).  However, the resources are organized
+differently from Lucid widgets.
 
   The resource names for the menu bar are in the @samp{pane.menubar}
 class, and they must be specified in this form:
 
 @smallexample
-Emacs.pane.menubar.@var{subwidget}.@var{resource}:  @var{value}
+Emacs.pane.menubar.@var{subwidget}.@var{resource}: @var{value}
 @end smallexample
 
 @noindent
@@ -427,7 +433,7 @@ For example, to specify the font @samp{8x16} for all menu bar items,
 including submenus, write this:
 
 @smallexample
-Emacs.pane.menubar.*.fontList:  8x16
+Emacs.pane.menubar.*.fontList: 8x16
 @end smallexample
 
   Each item in a submenu also has its own name for X resources; for
@@ -471,7 +477,7 @@ itself, you must first specify the resource for all of them, then
 override the value for submenus alone.  Here is an example:
 
 @smallexample
-Emacs.pane.menubar.*.fontList:  8x16
+Emacs.pane.menubar.*.fontList: 9x18
 Emacs.pane.menubar.popup_*.fontList: 8x16
 @end smallexample
 
@@ -508,9 +514,9 @@ The color for the border shadow, on the top and the left.
 @end ifnottex
 
 @node GTK resources
-@appendixsec GTK resources
+@appendixsec GTK+ resources
 @cindex GTK+ resources
-@cindex resource files for GTK
+@cindex resource files for GTK+
 @cindex @file{~/.gtkrc-2.0} file
 @cindex @file{~/.emacs.d/gtkrc} file
 
@@ -525,7 +531,7 @@ resources are specified in either the file @file{~/.emacs.d/gtkrc}
 (for Emacs-specific GTK+ resources), or @file{~/.gtkrc-2.0} (for
 general GTK+ resources).  We recommend using @file{~/.emacs.d/gtkrc},
 since GTK+ seems to ignore @file{~/.gtkrc-2.0} when running GConf with
-GNOME@.  Note, however, that some GTK themes may override
+GNOME@.  Note, however, that some GTK+ themes may override
 customizations in @file{~/.emacs.d/gtkrc}; there is nothing we can do
 about this.  GTK+ resources do not affect aspects of Emacs unrelated
 to GTK+ widgets, such as fonts and colors in the main Emacs window;
@@ -548,15 +554,15 @@ system, see
 @menu
 * GTK Resource Basics::   Basic usage of GTK+ resources.
 * GTK Widget Names::      How GTK+ widgets are named.
-* GTK Names in Emacs::    GTK widgets used by Emacs.
-* GTK styles::            What can be customized in a GTK widget.
+* GTK Names in Emacs::    GTK+ widgets used by Emacs.
+* GTK styles::            What can be customized in a GTK+ widget.
 @end menu
 
 @node GTK Resource Basics
-@appendixsubsec GTK Resource Basics
+@appendixsubsec GTK+ Resource Basics
 
   In a GTK+ 2 resource file (usually @file{~/.emacs.d/gtkrc}), the
-simplest kinds of resource settings simply assign a value to a
+simplest kind of a resource setting simply assigns a value to a
 variable.  For example, putting the following line in the resource
 file changes the font on all GTK+ widgets to @samp{courier-12}:
 
@@ -611,8 +617,8 @@ widget "*verticalScrollBar*" style "scroll"
 @end smallexample
 
 @node GTK Widget Names
-@appendixsubsec GTK widget names
-@cindex GTK widget names
+@appendixsubsec GTK+ widget names
+@cindex GTK+ widget names
 
   A GTK+ widget is specified by a @dfn{widget name} and a @dfn{widget
 class}.  The widget name refers to a specific widget
@@ -656,9 +662,9 @@ widget "*" style "my_style"
 @end smallexample
 
 @node GTK Names in Emacs
-@appendixsubsec GTK Widget Names in Emacs
-@cindex GTK widget names in Emacs
-@cindex GTK widget classes
+@appendixsubsec GTK+ Widget Names in Emacs
+@cindex GTK+ widget names in Emacs
+@cindex GTK+ widget classes
 
   The GTK+ widgets used by an Emacs frame are listed below:
 
@@ -720,8 +726,8 @@ widget_class "*Menu*" style "my_menu_style"
 @end smallexample
 
 @node GTK styles
-@appendixsubsec GTK styles
-@cindex GTK styles
+@appendixsubsec GTK+ styles
+@cindex GTK+ styles
 
   Here is an example of two GTK+ style declarations:
 
@@ -770,20 +776,24 @@ possible states are:
 @table @code
 @item NORMAL
 This is the default state for widgets.
+
 @item ACTIVE
 This is the state for a widget that is ready to do something.  It is
 also for the trough of a scroll bar, i.e., @code{bg[ACTIVE] = "red"}
 sets the scroll bar trough to red.  Buttons that have been armed
 (pressed but not released yet) are in this state.
+
 @item PRELIGHT
 This is the state for a widget that can be manipulated, when the mouse
 pointer is over it---for example when the mouse is over the thumb in
 the scroll bar or over a menu item.  When the mouse is over a button
 that is not pressed, the button is in this state.
+
 @item SELECTED
 This is the state for data that has been selected by the user.  It can
 be selected text or items selected in a list.  This state is not used
 in Emacs.
+
 @item INSENSITIVE
 This is the state for widgets that are visible, but they cannot be
 manipulated in the usual way---for example, buttons that can't be
@@ -805,14 +815,14 @@ dialog.
 
 @item bg_pixmap[@var{state}] = "@var{pixmap}"
 This specifies an image background (instead of a background color).
-@var{pixmap} should be the image file name.  GTK can use a number of
+@var{pixmap} should be the image file name.  GTK+ can use a number of
 image file formats, including XPM, XBM, GIF, JPEG and PNG@.  If you
 want a widget to use the same image as its parent, use
 @samp{<parent>}.  If you don't want any image, use @samp{<none>}.
 @samp{<none>} is the way to cancel a background image inherited from a
 parent style.
 
-You can't specify the file by its absolute file name.  GTK looks for
+You can't specify the file by its absolute file name.  GTK+ looks for
 the pixmap file in directories specified in @code{pixmap_path}.
 @code{pixmap_path} is a colon-separated list of directories within
 double quotes, specified at the top level in a @file{gtkrc} file
diff --git a/doc/lispintro/emacs-lisp-intro.texi b/doc/lispintro/emacs-lisp-intro.texi
index 16216bb774..c86ca43954 100644
--- a/doc/lispintro/emacs-lisp-intro.texi
+++ b/doc/lispintro/emacs-lisp-intro.texi
@@ -5882,7 +5882,7 @@ find and use again and again.
 @node New insert-buffer
 @subsection New Body for @code{insert-buffer}
 @findex insert-buffer@r{, new version body}
-@cindex new version body for insert-buffer
+@cindex new version body for @code{insert-buffer}
 
 The body in the GNU Emacs 22 version is more confusing than the original.
 
@@ -13254,7 +13254,7 @@ If you are reading this inside of GNU Emacs and you want to see the
 whole function, you can type @kbd{C-h f} (@code{describe-function})
 and the name of the function.  This gives you the function
 documentation and the name of the library containing the function's
-source.  Place point over the name of the library and press the RET
+source.  Place point over the name of the library and press the @key{RET}
 key; you will be taken directly to the source.  (Be sure to install
 your sources!  Without them, you are like a person who tries to drive
 a car with his eyes shut!)
@@ -14739,7 +14739,7 @@ In Emacs 22
   "Edit file FILENAME.
 Switch to a buffer visiting file FILENAME,
 creating one if none already exists.
-Interactively, the default if you just type RET is the current directory,
+Interactively, the default if you just type @key{RET} is the current directory,
 but the visited file name is available through the minibuffer history:
 type M-n to pull it into the minibuffer.
 
@@ -15917,8 +15917,8 @@ a regular expression, including functions that are not interactive.
 What we want to look for is some command that prints or inserts
 columns.  Very likely, the name of the function will contain either
 the word ``print'' or the word ``insert'' or the word ``column''.
-Therefore, we can simply type @kbd{M-x apropos RET
-print\|insert\|column RET} and look at the result.  On my system, this
+Therefore, we can simply type @kbd{M-x apropos @key{RET}
+print\|insert\|column @key{RET}} and look at the result.  On my system, this
 command once took quite some time, and then produced a list of 79
 functions and variables.  Now it does not take much time at all and
 produces a list of 211 functions and variables.  Scanning down the
@@ -18147,7 +18147,7 @@ You can enter the debugger when you call the function by calling
 Type:
 
 @smallexample
-M-x debug-on-entry RET triangle-bugged RET
+M-x debug-on-entry @key{RET} triangle-bugged @key{RET}
 @end smallexample
 
 @need 1250
@@ -18255,7 +18255,7 @@ To cancel the effect of @code{debug-on-entry}, call
 @code{cancel-debug-on-entry} and the name of the function, like this:
 
 @smallexample
-M-x cancel-debug-on-entry RET triangle-bugged RET
+M-x cancel-debug-on-entry @key{RET} triangle-bugged @key{RET}
 @end smallexample
 
 @noindent
@@ -18341,7 +18341,7 @@ this by positioning your cursor within or just after the definition
 and typing
 
 @smallexample
-M-x edebug-defun RET
+M-x edebug-defun @key{RET}
 @end smallexample
 
 @noindent
@@ -18552,7 +18552,7 @@ one of those long, but decipherable functions.  You can look up
 
 In this instance, since the code is Lisp, the @file{*Help*} buffer
 contains the name of the library containing the function's source.
-You can put point over the name of the library and press the RET key,
+You can put point over the name of the library and press the @key{RET} key,
 which in this situation is bound to @code{help-follow}, and be taken
 directly to the source, in the same way as @kbd{M-.}
 (@code{find-tag}).
diff --git a/doc/lispref/display.texi b/doc/lispref/display.texi
index 3ae317ae78..7348b1bf6b 100644
--- a/doc/lispref/display.texi
+++ b/doc/lispref/display.texi
@@ -3292,7 +3292,7 @@ nominal heights and widths would suggest.
 @defun x-list-fonts name &optional reference-face frame maximum width
 This function returns a list of available font names that match
 @var{name}.  @var{name} should be a string containing a font name in
-either the Fontconfig, GTK, or XLFD format (@pxref{Fonts,,, emacs, The
+either the Fontconfig, GTK+, or XLFD format (@pxref{Fonts,,, emacs, The
 GNU Emacs Manual}).  Within an XLFD string, wildcard characters may be
 used: the @samp{*} character matches any substring, and the @samp{?}
 character matches any single character.  Case is ignored when matching
@@ -3550,7 +3550,7 @@ specifications are as follows:
 
 @table @code
 @item :name
-The font name (a string), in either XLFD, Fontconfig, or GTK format.
+The font name (a string), in either XLFD, Fontconfig, or GTK+ format.
 @xref{Fonts,,, emacs, The GNU Emacs Manual}.
 
 @item :family
@@ -5387,7 +5387,6 @@ hint to ImageMagick to help it detect the image type.
 Specifies a rotation angle in degrees.
 
 @item :index @var{frame}
-@c Doesn't work: https://debbugs.gnu.org/7978
 @xref{Multi-Frame Images}.
 @end table
 
@@ -5396,8 +5395,8 @@ Specifies a rotation angle in degrees.
 @cindex SVG images
 
 SVG (Scalable Vector Graphics) is an XML format for specifying images.
-If your Emacs build has with SVG support, you can create and manipulate
-these images with the following commands.
+If your Emacs build has SVG support, you can create and manipulate
+these images with the following functions.
 
 @defun svg-create width height &rest args
 Create a new, empty SVG image with the specified dimensions.
@@ -5411,7 +5410,7 @@ The default width (in pixels) of any lines created.
 The default stroke color on any lines created.
 @end table
 
-This function returns an SVG structure, and all the following commands
+This function returns an SVG structure, and all the following functions
 work on that structure.
 @end defun
 
@@ -5993,7 +5992,7 @@ debugging.
 @cindex embedded widgets
 @cindex webkit browser widget
 
-  Emacs is able to display native widgets, such as GTK WebKit widgets,
+  Emacs is able to display native widgets, such as GTK+ WebKit widgets,
 in Emacs buffers when it was built with the necessary support
 libraries and is running on a graphical terminal.  To test whether
 Emacs supports display of embedded widgets, check that the
diff --git a/doc/lispref/files.texi b/doc/lispref/files.texi
index 68cc3df49a..6c6655c77d 100644
--- a/doc/lispref/files.texi
+++ b/doc/lispref/files.texi
@@ -3250,7 +3250,7 @@ shown above; the details are crucial for proper behavior in the case of
 multiple handlers, and for operations that have two file names that may
 each have handlers.
 
-@kindex safe-magic (@r{property})
+@kindex safe-magic @r{(property)}
   Handlers that don't really do anything special for actual access to the
 file---such as the ones that implement completion of host names for
 remote file names---should have a non-@code{nil} @code{safe-magic}
@@ -3260,7 +3260,7 @@ file names, by prefixing them with @samp{/:}.  But if the handler that
 would be used for them has a non-@code{nil} @code{safe-magic}
 property, the @samp{/:} is not added.
 
-@kindex operations (@r{property})
+@kindex operations @r{(property)}
   A file name handler can have an @code{operations} property to
 declare which operations it handles in a nontrivial way.  If this
 property has a non-@code{nil} value, it should be a list of
diff --git a/doc/lispref/frames.texi b/doc/lispref/frames.texi
index 2f9bb39886..459f05cb1c 100644
--- a/doc/lispref/frames.texi
+++ b/doc/lispref/frames.texi
@@ -181,6 +181,12 @@ the value of that parameter in the created frame to its value in the
 selected frame.
 @end defvar
 
+@defopt server-after-make-frame-hook
+A normal hook run when the Emacs server creates a client frame.  When
+this hook is called, the created frame is the selected one.
+@xref{Emacs Server,,, emacs, The GNU Emacs Manual}.
+@end defopt
+
 
 @node Multiple Terminals
 @section Multiple Terminals
diff --git a/doc/lispref/hooks.texi b/doc/lispref/hooks.texi
index db4e413921..e374d02def 100644
--- a/doc/lispref/hooks.texi
+++ b/doc/lispref/hooks.texi
@@ -66,6 +66,7 @@ not exactly a hook, but does a similar job.
 
 @item after-make-frame-functions
 @itemx before-make-frame-hook
+@itemx server-after-make-frame-hook
 @xref{Creating Frames}.
 
 @c Not general enough?
diff --git a/doc/lispref/keymaps.texi b/doc/lispref/keymaps.texi
index e39db7f6d0..cc2e11e0b6 100644
--- a/doc/lispref/keymaps.texi
+++ b/doc/lispref/keymaps.texi
@@ -2750,7 +2750,7 @@ If the value is @code{grow-only}, the tool bar expands automatically,
 but does not contract automatically.  To contract the tool bar, the
 user has to redraw the frame by entering @kbd{C-l}.
 
-If Emacs is built with GTK or Nextstep, the tool bar can only show one
+If Emacs is built with GTK+ or Nextstep, the tool bar can only show one
 line, so this variable has no effect.
 @end defvar
 
diff --git a/doc/lispref/numbers.texi b/doc/lispref/numbers.texi
index e692ee1cc2..f1180cf754 100644
--- a/doc/lispref/numbers.texi
+++ b/doc/lispref/numbers.texi
@@ -53,8 +53,9 @@ but many machines provide a wider range.  Many examples in this
 chapter assume the minimum integer width of 30 bits.
 @cindex overflow
 
-  The Lisp reader reads an integer as a sequence of digits with optional
-initial sign and optional final period.  An integer that is out of the
+  The Lisp reader reads an integer as a nonempty sequence
+of decimal digits with optional initial sign and optional
+final period.  A decimal integer that is out of the
 Emacs range is treated as a floating-point number.
 
 @example
diff --git a/doc/lispref/streams.texi b/doc/lispref/streams.texi
index 8f531347dc..a07500715e 100644
--- a/doc/lispref/streams.texi
+++ b/doc/lispref/streams.texi
@@ -778,6 +778,14 @@ In the second expression, the local binding of
 @code{prin1}, but not during the printing of the result.
 @end defvar
 
+@defvar print-escape-control-characters
+If this variable is non-@code{nil}, control characters in strings are
+printed as backslash sequences by the print functions @code{prin1} and
+@code{print} that print with quoting.  If this variable and
+@code{print-escape-newlines} are both non-@code{nil}, the latter takes
+precedences for newlines and formfeeds.
+@end defvar
+
 @defvar print-escape-nonascii
 If this variable is non-@code{nil}, then unibyte non-@acronym{ASCII}
 characters in strings are unconditionally printed as backslash sequences
diff --git a/doc/lispref/strings.texi b/doc/lispref/strings.texi
index 5452ea6879..8a9e27d00e 100644
--- a/doc/lispref/strings.texi
+++ b/doc/lispref/strings.texi
@@ -727,7 +727,7 @@ minus sign if the argument is negative.
      @result{} "-23.5"
 @end example
 
-@cindex int-to-string
+@cindex @code{int-to-string}
 @code{int-to-string} is a semi-obsolete alias for this function.
 
 See also the function @code{format} in @ref{Formatting Strings}.
diff --git a/doc/lispref/text.texi b/doc/lispref/text.texi
index 9de270c2d8..e992c0f561 100644
--- a/doc/lispref/text.texi
+++ b/doc/lispref/text.texi
@@ -3862,7 +3862,7 @@ clicks on the link quickly without moving the mouse.  This behavior is
 controlled by the user option @code{mouse-1-click-follows-link}.
 @xref{Mouse References,,, emacs, The GNU Emacs Manual}.
 
-@cindex follow-link (text or overlay property)
+@kindex follow-link @r{(text or overlay property)}
   To set up the link so that it obeys
 @code{mouse-1-click-follows-link}, you must either (1) apply a
 @code{follow-link} text or overlay property to the link text, or (2)
diff --git a/doc/lispref/tips.texi b/doc/lispref/tips.texi
index 0695d9b7b1..c62cfcfa8f 100644
--- a/doc/lispref/tips.texi
+++ b/doc/lispref/tips.texi
@@ -1043,7 +1043,8 @@ the place to write arbitrary keywords that describe their package,
 rather than just the relevant Finder keywords.
 
 @item Homepage
-This line states the homepage of the library.
+@itemx URL
+These lines state the homepage of the library.
 
 @item Package-Version
 If @samp{Version} is not suitable for use by the package manager, then
diff --git a/doc/lispref/variables.texi b/doc/lispref/variables.texi
index 203838d9d8..55bca5edcc 100644
--- a/doc/lispref/variables.texi
+++ b/doc/lispref/variables.texi
@@ -165,7 +165,7 @@ receive local values, which are the actual arguments supplied to the
 function call; these local bindings take effect within the body of the
 function.  To take another example, the @code{let} special form
 explicitly establishes local bindings for specific variables, which
-take effect within the body of the @code{let} form.
+take effect only within the body of the @code{let} form.
 
   We also speak of the @dfn{global binding}, which is where
 (conceptually) the global value is kept.
@@ -204,7 +204,8 @@ bindings:
 This special form sets up local bindings for a certain set of
 variables, as specified by @var{bindings}, and then evaluates all of
 the @var{forms} in textual order.  Its return value is the value of
-the last form in @var{forms}.
+the last form in @var{forms}.  The local bindings set up by @code{let}
+will be in effect only within the body of @var{forms}.
 
 Each of the @var{bindings} is either @w{(i) a} symbol, in which case
 that symbol is locally bound to @code{nil}; or @w{(ii) a} list of the
diff --git a/doc/misc/calc.texi b/doc/misc/calc.texi
index a4a091f243..be78a53ed6 100644
--- a/doc/misc/calc.texi
+++ b/doc/misc/calc.texi
@@ -9710,7 +9710,7 @@ The @kbd{C-x * x} command also turns the Calculator off, no matter which
 user interface (standard, Keypad, or Embedded) is currently active.
 It also cancels @code{calc-edit} mode if used from there.
 
-@kindex d @key{SPC}
+@kindex d SPC
 @pindex calc-refresh
 @cindex Refreshing a garbled display
 @cindex Garbled displays, refreshing
@@ -10268,7 +10268,7 @@ information is cleared whenever you give any command that adds new undo
 information, i.e., if you undo, then enter a number on the stack or make
 any other change, then it will be too late to redo.
 
-@kindex M-@key{RET}
+@kindex M-RET
 @pindex calc-last-args
 @cindex Last-arguments feature
 @cindex Arguments, restoring
@@ -10906,27 +10906,27 @@ degrees, minutes, and seconds.
 @ignore
 @mindex @null
 @end ignore
-@kindex ' (HMS forms)
+@kindex ' @r{(HMS forms)}
 @ignore
 @mindex @null
 @end ignore
-@kindex " (HMS forms)
+@kindex " @r{(HMS forms)}
 @ignore
 @mindex @null
 @end ignore
-@kindex h (HMS forms)
+@kindex h @r{(HMS forms)}
 @ignore
 @mindex @null
 @end ignore
-@kindex o (HMS forms)
+@kindex o @r{(HMS forms)}
 @ignore
 @mindex @null
 @end ignore
-@kindex m (HMS forms)
+@kindex m @r{(HMS forms)}
 @ignore
 @mindex @null
 @end ignore
-@kindex s (HMS forms)
+@kindex s @r{(HMS forms)}
 The default format for HMS values is
 @samp{@var{hours}@@ @var{mins}' @var{secs}"}.  During entry, the letters
 @samp{h} (for ``hours'') or
@@ -11125,7 +11125,7 @@ integers but this is not required.
 @ignore
 @mindex M
 @end ignore
-@kindex M (modulo forms)
+@kindex M @r{(modulo forms)}
 @ignore
 @mindex mod
 @end ignore
@@ -11280,7 +11280,7 @@ would indeed have been negligible.
 @ignore
 @mindex p
 @end ignore
-@kindex p (error forms)
+@kindex p @r{(error forms)}
 @tindex +/-
 To enter an error form during regular numeric entry, use the @kbd{p}
 (``plus-or-minus'') key to type the @samp{+/-} symbol.  (If you try actually
@@ -11732,8 +11732,8 @@ type, such as numbers, vectors, formulas, and incomplete objects.)
 @section Stack Manipulation Commands
 
 @noindent
-@kindex @key{RET}
-@kindex @key{SPC}
+@kindex RET
+@kindex SPC
 @pindex calc-enter
 @cindex Duplicating stack entries
 To duplicate the top object on the stack, press @key{RET} or @key{SPC}
@@ -11749,7 +11749,7 @@ For example, with @samp{10 20 30} on the stack,
 @kbd{C-u - 2 @key{RET}} creates @samp{10 20 30 20}, and
 @kbd{C-u 0 @key{RET}} creates @samp{10 20 30 10 20 30}.
 
-@kindex @key{LFD}
+@kindex LFD
 @pindex calc-over
 The @key{LFD} (@code{calc-over}) command (on a key marked Line-Feed if you
 have it, else on @kbd{C-j}) is like @code{calc-enter}
@@ -11759,7 +11759,7 @@ Thus with @samp{10 20 30} on the stack, @key{LFD} and @kbd{C-u 2 @key{LFD}}
 are both equivalent to @kbd{C-u - 2 @key{RET}}, producing
 @samp{10 20 30 20}.
 
-@kindex @key{DEL}
+@kindex DEL
 @kindex C-d
 @pindex calc-pop
 @cindex Removing stack entries
@@ -11777,7 +11777,7 @@ For example, with @samp{10 20 30} on the stack,
 @kbd{C-u - 2 @key{DEL}} leaves @samp{10 30}, and
 @kbd{C-u 0 @key{DEL}} leaves an empty stack.
 
-@kindex M-@key{DEL}
+@kindex M-DEL
 @pindex calc-pop-above
 The @kbd{M-@key{DEL}} (@code{calc-pop-above}) command is to @key{DEL} what
 @key{LFD} is to @key{RET}:  It interprets the sign of the numeric
@@ -11798,7 +11798,7 @@ specified element of the stack regardless of the cursor  position.
 Similarly, @key{DEL} will remove the corresponding elements from the
 stack.
 
-@kindex @key{TAB}
+@kindex TAB
 @pindex calc-roll-down
 To exchange the top two elements of the stack, press @key{TAB}
 (@code{calc-roll-down}).  Given a positive numeric prefix argument, the
@@ -11812,7 +11812,7 @@ For example, with @samp{10 20 30 40 50} on the stack,
 @kbd{C-u - 2 @key{TAB}} creates @samp{40 50 10 20 30}, and
 @kbd{C-u 0 @key{TAB}} creates @samp{50 40 30 20 10}.
 
-@kindex M-@key{TAB}
+@kindex M-TAB
 @pindex calc-roll-up
 The command @kbd{M-@key{TAB}} (@code{calc-roll-up}) is analogous to @key{TAB}
 except that it rotates upward instead of downward.  Also, the default
@@ -13075,7 +13075,7 @@ refresh the stack to leave the stack display alone.  The word ``Dirty''
 will appear in the mode line when Calc thinks the stack display may not
 reflect the latest mode settings.
 
-@kindex d @key{RET}
+@kindex d RET
 @pindex calc-refresh-top
 The @kbd{d @key{RET}} (@code{calc-refresh-top}) command reformats the
 top stack entry according to all the current modes.  Positive prefix
@@ -16682,8 +16682,8 @@ or matrix argument, these functions operate element-wise.
 @ignore
 @mindex v p
 @end ignore
-@kindex v p (complex)
-@kindex V p (complex)
+@kindex v p @r{(complex)}
+@kindex V p @r{(complex)}
 @pindex calc-pack
 The @kbd{v p} (@code{calc-pack}) command can pack the top two numbers on
 the stack into a composite object such as a complex number.  With
@@ -16694,8 +16694,8 @@ with an argument of @mathit{-2}, it produces a polar complex number.
 @ignore
 @mindex v u
 @end ignore
-@kindex v u (complex)
-@kindex V u (complex)
+@kindex v u @r{(complex)}
+@kindex V u @r{(complex)}
 @pindex calc-unpack
 The @kbd{v u} (@code{calc-unpack}) command takes the complex number
 (or other composite object) on the top of the stack and unpacks it
@@ -20234,7 +20234,7 @@ the conjugate transpose of its argument, i.e., @samp{conj(trn(x))}.
 @ignore
 @mindex A
 @end ignore
-@kindex A (vectors)
+@kindex A @r{(vectors)}
 @pindex calc-abs (vectors)
 @ignore
 @mindex abs
@@ -20280,7 +20280,7 @@ exactly three elements.
 @ignore
 @mindex &
 @end ignore
-@kindex & (matrices)
+@kindex & @r{(matrices)}
 @pindex calc-inv (matrices)
 @ignore
 @mindex inv
@@ -21942,7 +21942,7 @@ If you select an element of a vector and press @key{DEL}, that
 element is deleted from the vector.  If you delete one side of
 an equation or inequality, only the opposite side remains.
 
-@kindex j @key{DEL}
+@kindex j DEL
 @pindex calc-del-selection
 The @kbd{j @key{DEL}} (@code{calc-del-selection}) command is like
 @key{DEL} but with the auto-selecting behavior of @kbd{j '} and
@@ -21950,7 +21950,7 @@ The @kbd{j @key{DEL}} (@code{calc-del-selection}) command is like
 indicated by the cursor, or, in the absence of a selection, it
 deletes the sub-formula indicated by the cursor position.
 
-@kindex j @key{RET}
+@kindex j RET
 @pindex calc-grab-selection
 (There is also an auto-selecting @kbd{j @key{RET}} (@code{calc-copy-selection})
 command.)
@@ -31292,7 +31292,7 @@ for @code{Save} have no effect.
 You can modify Embedded mode's behavior by setting various Lisp
 variables described here.  These variables are customizable
 (@pxref{Customizing Calc}), or you can use @kbd{M-x set-variable}
-or @kbd{M-x edit-options} to adjust a variable on the fly.
+to adjust a variable on the fly.
 (Another possibility would be to use a file-local variable annotation at
 the end of the file;
 @pxref{File Variables, , Local Variables in Files, emacs, the Emacs manual}.)
@@ -31311,9 +31311,8 @@ regular expression is not completely plain, let's go through it
 in detail.
 
 The surrounding @samp{" "} marks quote the text between them as a
-Lisp string.  If you left them off, @code{set-variable} or
-@code{edit-options} would try to read the regular expression as a
-Lisp program.
+Lisp string.  If you left them off, @code{set-variable} (for example)
+would try to read the regular expression as a Lisp program.
 
 The most obvious property of this regular expression is that it
 contains indecently many backslashes.  There are actually two levels
@@ -35348,13 +35347,13 @@ followed by  @kbd{=}, @kbd{&}, @kbd{#}, @kbd{\}, @kbd{/}, @kbd{+} or
 @kbd{-} as well as @kbd{*} to start Calc, and so in many cases the last
 character of the prefix can simply be typed twice.
 
-Calc is controlled by many variables, most of which can be reset
-from within Calc.  Some variables are less involved with actual
-calculation and can be set outside of Calc using Emacs's
-customization facilities.  These variables are listed below.
-Typing @kbd{M-x customize-variable RET @var{variable-name} RET}
-will bring up a buffer in which the variable's value can be redefined.
-Typing @kbd{M-x customize-group RET calc RET} will bring up a buffer which
+Calc is controlled by many variables, most of which can be reset from
+within Calc.  Some variables are less involved with actual calculation
+and can be set outside of Calc using Emacs's customization facilities.
+These variables are listed below.  Typing @kbd{M-x customize-variable
+@key{RET} @var{variable-name} @key{RET}} will bring up a buffer in
+which the variable's value can be redefined.  Typing @kbd{M-x
+customize-group @key{RET} calc @key{RET}} will bring up a buffer which
 contains all of Calc's customizable variables.  (These variables can
 also be reset by putting the appropriate lines in your .emacs file;
 @xref{Init File, ,Init File, emacs, The GNU Emacs Manual}.)
diff --git a/doc/misc/cc-mode.texi b/doc/misc/cc-mode.texi
index a506213ea2..5a229c1cd6 100644
--- a/doc/misc/cc-mode.texi
+++ b/doc/misc/cc-mode.texi
@@ -356,9 +356,9 @@ Customizing Macros
 
 @cindex BOCM
 @cindex history
-@cindex awk-mode.el
-@cindex c-mode.el
-@cindex c++-mode.el
+@cindex @file{awk-mode.el}
+@cindex @file{c-mode.el}
+@cindex @file{c++-mode.el}
 
 Welcome to @ccmode{}, a GNU Emacs mode for editing files containing C,
 C++, Objective-C, Java, CORBA IDL (and the variants CORBA PSDL and
@@ -577,9 +577,9 @@ for the latest information on Emacs version and package compatibility
 
 @deffn Command c-version
 @findex version @r{(c-)}
-You can find out what version of @ccmode{} you are using by visiting a C
-file and entering @kbd{M-x c-version RET}.  You should see this message in
-the echo area:
+You can find out what version of @ccmode{} you are using by visiting a
+C file and entering @kbd{M-x c-version @key{RET}}.  You should see
+this message in the echo area:
 
 @example
 Using CC Mode version 5.XX
@@ -920,8 +920,8 @@ must be in column zero.  See @ref{Defuns,,,@emacsman{},
 
 @item @kbd{C-M-a} (AWK Mode) (@code{c-awk-beginning-of-defun})
 @itemx @kbd{C-M-e} (AWK Mode) (@code{c-awk-end-of-defun})
-@kindex C-M-a (AWK Mode)
-@kindex C-M-e (AWK Mode)
+@kindex C-M-a @r{(AWK Mode)}
+@kindex C-M-e @r{(AWK Mode)}
 @findex c-awk-beginning-of-defun
 @findex awk-beginning-of-defun @r{(c-)}
 @findex c-awk-end-of-defun
@@ -1521,7 +1521,7 @@ deletion.
 @kindex DEL
 @findex c-electric-backspace
 @findex electric-backspace @r{(c-)}
-This command is run by default when you hit the @kbd{DEL} key.  When
+This command is run by default when you hit the @kbd{@key{DEL}} key.  When
 hungry delete mode is enabled, it deletes any amount of whitespace in
 the backwards direction.  Otherwise, or when used with a prefix
 argument or in a literal (@pxref{Auto-newlines}), the command just
@@ -1567,8 +1567,8 @@ rather than using the minor mode toggling.
 
 @table @asis
 @item @kbd{C-c C-@key{DEL}}, or @kbd{C-c @key{DEL}} (@code{c-hungry-delete-backwards})@footnote{This command was formerly known as @code{c-hungry-backspace}.}
-@kindex C-c C-<backspace>
-@kindex C-c <backspace>
+@kindex C-c C-Backspace
+@kindex C-c Backspace
 @kindex C-c C-DEL
 @kindex C-c DEL
 @findex c-hungry-delete-backwards
@@ -1581,21 +1581,21 @@ a character terminal.
 
 @item @kbd{C-c C-d}, @kbd{C-c C-@key{DELETE}}, or @kbd{C-c @key{DELETE}} (@code{c-hungry-delete-forward})
 @kindex C-c C-d
-@kindex C-c C-<DELETE>
-@kindex C-c <DELETE>
+@kindex C-c C-Delete
+@kindex C-c Delete
 @findex c-hungry-delete-forward
 @findex hungry-delete-forward @r{(c-)}
 Delete any amount of whitespace in the forward direction (regardless
 whether hungry-delete mode is enabled or not).  This command is bound
-to both @kbd{C-c C-@key{DELETE}} and @kbd{C-c @key{DELETE}} for the
+to both @kbd{C-c C-@key{Delete}} and @kbd{C-c @key{Delete}} for the
 same reason as for @key{DEL} above.
 @end table
 @end table
 
-@kindex <delete>
-@kindex <backspace>
+@kindex Delete
+@kindex Backspace
 
-When we talk about @kbd{@key{DEL}}, and @kbd{@key{DELETE}} above, we
+When we talk about @kbd{@key{DEL}}, and @kbd{@key{Delete}} above, we
 actually do so without connecting them to the physical keys commonly
 known as @key{Backspace} and @key{Delete}.  The default bindings to
 those two keys depends on the flavor of (X)Emacs you are using.
@@ -1708,7 +1708,7 @@ nomenclature and treat them as separate words:
 @item     @kbd{M-b}   @tab @code{backward-word}      @tab @code{c-backward-subword}
 @item     @kbd{M-@@}  @tab @code{mark-word}          @tab @code{c-mark-subword}
 @item     @kbd{M-d}   @tab @code{kill-word}          @tab @code{c-kill-subword}
-@item     @kbd{M-DEL} @tab @code{backward-kill-word} @tab @code{c-backward-kill-subword}
+@item     @kbd{M-@key{DEL}} @tab @code{backward-kill-word} @tab @code{c-backward-kill-subword}
 @item     @kbd{M-t}   @tab @code{transpose-words}    @tab @code{c-transpose-subwords}
 @item     @kbd{M-c}   @tab @code{capitalize-word}    @tab @code{c-capitalize-subword}
 @item     @kbd{M-u}   @tab @code{upcase-word}        @tab @code{c-upcase-subword}
@@ -4734,7 +4734,7 @@ Once again, line 8 is assigned as @code{brace-entry-open} as is line
 with anchor point at the @samp{@{} of line 8@footnote{This extra
 syntactic element was introduced in @ccmode{} 5.33.1 to allow extra
 flexibility in indenting the second line of such a construct.  You can
-preserve the behaviour resulting from the former syntactic analysis by
+preserve the behavior resulting from the former syntactic analysis by
 giving @code{brace-list-entry} an offset of
 @code{c-lineup-under-anchor} (@pxref{Misc Line-Up}).}, and
 @code{brace-list-entry} anchored on the @samp{1} of line 8.
@@ -7250,13 +7250,13 @@ Set the variable @code{c-basic-offset}.  @xref{Getting Started}.
 @item
 @kindex RET
 @kindex C-j
-@emph{Why does/doesn't the @kbd{RET} key indent the new line?}
+@emph{Why does/doesn't the @kbd{@key{RET}} key indent the new line?}
 
 Emacs's convention used to be that @kbd{RET} just adds a newline, and that
 @kbd{C-j} adds a newline and indents it.  In Emacs-24.4, this convention was
 reversed.
 
-If you use an older Emacs and you want @kbd{RET} do this
+If you use an older Emacs and you want @kbd{@key{RET}} do this
 too, add this to your @code{c-initialization-hook}:
 
 @example
diff --git a/doc/misc/dbus.texi b/doc/misc/dbus.texi
index b425bb0c00..5b14382d8b 100644
--- a/doc/misc/dbus.texi
+++ b/doc/misc/dbus.texi
@@ -1815,7 +1815,7 @@ The function returns a number, which counts the connections this Emacs
 session has established to the @var{bus} under the same unique name
 (see @code{dbus-get-unique-name}).  It depends on the libraries Emacs
 is linked with, and on the environment Emacs is running.  For example,
-if Emacs is linked with the gtk toolkit, and it runs in a GTK-aware
+if Emacs is linked with the GTK+ toolkit, and it runs in a GTK+-aware
 environment like Gnome, another connection might already be
 established.
 
@@ -1837,9 +1837,9 @@ Example: You initialize a connection to the AT-SPI bus on your host:
 
 @result{} "unix:abstract=/tmp/dbus-2yzWHOCdSD,guid=a490dd26625870ca1298b6e10000fd7f"
 
-;; If Emacs is built with gtk support, and you run in a GTK enabled
+;; If Emacs is built with GTK+ support, and you run in a GTK+-enabled
 ;; environment (like a GNOME session), the initialization reuses the
-;; connection established by GTK's atk bindings.
+;; connection established by GTK+'s atk bindings.
 (dbus-init-bus my-bus)
 
 @result{} 2
diff --git a/doc/misc/dired-x.texi b/doc/misc/dired-x.texi
index 130c06b40e..60e978c9d9 100644
--- a/doc/misc/dired-x.texi
+++ b/doc/misc/dired-x.texi
@@ -995,7 +995,7 @@ If there are several Dired buffers for a directory, the most recently
 used is chosen.
 
 Dired avoids switching to the current buffer, so that if you have a
-normal and a wildcard buffer for the same directory, @kbd{C-x d RET}
+normal and a wildcard buffer for the same directory, @kbd{C-x d @key{RET}}
 will toggle between those two.
 @end table
 
diff --git a/doc/misc/ebrowse.texi b/doc/misc/ebrowse.texi
index 9ac2af1bcf..b6f2c1865f 100644
--- a/doc/misc/ebrowse.texi
+++ b/doc/misc/ebrowse.texi
@@ -482,7 +482,7 @@ you are working on, some classes will only be known to exist but the
 location of their declarations and definitions will not be known.
 
 @item @key{RET}
-Works like @kbd{SPC}, except that it finds the class
+Works like @kbd{@key{SPC}}, except that it finds the class
 declaration rather than viewing it, so that it is ready for
 editing.
 @end table
@@ -886,7 +886,7 @@ the member.
 This command finds the declaration of the member the cursor is on.
 
 @item @key{SPC}
-This is the same command as @kbd{RET}, but views the member definition
+This is the same command as @kbd{@key{RET}}, but views the member definition
 instead of finding the member's source file.
 
 @item v
@@ -1314,7 +1314,7 @@ the next position stored in the position stack.
 
 @item C-c C-m p
 Displays an electric buffer showing all positions saved in the stack.
-You can select a position by pressing @kbd{SPC} in a line.  You can
+You can select a position by pressing @kbd{@key{SPC}} in a line.  You can
 view a position with @kbd{v}.
 @end table
 
diff --git a/doc/misc/ede.texi b/doc/misc/ede.texi
index 88dc9e922e..42bedb10f6 100644
--- a/doc/misc/ede.texi
+++ b/doc/misc/ede.texi
@@ -160,8 +160,8 @@ First, lets create a directory for our project.  For this example,
 we'll start with something in @file{/tmp}.
 
 @example
-C-x C-f /tmp/myproject/README RET
-M-x make-directory RET RET
+C-x C-f /tmp/myproject/README @key{RET}
+M-x make-directory @key{RET} @key{RET}
 @end example
 
 Now put some plain text in your README file to start.
@@ -169,7 +169,7 @@ Now put some plain text in your README file to start.
 Now, lets create the project:
 
 @example
-M-x ede-new RET Automake RET myproject RET
+M-x ede-new @key{RET} Automake @key{RET} myproject @key{RET}
 @end example
 
 
@@ -191,8 +191,8 @@ We'll make a more complex project, so use dired to create some more
 directories using the @kbd{+} key, and typing in new directories:
 
 @example
-+ include RET
-+ src RET
++ include @key{RET}
++ src @key{RET}
 @end example
 
 Now I'll short-cut in this tutorial.  Create the following files:
@@ -252,13 +252,13 @@ now create those projects.
 With @file{main.cpp} as your current buffer, type:
 
 @example
-M-x ede-new RET Automake RET src RET
+M-x ede-new @key{RET} Automake @key{RET} src @key{RET}
 @end example
 
 and in @file{myproj.hh} as your current buffer, type:
 
 @example
-M-x ede-new RET Automake RET include RET
+M-x ede-new @key{RET} Automake @key{RET} include @key{RET}
 @end example
 
 These steps effectively only create the Project.ede file in which you
@@ -272,7 +272,7 @@ Projects.  You can create targets either from a buffer, or from a
 
 Note: If for some reason a directory list buffer, or file does not have the
 @samp{Project} menu item, or if @ede{} keybindings don't work, just
-use @kbd{M-x revert-buffer RET} to force a refresh.  Sometimes
+use @kbd{M-x revert-buffer @key{RET}} to force a refresh.  Sometimes
 creating a new project doesn't restart buffers correctly.
 
 Lets start with the header file.  In @file{include/myproj.hh}, you
@@ -280,7 +280,7 @@ could use the menu, but we will now start using the @ede{} command prefix
 which is @kbd{C-c .}.
 
 @example
-C-c . t includes RET miscellaneous RET y
+C-c . t includes @key{RET} miscellaneous @key{RET} y
 @end example
 
 
@@ -292,7 +292,7 @@ Next, visit the @file{src} directory using dired.  There should be a
 @samp{Project} menu.   You can create a new target with
 
 @example
-. t myprogram RET program RET
+. t myprogram @key{RET} program @key{RET}
 @end example
 
 Note that @kbd{. t} is a command for creating a target.  This command
@@ -304,7 +304,7 @@ Next, place the cursor on @file{main.cpp}, and use @kbd{. a} to add
 that file to your target.
 
 @example
-. a myprogram RET
+. a myprogram @key{RET}
 @end example
 
 Note that these prompts often have completion, so you can just press
@@ -316,8 +316,8 @@ all in your dired buffer, and add them all at the same time.
 Next, do the same for the library by placing the cursor on @file{mylib.cpp}.
 
 @example
-. t mylib RET sharedobject RET
-. a mylib RET
+. t mylib @key{RET} sharedobject @key{RET}
+. a mylib @key{RET}
 @end example
 
 @section Step 5: Compile, and fail
@@ -350,7 +350,7 @@ To fix the failed compile, we need to add
 Visit @file{main.cpp}.
 
 @example
-M-x customize-project RET
+M-x customize-project @key{RET}
 @end example
 
 Select the @samp{[Settings]} subgroup of options.  Under
@@ -407,7 +407,7 @@ project.  This is because variables such as the include path are
 treated globally, whereas dependencies for a target are target specific.
 
 @example
-M-x customize-target RET
+M-x customize-target @key{RET}
 @end example
 
 On the first page, you will see an Ldlibs-local section.  Add mylib to
@@ -437,7 +437,7 @@ C-c . C
 You can run your program directly from @ede{}.
 
 @example
-C-c . R RET RET
+C-c . R @key{RET} @key{RET}
 @end example
 
 If your program takes command line arguments, you can type them in
diff --git a/doc/misc/ediff.texi b/doc/misc/ediff.texi
index e488fc07f8..8ffa90fb5b 100644
--- a/doc/misc/ediff.texi
+++ b/doc/misc/ediff.texi
@@ -541,12 +541,12 @@ Copies the difference region from buffer C to buffer B@.
 The command @kbd{rb} undoes this.
 
 @item p
-@itemx DEL
+@itemx @key{DEL}
 @kindex p
 @kindex DEL
 Makes the previous difference region current.
 @item n
-@itemx SPC
+@itemx @key{SPC}
 @kindex n
 @kindex SPC
 Makes the next difference region current.
diff --git a/doc/misc/edt.texi b/doc/misc/edt.texi
index 20a7034fb2..ddeacf16b4 100644
--- a/doc/misc/edt.texi
+++ b/doc/misc/edt.texi
@@ -192,10 +192,10 @@ EDT Emulation.  (Note: In a few rare circumstances this does not work
 properly.  In particular, it does not work if a subset of the leading
 @acronym{ASCII} characters in a key sequence are recognized by Emacs as
 having an existing binding.  For example, if the keypad 7 (@key{KP7})
-key generates the sequence @samp{<ESC>Ow} and @samp{<ESC>O} is already
+key generates the sequence @samp{@key{ESC}Ow} and @samp{@key{ESC}O} is already
 bound to a function, pressing @key{KP7} when told to do so by
 @file{edt-mapper.el} will result in @file{edt-mapper.el} incorrectly
-mapping @samp{<ESC>O} to @key{KP7} and @samp{w} to @key{KP8}.  If
+mapping @samp{@key{ESC}O} to @key{KP7} and @samp{w} to @key{KP8}.  If
 something like this happens to you, it is probably a bug in the support
 for your keyboard within Emacs @strong{or} a bug in the Unix
 termcap/terminfo support for your terminal @strong{or} a bug in the
diff --git a/doc/misc/efaq-w32.texi b/doc/misc/efaq-w32.texi
index bf20c2291c..df75002bf2 100644
--- a/doc/misc/efaq-w32.texi
+++ b/doc/misc/efaq-w32.texi
@@ -309,7 +309,7 @@ file for build instructions.
 
 You can run Emacs without any extra steps, but if you want icons in your
 Start Menu, or for Emacs to detect the image libraries that are already
-installed on your system as part of GTK, then you should run the program
+installed on your system as part of GTK+, then you should run the program
 @file{addpm.exe}, which is usually installed into the same @file{bin}
 directory with @file{emacs.exe}.
 
@@ -899,7 +899,7 @@ The doc string contains a list of the system sounds you can use.
 @cindex font XLFD name format
 @cindex fontconfig font names in Emacs 23
 @cindex font dialog, using to find font names
-@findex w32-select-font
+@findex x-select-font
 @findex x-list-fonts
 
 Fonts in Emacs 22 and earlier are named using the X Logical Font
@@ -930,7 +930,7 @@ Fontconfig: Courier New-13
 To find the XFLD name for a font, you can execute the following in the
 @file{*scratch*} buffer by pressing C-j at the end of the line:
 @example
-(w32-select-font nil t)
+(x-select-font nil t)
 @end example
 
 To see a complete list of fonts, execute the following in the
@@ -1588,7 +1588,7 @@ non-@code{nil}, you should set it to @code{nil}:
 @cindex movemail, using pop3
 @cindex MAILHOST
 @vindex rmail-primary-inbox-list
-@vindex rmail-pop-password-required
+@vindex rmail-remote-password-required
 
 For incoming mail using the Rmail package and a POP3 server, you will
 need the following configuration:
@@ -1596,7 +1596,7 @@ need the following configuration:
 @example
 (setenv "MAILHOST" "@var{domain.name.of.your.pop3.server}")
 (setq rmail-primary-inbox-list '("po:@var{your logon id}"))
-(setq rmail-pop-password-required t)
+(setq rmail-remote-password-required t)
 @end example
 
 @node Incoming mail with Gnus
@@ -2199,10 +2199,10 @@ outdated.  Tools available here that are useful for Emacs include:
 @item GifLib - library to support GIF images.
 @item Grep - for searching through files with @code{grep}.
 @item Gzip - used by Emacs to automatically decompress .gz files.
-@item Jpeg - library to support JPEG images (also in GTK).
+@item Jpeg - library to support JPEG images (also in GTK+).
 @item Lha - used by @code{archive-mode} to edit .lzh files.
-@item LibPng - library to support PNG images (also in GTK).
-@item LibTiff - library to support TIFF images (also in GTK).
+@item LibPng - library to support PNG images (also in GTK+).
+@item LibTiff - library to support TIFF images (also in GTK+).
 @item Make - used by @code{compile} for building projects (also in MinGW)
 @item OpenSSL - used by @code{gnus} to talk to servers over SSL.
 @item Patch - used by @code{ediff-patch-file} and others to apply patches.
@@ -2211,21 +2211,21 @@ outdated.  Tools available here that are useful for Emacs include:
 @item Unzip - used by @code{archive-mode} for extracting zip files.
 @item Xpm - library to support XPM images (bundled with Emacs binaries)
 @item Zip - used by @code{archive-mode} for editing zip files.
-@item Zlib - required by LibPng (also in GTK).
+@item Zlib - required by LibPng (also in GTK+).
 @end itemize
 
 @node GTK
-@section GTK
-@cindex GTK image libraries
-@cindex image libraries, GTK
-@cindex addpm, using GTK image libraries
+@section GTK+
+@cindex GTK+ image libraries
+@cindex image libraries, GTK+
+@cindex addpm, using GTK+ image libraries
 
-GTK is a potential source for some of the image libraries that Emacs
-requires.  GTK is installed along with other ports of GUI software,
+GTK+ is a potential source for some of the image libraries that Emacs
+requires.  GTK+ is installed along with other ports of GUI software,
 such as the GIMP image editor, and Pidgin instant messenger client.
-If GTK is installed when you run @command{addpm}, Emacs will use the
+If GTK+ is installed when you run @command{addpm}, Emacs will use the
 image libraries that it provides, even if they are not on the
-@env{PATH}.  GTK ships with JPEG, PNG and TIFF support.
+@env{PATH}.  GTK+ ships with JPEG, PNG and TIFF support.
 
 @node Read man pages
 @section How do I read man pages?
diff --git a/doc/misc/efaq.texi b/doc/misc/efaq.texi
index 4d645ec6d4..b980e569fc 100644
--- a/doc/misc/efaq.texi
+++ b/doc/misc/efaq.texi
@@ -173,7 +173,7 @@ Key sequences longer than one key (and some single-key sequences) are
 written inside quotes or on lines by themselves, like this:
 
 @display
-  @kbd{M-x frobnicate-while-foo RET}
+  @kbd{M-x frobnicate-while-foo @key{RET}}
 @end display
 
 @noindent
@@ -201,7 +201,7 @@ Also, on very few keyboards does @kbd{C-?} generate @acronym{ASCII} code 127.
 @section What does @file{M-x @var{command}} mean?
 @cindex Extended commands
 @cindex Commands, extended
-@cindex M-x, meaning of
+@cindex @kbd{M-x}, meaning of
 
 @kbd{M-x @var{command}} means type @kbd{M-x}, then type the name of the
 command, then type @key{RET}.  (@xref{Basic keys}, if you're not sure
@@ -3756,9 +3756,9 @@ defines the @kbd{M-@key{TAB}} key sequence.
 
 @node Backspace invokes help
 @section Why does the @key{Backspace} key invoke help?
-@cindex Backspace key invokes help
-@cindex Help invoked by Backspace
-@cindex DEL key does not delete
+@cindex @key{Backspace} key invokes help
+@cindex Help invoked by @key{Backspace}
+@cindex @key{DEL} key does not delete
 
 The @key{Backspace} key (on most keyboards) generates @acronym{ASCII} code 8.
 @kbd{C-h} sends the same code.  In Emacs by default @kbd{C-h} invokes
@@ -4103,7 +4103,7 @@ This will disable the use of the extra keysyms systemwide, which may be
 undesirable if you actually intend to use them.
 
 @node SPC no longer completes file names
-@section Why doesn't SPC complete file names anymore?
+@section Why doesn't @key{SPC} complete file names anymore?
 @cindex @kbd{SPC} file name completion
 
 Starting with Emacs 22.1, @kbd{SPC} no longer completes file names in
@@ -4288,7 +4288,7 @@ fontset, or you can select it by setting the default font in your
 @file{~/.emacs}:
 
 @lisp
-  (set-default-font "fontset-bdf")
+  (set-frame-font "fontset-bdf")
 @end lisp
 
 
diff --git a/doc/misc/eieio.texi b/doc/misc/eieio.texi
index 16c341b887..689ff72b72 100644
--- a/doc/misc/eieio.texi
+++ b/doc/misc/eieio.texi
@@ -1263,13 +1263,13 @@ The @var{parent-instance} slot indicates the instance which is
 considered the parent of the current instance.  Default is @code{nil}.
 @end deftp
 
-@cindex clone
+@cindex @code{clone}
 To use this class, inherit from it with your own class.
 To make a new instance that inherits from and existing instance of your
 class, use the @code{clone} method with additional parameters
 to specify local values.
 
-@cindex slot-unbound
+@cindex @code{slot-unbound}
 The @code{eieio-instance-inheritor} class works by causing cloned
 objects to have all slots unbound.  This class' @code{slot-unbound}
 method will cause references to unbound slots to be redirected to the
@@ -1395,7 +1395,7 @@ with a minimum of effort.
 
 @deftp {Class} eieio-speedbar buttontype buttonface
 Enables base speedbar display for a class.
-@cindex speedbar-make-tag-line
+@cindex @code{speedbar-make-tag-line}
 The slot @var{buttontype} is any of the symbols allowed by the
 function @code{speedbar-make-tag-line} for the @var{exp-button-type}
 argument @xref{Extending,,,speedbar}.
diff --git a/doc/misc/emacs-mime.texi b/doc/misc/emacs-mime.texi
index 4fbb3e5673..2c607cc97c 100644
--- a/doc/misc/emacs-mime.texi
+++ b/doc/misc/emacs-mime.texi
@@ -179,18 +179,18 @@ Emacs source code.  This item works only in the groups matching
 @code{mm-uu-emacs-sources-regexp}.
 
 @item diff
-@vindex diff
+@findex diff
 @vindex mm-uu-diff-groups-regexp
 Patches.  This is intended for groups where diffs of committed files
 are automatically sent to.  It only works in groups matching
 @code{mm-uu-diff-groups-regexp}.
 
 @item verbatim-marks
-@cindex verbatim-marks
+@findex verbatim-marks
 Slrn-style verbatim marks.
 
 @item LaTeX
-@cindex LaTeX
+@findex LaTeX
 LaTeX documents.  It only works in groups matching
 @code{mm-uu-tex-groups-regexp}.
 
@@ -1093,7 +1093,7 @@ If non-@code{nil} a format=flowed article will be displayed flowed.
 @node Interface Functions
 @chapter Interface Functions
 @cindex interface functions
-@cindex mail-parse
+@cindex @code{mail-parse}
 
 The @code{mail-parse} library is an abstraction over the actual
 low-level libraries that are described in the next chapter.
diff --git a/doc/misc/epa.texi b/doc/misc/epa.texi
index 237617a524..d5dfe70760 100644
--- a/doc/misc/epa.texi
+++ b/doc/misc/epa.texi
@@ -281,22 +281,22 @@ The following keys are assigned.
 
 @table @kbd
 @item : d
-@kindex @kbd{: d}
+@kindex : d
 @findex epa-dired-do-decrypt
 Decrypt marked files.
 
 @item : v
-@kindex @kbd{: v}
+@kindex : v
 @findex epa-dired-do-verify
 Verify marked files.
 
 @item : s
-@kindex @kbd{: s}
+@kindex : s
 @findex epa-dired-do-sign
 Sign marked files.
 
 @item : e
-@kindex @kbd{: e}
+@kindex : e
 @findex epa-dired-do-encrypt
 Encrypt marked files.
 
@@ -322,26 +322,26 @@ interface.  Try @kbd{M-x customize-variable epa-global-mail-mode}.
 
 @table @kbd
 @item C-c C-e C-d and C-c C-e d
-@kindex @kbd{C-c C-e C-d}
-@kindex @kbd{C-c C-e d}
+@kindex C-c C-e C-d
+@kindex C-c C-e d
 @findex epa-mail-decrypt
 Decrypt OpenPGP armors in the current buffer.
 
 @item C-c C-e C-v and C-c C-e v
-@kindex @kbd{C-c C-e C-v}
-@kindex @kbd{C-c C-e v}
+@kindex C-c C-e C-v
+@kindex C-c C-e v
 @findex epa-mail-verify
 Verify OpenPGP cleartext signed messages in the current buffer.
 
 @item C-c C-e C-s and C-c C-e s
-@kindex @kbd{C-c C-e C-s}
-@kindex @kbd{C-c C-e s}
+@kindex C-c C-e C-s
+@kindex C-c C-e s
 @findex epa-mail-sign
 Compose a signed message from the current buffer.
 
 @item C-c C-e C-e and C-c C-e e
-@kindex @kbd{C-c C-e C-e}
-@kindex @kbd{C-c C-e e}
+@kindex C-c C-e C-e
+@kindex C-c C-e e
 @findex epa-mail-encrypt
 @vindex epa-mail-aliases
 Compose an encrypted message from the current buffer.
diff --git a/doc/misc/erc.texi b/doc/misc/erc.texi
index 466a4fc4b8..55556c5281 100644
--- a/doc/misc/erc.texi
+++ b/doc/misc/erc.texi
@@ -117,10 +117,11 @@ connect to.
 If you want to place ERC settings in their own file, you can place them
 in @file{~/.emacs.d/.ercrc.el}, creating it if necessary.
 
-If you would rather use the Customize interface to change how ERC works,
-do @kbd{M-x customize-group RET erc RET}.  In particular, ERC comes with
-lots of modules that may be enabled or disabled; to select which ones
-you want, do @kbd{M-x customize-variable RET erc-modules RET}.
+If you would rather use the Customize interface to change how ERC
+works, do @kbd{M-x customize-group @key{RET} erc @key{RET}}.  In
+particular, ERC comes with lots of modules that may be enabled or
+disabled; to select which ones you want, do @kbd{M-x
+customize-variable @key{RET} erc-modules @key{RET}}.
 
 @menu
 * Sample Session::              Example of connecting to the #emacs channel
@@ -269,14 +270,14 @@ This is a summary of keystrokes available in every ERC buffer.
 @item C-a or <home> (@code{erc-bol})
 Go to beginning of line or end of prompt.
 
-@item RET (@code{erc-send-current-line})
+@item @key{RET} (@code{erc-send-current-line})
 Send the current line
 
-@item TAB (@code{erc-complete-word})
+@item @key{TAB} (@code{erc-complete-word})
 If at prompt, complete the current word.
 Otherwise, move to the next link or button.
 
-@item M-TAB (@code{ispell-complete-word})
+@item M-@key{TAB} (@code{ispell-complete-word})
 Complete the given word, using ispell.
 
 @item C-c C-a (@code{erc-bol})
@@ -297,7 +298,7 @@ Toggle automatic CTCP replies (like VERSION and PING).
 @item C-c C-f (@code{erc-toggle-flood-control})
 Toggle use of flood control on sent messages.
 
-@item C-c TAB (@code{erc-invite-only-mode})
+@item C-c @key{TAB} (@code{erc-invite-only-mode})
 Turn on the invite only mode (+i) for the current channel.
 
 @item C-c C-j (@code{erc-join-channel})
@@ -349,8 +350,9 @@ One way to add functionality to ERC is to customize which of its many
 modules are loaded.
 
 There is a spiffy customize interface, which may be reached by typing
-@kbd{M-x customize-option erc-modules RET}.  Alternatively, set
-@code{erc-modules} manually and then call @code{erc-update-modules}.
+@kbd{M-x customize-option @key{RET} erc-modules @key{RET}}.
+Alternatively, set @code{erc-modules} manually and then call
+@code{erc-update-modules}.
 
 The following is a list of available modules.
 
@@ -743,7 +745,7 @@ stuff, to the current ERC buffer."
 
 This section is extremely incomplete.  For now, the easiest way to
 check out all the available options for ERC is to do
-@kbd{M-x customize-group erc RET}.
+@kbd{M-x customize-group @key{RET} erc @key{RET}}.
 
 @defopt erc-hide-list
 If non, @code{nil}, this is a list of IRC message types to hide, e.g.:
diff --git a/doc/misc/ert.texi b/doc/misc/ert.texi
index 3553560f49..82e0e27ed1 100644
--- a/doc/misc/ert.texi
+++ b/doc/misc/ert.texi
@@ -203,7 +203,7 @@ different Emacs versions.
 
 @findex ert
 You can run the tests that are currently defined in your Emacs with
-the command @kbd{@kbd{M-x} ert @kbd{RET} t @kbd{RET}}.  (For an
+the command @kbd{M-x ert @key{RET} t @key{RET}}.  (For an
 explanation of the @code{t} argument, @pxref{Test Selectors}.) ERT will pop
 up a new buffer, the ERT results buffer, showing the results of the
 tests run.  It looks like this:
@@ -262,9 +262,9 @@ for more details.
 
 @kindex TAB@r{, in ert results buffer}
 @kindex S-TAB@r{, in ert results buffer}
-In the ERT results buffer, @kbd{TAB} and @kbd{S-TAB} cycle between
+In the ERT results buffer, @kbd{@key{TAB}} and @kbd{S-@key{TAB}} cycle between
 buttons.  Each name of a function or macro in this buffer is a button;
-moving point to it and typing @kbd{RET} jumps to its definition.
+moving point to it and typing @kbd{@key{RET}} jumps to its definition.
 
 @kindex r@r{, in ert results buffer}
 @kindex d@r{, in ert results buffer}
@@ -273,7 +273,7 @@ moving point to it and typing @kbd{RET} jumps to its definition.
 @cindex backtrace of a failed test
 Pressing @kbd{r} re-runs the test near point on its own.  Pressing
 @kbd{d} re-runs it with the debugger enabled.  @kbd{.} jumps to the
-definition of the test near point (@kbd{RET} has the same effect if
+definition of the test near point (@kbd{@key{RET}} has the same effect if
 point is on the name of the test).  On a failed test, @kbd{b} shows
 the backtrace of the failure.
 
@@ -817,7 +817,7 @@ failed.  This can be useful to figure out how far it got.
 @item
 You can instrument tests for debugging the same way you instrument
 @code{defun}s for debugging: go to the source code of the test and
-type @kbd{@kbd{C-u} @kbd{C-M-x}}.  Then, go back to the ERT buffer and
+type @kbd{C-u C-M-x}.  Then, go back to the ERT buffer and
 re-run the test with @kbd{r} or @kbd{d}.
 
 @cindex discard obsolete test results
diff --git a/doc/misc/eshell.texi b/doc/misc/eshell.texi
index 1789767dbe..80077e5ccd 100644
--- a/doc/misc/eshell.texi
+++ b/doc/misc/eshell.texi
@@ -894,7 +894,7 @@ will happen as it should (albeit slowly).
 
 @item Make sure syntax table is correct in Eshell mode
 
-So that @kbd{M-DEL} acts in a predictable manner, etc.
+So that @kbd{M-@key{DEL}} acts in a predictable manner, etc.
 
 @item Allow all Eshell buffers to share the same history and list-dir
 
@@ -908,19 +908,19 @@ output from all subsequent commands is swallowed.
 Make it similar to the way that @file{esh-arg.el} is structured.
 Then add parsing of @samp{$[?\n]}.
 
-@item After pressing @kbd{M-RET}, redisplay before running the next command
+@item After pressing @kbd{M-@key{RET}}, redisplay before running the next command
 
 @item Argument predicates and modifiers should work anywhere in a path
 
 @example
-/usr/local/src/editors/vim $ vi **/CVS(/)/Root(.)
-Invalid regexp: "Unmatched ( or \\("
+/usr/local/src/editors/vim $ vi **/CVS(/)/Root(.)  Invalid regexp:
+"Unmatched ( or \\("
 @end example
 
 With @command{zsh}, the glob above expands to all files named
 @file{Root} in directories named @file{CVS}.
 
-@item Typing @samp{echo $@{locate locate@}/bin<TAB>} results in a Lisp error
+@item Typing @samp{echo $@{locate locate@}/bin@key{TAB}} results in a Lisp error
 
 Perhaps it should interpolate all permutations, and make that the
 globbing result, since otherwise hitting return here will result in
@@ -960,7 +960,7 @@ At the moment, this is not supported.
 An error should be generated only if @code{eshell-error-if-no-glob} is
 non-@code{nil}.
 
-@item @samp{(+ RET SPC TAB} does not cause @code{indent-according-to-mode} to occur
+@item @samp{(+ @key{RET} @key{SPC} @key{TAB}} does not cause @code{indent-according-to-mode} to occur
 
 @item Create @code{eshell-auto-accumulate-list}
 
@@ -1172,8 +1172,8 @@ only.  That way, it could be listed as a login shell.
 @item Make @kbd{/} electric
 
 So that it automatically expands and corrects pathnames.  Or make
-pathname completion for Pcomplete auto-expand @samp{/u/i/std<TAB>} to
-@samp{/usr/include/std<TAB>}.
+pathname completion for Pcomplete auto-expand @samp{/u/i/std@key{TAB}} to
+@samp{/usr/include/std@key{TAB}}.
 
 @item Write the @command{pushd} stack to disk along with @code{last-dir-ring}
 
@@ -1221,7 +1221,7 @@ If the first thing that I do after entering Emacs is to run
 @code{eshell-command} and invoke @command{ls}, and then use @kbd{M-x
 eshell}, it doesn't display anything.
 
-@item @kbd{M-RET} during a long command (using smart display) doesn't work
+@item @kbd{M-@key{RET}} during a long command (using smart display) doesn't work
 
 Since it keeps the cursor up where the command was invoked.
 
diff --git a/doc/misc/eww.texi b/doc/misc/eww.texi
index 258a2f2bff..43adc2eda0 100644
--- a/doc/misc/eww.texi
+++ b/doc/misc/eww.texi
@@ -99,7 +99,7 @@ web page hit @kbd{g} (@code{eww-reload}).  Pressing @kbd{w}
 
 @findex eww-open-in-new-buffer
 @kindex M-RET
-  The @kbd{M-RET} command (@code{eww-open-in-new-buffer}) opens the
+  The @kbd{M-@key{RET}} command (@code{eww-open-in-new-buffer}) opens the
 URL at point in a new EWW buffer, akin to opening a link in a new
 ``tab'' in other browsers.
 
diff --git a/doc/misc/forms.texi b/doc/misc/forms.texi
index 9857a67745..70463419e8 100644
--- a/doc/misc/forms.texi
+++ b/doc/misc/forms.texi
@@ -263,14 +263,14 @@ prompted for confirmation before the record is deleted unless a numeric
 argument has been provided.
 
 @findex forms-search-forward
-@kindex C-c C-s @var{regexp} @key{RET}
+@kindex C-c C-s @var{regexp} RET
 @item C-c C-s @var{regexp} @key{RET}
 Search forward for @var{regexp} in all records following this one
 (@code{forms-search-forward}).  If found, this record is shown.
 If you give an empty argument, the previous regexp is used again.
 
 @findex forms-search-backward
-@kindex C-c C-r @var{regexp} @key{RET}
+@kindex C-c C-r @var{regexp} RET
 @item C-c C-r @var{regexp} @key{RET}
 Search backward for @var{regexp} in all records following this one
 (@code{forms-search-backward}).  If found, this record is shown.
@@ -334,25 +334,25 @@ The following function key definitions are set up in Forms mode
 (whether read-only or not):
 
 @table @kbd
-@kindex next
-@item next
+@kindex NEXT
+@item @key{NEXT}
 forms-next-record
 
-@kindex prior
-@item prior
+@kindex PRIOR
+@item @key{PRIOR}
 forms-prev-record
 
-@kindex begin
-@item begin
+@kindex BEGIN
+@item @key{BEGIN}
 forms-first-record
 
-@kindex end
-@item end
+@kindex END
+@item @key{END}
 forms-last-record
 
-@kindex S-Tab
+@kindex S-TAB
 @findex forms-prev-field
-@item S-Tab
+@item S-@key{TAB}
 forms-prev-field
 @end table
 
diff --git a/doc/misc/gnus-faq.texi b/doc/misc/gnus-faq.texi
index 4175c88754..efef01f697 100644
--- a/doc/misc/gnus-faq.texi
+++ b/doc/misc/gnus-faq.texi
@@ -397,7 +397,7 @@ The ~/ means the home directory where Gnus and Emacs look
 for the configuration files.  However, you don't really
 need to know what this means, it suffices that Emacs knows
 what it means :-) You can type
-@samp{C-x C-f ~/.gnus.el RET }
+@samp{C-x C-f ~/.gnus.el @key{RET}}
 (yes, with the forward slash, even on Windows), and
 Emacs will open the right file for you.  (It will most
 likely be new, and thus empty.)
@@ -422,7 +422,7 @@ possibility to set environment variables.  Create a new one with
 name HOME and value C:\myhome.  Rebooting is not necessary.
 
 Now to create @file{~/.gnus.el}, say
-@samp{C-x C-f ~/.gnus.el RET C-x C-s}.
+@samp{C-x C-f ~/.gnus.el @key{RET} C-x C-s}.
 in Emacs.
 
 @node FAQ 3-3
@@ -459,11 +459,11 @@ subscribe to a group.
 @subsubheading Answer
 
 If you know the name of the group say @samp{U
-name.of.group RET} in group buffer (use the
+name.of.group @key{RET}} in group buffer (use the
 tab-completion Luke). Otherwise hit ^ in group buffer,
 this brings you to the server buffer. Now place point (the
 cursor) over the server which carries the group you want,
-hit @samp{RET}, move point to the group
+hit @samp{@key{RET}}, move point to the group
 you want to subscribe to and say @samp{u}
 to subscribe to it.
 
@@ -753,11 +753,11 @@ When I enter a group, all read messages are gone. How to view them again?
 @subsubheading Answer
 
 If you enter the group by saying
-@samp{RET}
+@samp{@key{RET}}
 in group buffer with point over the group, only unread and ticked messages are loaded. Say
-@samp{C-u RET}
+@samp{C-u @key{RET}}
 instead to load all available messages. If you want only the 300 newest say
-@samp{C-u 300 RET}
+@samp{C-u 300 @key{RET}}
 
 Loading only unread messages can be annoying if you have threaded view enabled, say
 
@@ -1019,7 +1019,7 @@ back ends. Gnus thinks ``highest-article-number @minus{}
 lowest-article-number = total-number-of-articles''. This
 works OK for Usenet groups, but if you delete and move
 many messages in mail groups, this fails. To cure the
-symptom, enter the group via @samp{C-u RET}
+symptom, enter the group via @samp{C-u @key{RET}}
 (this makes Gnus get all messages), then
 hit @samp{M P b} to mark all messages and
 then say @samp{B m name.of.group} to move
@@ -1494,8 +1494,8 @@ place them in ~/.emacs:
 @end example
 @noindent
 
-Now you should be ready to go. Say @samp{M-x bbdb RET
-RET} to open a bbdb buffer showing all
+Now you should be ready to go. Say @samp{M-x bbdb @key{RET}
+@key{RET}} to open a bbdb buffer showing all
 entries. Say @samp{c} to create a new
 entry, @samp{b} to search your BBDB and
 @samp{C-o} to add a new field to an
@@ -1734,15 +1734,15 @@ world, you may find tools at
 
 Now you've got to import this mbox file into Gnus. To do
 this, create a nndoc group based on the mbox file by
-saying @samp{G f /path/file.mbox RET} in
+saying @samp{G f /path/file.mbox @key{RET}} in
 Group buffer. You now have read-only access to your
 mail. If you want to import the messages to your normal
 Gnus mail groups hierarchy, enter the nndoc group you've
-just created by saying @samp{C-u RET}
+just created by saying @samp{C-u @key{RET}}
 (thus making sure all messages are retrieved), mark all
 messages by saying @samp{M P b} and
 either copy them to the desired group by saying
-@samp{B c name.of.group RET} or send them
+@samp{B c name.of.group @key{RET}} or send them
 through nnmail-split-methods (respool them) by saying
 @samp{B r}.
 
@@ -1809,7 +1809,7 @@ a Usenet group the easiest solution is probably to ask
 @uref{http://groups.google.com, groups.google.com},
 if you found the posting there, tell Google to display
 the raw message, look for the message-id, and say
-@samp{M-^ the@@message.id RET} in a
+@samp{M-^ the@@message.id @key{RET}} in a
 summary buffer.
 Since Gnus 5.10 there's also a Gnus interface for
 groups.google.com which you can call with
@@ -1853,7 +1853,7 @@ How to get rid of old unwanted mail?
 
 You can of course just mark the mail you don't need
 anymore by saying @samp{#} with point
-over the mail and then say @samp{B DEL}
+over the mail and then say @samp{B @key{DEL}}
 to get rid of them forever. You could also instead of
 actually deleting them, send them to a junk-group by
 saying @samp{B m nnml:trash-bin} which
@@ -2089,7 +2089,7 @@ How to find information and help inside Emacs?
 @subsubheading Answer
 
 The first stop should be the Gnus manual (Say
-@samp{C-h i d m Gnus RET} to start the
+@samp{C-h i d m Gnus @key{RET}} to start the
 Gnus manual, then walk through the menus or do a
 full-text search with @samp{s}). Then
 there are the general Emacs help commands starting with
@@ -2191,8 +2191,8 @@ The reason for this could be the way Gnus reads its
 active file, see the node "The Active File" in the Gnus
 manual for things you might try to speed the process up.
 An other idea would be to byte compile your @file{~/.gnus.el} (say
-@samp{M-x byte-compile-file RET ~/.gnus.el
-RET} to do it). Finally, if you have require
+@samp{M-x byte-compile-file @key{RET} ~/.gnus.el
+@key{RET}} to do it). Finally, if you have require
 statements in your .gnus, you could replace them with
 @code{with-eval-after-load}, which loads the stuff not at startup
 time, but when it's needed. Say you've got this in your
diff --git a/doc/misc/gnus-news.texi b/doc/misc/gnus-news.texi
index 91908584c9..171f59a3ad 100644
--- a/doc/misc/gnus-news.texi
+++ b/doc/misc/gnus-news.texi
@@ -324,7 +324,7 @@ messages are deleted again).
 @itemize @bullet
 
 @item The tool bar has been updated to use GNOME icons.
-You can also customize the tool bars: @kbd{M-x customize-apropos RET
+You can also customize the tool bars: @kbd{M-x customize-apropos @key{RET}
 -tool-bar$} should get you started.  (Only for Emacs, not in XEmacs.)
 @c FIXME: Document this in the manual
 
diff --git a/doc/misc/gnus.texi b/doc/misc/gnus.texi
index 17fbe0e3e3..cc4b2342be 100644
--- a/doc/misc/gnus.texi
+++ b/doc/misc/gnus.texi
@@ -959,7 +959,6 @@ Emacs for Heathens
 If you haven't used Emacs much before using Gnus, read @ref{Emacs for
 Heathens} first.
 
-@kindex M-x gnus
 @findex gnus
 If your system administrator has set things up properly, starting Gnus
 and reading news is extremely easy---you just type @kbd{M-x gnus} in
@@ -969,7 +968,6 @@ minimal setup for posting should also customize the variables
 @code{user-full-name} and @code{user-mail-address}.
 
 @findex gnus-other-frame
-@kindex M-x gnus-other-frame
 If you want to start Gnus in a different frame, you can use the command
 @kbd{M-x gnus-other-frame} instead.
 
@@ -1000,7 +998,7 @@ terminology section (@pxref{Terminology}).
 First of all, you should know that there is a special buffer called
 @file{*Server*} that lists all the servers Gnus knows about.  You can
 press @kbd{^} from the Group buffer to see it.  In the Server buffer,
-you can press @kbd{RET} on a defined server to see all the groups it
+you can press @kbd{@key{RET}} on a defined server to see all the groups it
 serves (subscribed or not!).  You can also add or delete servers, edit
 a foreign server's definition, agentize or de-agentize a server, and
 do many other neat things.  @xref{Server Buffer}.
@@ -1043,7 +1041,7 @@ If that fails as well, Gnus will try to use the machine running Emacs
 as an @acronym{NNTP} server.  That's a long shot, though.
 
 @findex gnus-group-browse-foreign-server
-@kindex B (Group)
+@kindex B @r{(Group)}
 However, if you use one @acronym{NNTP} server regularly and are just
 interested in a couple of groups from a different server, you would be
 better served by using the @kbd{B} command in the group buffer.  It will
@@ -1087,7 +1085,6 @@ groups, you'll find it difficult to actually do anything in the group
 buffer.  But, hey, that's your problem.  Blllrph!
 
 @findex gnus-no-server
-@kindex M-x gnus-no-server
 @c @head
 If you know that the server is definitely down, or you just want to read
 your mail without bothering with the server at all, you can use the
@@ -1354,13 +1351,11 @@ you have read is by keeping track of article numbers.  So when you
 change @code{gnus-select-method}, your @file{.newsrc} file becomes
 worthless.
 
-@kindex M-x gnus-group-clear-data-on-native-groups
 @findex gnus-group-clear-data-on-native-groups
 You can use the @kbd{M-x gnus-group-clear-data-on-native-groups}
 command to clear out all data that you have on your native groups.
 Use with caution.
 
-@kindex M-x gnus-group-clear-data
 @findex gnus-group-clear-data
 Clear the data from the current group only---nix out marks and the
 list of read articles (@code{gnus-group-clear-data}).
@@ -1704,7 +1699,7 @@ long as Gnus is active.
 @end menu
 
 You can customize the Group Mode tool bar, see @kbd{M-x
-customize-apropos RET gnus-group-tool-bar}.  This feature is only
+customize-apropos @key{RET} gnus-group-tool-bar}.  This feature is only
 available in Emacs.
 
 The tool bar icons are now (de)activated correctly depending on the
@@ -1989,37 +1984,37 @@ expected, hopefully.
 @table @kbd
 
 @item n
-@kindex n (Group)
+@kindex n @r{(Group)}
 @findex gnus-group-next-unread-group
 Go to the next group that has unread articles
 (@code{gnus-group-next-unread-group}).
 
 @item p
-@itemx DEL
-@kindex DEL (Group)
-@kindex p (Group)
+@itemx @key{DEL}
+@kindex DEL @r{(Group)}
+@kindex p @r{(Group)}
 @findex gnus-group-prev-unread-group
 Go to the previous group that has unread articles
 (@code{gnus-group-prev-unread-group}).
 
 @item N
-@kindex N (Group)
+@kindex N @r{(Group)}
 @findex gnus-group-next-group
 Go to the next group (@code{gnus-group-next-group}).
 
 @item P
-@kindex P (Group)
+@kindex P @r{(Group)}
 @findex gnus-group-prev-group
 Go to the previous group (@code{gnus-group-prev-group}).
 
 @item M-n
-@kindex M-n (Group)
+@kindex M-n @r{(Group)}
 @findex gnus-group-next-unread-group-same-level
 Go to the next unread group on the same (or lower) level
 (@code{gnus-group-next-unread-group-same-level}).
 
 @item M-p
-@kindex M-p (Group)
+@kindex M-p @r{(Group)}
 @findex gnus-group-prev-unread-group-same-level
 Go to the previous unread group on the same (or lower) level
 (@code{gnus-group-prev-unread-group-same-level}).
@@ -2030,20 +2025,20 @@ Three commands for jumping to groups:
 @table @kbd
 
 @item j
-@kindex j (Group)
+@kindex j @r{(Group)}
 @findex gnus-group-jump-to-group
 Jump to a group (and make it visible if it isn't already)
 (@code{gnus-group-jump-to-group}).  Killed groups can be jumped to, just
 like living groups.
 
 @item ,
-@kindex , (Group)
+@kindex , @r{(Group)}
 @findex gnus-group-best-unread-group
 Jump to the unread group with the lowest level
 (@code{gnus-group-best-unread-group}).
 
 @item .
-@kindex . (Group)
+@kindex . @r{(Group)}
 @findex gnus-group-first-unread-group
 Jump to the first group with unread articles
 (@code{gnus-group-first-unread-group}).
@@ -2067,8 +2062,8 @@ Otherwise, the point is set to the group just exited.  The default is
 
 @table @kbd
 
-@item SPACE
-@kindex SPACE (Group)
+@item @key{SPC}
+@kindex SPC @r{(Group)}
 @findex gnus-group-read-group
 Select the current group, switch to the summary buffer and display the
 first unread article (@code{gnus-group-read-group}).  If there are no
@@ -2079,16 +2074,16 @@ determines the number of articles Gnus will fetch.  If @var{n} is
 positive, Gnus fetches the @var{n} newest articles, if @var{n} is
 negative, Gnus fetches the @code{abs(@var{n})} oldest articles.
 
-Thus, @kbd{SPC} enters the group normally, @kbd{C-u SPC} offers old
-articles, @kbd{C-u 4 2 SPC} fetches the 42 newest articles, and @kbd{C-u
-- 4 2 SPC} fetches the 42 oldest ones.
+Thus, @kbd{@key{SPC}} enters the group normally, @kbd{C-u @key{SPC}}
+offers old articles, @kbd{C-u 4 2 @key{SPC}} fetches the 42 newest
+articles, and @kbd{C-u - 4 2 @key{SPC}} fetches the 42 oldest ones.
 
 When you are in the group (in the Summary buffer), you can type
 @kbd{M-g} to fetch new articles, or @kbd{C-u M-g} to also show the old
 ones.
 
-@item RET
-@kindex RET (Group)
+@item @key{RET}
+@kindex RET @r{(Group)}
 @findex gnus-group-select-group
 Select the current group and switch to the summary buffer
 (@code{gnus-group-select-group}).  Takes the same arguments as
@@ -2096,27 +2091,27 @@ Select the current group and switch to the summary buffer
 does not display the first unread article automatically upon group
 entry.
 
-@item M-RET
-@kindex M-RET (Group)
+@item M-@key{RET}
+@kindex M-RET @r{(Group)}
 @findex gnus-group-quick-select-group
 This does the same as the command above, but tries to do it with the
 minimum amount of fuzz (@code{gnus-group-quick-select-group}).  No
 scoring/killing will be performed, there will be no highlights and no
 expunging.  This might be useful if you're in a real hurry and have to
 enter some humongous group.  If you give a 0 prefix to this command
-(i.e., @kbd{0 M-RET}), Gnus won't even generate the summary buffer,
+(i.e., @kbd{0 M-@key{RET}}), Gnus won't even generate the summary buffer,
 which is useful if you want to toggle threading before generating the
 summary buffer (@pxref{Summary Generation Commands}).
 
-@item M-SPACE
-@kindex M-SPACE (Group)
+@item M-@key{SPC}
+@kindex M-SPC @r{(Group)}
 @findex gnus-group-visible-select-group
-This is yet one more command that does the same as the @kbd{RET}
+This is yet one more command that does the same as the @kbd{@key{RET}}
 command, but this one does it without expunging and hiding dormants
 (@code{gnus-group-visible-select-group}).
 
-@item C-M-RET
-@kindex C-M-RET (Group)
+@item C-M-@key{RET}
+@kindex C-M-RET @r{(Group)}
 @findex gnus-group-select-group-ephemerally
 Finally, this command selects the current group ephemerally without
 doing any processing of its contents
@@ -2164,7 +2159,7 @@ means Gnus never ignores old articles.
 @vindex gnus-auto-select-first
 @vindex gnus-auto-select-subject
 If @code{gnus-auto-select-first} is non-@code{nil}, select an article
-automatically when entering a group with the @kbd{SPACE} command.
+automatically when entering a group with the @kbd{@key{SPC}} command.
 Which article this is controlled by the
 @code{gnus-auto-select-subject} variable.  Valid values for this
 variable are:
@@ -2207,15 +2202,15 @@ selected.
 The following commands allow for managing your subscriptions in the
 Group buffer.  If you want to subscribe to many groups, it's probably
 more convenient to go to the @ref{Server Buffer}, and choose the
-server there using @kbd{RET} or @kbd{SPC}.  Then you'll have the
+server there using @kbd{@key{RET}} or @kbd{@key{SPC}}.  Then you'll have the
 commands listed in @ref{Browse Foreign Server} at hand.
 
 @table @kbd
 
 @item S t
 @itemx u
-@kindex S t (Group)
-@kindex u (Group)
+@kindex S t @r{(Group)}
+@kindex u @r{(Group)}
 @findex gnus-group-unsubscribe-current-group
 @c @icon{gnus-group-unsubscribe}
 Toggle subscription to the current group
@@ -2223,8 +2218,8 @@ Toggle subscription to the current group
 
 @item S s
 @itemx U
-@kindex S s (Group)
-@kindex U (Group)
+@kindex S s @r{(Group)}
+@kindex U @r{(Group)}
 @findex gnus-group-unsubscribe-group
 Prompt for a group to subscribe, and then subscribe it.  If it was
 subscribed already, unsubscribe it instead
@@ -2232,21 +2227,21 @@ subscribed already, unsubscribe it instead
 
 @item S k
 @itemx C-k
-@kindex S k (Group)
-@kindex C-k (Group)
+@kindex S k @r{(Group)}
+@kindex C-k @r{(Group)}
 @findex gnus-group-kill-group
 @c @icon{gnus-group-kill-group}
 Kill the current group (@code{gnus-group-kill-group}).
 
 @item S y
 @itemx C-y
-@kindex S y (Group)
-@kindex C-y (Group)
+@kindex S y @r{(Group)}
+@kindex C-y @r{(Group)}
 @findex gnus-group-yank-group
 Yank the last killed group (@code{gnus-group-yank-group}).
 
 @item C-x C-t
-@kindex C-x C-t (Group)
+@kindex C-x C-t @r{(Group)}
 @findex gnus-group-transpose-groups
 Transpose two groups (@code{gnus-group-transpose-groups}).  This isn't
 really a subscription command, but you can use it instead of a
@@ -2254,18 +2249,18 @@ kill-and-yank sequence sometimes.
 
 @item S w
 @itemx C-w
-@kindex S w (Group)
-@kindex C-w (Group)
+@kindex S w @r{(Group)}
+@kindex C-w @r{(Group)}
 @findex gnus-group-kill-region
 Kill all groups in the region (@code{gnus-group-kill-region}).
 
 @item S z
-@kindex S z (Group)
+@kindex S z @r{(Group)}
 @findex gnus-group-kill-all-zombies
 Kill all zombie groups (@code{gnus-group-kill-all-zombies}).
 
 @item S C-k
-@kindex S C-k (Group)
+@kindex S C-k @r{(Group)}
 @findex gnus-group-kill-level
 Kill all groups on a certain level (@code{gnus-group-kill-level}).
 These groups can't be yanked back after killing, so this command should
@@ -2286,7 +2281,7 @@ Also @pxref{Group Levels}.
 @table @kbd
 
 @item c
-@kindex c (Group)
+@kindex c @r{(Group)}
 @findex gnus-group-catchup-current
 @vindex gnus-group-catchup-group-hook
 @c @icon{gnus-group-catchup-current}
@@ -2296,19 +2291,18 @@ Mark all unticked articles in this group as read
 the group buffer.
 
 @item C
-@kindex C (Group)
+@kindex C @r{(Group)}
 @findex gnus-group-catchup-current-all
 Mark all articles in this group, even the ticked ones, as read
 (@code{gnus-group-catchup-current-all}).
 
 @item M-c
-@kindex M-c (Group)
+@kindex M-c @r{(Group)}
 @findex gnus-group-clear-data
 Clear the data from the current group---nix out marks and the list of
 read articles (@code{gnus-group-clear-data}).
 
 @item M-x gnus-group-clear-data-on-native-groups
-@kindex M-x gnus-group-clear-data-on-native-groups
 @findex gnus-group-clear-data-on-native-groups
 If you have switched from one @acronym{NNTP} server to another, all your marks
 and read ranges have become worthless.  You can use this command to
@@ -2334,7 +2328,7 @@ Remember:  The higher the level of the group, the less important it is.
 @table @kbd
 
 @item S l
-@kindex S l (Group)
+@kindex S l @r{(Group)}
 @findex gnus-group-set-current-level
 Set the level of the current group.  If a numeric prefix is given, the
 next @var{n} groups will have their levels set.  The user will be
@@ -2478,37 +2472,37 @@ with the process mark and then execute the command.
 @table @kbd
 
 @item #
-@kindex # (Group)
+@kindex # @r{(Group)}
 @itemx M m
-@kindex M m (Group)
+@kindex M m @r{(Group)}
 @findex gnus-group-mark-group
 Set the mark on the current group (@code{gnus-group-mark-group}).
 
 @item M-#
-@kindex M-# (Group)
+@kindex M-# @r{(Group)}
 @itemx M u
-@kindex M u (Group)
+@kindex M u @r{(Group)}
 @findex gnus-group-unmark-group
 Remove the mark from the current group
 (@code{gnus-group-unmark-group}).
 
 @item M U
-@kindex M U (Group)
+@kindex M U @r{(Group)}
 @findex gnus-group-unmark-all-groups
 Remove the mark from all groups (@code{gnus-group-unmark-all-groups}).
 
 @item M w
-@kindex M w (Group)
+@kindex M w @r{(Group)}
 @findex gnus-group-mark-region
 Mark all groups between point and mark (@code{gnus-group-mark-region}).
 
 @item M b
-@kindex M b (Group)
+@kindex M b @r{(Group)}
 @findex gnus-group-mark-buffer
 Mark all groups in the buffer (@code{gnus-group-mark-buffer}).
 
 @item M r
-@kindex M r (Group)
+@kindex M r @r{(Group)}
 @findex gnus-group-mark-regexp
 Mark all groups that match some regular expression
 (@code{gnus-group-mark-regexp}).
@@ -2549,7 +2543,7 @@ variable @code{gnus-parameters}, @xref{Group Parameters}.
 @table @kbd
 
 @item G m
-@kindex G m (Group)
+@kindex G m @r{(Group)}
 @findex gnus-group-make-group
 @cindex making groups
 Make a new group (@code{gnus-group-make-group}).  Gnus will prompt you
@@ -2557,13 +2551,13 @@ for a name, a method and possibly an @dfn{address}.  For an easier way
 to subscribe to @acronym{NNTP} groups (@pxref{Browse Foreign Server}).
 
 @item G M
-@kindex G M (Group)
+@kindex G M @r{(Group)}
 @findex gnus-group-read-ephemeral-group
 Make an ephemeral group (@code{gnus-group-read-ephemeral-group}).  Gnus
 will prompt you for a name, a method and an @dfn{address}.
 
 @item G r
-@kindex G r (Group)
+@kindex G r @r{(Group)}
 @findex gnus-group-rename-group
 @cindex renaming groups
 Rename the current group to something else
@@ -2572,45 +2566,45 @@ groups---mail groups mostly.  This command might very well be quite slow
 on some back ends.
 
 @item G c
-@kindex G c (Group)
+@kindex G c @r{(Group)}
 @cindex customizing
 @findex gnus-group-customize
 Customize the group parameters (@code{gnus-group-customize}).
 
 @item G e
-@kindex G e (Group)
+@kindex G e @r{(Group)}
 @findex gnus-group-edit-group-method
 @cindex renaming groups
 Enter a buffer where you can edit the select method of the current
 group (@code{gnus-group-edit-group-method}).
 
 @item G p
-@kindex G p (Group)
+@kindex G p @r{(Group)}
 @findex gnus-group-edit-group-parameters
 Enter a buffer where you can edit the group parameters
 (@code{gnus-group-edit-group-parameters}).
 
 @item G E
-@kindex G E (Group)
+@kindex G E @r{(Group)}
 @findex gnus-group-edit-group
 Enter a buffer where you can edit the group info
 (@code{gnus-group-edit-group}).
 
 @item G d
-@kindex G d (Group)
+@kindex G d @r{(Group)}
 @findex gnus-group-make-directory-group
 @cindex nndir
 Make a directory group (@pxref{Directory Groups}).  You will be prompted
 for the directory's name (@code{gnus-group-make-directory-group}).
 
 @item G h
-@kindex G h (Group)
+@kindex G h @r{(Group)}
 @cindex help group
 @findex gnus-group-make-help-group
 Make the Gnus help group (@code{gnus-group-make-help-group}).
 
 @item G D
-@kindex G D (Group)
+@kindex G D @r{(Group)}
 @findex gnus-group-enter-directory
 @cindex nneething
 Read an arbitrary directory as if it were a newsgroup with the
@@ -2618,7 +2612,7 @@ Read an arbitrary directory as if it were a newsgroup with the
 @xref{Anything Groups}.
 
 @item G f
-@kindex G f (Group)
+@kindex G f @r{(Group)}
 @findex gnus-group-make-doc-group
 @cindex ClariNet Briefs
 @cindex nndoc
@@ -2634,14 +2628,14 @@ you run this command without a prefix, Gnus will guess at the file
 type.  @xref{Document Groups}.
 
 @item G u
-@kindex G u (Group)
+@kindex G u @r{(Group)}
 @vindex gnus-useful-groups
 @findex gnus-group-make-useful-group
 Create one of the groups mentioned in @code{gnus-useful-groups}
 (@code{gnus-group-make-useful-group}).
 
 @item G w
-@kindex G w (Group)
+@kindex G w @r{(Group)}
 @findex gnus-group-make-web-group
 @cindex Google
 @cindex nnweb
@@ -2658,14 +2652,14 @@ to a particular group by using a match string like
 @samp{shaving group:alt.sysadmin.recovery}.
 
 @item G R
-@kindex G R (Group)
+@kindex G R @r{(Group)}
 @findex gnus-group-make-rss-group
 Make a group based on an @acronym{RSS} feed
 (@code{gnus-group-make-rss-group}).  You will be prompted for an URL@.
 @xref{RSS}.
 
-@item G DEL
-@kindex G DEL (Group)
+@item G @key{DEL}
+@kindex G DEL @r{(Group)}
 @findex gnus-group-delete-group
 This function will delete the current group
 (@code{gnus-group-delete-group}).  If given a prefix, this function will
@@ -2675,13 +2669,13 @@ absolutely sure of what you are doing.  This command can't be used on
 read-only groups (like @code{nntp} groups), though.
 
 @item G V
-@kindex G V (Group)
+@kindex G V @r{(Group)}
 @findex gnus-group-make-empty-virtual
 Make a new, fresh, empty @code{nnvirtual} group
 (@code{gnus-group-make-empty-virtual}).  @xref{Virtual Groups}.
 
 @item G v
-@kindex G v (Group)
+@kindex G v @r{(Group)}
 @findex gnus-group-add-to-virtual
 Add the current group to an @code{nnvirtual} group
 (@code{gnus-group-add-to-virtual}).  Uses the process/prefix convention.
@@ -3260,8 +3254,8 @@ These commands all list various slices of the groups available.
 
 @item l
 @itemx A s
-@kindex A s (Group)
-@kindex l (Group)
+@kindex A s @r{(Group)}
+@kindex l @r{(Group)}
 @findex gnus-group-list-groups
 List all groups that have unread articles
 (@code{gnus-group-list-groups}).  If the numeric prefix is used, this
@@ -3272,8 +3266,8 @@ groups).
 
 @item L
 @itemx A u
-@kindex A u (Group)
-@kindex L (Group)
+@kindex A u @r{(Group)}
+@kindex L @r{(Group)}
 @findex gnus-group-list-all-groups
 List all groups, whether they have unread articles or not
 (@code{gnus-group-list-all-groups}).  If the numeric prefix is used,
@@ -3282,14 +3276,14 @@ it lists groups of level seven or lower (i.e., just subscribed and
 unsubscribed groups).
 
 @item A l
-@kindex A l (Group)
+@kindex A l @r{(Group)}
 @findex gnus-group-list-level
 List all unread groups on a specific level
 (@code{gnus-group-list-level}).  If given a prefix, also list the groups
 with no unread articles.
 
 @item A k
-@kindex A k (Group)
+@kindex A k @r{(Group)}
 @findex gnus-group-list-killed
 List all killed groups (@code{gnus-group-list-killed}).  If given a
 prefix argument, really list all groups that are available, but aren't
@@ -3297,23 +3291,23 @@ currently (un)subscribed.  This could entail reading the active file
 from the server.
 
 @item A z
-@kindex A z (Group)
+@kindex A z @r{(Group)}
 @findex gnus-group-list-zombies
 List all zombie groups (@code{gnus-group-list-zombies}).
 
 @item A m
-@kindex A m (Group)
+@kindex A m @r{(Group)}
 @findex gnus-group-list-matching
 List all unread, subscribed groups with names that match a regexp
 (@code{gnus-group-list-matching}).
 
 @item A M
-@kindex A M (Group)
+@kindex A M @r{(Group)}
 @findex gnus-group-list-all-matching
 List groups that match a regexp (@code{gnus-group-list-all-matching}).
 
 @item A A
-@kindex A A (Group)
+@kindex A A @r{(Group)}
 @findex gnus-group-list-active
 List absolutely all groups in the active file(s) of the
 server(s) you are connected to (@code{gnus-group-list-active}).  This
@@ -3324,34 +3318,34 @@ don't exist (yet)---these will be listed as if they were killed groups.
 Take the output with some grains of salt.
 
 @item A a
-@kindex A a (Group)
+@kindex A a @r{(Group)}
 @findex gnus-group-apropos
 List all groups that have names that match a regexp
 (@code{gnus-group-apropos}).
 
 @item A d
-@kindex A d (Group)
+@kindex A d @r{(Group)}
 @findex gnus-group-description-apropos
 List all groups that have names or descriptions that match a regexp
 (@code{gnus-group-description-apropos}).
 
 @item A c
-@kindex A c (Group)
+@kindex A c @r{(Group)}
 @findex gnus-group-list-cached
 List all groups with cached articles (@code{gnus-group-list-cached}).
 
 @item A ?
-@kindex A ? (Group)
+@kindex A ? @r{(Group)}
 @findex gnus-group-list-dormant
 List all groups with dormant articles (@code{gnus-group-list-dormant}).
 
 @item A !
-@kindex A ! (Group)
+@kindex A ! @r{(Group)}
 @findex gnus-group-list-ticked
 List all groups with ticked articles (@code{gnus-group-list-ticked}).
 
 @item A /
-@kindex A / (Group)
+@kindex A / @r{(Group)}
 @findex gnus-group-list-limit
 Further limit groups within the current selection
 (@code{gnus-group-list-limit}).  If you've first limited to groups
@@ -3361,12 +3355,12 @@ giving you the groups that have both dormant articles and cached
 articles.
 
 @item A f
-@kindex A f (Group)
+@kindex A f @r{(Group)}
 @findex gnus-group-list-flush
 Flush groups from the current selection (@code{gnus-group-list-flush}).
 
 @item A p
-@kindex A p (Group)
+@kindex A p @r{(Group)}
 @findex gnus-group-list-plus
 List groups plus the current selection (@code{gnus-group-list-plus}).
 
@@ -3390,7 +3384,7 @@ groups.  It is @code{t} by default.
 @section Sorting Groups
 @cindex sorting groups
 
-@kindex C-c C-s (Group)
+@kindex C-c C-s @r{(Group)}
 @findex gnus-group-sort-groups
 @vindex gnus-group-sort-function
 The @kbd{C-c C-s} (@code{gnus-group-sort-groups}) command sorts the
@@ -3446,43 +3440,43 @@ some sorting criteria:
 
 @table @kbd
 @item G S a
-@kindex G S a (Group)
+@kindex G S a @r{(Group)}
 @findex gnus-group-sort-groups-by-alphabet
 Sort the group buffer alphabetically by group name
 (@code{gnus-group-sort-groups-by-alphabet}).
 
 @item G S u
-@kindex G S u (Group)
+@kindex G S u @r{(Group)}
 @findex gnus-group-sort-groups-by-unread
 Sort the group buffer by the number of unread articles
 (@code{gnus-group-sort-groups-by-unread}).
 
 @item G S l
-@kindex G S l (Group)
+@kindex G S l @r{(Group)}
 @findex gnus-group-sort-groups-by-level
 Sort the group buffer by group level
 (@code{gnus-group-sort-groups-by-level}).
 
 @item G S v
-@kindex G S v (Group)
+@kindex G S v @r{(Group)}
 @findex gnus-group-sort-groups-by-score
 Sort the group buffer by group score
 (@code{gnus-group-sort-groups-by-score}).  @xref{Group Score}.
 
 @item G S r
-@kindex G S r (Group)
+@kindex G S r @r{(Group)}
 @findex gnus-group-sort-groups-by-rank
 Sort the group buffer by group rank
 (@code{gnus-group-sort-groups-by-rank}).  @xref{Group Score}.
 
 @item G S m
-@kindex G S m (Group)
+@kindex G S m @r{(Group)}
 @findex gnus-group-sort-groups-by-method
 Sort the group buffer alphabetically by back end name@*
 (@code{gnus-group-sort-groups-by-method}).
 
 @item G S n
-@kindex G S n (Group)
+@kindex G S n @r{(Group)}
 @findex gnus-group-sort-groups-by-real-name
 Sort the group buffer alphabetically by real (unprefixed) group name
 (@code{gnus-group-sort-groups-by-real-name}).
@@ -3499,49 +3493,49 @@ You can also sort a subset of the groups:
 
 @table @kbd
 @item G P a
-@kindex G P a (Group)
+@kindex G P a @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-alphabet
 Sort the groups alphabetically by group name
 (@code{gnus-group-sort-selected-groups-by-alphabet}).
 
 @item G P u
-@kindex G P u (Group)
+@kindex G P u @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-unread
 Sort the groups by the number of unread articles
 (@code{gnus-group-sort-selected-groups-by-unread}).
 
 @item G P l
-@kindex G P l (Group)
+@kindex G P l @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-level
 Sort the groups by group level
 (@code{gnus-group-sort-selected-groups-by-level}).
 
 @item G P v
-@kindex G P v (Group)
+@kindex G P v @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-score
 Sort the groups by group score
 (@code{gnus-group-sort-selected-groups-by-score}).  @xref{Group Score}.
 
 @item G P r
-@kindex G P r (Group)
+@kindex G P r @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-rank
 Sort the groups by group rank
 (@code{gnus-group-sort-selected-groups-by-rank}).  @xref{Group Score}.
 
 @item G P m
-@kindex G P m (Group)
+@kindex G P m @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-method
 Sort the groups alphabetically by back end name@*
 (@code{gnus-group-sort-selected-groups-by-method}).
 
 @item G P n
-@kindex G P n (Group)
+@kindex G P n @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-real-name
 Sort the groups alphabetically by real (unprefixed) group name
 (@code{gnus-group-sort-selected-groups-by-real-name}).
 
 @item G P s
-@kindex G P s (Group)
+@kindex G P s @r{(Group)}
 @findex gnus-group-sort-selected-groups
 Sort the groups according to @code{gnus-group-sort-function}.
 
@@ -3557,13 +3551,13 @@ move groups around.
 
 @table @kbd
 @item b
-@kindex b (Group)
+@kindex b @r{(Group)}
 @findex gnus-group-check-bogus-groups
 Find bogus groups and delete them
 (@code{gnus-group-check-bogus-groups}).
 
 @item F
-@kindex F (Group)
+@kindex F @r{(Group)}
 @findex gnus-group-find-new-groups
 Find new groups and process them (@code{gnus-group-find-new-groups}).
 With 1 @kbd{C-u}, use the @code{ask-server} method to query the server
@@ -3572,7 +3566,7 @@ to query the server for new groups, and subscribe the new groups as
 zombies.
 
 @item C-c C-x
-@kindex C-c C-x (Group)
+@kindex C-c C-x @r{(Group)}
 @findex gnus-group-expire-articles
 @cindex expiring mail
 Run all expirable articles in the current group through the expiry
@@ -3581,7 +3575,7 @@ all expirable articles in the group that have been around for a while.
 (@pxref{Expiring Mail}).
 
 @item C-c C-M-x
-@kindex C-c C-M-x (Group)
+@kindex C-c C-M-x @r{(Group)}
 @findex gnus-group-expire-all-groups
 @cindex expiring mail
 Run all expirable articles in all groups through the expiry process
@@ -3597,7 +3591,7 @@ Run all expirable articles in all groups through the expiry process
 
 @table @kbd
 @item B
-@kindex B (Group)
+@kindex B @r{(Group)}
 @findex gnus-group-browse-foreign-server
 You will be queried for a select method and a server name.  Gnus will
 then attempt to contact this server and let you browse the groups there
@@ -3613,28 +3607,28 @@ Here's a list of keystrokes available in the browse mode:
 
 @table @kbd
 @item n
-@kindex n (Browse)
+@kindex n @r{(Browse)}
 @findex gnus-group-next-group
 Go to the next group (@code{gnus-group-next-group}).
 
 @item p
-@kindex p (Browse)
+@kindex p @r{(Browse)}
 @findex gnus-group-prev-group
 Go to the previous group (@code{gnus-group-prev-group}).
 
-@item SPACE
-@kindex SPACE (Browse)
+@item @key{SPC}
+@kindex SPC @r{(Browse)}
 @findex gnus-browse-read-group
 Enter the current group and display the first article
 (@code{gnus-browse-read-group}).
 
-@item RET
-@kindex RET (Browse)
+@item @key{RET}
+@kindex RET @r{(Browse)}
 @findex gnus-browse-select-group
 Enter the current group (@code{gnus-browse-select-group}).
 
 @item u
-@kindex u (Browse)
+@kindex u @r{(Browse)}
 @findex gnus-browse-unsubscribe-current-group
 @vindex gnus-browse-subscribe-newsgroup-method
 Unsubscribe to the current group, or, as will be the case here,
@@ -3645,24 +3639,24 @@ using the variable @code{gnus-browse-subscribe-newsgroup-method}.  See
 
 @item l
 @itemx q
-@kindex q (Browse)
-@kindex l (Browse)
+@kindex q @r{(Browse)}
+@kindex l @r{(Browse)}
 @findex gnus-browse-exit
 Exit browse mode (@code{gnus-browse-exit}).
 
 @item d
-@kindex d (Browse)
+@kindex d @r{(Browse)}
 @findex gnus-browse-describe-group
 Describe the current group (@code{gnus-browse-describe-group}).
 
 @item ?
-@kindex ? (Browse)
+@kindex ? @r{(Browse)}
 @findex gnus-browse-describe-briefly
 Describe browse mode briefly (well, there's not much to describe, is
 there) (@code{gnus-browse-describe-briefly}).
 
-@item DEL
-@kindex DEL (Browse)
+@item @key{DEL}
+@kindex DEL @r{(Browse)}
 @findex gnus-browse-delete-group
 This function will delete the current group
 (@code{gnus-browse-delete-group}).  If given a prefix, this function
@@ -3680,20 +3674,20 @@ Yes, Gnus is ex(c)iting.
 
 @table @kbd
 @item z
-@kindex z (Group)
+@kindex z @r{(Group)}
 @findex gnus-group-suspend
 Suspend Gnus (@code{gnus-group-suspend}).  This doesn't really exit Gnus,
 but it kills all buffers except the Group buffer.  I'm not sure why this
 is a gain, but then who am I to judge?
 
 @item q
-@kindex q (Group)
+@kindex q @r{(Group)}
 @findex gnus-group-exit
 @c @icon{gnus-group-exit}
 Quit Gnus (@code{gnus-group-exit}).
 
 @item Q
-@kindex Q (Group)
+@kindex Q @r{(Group)}
 @findex gnus-group-quit
 Quit Gnus without saving the @file{.newsrc} files (@code{gnus-group-quit}).
 The dribble file will be saved, though (@pxref{Auto Save}).
@@ -3752,7 +3746,7 @@ Gnus
 @end example
 
 @findex gnus-topic-mode
-@kindex t (Group)
+@kindex t @r{(Group)}
 To get this @emph{fab} functionality you simply turn on (ooh!) the
 @code{gnus-topic} minor mode---type @kbd{t} in the group buffer.  (This
 is a toggling command.)
@@ -3801,22 +3795,22 @@ the way you like.
 @table @kbd
 
 @item T n
-@kindex T n (Topic)
+@kindex T n @r{(Topic)}
 @findex gnus-topic-create-topic
 Prompt for a new topic name and create it
 (@code{gnus-topic-create-topic}).
 
-@item T TAB
-@itemx TAB
-@kindex T TAB (Topic)
-@kindex TAB (Topic)
+@item T @key{TAB}
+@itemx @key{TAB}
+@kindex T TAB @r{(Topic)}
+@kindex TAB @r{(Topic)}
 @findex gnus-topic-indent
 ``Indent'' the current topic so that it becomes a sub-topic of the
 previous topic (@code{gnus-topic-indent}).  If given a prefix,
 ``un-indent'' the topic instead.
 
-@item M-TAB
-@kindex M-TAB (Topic)
+@item M-@key{TAB}
+@kindex M-TAB @r{(Topic)}
 @findex gnus-topic-unindent
 ``Un-indent'' the current topic so that it becomes a sub-topic of the
 parent of its current parent (@code{gnus-topic-unindent}).
@@ -3831,13 +3825,13 @@ kill and yank rather than cut and paste.
 @table @kbd
 
 @item C-k
-@kindex C-k (Topic)
+@kindex C-k @r{(Topic)}
 @findex gnus-topic-kill-group
 Kill a group or topic (@code{gnus-topic-kill-group}).  All groups in the
 topic will be removed along with the topic.
 
 @item C-y
-@kindex C-y (Topic)
+@kindex C-y @r{(Topic)}
 @findex gnus-topic-yank-group
 Yank the previously killed group or topic
 (@code{gnus-topic-yank-group}).  Note that all topics will be yanked
@@ -3860,10 +3854,10 @@ key.
 
 @table @kbd
 
-@item RET
-@kindex RET (Topic)
+@item @key{RET}
+@kindex RET @r{(Topic)}
 @findex gnus-topic-select-group
-@itemx SPACE
+@itemx @key{SPC}
 Either select a group or fold a topic (@code{gnus-topic-select-group}).
 When you perform this command on a group, you'll enter the group, as
 usual.  When done on a topic line, the topic will be folded (if it was
@@ -3878,38 +3872,38 @@ Now for a list of other commands, in no particular order.
 @table @kbd
 
 @item T m
-@kindex T m (Topic)
+@kindex T m @r{(Topic)}
 @findex gnus-topic-move-group
 Move the current group to some other topic
 (@code{gnus-topic-move-group}).  This command uses the process/prefix
 convention (@pxref{Process/Prefix}).
 
 @item T j
-@kindex T j (Topic)
+@kindex T j @r{(Topic)}
 @findex gnus-topic-jump-to-topic
 Go to a topic (@code{gnus-topic-jump-to-topic}).
 
 @item T c
-@kindex T c (Topic)
+@kindex T c @r{(Topic)}
 @findex gnus-topic-copy-group
 Copy the current group to some other topic
 (@code{gnus-topic-copy-group}).  This command uses the process/prefix
 convention (@pxref{Process/Prefix}).
 
 @item T h
-@kindex T h (Topic)
+@kindex T h @r{(Topic)}
 @findex gnus-topic-hide-topic
 Hide the current topic (@code{gnus-topic-hide-topic}).  If given
 a prefix, hide the topic permanently.
 
 @item T s
-@kindex T s (Topic)
+@kindex T s @r{(Topic)}
 @findex gnus-topic-show-topic
 Show the current topic (@code{gnus-topic-show-topic}).  If given
 a prefix, show the topic permanently.
 
 @item T D
-@kindex T D (Topic)
+@kindex T D @r{(Topic)}
 @findex gnus-topic-remove-group
 Remove a group from the current topic (@code{gnus-topic-remove-group}).
 This command is mainly useful if you have the same group in several
@@ -3923,39 +3917,39 @@ This command uses the process/prefix convention
 (@pxref{Process/Prefix}).
 
 @item T M
-@kindex T M (Topic)
+@kindex T M @r{(Topic)}
 @findex gnus-topic-move-matching
 Move all groups that match some regular expression to a topic
 (@code{gnus-topic-move-matching}).
 
 @item T C
-@kindex T C (Topic)
+@kindex T C @r{(Topic)}
 @findex gnus-topic-copy-matching
 Copy all groups that match some regular expression to a topic
 (@code{gnus-topic-copy-matching}).
 
 @item T H
-@kindex T H (Topic)
+@kindex T H @r{(Topic)}
 @findex gnus-topic-toggle-display-empty-topics
 Toggle hiding empty topics
 (@code{gnus-topic-toggle-display-empty-topics}).
 
 @item T #
-@kindex T # (Topic)
+@kindex T # @r{(Topic)}
 @findex gnus-topic-mark-topic
 Mark all groups in the current topic with the process mark
 (@code{gnus-topic-mark-topic}).  This command works recursively on
 sub-topics unless given a prefix.
 
 @item T M-#
-@kindex T M-# (Topic)
+@kindex T M-# @r{(Topic)}
 @findex gnus-topic-unmark-topic
 Remove the process mark from all groups in the current topic
 (@code{gnus-topic-unmark-topic}).  This command works recursively on
 sub-topics unless given a prefix.
 
 @item C-c C-x
-@kindex C-c C-x (Topic)
+@kindex C-c C-x @r{(Topic)}
 @findex gnus-topic-expire-articles
 @cindex expiring mail
 Run all expirable articles in the current group or topic through the
@@ -3963,33 +3957,33 @@ expiry process (if any)
 (@code{gnus-topic-expire-articles}).  (@pxref{Expiring Mail}).
 
 @item T r
-@kindex T r (Topic)
+@kindex T r @r{(Topic)}
 @findex gnus-topic-rename
 Rename a topic (@code{gnus-topic-rename}).
 
-@item T DEL
-@kindex T DEL (Topic)
+@item T @key{DEL}
+@kindex T DEL @r{(Topic)}
 @findex gnus-topic-delete
 Delete an empty topic (@code{gnus-topic-delete}).
 
 @item A T
-@kindex A T (Topic)
+@kindex A T @r{(Topic)}
 @findex gnus-topic-list-active
 List all groups that Gnus knows about in a topics-ified way
 (@code{gnus-topic-list-active}).
 
 @item T M-n
-@kindex T M-n (Topic)
+@kindex T M-n @r{(Topic)}
 @findex gnus-topic-goto-next-topic
 Go to the next topic (@code{gnus-topic-goto-next-topic}).
 
 @item T M-p
-@kindex T M-p (Topic)
+@kindex T M-p @r{(Topic)}
 @findex gnus-topic-goto-previous-topic
 Go to the previous topic (@code{gnus-topic-goto-previous-topic}).
 
 @item G p
-@kindex G p (Topic)
+@kindex G p @r{(Topic)}
 @findex gnus-topic-edit-parameters
 @cindex group parameters
 @cindex topic parameters
@@ -4052,49 +4046,49 @@ commands:
 
 @table @kbd
 @item T S a
-@kindex T S a (Topic)
+@kindex T S a @r{(Topic)}
 @findex gnus-topic-sort-groups-by-alphabet
 Sort the current topic alphabetically by group name
 (@code{gnus-topic-sort-groups-by-alphabet}).
 
 @item T S u
-@kindex T S u (Topic)
+@kindex T S u @r{(Topic)}
 @findex gnus-topic-sort-groups-by-unread
 Sort the current topic by the number of unread articles
 (@code{gnus-topic-sort-groups-by-unread}).
 
 @item T S l
-@kindex T S l (Topic)
+@kindex T S l @r{(Topic)}
 @findex gnus-topic-sort-groups-by-level
 Sort the current topic by group level
 (@code{gnus-topic-sort-groups-by-level}).
 
 @item T S v
-@kindex T S v (Topic)
+@kindex T S v @r{(Topic)}
 @findex gnus-topic-sort-groups-by-score
 Sort the current topic by group score
 (@code{gnus-topic-sort-groups-by-score}).  @xref{Group Score}.
 
 @item T S r
-@kindex T S r (Topic)
+@kindex T S r @r{(Topic)}
 @findex gnus-topic-sort-groups-by-rank
 Sort the current topic by group rank
 (@code{gnus-topic-sort-groups-by-rank}).  @xref{Group Score}.
 
 @item T S m
-@kindex T S m (Topic)
+@kindex T S m @r{(Topic)}
 @findex gnus-topic-sort-groups-by-method
 Sort the current topic alphabetically by back end name
 (@code{gnus-topic-sort-groups-by-method}).
 
 @item T S e
-@kindex T S e (Topic)
+@kindex T S e @r{(Topic)}
 @findex gnus-topic-sort-groups-by-server
 Sort the current topic alphabetically by server name
 (@code{gnus-topic-sort-groups-by-server}).
 
 @item T S s
-@kindex T S s (Topic)
+@kindex T S s @r{(Topic)}
 @findex gnus-topic-sort-groups
 Sort the current topic according to the function(s) given by the
 @code{gnus-group-sort-function} variable
@@ -4369,7 +4363,7 @@ header will be displayed incorrectly in the article buffer.
 @table @kbd
 
 @item v
-@kindex v (Group)
+@kindex v @r{(Group)}
 @cindex keys, reserved for users (Group)
 The key @kbd{v} is reserved for users.  You can bind it to some
 command or better use it as a prefix key.  For example:
@@ -4385,13 +4379,13 @@ On keys reserved for users in Emacs and on keybindings in general
 @xref{Keymaps, Keymaps, , emacs, The Emacs Editor}.
 
 @item ^
-@kindex ^ (Group)
+@kindex ^ @r{(Group)}
 @findex gnus-group-enter-server-mode
 Enter the server buffer (@code{gnus-group-enter-server-mode}).
 @xref{Server Buffer}.
 
 @item a
-@kindex a (Group)
+@kindex a @r{(Group)}
 @findex gnus-group-post-news
 Start composing a message (a news by default)
 (@code{gnus-group-post-news}).  If given a prefix, post to the group
@@ -4401,7 +4395,7 @@ article might be a mail instead of a news, if a mail group is specified
 with the prefix argument.  @xref{Composing Messages}.
 
 @item m
-@kindex m (Group)
+@kindex m @r{(Group)}
 @findex gnus-group-mail
 Mail a message somewhere (@code{gnus-group-mail}).  If given a prefix,
 use the posting style of the group under the point.  If the prefix is 1,
@@ -4409,7 +4403,7 @@ prompt for a group name to find the posting style.
 @xref{Composing Messages}.
 
 @item i
-@kindex i (Group)
+@kindex i @r{(Group)}
 @findex gnus-group-news
 Start composing a news (@code{gnus-group-news}).  If given a prefix,
 post to the group under the point.  If the prefix is 1, prompt
@@ -4422,7 +4416,7 @@ in question.  The corresponding back end must have a request-post method
 for this to work though.
 
 @item G z
-@kindex G z (Group)
+@kindex G z @r{(Group)}
 @findex gnus-group-compact-group
 
 Compact the group under point (@code{gnus-group-compact-group}).
@@ -4467,7 +4461,7 @@ whether they are empty or not.
 @table @kbd
 
 @item g
-@kindex g (Group)
+@kindex g @r{(Group)}
 @findex gnus-group-get-new-news
 @c @icon{gnus-group-get-new-news}
 Check the server(s) for new articles.  If the numerical prefix is used,
@@ -4477,7 +4471,7 @@ command will force a total re-reading of the active file(s) from the
 back end(s).
 
 @item M-g
-@kindex M-g (Group)
+@kindex M-g @r{(Group)}
 @findex gnus-group-get-new-news-this-group
 @vindex gnus-goto-next-group-when-activating
 @c @icon{gnus-group-get-new-news-this-group}
@@ -4489,11 +4483,11 @@ to move point to the next group or not.  It is @code{t} by default.
 @findex gnus-activate-all-groups
 @cindex activating groups
 @item C-c M-g
-@kindex C-c M-g (Group)
+@kindex C-c M-g @r{(Group)}
 Activate absolutely all groups (@code{gnus-activate-all-groups}).
 
 @item R
-@kindex R (Group)
+@kindex R @r{(Group)}
 @cindex restarting
 @findex gnus-group-restart
 Restart Gnus (@code{gnus-group-restart}).  This saves the @file{.newsrc}
@@ -4521,8 +4515,8 @@ news.
 @item H d
 @itemx C-c C-d
 @c @icon{gnus-group-describe-group}
-@kindex H d (Group)
-@kindex C-c C-d (Group)
+@kindex H d @r{(Group)}
+@kindex C-c C-d @r{(Group)}
 @cindex describing groups
 @cindex group description
 @findex gnus-group-describe-group
@@ -4530,26 +4524,26 @@ Describe the current group (@code{gnus-group-describe-group}).  If given
 a prefix, force Gnus to re-read the description from the server.
 
 @item M-d
-@kindex M-d (Group)
+@kindex M-d @r{(Group)}
 @findex gnus-group-describe-all-groups
 Describe all groups (@code{gnus-group-describe-all-groups}).  If given a
 prefix, force Gnus to re-read the description file from the server.
 
 @item H v
 @itemx V
-@kindex V (Group)
-@kindex H v (Group)
+@kindex V @r{(Group)}
+@kindex H v @r{(Group)}
 @cindex version
 @findex gnus-version
 Display current Gnus version numbers (@code{gnus-version}).
 
 @item ?
-@kindex ? (Group)
+@kindex ? @r{(Group)}
 @findex gnus-group-describe-briefly
 Give a very short help message (@code{gnus-group-describe-briefly}).
 
 @item C-c C-i
-@kindex C-c C-i (Group)
+@kindex C-c C-i @r{(Group)}
 @cindex info
 @cindex manual
 @findex gnus-info-find-node
@@ -4623,7 +4617,7 @@ either.
 @table @kbd
 
 @item r
-@kindex r (Group)
+@kindex r @r{(Group)}
 @findex gnus-group-read-init-file
 @vindex gnus-init-file
 @cindex reading init file
@@ -4631,7 +4625,7 @@ Re-read the init file (@code{gnus-init-file}, which defaults to
 @file{~/.gnus.el}) (@code{gnus-group-read-init-file}).
 
 @item s
-@kindex s (Group)
+@kindex s @r{(Group)}
 @findex gnus-group-save-newsrc
 @cindex saving .newsrc
 Save the @file{.newsrc.eld} file (and @file{.newsrc} if wanted)
@@ -4639,7 +4633,7 @@ Save the @file{.newsrc.eld} file (and @file{.newsrc} if wanted)
 file(s) whether Gnus thinks it is necessary or not.
 
 @c @item Z
-@c @kindex Z (Group)
+@c @kindex Z @r{(Group)}
 @c @findex gnus-group-clear-dribble
 @c Clear the dribble buffer (@code{gnus-group-clear-dribble}).
 
@@ -4689,7 +4683,7 @@ if address "sender" "owner-ding@@hpc.uh.edu" @{
 @table @kbd
 
 @item D g
-@kindex D g (Group)
+@kindex D g @r{(Group)}
 @findex gnus-sieve-generate
 @vindex gnus-sieve-file
 @cindex generating sieve script
@@ -4697,7 +4691,7 @@ Regenerate a Sieve script from the @code{sieve} group parameters and
 put you into the @code{gnus-sieve-file} without saving it.
 
 @item D u
-@kindex D u (Group)
+@kindex D u @r{(Group)}
 @findex gnus-sieve-update
 @vindex gnus-sieve-file
 @cindex updating sieve script
@@ -4721,10 +4715,10 @@ group buffer (@pxref{Selecting a Group}).
 You can have as many summary buffers open as you wish.
 
 You can customize the Summary Mode tool bar, see @kbd{M-x
-customize-apropos RET gnus-summary-tool-bar}.  This feature is only
+customize-apropos @key{RET} gnus-summary-tool-bar}.  This feature is only
 available in Emacs.
 
-@kindex v (Summary)
+@kindex v @r{(Summary)}
 @cindex keys, reserved for users (Summary)
 The key @kbd{v} is reserved for users.  You can bind it to some
 command or better use it as a prefix key.  For example:
@@ -5204,22 +5198,22 @@ None of these commands select articles.
 @table @kbd
 @item G M-n
 @itemx M-n
-@kindex M-n (Summary)
-@kindex G M-n (Summary)
+@kindex M-n @r{(Summary)}
+@kindex G M-n @r{(Summary)}
 @findex gnus-summary-next-unread-subject
 Go to the next summary line of an unread article
 (@code{gnus-summary-next-unread-subject}).
 
 @item G M-p
 @itemx M-p
-@kindex M-p (Summary)
-@kindex G M-p (Summary)
+@kindex M-p @r{(Summary)}
+@kindex G M-p @r{(Summary)}
 @findex gnus-summary-prev-unread-subject
 Go to the previous summary line of an unread article
 (@code{gnus-summary-prev-unread-subject}).
 
 @item G g
-@kindex G g (Summary)
+@kindex G g @r{(Summary)}
 @findex gnus-summary-goto-subject
 Ask for an article number and then go to the summary line of that article
 without displaying the article (@code{gnus-summary-goto-subject}).
@@ -5281,7 +5275,7 @@ the given number of lines from the top.
 @item gnus-summary-stop-at-end-of-message
 @vindex gnus-summary-stop-at-end-of-message
 If non-@code{nil}, don't go to the next article when hitting
-@kbd{SPC}, and you're at the end of the article.
+@kbd{@key{SPC}}, and you're at the end of the article.
 
 @end table
 
@@ -5306,69 +5300,69 @@ If you want to fetch new articles or redisplay the group, see
 @ref{Exiting the Summary Buffer}.
 
 @table @kbd
-@item SPACE
-@kindex SPACE (Summary)
+@item @key{SPC}
+@kindex SPC @r{(Summary)}
 @findex gnus-summary-next-page
 Select the current article, or, if that one's read already, the next
 unread article (@code{gnus-summary-next-page}).
 
-If you have an article window open already and you press @kbd{SPACE}
+If you have an article window open already and you press @kbd{@key{SPC}}
 again, the article will be scrolled.  This lets you conveniently
-@kbd{SPACE} through an entire newsgroup.  @xref{Paging the Article}.
+@kbd{@key{SPC}} through an entire newsgroup.  @xref{Paging the Article}.
 
 @item G n
 @itemx n
-@kindex n (Summary)
-@kindex G n (Summary)
+@kindex n @r{(Summary)}
+@kindex G n @r{(Summary)}
 @findex gnus-summary-next-unread-article
 @c @icon{gnus-summary-next-unread}
 Go to next unread article (@code{gnus-summary-next-unread-article}).
 
 @item G p
 @itemx p
-@kindex p (Summary)
+@kindex p @r{(Summary)}
 @findex gnus-summary-prev-unread-article
 @c @icon{gnus-summary-prev-unread}
 Go to previous unread article (@code{gnus-summary-prev-unread-article}).
 
 @item G N
 @itemx N
-@kindex N (Summary)
-@kindex G N (Summary)
+@kindex N @r{(Summary)}
+@kindex G N @r{(Summary)}
 @findex gnus-summary-next-article
 Go to the next article (@code{gnus-summary-next-article}).
 
 @item G P
 @itemx P
-@kindex P (Summary)
-@kindex G P (Summary)
+@kindex P @r{(Summary)}
+@kindex G P @r{(Summary)}
 @findex gnus-summary-prev-article
 Go to the previous article (@code{gnus-summary-prev-article}).
 
 @item G C-n
-@kindex G C-n (Summary)
+@kindex G C-n @r{(Summary)}
 @findex gnus-summary-next-same-subject
 Go to the next article with the same subject
 (@code{gnus-summary-next-same-subject}).
 
 @item G C-p
-@kindex G C-p (Summary)
+@kindex G C-p @r{(Summary)}
 @findex gnus-summary-prev-same-subject
 Go to the previous article with the same subject
 (@code{gnus-summary-prev-same-subject}).
 
 @item G f
 @itemx .
-@kindex G f  (Summary)
-@kindex .  (Summary)
+@kindex G f  @r{(Summary)}
+@kindex .  @r{(Summary)}
 @findex gnus-summary-first-unread-article
 Go to the first unread article
 (@code{gnus-summary-first-unread-article}).
 
 @item G b
 @itemx ,
-@kindex G b (Summary)
-@kindex , (Summary)
+@kindex G b @r{(Summary)}
+@kindex , @r{(Summary)}
 @findex gnus-summary-best-unread-article
 Go to the unread article with the highest score
 (@code{gnus-summary-best-unread-article}).  If given a prefix argument,
@@ -5376,13 +5370,13 @@ go to the first unread article that has a score over the default score.
 
 @item G l
 @itemx l
-@kindex l (Summary)
-@kindex G l (Summary)
+@kindex l @r{(Summary)}
+@kindex G l @r{(Summary)}
 @findex gnus-summary-goto-last-article
 Go to the previous article read (@code{gnus-summary-goto-last-article}).
 
 @item G o
-@kindex G o (Summary)
+@kindex G o @r{(Summary)}
 @findex gnus-summary-pop-article
 @cindex history
 @cindex article history
@@ -5395,8 +5389,8 @@ For a somewhat related issue (if you use these commands a lot),
 
 @item G j
 @itemx j
-@kindex j (Summary)
-@kindex G j (Summary)
+@kindex j @r{(Summary)}
+@kindex G j @r{(Summary)}
 @findex gnus-summary-goto-article
 Ask for an article number or @code{Message-ID}, and then go to that
 article (@code{gnus-summary-goto-article}).
@@ -5448,10 +5442,10 @@ instead.  It will leave marks like @code{gnus-low-score-mark},
 
 @table @kbd
 
-@item SPACE
-@kindex SPACE (Summary)
+@item @key{SPC}
+@kindex SPC @r{(Summary)}
 @findex gnus-summary-next-page
-Pressing @kbd{SPACE} will scroll the current article forward one page,
+Pressing @kbd{@key{SPC}} will scroll the current article forward one page,
 or, if you have come to the end of the current article, will choose the
 next article (@code{gnus-summary-next-page}).
 
@@ -5464,27 +5458,27 @@ what is considered uninteresting with
 @code{gnus-article-boring-faces}.  You can manually view the article's
 pages, no matter how boring, using @kbd{C-M-v}.
 
-@item DEL
-@kindex DEL (Summary)
+@item @key{DEL}
+@kindex DEL @r{(Summary)}
 @findex gnus-summary-prev-page
 Scroll the current article back one page (@code{gnus-summary-prev-page}).
 
-@item RET
-@kindex RET (Summary)
+@item @key{RET}
+@kindex RET @r{(Summary)}
 @findex gnus-summary-scroll-up
 Scroll the current article one line forward
 (@code{gnus-summary-scroll-up}).
 
-@item M-RET
-@kindex M-RET (Summary)
+@item M-@key{RET}
+@kindex M-RET @r{(Summary)}
 @findex gnus-summary-scroll-down
 Scroll the current article one line backward
 (@code{gnus-summary-scroll-down}).
 
 @item A g
 @itemx g
-@kindex A g (Summary)
-@kindex g (Summary)
+@kindex A g @r{(Summary)}
+@kindex g @r{(Summary)}
 @findex gnus-summary-show-article
 @vindex gnus-summary-show-article-charset-alist
 (Re)fetch the current article (@code{gnus-summary-show-article}).  If
@@ -5495,7 +5489,7 @@ treatment functions.
 
 @cindex charset, view article with different charset
 If given a numerical prefix, you can do semi-manual charset stuff.
-@kbd{C-u 0 g cn-gb-2312 RET} will decode the message as if it were
+@kbd{C-u 0 g cn-gb-2312 @key{RET}} will decode the message as if it were
 encoded in the @code{cn-gb-2312} charset.  If you have
 
 @lisp
@@ -5508,29 +5502,29 @@ then you can say @kbd{C-u 1 g} to get the same effect.
 
 @item A <
 @itemx <
-@kindex < (Summary)
-@kindex A < (Summary)
+@kindex < @r{(Summary)}
+@kindex A < @r{(Summary)}
 @findex gnus-summary-beginning-of-article
 Scroll to the beginning of the article
 (@code{gnus-summary-beginning-of-article}).
 
 @item A >
 @itemx >
-@kindex > (Summary)
-@kindex A > (Summary)
+@kindex > @r{(Summary)}
+@kindex A > @r{(Summary)}
 @findex gnus-summary-end-of-article
 Scroll to the end of the article (@code{gnus-summary-end-of-article}).
 
 @item A s
 @itemx s
-@kindex A s (Summary)
-@kindex s (Summary)
+@kindex A s @r{(Summary)}
+@kindex s @r{(Summary)}
 @findex gnus-summary-isearch-article
 Perform an isearch in the article buffer
 (@code{gnus-summary-isearch-article}).
 
 @item h
-@kindex h (Summary)
+@kindex h @r{(Summary)}
 @findex gnus-summary-select-article-buffer
 Select the article buffer (@code{gnus-summary-select-article-buffer}).
 
@@ -5559,8 +5553,8 @@ Commands for composing a mail message:
 
 @item S r
 @itemx r
-@kindex S r (Summary)
-@kindex r (Summary)
+@kindex S r @r{(Summary)}
+@kindex r @r{(Summary)}
 @findex gnus-summary-reply
 @c @icon{gnus-summary-mail-reply}
 @c @icon{gnus-summary-reply}
@@ -5569,8 +5563,8 @@ Mail a reply to the author of the current article
 
 @item S R
 @itemx R
-@kindex R (Summary)
-@kindex S R (Summary)
+@kindex R @r{(Summary)}
+@kindex S R @r{(Summary)}
 @findex gnus-summary-reply-with-original
 @c @icon{gnus-summary-reply-with-original}
 Mail a reply to the author of the current article and include the
@@ -5578,7 +5572,7 @@ original message (@code{gnus-summary-reply-with-original}).  This
 command uses the process/prefix convention.
 
 @item S w
-@kindex S w (Summary)
+@kindex S w @r{(Summary)}
 @findex gnus-summary-wide-reply
 Mail a wide reply to the author of the current article
 (@code{gnus-summary-wide-reply}).  A @dfn{wide reply} is a reply that
@@ -5587,7 +5581,7 @@ goes out to all people listed in the @code{To}, @code{From} (or
 present, that's used instead.
 
 @item S W
-@kindex S W (Summary)
+@kindex S W @r{(Summary)}
 @findex gnus-summary-wide-reply-with-original
 Mail a wide reply to the current article and include the original
 message (@code{gnus-summary-wide-reply-with-original}).  This command uses
@@ -5595,14 +5589,14 @@ the process/prefix convention, but only uses the headers from the
 first article to determine the recipients.
 
 @item S L
-@kindex S L (Summary)
+@kindex S L @r{(Summary)}
 @findex gnus-summary-reply-to-list-with-original
 When replying to a message from a mailing list, send a reply to that
 message to the mailing list, and include the original message
 (@code{gnus-summary-reply-to-list-with-original}).
 
 @item S v
-@kindex S v (Summary)
+@kindex S v @r{(Summary)}
 @findex gnus-summary-very-wide-reply
 Mail a very wide reply to the author of the current article
 (@code{gnus-summary-wide-reply}).  A @dfn{very wide reply} is a reply
@@ -5611,14 +5605,14 @@ that goes out to all people listed in the @code{To}, @code{From} (or
 articles.  This command uses the process/prefix convention.
 
 @item S V
-@kindex S V (Summary)
+@kindex S V @r{(Summary)}
 @findex gnus-summary-very-wide-reply-with-original
 Mail a very wide reply to the author of the current article and include the
 original message (@code{gnus-summary-very-wide-reply-with-original}).  This
 command uses the process/prefix convention.
 
 @item S B r
-@kindex S B r (Summary)
+@kindex S B r @r{(Summary)}
 @findex gnus-summary-reply-broken-reply-to
 Mail a reply to the author of the current article but ignore the
 @code{Reply-To} field (@code{gnus-summary-reply-broken-reply-to}).
@@ -5628,7 +5622,7 @@ the @code{broken-reply-to} group parameter instead, so things will work
 correctly.  @xref{Group Parameters}.
 
 @item S B R
-@kindex S B R (Summary)
+@kindex S B R @r{(Summary)}
 @findex gnus-summary-reply-broken-reply-to-with-original
 Mail a reply to the author of the current article and include the
 original message but ignore the @code{Reply-To} field
@@ -5636,8 +5630,8 @@ original message but ignore the @code{Reply-To} field
 
 @item S o m
 @itemx C-c C-f
-@kindex S o m (Summary)
-@kindex C-c C-f (Summary)
+@kindex S o m @r{(Summary)}
+@kindex C-c C-f @r{(Summary)}
 @findex gnus-summary-mail-forward
 @c @icon{gnus-summary-mail-forward}
 Forward the current article to some other person
@@ -5654,8 +5648,8 @@ section.
 
 @item S m
 @itemx m
-@kindex m (Summary)
-@kindex S m (Summary)
+@kindex m @r{(Summary)}
+@kindex S m @r{(Summary)}
 @findex gnus-summary-mail-other-window
 @c @icon{gnus-summary-mail-originate}
 Prepare a mail (@code{gnus-summary-mail-other-window}).  By default, use
@@ -5663,7 +5657,7 @@ the posting style of the current group.  If given a prefix, disable that.
 If the prefix is 1, prompt for a group name to find the posting style.
 
 @item S i
-@kindex S i (Summary)
+@kindex S i @r{(Summary)}
 @findex gnus-summary-news-other-window
 Prepare a news (@code{gnus-summary-news-other-window}).  By default,
 post to the current group.  If given a prefix, disable that.  If the
@@ -5676,7 +5670,7 @@ in question.  The corresponding back end must have a request-post method
 for this to work though.
 
 @item S D b
-@kindex S D b (Summary)
+@kindex S D b @r{(Summary)}
 @findex gnus-summary-resend-bounced-mail
 @cindex bouncing mail
 If you have sent a mail, but the mail was bounced back to you for some
@@ -5689,7 +5683,7 @@ that mail and display it for easy perusal of its headers.  This might
 very well fail, though.
 
 @item S D r
-@kindex S D r (Summary)
+@kindex S D r @r{(Summary)}
 @findex gnus-summary-resend-message
 Not to be confused with the previous command,
 @code{gnus-summary-resend-message} will prompt you for an address to
@@ -5710,21 +5704,21 @@ This command understands the process/prefix convention
 (@pxref{Process/Prefix}).
 
 @item S D e
-@kindex S D e (Summary)
+@kindex S D e @r{(Summary)}
 @findex gnus-summary-resend-message-edit
 
 Like the previous command, but will allow you to edit the message as
 if it were a new message before resending.
 
 @item S O m
-@kindex S O m (Summary)
+@kindex S O m @r{(Summary)}
 @findex gnus-uu-digest-mail-forward
 Digest the current series (@pxref{Decoding Articles}) and forward the
 result using mail (@code{gnus-uu-digest-mail-forward}).  This command
 uses the process/prefix convention (@pxref{Process/Prefix}).
 
 @item S M-c
-@kindex S M-c (Summary)
+@kindex S M-c @r{(Summary)}
 @findex gnus-summary-mail-crosspost-complaint
 @cindex crossposting
 @cindex excessive crossposting
@@ -5754,8 +5748,8 @@ Commands for posting a news article:
 @table @kbd
 @item S p
 @itemx a
-@kindex a (Summary)
-@kindex S p (Summary)
+@kindex a @r{(Summary)}
+@kindex S p @r{(Summary)}
 @findex gnus-summary-post-news
 @c @icon{gnus-summary-post-news}
 Prepare for posting an article (@code{gnus-summary-post-news}).  By
@@ -5764,16 +5758,16 @@ If the prefix is 1, prompt for another group instead.
 
 @item S f
 @itemx f
-@kindex f (Summary)
-@kindex S f (Summary)
+@kindex f @r{(Summary)}
+@kindex S f @r{(Summary)}
 @findex gnus-summary-followup
 @c @icon{gnus-summary-followup}
 Post a followup to the current article (@code{gnus-summary-followup}).
 
 @item S F
 @itemx F
-@kindex S F (Summary)
-@kindex F (Summary)
+@kindex S F @r{(Summary)}
+@kindex F @r{(Summary)}
 @c @icon{gnus-summary-followup-with-original}
 @findex gnus-summary-followup-with-original
 Post a followup to the current article and include the original message
@@ -5781,13 +5775,13 @@ Post a followup to the current article and include the original message
 process/prefix convention.
 
 @item S n
-@kindex S n (Summary)
+@kindex S n @r{(Summary)}
 @findex gnus-summary-followup-to-mail
 Post a followup to the current article via news, even if you got the
 message through mail (@code{gnus-summary-followup-to-mail}).
 
 @item S N
-@kindex S N (Summary)
+@kindex S N @r{(Summary)}
 @findex gnus-summary-followup-to-mail-with-original
 Post a followup to the current article via news, even if you got the
 message through mail and include the original message
@@ -5795,7 +5789,7 @@ message through mail and include the original message
 the process/prefix convention.
 
 @item S o p
-@kindex S o p (Summary)
+@kindex S o p @r{(Summary)}
 @findex gnus-summary-post-forward
 Forward the current article to a newsgroup
 (@code{gnus-summary-post-forward}).
@@ -5810,7 +5804,7 @@ but use the flipped value of (@code{message-forward-as-mime}).  By
 default, the message is decoded and forwarded as an rfc822 @acronym{MIME} section.
 
 @item S O p
-@kindex S O p (Summary)
+@kindex S O p @r{(Summary)}
 @findex gnus-uu-digest-post-forward
 @cindex digests
 @cindex making digests
@@ -5819,7 +5813,7 @@ Digest the current series and forward the result to a newsgroup
 process/prefix convention.
 
 @item S u
-@kindex S u (Summary)
+@kindex S u @r{(Summary)}
 @findex gnus-uu-post-news
 @c @icon{gnus-uu-post-news}
 Uuencode a file, split it into parts, and post it as a series
@@ -5835,7 +5829,7 @@ Manual}, for more information.
 
 @table @kbd
 @item S y
-@kindex S y (Summary)
+@kindex S y @r{(Summary)}
 @findex gnus-summary-yank-message
 Yank the current article into an already existing Message composition
 buffer (@code{gnus-summary-yank-message}).  This command prompts for
@@ -5856,7 +5850,7 @@ really, really wish you hadn't posted that?
 Well, you can't cancel mail, but you can cancel posts.
 
 @findex gnus-summary-cancel-article
-@kindex C (Summary)
+@kindex C @r{(Summary)}
 @c @icon{gnus-summary-cancel-article}
 Find the article you wish to cancel (you can only cancel your own
 articles, so don't try any funny stuff).  Then press @kbd{C} or @kbd{S
@@ -5881,7 +5875,7 @@ corrections, you can post a @dfn{superseding} article that will replace
 your original article.
 
 @findex gnus-summary-supersede-article
-@kindex S (Summary)
+@kindex S @r{(Summary)}
 Go to the original article and press @kbd{S s}
 (@code{gnus-summary-supersede-article}).  You will be put in a buffer
 where you can edit the article all you want before sending it off the
@@ -6064,7 +6058,7 @@ followups, you can use the @kbd{/ D} command (@pxref{Limiting}).
 Otherwise (except for the visibility issue), they are just like ticked
 messages.
 
-@item SPACE
+@item @key{SPC}
 @vindex gnus-unread-mark
 Marked as unread (@code{gnus-unread-mark}).
 
@@ -6248,8 +6242,8 @@ All the marking commands understand the numeric prefix.
 @table @kbd
 @item M c
 @itemx M-u
-@kindex M c (Summary)
-@kindex M-u (Summary)
+@kindex M c @r{(Summary)}
+@kindex M-u @r{(Summary)}
 @findex gnus-summary-clear-mark-forward
 @cindex mark as unread
 Clear all readedness-marks from the current article
@@ -6258,38 +6252,38 @@ article as unread.
 
 @item M t
 @itemx !
-@kindex ! (Summary)
-@kindex M t (Summary)
+@kindex ! @r{(Summary)}
+@kindex M t @r{(Summary)}
 @findex gnus-summary-tick-article-forward
 Tick the current article (@code{gnus-summary-tick-article-forward}).
 @xref{Article Caching}.
 
 @item M ?
 @itemx ?
-@kindex ? (Summary)
-@kindex M ? (Summary)
+@kindex ? @r{(Summary)}
+@kindex M ? @r{(Summary)}
 @findex gnus-summary-mark-as-dormant
 Mark the current article as dormant
 (@code{gnus-summary-mark-as-dormant}).  @xref{Article Caching}.
 
 @item M d
 @itemx d
-@kindex M d (Summary)
-@kindex d (Summary)
+@kindex M d @r{(Summary)}
+@kindex d @r{(Summary)}
 @findex gnus-summary-mark-as-read-forward
 Mark the current article as read
 (@code{gnus-summary-mark-as-read-forward}).
 
 @item D
-@kindex D (Summary)
+@kindex D @r{(Summary)}
 @findex gnus-summary-mark-as-read-backward
 Mark the current article as read and move point to the previous line
 (@code{gnus-summary-mark-as-read-backward}).
 
 @item M k
 @itemx k
-@kindex k (Summary)
-@kindex M k (Summary)
+@kindex k @r{(Summary)}
+@kindex M k @r{(Summary)}
 @findex gnus-summary-kill-same-subject-and-select
 Mark all articles that have the same subject as the current one as read,
 and then select the next unread article
@@ -6297,82 +6291,82 @@ and then select the next unread article
 
 @item M K
 @itemx C-k
-@kindex M K (Summary)
-@kindex C-k (Summary)
+@kindex M K @r{(Summary)}
+@kindex C-k @r{(Summary)}
 @findex gnus-summary-kill-same-subject
 Mark all articles that have the same subject as the current one as read
 (@code{gnus-summary-kill-same-subject}).
 
 @item M C
-@kindex M C (Summary)
+@kindex M C @r{(Summary)}
 @findex gnus-summary-catchup
 @c @icon{gnus-summary-catchup}
 Mark all unread articles as read (@code{gnus-summary-catchup}).
 
 @item M C-c
-@kindex M C-c (Summary)
+@kindex M C-c @r{(Summary)}
 @findex gnus-summary-catchup-all
 Mark all articles in the group as read---even the ticked and dormant
 articles (@code{gnus-summary-catchup-all}).
 
 @item M H
-@kindex M H (Summary)
+@kindex M H @r{(Summary)}
 @findex gnus-summary-catchup-to-here
 Catchup the current group to point (before the point)
 (@code{gnus-summary-catchup-to-here}).
 
 @item M h
-@kindex M h (Summary)
+@kindex M h @r{(Summary)}
 @findex gnus-summary-catchup-from-here
 Catchup the current group from point (after the point)
 (@code{gnus-summary-catchup-from-here}).
 
 @item C-w
-@kindex C-w (Summary)
+@kindex C-w @r{(Summary)}
 @findex gnus-summary-mark-region-as-read
 Mark all articles between point and mark as read
 (@code{gnus-summary-mark-region-as-read}).
 
 @item M V k
-@kindex M V k (Summary)
+@kindex M V k @r{(Summary)}
 @findex gnus-summary-kill-below
 Kill all articles with scores below the default score (or below the
 numeric prefix) (@code{gnus-summary-kill-below}).
 
 @item M e
 @itemx E
-@kindex M e (Summary)
-@kindex E (Summary)
+@kindex M e @r{(Summary)}
+@kindex E @r{(Summary)}
 @findex gnus-summary-mark-as-expirable
 Mark the current article as expirable
 (@code{gnus-summary-mark-as-expirable}).
 
 @item M b
-@kindex M b (Summary)
+@kindex M b @r{(Summary)}
 @findex gnus-summary-set-bookmark
 Set a bookmark in the current article
 (@code{gnus-summary-set-bookmark}).
 
 @item M B
-@kindex M B (Summary)
+@kindex M B @r{(Summary)}
 @findex gnus-summary-remove-bookmark
 Remove the bookmark from the current article
 (@code{gnus-summary-remove-bookmark}).
 
 @item M V c
-@kindex M V c (Summary)
+@kindex M V c @r{(Summary)}
 @findex gnus-summary-clear-above
 Clear all marks from articles with scores over the default score (or
 over the numeric prefix) (@code{gnus-summary-clear-above}).
 
 @item M V u
-@kindex M V u (Summary)
+@kindex M V u @r{(Summary)}
 @findex gnus-summary-tick-above
 Tick all articles with scores over the default score (or over the
 numeric prefix) (@code{gnus-summary-tick-above}).
 
 @item M V m
-@kindex M V m (Summary)
+@kindex M V m @r{(Summary)}
 @findex gnus-summary-mark-above
 Prompt for a mark, and mark all articles with scores over the default
 score (or over the numeric prefix) with this mark
@@ -6385,7 +6379,7 @@ be taken after setting a mark.  If non-@code{nil}, point will move to
 the next/previous unread article.  If @code{nil}, point will just move
 one line up or down.  As a special case, if this variable is
 @code{never}, all the marking commands as well as other commands (like
-@kbd{SPACE}) will move to the next article, whether it is unread or not.
+@kbd{@key{SPC}}) will move to the next article, whether it is unread or not.
 The default is @code{t}.
 
 
@@ -6445,8 +6439,8 @@ articles into the cache.  For more information,
 
 @item M P p
 @itemx #
-@kindex # (Summary)
-@kindex M P p (Summary)
+@kindex # @r{(Summary)}
+@kindex M P p @r{(Summary)}
 @findex gnus-summary-mark-as-processable
 Mark the current article with the process mark
 (@code{gnus-summary-mark-as-processable}).
@@ -6454,99 +6448,99 @@ Mark the current article with the process mark
 
 @item M P u
 @itemx M-#
-@kindex M P u (Summary)
-@kindex M-# (Summary)
+@kindex M P u @r{(Summary)}
+@kindex M-# @r{(Summary)}
 Remove the process mark, if any, from the current article
 (@code{gnus-summary-unmark-as-processable}).
 
 @item M P U
-@kindex M P U (Summary)
+@kindex M P U @r{(Summary)}
 @findex gnus-summary-unmark-all-processable
 Remove the process mark from all articles
 (@code{gnus-summary-unmark-all-processable}).
 
 @item M P i
-@kindex M P i (Summary)
+@kindex M P i @r{(Summary)}
 @findex gnus-uu-invert-processable
 Invert the list of process marked articles
 (@code{gnus-uu-invert-processable}).
 
 @item M P R
-@kindex M P R (Summary)
+@kindex M P R @r{(Summary)}
 @findex gnus-uu-mark-by-regexp
 Mark articles that have a @code{Subject} header that matches a regular
 expression (@code{gnus-uu-mark-by-regexp}).
 
 @item M P G
-@kindex M P G (Summary)
+@kindex M P G @r{(Summary)}
 @findex gnus-uu-unmark-by-regexp
 Unmark articles that have a @code{Subject} header that matches a regular
 expression (@code{gnus-uu-unmark-by-regexp}).
 
 @item M P r
-@kindex M P r (Summary)
+@kindex M P r @r{(Summary)}
 @findex gnus-uu-mark-region
 Mark articles in region (@code{gnus-uu-mark-region}).
 
 @item M P g
-@kindex M P g (Summary)
+@kindex M P g @r{(Summary)}
 @findex gnus-uu-unmark-region
 Unmark articles in region (@code{gnus-uu-unmark-region}).
 
 @item M P t
-@kindex M P t (Summary)
+@kindex M P t @r{(Summary)}
 @findex gnus-uu-mark-thread
 Mark all articles in the current (sub)thread
 (@code{gnus-uu-mark-thread}).
 
 @item M P T
-@kindex M P T (Summary)
+@kindex M P T @r{(Summary)}
 @findex gnus-uu-unmark-thread
 Unmark all articles in the current (sub)thread
 (@code{gnus-uu-unmark-thread}).
 
 @item M P v
-@kindex M P v (Summary)
+@kindex M P v @r{(Summary)}
 @findex gnus-uu-mark-over
 Mark all articles that have a score above the prefix argument
 (@code{gnus-uu-mark-over}).
 
 @item M P s
-@kindex M P s (Summary)
+@kindex M P s @r{(Summary)}
 @findex gnus-uu-mark-series
 Mark all articles in the current series (@code{gnus-uu-mark-series}).
 
 @item M P S
-@kindex M P S (Summary)
+@kindex M P S @r{(Summary)}
 @findex gnus-uu-mark-sparse
 Mark all series that have already had some articles marked
 (@code{gnus-uu-mark-sparse}).
 
 @item M P a
-@kindex M P a (Summary)
+@kindex M P a @r{(Summary)}
 @findex gnus-uu-mark-all
 Mark all articles in series order (@code{gnus-uu-mark-all}).
 
 @item M P b
-@kindex M P b (Summary)
+@kindex M P b @r{(Summary)}
 @findex gnus-uu-mark-buffer
 Mark all articles in the buffer in the order they appear
 (@code{gnus-uu-mark-buffer}).
 
 @item M P k
-@kindex M P k (Summary)
+@kindex M P k @r{(Summary)}
 @findex gnus-summary-kill-process-mark
 Push the current process mark set onto the stack and unmark all articles
 (@code{gnus-summary-kill-process-mark}).
 
 @item M P y
-@kindex M P y (Summary)
+@kindex M P y @r{(Summary)}
 @findex gnus-summary-yank-process-mark
 Pop the previous process mark set from the stack and restore it
 (@code{gnus-summary-yank-process-mark}).
 
 @item M P w
-@kindex M P w (Summary)
+@kindex M P w @r{(Summary)}
 @findex gnus-summary-save-process-mark
 Push the current process mark set onto the stack
 (@code{gnus-summary-save-process-mark}).
@@ -6574,42 +6568,42 @@ articles.
 
 @item / /
 @itemx / s
-@kindex / / (Summary)
+@kindex / / @r{(Summary)}
 @findex gnus-summary-limit-to-subject
 Limit the summary buffer to articles that match some subject
 (@code{gnus-summary-limit-to-subject}).  If given a prefix, exclude
 matching articles.
 
 @item / a
-@kindex / a (Summary)
+@kindex / a @r{(Summary)}
 @findex gnus-summary-limit-to-author
 Limit the summary buffer to articles that match some author
 (@code{gnus-summary-limit-to-author}).  If given a prefix, exclude
 matching articles.
 
 @item / R
-@kindex / R (Summary)
+@kindex / R @r{(Summary)}
 @findex gnus-summary-limit-to-recipient
 Limit the summary buffer to articles that match some recipient
 (@code{gnus-summary-limit-to-recipient}).  If given a prefix, exclude
 matching articles.
 
 @item / A
-@kindex / A (Summary)
+@kindex / A @r{(Summary)}
 @findex gnus-summary-limit-to-address
 Limit the summary buffer to articles in which contents of From, To or Cc
 header match a given address (@code{gnus-summary-limit-to-address}).  If
 given a prefix, exclude matching articles.
 
 @item / S
-@kindex / S (Summary)
+@kindex / S @r{(Summary)}
 @findex gnus-summary-limit-to-singletons
 Limit the summary buffer to articles that aren't part of any displayed
 threads (@code{gnus-summary-limit-to-singletons}).  If given a prefix,
 limit to articles that are part of displayed threads.
 
 @item / x
-@kindex / x (Summary)
+@kindex / x @r{(Summary)}
 @findex gnus-summary-limit-to-extra
 Limit the summary buffer to articles that match one of the ``extra''
 headers (@pxref{To From Newsgroups})
@@ -6618,8 +6612,8 @@ matching articles.
 
 @item / u
 @itemx x
-@kindex / u (Summary)
-@kindex x (Summary)
+@kindex / u @r{(Summary)}
+@kindex x @r{(Summary)}
 @findex gnus-summary-limit-to-unread
 Limit the summary buffer to articles not marked as read
 (@code{gnus-summary-limit-to-unread}).  If given a prefix, limit the
@@ -6627,46 +6621,46 @@ buffer to articles strictly unread.  This means that ticked and
 dormant articles will also be excluded.
 
 @item / m
-@kindex / m (Summary)
+@kindex / m @r{(Summary)}
 @findex gnus-summary-limit-to-marks
 Ask for a mark and then limit to all articles that have been marked
 with that mark (@code{gnus-summary-limit-to-marks}).
 
 @item / t
-@kindex / t (Summary)
+@kindex / t @r{(Summary)}
 @findex gnus-summary-limit-to-age
 Ask for a number and then limit the summary buffer to articles older than (or equal to) that number of days
 (@code{gnus-summary-limit-to-age}).  If given a prefix, limit to
 articles younger than that number of days.
 
 @item / n
-@kindex / n (Summary)
+@kindex / n @r{(Summary)}
 @findex gnus-summary-limit-to-articles
 With prefix @samp{n}, limit the summary buffer to the next @samp{n}
 articles.  If not given a prefix, use the process marked articles
 instead.  (@code{gnus-summary-limit-to-articles}).
 
 @item / w
-@kindex / w (Summary)
+@kindex / w @r{(Summary)}
 @findex gnus-summary-pop-limit
 Pop the previous limit off the stack and restore it
 (@code{gnus-summary-pop-limit}).  If given a prefix, pop all limits off
 the stack.
 
 @item / .
-@kindex / . (Summary)
+@kindex / . @r{(Summary)}
 @findex gnus-summary-limit-to-unseen
 Limit the summary buffer to the unseen articles
 (@code{gnus-summary-limit-to-unseen}).
 
 @item / v
-@kindex / v (Summary)
+@kindex / v @r{(Summary)}
 @findex gnus-summary-limit-to-score
 Limit the summary buffer to articles that have a score at or above some
 score (@code{gnus-summary-limit-to-score}).
 
 @item / p
-@kindex / p (Summary)
+@kindex / p @r{(Summary)}
 @findex gnus-summary-limit-to-display-predicate
 Limit the summary buffer to articles that satisfy the @code{display}
 group parameter predicate
@@ -6674,7 +6668,7 @@ group parameter predicate
 Parameters}, for more on this predicate.
 
 @item / r
-@kindex / r (Summary)
+@kindex / r @r{(Summary)}
 @findex gnus-summary-limit-to-replied
 Limit the summary buffer to replied articles
 (@code{gnus-summary-limit-to-replied}).  If given a prefix, exclude
@@ -6682,55 +6676,55 @@ replied articles.
 
 @item / E
 @itemx M S
-@kindex M S (Summary)
-@kindex / E (Summary)
+@kindex M S @r{(Summary)}
+@kindex / E @r{(Summary)}
 @findex gnus-summary-limit-include-expunged
 Include all expunged articles in the limit
 (@code{gnus-summary-limit-include-expunged}).
 
 @item / D
-@kindex / D (Summary)
+@kindex / D @r{(Summary)}
 @findex gnus-summary-limit-include-dormant
 Include all dormant articles in the limit
 (@code{gnus-summary-limit-include-dormant}).
 
 @item / *
-@kindex / * (Summary)
+@kindex / * @r{(Summary)}
 @findex gnus-summary-limit-include-cached
 Include all cached articles in the limit
 (@code{gnus-summary-limit-include-cached}).
 
 @item / d
-@kindex / d (Summary)
+@kindex / d @r{(Summary)}
 @findex gnus-summary-limit-exclude-dormant
 Exclude all dormant articles from the limit
 (@code{gnus-summary-limit-exclude-dormant}).
 
 @item / M
-@kindex / M (Summary)
+@kindex / M @r{(Summary)}
 @findex gnus-summary-limit-exclude-marks
 Exclude all marked articles (@code{gnus-summary-limit-exclude-marks}).
 
 @item / T
-@kindex / T (Summary)
+@kindex / T @r{(Summary)}
 @findex gnus-summary-limit-include-thread
 Include all the articles in the current thread in the limit.
 
 @item / c
-@kindex / c (Summary)
+@kindex / c @r{(Summary)}
 @findex gnus-summary-limit-exclude-childless-dormant
 Exclude all dormant articles that have no children from the limit@*
 (@code{gnus-summary-limit-exclude-childless-dormant}).
 
 @item / C
-@kindex / C (Summary)
+@kindex / C @r{(Summary)}
 @findex gnus-summary-limit-mark-excluded-as-read
 Mark all excluded unread articles as read
 (@code{gnus-summary-limit-mark-excluded-as-read}).  If given a prefix,
 also mark excluded ticked and dormant articles as read.
 
 @item / b
-@kindex / b (Summary)
+@kindex / b @r{(Summary)}
 @findex gnus-summary-limit-to-bodies
 Limit the summary buffer to articles that have bodies that match a
 certain regexp (@code{gnus-summary-limit-to-bodies}).  If given a
@@ -6738,7 +6732,7 @@ prefix, reverse the limit.  This command is quite slow since it
 requires selecting each article to find the matches.
 
 @item / h
-@kindex / h (Summary)
+@kindex / h @r{(Summary)}
 @findex gnus-summary-limit-to-headers
 Like the previous command, only limit to headers instead
 (@code{gnus-summary-limit-to-headers}).
@@ -6751,13 +6745,13 @@ prefix as well.
 
 @table @kbd
 @item / N
-@kindex / N (Summary)
+@kindex / N @r{(Summary)}
 @findex gnus-summary-insert-new-articles
 Insert all new articles in the summary buffer.  It scans for new emails
 if @var{back-end}@code{-get-new-mail} is non-@code{nil}.
 
 @item / o
-@kindex / o (Summary)
+@kindex / o @r{(Summary)}
 @findex gnus-summary-insert-old-articles
 Insert all old articles in the summary buffer.  If given a numbered
 prefix, fetch this number of articles.
@@ -7043,7 +7037,7 @@ visible effects, but is useful if you use the @kbd{A T} command a lot
 
 The server has to support @acronym{NOV} for any of this to work.
 
-@cindex Gmane, gnus-fetch-old-headers
+@cindex Gmane, @code{gnus-fetch-old-headers}
 This feature can seriously impact performance it ignores all locally
 cached header entries.  Setting it to @code{t} for groups for a server
 that doesn't expire articles (such as news.gmane.org), leads to very
@@ -7197,8 +7191,8 @@ meaningful.  Here's one example:
 
 @item T k
 @itemx C-M-k
-@kindex T k (Summary)
-@kindex C-M-k (Summary)
+@kindex T k @r{(Summary)}
+@kindex C-M-k @r{(Summary)}
 @findex gnus-summary-kill-thread
 Mark all articles in the current (sub-)thread as read
 (@code{gnus-summary-kill-thread}).  If the prefix argument is positive,
@@ -7207,71 +7201,71 @@ articles instead.
 
 @item T l
 @itemx C-M-l
-@kindex T l (Summary)
-@kindex C-M-l (Summary)
+@kindex T l @r{(Summary)}
+@kindex C-M-l @r{(Summary)}
 @findex gnus-summary-lower-thread
 Lower the score of the current (sub-)thread
 (@code{gnus-summary-lower-thread}).
 
 @item T i
-@kindex T i (Summary)
+@kindex T i @r{(Summary)}
 @findex gnus-summary-raise-thread
 Increase the score of the current (sub-)thread
 (@code{gnus-summary-raise-thread}).
 
 @item T #
-@kindex T # (Summary)
+@kindex T # @r{(Summary)}
 @findex gnus-uu-mark-thread
 Set the process mark on the current (sub-)thread
 (@code{gnus-uu-mark-thread}).
 
 @item T M-#
-@kindex T M-# (Summary)
+@kindex T M-# @r{(Summary)}
 @findex gnus-uu-unmark-thread
 Remove the process mark from the current (sub-)thread
 (@code{gnus-uu-unmark-thread}).
 
 @item T T
-@kindex T T (Summary)
+@kindex T T @r{(Summary)}
 @findex gnus-summary-toggle-threads
 Toggle threading (@code{gnus-summary-toggle-threads}).
 
 @item T s
-@kindex T s (Summary)
+@kindex T s @r{(Summary)}
 @findex gnus-summary-show-thread
 Expose the (sub-)thread hidden under the current article, if any@*
 (@code{gnus-summary-show-thread}).
 
 @item T h
-@kindex T h (Summary)
+@kindex T h @r{(Summary)}
 @findex gnus-summary-hide-thread
 Hide the current (sub-)thread (@code{gnus-summary-hide-thread}).
 
 @item T S
-@kindex T S (Summary)
+@kindex T S @r{(Summary)}
 @findex gnus-summary-show-all-threads
 Expose all hidden threads (@code{gnus-summary-show-all-threads}).
 
 @item T H
-@kindex T H (Summary)
+@kindex T H @r{(Summary)}
 @findex gnus-summary-hide-all-threads
 Hide all threads (@code{gnus-summary-hide-all-threads}).
 
 @item T t
-@kindex T t (Summary)
+@kindex T t @r{(Summary)}
 @findex gnus-summary-rethread-current
 Re-thread the current article's thread
 (@code{gnus-summary-rethread-current}).  This works even when the
 summary buffer is otherwise unthreaded.
 
 @item T ^
-@kindex T ^ (Summary)
+@kindex T ^ @r{(Summary)}
 @findex gnus-summary-reparent-thread
 Make the current article the child of the marked (or previous) article
 (@code{gnus-summary-reparent-thread}).
 
 @item T M-^
-@kindex T M-^ (Summary)
+@kindex T M-^ @r{(Summary)}
 @findex gnus-summary-reparent-children
 Make the current article the parent of the marked articles
 (@code{gnus-summary-reparent-children}).
@@ -7284,35 +7278,35 @@ understand the numeric prefix.
 @table @kbd
 
 @item T n
-@kindex T n (Summary)
+@kindex T n @r{(Summary)}
 @itemx C-M-f
-@kindex C-M-n (Summary)
-@itemx M-down
-@kindex M-down (Summary)
+@kindex C-M-n @r{(Summary)}
+@itemx M-@key{DOWN}
+@kindex M-DOWN @r{(Summary)}
 @findex gnus-summary-next-thread
 Go to the next thread (@code{gnus-summary-next-thread}).
 
 @item T p
-@kindex T p (Summary)
+@kindex T p @r{(Summary)}
 @itemx C-M-b
-@kindex C-M-p (Summary)
-@itemx M-up
-@kindex M-up (Summary)
+@kindex C-M-p @r{(Summary)}
+@itemx M-@key{UP}
+@kindex M-UP @r{(Summary)}
 @findex gnus-summary-prev-thread
 Go to the previous thread (@code{gnus-summary-prev-thread}).
 
 @item T d
-@kindex T d (Summary)
+@kindex T d @r{(Summary)}
 @findex gnus-summary-down-thread
 Descend the thread (@code{gnus-summary-down-thread}).
 
 @item T u
-@kindex T u (Summary)
+@kindex T u @r{(Summary)}
 @findex gnus-summary-up-thread
 Ascend the thread (@code{gnus-summary-up-thread}).
 
 @item T o
-@kindex T o (Summary)
+@kindex T o @r{(Summary)}
 @findex gnus-summary-top-thread
 Go to the top of the thread (@code{gnus-summary-top-thread}).
 @end table
@@ -7654,12 +7648,12 @@ you use two explicit commands for managing persistent articles:
 @table @kbd
 
 @item *
-@kindex * (Summary)
+@kindex * @r{(Summary)}
 @findex gnus-cache-enter-article
 Make the current article persistent (@code{gnus-cache-enter-article}).
 
 @item M-*
-@kindex M-* (Summary)
+@kindex M-* @r{(Summary)}
 @findex gnus-cache-remove-article
 Remove the current article from the persistent articles
 (@code{gnus-cache-remove-article}).  This will normally delete the
@@ -7697,7 +7691,7 @@ select another article.  You can make an article sticky with:
 
 @table @kbd
 @item A S
-@kindex A S (Summary)
+@kindex A S @r{(Summary)}
 @findex gnus-sticky-article
 Make the current article sticky.  If a prefix arg is given, ask for a
 name for this sticky article buffer.
@@ -7707,12 +7701,12 @@ To close a sticky article buffer you can use these commands:
 
 @table @kbd
 @item q
-@kindex q (Article)
+@kindex q @r{@r{(Article)}}
 @findex bury-buffer
 Puts this sticky article buffer at the end of the list of all buffers.
 
 @item k
-@kindex k (Article)
+@kindex k @r{(Article)}
 @findex gnus-kill-sticky-article-buffer
 Kills this sticky article buffer.
 @end table
@@ -7778,61 +7772,61 @@ deleted before saving.
 
 @item O o
 @itemx o
-@kindex O o (Summary)
-@kindex o (Summary)
+@kindex O o @r{(Summary)}
+@kindex o @r{(Summary)}
 @findex gnus-summary-save-article
 @c @icon{gnus-summary-save-article}
 Save the current article using the default article saver
 (@code{gnus-summary-save-article}).
 
 @item O m
-@kindex O m (Summary)
+@kindex O m @r{(Summary)}
 @findex gnus-summary-save-article-mail
 Save the current article in a Unix mail box (mbox) file
 (@code{gnus-summary-save-article-mail}).
 
 @item O r
-@kindex O r (Summary)
+@kindex O r @r{(Summary)}
 @findex gnus-summary-save-article-rmail
 Save the current article in Rmail format
 (@code{gnus-summary-save-article-rmail}).  This is mbox since Emacs 23,
 Babyl in older versions.
 
 @item O f
-@kindex O f (Summary)
+@kindex O f @r{(Summary)}
 @findex gnus-summary-save-article-file
 @c @icon{gnus-summary-save-article-file}
 Save the current article in plain file format
 (@code{gnus-summary-save-article-file}).
 
 @item O F
-@kindex O F (Summary)
+@kindex O F @r{(Summary)}
 @findex gnus-summary-write-article-file
 Write the current article in plain file format, overwriting any previous
 file contents (@code{gnus-summary-write-article-file}).
 
 @item O b
-@kindex O b (Summary)
+@kindex O b @r{(Summary)}
 @findex gnus-summary-save-article-body-file
 Save the current article body in plain file format
 (@code{gnus-summary-save-article-body-file}).
 
 @item O h
-@kindex O h (Summary)
+@kindex O h @r{(Summary)}
 @findex gnus-summary-save-article-folder
 Save the current article in mh folder format
 (@code{gnus-summary-save-article-folder}).
 
 @item O v
-@kindex O v (Summary)
+@kindex O v @r{(Summary)}
 @findex gnus-summary-save-article-vm
 Save the current article in a VM folder
 (@code{gnus-summary-save-article-vm}).
 
 @item O p
 @itemx |
-@kindex O p (Summary)
-@kindex | (Summary)
+@kindex O p @r{(Summary)}
+@kindex | @r{(Summary)}
 @findex gnus-summary-pipe-output
 @vindex gnus-summary-pipe-output-default-command
 Save the current article in a pipe.  Uhm, like, what I mean is---Pipe
@@ -7845,7 +7839,7 @@ to a string containing the default command and options (default
 @code{nil}).
 
 @item O P
-@kindex O P (Summary)
+@kindex O P @r{(Summary)}
 @findex gnus-summary-muttprint
 @vindex gnus-summary-muttprint-program
 Save the current article into muttprint.  That is, print it using the
@@ -8152,24 +8146,24 @@ commands, and you have to mark the articles manually with @kbd{#}.
 @table @kbd
 
 @item X u
-@kindex X u (Summary)
+@kindex X u @r{(Summary)}
 @findex gnus-uu-decode-uu
 @c @icon{gnus-uu-decode-uu}
 Uudecodes the current series (@code{gnus-uu-decode-uu}).
 
 @item X U
-@kindex X U (Summary)
+@kindex X U @r{(Summary)}
 @findex gnus-uu-decode-uu-and-save
 Uudecodes and saves the current series
 (@code{gnus-uu-decode-uu-and-save}).
 
 @item X v u
-@kindex X v u (Summary)
+@kindex X v u @r{(Summary)}
 @findex gnus-uu-decode-uu-view
 Uudecodes and views the current series (@code{gnus-uu-decode-uu-view}).
 
 @item X v U
-@kindex X v U (Summary)
+@kindex X v U @r{(Summary)}
 @findex gnus-uu-decode-uu-and-save-view
 Uudecodes, views and saves the current series
 (@code{gnus-uu-decode-uu-and-save-view}).
@@ -8210,22 +8204,22 @@ some commands to deal with these:
 @table @kbd
 
 @item X s
-@kindex X s (Summary)
+@kindex X s @r{(Summary)}
 @findex gnus-uu-decode-unshar
 Unshars the current series (@code{gnus-uu-decode-unshar}).
 
 @item X S
-@kindex X S (Summary)
+@kindex X S @r{(Summary)}
 @findex gnus-uu-decode-unshar-and-save
 Unshars and saves the current series (@code{gnus-uu-decode-unshar-and-save}).
 
 @item X v s
-@kindex X v s (Summary)
+@kindex X v s @r{(Summary)}
 @findex gnus-uu-decode-unshar-view
 Unshars and views the current series (@code{gnus-uu-decode-unshar-view}).
 
 @item X v S
-@kindex X v S (Summary)
+@kindex X v S @r{(Summary)}
 @findex gnus-uu-decode-unshar-and-save-view
 Unshars, views and saves the current series
 (@code{gnus-uu-decode-unshar-and-save-view}).
@@ -8239,24 +8233,24 @@ Unshars, views and saves the current series
 @table @kbd
 
 @item X p
-@kindex X p (Summary)
+@kindex X p @r{(Summary)}
 @findex gnus-uu-decode-postscript
 Unpack the current PostScript series (@code{gnus-uu-decode-postscript}).
 
 @item X P
-@kindex X P (Summary)
+@kindex X P @r{(Summary)}
 @findex gnus-uu-decode-postscript-and-save
 Unpack and save the current PostScript series
 (@code{gnus-uu-decode-postscript-and-save}).
 
 @item X v p
-@kindex X v p (Summary)
+@kindex X v p @r{(Summary)}
 @findex gnus-uu-decode-postscript-view
 View the current PostScript series
 (@code{gnus-uu-decode-postscript-view}).
 
 @item X v P
-@kindex X v P (Summary)
+@kindex X v P @r{(Summary)}
 @findex gnus-uu-decode-postscript-and-save-view
 View and save the current PostScript series
 (@code{gnus-uu-decode-postscript-and-save-view}).
@@ -8268,19 +8262,19 @@ View and save the current PostScript series
 
 @table @kbd
 @item X o
-@kindex X o (Summary)
+@kindex X o @r{(Summary)}
 @findex gnus-uu-decode-save
 Save the current series
 (@code{gnus-uu-decode-save}).
 
 @item X b
-@kindex X b (Summary)
+@kindex X b @r{(Summary)}
 @findex gnus-uu-decode-binhex
 Unbinhex the current series (@code{gnus-uu-decode-binhex}).  This
 doesn't really work yet.
 
 @item X Y
-@kindex X Y (Summary)
+@kindex X Y @r{(Summary)}
 @findex gnus-uu-decode-yenc
 yEnc-decode the current series and save it (@code{gnus-uu-decode-yenc}).
 @end table
@@ -8554,7 +8548,7 @@ you want it to look like technicolor fruit salad.
 @table @kbd
 
 @item W H a
-@kindex W H a (Summary)
+@kindex W H a @r{(Summary)}
 @findex gnus-article-highlight
 @findex gnus-article-maybe-highlight
 Do much highlighting of the current article
@@ -8562,7 +8556,7 @@ Do much highlighting of the current article
 text, the signature, and adds buttons to the body and the head.
 
 @item W H h
-@kindex W H h (Summary)
+@kindex W H h @r{(Summary)}
 @findex gnus-article-highlight-headers
 @vindex gnus-header-face-alist
 Highlight the headers (@code{gnus-article-highlight-headers}).  The
@@ -8576,7 +8570,7 @@ the header value.  The first match made will be used.  Note that
 @var{regexp} shouldn't have @samp{^} prepended---Gnus will add one.
 
 @item W H c
-@kindex W H c (Summary)
+@kindex W H c @r{(Summary)}
 @findex gnus-article-highlight-citation
 Highlight cited text (@code{gnus-article-highlight-citation}).
 
@@ -8637,7 +8631,7 @@ is @code{t}.
 
 
 @item W H s
-@kindex W H s (Summary)
+@kindex W H s @r{(Summary)}
 @vindex gnus-signature-separator
 @vindex gnus-signature-face
 @findex gnus-article-highlight-signature
@@ -8658,7 +8652,7 @@ default.
 @cindex article emphasis
 
 @findex gnus-article-emphasize
-@kindex W e (Summary)
+@kindex W e @r{(Summary)}
 People commonly add emphasis to words in news articles by writing things
 like @samp{_this_} or @samp{*this*} or @samp{/this/}.  Gnus can make
 this look nicer by running the article through the @kbd{W e}
@@ -8729,32 +8723,32 @@ too much cruft in most articles.
 @table @kbd
 
 @item W W a
-@kindex W W a (Summary)
+@kindex W W a @r{(Summary)}
 @findex gnus-article-hide
 Do quite a lot of hiding on the article buffer
 (@kbd{gnus-article-hide}).  In particular, this function will hide
 headers, @acronym{PGP}, cited text and the signature.
 
 @item W W h
-@kindex W W h (Summary)
+@kindex W W h @r{(Summary)}
 @findex gnus-article-hide-headers
 Hide headers (@code{gnus-article-hide-headers}).  @xref{Hiding
 Headers}.
 
 @item W W b
-@kindex W W b (Summary)
+@kindex W W b @r{(Summary)}
 @findex gnus-article-hide-boring-headers
 Hide headers that aren't particularly interesting
 (@code{gnus-article-hide-boring-headers}).  @xref{Hiding Headers}.
 
 @item W W s
-@kindex W W s (Summary)
+@kindex W W s @r{(Summary)}
 @findex gnus-article-hide-signature
 Hide signature (@code{gnus-article-hide-signature}).  @xref{Article
 Signature}.
 
 @item W W l
-@kindex W W l (Summary)
+@kindex W W l @r{(Summary)}
 @findex gnus-article-hide-list-identifiers
 @vindex gnus-list-identifiers
 Strip list identifiers specified in @code{gnus-list-identifiers}.  These
@@ -8773,13 +8767,13 @@ subject.  This can also be a list of regular expressions.
 @end table
 
 @item W W P
-@kindex W W P (Summary)
+@kindex W W P @r{(Summary)}
 @findex gnus-article-hide-pem
 Hide @acronym{PEM} (privacy enhanced messages) cruft
 (@code{gnus-article-hide-pem}).
 
 @item W W B
-@kindex W W B (Summary)
+@kindex W W B @r{(Summary)}
 @findex gnus-article-strip-banner
 @vindex gnus-article-banner-alist
 @vindex gnus-article-address-banner-alist
@@ -8833,7 +8827,7 @@ sends, you can use the following element to remove them:
 @end table
 
 @item W W c
-@kindex W W c (Summary)
+@kindex W W c @r{(Summary)}
 @findex gnus-article-hide-citation
 Hide citation (@code{gnus-article-hide-citation}).  Some variables for
 customizing the hiding:
@@ -8869,7 +8863,7 @@ and bottom of the text, respectively, to remain visible.
 @end table
 
 @item W W C-c
-@kindex W W C-c (Summary)
+@kindex W W C-c @r{(Summary)}
 @findex gnus-article-hide-citation-maybe
 
 Hide citation (@code{gnus-article-hide-citation-maybe}) depending on the
@@ -8888,7 +8882,7 @@ is hidden.
 @end table
 
 @item W W C
-@kindex W W C (Summary)
+@kindex W W C @r{(Summary)}
 @findex gnus-article-hide-citation-in-followups
 Hide cited text in articles that aren't roots
 (@code{gnus-article-hide-citation-in-followups}).  This isn't very
@@ -8938,14 +8932,14 @@ interactive Washing functions but with all default treatments
 (@pxref{Customizing Articles}).
 
 @item W l
-@kindex W l (Summary)
+@kindex W l @r{(Summary)}
 @findex gnus-summary-stop-page-breaking
 Remove page breaks from the current article
 (@code{gnus-summary-stop-page-breaking}).  @xref{Misc Article}, for page
 delimiters.
 
 @item W r
-@kindex W r (Summary)
+@kindex W r @r{(Summary)}
 @findex gnus-summary-caesar-message
 @c @icon{gnus-summary-caesar-message}
 Do a Caesar rotate (rot13) on the article buffer
@@ -8959,12 +8953,12 @@ positions in the alphabet, e.g., @samp{B} (letter #2) -> @samp{O} (letter
 is rumored to have employed this form of, uh, somewhat weak encryption.
 
 @item W m
-@kindex W m (Summary)
+@kindex W m @r{(Summary)}
 @findex gnus-summary-morse-message
 Morse decode the article buffer (@code{gnus-summary-morse-message}).
 
 @item W i
-@kindex W i (Summary)
+@kindex W i @r{(Summary)}
 @findex gnus-summary-idna-message
 Decode IDNA encoded domain names in the current articles.  IDNA
 encoded domain names looks like @samp{xn--bar}.  If a string remain
@@ -8975,25 +8969,25 @@ to work.
 
 @item W t
 @item t
-@kindex W t (Summary)
-@kindex t (Summary)
+@kindex W t @r{(Summary)}
+@kindex t @r{(Summary)}
 @findex gnus-summary-toggle-header
 Toggle whether to display all headers in the article buffer
 (@code{gnus-summary-toggle-header}).
 
 @item W v
-@kindex W v (Summary)
+@kindex W v @r{(Summary)}
 @findex gnus-summary-verbose-headers
 Toggle whether to display all headers in the article buffer permanently
 (@code{gnus-summary-verbose-headers}).
 
 @item W o
-@kindex W o (Summary)
+@kindex W o @r{(Summary)}
 @findex gnus-article-treat-overstrike
 Treat overstrike (@code{gnus-article-treat-overstrike}).
 
 @item W d
-@kindex W d (Summary)
+@kindex W d @r{(Summary)}
 @findex gnus-article-treat-dumbquotes
 @vindex gnus-article-dumbquotes-map
 @cindex Smartquotes
@@ -9011,7 +9005,7 @@ like @code{\222} or @code{\264} where you're expecting some kind of
 apostrophe or quotation mark, then try this wash.
 
 @item W U
-@kindex W U (Summary)
+@kindex W U @r{(Summary)}
 @findex gnus-article-treat-non-ascii
 @cindex Unicode
 @cindex Non-@acronym{ASCII}
@@ -9022,7 +9016,7 @@ and doesn't show accented characters, ``advanced'' punctuation, and the
 like.  For instance, @samp{»} is translated into @samp{>>}, and so on.
 
 @item W Y f
-@kindex W Y f (Summary)
+@kindex W Y f @r{(Summary)}
 @findex gnus-article-outlook-deuglify-article
 @cindex Outlook Express
 Full deuglify of broken Outlook (Express) articles: Treat dumbquotes,
@@ -9030,7 +9024,7 @@ unwrap lines, repair attribution and rearrange citation.
 (@code{gnus-article-outlook-deuglify-article}).
 
 @item W Y u
-@kindex W Y u (Summary)
+@kindex W Y u @r{(Summary)}
 @findex gnus-article-outlook-unwrap-lines
 @vindex gnus-outlook-deuglify-unwrap-min
 @vindex gnus-outlook-deuglify-unwrap-max
@@ -9042,19 +9036,19 @@ maximum length of an unwrapped citation line.
 (@code{gnus-article-outlook-unwrap-lines}).
 
 @item W Y a
-@kindex W Y a (Summary)
+@kindex W Y a @r{(Summary)}
 @findex gnus-article-outlook-repair-attribution
 Repair a broken attribution line.@*
 (@code{gnus-article-outlook-repair-attribution}).
 
 @item W Y c
-@kindex W Y c (Summary)
+@kindex W Y c @r{(Summary)}
 @findex gnus-article-outlook-rearrange-citation
 Repair broken citations by rearranging the text.
 (@code{gnus-article-outlook-rearrange-citation}).
 
 @item W w
-@kindex W w (Summary)
+@kindex W w @r{(Summary)}
 @findex gnus-article-fill-cited-article
 Do word wrap (@code{gnus-article-fill-cited-article}).
 
@@ -9062,18 +9056,18 @@ You can give the command a numerical prefix to specify the width to use
 when filling.
 
 @item W Q
-@kindex W Q (Summary)
+@kindex W Q @r{(Summary)}
 @findex gnus-article-fill-long-lines
 Fill long lines (@code{gnus-article-fill-long-lines}).
 
 @item W C
-@kindex W C (Summary)
+@kindex W C @r{(Summary)}
 @findex gnus-article-capitalize-sentences
 Capitalize the first word in each sentence
 (@code{gnus-article-capitalize-sentences}).
 
 @item W c
-@kindex W c (Summary)
+@kindex W c @r{(Summary)}
 @findex gnus-article-remove-cr
 Translate CRLF pairs (i.e., @samp{^M}s on the end of the lines) into LF
 (this takes care of DOS line endings), and then translate any remaining
@@ -9081,7 +9075,7 @@ CRs into LF (this takes care of Mac line endings)
 (@code{gnus-article-remove-cr}).
 
 @item W q
-@kindex W q (Summary)
+@kindex W q @r{(Summary)}
 @findex gnus-article-de-quoted-unreadable
 Treat quoted-printable (@code{gnus-article-de-quoted-unreadable}).
 Quoted-Printable is one common @acronym{MIME} encoding employed when
@@ -9093,7 +9087,7 @@ done automatically by Gnus if the message in question has a
 has been done.  If a prefix is given, a charset will be asked for.
 
 @item W 6
-@kindex W 6 (Summary)
+@kindex W 6 @r{(Summary)}
 @findex gnus-article-de-base64-unreadable
 Treat base64 (@code{gnus-article-de-base64-unreadable}).  Base64 is
 one common @acronym{MIME} encoding employed when sending
@@ -9103,14 +9097,14 @@ usually done automatically by Gnus if the message in question has a
 has been done.  If a prefix is given, a charset will be asked for.
 
 @item W Z
-@kindex W Z (Summary)
+@kindex W Z @r{(Summary)}
 @findex gnus-article-decode-HZ
 Treat HZ or HZP (@code{gnus-article-decode-HZ}).  HZ (or HZP) is one
 common encoding employed when sending Chinese articles.  It typically
 makes strings look like @samp{~@{<:Ky2;S@{#,NpJ)l6HK!#~@}}.
 
 @item W A
-@kindex W A (Summary)
+@kindex W A @r{(Summary)}
 @findex gnus-article-treat-ansi-sequences
 @cindex @acronym{ANSI} control sequences
 Translate @acronym{ANSI} SGR control sequences into overlays or
@@ -9118,7 +9112,7 @@ extents (@code{gnus-article-treat-ansi-sequences}).  @acronym{ANSI}
 sequences are used in some Chinese hierarchies for highlighting.
 
 @item W u
-@kindex W u (Summary)
+@kindex W u @r{(Summary)}
 @findex gnus-article-unsplit-urls
 Remove newlines from within URLs.  Some mailers insert newlines into
 outgoing email messages to keep lines short.  This reformatting can
@@ -9126,7 +9120,7 @@ split long URLs onto multiple lines.  Repair those URLs by removing
 the newlines (@code{gnus-article-unsplit-urls}).
 
 @item W h
-@kindex W h (Summary)
+@kindex W h @r{(Summary)}
 @findex gnus-article-wash-html
 Treat @acronym{HTML} (@code{gnus-article-wash-html}).  Note that this is
 usually done automatically by Gnus if the message in question has a
@@ -9166,19 +9160,19 @@ Use html2text---a simple @acronym{HTML} converter included with Gnus.
 @end table
 
 @item W b
-@kindex W b (Summary)
+@kindex W b @r{(Summary)}
 @findex gnus-article-add-buttons
 Add clickable buttons to the article (@code{gnus-article-add-buttons}).
 @xref{Article Buttons}.
 
 @item W B
-@kindex W B (Summary)
+@kindex W B @r{(Summary)}
 @findex gnus-article-add-buttons-to-head
 Add clickable buttons to the article headers
 (@code{gnus-article-add-buttons-to-head}).
 
 @item W p
-@kindex W p (Summary)
+@kindex W p @r{(Summary)}
 @findex gnus-article-verify-x-pgp-sig
 Verify a signed control message
 (@code{gnus-article-verify-x-pgp-sig}).  Control messages such as
@@ -9189,57 +9183,57 @@ message.@footnote{@acronym{PGP} keys for many hierarchies are
 available at @uref{https://ftp.isc.org/pub/pgpcontrol/README.html}}
 
 @item W s
-@kindex W s (Summary)
+@kindex W s @r{(Summary)}
 @findex gnus-summary-force-verify-and-decrypt
 Verify a signed (@acronym{PGP}, @acronym{PGP/MIME} or
 @acronym{S/MIME}) message
 (@code{gnus-summary-force-verify-and-decrypt}). @xref{Security}.
 
 @item W a
-@kindex W a (Summary)
+@kindex W a @r{(Summary)}
 @findex gnus-article-strip-headers-in-body
 Strip headers like the @code{X-No-Archive} header from the beginning of
 article bodies (@code{gnus-article-strip-headers-in-body}).
 
 @item W E l
-@kindex W E l (Summary)
+@kindex W E l @r{(Summary)}
 @findex gnus-article-strip-leading-blank-lines
 Remove all blank lines from the beginning of the article
 (@code{gnus-article-strip-leading-blank-lines}).
 
 @item W E m
-@kindex W E m (Summary)
+@kindex W E m @r{(Summary)}
 @findex gnus-article-strip-multiple-blank-lines
 Replace all blank lines with empty lines and then all multiple empty
 lines with a single empty line.
 (@code{gnus-article-strip-multiple-blank-lines}).
 
 @item W E t
-@kindex W E t (Summary)
+@kindex W E t @r{(Summary)}
 @findex gnus-article-remove-trailing-blank-lines
 Remove all blank lines at the end of the article
 (@code{gnus-article-remove-trailing-blank-lines}).
 
 @item W E a
-@kindex W E a (Summary)
+@kindex W E a @r{(Summary)}
 @findex gnus-article-strip-blank-lines
 Do all the three commands above
 (@code{gnus-article-strip-blank-lines}).
 
 @item W E A
-@kindex W E A (Summary)
+@kindex W E A @r{(Summary)}
 @findex gnus-article-strip-all-blank-lines
 Remove all blank lines
 (@code{gnus-article-strip-all-blank-lines}).
 
 @item W E s
-@kindex W E s (Summary)
+@kindex W E s @r{(Summary)}
 @findex gnus-article-strip-leading-space
 Remove all white space from the beginning of all lines of the article
 body (@code{gnus-article-strip-leading-space}).
 
 @item W E e
-@kindex W E e (Summary)
+@kindex W E e @r{(Summary)}
 @findex gnus-article-strip-trailing-space
 Remove all white space from the end of all lines of the article
 body (@code{gnus-article-strip-trailing-space}).
@@ -9257,24 +9251,24 @@ These commands perform various transformations of article header.
 @table @kbd
 
 @item W G u
-@kindex W G u (Summary)
+@kindex W G u @r{(Summary)}
 @findex gnus-article-treat-unfold-headers
 Unfold folded header lines (@code{gnus-article-treat-unfold-headers}).
 
 @item W G n
-@kindex W G n (Summary)
+@kindex W G n @r{(Summary)}
 @findex gnus-article-treat-fold-newsgroups
 Fold the @code{Newsgroups} and @code{Followup-To} headers
 (@code{gnus-article-treat-fold-newsgroups}).
 
 @item W G f
-@kindex W G f (Summary)
+@kindex W G f @r{(Summary)}
 @findex gnus-article-treat-fold-headers
 Fold all the message headers
 (@code{gnus-article-treat-fold-headers}).
 
 @item W E w
-@kindex W E w (Summary)
+@kindex W E w @r{(Summary)}
 @findex gnus-article-remove-leading-whitespace
 Remove excessive whitespace from all headers
 (@code{gnus-article-remove-leading-whitespace}).
@@ -9288,7 +9282,7 @@ Remove excessive whitespace from all headers
 
 People often include references to other stuff in articles, and it would
 be nice if Gnus could just fetch whatever it is that people talk about
-with the minimum of fuzz when you hit @kbd{RET} or use the middle mouse
+with the minimum of fuzz when you hit @kbd{@key{RET}} or use the middle mouse
 button on these references.
 
 @vindex gnus-button-man-handler
@@ -9494,31 +9488,31 @@ when the article was sent.
 @table @kbd
 
 @item W T u
-@kindex W T u (Summary)
+@kindex W T u @r{(Summary)}
 @findex gnus-article-date-ut
 Display the date in UT (aka. GMT, aka ZULU)
 (@code{gnus-article-date-ut}).
 
 @item W T i
-@kindex W T i (Summary)
+@kindex W T i @r{(Summary)}
 @findex gnus-article-date-iso8601
 @cindex ISO 8601
 Display the date in international format, aka. ISO 8601
 (@code{gnus-article-date-iso8601}).
 
 @item W T l
-@kindex W T l (Summary)
+@kindex W T l @r{(Summary)}
 @findex gnus-article-date-local
 Display the date in the local timezone (@code{gnus-article-date-local}).
 
 @item W T p
-@kindex W T p (Summary)
+@kindex W T p @r{(Summary)}
 @findex gnus-article-date-english
 Display the date in a format that's easily pronounceable in English
 (@code{gnus-article-date-english}).
 
 @item W T s
-@kindex W T s (Summary)
+@kindex W T s @r{(Summary)}
 @vindex gnus-article-time-format
 @findex gnus-article-date-user
 @findex format-time-string
@@ -9529,7 +9523,7 @@ to @code{format-time-string}.  See the documentation of that variable
 for a list of possible format specs.
 
 @item W T e
-@kindex W T e (Summary)
+@kindex W T e @r{(Summary)}
 @findex gnus-article-date-lapsed
 @findex gnus-start-date-timer
 @findex gnus-stop-date-timer
@@ -9545,7 +9539,7 @@ To make this line updated continually, set the
 seconds (the default is @code{nil}).
 
 @item W T o
-@kindex W T o (Summary)
+@kindex W T o @r{(Summary)}
 @findex gnus-article-date-original
 Display the original date (@code{gnus-article-date-original}).  This can
 be useful if you normally use some other conversion function and are
@@ -9589,58 +9583,58 @@ they'll be removed.
 
 @table @kbd
 @item W D x
-@kindex W D x (Summary)
+@kindex W D x @r{(Summary)}
 @findex gnus-article-display-x-face
 Display an @code{X-Face} in the @code{From} header.
 (@code{gnus-article-display-x-face}).
 
 @item W D d
-@kindex W D d (Summary)
+@kindex W D d @r{(Summary)}
 @findex gnus-article-display-face
 Display a @code{Face} in the @code{From} header.
 (@code{gnus-article-display-face}).
 
 @item W D s
-@kindex W D s (Summary)
+@kindex W D s @r{(Summary)}
 @findex gnus-treat-smiley
 Display smileys (@code{gnus-treat-smiley}).
 
 @item W D f
-@kindex W D f (Summary)
+@kindex W D f @r{(Summary)}
 @findex gnus-treat-from-picon
 Piconify the @code{From} header (@code{gnus-treat-from-picon}).
 
 @item W D m
-@kindex W D m (Summary)
+@kindex W D m @r{(Summary)}
 @findex gnus-treat-mail-picon
 Piconify all mail headers (i.e., @code{Cc}, @code{To})
 (@code{gnus-treat-mail-picon}).
 
 @item W D n
-@kindex W D n (Summary)
+@kindex W D n @r{(Summary)}
 @findex gnus-treat-newsgroups-picon
 Piconify all news headers (i.e., @code{Newsgroups} and
 @code{Followup-To}) (@code{gnus-treat-newsgroups-picon}).
 
 @item W D g
-@kindex W D g (Summary)
+@kindex W D g @r{(Summary)}
 @findex gnus-treat-from-gravatar
 Gravatarify the @code{From} header (@code{gnus-treat-from-gravatar}).
 
 @item W D h
-@kindex W D h (Summary)
+@kindex W D h @r{(Summary)}
 @findex gnus-treat-mail-gravatar
 Gravatarify all mail headers (i.e., @code{Cc}, @code{To})
 (@code{gnus-treat-from-gravatar}).
 
 @item W D D
-@kindex W D D (Summary)
+@kindex W D D @r{(Summary)}
 @findex gnus-article-remove-images
 Remove all images from the article buffer
 (@code{gnus-article-remove-images}).
 
 @item W D W
-@kindex W D W (Summary)
+@kindex W D W @r{(Summary)}
 @findex gnus-html-show-images
 If you're reading an @acronym{HTML} article rendered with
 @code{gnus-article-html}, then you can insert any blocked images in
@@ -9718,7 +9712,7 @@ signature after all.
 
 @table @kbd
 @item A t
-@kindex A t (Summary)
+@kindex A t @r{(Summary)}
 @findex gnus-article-babel
 Translate the article from one language to another
 (@code{gnus-article-babel}).
@@ -9738,43 +9732,43 @@ instance, @kbd{3 K v} means ``view the third @acronym{MIME} part''.
 @table @kbd
 @item b
 @itemx K v
-@kindex b (Summary)
-@kindex K v (Summary)
+@kindex b @r{(Summary)}
+@kindex K v @r{(Summary)}
 View the @acronym{MIME} part.
 
 @item K o
-@kindex K o (Summary)
+@kindex K o @r{(Summary)}
 Save the @acronym{MIME} part.
 
 @item K O
-@kindex K O (Summary)
+@kindex K O @r{(Summary)}
 Prompt for a file name, then save the @acronym{MIME} part and strip it
 from the article.  The stripped @acronym{MIME} object will be referred
 via the message/external-body @acronym{MIME} type.
 
 @item K r
-@kindex K r (Summary)
+@kindex K r @r{(Summary)}
 Replace the @acronym{MIME} part with an external body.
 
 @item K d
-@kindex K d (Summary)
+@kindex K d @r{(Summary)}
 Delete the @acronym{MIME} part and add some information about the
 removed part.
 
 @item K c
-@kindex K c (Summary)
+@kindex K c @r{(Summary)}
 Copy the @acronym{MIME} part.
 
 @item K e
-@kindex K e (Summary)
+@kindex K e @r{(Summary)}
 View the @acronym{MIME} part externally.
 
 @item K i
-@kindex K i (Summary)
+@kindex K i @r{(Summary)}
 View the @acronym{MIME} part internally.
 
 @item K |
-@kindex K | (Summary)
+@kindex K | @r{(Summary)}
 Pipe the @acronym{MIME} part to an external command.
 @end table
 
@@ -9783,7 +9777,7 @@ the same manner:
 
 @table @kbd
 @item K H
-@kindex K H (Summary)
+@kindex K H @r{(Summary)}
 @findex gnus-article-browse-html-article
 View @samp{text/html} parts of the current article with a WWW browser.
 Inline images embedded in a message using the @code{cid} scheme, as they
@@ -9805,13 +9799,13 @@ including images if any to the browser, and deletes them when exiting
 the group (if you want).
 
 @item K b
-@kindex K b (Summary)
+@kindex K b @r{(Summary)}
 Make all the @acronym{MIME} parts have buttons in front of them.  This is
 mostly useful if you wish to save (or perform other actions) on inlined
 parts.
 
 @item W M h
-@kindex W M h (Summary)
+@kindex W M h @r{(Summary)}
 @findex gnus-mime-buttonize-attachments-in-header
 @vindex gnus-mime-display-attachment-buttons-in-header
 Display @acronym{MIME} part buttons in the end of the header of an
@@ -9824,7 +9818,7 @@ The default is @code{t}.  To change the appearance of buttons, customize
 @code{gnus-header-face-alist}.
 
 @item K m
-@kindex K m (Summary)
+@kindex K m @r{(Summary)}
 @findex gnus-summary-repair-multipart
 Some multipart messages are transmitted with missing or faulty headers.
 This command will attempt to ``repair'' these messages so that they can
@@ -9832,26 +9826,26 @@ be viewed in a more pleasant manner
 (@code{gnus-summary-repair-multipart}).
 
 @item X m
-@kindex X m (Summary)
+@kindex X m @r{(Summary)}
 @findex gnus-summary-save-parts
 Save all parts matching a @acronym{MIME} type to a directory
 (@code{gnus-summary-save-parts}).  Understands the process/prefix
 convention (@pxref{Process/Prefix}).
 
 @item M-t
-@kindex M-t (Summary)
+@kindex M-t @r{(Summary)}
 @findex gnus-summary-toggle-display-buttonized
 Toggle the buttonized display of the article buffer
 (@code{gnus-summary-toggle-display-buttonized}).
 
 @item W M w
-@kindex W M w (Summary)
+@kindex W M w @r{(Summary)}
 @findex gnus-article-decode-mime-words
 Decode RFC 2047-encoded words in the article headers
 (@code{gnus-article-decode-mime-words}).
 
 @item W M c
-@kindex W M c (Summary)
+@kindex W M c @r{(Summary)}
 @findex gnus-article-decode-charset
 Decode encoded article bodies as well as charsets
 (@code{gnus-article-decode-charset}).
@@ -9864,7 +9858,7 @@ include @acronym{MIME} headers), you can set the @code{charset} group/topic
 parameter to the required charset (@pxref{Group Parameters}).
 
 @item W M v
-@kindex W M v (Summary)
+@kindex W M v @r{(Summary)}
 @findex gnus-mime-view-all-parts
 View all the @acronym{MIME} parts in the current article
 (@code{gnus-mime-view-all-parts}).
@@ -10123,7 +10117,7 @@ something like
 @item A P
 @cindex PostScript
 @cindex printing
-@kindex A P (Summary)
+@kindex A P @r{(Summary)}
 @vindex gnus-ps-print-hook
 @findex gnus-summary-print-article
 Generate and print a PostScript image of the article buffer
@@ -10154,68 +10148,68 @@ can't really see why you'd want that.
 @table @kbd
 
 @item C-c C-s C-n
-@kindex C-c C-s C-n (Summary)
+@kindex C-c C-s C-n @r{(Summary)}
 @findex gnus-summary-sort-by-number
 Sort by article number (@code{gnus-summary-sort-by-number}).
 
 @item C-c C-s C-m C-n
-@kindex C-c C-s C-n (Summary)
+@kindex C-c C-s C-n @r{(Summary)}
 @findex gnus-summary-sort-by-most-recent-number
 Sort by most recent article number
 (@code{gnus-summary-sort-by-most-recent-number}).
 
 @item C-c C-s C-a
-@kindex C-c C-s C-a (Summary)
+@kindex C-c C-s C-a @r{(Summary)}
 @findex gnus-summary-sort-by-author
 Sort by author (@code{gnus-summary-sort-by-author}).
 
 @item C-c C-s C-t
-@kindex C-c C-s C-t (Summary)
+@kindex C-c C-s C-t @r{(Summary)}
 @findex gnus-summary-sort-by-recipient
 Sort by recipient (@code{gnus-summary-sort-by-recipient}).
 
 @item C-c C-s C-s
-@kindex C-c C-s C-s (Summary)
+@kindex C-c C-s C-s @r{(Summary)}
 @findex gnus-summary-sort-by-subject
 Sort by subject (@code{gnus-summary-sort-by-subject}).
 
 @item C-c C-s C-d
-@kindex C-c C-s C-d (Summary)
+@kindex C-c C-s C-d @r{(Summary)}
 @findex gnus-summary-sort-by-date
 Sort by date (@code{gnus-summary-sort-by-date}).
 
 @item C-c C-s C-m C-d
-@kindex C-c C-s C-m C-d (Summary)
+@kindex C-c C-s C-m C-d @r{(Summary)}
 @findex gnus-summary-sort-by-most-recent-date
 Sort by most recent date (@code{gnus-summary-sort-by-most-recent-date}).
 
 @item C-c C-s C-l
-@kindex C-c C-s C-l (Summary)
+@kindex C-c C-s C-l @r{(Summary)}
 @findex gnus-summary-sort-by-lines
 Sort by lines (@code{gnus-summary-sort-by-lines}).
 
 @item C-c C-s C-c
-@kindex C-c C-s C-c (Summary)
+@kindex C-c C-s C-c @r{(Summary)}
 @findex gnus-summary-sort-by-chars
 Sort by article length (@code{gnus-summary-sort-by-chars}).
 
 @item C-c C-s C-m C-m
-@kindex C-c C-s C-m C-m (Summary)
+@kindex C-c C-s C-m C-m @r{(Summary)}
 @findex gnus-summary-sort-by-marks
 Sort by article ``readedness'' marks (@code{gnus-summary-sort-by-marks}).
 
 @item C-c C-s C-i
-@kindex C-c C-s C-i (Summary)
+@kindex C-c C-s C-i @r{(Summary)}
 @findex gnus-summary-sort-by-score
 Sort by score (@code{gnus-summary-sort-by-score}).
 
 @item C-c C-s C-r
-@kindex C-c C-s C-r (Summary)
+@kindex C-c C-s C-r @r{(Summary)}
 @findex gnus-summary-sort-by-random
 Randomize (@code{gnus-summary-sort-by-random}).
 
 @item C-c C-s C-o
-@kindex C-c C-s C-o (Summary)
+@kindex C-c C-s C-o @r{(Summary)}
 @findex gnus-summary-sort-by-original
 Sort using the default sorting method
 (@code{gnus-summary-sort-by-original}).
@@ -10238,7 +10232,7 @@ If a prefix argument if given, the sort order is reversed.
 
 @table @kbd
 @item ^
-@kindex ^ (Summary)
+@kindex ^ @r{(Summary)}
 @findex gnus-summary-refer-parent-article
 If you'd like to read the parent of the current article, and it is not
 displayed in the summary buffer, you might still be able to.  That is,
@@ -10258,13 +10252,13 @@ article.
 
 @item A R (Summary)
 @findex gnus-summary-refer-references
-@kindex A R (Summary)
+@kindex A R @r{(Summary)}
 Fetch all articles mentioned in the @code{References} header of the
 article (@code{gnus-summary-refer-references}).
 
 @item A T (Summary)
 @findex gnus-summary-refer-thread
-@kindex A T (Summary)
+@kindex A T @r{(Summary)}
 Display the full thread where the current article appears
 (@code{gnus-summary-refer-thread}).  This command has to fetch all the
 headers in the current group to work, so it usually takes a while.  If
@@ -10282,7 +10276,7 @@ by giving the @kbd{A T} command a numerical prefix.
 
 @item M-^ (Summary)
 @findex gnus-summary-refer-article
-@kindex M-^ (Summary)
+@kindex M-^ @r{(Summary)}
 @cindex Message-ID
 @cindex fetching by Message-ID
 You can also ask Gnus for an arbitrary article, no matter what group it
@@ -10352,7 +10346,6 @@ buffer the articles she wants to read.  Then she starts reading the
 articles with just an article buffer displayed.
 
 @findex gnus-pick-mode
-@kindex M-x gnus-pick-mode
 Gnus provides a summary buffer minor mode that allows
 this---@code{gnus-pick-mode}.  This basically means that a few process
 mark commands become one-keystroke commands to allow easy marking, and
@@ -10362,7 +10355,7 @@ Here are the available keystrokes when using pick mode:
 
 @table @kbd
 @item .
-@kindex . (Pick)
+@kindex . @r{(Pick)}
 @findex gnus-pick-article-or-thread
 Pick the article or thread on the current line
 (@code{gnus-pick-article-or-thread}).  If the variable
@@ -10372,14 +10365,14 @@ it selects just the article.  If given a numerical prefix, go to that
 thread or article and pick it.  (The line number is normally displayed
 at the beginning of the summary pick lines.)
 
-@item SPACE
-@kindex SPACE (Pick)
+@item @key{SPC}
+@kindex SPC @r{(Pick)}
 @findex gnus-pick-next-page
 Scroll the summary buffer up one page (@code{gnus-pick-next-page}).  If
 at the end of the buffer, start reading the picked articles.
 
 @item u
-@kindex u (Pick)
+@kindex u @r{(Pick)}
 @findex gnus-pick-unmark-article-or-thread.
 Unpick the thread or article
 (@code{gnus-pick-unmark-article-or-thread}).  If the variable
@@ -10388,8 +10381,8 @@ thread if used at the first article of the thread.  Otherwise it unpicks
 just the article.  You can give this key a numerical prefix to unpick
 the thread or article at that line.
 
-@item RET
-@kindex RET (Pick)
+@item @key{RET}
+@kindex RET @r{(Pick)}
 @findex gnus-pick-start-reading
 @vindex gnus-pick-display-summary
 Start reading the picked articles (@code{gnus-pick-start-reading}).  If
@@ -10431,14 +10424,13 @@ Variables}).  It accepts the same format specs that
 @cindex binary groups
 
 @findex gnus-binary-mode
-@kindex M-x gnus-binary-mode
 If you spend much time in binary groups, you may grow tired of hitting
-@kbd{X u}, @kbd{n}, @kbd{RET} all the time.  @kbd{M-x gnus-binary-mode}
+@kbd{X u}, @kbd{n}, @kbd{@key{RET}} all the time.  @kbd{M-x gnus-binary-mode}
 is a minor mode for summary buffers that makes all ordinary Gnus article
 selection functions uudecode series of articles and display the result
 instead of just displaying the articles the normal way.
 
-@kindex g (Binary)
+@kindex g @r{(Binary)}
 @findex gnus-binary-show-article
 The only way, in fact, to see the actual articles is the @kbd{g}
 command, when you have turned on this mode
@@ -10614,7 +10606,7 @@ process/prefix convention (@pxref{Process/Prefix}).
 @table @kbd
 
 @item B e
-@kindex B e (Summary)
+@kindex B e @r{(Summary)}
 @findex gnus-summary-expire-articles
 @cindex expiring mail
 Run all expirable articles in the current group through the expiry
@@ -10623,7 +10615,7 @@ expirable articles in the group that have been around for a while.
 (@pxref{Expiring Mail}).
 
 @item B C-M-e
-@kindex B C-M-e (Summary)
+@kindex B C-M-e @r{(Summary)}
 @findex gnus-summary-expire-articles-now
 @cindex expiring mail
 Delete all the expirable articles in the group
@@ -10631,8 +10623,8 @@ Delete all the expirable articles in the group
 articles eligible for expiry in the current group will
 disappear forever into that big @file{/dev/null} in the sky.
 
-@item B DEL
-@kindex B DEL (Summary)
+@item B @key{DEL}
+@kindex B DEL @r{(Summary)}
 @cindex deleting mail
 @findex gnus-summary-delete-article
 @c @icon{gnus-summary-mail-delete}
@@ -10641,7 +10633,7 @@ disk forever and ever, never to return again.'' Use with caution.
 (@code{gnus-summary-delete-article}).
 
 @item B m
-@kindex B m (Summary)
+@kindex B m @r{(Summary)}
 @cindex move mail
 @findex gnus-summary-move-article
 @vindex gnus-preserve-marks
@@ -10650,7 +10642,7 @@ Move the article from one mail group to another
 @code{gnus-preserve-marks} is non-@code{nil} (which is the default).
 
 @item B c
-@kindex B c (Summary)
+@kindex B c @r{(Summary)}
 @cindex copy mail
 @findex gnus-summary-copy-article
 @c @icon{gnus-summary-mail-copy}
@@ -10659,7 +10651,7 @@ Copy the article from one group (mail group or not) to a mail group
 @code{gnus-preserve-marks} is non-@code{nil} (which is the default).
 
 @item B B
-@kindex B B (Summary)
+@kindex B B @r{(Summary)}
 @cindex crosspost mail
 @findex gnus-summary-crosspost-article
 Crosspost the current article to some other group
@@ -10668,21 +10660,21 @@ the article in the other group, and the Xref headers of the article will
 be properly updated.
 
 @item B i
-@kindex B i (Summary)
+@kindex B i @r{(Summary)}
 @findex gnus-summary-import-article
 Import an arbitrary file into the current mail newsgroup
 (@code{gnus-summary-import-article}).  You will be prompted for a file
 name, a @code{From} header and a @code{Subject} header.
 
 @item B I
-@kindex B I (Summary)
+@kindex B I @r{(Summary)}
 @findex gnus-summary-create-article
 Create an empty article in the current mail newsgroups
 (@code{gnus-summary-create-article}).  You will be prompted for a
 @code{From} header and a @code{Subject} header.
 
 @item B r
-@kindex B r (Summary)
+@kindex B r @r{(Summary)}
 @findex gnus-summary-respool-article
 @vindex gnus-summary-respool-default-method
 Respool the mail article (@code{gnus-summary-respool-article}).
@@ -10694,10 +10686,10 @@ Marks will be preserved if @code{gnus-preserve-marks} is non-@code{nil}
 
 @item B w
 @itemx e
-@kindex B w (Summary)
-@kindex e (Summary)
+@kindex B w @r{(Summary)}
+@kindex e @r{(Summary)}
 @findex gnus-summary-edit-article
-@kindex C-c C-c (Article)
+@kindex C-c C-c @r{(Article)}
 @findex gnus-summary-edit-article-done
 Edit the current article (@code{gnus-summary-edit-article}).  To finish
 editing and make the changes permanent, type @kbd{C-c C-c}
@@ -10705,20 +10697,20 @@ editing and make the changes permanent, type @kbd{C-c C-c}
 @kbd{C-c C-c} command, Gnus won't re-highlight the article.
 
 @item B q
-@kindex B q (Summary)
+@kindex B q @r{(Summary)}
 @findex gnus-summary-respool-query
 If you want to re-spool an article, you might be curious as to what group
 the article will end up in before you do the re-spooling.  This command
 will tell you (@code{gnus-summary-respool-query}).
 
 @item B t
-@kindex B t (Summary)
+@kindex B t @r{(Summary)}
 @findex gnus-summary-respool-trace
 Similarly, this command will display all fancy splitting patterns used
 when respooling, if any (@code{gnus-summary-respool-trace}).
 
 @item B p
-@kindex B p (Summary)
+@kindex B p @r{(Summary)}
 @findex gnus-summary-article-posted-p
 Some people have a tendency to send you ``courtesy'' copies when they
 follow up to articles you have posted.  These usually have a
@@ -10732,7 +10724,7 @@ propagation is much faster than news propagation, and the news copy may
 just not have arrived yet.
 
 @item K E
-@kindex K E (Summary)
+@kindex K E @r{(Summary)}
 @findex gnus-article-encrypt-body
 @vindex gnus-article-encrypt-protocol
 Encrypt the body of an article (@code{gnus-article-encrypt-body}).
@@ -10867,20 +10859,20 @@ Also @pxref{Group Parameters}.
 @table @kbd
 
 @item H d
-@kindex H d (Summary)
+@kindex H d @r{(Summary)}
 @findex gnus-summary-describe-group
 Give a brief description of the current group
 (@code{gnus-summary-describe-group}).  If given a prefix, force
 rereading the description from the server.
 
 @item H h
-@kindex H h (Summary)
+@kindex H h @r{(Summary)}
 @findex gnus-summary-describe-briefly
 Give an extremely brief description of the most important summary
 keystrokes (@code{gnus-summary-describe-briefly}).
 
 @item H i
-@kindex H i (Summary)
+@kindex H i @r{(Summary)}
 @findex gnus-info-find-node
 Go to the Gnus info node (@code{gnus-info-find-node}).
 @end table
@@ -10892,31 +10884,31 @@ Go to the Gnus info node (@code{gnus-info-find-node}).
 @table @kbd
 
 @item M-s
-@kindex M-s (Summary)
+@kindex M-s @r{(Summary)}
 @findex gnus-summary-search-article-forward
 Search through all subsequent (raw) articles for a regexp
 (@code{gnus-summary-search-article-forward}).
 
 @item M-r
-@kindex M-r (Summary)
+@kindex M-r @r{(Summary)}
 @findex gnus-summary-search-article-backward
 Search through all previous (raw) articles for a regexp
 (@code{gnus-summary-search-article-backward}).
 
 @item M-S
-@kindex M-S (Summary)
+@kindex M-S @r{(Summary)}
 @findex gnus-summary-repeat-search-article-forward
 Repeat the previous search forwards
 (@code{gnus-summary-repeat-search-article-forward}).
 
 @item M-R
-@kindex M-R (Summary)
+@kindex M-R @r{(Summary)}
 @findex gnus-summary-repeat-search-article-backward
 Repeat the previous search backwards
 (@code{gnus-summary-repeat-search-article-backward}).
 
 @item &
-@kindex & (Summary)
+@kindex & @r{(Summary)}
 @findex gnus-summary-execute-command
 This command will prompt you for a header, a regular expression to match
 on this field, and a command to be executed if the match is made
@@ -10924,11 +10916,12 @@ on this field, and a command to be executed if the match is made
 string, the match is done on the entire article.  If given a prefix,
 search backward instead.
 
-For instance, @kbd{& RET some.*string RET #} will put the process mark on
-all articles that have heads or bodies that match @samp{some.*string}.
+For instance, @kbd{& @key{RET} some.*string @key{RET} #} will put the
+process mark on all articles that have heads or bodies that match
+@samp{some.*string}.
 
 @item M-&
-@kindex M-& (Summary)
+@kindex M-& @r{(Summary)}
 @findex gnus-summary-universal-argument
 Perform any operation on all articles that have been marked with
 the process mark (@code{gnus-summary-universal-argument}).
@@ -10940,24 +10933,24 @@ the process mark (@code{gnus-summary-universal-argument}).
 @table @kbd
 
 @item Y g
-@kindex Y g (Summary)
+@kindex Y g @r{(Summary)}
 @findex gnus-summary-prepare
 Regenerate the current summary buffer (@code{gnus-summary-prepare}).
 
 @item Y c
-@kindex Y c (Summary)
+@kindex Y c @r{(Summary)}
 @findex gnus-summary-insert-cached-articles
 Pull all cached articles (for the current group) into the summary buffer
 (@code{gnus-summary-insert-cached-articles}).
 
 @item Y d
-@kindex Y d (Summary)
+@kindex Y d @r{(Summary)}
 @findex gnus-summary-insert-dormant-articles
 Pull all dormant articles (for the current group) into the summary buffer
 (@code{gnus-summary-insert-dormant-articles}).
 
 @item Y t
-@kindex Y t (Summary)
+@kindex Y t @r{(Summary)}
 @findex gnus-summary-insert-ticked-articles
 Pull all ticked articles (for the current group) into the summary buffer
 (@code{gnus-summary-insert-ticked-articles}).
@@ -10972,8 +10965,8 @@ Pull all ticked articles (for the current group) into the summary buffer
 
 @item A D
 @itemx C-d
-@kindex C-d (Summary)
-@kindex A D (Summary)
+@kindex C-d @r{(Summary)}
+@kindex A D @r{(Summary)}
 @findex gnus-summary-enter-digest-group
 If the current article is a collection of other articles (for instance,
 a digest), you might use this command to enter a group based on that
@@ -11007,7 +11000,7 @@ If it has any other value or there is no next (unread) article, the
 article selected before entering to the digest group will appear.
 
 @item C-M-d
-@kindex C-M-d (Summary)
+@kindex C-M-d @r{(Summary)}
 @findex gnus-summary-read-document
 This command is very similar to the one above, but lets you gather
 several documents into one biiig group
@@ -11018,7 +11011,7 @@ command understands the process/prefix convention
 (@pxref{Process/Prefix}).
 
 @item C-t
-@kindex C-t (Summary)
+@kindex C-t @r{(Summary)}
 @findex gnus-summary-toggle-truncation
 Toggle truncation of summary lines
 (@code{gnus-summary-toggle-truncation}).  This will probably confuse the
@@ -11026,19 +11019,19 @@ line centering function in the summary buffer, so it's not a good idea
 to have truncation switched off while reading articles.
 
 @item =
-@kindex = (Summary)
+@kindex = @r{(Summary)}
 @findex gnus-summary-expand-window
 Expand the summary buffer window (@code{gnus-summary-expand-window}).
 If given a prefix, force an @code{article} window configuration.
 
 @item C-M-e
-@kindex C-M-e (Summary)
+@kindex C-M-e @r{(Summary)}
 @findex gnus-summary-edit-parameters
 Edit the group parameters (@pxref{Group Parameters}) of the current
 group (@code{gnus-summary-edit-parameters}).
 
 @item C-M-a
-@kindex C-M-a (Summary)
+@kindex C-M-a @r{(Summary)}
 @findex gnus-summary-customize-parameters
 Customize the group parameters (@pxref{Group Parameters}) of the current
 group (@code{gnus-summary-customize-parameters}).
@@ -11059,9 +11052,9 @@ group and return you to the group buffer.
 @item Z Z
 @itemx Z Q
 @itemx q
-@kindex Z Z (Summary)
-@kindex Z Q (Summary)
-@kindex q (Summary)
+@kindex Z Z @r{(Summary)}
+@kindex Z Q @r{(Summary)}
+@kindex q @r{(Summary)}
 @findex gnus-summary-exit
 @vindex gnus-summary-exit-hook
 @vindex gnus-summary-prepare-exit-hook
@@ -11077,43 +11070,43 @@ group mode having no more (unread) groups.
 
 @item Z E
 @itemx Q
-@kindex Z E (Summary)
-@kindex Q (Summary)
+@kindex Z E @r{(Summary)}
+@kindex Q @r{(Summary)}
 @findex gnus-summary-exit-no-update
 Exit the current group without updating any information on the group
 (@code{gnus-summary-exit-no-update}).
 
 @item Z c
 @itemx c
-@kindex Z c (Summary)
-@kindex c (Summary)
+@kindex Z c @r{(Summary)}
+@kindex c @r{(Summary)}
 @findex gnus-summary-catchup-and-exit
 @c @icon{gnus-summary-catchup-and-exit}
 Mark all unticked articles in the group as read and then exit
 (@code{gnus-summary-catchup-and-exit}).
 
 @item Z C
-@kindex Z C (Summary)
+@kindex Z C @r{(Summary)}
 @findex gnus-summary-catchup-all-and-exit
 Mark all articles, even the ticked ones, as read and then exit
 (@code{gnus-summary-catchup-all-and-exit}).
 
 @item Z n
-@kindex Z n (Summary)
+@kindex Z n @r{(Summary)}
 @findex gnus-summary-catchup-and-goto-next-group
 Mark all articles as read and go to the next group
 (@code{gnus-summary-catchup-and-goto-next-group}).
 
 @item Z p
-@kindex Z p (Summary)
+@kindex Z p @r{(Summary)}
 @findex gnus-summary-catchup-and-goto-prev-group
 Mark all articles as read and go to the previous group
 (@code{gnus-summary-catchup-and-goto-prev-group}).
 
 @item Z R
 @itemx C-x C-s
-@kindex Z R (Summary)
-@kindex C-x C-s (Summary)
+@kindex Z R @r{(Summary)}
+@kindex C-x C-s @r{(Summary)}
 @findex gnus-summary-reselect-current-group
 Exit this group, and then enter it again
 (@code{gnus-summary-reselect-current-group}).  If given a prefix, select
@@ -11121,8 +11114,8 @@ all articles, both read and unread.
 
 @item Z G
 @itemx M-g
-@kindex Z G (Summary)
-@kindex M-g (Summary)
+@kindex Z G @r{(Summary)}
+@kindex M-g @r{(Summary)}
 @findex gnus-summary-rescan-group
 @c @icon{gnus-summary-mail-get}
 Exit the group, check for new articles in the group, and select the
@@ -11130,19 +11123,19 @@ group (@code{gnus-summary-rescan-group}).  If given a prefix, select all
 articles, both read and unread.
 
 @item Z N
-@kindex Z N (Summary)
+@kindex Z N @r{(Summary)}
 @findex gnus-summary-next-group
 Exit the group and go to the next group
 (@code{gnus-summary-next-group}).
 
 @item Z P
-@kindex Z P (Summary)
+@kindex Z P @r{(Summary)}
 @findex gnus-summary-prev-group
 Exit the group and go to the previous group
 (@code{gnus-summary-prev-group}).
 
 @item Z s
-@kindex Z s (Summary)
+@kindex Z s @r{(Summary)}
 @findex gnus-summary-save-newsrc
 Save the current number of read/marked articles in the dribble buffer
 and then save the dribble buffer (@code{gnus-summary-save-newsrc}).  If
@@ -11413,7 +11406,7 @@ encrypted messages up can be found in the message manual
 @cindex mailing list
 @cindex RFC 2396
 
-@kindex A M (summary)
+@kindex A M @r{(Summary)}
 @findex gnus-mailing-list-insinuate
 Gnus understands some mailing list fields of RFC 2369.  To enable it,
 add a @code{to-list} group parameter (@pxref{Group Parameters}),
@@ -11425,33 +11418,33 @@ That enables the following commands to the summary buffer:
 @table @kbd
 
 @item C-c C-n h
-@kindex C-c C-n h (Summary)
+@kindex C-c C-n h @r{(Summary)}
 @findex gnus-mailing-list-help
 Send a message to fetch mailing list help, if List-Help field exists.
 
 @item C-c C-n s
-@kindex C-c C-n s (Summary)
+@kindex C-c C-n s @r{(Summary)}
 @findex gnus-mailing-list-subscribe
 Send a message to subscribe the mailing list, if List-Subscribe field exists.
 
 @item C-c C-n u
-@kindex C-c C-n u (Summary)
+@kindex C-c C-n u @r{(Summary)}
 @findex gnus-mailing-list-unsubscribe
 Send a message to unsubscribe the mailing list, if List-Unsubscribe
 field exists.
 
 @item C-c C-n p
-@kindex C-c C-n p (Summary)
+@kindex C-c C-n p @r{(Summary)}
 @findex gnus-mailing-list-post
 Post to the mailing list, if List-Post field exists.
 
 @item C-c C-n o
-@kindex C-c C-n o (Summary)
+@kindex C-c C-n o @r{(Summary)}
 @findex gnus-mailing-list-owner
 Send a message to the mailing list owner, if List-Owner field exists.
 
 @item C-c C-n a
-@kindex C-c C-n a (Summary)
+@kindex C-c C-n a @r{(Summary)}
 @findex gnus-mailing-list-archive
 Browse the mailing list archive, if List-Archive field exists.
 
@@ -11629,9 +11622,9 @@ The following commands are available when you have placed point over a
 
 @table @kbd
 @findex gnus-article-press-button
-@item RET (Article)
-@kindex RET (Article)
-@itemx BUTTON-2 (Article)
+@item @key{RET} (Article)
+@kindex RET @r{(Article)}
+@itemx @key{BUTTON-2} (Article)
 Toggle displaying of the @acronym{MIME} object
 (@code{gnus-article-press-button}).  If built-in viewers can not display
 the object, Gnus resorts to external viewers in the @file{mailcap}
@@ -11639,33 +11632,33 @@ files.  If a viewer has the @samp{copiousoutput} specification, the
 object is displayed inline.
 
 @findex gnus-mime-view-part
-@item M-RET (Article)
-@kindex M-RET (Article)
+@item M-@key{RET} (Article)
+@kindex M-RET @r{(Article)}
 @itemx v (Article)
 Prompt for a method, and then view the @acronym{MIME} object using this
 method (@code{gnus-mime-view-part}).
 
 @findex gnus-mime-view-part-as-type
 @item t (Article)
-@kindex t (Article)
+@kindex t @r{(Article)}
 View the @acronym{MIME} object as if it were a different @acronym{MIME} media type
 (@code{gnus-mime-view-part-as-type}).
 
 @findex gnus-mime-view-part-as-charset
 @item C (Article)
-@kindex C (Article)
+@kindex C @r{(Article)}
 Prompt for a charset, and then view the @acronym{MIME} object using this
 charset (@code{gnus-mime-view-part-as-charset}).
 
 @findex gnus-mime-save-part
 @item o (Article)
-@kindex o (Article)
+@kindex o @r{(Article)}
 Prompt for a file name, and then save the @acronym{MIME} object
 (@code{gnus-mime-save-part}).
 
 @findex gnus-mime-save-part-and-strip
 @item C-o (Article)
-@kindex C-o (Article)
+@kindex C-o @r{(Article)}
 Prompt for a file name, then save the @acronym{MIME} object and strip it from
 the article.  Then proceed to article editing, where a reasonable
 suggestion is being made on how the altered article should look
@@ -11675,14 +11668,14 @@ message/external-body @acronym{MIME} type.
 
 @findex gnus-mime-replace-part
 @item r (Article)
-@kindex r (Article)
+@kindex r @r{(Article)}
 Prompt for a file name, replace the @acronym{MIME} object with an
 external body referring to the file via the message/external-body
 @acronym{MIME} type.  (@code{gnus-mime-replace-part}).
 
 @findex gnus-mime-delete-part
 @item d (Article)
-@kindex d (Article)
+@kindex d @r{(Article)}
 Delete the @acronym{MIME} object from the article and replace it with some
 information about the removed @acronym{MIME} object
 (@code{gnus-mime-delete-part}).
@@ -11691,7 +11684,7 @@ information about the removed @acronym{MIME} object
 
 @findex gnus-mime-copy-part
 @item c (Article)
-@kindex c (Article)
+@kindex c @r{(Article)}
 Copy the @acronym{MIME} object to a fresh buffer and display this buffer
 (@code{gnus-mime-copy-part}).  If given a prefix, copy the raw contents
 without decoding.  If given a numerical prefix, you can do semi-manual
@@ -11703,14 +11696,14 @@ Accessing Compressed Files, emacs, The Emacs Editor}).
 
 @findex gnus-mime-print-part
 @item p (Article)
-@kindex p (Article)
+@kindex p @r{(Article)}
 Print the @acronym{MIME} object (@code{gnus-mime-print-part}).  This
 command respects the @samp{print=} specifications in the
 @file{.mailcap} file.
 
 @findex gnus-mime-inline-part
 @item i (Article)
-@kindex i (Article)
+@kindex i @r{(Article)}
 Insert the contents of the @acronym{MIME} object into the buffer
 (@code{gnus-mime-inline-part}) as @samp{text/plain}.  If given a prefix, insert
 the raw contents without decoding.  If given a numerical prefix, you can
@@ -11723,25 +11716,25 @@ Compressed Files, emacs, The Emacs Editor}).
 
 @findex gnus-mime-view-part-internally
 @item E (Article)
-@kindex E (Article)
+@kindex E @r{(Article)}
 View the @acronym{MIME} object with an internal viewer.  If no internal
 viewer is available, use an external viewer
 (@code{gnus-mime-view-part-internally}).
 
 @findex gnus-mime-view-part-externally
 @item e (Article)
-@kindex e (Article)
+@kindex e @r{(Article)}
 View the @acronym{MIME} object with an external viewer.
 (@code{gnus-mime-view-part-externally}).
 
 @findex gnus-mime-pipe-part
 @item | (Article)
-@kindex | (Article)
+@kindex | @r{(Article)}
 Output the @acronym{MIME} object to a process (@code{gnus-mime-pipe-part}).
 
 @findex gnus-mime-action-on-part
 @item . (Article)
-@kindex . (Article)
+@kindex . @r{(Article)}
 Interactively run an action on the @acronym{MIME} object
 (@code{gnus-mime-action-on-part}).
 
@@ -11925,7 +11918,7 @@ controlling variable is a predicate list, as described above.
 
 @ifinfo
 @c Avoid sort of redundant entries in the same section for the printed
-@c manual, but add them in info to allow 'i gnus-treat-foo-bar RET' or
+@c manual, but add them in info to allow 'i gnus-treat-foo-bar @key{RET}' or
 @c 'i foo-bar'.
 @vindex gnus-treat-buttonize
 @vindex gnus-treat-buttonize-head
@@ -12130,7 +12123,7 @@ buffer, which means that you don't actually have to have a summary
 buffer displayed while reading.  You can do it all from the article
 buffer.
 
-@kindex v (Article)
+@kindex v @r{(Article)}
 @cindex keys, reserved for users (Article)
 The key @kbd{v} is reserved for users.  You can bind it to some
 command or better use it as a prefix key.
@@ -12139,70 +12132,70 @@ A few additional keystrokes are available:
 
 @table @kbd
 
-@item SPACE
-@kindex SPACE (Article)
+@item @key{SPC}
+@kindex SPC @r{(Article)}
 @findex gnus-article-next-page
 Scroll forwards one page (@code{gnus-article-next-page}).
-This is exactly the same as @kbd{h SPACE h}.
+This is exactly the same as @kbd{h @key{SPC} h}.
 
-@item DEL
-@kindex DEL (Article)
+@item @key{DEL}
+@kindex DEL @r{(Article)}
 @findex gnus-article-prev-page
 Scroll backwards one page (@code{gnus-article-prev-page}).
-This is exactly the same as @kbd{h DEL h}.
+This is exactly the same as @kbd{h @key{DEL} h}.
 
 @item C-c ^
-@kindex C-c ^ (Article)
+@kindex C-c ^ @r{(Article)}
 @findex gnus-article-refer-article
 If point is in the neighborhood of a @code{Message-ID} and you press
 @kbd{C-c ^}, Gnus will try to get that article from the server
 (@code{gnus-article-refer-article}).
 
 @item C-c C-m
-@kindex C-c C-m (Article)
+@kindex C-c C-m @r{(Article)}
 @findex gnus-article-mail
 Send a reply to the address near point (@code{gnus-article-mail}).  If
 given a prefix, include the mail.
 
 @item s
-@kindex s (Article)
+@kindex s @r{(Article)}
 @findex gnus-article-show-summary
 Reconfigure the buffers so that the summary buffer becomes visible
 (@code{gnus-article-show-summary}).
 
 @item ?
-@kindex ? (Article)
+@kindex ? @r{(Article)}
 @findex gnus-article-describe-briefly
 Give a very brief description of the available keystrokes
 (@code{gnus-article-describe-briefly}).
 
-@item TAB
-@kindex TAB (Article)
+@item @key{TAB}
+@kindex TAB @r{(Article)}
 @findex gnus-article-next-button
 Go to the next button, if any (@code{gnus-article-next-button}).  This
 only makes sense if you have buttonizing turned on.
 
-@item M-TAB
-@kindex M-TAB (Article)
+@item M-@key{TAB}
+@kindex M-TAB @r{(Article)}
 @findex gnus-article-prev-button
 Go to the previous button, if any (@code{gnus-article-prev-button}).
 
 @item R
-@kindex R (Article)
+@kindex R @r{(Article)}
 @findex gnus-article-reply-with-original
 Send a reply to the current article and yank the current article
 (@code{gnus-article-reply-with-original}).  If the region is active,
 only yank the text in the region.
 
 @item S W
-@kindex S W (Article)
+@kindex S W @r{(Article)}
 @findex gnus-article-wide-reply-with-original
 Send a wide reply to the current article and yank the current article
 (@code{gnus-article-wide-reply-with-original}).  If the region is
 active, only yank the text in the region.
 
 @item F
-@kindex F (Article)
+@kindex F @r{(Article)}
 @findex gnus-article-followup-with-original
 Send a followup to the current article and yank the current article
 (@code{gnus-article-followup-with-original}).  If the region is active,
@@ -12225,7 +12218,7 @@ If non-@code{nil}, use the same article buffer for all the groups.
 article buffer.
 
 @item gnus-widen-article-window
-@cindex gnus-widen-article-window
+@vindex gnus-widen-article-window
 If non-@code{nil}, selecting the article buffer with the @kbd{h}
 command will ``widen'' the article window to take the entire frame.
 
@@ -12348,7 +12341,7 @@ when @code{mm-text-html-renderer} (@pxref{Display Customization,
 @cindex using s/mime
 @cindex using smime
 
-@kindex C-c C-c (Post)
+@kindex C-c C-c @r{(Post)}
 All commands for posting and mailing will put you in a message buffer
 where you can edit the article all you like, before you send the
 article by pressing @kbd{C-c C-c}.  @xref{Top, , Overview, message,
@@ -12946,10 +12939,10 @@ correct parameters.  The content of the group is not lost.
 
 @c @findex gnus-dissociate-buffer-from-draft
 @c @kindex C-c M-d (Mail)
-@c @kindex C-c M-d (Post)
+@c @kindex C-c M-d @r{(Post)}
 @c @findex gnus-associate-buffer-with-draft
 @c @kindex C-c C-d (Mail)
-@c @kindex C-c C-d (Post)
+@c @kindex C-c C-d @r{(Post)}
 @c If you're writing some super-secret message that you later want to
 @c encode with PGP before sending, you may wish to turn the auto-saving
 @c (and association with the draft group) off.  You never know who might be
@@ -12964,7 +12957,7 @@ correct parameters.  The content of the group is not lost.
 @c @code{gnus-use-draft} to @code{nil}.  It is @code{t} by default.
 
 @findex gnus-draft-edit-message
-@kindex D e (Draft)
+@kindex D e @r{(Draft)}
 When you want to continue editing the article, you simply enter the
 draft group and push @kbd{D e} (@code{gnus-draft-edit-message}) to do
 that.  You will be placed in a buffer where you left off.
@@ -12973,9 +12966,9 @@ Rejected articles will also be put in this draft group (@pxref{Rejected
 Articles}).
 
 @findex gnus-draft-send-all-messages
-@kindex D s (Draft)
+@kindex D s @r{(Draft)}
 @findex gnus-draft-send-message
-@kindex D S (Draft)
+@kindex D S @r{(Draft)}
 If you have lots of rejected messages you want to post (or mail) without
 doing further editing, you can use the @kbd{D s} command
 (@code{gnus-draft-send-message}).  This command understands the
@@ -12984,12 +12977,12 @@ command (@code{gnus-draft-send-all-messages}) will ship off all messages
 in the buffer.
 
 @findex gnus-draft-toggle-sending
-@kindex D t (Draft)
+@kindex D t @r{(Draft)}
 If you have some messages that you wish not to send, you can use the
 @kbd{D t} (@code{gnus-draft-toggle-sending}) command to mark the message
 as unsendable.  This is a toggling command.
 
-Finally, if you want to delete a draft, use the normal @kbd{B DEL}
+Finally, if you want to delete a draft, use the normal @kbd{B @key{DEL}}
 command (@pxref{Mail Group Commands}).
 
 
@@ -13041,43 +13034,43 @@ signing and the @kbd{C-c C-m c} key map for encryption, as follows.
 @table @kbd
 
 @item C-c C-m s s
-@kindex C-c C-m s s (Message)
+@kindex C-c C-m s s @r{(Message)}
 @findex mml-secure-message-sign-smime
 
 Digitally sign current message using @acronym{S/MIME}.
 
 @item C-c C-m s o
-@kindex C-c C-m s o (Message)
+@kindex C-c C-m s o @r{(Message)}
 @findex mml-secure-message-sign-pgp
 
 Digitally sign current message using @acronym{PGP}.
 
 @item C-c C-m s p
-@kindex C-c C-m s p (Message)
+@kindex C-c C-m s p @r{(Message)}
 @findex mml-secure-message-sign-pgp
 
 Digitally sign current message using @acronym{PGP/MIME}.
 
 @item C-c C-m c s
-@kindex C-c C-m c s (Message)
+@kindex C-c C-m c s @r{(Message)}
 @findex mml-secure-message-encrypt-smime
 
 Digitally encrypt current message using @acronym{S/MIME}.
 
 @item C-c C-m c o
-@kindex C-c C-m c o (Message)
+@kindex C-c C-m c o @r{(Message)}
 @findex mml-secure-message-encrypt-pgp
 
 Digitally encrypt current message using @acronym{PGP}.
 
 @item C-c C-m c p
-@kindex C-c C-m c p (Message)
+@kindex C-c C-m c p @r{(Message)}
 @findex mml-secure-message-encrypt-pgpmime
 
 Digitally encrypt current message using @acronym{PGP/MIME}.
 
 @item C-c C-m C-n
-@kindex C-c C-m C-n (Message)
+@kindex C-c C-m C-n @r{(Message)}
 @findex mml-unsecure-message
 Remove security related @acronym{MML} tags from message.
 
@@ -13224,72 +13217,72 @@ in your init files.
 @table @kbd
 
 @item v
-@kindex v (Server)
+@kindex v @r{(Server)}
 @cindex keys, reserved for users (Server)
 The key @kbd{v} is reserved for users.  You can bind it to some
 command or better use it as a prefix key.
 
 @item a
-@kindex a (Server)
+@kindex a @r{(Server)}
 @findex gnus-server-add-server
 Add a new server (@code{gnus-server-add-server}).
 
 @item e
-@kindex e (Server)
+@kindex e @r{(Server)}
 @findex gnus-server-edit-server
 Edit a server (@code{gnus-server-edit-server}).
 
 @item S
-@kindex S (Server)
+@kindex S @r{(Server)}
 @findex gnus-server-show-server
 Show the definition of a server (@code{gnus-server-show-server}).
 
-@item SPACE
-@kindex SPACE (Server)
+@item @key{SPC}
+@kindex SPC @r{(Server)}
 @findex gnus-server-read-server
 Browse the current server (@code{gnus-server-read-server}).
 
 @item q
-@kindex q (Server)
+@kindex q @r{(Server)}
 @findex gnus-server-exit
 Return to the group buffer (@code{gnus-server-exit}).
 
 @item k
-@kindex k (Server)
+@kindex k @r{(Server)}
 @findex gnus-server-kill-server
 Kill the current server (@code{gnus-server-kill-server}).
 
 @item y
-@kindex y (Server)
+@kindex y @r{(Server)}
 @findex gnus-server-yank-server
 Yank the previously killed server (@code{gnus-server-yank-server}).
 
 @item c
-@kindex c (Server)
+@kindex c @r{(Server)}
 @findex gnus-server-copy-server
 Copy the current server (@code{gnus-server-copy-server}).
 
 @item l
-@kindex l (Server)
+@kindex l @r{(Server)}
 @findex gnus-server-list-servers
 List all servers (@code{gnus-server-list-servers}).
 
 @item s
-@kindex s (Server)
+@kindex s @r{(Server)}
 @findex gnus-server-scan-server
 Request that the server scan its sources for new articles
 (@code{gnus-server-scan-server}).  This is mainly sensible with mail
 servers.
 
 @item g
-@kindex g (Server)
+@kindex g @r{(Server)}
 @findex gnus-server-regenerate-server
 Request that the server regenerate all its data structures
 (@code{gnus-server-regenerate-server}).  This can be useful if you have
 a mail back end that has gotten out of sync.
 
 @item z
-@kindex z (Server)
+@kindex z @r{(Server)}
 @findex gnus-server-compact-server
 
 Compact all groups in the server under point
@@ -13421,7 +13414,7 @@ First you need to add a new server.  The @kbd{a} command does that.  It
 would probably be best to use @code{nnml} to read the cache.  You
 could also use @code{nnspool} or @code{nnmh}, though.
 
-Type @kbd{a nnml RET cache RET}.
+Type @kbd{a nnml @key{RET} cache @key{RET}}.
 
 You should now have a brand new @code{nnml} virtual server called
 @samp{cache}.  You now need to edit it to have the right definitions.
@@ -13441,7 +13434,7 @@ Change that to:
 @end lisp
 
 Type @kbd{C-c C-c} to return to the server buffer.  If you now press
-@kbd{RET} over this virtual server, you should be entered into a browse
+@kbd{@key{RET}} over this virtual server, you should be entered into a browse
 buffer, and you should be able to enter any of the groups displayed.
 
 
@@ -13512,44 +13505,44 @@ with the following commands:
 @table @kbd
 
 @item O
-@kindex O (Server)
+@kindex O @r{(Server)}
 @findex gnus-server-open-server
 Try to establish connection to the server on the current line
 (@code{gnus-server-open-server}).
 
 @item C
-@kindex C (Server)
+@kindex C @r{(Server)}
 @findex gnus-server-close-server
 Close the connection (if any) to the server
 (@code{gnus-server-close-server}).
 
 @item D
-@kindex D (Server)
+@kindex D @r{(Server)}
 @findex gnus-server-deny-server
 Mark the current server as unreachable
 (@code{gnus-server-deny-server}).  This will effectively disable the
 server.
 
 @item M-o
-@kindex M-o (Server)
+@kindex M-o @r{(Server)}
 @findex gnus-server-open-all-servers
 Open the connections to all servers in the buffer
 (@code{gnus-server-open-all-servers}).
 
 @item M-c
-@kindex M-c (Server)
+@kindex M-c @r{(Server)}
 @findex gnus-server-close-all-servers
 Close the connections to all servers in the buffer
 (@code{gnus-server-close-all-servers}).
 
 @item R
-@kindex R (Server)
+@kindex R @r{(Server)}
 @findex gnus-server-remove-denials
 Remove all marks to whether Gnus was denied connection from any servers
 (@code{gnus-server-remove-denials}).
 
 @item c
-@kindex c (Server)
+@kindex c @r{(Server)}
 @findex gnus-server-copy-server
 Copy a server and give it a new name
 (@code{gnus-server-copy-server}).  This can be useful if you have a
@@ -13557,7 +13550,7 @@ complex method definition, and want to use the same definition towards
 a different (physical) server.
 
 @item L
-@kindex L (Server)
+@kindex L @r{(Server)}
 @findex gnus-server-offline-server
 Set server status to offline (@code{gnus-server-offline-server}).
 
@@ -14565,7 +14558,7 @@ see @ref{Fancy Mail Splitting}.
 Note that the mail back ends are free to maul the poor, innocent,
 incoming headers all they want to.  They all add @code{Lines} headers;
 some add @code{X-Gnus-Group} headers; most rename the Unix mbox
-@code{From<SPACE>} line to something else.
+@code{From@key{SPC}} line to something else.
 
 @vindex nnmail-crosspost
 The mail back ends all support cross-posting.  If several regexps match,
@@ -14582,7 +14575,6 @@ links.  If that's the case for you, set
 @code{nnmail-crosspost-link-function} to @code{copy-file}.  (This
 variable is @code{add-name-to-file} by default.)
 
-@kindex M-x nnmail-split-history
 @findex nnmail-split-history
 If you wish to see where the previous mail split put the messages, you
 can use the @kbd{M-x nnmail-split-history} command.  If you wish to see
@@ -15721,7 +15713,7 @@ Type @kbd{G f} and give the file name to the mbox file when prompted to create a
 @code{nndoc} group from the mbox file (@pxref{Foreign Groups}).
 
 @item
-Type @kbd{SPACE} to enter the newly created group.
+Type @kbd{@key{SPC}} to enter the newly created group.
 
 @item
 Type @kbd{M P b} to process-mark all articles in this group's buffer
@@ -16036,7 +16028,7 @@ This can also be done non-destructively with
 
 @item nnmail-remove-tabs
 @findex nnmail-remove-tabs
-Translate all @samp{TAB} characters into @samp{SPACE} characters.
+Translate all @samp{@key{TAB}} characters into @samp{@key{SPC}} characters.
 
 @item nnmail-ignore-broken-references
 @findex nnmail-ignore-broken-references
@@ -16713,7 +16705,6 @@ The directory where the @acronym{NOV} files should be stored.  If
 
 
 @findex nnfolder-generate-active-file
-@kindex M-x nnfolder-generate-active-file
 If you have lots of @code{nnfolder}-like files you'd like to read with
 @code{nnfolder}, you can use the @kbd{M-x nnfolder-generate-active-file}
 command to make @code{nnfolder} aware of all likely files in
@@ -17062,14 +17053,14 @@ system because @acronym{RSS} uses UTF-8 for encoding non-@acronym{ASCII}
 text by default.  It is also used by default for non-@acronym{ASCII}
 group names.
 
-@kindex G R (Group)
+@kindex G R @r{(Group)}
 Use @kbd{G R} from the group buffer to subscribe to a feed---you will be
 prompted for the location, the title and the description of the feed.
 The title, which allows any characters, will be used for the group name
 and the name of the group data file.  The description can be omitted.
 
 An easy way to get started with @code{nnrss} is to say something like
-the following in the group buffer: @kbd{B nnrss RET RET y}, then
+the following in the group buffer: @kbd{B nnrss @key{RET} @key{RET} y}, then
 subscribe to groups.
 
 The @code{nnrss} back end saves the group data file in
@@ -18670,51 +18661,51 @@ The following commands are available in this buffer:
 
 @table @kbd
 @item q
-@kindex q (Category)
+@kindex q @r{(Category)}
 @findex gnus-category-exit
 Return to the group buffer (@code{gnus-category-exit}).
 
 @item e
-@kindex e (Category)
+@kindex e @r{(Category)}
 @findex gnus-category-customize-category
 Use a customization buffer to set all of the selected category's
 parameters at one time (@code{gnus-category-customize-category}).
 
 @item k
-@kindex k (Category)
+@kindex k @r{(Category)}
 @findex gnus-category-kill
 Kill the current category (@code{gnus-category-kill}).
 
 @item c
-@kindex c (Category)
+@kindex c @r{(Category)}
 @findex gnus-category-copy
 Copy the current category (@code{gnus-category-copy}).
 
 @item a
-@kindex a (Category)
+@kindex a @r{(Category)}
 @findex gnus-category-add
 Add a new category (@code{gnus-category-add}).
 
 @item p
-@kindex p (Category)
+@kindex p @r{(Category)}
 @findex gnus-category-edit-predicate
 Edit the predicate of the current category
 (@code{gnus-category-edit-predicate}).
 
 @item g
-@kindex g (Category)
+@kindex g @r{(Category)}
 @findex gnus-category-edit-groups
 Edit the list of groups belonging to the current category
 (@code{gnus-category-edit-groups}).
 
 @item s
-@kindex s (Category)
+@kindex s @r{(Category)}
 @findex gnus-category-edit-score
 Edit the download score rule of the current category
 (@code{gnus-category-edit-score}).
 
 @item l
-@kindex l (Category)
+@kindex l @r{(Category)}
 @findex gnus-category-list
 List all the categories (@code{gnus-category-list}).
 @end table
@@ -18788,7 +18779,7 @@ have to enable expiration in selected groups.
 @node Agent Commands
 @subsection Agent Commands
 @findex gnus-agent-toggle-plugged
-@kindex J j (Agent)
+@kindex J j @r{(Agent)}
 
 All the Gnus Agent commands are on the @kbd{J} submap.  The @kbd{J j}
 (@code{gnus-agent-toggle-plugged}) command works in all modes, and
@@ -18809,44 +18800,44 @@ toggles the plugged/unplugged state of the Gnus Agent.
 
 @table @kbd
 @item J u
-@kindex J u (Agent Group)
+@kindex J u @r{(Agent Group)}
 @findex gnus-agent-fetch-groups
 Fetch all eligible articles in the current group
 (@code{gnus-agent-fetch-groups}).
 
 @item J c
-@kindex J c (Agent Group)
+@kindex J c @r{(Agent Group)}
 @findex gnus-enter-category-buffer
 Enter the Agent category buffer (@code{gnus-enter-category-buffer}).
 
 @item J s
-@kindex J s (Agent Group)
+@kindex J s @r{(Agent Group)}
 @findex gnus-agent-fetch-session
 Fetch all eligible articles in all groups
 (@code{gnus-agent-fetch-session}).
 
 @item J S
-@kindex J S (Agent Group)
+@kindex J S @r{(Agent Group)}
 @findex gnus-group-send-queue
 Send all sendable messages in the queue group
 (@code{gnus-group-send-queue}).  @xref{Drafts}.
 
 @item J a
-@kindex J a (Agent Group)
+@kindex J a @r{(Agent Group)}
 @findex gnus-agent-add-group
 Add the current group to an Agent category
 (@code{gnus-agent-add-group}).  This command understands the
 process/prefix convention (@pxref{Process/Prefix}).
 
 @item J r
-@kindex J r (Agent Group)
+@kindex J r @r{(Agent Group)}
 @findex gnus-agent-remove-group
 Remove the current group from its category, if any
 (@code{gnus-agent-remove-group}).  This command understands the
 process/prefix convention (@pxref{Process/Prefix}).
 
 @item J Y
-@kindex J Y (Agent Group)
+@kindex J Y @r{(Agent Group)}
 @findex gnus-agent-synchronize-flags
 Synchronize flags changed while unplugged with remote server, if any.
 
@@ -18859,43 +18850,43 @@ Synchronize flags changed while unplugged with remote server, if any.
 
 @table @kbd
 @item J #
-@kindex J # (Agent Summary)
+@kindex J # @r{(Agent Summary)}
 @findex gnus-agent-mark-article
 Mark the article for downloading (@code{gnus-agent-mark-article}).
 
 @item J M-#
-@kindex J M-# (Agent Summary)
+@kindex J M-# @r{(Agent Summary)}
 @findex gnus-agent-unmark-article
 Remove the downloading mark from the article
 (@code{gnus-agent-unmark-article}).
 
 @cindex %
 @item @@
-@kindex @@ (Agent Summary)
+@kindex @@ @r{(Agent Summary)}
 @findex gnus-agent-toggle-mark
 Toggle whether to download the article
 (@code{gnus-agent-toggle-mark}).  The download mark is @samp{%} by
 default.
 
 @item J c
-@kindex J c (Agent Summary)
+@kindex J c @r{(Agent Summary)}
 @findex gnus-agent-catchup
 Mark all articles as read (@code{gnus-agent-catchup}) that are neither cached, downloaded, nor downloadable.
 
 @item J S
-@kindex J S (Agent Summary)
+@kindex J S @r{(Agent Summary)}
 @findex gnus-agent-fetch-group
 Download all eligible (@pxref{Agent Categories}) articles in this group.
 (@code{gnus-agent-fetch-group}).
 
 @item J s
-@kindex J s (Agent Summary)
+@kindex J s @r{(Agent Summary)}
 @findex gnus-agent-summary-fetch-series
 Download all processable articles in this group.
 (@code{gnus-agent-summary-fetch-series}).
 
 @item J u
-@kindex J u (Agent Summary)
+@kindex J u @r{(Agent Summary)}
 @findex gnus-agent-summary-fetch-group
 Download all downloadable articles in the current group
 (@code{gnus-agent-summary-fetch-group}).
@@ -18908,13 +18899,13 @@ Download all downloadable articles in the current group
 
 @table @kbd
 @item J a
-@kindex J a (Agent Server)
+@kindex J a @r{(Agent Server)}
 @findex gnus-agent-add-server
 Add the current server to the list of servers covered by the Gnus Agent
 (@code{gnus-agent-add-server}).
 
 @item J r
-@kindex J r (Agent Server)
+@kindex J r @r{(Agent Server)}
 @findex gnus-agent-remove-server
 Remove the current server from the list of servers covered by the Gnus
 Agent (@code{gnus-agent-remove-server}).
@@ -19015,8 +19006,6 @@ sense if you are using a nntp or nnimap back end.
 
 @vindex gnus-agent-expire-days
 @findex gnus-agent-expire
-@kindex M-x gnus-agent-expire
-@kindex M-x gnus-agent-expire-group
 @findex gnus-agent-expire-group
 @cindex agent expiry
 @cindex Gnus agent expiry
@@ -19070,14 +19059,12 @@ failure.  Running @code{gnus-agent-regenerate} or
 such that you don't need to download these articles a second time.
 
 @findex gnus-agent-regenerate
-@kindex M-x gnus-agent-regenerate
 The command @code{gnus-agent-regenerate} will perform
 @code{gnus-agent-regenerate-group} on every agentized group.  While
 you can run @code{gnus-agent-regenerate} in any buffer, it is strongly
 recommended that you first close all summary buffers.
 
 @findex gnus-agent-regenerate-group
-@kindex M-x gnus-agent-regenerate-group
 The command @code{gnus-agent-regenerate-group} uses the local copies
 of individual articles to repair the local @acronym{NOV}(header) database.  It
 then updates the internal data structures that document which articles
@@ -19463,18 +19450,18 @@ General score commands that don't actually change the score file:
 @table @kbd
 
 @item V s
-@kindex V s (Summary)
+@kindex V s @r{(Summary)}
 @findex gnus-summary-set-score
 Set the score of the current article (@code{gnus-summary-set-score}).
 
 @item V S
-@kindex V S (Summary)
+@kindex V S @r{(Summary)}
 @findex gnus-summary-current-score
 Display the score of the current article
 (@code{gnus-summary-current-score}).
 
 @item V t
-@kindex V t (Summary)
+@kindex V t @r{(Summary)}
 @findex gnus-score-find-trace
 Display all score rules that have been used on the current article
 (@code{gnus-score-find-trace}).  In the @file{*Score Trace*} buffer, you
@@ -19483,12 +19470,12 @@ current line and @kbd{f} to format (@code{gnus-score-pretty-print}) the
 score file and edit it.
 
 @item V w
-@kindex V w (Summary)
-@findex gnus-score-find-favourite-words
-List words used in scoring (@code{gnus-score-find-favourite-words}).
+@kindex V w @r{(Summary)}
+@findex gnus-score-find-favorite-words
+List words used in scoring (@code{gnus-score-find-favorite-words}).
 
 @item V R
-@kindex V R (Summary)
+@kindex V R @r{(Summary)}
 @findex gnus-summary-rescore
 Run the current summary through the scoring process
 (@code{gnus-summary-rescore}).  This might be useful if you're playing
@@ -19496,32 +19483,32 @@ around with your score files behind Gnus' back and want to see the
 effect you're having.
 
 @item V c
-@kindex V c (Summary)
+@kindex V c @r{(Summary)}
 @findex gnus-score-change-score-file
 Make a different score file the current
 (@code{gnus-score-change-score-file}).
 
 @item V e
-@kindex V e (Summary)
+@kindex V e @r{(Summary)}
 @findex gnus-score-edit-current-scores
 Edit the current score file (@code{gnus-score-edit-current-scores}).
 You will be popped into a @code{gnus-score-mode} buffer (@pxref{Score
 File Editing}).
 
 @item V f
-@kindex V f (Summary)
+@kindex V f @r{(Summary)}
 @findex gnus-score-edit-file
 Edit a score file and make this score file the current one
 (@code{gnus-score-edit-file}).
 
 @item V F
-@kindex V F (Summary)
+@kindex V F @r{(Summary)}
 @findex gnus-score-flush-cache
 Flush the score cache (@code{gnus-score-flush-cache}).  This is useful
 after editing score files.
 
 @item V C
-@kindex V C (Summary)
+@kindex V C @r{(Summary)}
 @findex gnus-score-customize
 Customize a score file in a visually pleasing manner
 (@code{gnus-score-customize}).
@@ -19533,13 +19520,13 @@ The rest of these commands modify the local score file.
 @table @kbd
 
 @item V m
-@kindex V m (Summary)
+@kindex V m @r{(Summary)}
 @findex gnus-score-set-mark-below
 Prompt for a score, and mark all articles with a score below this as
 read (@code{gnus-score-set-mark-below}).
 
 @item V x
-@kindex V x (Summary)
+@kindex V x @r{(Summary)}
 @findex gnus-score-set-expunge-below
 Prompt for a score, and add a score rule to the current score file to
 expunge all articles below this score
@@ -19674,7 +19661,7 @@ Immediately scoring.
 @item
 If you are scoring on @samp{e} (extra) headers, you will then be prompted for
 the header name on which you wish to score.  This must be a header named
-in gnus-extra-headers, and @samp{TAB} completion is available.
+in gnus-extra-headers, and @samp{@key{TAB}} completion is available.
 
 @end enumerate
 
@@ -19709,13 +19696,13 @@ There aren't many of these as yet, I'm afraid.
 @table @kbd
 
 @item W e
-@kindex W e (Group)
+@kindex W e @r{(Group)}
 @findex gnus-score-edit-all-score
 Edit the apply-to-all-groups all.SCORE file.  You will be popped into
 a @code{gnus-score-mode} buffer (@pxref{Score File Editing}).
 
 @item W f
-@kindex W f (Group)
+@kindex W f @r{(Group)}
 @findex gnus-score-flush-cache
 Gnus maintains a cache of score alists to avoid having to reload them
 all the time.  This command will flush the cache
@@ -20199,20 +20186,20 @@ additional commands:
 @table @kbd
 
 @item C-c C-c
-@kindex C-c C-c (Score)
+@kindex C-c C-c @r{(Score)}
 @findex gnus-score-edit-exit
 Save the changes you have made and return to the summary buffer
 (@code{gnus-score-edit-exit}).
 
 @item C-c C-d
-@kindex C-c C-d (Score)
+@kindex C-c C-d @r{(Score)}
 @findex gnus-score-edit-insert-date
 Insert the current date in numerical format
 (@code{gnus-score-edit-insert-date}).  This is really the day number, if
 you were wondering.
 
 @item C-c C-p
-@kindex C-c C-p (Score)
+@kindex C-c C-p @r{(Score)}
 @findex gnus-score-pretty-print
 The adaptive score files are saved in an unformatted fashion.  If you
 intend to read one of these files, you want to @dfn{pretty print} it
@@ -20578,7 +20565,7 @@ Restart Gnus and rebuild your @code{nnml} overview files with the
 time if you have much mail.
 
 Now you can score on @samp{To} and @samp{Cc} as ``extra headers'' like
-so: @kbd{I e s p To RET <your name> RET}.
+so: @kbd{I e s p To @key{RET} <your name> @key{RET}}.
 
 See?  Simple.
 
@@ -20765,12 +20752,12 @@ Two summary functions for editing a @sc{gnus} kill file:
 @table @kbd
 
 @item M-k
-@kindex M-k (Summary)
+@kindex M-k @r{(Summary)}
 @findex gnus-summary-edit-local-kill
 Edit this group's kill file (@code{gnus-summary-edit-local-kill}).
 
 @item M-K
-@kindex M-K (Summary)
+@kindex M-K @r{(Summary)}
 @findex gnus-summary-edit-global-kill
 Edit the general kill file (@code{gnus-summary-edit-global-kill}).
 @end table
@@ -20780,12 +20767,12 @@ Two group mode functions for editing the kill files:
 @table @kbd
 
 @item M-k
-@kindex M-k (Group)
+@kindex M-k @r{(Group)}
 @findex gnus-group-edit-local-kill
 Edit this group's kill file (@code{gnus-group-edit-local-kill}).
 
 @item M-K
-@kindex M-K (Group)
+@kindex M-K @r{(Group)}
 @findex gnus-group-edit-global-kill
 Edit the general kill file (@code{gnus-group-edit-global-kill}).
 @end table
@@ -21725,7 +21712,7 @@ want.
 @item
 The name of the @strong{back end server} where mairix should store its
 searches.  This must be a full server name, like @code{nnml:mymail}.
-Just hit @kbd{TAB} to see the available servers.  Currently, servers
+Just hit @kbd{@key{TAB}} to see the available servers.  Currently, servers
 which are accessed through @code{nnmaildir}, @code{nnimap} and
 @code{nnml} are supported.  As explained above, for locally stored
 mails, this can be an existing server where you store your mails.
@@ -21770,34 +21757,34 @@ In group mode:
 @table @kbd
 
 @item G b c
-@kindex G b c (Group)
+@kindex G b c @r{(Group)}
 @findex nnmairix-create-server-and-default-group
 Creates @code{nnmairix} server and default search group for this server
 (@code{nnmairix-create-server-and-default-group}).  You should have done
 this by now (@pxref{Configuring nnmairix}).
 
 @item G b s
-@kindex G b s (Group)
+@kindex G b s @r{(Group)}
 @findex nnmairix-search
 Prompts for query which is then sent to the mairix binary.  Search
 results are put into the default search group which is automatically
 displayed (@code{nnmairix-search}).
 
 @item G b m
-@kindex G b m (Group)
+@kindex G b m @r{(Group)}
 @findex nnmairix-widget-search
 Allows you to create a mairix search or a permanent group more
 comfortably using graphical widgets, similar to a customization
 group.  Just try it to see how it works (@code{nnmairix-widget-search}).
 
 @item G b i
-@kindex G b i (Group)
+@kindex G b i @r{(Group)}
 @findex nnmairix-search-interactive
 Another command for creating a mairix query more comfortably, but uses
 only the minibuffer (@code{nnmairix-search-interactive}).
 
 @item G b g
-@kindex G b g (Group)
+@kindex G b g @r{(Group)}
 @findex nnmairix-create-search-group
 Creates a permanent group which is associated with a search query
 (@code{nnmairix-create-search-group}).  The @code{nnmairix} back end
@@ -21805,20 +21792,20 @@ automatically calls mairix when you update this group with @kbd{g} or
 @kbd{M-g}.
 
 @item G b q
-@kindex G b q (Group)
+@kindex G b q @r{(Group)}
 @findex nnmairix-group-change-query-this-group
 Changes the search query for the @code{nnmairix} group under cursor
 (@code{nnmairix-group-change-query-this-group}).
 
 @item G b t
-@kindex G b t (Group)
+@kindex G b t @r{(Group)}
 @findex nnmairix-group-toggle-threads-this-group
 Toggles the 'threads' parameter for the @code{nnmairix} group under cursor,
 i.e., if you want see the whole threads of the found messages
 (@code{nnmairix-group-toggle-threads-this-group}).
 
 @item G b u
-@kindex G b u (Group)
+@kindex G b u @r{(Group)}
 @findex nnmairix-update-database
 @vindex nnmairix-mairix-update-options
 Calls mairix binary for updating the database
@@ -21828,20 +21815,20 @@ and @code{-Q} for making this as fast as possible (see variable
 options).
 
 @item G b r
-@kindex G b r (Group)
+@kindex G b r @r{(Group)}
 @findex nnmairix-group-toggle-readmarks-this-group
 Keep articles in this @code{nnmairix} group always read or unread, or leave the
 marks unchanged (@code{nnmairix-group-toggle-readmarks-this-group}).
 
 @item G b d
-@kindex G b d (Group)
+@kindex G b d @r{(Group)}
 @findex nnmairix-group-delete-recreate-this-group
 Recreate @code{nnmairix} group on the ``real'' mail back end
 (@code{nnmairix-group-delete-recreate-this-group}).  You can do this if
 you always get wrong article counts with a @code{nnmairix} group.
 
 @item G b a
-@kindex G b a (Group)
+@kindex G b a @r{(Group)}
 @findex nnmairix-group-toggle-allowfast-this-group
 Toggles the @code{allow-fast} parameters for group under cursor
 (@code{nnmairix-group-toggle-allowfast-this-group}).  The default
@@ -21853,14 +21840,14 @@ lead to dangling symlinks if something changed between updating and
 entering the group which is not yet in the mairix database.
 
 @item G b p
-@kindex G b p (Group)
+@kindex G b p @r{(Group)}
 @findex nnmairix-group-toggle-propmarks-this-group
 Toggle marks propagation for this group
 (@code{nnmairix-group-toggle-propmarks-this-group}).  (@pxref{Propagating
 marks}).
 
 @item G b o
-@kindex G b o (Group)
+@kindex G b o @r{(Group)}
 @findex nnmairix-propagate-marks
 Manually propagate marks (@code{nnmairix-propagate-marks}); needed only when
 @code{nnmairix-propagate-marks-upon-close} is set to @code{nil}.
@@ -21872,21 +21859,21 @@ In summary mode:
 @table @kbd
 
 @item G G m
-@kindex G G m (Summary)
+@kindex G G m @r{(Summary)}
 @findex nnmairix-widget-search-from-this-article
 Allows you to create a mairix query or group based on the current
 message using graphical widgets (same as @code{nnmairix-widget-search})
 (@code{nnmairix-widget-search-from-this-article}).
 
 @item G G g
-@kindex G G g (Summary)
+@kindex G G g @r{(Summary)}
 @findex nnmairix-create-search-group-from-message
 Interactively creates a new search group with query based on the current
 message, but uses the minibuffer instead of graphical widgets
 (@code{nnmairix-create-search-group-from-message}).
 
 @item G G t
-@kindex G G t (Summary)
+@kindex G G t @r{(Summary)}
 @findex nnmairix-search-thread-this-article
 Searches thread for the current article
 (@code{nnmairix-search-thread-this-article}).  This is effectively a
@@ -21894,14 +21881,14 @@ shortcut for calling @code{nnmairix-search} with @samp{m:msgid} of the
 current article and enabled threads.
 
 @item G G f
-@kindex G G f (Summary)
+@kindex G G f @r{(Summary)}
 @findex nnmairix-search-from-this-article
 Searches all messages from sender of the current article
 (@code{nnmairix-search-from-this-article}).  This is a shortcut for
 calling @code{nnmairix-search} with @samp{f:From}.
 
 @item G G o
-@kindex G G o (Summary)
+@kindex G G o @r{(Summary)}
 @findex nnmairix-goto-original-article
 (Only in @code{nnmairix} groups!) Tries determine the group this article
 originally came from and displays the article in this group, so that,
@@ -21911,7 +21898,7 @@ function will use the registry if available, but can also parse the
 article file name as a fallback method.
 
 @item G G u
-@kindex G G u (Summary)
+@kindex G G u @r{(Summary)}
 @findex nnmairix-remove-tick-mark-original-article
 Remove possibly existing tick mark from original article
 (@code{nnmairix-remove-tick-mark-original-article}).  (@pxref{nnmairix
@@ -22334,7 +22321,7 @@ for instance.  But what if you want to save without making a backup
 file, and you want Emacs to flash lights and play a nice tune at the
 same time?  You can't, and you're probably perfectly happy that way.
 
-@kindex M-i (Summary)
+@kindex M-i @r{(Summary)}
 @findex gnus-symbolic-argument
 I'm not, so I've added a second prefix---the @dfn{symbolic prefix}.  The
 prefix key is @kbd{M-i} (@code{gnus-symbolic-argument}), and the next
@@ -22390,7 +22377,6 @@ Currently Gnus uses the following formatting variables:
 All these format variables can also be arbitrary elisp forms.  In that
 case, they will be @code{eval}ed to insert the required lines.
 
-@kindex M-x gnus-update-format
 @findex gnus-update-format
 Gnus includes a command to help you while creating your own format
 specs.  @kbd{M-x gnus-update-format} will @code{eval} the current form,
@@ -24292,10 +24278,10 @@ group:
 @itemx M-d
 @itemx M s x
 @itemx S x
-@kindex $ (Summary)
-@kindex M-d (Summary)
-@kindex S x (Summary)
-@kindex M s x (Summary)
+@kindex $ @r{(Summary)}
+@kindex M-d @r{(Summary)}
+@kindex S x @r{(Summary)}
+@kindex M s x @r{(Summary)}
 @findex gnus-summary-mark-as-spam
 @findex gnus-summary-mark-as-spam
 Mark current article as spam, showing it with the @samp{$} mark
@@ -24567,7 +24553,7 @@ determined by either the @code{ham-process-destination} group
 parameter or a match in the @code{gnus-ham-process-destinations}
 variable, which is a list of regular expressions matched with group
 names (it's easiest to customize this variable with @kbd{M-x
-customize-variable @key{RET} gnus-ham-process-destinations}).  Each
+customize-variable @key{@key{RET}} gnus-ham-process-destinations}).  Each
 group name list is a standard Lisp list, if you prefer to customize
 the variable manually.  If the @code{ham-process-destination}
 parameter is not set, ham articles are left in place.  If the
@@ -24603,7 +24589,7 @@ When you leave a @emph{ham} or @emph{unclassified} group, all
 the @code{spam-process-destination} group parameter or a match in the
 @code{gnus-spam-process-destinations} variable, which is a list of
 regular expressions matched with group names (it's easiest to
-customize this variable with @kbd{M-x customize-variable @key{RET}
+customize this variable with @kbd{M-x customize-variable @key{@key{RET}}
 gnus-spam-process-destinations}).  Each group name list is a standard
 Lisp list, if you prefer to customize the variable manually.  If the
 @code{spam-process-destination} parameter is not set, the spam
@@ -26235,7 +26221,7 @@ you to optionally upload your first CloudSynchronizationDataPack(TM).
 After setting up, you can use these shortcuts from the Group buffer:
 
 @table @kbd
-@item ~ RET
+@item ~ @key{RET}
 @item ~ d
 @findex gnus-cloud-download-all-data
 @cindex cloud, download
@@ -26670,7 +26656,6 @@ to stop doing it the old way.
 
 Gnus understands all @sc{gnus} startup files.
 
-@kindex M-x gnus-bug
 @findex gnus-bug
 @cindex reporting bugs
 @cindex bugs
@@ -27749,7 +27734,7 @@ control over simplification.
 limit.
 
 @item
-@kbd{M-RET} is a new Message command for breaking cited text.
+@kbd{M-@key{RET}} is a new Message command for breaking cited text.
 
 @item
 @samp{\\1}-expressions are now valid in @code{nnmail-split-methods}.
@@ -28304,10 +28289,10 @@ Easy inclusion of X-Faces headers.  @xref{X-Face}.
 @item
 Group Carbon Copy (GCC) quoting
 
-To support groups that contains SPC and other weird characters, groups
+To support groups that contains @key{SPC} and other weird characters, groups
 are quoted before they are placed in the Gcc: header.  This means
 variables such as @code{gnus-message-archive-group} should no longer
-contain quote characters to make groups containing SPC work.  Also, if
+contain quote characters to make groups containing @key{SPC} work.  Also, if
 you are using the string @samp{nnml:foo, nnml:bar} (indicating Gcc
 into two groups) you must change it to return the list
 @code{("nnml:foo" "nnml:bar")}, otherwise the Gcc: line will be quoted
@@ -28396,7 +28381,7 @@ Gnus supports @acronym{PGP} (RFC 1991/2440), @acronym{PGP/MIME} (RFC
 
 It needs an external @acronym{S/MIME} and OpenPGP implementation, but no
 additional Lisp libraries.  This add several menu items to the
-Attachments menu, and @kbd{C-c RET} key bindings, when composing
+Attachments menu, and @kbd{C-c @key{RET}} key bindings, when composing
 messages.  This also obsoletes @code{gnus-article-hide-pgp-hook}.
 
 @item
@@ -28492,7 +28477,7 @@ message, Message Manual}).
 @item
 The tool bars have been updated to use GNOME icons in Group, Summary and
 Message mode.  You can also customize the tool bars: @kbd{M-x
-customize-apropos RET -tool-bar$} should get you started.  This is a new
+customize-apropos @key{RET} -tool-bar$} should get you started.  This is a new
 feature in Gnus 5.10.10.  (Only for Emacs, not in XEmacs.)
 
 @item The tool bar icons are now (de)activated correctly
@@ -28723,7 +28708,7 @@ commonly fetched via the protocol @acronym{NNTP}, whereas mail
 messages could be read from a file on the local disk.  The internal
 architecture of Gnus thus comprises a ``front end'' and a number of
 ``back ends''.  Internally, when you enter a group (by hitting
-@key{RET}, say), you thereby invoke a function in the front end in
+@key{@key{RET}}, say), you thereby invoke a function in the front end in
 Gnus.  The front end then ``talks'' to a back end and says things like
 ``Give me the list of articles in the foo group'' or ``Show me article
 number 4711''.
@@ -29125,12 +29110,12 @@ If all else fails, report the problem as a bug.
 @cindex bugs
 @cindex reporting bugs
 
-@kindex M-x gnus-bug
 @findex gnus-bug
-If you find a bug in Gnus, you can report it with the @kbd{M-x gnus-bug}
-command.  @kbd{M-x set-variable RET debug-on-error RET t RET}, and send
-me the backtrace.  I will fix bugs, but I can only fix them if you send
-me a precise description as to how to reproduce the bug.
+If you find a bug in Gnus, you can report it with the @kbd{M-x
+gnus-bug} command.  @kbd{M-x set-variable @key{RET} debug-on-error
+@key{RET} t @key{RET}}, and send me the backtrace.  I will fix bugs,
+but I can only fix them if you send me a precise description as to how
+to reproduce the bug.
 
 You really can never be too detailed in a bug report.  Always use the
 @kbd{M-x gnus-bug} command when you make bug reports, even if it creates
@@ -29163,9 +29148,9 @@ Lisp Reference Manual}).  To get you started with edebug, consider if
 you discover some weird behavior when pressing @kbd{c}, the first
 step is to do @kbd{C-h k c} and click on the hyperlink (Emacs only) in
 the documentation buffer that leads you to the function definition,
-then press @kbd{M-x edebug-defun RET} with point inside that function,
+then press @kbd{M-x edebug-defun @key{RET}} with point inside that function,
 return to Gnus and press @kbd{c} to invoke the code.  You will be
-placed in the lisp buffer and can single step using @kbd{SPC} and
+placed in the lisp buffer and can single step using @kbd{@key{SPC}} and
 evaluate expressions using @kbd{M-:} or inspect variables using
 @kbd{C-h v}, abort execution with @kbd{q}, and resume execution with
 @kbd{c} or @kbd{g}.
@@ -29183,8 +29168,8 @@ A fancier approach is to use the elisp profiler, ELP@.  The profiler is
 (or should be) fully documented elsewhere, but to get you started
 there are a few steps that need to be followed.  First, instrument the
 part of Gnus you are interested in for profiling, e.g., @kbd{M-x
-elp-instrument-package RET gnus} or @kbd{M-x elp-instrument-package
-RET message}.  Then perform the operation that is slow and press
+elp-instrument-package @key{RET} gnus} or @kbd{M-x elp-instrument-package
+@key{RET} message}.  Then perform the operation that is slow and press
 @kbd{M-x elp-results}.  You will then see which operations that takes
 time, and can debug them further.  If the entire operation takes much
 longer than the time spent in the slowest function in the profiler
diff --git a/doc/misc/htmlfontify.texi b/doc/misc/htmlfontify.texi
index 9f1d1b4ee3..c4cf7dac0a 100644
--- a/doc/misc/htmlfontify.texi
+++ b/doc/misc/htmlfontify.texi
@@ -1116,7 +1116,7 @@ Some of the (informal) data structures used in Htmlfontify are detailed here:
 @table @code
 
 @item hfy-style-assoc
-@cindex hfy-style-assoc
+@cindex @code{hfy-style-assoc}
 @anchor{hfy-style-assoc}
 
 An assoc representing/describing an Emacs face.  Properties may be repeated,
@@ -1148,7 +1148,7 @@ Some examples:
 @end lisp
 
 @item hfy-sheet-assoc
-@cindex hfy-sheet-assoc
+@cindex @code{hfy-sheet-assoc}
 @anchor{hfy-sheet-assoc}
 
 An assoc with elements of the form @samp{(face-name style-name . style-string)}.
@@ -1160,7 +1160,7 @@ The actual stylesheet for each page is derived from one of these.
 @end lisp
 
 @item hfy-facemap-assoc
-@cindex hfy-facemap-assoc
+@cindex @code{hfy-facemap-assoc}
 @anchor{hfy-facemap-assoc}
 
 An assoc of @code{(point . @var{face-symbol})} or
@@ -1379,9 +1379,9 @@ For example, I customize this to:
 ((t :background "black" :foreground "white" :family "misc-fixed"))
 @end lisp
 
-@item hfy-init-kludge-hooks
-@vindex hfy-init-kludge-hooks
-@anchor{hfy-init-kludge-hooks}
+@item hfy-init-kludge-hook
+@vindex hfy-init-kludge-hook
+@anchor{hfy-init-kludge-hook}
 
 List of functions to call when starting htmlfontify-buffer to do any
 kludging necessary to get highlighting modes to behave as you want, even
diff --git a/doc/misc/idlwave.texi b/doc/misc/idlwave.texi
index c37ca16b0c..204a449925 100644
--- a/doc/misc/idlwave.texi
+++ b/doc/misc/idlwave.texi
@@ -172,7 +172,7 @@ Catalogs
 @cindex CORBA (Common Object Request Broker Architecture)
 @cindex Interface Definition Language
 @cindex Interactive Data Language
-@cindex cc-mode.el
+@cindex @file{cc-mode.el}
 @cindex @file{idl.el}
 @cindex @file{idl-shell.el}
 @cindex Feature overview
@@ -935,7 +935,7 @@ IDL code.
 @cindex String splitting
 @cindex Splitting, of lines
 
-@kindex M-@key{RET}
+@kindex M-RET
 In IDL, a newline character terminates a statement unless preceded by a
 @samp{$}.  If you would like to start a continuation line, use
 @kbd{M-@key{RET}}, which calls the command @code{idlwave-split-line}.
@@ -1523,7 +1523,7 @@ The case-insensitive heading word in doclib headers to locate the
 @cindex Function name completion
 @cindex Procedure name completion
 
-@kindex M-@key{TAB}
+@kindex M-TAB
 @kindex C-c C-i
 IDLWAVE offers completion for class names, routine names, keywords,
 system variables, system variable tags, class structure tags, regular
@@ -4064,7 +4064,7 @@ sure you check the following things:
 @itemize @bullet
 @item When you download the IDLWAVE distribution, make sure you save the
 file under the names @file{idlwave.tar.gz}.
-@item M-TAB switches among running programs---use Esc-TAB
+@item M-@key{TAB} switches among running programs---use @key{ESC}-@key{TAB}
 instead.
 @item Other issues as yet unnamed...
 @end itemize
diff --git a/doc/misc/ido.texi b/doc/misc/ido.texi
index 6666c53410..4ff978ee79 100644
--- a/doc/misc/ido.texi
+++ b/doc/misc/ido.texi
@@ -456,14 +456,14 @@ You can toggle display of the hidden buffers and files with @kbd{C-a}
 You can customize the @code{ido} group to change Ido functionality:
 
 @example
-M-x customize-group RET ido RET
+M-x customize-group @key{RET} ido @key{RET}
 @end example
 
 @noindent
 or customize a certain variable:
 
 @example
-M-x customize-variable RET ido-xxxxx
+M-x customize-variable @key{RET} ido-xxxxx @key{RET}
 @end example
 
 To modify the keybindings, use the @code{ido-setup-hook}.  For example:
diff --git a/doc/misc/mairix-el.texi b/doc/misc/mairix-el.texi
index 906448c102..8d620c720e 100644
--- a/doc/misc/mairix-el.texi
+++ b/doc/misc/mairix-el.texi
@@ -169,13 +169,13 @@ the updates incrementally and hence is very fast.
 
 First, put @code{mairix.el} in your Emacs search path and put
 @code{(require 'mairix)} into your @file{.emacs} file.  Then, use
-@kbd{M-x customize-group mairix RET} to set your preferences for
-mairix.el.  The most important items are @emph{Mairix File Path},
-@emph{Mairix Search File} and @emph{Mairix Mail Program}.  The latter
-specifies which mail program should be used to display the mairix search
-results.  Currently, RMail, Gnus with mbox files, and VM are supported.
-If you use Gnus with maildir or mh, use the native Gnus back end
-nnmairix instead.
+@kbd{M-x customize-group @key{RET} mairix @key{RET}} to set your
+preferences for mairix.el.  The most important items are @emph{Mairix
+File Path}, @emph{Mairix Search File} and @emph{Mairix Mail Program}.
+The latter specifies which mail program should be used to display the
+mairix search results.  Currently, RMail, Gnus with mbox files, and VM
+are supported.  If you use Gnus with maildir or mh, use the native
+Gnus back end nnmairix instead.
 
 If you use another Emacs mail program which is not yet supported by
 mairix.el, it is pretty easy to integrate it.  @xref{Extending},
@@ -213,7 +213,6 @@ Here's a description of the available interactive functions:
 @table @code
 
 @item mairix-search
-@kindex M-x mairix-search
 @findex mairix-search
 @vindex mairix-search-file
 @vindex mairix-file-path
@@ -229,7 +228,6 @@ is specified by the variable @code{mairix-command}, together with the options
 for making searching faster.
 
 @item mairix-widget-search
-@kindex M-x mairix-widget-search
 @findex mairix-widget-search
 @vindex mairix-widget-fields-list
 Creates a mairix query using graphical widgets.  Very handy if you're
@@ -241,28 +239,24 @@ might want to include some other fields.  This can be easily done by
 modifying @code{mairix-widget-fields-list}.
 
 @item mairix-widget-search-based-on-article
-@kindex M-x mairix-widget-search-based-on-article
 @findex mairix-widget-search-based-on-article
 Create a mairix query using graphical widgets, but based on the
 currently displayed article, i.e., the available fields will be filled
 with the current header values.
 
 @item mairix-search-from-this-article
-@kindex M-x mairix-search-from-this-article
 @findex mairix-search-from-this-article
 Search messages from sender of the current article.  This is effectively
 a shortcut for calling @code{mairix-search} with @code{f:current_from}.
 If used with a prefix, include whole threads of the found messages.
 
 @item mairix-search-thread-this-article
-@kindex M-x mairix-search-thread-this-article
 @findex mairix-search-thread-this-article
 Search thread for the current article.  This is effectively a shortcut
 for calling @code{mairix-search} with @code{m:msgid} of the current article and
 enabled threads.
 
 @item mairix-save-search
-@kindex M-x mairix-save-search
 @findex mairix-save-search
 Save the last search for future use.  You will have to specify a name
 for the search and will then be asked if you want to save your saved
@@ -272,13 +266,11 @@ your @file{.emacs}.  You can also do this later by using
 @code{mairix-edit-saved-searches}.
 
 @item mairix-use-saved-search
-@kindex M-x mairix-use-saved-search
 @findex mairix-use-saved-search
 Call mairix with a previously saved search.  You will be asked for the
 name of the saved search (use @kbd{TAB} for completion).
 
 @item mairix-edit-saved-searches
-@kindex M-x mairix-edit-saved-searches
 @findex mairix-edit-saved-searches
 Edit your current mairix searches.  This is a simple major mode for
 editing the contents of the variable @code{mairix-saved-searches}.  You
@@ -290,14 +282,12 @@ to open different searches at the same time, or if you want to regularly
 access certain searches without the need to call mairix.
 
 @item mairix-edit-saved-searches-customize
-@kindex M-x mairix-edit-saved-searches-customize
 @findex mairix-edit-saved-searches-customize
 Edit the variable @code{mairix-saved-searches} in a normal customization
 buffer.  This function exists more or less for historic reasons, but
 maybe you like it.
 
 @item mairix-update-database
-@kindex M-x mairix-update-database
 @findex mairix-update-database
 @vindex mairix-update-options
 @vindex mairix-synchronous-update
diff --git a/doc/misc/message.texi b/doc/misc/message.texi
index 1ef67fe0cb..0a2a6ce49d 100644
--- a/doc/misc/message.texi
+++ b/doc/misc/message.texi
@@ -104,7 +104,7 @@ sending it.
 @end menu
 
 You can customize the Message Mode tool bar, see @kbd{M-x
-customize-apropos RET message-tool-bar}.  This feature is only available
+customize-apropos @key{RET} message-tool-bar}.  This feature is only available
 in Emacs.
 
 @node New Mail Message
@@ -707,14 +707,12 @@ This means that if the recipient supports RFC 2298 she might send you a
 notification that she received the message.
 
 @item M-x message-insert-importance-high
-@kindex M-x message-insert-importance-high
 @findex message-insert-importance-high
 @cindex Importance
 Insert an @samp{Importance} header with a value of @samp{high},
 deleting headers if necessary.
 
 @item M-x message-insert-importance-low
-@kindex M-x message-insert-importance-low
 @findex message-insert-importance-low
 @cindex Importance
 Insert an @samp{Importance} header with a value of @samp{low}, deleting
@@ -921,7 +919,7 @@ is fully available) @acronym{IDNA} encoding happens automatically.
 
 @findex message-idna-to-ascii-rhs
 If you want to experiment with the @acronym{IDNA} encoding, you can
-invoke @kbd{M-x message-idna-to-ascii-rhs RET} in the message buffer
+invoke @kbd{M-x message-idna-to-ascii-rhs @key{RET}} in the message buffer
 to have the non-@acronym{ASCII} domain names encoded while you edit
 the message.
 
@@ -1084,7 +1082,7 @@ Since signing and especially encryption often is used when sensitive
 information is sent, you may want to have some way to ensure that your
 mail is actually signed or encrypted.  After invoking the above
 sign/encrypt commands, it is possible to preview the raw article by
-using @kbd{C-u C-c RET P} (@code{mml-preview}).  Then you can
+using @kbd{C-u C-c @key{RET} P} (@code{mml-preview}).  Then you can
 verify that your long rant about what your ex-significant other or
 whomever actually did with that funny looking person at that strange
 party the other night, actually will be sent encrypted.
@@ -1176,7 +1174,7 @@ without some kind of configuration.  Especially, you need to tell it
 where your private key and your certificate is stored.  @acronym{MML}
 uses an Emacs interface to OpenSSL, aptly named @code{smime.el}, and it
 contain a @code{custom} group used for this configuration.  So, try
-@kbd{M-x customize-group RET smime RET} and look around.
+@kbd{M-x customize-group @key{RET} smime @key{RET}} and look around.
 
 Currently there is no support for talking to a CA (or RA) to create
 your own certificate.  None is planned either.  You need to do this
@@ -1222,7 +1220,7 @@ according to two different standards, namely @acronym{PGP} or
 @node Passphrase caching
 @subsection Passphrase caching
 
-@cindex gpg-agent
+@cindex @command{gpg-agent}
 Message with EasyPG internally calls GnuPG (the @command{gpg} or
 @command{gpgsm} command) to perform
 data encryption, and in certain cases (decrypting or signing for
@@ -1379,7 +1377,7 @@ end of the message (@code{message-kill-to-signature}).
 Delete all text in the body of the message that is outside the region
 (@code{message-delete-not-region}).
 
-@item M-RET
+@item M-@key{RET}
 @kindex M-RET
 @findex message-newline-and-reformat
 Insert four newlines, and then reformat if inside quoted text.
@@ -1390,7 +1388,7 @@ Here's an example:
 > This is some quoted text.  And here's more quoted text.
 @end example
 
-If point is before @samp{And} and you press @kbd{M-RET}, you'll get:
+If point is before @samp{And} and you press @kbd{M-@key{RET}}, you'll get:
 
 @example
 > This is some quoted text.
@@ -1408,12 +1406,12 @@ If point is before @samp{And} and you press @kbd{M-RET}, you'll get:
 Rename the buffer (@code{message-rename-buffer}).  If given a prefix,
 prompt for a new buffer name.
 
-@item TAB
+@item @key{TAB}
 @kindex TAB
 @findex message-tab
 @vindex message-tab-body-function
 If @code{message-tab-body-function} is non-@code{nil}, execute the
-function it specifies.  Otherwise use the function bound to @kbd{TAB} in
+function it specifies.  Otherwise use the function bound to @key{TAB} in
 @code{text-mode-map} or @code{global-map}.
 
 @end table
diff --git a/doc/misc/mh-e.texi b/doc/misc/mh-e.texi
index 5f0cc32cc4..b44e503996 100644
--- a/doc/misc/mh-e.texi
+++ b/doc/misc/mh-e.texi
@@ -442,7 +442,7 @@ either @code{customize-option} or @code{add-hook}.
 @cindex point
 @cindex region
 @kindex C-@@
-@kindex C-@key{SPC}
+@kindex C-SPC
 
 There are several other terms that are used in Emacs that you should
 know. The @dfn{point} is where the cursor currently is. You can save
@@ -692,7 +692,6 @@ get the big picture, and then you can read the manual as you wish.
 @cindex modes, MH-Letter
 @cindex sending mail
 @findex mh-smail
-@kindex M-x mh-smail
 
 Let's start our tour by sending ourselves a message which we can later
 read and process. Enter @kbd{M-x mh-smail} to invoke the MH-E program
@@ -762,7 +761,6 @@ message. Type @kbd{C-c C-c} now. That's all there is to it!
 @cindex modes, MH-Folder
 @cindex reading mail
 @findex mh-rmail
-@kindex M-x mh-rmail
 
 To read the mail you've just sent yourself, enter @kbd{M-x mh-rmail}.
 This incorporates the new mail and puts the output from
@@ -777,7 +775,6 @@ major mode is MH-Folder.
 
 @findex mh-rmail
 @kindex F r
-@kindex M-x mh-rmail
 
 @sp 1
 @center @strong{NOTE}
@@ -790,7 +787,7 @@ use @kbd{F r} to pull all your messages into MH-E.
 @end quotation
 @sp 1
 
-@kindex @key{RET}
+@kindex RET
 @kindex n
 @kindex p
 
@@ -820,8 +817,8 @@ This is a test message to get the wheels churning...
 @end cartouche
 @i{After incorporating new messages}
 
-@kindex @key{DEL}
-@kindex @key{SPC}
+@kindex DEL
+@kindex SPC
 
 If you typed a long message, you can view subsequent pages with
 @key{SPC} and previous pages with @key{DEL}.
@@ -830,7 +827,7 @@ If you typed a long message, you can view subsequent pages with
 @section Processing Mail
 
 @cindex processing mail
-@kindex @key{RET}
+@kindex RET
 @kindex r
 
 The first thing we want to do is reply to the message that we sent
@@ -883,7 +880,7 @@ Type C-c C-c to send message, C-c ? for help
 @kindex C-f
 @kindex C-n
 @kindex C-p
-@kindex @key{BS}
+@kindex BS
 
 By default, MH will not add you to the address list of your replies,
 so if you find that the @samp{To:} header field is missing, don't
@@ -898,7 +895,7 @@ editing your message, send it with @kbd{C-c C-c} as before.
 @cindex @command{refile}
 @cindex MH commands, @command{refile}
 @cindex folders
-@kindex @key{SPC}
+@kindex SPC
 @kindex o
 
 You'll often want to save messages that were sent to you in an
@@ -918,7 +915,7 @@ in a moment.
 @cindex modes, MH-Folder
 @kindex d
 @kindex i
-@kindex @key{RET}
+@kindex RET
 @kindex n
 @kindex p
 @kindex x
@@ -935,7 +932,6 @@ command.
 
 @findex mh-smail
 @kindex m
-@kindex M-x mh-smail
 
 If you want to send another message you can use @kbd{m} instead of
 @kbd{M-x mh-smail}. So go ahead, send some mail to your friends!
@@ -970,7 +966,6 @@ perform any refiles and deletes that you did there.
 @findex mh-rmail
 @kindex C-x b
 @kindex C-x k
-@kindex M-x mh-rmail
 @kindex q
 
 If you don't want to leave Emacs, you can type @kbd{q} to bury (hide)
@@ -1228,7 +1223,7 @@ Many commands that operate on individual messages, such as
 @code{mh-forward} or @code{mh-refile-msg} take a @code{RANGE}
 argument. This argument can be used in several ways.
 
-@kindex C-u, with ranges
+@kindex C-u@r{, with ranges}
 
 If you provide the prefix argument @kbd{C-u} to these commands, then
 you will be prompted for the message range. This can be any valid MH
@@ -1552,7 +1547,6 @@ the message numbers from outside of MH-E.
 @findex mh-rmail
 @kindex F r
 @kindex F v
-@kindex M-x mh-rmail
 
 The MH-E entry point for reading mail is @kbd{M-x mh-rmail}. This
 command incorporates your mail and creates a buffer called
@@ -1592,38 +1586,38 @@ Display cheat sheet for the MH-E commands (@code{mh-help}).
 @c -------------------------
 @cindex @samp{Message > Show Message} menu item
 @cindex menu item, @samp{Message > Show Message}
-@kindex @key{RET}
+@kindex RET
 @findex mh-show
 @item @key{RET}
 Display message (@code{mh-show}).
 @c -------------------------
 @cindex @samp{Message > Show Message with Header} menu item
 @cindex menu item, @samp{Message > Show Message with Header}
-@kindex , (comma)
+@kindex , @r{(comma)}
 @findex mh-header-display
 @item , (comma)
 Display message with all header fields (@code{mh-header-display}).
 @c -------------------------
 @cindex @samp{Message > Show Message with Preferred Alternative} menu item
 @cindex menu item, @samp{Message > Show Message with Preferred Alternative}
-@kindex : (colon)
+@kindex : @r{(colon)}
 @findex mh-show-preferred-alternative
 @item : (colon)
 Display message with the default preferred alternative
 (@code{mh-show-preferred-alternative}).
 @c -------------------------
-@kindex ; (semicolon)
+@kindex ; @r{(semicolon)}
 @findex mh-toggle-mh-decode-mime-flag
 @item ; (semicolon)
 Toggle the value of @code{mh-decode-mime-flag}
 (@code{mh-toggle-mh-decode-mime-flag}).
 @c -------------------------
-@kindex @key{SPC}
+@kindex SPC
 @findex mh-page-msg
 @item @key{SPC}
 Display next page in message (@code{mh-page-msg}).
 @c -------------------------
-@kindex @key{BS}
+@kindex BS
 @findex mh-previous-page
 @item @key{BS}
 Display previous page in message (@code{mh-previous-page}).
@@ -1661,12 +1655,12 @@ Delete range (@code{mh-delete-msg}).
 Display cheat sheet for the commands of the current prefix in
 minibuffer (@code{mh-prefix-help}).
 @c -------------------------
-@kindex D @key{SPC}
+@kindex D SPC
 @findex mh-page-digest
 @item D @key{SPC}
 Display next message in digest (@code{mh-page-digest}).
 @c -------------------------
-@kindex D @key{BS}
+@kindex D BS
 @findex mh-page-digest-backwards
 @item D @key{BS}
 Display previous message in digest (@code{mh-page-digest-backwards}).
@@ -1697,12 +1691,12 @@ Delete messages with same subject or thread
 Display cheat sheet for the commands of the current prefix in
 minibuffer (@code{mh-prefix-help}).
 @c -------------------------
-@kindex K @key{TAB}
+@kindex K TAB
 @findex mh-next-button
 @item K @key{TAB}
 Go to the next button (@code{mh-next-button}).
 @c -------------------------
-@kindex K S-@key{TAB}
+@kindex K S-TAB
 @findex mh-prev-button
 @item K S-@key{TAB}
 Go to the previous button (@code{mh-prev-button}).
@@ -1844,7 +1838,7 @@ Move point to mouse event and show message (@code{mh-show-mouse}).
 Within the MH-Show buffer, the following command is defined.
 
 @table @kbd
-@kindex @key{RET}
+@kindex RET
 @kindex mouse-1
 @kindex mouse-2
 @findex mh-press-button
@@ -2017,11 +2011,11 @@ detail in the following sections.
 @findex mh-previous-page
 @findex mh-show
 @findex mh-show-mouse
-@kindex , (comma)
-@kindex . (period)
-@kindex @key{BS}
-@kindex @key{RET}
-@kindex @key{SPC}
+@kindex , @r{(comma)}
+@kindex . @r{(period)}
+@kindex BS
+@kindex RET
+@kindex SPC
 @kindex mouse-2
 
 The command @key{RET} (@code{mh-show}) displays the message that the
@@ -2101,9 +2095,9 @@ Emacs 21 and XEmacs. For more information, see
 @uref{http://quimby.gnus.org/circus/face/}.}.
 
 @cindex @command{uncompface}
-@cindex Emacs, packages, x-face
+@cindex Emacs, packages, @samp{x-face}
 @cindex Unix commands, @command{uncompface}
-@cindex x-face package
+@cindex @samp{x-face} package
 @vindex mh-show-xface
 
 Next is the traditional @samp{X-Face:} header field@footnote{The
@@ -2200,7 +2194,7 @@ highlighting of citations entirely, choose @samp{None}.
 @cindex highlighting email addresses
 @cindex links, following
 @findex goto-address-at-point
-@kindex C-c @key{RET}
+@kindex C-c RET
 @kindex mouse-2
 @vindex goto-address-highlight-p
 
@@ -2306,10 +2300,10 @@ System: type @kbd{M-! xterm -e mhshow @var{message-number}}. You can
 leave out the @samp{xterm -e} if you use @command{mhlist} or
 @command{mhstore}.}.
 
-@cindex Emacs, packages, mm-decode
-@cindex mm-decode package
+@cindex Emacs, packages, @samp{mm-decode}
+@cindex @samp{mm-decode} package
 @findex mh-toggle-mh-decode-mime-flag
-@kindex ; (semicolon)
+@kindex ; @r{(semicolon)}
 @vindex mh-decode-mime-flag
 
 MH-E can handle attachments as well if the Gnus @samp{mm-decode}
@@ -2334,9 +2328,9 @@ Attachments in MH-E are indicated by @dfn{buttons} like this:
 @findex mh-next-button
 @findex mh-press-button
 @findex mh-prev-button
-@kindex @key{RET}
-@kindex K @key{TAB}
-@kindex K S-@key{TAB}
+@kindex RET
+@kindex K TAB
+@kindex K S-TAB
 @kindex mouse-1
 @kindex mouse-2
 
@@ -2490,7 +2484,7 @@ the option @code{mm-discouraged-alternatives}, and add
 @samp{text/html}. The next best alternative, if any, will be shown.
 
 @findex mh-show-preferred-alternative
-@kindex : (colon)
+@kindex : @r{(colon)}
 
 Occasionally, though, you might want to see the preferred alternative.
 The command @kbd{:} (@code{mh-show-preferred-alternative}) displays
@@ -2688,10 +2682,10 @@ buffer, including HTML buffers.
 @cindex digests
 @findex mh-page-digest
 @findex mh-page-digest-backwards
-@kindex D @key{BS}
-@kindex D @key{SPC}
-@kindex @key{BS}
-@kindex @key{SPC}
+@kindex D BS
+@kindex D SPC
+@kindex BS
+@kindex SPC
 
 A digest is a message that contains other messages. Special MH-E
 commands let you read digests conveniently. You can use @key{SPC} and
@@ -2904,8 +2898,8 @@ Another related function is the command @kbd{P F}
 faces and not. When faces are enabled, the printed message will look
 very similar to the message in the MH-Show buffer.
 
-@cindex ps-print package
-@cindex Emacs, packages, ps-print
+@cindex @samp{ps-print} package
+@cindex Emacs, packages, @samp{ps-print}
 
 MH-E uses the @samp{ps-print} package to do the printing, so you can
 customize the printing further by going to the @samp{ps-print}
@@ -2995,7 +2989,7 @@ like to change the initial default directory, customize the option
 directory for storing the content of these messages.
 
 @findex mh-store-buffer
-@kindex @key{RET}
+@kindex RET
 @kindex X s
 
 By the way, @kbd{X s} calls the Emacs Lisp function
@@ -3045,7 +3039,7 @@ message with @kbd{M-<} (@code{mh-first-msg}) and @kbd{M->}
 @findex previous-line
 @kindex C-n
 @kindex C-p
-@kindex @key{RET}
+@kindex RET
 
 You can also use the Emacs commands @kbd{C-p} (@code{previous-line})
 and @kbd{C-n} (@code{next-line}) to move up and down the scan lines in
@@ -3746,7 +3740,7 @@ The command @kbd{F p} runs @code{mh-pack-folder-hook} after
 renumbering the messages. A variable that is useful with this hook
 is @code{mh-current-folder}.
 
-@kindex @key{TAB}
+@kindex TAB
 @vindex mh-recursive-folders-flag
 
 By default, operations on folders work only one level at a time. Set
@@ -3850,16 +3844,15 @@ buffers that you would rather remove, you can use both
 
 You can use dired to manipulate the folders themselves. For example, I
 renamed my @samp{+out} folder to the more common @samp{+outbox} by
-running dired on my mail directory (@kbd{M-x dired RET ~/Mail RET}),
-moving my cursor to @samp{out} and using the command @kbd{R}
-(@code{dired-do-rename}).
+running dired on my mail directory (@kbd{M-x dired @key{RET} ~/Mail
+@key{RET}}), moving my cursor to @samp{out} and using the command
+@kbd{R} (@code{dired-do-rename}).
 
 @node Sending Mail, Editing Drafts, Folders, Top
 @chapter Sending Mail
 
 @cindex sending mail
 @findex mh-smail
-@kindex M-x mh-smail
 
 You can send a mail message in several ways. You can call @kbd{M-x
 mh-smail} directly, or from the command line like this:
@@ -4027,8 +4020,6 @@ more detail in the following sections.
 @cindex sending mail
 @findex mh-smail
 @findex mh-smail-other-window
-@kindex M-x mh-smail
-@kindex M-x mh-smail-other-window
 
 Outside of an MH-Folder buffer, you must call either @kbd{M-x
 mh-smail} or @kbd{M-x mh-smail-other-window} to compose a new message.
@@ -4390,28 +4381,28 @@ commands in addition to the normal Emacs editing commands to help you
 edit your draft. These can also be found in the @samp{Letter} menu.
 
 @table @kbd
-@kindex @key{SPC}
+@kindex SPC
 @findex mh-letter-complete-or-space
 @item @key{SPC}
 Perform completion or insert space (@code{mh-letter-complete-or-space}).
 @c -------------------------
-@kindex M-@key{TAB}
+@kindex M-TAB
 @findex mh-letter-complete
 @item M-@key{TAB}
 Perform completion on header field or word preceding point
 (@code{mh-letter-complete}).
 @c -------------------------
-@kindex , (comma)
+@kindex , @r{(comma)}
 @findex mh-letter-confirm-address
 @item , (comma)
 Flash alias expansion (@code{mh-letter-confirm-address}).
 @c -------------------------
-@kindex @key{TAB}
+@kindex TAB
 @findex mh-letter-next-header-field-or-indent
 @item @key{TAB}
 Cycle to next field (@code{mh-letter-next-header-field-or-indent}).
 @c -------------------------
-@kindex S-@key{TAB}
+@kindex S-TAB
 @findex mh-letter-previous-header-field
 @item S-@key{TAB}
 Cycle to the previous header field
@@ -4816,8 +4807,8 @@ draft. @xref{Folder Selection}.
 @findex indent-relative
 @findex mh-letter-next-header-field-or-indent
 @findex mh-letter-previous-header-field
-@kindex @key{TAB}
-@kindex S-@key{TAB}
+@kindex TAB
+@kindex S-TAB
 @vindex mh-compose-skipped-header-fields
 @vindex mh-letter-header-field
 
@@ -4842,9 +4833,9 @@ take point to the last field from anywhere in the body.
 @findex mh-letter-complete
 @findex mh-letter-complete-or-space
 @findex mh-letter-confirm-address
-@kindex , (comma)
-@kindex @key{SPC}
-@kindex M-@key{TAB}
+@kindex , @r{(comma)}
+@kindex SPC
+@kindex M-TAB
 @vindex mh-alias-flash-on-comma
 @vindex mh-compose-space-does-completion-flag
 @vindex mh-letter-complete-function
@@ -4997,8 +4988,8 @@ You can also turn on the @code{mh-delete-yanked-msg-window-flag}
 option to delete the window containing the original message after
 yanking it to make more room on your screen for your reply.
 
-@cindex Emacs, packages, supercite
-@cindex supercite package
+@cindex Emacs, packages, @samp{supercite}
+@cindex @samp{supercite} package
 @kindex r
 @vindex mail-citation-hook
 @vindex mh-yank-behavior
@@ -5061,8 +5052,8 @@ and it should leave point and mark around the modified citation text
 for the next hook function. The standard prefix
 @code{mh-ins-buf-prefix} is not added if this hook is set.
 
-@cindex Emacs, packages, trivial-cite
-@cindex trivial-cite package
+@cindex Emacs, packages, @samp{trivial-cite}
+@cindex @samp{trivial-cite} package
 @vindex mh-yank-behavior
 
 For example, if you use the hook function
@@ -5499,7 +5490,7 @@ LyogWFBNICovCnN0YXRpYyBjaGFyICogc2V0aWF0aG9tZV94cG1bXSA9IHsKIjQ1IDQ1IDc2N
 @end cartouche
 @i{MH-E @sc{mime} draft ready to send}
 
-@cindex undo effects of mh-mml-to-mime
+@cindex undo effects of @code{mh-mml-to-mime}
 
 This action can be undone by running @kbd{C-_} (@code{undo}).
 
@@ -5507,7 +5498,7 @@ This action can be undone by running @kbd{C-_} (@code{undo}).
 @cindex @command{mhn}
 @cindex MH commands, @command{mhbuild}
 @cindex MH commands, @command{mhn}
-@cindex undo effects of mh-mh-to-mime
+@cindex undo effects of @code{mh-mh-to-mime}
 @findex mh-mh-to-mime
 @findex mh-mh-to-mime-undo
 @kindex C-c C-e
@@ -5723,12 +5714,12 @@ The following commands are available in MH-Letter mode with the
 exception of @code{mh-alias-reload} which can be called from anywhere.
 
 @table @kbd
-@kindex @key{SPC}
+@kindex SPC
 @findex mh-letter-complete-or-space
 @item @key{SPC}
 Perform completion or insert space (@code{mh-letter-complete-or-space}).
 @c -------------------------
-@kindex M-@key{TAB}
+@kindex M-TAB
 @findex mh-letter-complete
 @item M-@key{TAB}
 Perform completion on header field or word preceding point
@@ -5800,7 +5791,7 @@ Hook run by @code{mh-alias-reload} after loading aliases (default:
 You can use aliases when you are adding recipients to a message.
 
 @findex minibuffer-complete
-@kindex @key{TAB}
+@kindex TAB
 @vindex mh-alias-expand-aliases-flag
 @vindex mh-compose-prompt-flag
 
@@ -5814,8 +5805,8 @@ aliases to be expanded to their respective addresses in the draft.
 
 @findex mh-letter-complete
 @findex mh-letter-complete-or-space
-@kindex @key{SPC}
-@kindex M-@key{TAB}
+@kindex SPC
+@kindex M-TAB
 
 Otherwise, you can complete aliases in the header of the draft with
 @kbd{M-@key{TAB}} (@code{mh-letter-complete}) or @key{SPC}
@@ -5934,7 +5925,6 @@ executed to generate the password file. For example, use @samp{ypcat
 passwd} to obtain the NIS password file.
 
 @findex mh-alias-reload
-@kindex M-x mh-alias-reload
 @vindex mh-alias-reloaded-hook
 
 Since aliases are updated frequently, MH-E reloads aliases
@@ -5950,7 +5940,6 @@ listed in your @samp{Aliasfile:} profile component. MH-E provides
 other methods for maintaining your alias file(s).
 
 @findex mh-alias-add-alias
-@kindex M-x mh-alias-add-alias
 
 You can use the @kbd{M-x mh-alias-add-alias} command which will prompt
 you for the alias and address that you would like to add. If the alias
@@ -5985,8 +5974,8 @@ Using prefixes instead of postfixes helps you explore aliases during
 completion. If you forget the name of an old dive buddy, you can enter
 @samp{div} and then @key{SPC} to get a listing of all your dive buddies.
 
-@kindex M-x mh-alias-add-address-under-point
-@kindex M-x mh-alias-grab-from-field
+@findex mh-alias-add-address-under-point
+@findex mh-alias-grab-from-field
 
 An alias for the sender of the current message is added automatically
 by clicking on the @samp{Grab From alias} tool bar button or by running
@@ -6021,7 +6010,6 @@ more appropriate.
 
 @cindex regular expressions, @code{mh-alias-apropos}
 @findex mh-alias-apropos
-@kindex M-x mh-alias-apropos
 
 If you can't quite remember an alias, you can use @kbd{M-x
 mh-alias-apropos} to show all aliases or addresses that match a
@@ -6280,8 +6268,8 @@ containing the value for the field is given.
 @cindex folder navigation
 @cindex speedbar
 @findex mh-visit-folder
+@findex speedbar
 @kindex F v
-@kindex M-x speedbar
 @kindex mouse-2
 
 You can also use the speedbar
@@ -6623,12 +6611,12 @@ Another few commands are available in the MH-Folder buffer resulting
 from a search.
 
 @table @kbd
-@kindex @key{TAB}
+@kindex TAB
 @findex mh-index-next-folder
 @item @key{TAB}
 Jump to the next folder marker (@code{mh-index-next-folder}).
 @c -------------------------
-@kindex S-@key{TAB}
+@kindex S-TAB
 @findex mh-index-previous-folder
 @item S-@key{TAB}
 Jump to the previous folder marker (@code{mh-index-previous-folder}).
@@ -6773,8 +6761,8 @@ method with the pick method by running the command @kbd{C-c C-p}
 @cindex @samp{+mhe-index}
 @findex mh-index-next-folder
 @findex mh-index-previous-folder
-@kindex @key{TAB}
-@kindex S-@key{TAB}
+@kindex TAB
+@kindex S-TAB
 @vindex mh-search-folder
 
 The messages that are found are put in a temporary sub-folder of
@@ -7514,7 +7502,6 @@ Mail}).
 @cindex sequence, @samp{cur}
 @cindex sequence, @samp{tick}
 @findex mh-update-sequences
-@kindex M-x mh-update-sequences
 @kindex q
 @kindex x
 @vindex mh-tick-seq
@@ -8001,7 +7988,7 @@ system.
 @cindex MH-E version
 @cindex @file{*MH-E Info*}
 @cindex version
-@kindex M-x mh-version
+@findex mh-version
 
 One command worth noting is @kbd{M-x mh-version}. You can compare the
 version this command prints to the latest release (@pxref{Getting
@@ -8716,7 +8703,7 @@ I also point out some additional sources of information.
 
 @cindex bugs
 @cindex SourceForge
-@kindex M-x mh-version
+@findex mh-version
 
 Bug reports should be filed at
 @uref{https://sourceforge.net/p/mh-e/bugs/, SourceForge}. You need to
@@ -8792,7 +8779,7 @@ instead.
 @cindex news
 @cindex @samp{MH-E-NEWS}
 @cindex @samp{README}
-@kindex M-x mh-version
+@findex mh-version
 
 After you download and extract the MH-E tarball, read the
 @file{README} file and @file{MH-E-NEWS}. These correspond to the
diff --git a/doc/misc/newsticker.texi b/doc/misc/newsticker.texi
index 43d248bc7d..ac29ced8fb 100644
--- a/doc/misc/newsticker.texi
+++ b/doc/misc/newsticker.texi
@@ -239,17 +239,17 @@ The position of groups and feeds within the tree can be changed with these
 commands:
 
 @table @kbd
-@item M-up
-@itemx M-down
-@kindex M-up
-@kindex M-down
+@item M-@key{UP}
+@itemx M-@key{DOWN}
+@kindex M-UP
+@kindex M-DOWN
 @findex newsticker-group-shift-feed-up
 @findex newsticker-group-shift-feed-down
 Shift the currently selected feed up and down within its group.
-@item M-S-up
-@itemx M-S-down
-@kindex M-S-up
-@kindex M-S-down
+@item M-S-@key{UP}
+@itemx M-S-@key{DOWN}
+@kindex M-S-UP
+@kindex M-S-DOWN
 @findex newsticker-group-shift-group-up
 @findex newsticker-group-shift-group-down
 Shift the currently selected group up and down within its parent group.
@@ -397,8 +397,8 @@ Mark current item as immortal.  Immortal items are kept forever.
 @table @kbd
 @cindex Get News
 @item v
-@itemx RET
-@itemx <mouse-1>
+@itemx @key{RET}
+@itemx mouse-1
 @findex newsticker-treeview-browse-url
 Open the link to the full article (as contained in the current
 headline) in your web browser @code{newsticker-treeview-browse-url}).
diff --git a/doc/misc/org.texi b/doc/misc/org.texi
index 17931905f1..c727cc3f8d 100644
--- a/doc/misc/org.texi
+++ b/doc/misc/org.texi
@@ -749,7 +749,7 @@ Specific header arguments
 
 Miscellaneous
 
-* Completion::                  M-TAB guesses completions
+* Completion::                  M-@key{TAB} guesses completions
 * Easy templates::              Quick insertion of structural elements
 * Speed keys::                  Electric commands at the beginning of a headline
 * Code evaluation security::    Org mode files evaluate inline code
@@ -884,7 +884,8 @@ We @b{strongly recommend} to stick to a single installation method.
 @subsubheading Using Emacs packaging system
 
 Recent Emacs distributions include a packaging system which lets you install
-Elisp libraries.  You can install Org with @kbd{M-x package-install RET org}.
+Elisp libraries.  You can install Org with @kbd{M-x package-install @key{RET}
+org}.
 
 @noindent @b{Important}: you need to do this in a session where no @code{.org} file has
 been visited, i.e., where no Org built-in function have been loaded.
@@ -1011,10 +1012,10 @@ version of Org available---if you are running an outdated version, it is
 quite possible that the bug has been fixed already.  If the bug persists,
 prepare a report and provide as much information as possible, including the
 version information of Emacs (@kbd{M-x emacs-version @key{RET}}) and Org
-(@kbd{M-x org-version RET}), as well as the Org related setup in the Emacs
-init file.  The easiest way to do this is to use the command
+(@kbd{M-x org-version @key{RET}}), as well as the Org related setup in the
+Emacs init file.  The easiest way to do this is to use the command
 @example
-@kbd{M-x org-submit-bug-report RET}
+@kbd{M-x org-submit-bug-report @key{RET}}
 @end example
 @noindent which will put all this information into an Emacs mail buffer so
 that you only need to add your description.  If you are not sending the Email
@@ -1074,7 +1075,7 @@ Reload uncompiled versions of all Org mode Lisp files.  The backtrace
 contains much more information if it is produced with uncompiled code.
 To do this, use
 @example
-@kbd{C-u M-x org-reload RET}
+@kbd{C-u M-x org-reload @key{RET}}
 @end example
 @noindent
 or select @code{Org -> Refresh/Reload -> Reload Org uncompiled} from the
@@ -1134,7 +1135,7 @@ accessing a functionality.  Org mode often uses the same key for different
 functions, depending on context.  The command that is bound to such keys has
 a generic name, like @code{org-metaright}.  In the manual we will, wherever
 possible, give the function that is internally called by the generic command.
-For example, in the chapter on document structure, @kbd{M-@key{right}} will
+For example, in the chapter on document structure, @kbd{M-@key{RIGHT}} will
 be listed to call @code{org-do-demote}, while in the chapter on tables, it
 will be listed to call @code{org-table-move-column-right}.  If you prefer,
 you can compile the manual without the command names by unsetting the flag
@@ -1340,9 +1341,9 @@ following lines anywhere in the buffer:
 #+STARTUP: showeverything
 @end example
 
-@cindex property, VISIBILITY
+@cindex property, @code{VISIBILITY}
 @noindent
-Furthermore, any entries with a @samp{VISIBILITY} property (@pxref{Properties
+Furthermore, any entries with a @code{VISIBILITY} property (@pxref{Properties
 and columns}) will get their visibility adapted accordingly.  Allowed values
 for this property are @code{folded}, @code{children}, @code{content}, and
 @code{all}.
@@ -1350,7 +1351,7 @@ for this property are @code{folded}, @code{children}, @code{content}, and
 @table @asis
 @orgcmd{C-u C-u @key{TAB},org-set-startup-visibility}
 Switch back to the startup visibility of the buffer, i.e., whatever is
-requested by startup options and @samp{VISIBILITY} properties in individual
+requested by startup options and @code{VISIBILITY} properties in individual
 entries.
 @end table
 
@@ -1390,7 +1391,7 @@ you can use the following keys to find your destination:
 @vindex org-goto-auto-isearch
 @example
 @key{TAB}         @r{Cycle visibility.}
-@key{down} / @key{up}   @r{Next/previous visible headline.}
+@key{DOWN} / @key{UP}   @r{Next/previous visible headline.}
 @key{RET}         @r{Select this location.}
 @kbd{/}           @r{Do a Sparse-tree search}
 @r{The following keys work if you turn off @code{org-goto-auto-isearch}}
@@ -1451,18 +1452,18 @@ In a new entry with no text yet, the first @key{TAB} demotes the entry to
 become a child of the previous one.  The next @key{TAB} makes it a parent,
 and so on, all the way to top level.  Yet another @key{TAB}, and you are back
 to the initial level.
-@orgcmd{M-@key{left},org-do-promote}
+@orgcmd{M-@key{LEFT},org-do-promote}
 Promote current heading by one level.
-@orgcmd{M-@key{right},org-do-demote}
+@orgcmd{M-@key{RIGHT},org-do-demote}
 Demote current heading by one level.
-@orgcmd{M-S-@key{left},org-promote-subtree}
+@orgcmd{M-S-@key{LEFT},org-promote-subtree}
 Promote the current subtree by one level.
-@orgcmd{M-S-@key{right},org-demote-subtree}
+@orgcmd{M-S-@key{RIGHT},org-demote-subtree}
 Demote the current subtree by one level.
-@orgcmd{M-@key{up},org-move-subtree-up}
+@orgcmd{M-@key{UP},org-move-subtree-up}
 Move subtree up (swap with previous subtree of same
 level).
-@orgcmd{M-@key{down},org-move-subtree-down}
+@orgcmd{M-@key{DOWN},org-move-subtree-down}
 Move subtree down (swap with next subtree of same level).
 @orgcmd{M-h,org-mark-element}
 Mark the element at point.  Hitting repeatedly will mark subsequent elements
@@ -1728,10 +1729,10 @@ one.
 @end table
 
 @table @kbd
-@kindex M-S-@key{RET}
+@kindex M-S-RET
 @item M-S-@key{RET}
 Insert a new item with a checkbox (@pxref{Checkboxes}).
-@kindex S-@key{down}
+@kindex S-DOWN
 @item S-up
 @itemx S-down
 @cindex shift-selection-mode
@@ -1741,25 +1742,25 @@ Jump to the previous/next item in the current list@footnote{If you want to
 cycle around items that way, you may customize
 @code{org-list-use-circular-motion}.}, but only if
 @code{org-support-shift-select} is off.  If not, you can still use paragraph
-jumping commands like @kbd{C-@key{up}} and @kbd{C-@key{down}} to quite
+jumping commands like @kbd{C-@key{UP}} and @kbd{C-@key{DOWN}} to quite
 similar effect.
-@kindex M-@key{up}
-@kindex M-@key{down}
+@kindex M-UP
+@kindex M-DOWN
 @item M-up
 @itemx M-down
 Move the item including subitems up/down@footnote{See
 @code{org-list-use-circular-motion} for a cyclic behavior.} (swap with
 previous/next item of same indentation).  If the list is ordered, renumbering
 is automatic.
-@kindex M-@key{left}
-@kindex M-@key{right}
+@kindex M-LEFT
+@kindex M-RIGHT
 @item M-left
 @itemx M-right
 Decrease/increase the indentation of an item, leaving children alone.
-@kindex M-S-@key{left}
-@kindex M-S-@key{right}
-@item M-S-@key{left}
-@itemx M-S-@key{right}
+@kindex M-S-LEFT
+@kindex M-S-RIGHT
+@item M-S-@key{LEFT}
+@itemx M-S-@key{RIGHT}
 Decrease/increase the indentation of the item, including subitems.
 Initially, the item tree is selected based on current indentation.  When
 these commands are executed several times in direct succession, the initially
@@ -1797,9 +1798,9 @@ its location).  @xref{Structure editing}, for a detailed explanation.
 Turn the whole plain list into a subtree of the current heading.  Checkboxes
 (@pxref{Checkboxes}) will become TODO (resp. DONE) keywords when unchecked
 (resp. checked).
-@kindex S-@key{left}
-@kindex S-@key{right}
-@item S-left/right
+@kindex S-LEFT
+@kindex S-RIGHT
+@item S-@key{LEFT}/@key{RIGHT}
 @vindex org-support-shift-select
 This command also cycles bullet styles when the cursor in on the bullet or
 anywhere in an item line, details depending on
@@ -1817,7 +1818,7 @@ or by a custom function.
 @cindex drawers
 @cindex visibility cycling, drawers
 
-@cindex org-insert-drawer
+@cindex @code{org-insert-drawer}
 @kindex C-c C-x d
 Sometimes you want to keep information associated with an entry, but you
 normally don't want to see it.  For this, Org mode has @emph{drawers}.  They
@@ -1873,7 +1874,7 @@ export output.  Property drawers are not affected by this variable: configure
 Org mode uses begin...end blocks for various purposes from including source
 code examples (@pxref{Literal examples}) to capturing time logging
 information (@pxref{Clocking work time}).  These blocks can be folded and
-unfolded by pressing TAB in the begin line.  You can also get all blocks
+unfolded by pressing @key{TAB} in the begin line.  You can also get all blocks
 folded at startup by configuring the option @code{org-hide-block-startup}
 or on a per-file basis by using
 
@@ -1997,7 +1998,7 @@ a separate window.  The window can be closed by pressing @kbd{C-c '}.
 If you like the intuitive way the Org mode structure editing and list
 formatting works, you might want to use these commands in other modes like
 Text mode or Mail mode as well.  The minor mode @code{orgstruct-mode} makes
-this possible.   Toggle the mode with @kbd{M-x orgstruct-mode RET}, or
+this possible.   Toggle the mode with @kbd{M-x orgstruct-mode @key{RET}}, or
 turn it on by default, for example in Message mode, with one of:
 
 @lisp
@@ -2038,7 +2039,7 @@ file falls into one of the categories above.
 To explore the abstract structure of an Org buffer, run this in a buffer:
 
 @lisp
-M-: (org-element-parse-buffer) RET
+M-: (org-element-parse-buffer) @key{RET}
 @end lisp
 
 It will output a list containing the buffer's content represented as an
@@ -2132,10 +2133,10 @@ table.  But it is easier just to start typing, like
 @orgcmd{C-c C-c,org-table-align}
 Re-align the table and don't move to another field.
 @c
-@orgcmd{C-c SPC,org-table-blank-field}
+@orgcmd{C-c @key{SPC},org-table-blank-field}
 Blank the field at point.
 @c
-@orgcmd{TAB,org-table-next-field}
+@orgcmd{@key{TAB},org-table-next-field}
 Re-align the table, move to the next field.  Creates a new row if
 necessary.
 @c
@@ -2153,22 +2154,22 @@ Move to beginning of the current table field, or on to the previous field.
 Move to end of the current table field, or on to the next field.
 
 @tsubheading{Column and row editing}
-@orgcmdkkcc{M-@key{left},M-@key{right},org-table-move-column-left,org-table-move-column-right}
+@orgcmdkkcc{M-@key{LEFT},M-@key{RIGHT},org-table-move-column-left,org-table-move-column-right}
 Move the current column left/right.
 @c
-@orgcmd{M-S-@key{left},org-table-delete-column}
+@orgcmd{M-S-@key{LEFT},org-table-delete-column}
 Kill the current column.
 @c
-@orgcmd{M-S-@key{right},org-table-insert-column}
+@orgcmd{M-S-@key{RIGHT},org-table-insert-column}
 Insert a new column to the left of the cursor position.
 @c
-@orgcmdkkcc{M-@key{up},M-@key{down},org-table-move-row-up,org-table-move-row-down}
+@orgcmdkkcc{M-@key{UP},M-@key{DOWN},org-table-move-row-up,org-table-move-row-down}
 Move the current row up/down.
 @c
-@orgcmd{M-S-@key{up},org-table-kill-row}
+@orgcmd{M-S-@key{UP},org-table-kill-row}
 Kill the current row or horizontal line.
 @c
-@orgcmd{M-S-@key{down},org-table-insert-row}
+@orgcmd{M-S-@key{DOWN},org-table-insert-row}
 Insert a new row above the current row.  With a prefix argument, the line is
 created below the current one.
 @c
@@ -2250,7 +2251,7 @@ window follow the cursor through the table and always show the current
 field.  The follow mode exits automatically when the cursor leaves the table,
 or when you repeat this command with @kbd{C-u C-u C-c `}.
 @c
-@item M-x org-table-import RET
+@item M-x org-table-import @key{RET}
 Import a file as a table.  The table should be TAB or whitespace
 separated.  Use, for example, to import a spreadsheet table or data
 from a database, because these programs generally can write
@@ -2263,7 +2264,7 @@ Tables can also be imported by pasting tabular text into the Org
 buffer, selecting the pasted text with @kbd{C-x C-x} and then using the
 @kbd{C-c |} command (see above under @i{Creation and conversion}).
 @c
-@item M-x org-table-export RET
+@item M-x org-table-export @key{RET}
 @findex org-table-export
 @vindex org-table-export-default-format
 Export the table, by default as a TAB-separated file.  Use for data
@@ -2388,11 +2389,11 @@ every vertical line you would like to have:
 @cindex Orgtbl mode
 @cindex minor mode for tables
 
-If you like the intuitive way the Org table editor works, you
-might also want to use it in other modes like Text mode or Mail mode.
-The minor mode Orgtbl mode makes this possible.  You can always toggle
-the mode with @kbd{M-x orgtbl-mode RET}.  To turn it on by default, for
-example in Message mode, use
+If you like the intuitive way the Org table editor works, you might also want
+to use it in other modes like Text mode or Mail mode.  The minor mode Orgtbl
+mode makes this possible.  You can always toggle the mode with @kbd{M-x
+orgtbl-mode @key{RET}}.  To turn it on by default, for example in Message
+mode, use
 
 @lisp
 (add-hook 'message-mode-hook 'turn-on-orgtbl)
@@ -2565,7 +2566,7 @@ rows/columns.
 @cindex references, named
 @cindex name, of column or field
 @cindex constants, in calculations
-@cindex #+CONSTANTS
+@cindex @code{#+CONSTANTS}
 
 @vindex org-table-formula-constants
 @samp{$name} is interpreted as the name of a column, parameter or
@@ -2602,7 +2603,7 @@ numbers.
 @cindex references, to a different table
 @cindex name, of column or field
 @cindex constants, in calculations
-@cindex #+NAME, for table
+@cindex @code{#+NAME}, for table
 
 You may also reference constants, fields and ranges from a different table,
 either in the current file or even in a different file.  The syntax is
@@ -2824,8 +2825,8 @@ preceded by @samp{:=}, for example @samp{:=vsum(@@II..III)}.  When you press
 the formula will be stored as the formula for this field, evaluated, and the
 current field will be replaced with the result.
 
-@cindex #+TBLFM
-Formulas are stored in a special line starting with @samp{#+TBLFM:} directly
+@cindex @code{#+TBLFM}
+Formulas are stored in a special line starting with @code{#+TBLFM:} directly
 below the table.  If you type the equation in the 4th field of the 3rd data
 line in the table, the formula will look like @samp{@@3$4=$1+$2}.  When
 inserting/deleting/swapping columns and rows with the appropriate commands,
@@ -2843,7 +2844,7 @@ command
 @table @kbd
 @orgcmd{C-u C-c =,org-table-eval-formula}
 Install a new formula for the current field.  The command prompts for a
-formula with default taken from the @samp{#+TBLFM:} line, applies
+formula with default taken from the @code{#+TBLFM:} line, applies
 it to the current field, and stores it.
 @end table
 
@@ -2890,7 +2891,7 @@ the formula will be stored as the formula for the current column, evaluated
 and the current field replaced with the result.  If the field contains only
 @samp{=}, the previously stored formula for this column is used.  For each
 column, Org will only remember the most recently used formula.  In the
-@samp{#+TBLFM:} line, column formulas will look like @samp{$4=$1+$2}.  The
+@code{#+TBLFM:} line, column formulas will look like @samp{$4=$1+$2}.  The
 left-hand side of a column formula cannot be the name of column, it must be
 the numeric column reference or @code{$>}.
 
@@ -2901,7 +2902,7 @@ following command:
 @orgcmd{C-c =,org-table-eval-formula}
 Install a new formula for the current column and replace current field with
 the result of the formula.  The command prompts for a formula, with default
-taken from the @samp{#+TBLFM} line, applies it to the current field and
+taken from the @code{#+TBLFM} line, applies it to the current field and
 stores it.  With a numeric prefix argument(e.g., @kbd{C-5 C-c =}) the command
 will apply it to that many consecutive fields in the current column.
 @end table
@@ -3012,22 +3013,22 @@ formula, @key{TAB} re-indents just like in Emacs Lisp mode.
 Complete Lisp symbols, just like in Emacs Lisp mode.@footnote{Many desktops
 intercept @kbd{M-@key{TAB}} to switch windows.  Use @kbd{C-M-i} or
 @kbd{@key{ESC} @key{TAB}} instead for completion (@pxref{Completion}).}
-@kindex S-@key{up}
-@kindex S-@key{down}
-@kindex S-@key{left}
-@kindex S-@key{right}
+@kindex S-UP
+@kindex S-DOWN
+@kindex S-LEFT
+@kindex S-RIGHT
 @findex org-table-fedit-ref-up
 @findex org-table-fedit-ref-down
 @findex org-table-fedit-ref-left
 @findex org-table-fedit-ref-right
-@item S-@key{up}/@key{down}/@key{left}/@key{right}
+@item S-@key{UP}/@key{DOWN}/@key{LEFT}/@key{RIGHT}
 Shift the reference at point.  For example, if the reference is
-@code{B3} and you press @kbd{S-@key{right}}, it will become @code{C3}.
+@code{B3} and you press @kbd{S-@key{RIGHT}}, it will become @code{C3}.
 This also works for relative references and for hline references.
-@orgcmdkkcc{M-S-@key{up},M-S-@key{down},org-table-fedit-line-up,org-table-fedit-line-down}
+@orgcmdkkcc{M-S-@key{UP},M-S-@key{DOWN},org-table-fedit-line-up,org-table-fedit-line-down}
 Move the test line for column formulas in the Org buffer up and
 down.
-@orgcmdkkcc{M-@key{up},M-@key{down},org-table-fedit-scroll-down,org-table-fedit-scroll-up}
+@orgcmdkkcc{M-@key{UP},M-@key{DOWN},org-table-fedit-scroll-down,org-table-fedit-scroll-up}
 Scroll the window displaying the table.
 @kindex C-c @}
 @findex org-table-toggle-coordinate-overlays
@@ -3037,25 +3038,25 @@ Turn the coordinate grid in the table on and off.
 @end table
 
 Making a table field blank does not remove the formula associated with
-the field, because that is stored in a different line (the @samp{#+TBLFM}
+the field, because that is stored in a different line (the @code{#+TBLFM}
 line)---during the next recalculation the field will be filled again.
 To remove a formula from a field, you have to give an empty reply when
-prompted for the formula, or to edit the @samp{#+TBLFM} line.
+prompted for the formula, or to edit the @code{#+TBLFM} line.
 
 @kindex C-c C-c
-You may edit the @samp{#+TBLFM} directly and re-apply the changed
+You may edit the @code{#+TBLFM} directly and re-apply the changed
 equations with @kbd{C-c C-c} in that line or with the normal
 recalculation commands in the table.
 
 @anchor{Using multiple #+TBLFM lines}
-@subsubheading Using multiple #+TBLFM lines
-@cindex #+TBLFM line, multiple
-@cindex #+TBLFM
-@cindex #+TBLFM, switching
+@subsubheading Using multiple @code{#+TBLFM} lines
+@cindex @code{#+TBLFM} line, multiple
+@cindex @code{#+TBLFM}
+@cindex @code{#+TBLFM}, switching
 @kindex C-c C-c
 
 You may apply the formula temporarily.  This is useful when you
-switch the formula.  Place multiple @samp{#+TBLFM} lines right
+switch the formula.  Place multiple @code{#+TBLFM} lines right
 after the table, and then press @kbd{C-c C-c} on the formula to
 apply.  Here is an example:
 
@@ -3082,7 +3083,7 @@ Pressing @kbd{C-c C-c} in the line of @samp{#+TBLFM: $2=$1*2} yields:
 
 @noindent
 Note: If you recalculate this table (with @kbd{C-u C-c *}, for example), you
-will get the following result of applying only the first @samp{#+TBLFM} line.
+will get the following result of applying only the first @code{#+TBLFM} line.
 
 @example
 | x | y |
@@ -3131,10 +3132,10 @@ hline are left alone, assuming that these are part of the table header.
 Iterate the table by recomputing it until no further changes occur.
 This may be necessary if some computed fields use the value of other
 fields that are computed @i{later} in the calculation sequence.
-@item M-x org-table-recalculate-buffer-tables RET
+@item M-x org-table-recalculate-buffer-tables @key{RET}
 @findex org-table-recalculate-buffer-tables
 Recompute all tables in the current buffer.
-@item M-x org-table-iterate-buffer-tables RET
+@item M-x org-table-iterate-buffer-tables @key{RET}
 @findex org-table-iterate-buffer-tables
 Iterate all tables in the current buffer, in order to converge table-to-table
 dependencies.
@@ -3249,7 +3250,7 @@ functions.
 @section Org-Plot
 @cindex graph, in tables
 @cindex plot tables using Gnuplot
-@cindex #+PLOT
+@cindex @code{#+PLOT}
 
 Org-Plot can produce graphs of information stored in org tables, either
 graphically or in ASCII-art.
@@ -3432,7 +3433,7 @@ internal structure of all links, use the menu entry
 @cindex links, internal
 @cindex targets, for links
 
-@cindex property, CUSTOM_ID
+@cindex property, @code{CUSTOM_ID}
 If the link does not look like a URL, it is considered to be internal in the
 current file.  The most important case is a link like
 @samp{[[#my-custom-id]]} which will link to the entry with the
@@ -3448,7 +3449,7 @@ point to the corresponding headline.  The preferred match for a text link is
 a @i{dedicated target}: the same string in double angular brackets, like
 @samp{<<My Target>>}.
 
-@cindex #+NAME
+@cindex @code{#+NAME}
 If no dedicated target exists, the link will then try to match the exact name
 of an element within the buffer.  Naming is done with the @code{#+NAME}
 keyword, which has to be put in the line before the element it refers to, as
@@ -3640,8 +3641,8 @@ removed from the link and result in a wrong link---you should avoid putting
 timestamp in the headline.}.
 
 @vindex org-id-link-to-org-use-id
-@cindex property, CUSTOM_ID
-@cindex property, ID
+@cindex property, @code{CUSTOM_ID}
+@cindex property, @code{ID}
 If the headline has a @code{CUSTOM_ID} property, a link to this custom ID
 will be stored.  In addition or alternatively (depending on the value of
 @code{org-id-link-to-org-use-id}), a globally unique @code{ID} property will
@@ -3708,7 +3709,7 @@ becomes the default description.
 @b{Inserting stored links}@*
 All links stored during the
 current session are part of the history for this prompt, so you can access
-them with @key{up} and @key{down} (or @kbd{M-p/n}).
+them with @key{UP} and @key{DOWN} (or @kbd{M-p/n}).
 
 @b{Completion support}@* Completion with @key{TAB} will help you to insert
 valid link prefixes like @samp{https:}, including the prefixes
@@ -3883,7 +3884,7 @@ what the Org author is doing besides Emacs hacking with
 If you need special abbreviations just for a single Org buffer, you
 can define them in the file with
 
-@cindex #+LINK
+@cindex @code{#+LINK}
 @example
 #+LINK: bugzilla  http://10.1.2.9/bugzilla/show_bug.cgi?id=
 #+LINK: google    http://www.google.com/search?q=%s
@@ -4041,9 +4042,9 @@ completion; otherwise force cycling through TODO states with no prompt.  When
 @code{org-use-fast-todo-selection} is set to @code{prefix}, use the fast
 selection interface.
 
-@kindex S-@key{right}
-@kindex S-@key{left}
-@item S-@key{right} @ @r{/} @ S-@key{left}
+@kindex S-RIGHT
+@kindex S-LEFT
+@item S-@key{RIGHT} @ @r{/} @ S-@key{LEFT}
 @vindex org-treat-S-cursor-todo-selection-as-state-change
 Select the following/preceding TODO state, similar to cycling.  Useful
 mostly if more than two TODO states are possible (@pxref{TODO
@@ -4124,7 +4125,7 @@ With this setup, the command @kbd{C-c C-t} will cycle an entry from TODO
 to FEEDBACK, then to VERIFY, and finally to DONE and DELEGATED@.  You may
 also use a numeric prefix argument to quickly select a specific state.  For
 example @kbd{C-3 C-c C-t} will change the state immediately to VERIFY@.
-Or you can use @kbd{S-@key{left}} to go backward through the sequence.  If you
+Or you can use @kbd{S-@key{LEFT}} to go backward through the sequence.  If you
 define many keywords, you can use in-buffer completion
 (@pxref{Completion}) or even a special one-key selection scheme
 (@pxref{Fast access to TODO states}) to insert these words into the
@@ -4190,23 +4191,23 @@ select the correct sequence.  Besides the obvious ways like typing a
 keyword or using completion, you may also apply the following commands:
 
 @table @kbd
-@kindex C-S-@key{right}
-@kindex C-S-@key{left}
+@kindex C-S-RIGHT
+@kindex C-S-LEFT
 @kindex C-u C-u C-c C-t
 @item C-u C-u C-c C-t
-@itemx C-S-@key{right}
-@itemx C-S-@key{left}
+@itemx C-S-@key{RIGHT}
+@itemx C-S-@key{LEFT}
 These keys jump from one TODO subset to the next.  In the above example,
-@kbd{C-u C-u C-c C-t} or @kbd{C-S-@key{right}} would jump from @code{TODO} or
+@kbd{C-u C-u C-c C-t} or @kbd{C-S-@key{RIGHT}} would jump from @code{TODO} or
 @code{DONE} to @code{REPORT}, and any of the words in the second row to
 @code{CANCELED}.  Note that the @kbd{C-S-} key binding conflict with
 @code{shift-selection-mode} (@pxref{Conflicts}).
-@kindex S-@key{right}
-@kindex S-@key{left}
-@item S-@key{right}
-@itemx S-@key{left}
-@kbd{S-@key{left}} and @kbd{S-@key{right}} and walk through @emph{all}
-keywords from all sets, so for example @kbd{S-@key{right}} would switch
+@kindex S-RIGHT
+@kindex S-LEFT
+@item S-@key{RIGHT}
+@itemx S-@key{LEFT}
+@kbd{S-@key{LEFT}} and @kbd{S-@key{RIGHT}} and walk through @emph{all}
+keywords from all sets, so for example @kbd{S-@key{RIGHT}} would switch
 from @code{DONE} to @code{REPORT} in the example above.  See also
 @ref{Conflicts}, for a discussion of the interaction with
 @code{shift-selection-mode}.
@@ -4229,8 +4230,8 @@ each keyword, in parentheses@footnote{All characters are allowed except
 @end lisp
 
 @vindex org-fast-tag-selection-include-todo
-If you then press @kbd{C-c C-t} followed by the selection key, the entry
-will be switched to this state.  @kbd{SPC} can be used to remove any TODO
+If you then press @kbd{C-c C-t} followed by the selection key, the entry will
+be switched to this state.  @kbd{@key{SPC}} can be used to remove any TODO
 keyword from an entry.@footnote{Check also the option
 @code{org-fast-tag-selection-include-todo}, it allows you to change the TODO
 state through the tags interface (@pxref{Setting tags}), in case you like to
@@ -4241,9 +4242,9 @@ unique keys across both sets of keywords.}
 @subsection Setting up keywords for individual files
 @cindex keyword options
 @cindex per-file keywords
-@cindex #+TODO
-@cindex #+TYP_TODO
-@cindex #+SEQ_TODO
+@cindex @code{#+TODO}
+@cindex @code{#+TYP_TODO}
+@cindex @code{#+SEQ_TODO}
 
 It can be very useful to use different aspects of the TODO mechanism in
 different files.  For file-local settings, you need to add special lines to
@@ -4269,7 +4270,7 @@ A setup for using several sets in parallel would be:
 @end example
 
 @cindex completion, of option keywords
-@kindex M-@key{TAB}
+@kindex M-TAB
 @noindent To make sure you are using the correct keyword, type
 @samp{#+} into the buffer and then use @kbd{M-@key{TAB}} completion.
 
@@ -4318,7 +4319,7 @@ foreground or a background color.
 @cindex TODO dependencies, NOBLOCKING
 
 @vindex org-enforce-todo-dependencies
-@cindex property, ORDERED
+@cindex property, @code{ORDERED}
 The structure of Org files (hierarchy and lists) makes it easy to define TODO
 dependencies.  Usually, a parent TODO task should not be marked DONE until
 all subtasks (defined as children tasks) are marked as DONE@.  And sometimes
@@ -4357,7 +4358,7 @@ property:
 @table @kbd
 @orgcmd{C-c C-x o,org-toggle-ordered-property}
 @vindex org-track-ordered-property-with-tag
-@cindex property, ORDERED
+@cindex property, @code{ORDERED}
 Toggle the @code{ORDERED} property of the current entry.  A property is used
 for this behavior because this should be local to the current entry, not
 inherited like a tag.  However, if you would like to @i{track} the value of
@@ -4419,7 +4420,7 @@ Then each time you turn an entry from a TODO (not-done) state into any of the
 DONE states, a line @samp{CLOSED: [timestamp]} will be inserted just after
 the headline.  If you turn the entry back into a TODO item through further
 state cycling, that line will be removed again.  If you turn the entry back
-to a non-TODO state (by pressing @key{C-c C-t SPC} for example), that line
+to a non-TODO state (by pressing @key{C-c C-t @key{SPC}} for example), that line
 will also be removed, unless you set @code{org-closed-keep-when-no-todo} to
 non-@code{nil}.  If you want to record a note along with the timestamp,
 use@footnote{The corresponding in-buffer setting is: @code{#+STARTUP:
@@ -4439,7 +4440,7 @@ the entry with a @samp{Closing Note} heading.
 
 @vindex org-log-states-order-reversed
 @vindex org-log-into-drawer
-@cindex property, LOG_INTO_DRAWER
+@cindex property, @code{LOG_INTO_DRAWER}
 When TODO keywords are used as workflow states (@pxref{Workflow states}), you
 might want to keep track of when a state change occurred and maybe take a
 note about this change.  You can either record just a timestamp, or a
@@ -4449,8 +4450,8 @@ headline as an itemized list, newest first@footnote{See the option
 want to get the notes out of the way into a drawer (@pxref{Drawers}).
 Customize @code{org-log-into-drawer} to get this behavior---the recommended
 drawer for this is called @code{LOGBOOK}@footnote{Note that the
-@code{LOGBOOK} drawer is unfolded when pressing @key{SPC} in the agenda to
-show an entry---use @key{C-u SPC} to keep it folded here}.  You can also
+@code{LOGBOOK} drawer is unfolded when pressing @kbd{@key{SPC}} in the agenda to
+show an entry---use @kbd{C-u @key{SPC}} to keep it folded here}.  You can also
 overrule the setting of this variable for a subtree by setting a
 @code{LOG_INTO_DRAWER} property.
 
@@ -4493,12 +4494,12 @@ to a buffer:
 #+TODO: TODO(t) WAIT(w@@/!) | DONE(d!) CANCELED(c@@)
 @end example
 
-@cindex property, LOGGING
-In order to define logging settings that are local to a subtree or a
-single item, define a LOGGING property in this entry.  Any non-empty
-LOGGING property resets all logging settings to @code{nil}.  You may then turn
-on logging for this specific tree using STARTUP keywords like
-@code{lognotedone} or @code{logrepeat}, as well as adding state specific
+@cindex property, @code{LOGGING}
+In order to define logging settings that are local to a subtree or a single
+item, define a @code{LOGGING} property in this entry.  Any non-empty
+@code{LOGGING} property resets all logging settings to @code{nil}.  You may
+then turn on logging for this specific tree using @code{#+STARTUP} keywords
+like @code{lognotedone} or @code{logrepeat}, as well as adding state specific
 settings like @code{TODO(!)}.  For example
 
 @example
@@ -4642,7 +4643,7 @@ items.
 
 @table @kbd
 @item @kbd{C-c ,}
-@kindex @kbd{C-c ,}
+@kindex C-c ,
 @findex org-priority
 Set the priority of the current headline (@command{org-priority}).  The
 command prompts for a priority character @samp{A}, @samp{B} or @samp{C}.
@@ -4650,7 +4651,7 @@ When you press @key{SPC} instead, the priority cookie is removed from the
 headline.  The priorities can also be changed ``remotely'' from the agenda
 buffer with the @kbd{,} command (@pxref{Agenda commands}).
 @c
-@orgcmdkkcc{S-@key{up},S-@key{down},org-priority-up,org-priority-down}
+@orgcmdkkcc{S-@key{UP},S-@key{DOWN},org-priority-up,org-priority-down}
 @vindex org-priority-start-cycle-with-default
 Increase/decrease priority of current headline@footnote{See also the option
 @code{org-priority-start-cycle-with-default}.}.  Note that these keys are
@@ -4669,7 +4670,7 @@ these values (highest, lowest, default) like this (please make sure that
 the highest priority is earlier in the alphabet than the lowest
 priority):
 
-@cindex #+PRIORITIES
+@cindex @code{#+PRIORITIES}
 @example
 #+PRIORITIES: A C B
 @end example
@@ -4698,7 +4699,7 @@ be updated each time the TODO status of a child changes, or when pressing
 ** DONE Talk to neighbor
 @end example
 
-@cindex property, COOKIE_DATA
+@cindex property, @code{COOKIE_DATA}
 If a heading has both checkboxes and TODO children below it, the meaning of
 the statistics cookie become ambiguous.  Set the property
 @code{COOKIE_DATA} to either @samp{checkbox} or @samp{todo} to resolve
@@ -4770,7 +4771,7 @@ checked.
 
 @cindex statistics, for checkboxes
 @cindex checkbox statistics
-@cindex property, COOKIE_DATA
+@cindex property, @code{COOKIE_DATA}
 @vindex org-checkbox-hierarchical-statistics
 The @samp{[2/4]} and @samp{[1/3]} in the first and second line are cookies
 indicating how many checkboxes present in this entry have been checked off,
@@ -4792,7 +4793,7 @@ to either @samp{checkbox} or @samp{todo} to resolve this issue.
 
 @cindex blocking, of checkboxes
 @cindex checkbox blocking
-@cindex property, ORDERED
+@cindex property, @code{ORDERED}
 If the current outline node has an @code{ORDERED} property, checkboxes must
 be checked off in sequence, and an error will be thrown if you try to check
 off a box while there are unchecked boxes above it.
@@ -4829,7 +4830,7 @@ Insert a new item with a checkbox.  This works only if the cursor is already
 in a plain list item (@pxref{Plain lists}).
 @orgcmd{C-c C-x o,org-toggle-ordered-property}
 @vindex org-track-ordered-property-with-tag
-@cindex property, ORDERED
+@cindex property, @code{ORDERED}
 Toggle the @code{ORDERED} property of the entry, to toggle if checkboxes must
 be checked off in sequence.  A property is used for this behavior because
 this should be local to the current entry, not inherited like a tag.
@@ -4897,7 +4898,7 @@ a hypothetical level zero that surrounds the entire file.  Use a line like
 this@footnote{As with all these in-buffer settings, pressing @kbd{C-c C-c}
 activates any changes in the line.}:
 
-@cindex #+FILETAGS
+@cindex @code{#+FILETAGS}
 @example
 #+FILETAGS: :Peter:Boss:Secret:
 @end example
@@ -4931,7 +4932,7 @@ can really speed up agenda generation.
 @cindex setting tags
 @cindex tags, setting
 
-@kindex M-@key{TAB}
+@kindex M-TAB
 Tags can simply be typed into the buffer at the end of a headline.
 After a colon, @kbd{M-@key{TAB}} offers completion on tags.  There is
 also a special command for inserting tags:
@@ -4959,7 +4960,7 @@ currently used in the buffer.  You may also globally specify a hard list
 of tags with the variable @code{org-tag-alist}.  Finally you can set
 the default tags for a given file with lines like
 
-@cindex #+TAGS
+@cindex @code{#+TAGS}
 @example
 #+TAGS: @@work @@home @@tennisclub
 #+TAGS: laptop car pc sailboat
@@ -4978,7 +4979,7 @@ If you have a preferred set of tags that you would like to use in every file,
 in addition to those defined on a per-file basis by TAGS option lines, then
 you may specify a list of tags with the variable
 @code{org-tag-persistent-alist}.  You may turn this off on a per-file basis
-by adding a STARTUP option line to that file:
+by adding a @code{#+STARTUP} option line to that file:
 
 @example
 #+STARTUP: noptag
@@ -5062,17 +5063,17 @@ will turn off any other tags from that group.
 In this interface, you can also use the following special keys:
 
 @table @kbd
-@kindex @key{TAB}
+@kindex TAB
 @item @key{TAB}
 Enter a tag in the minibuffer, even if the tag is not in the predefined
 list.  You will be able to complete on all tags present in the buffer.
 You can also add several tags: just separate them with a comma.
 
-@kindex @key{SPC}
+@kindex SPC
 @item @key{SPC}
 Clear all tags for this line.
 
-@kindex @key{RET}
+@kindex RET
 @item @key{RET}
 Accept the modified set.
 
@@ -5328,8 +5329,8 @@ publishers and the number of disks in a box like this:
 
 If you want to set properties that can be inherited by any entry in a
 file, use a line like
-@cindex property, _ALL
-@cindex #+PROPERTY
+@cindex property, @code{_ALL}
+@cindex @code{#+PROPERTY}
 @example
 #+PROPERTY: NDisks_ALL 1 2 3 4
 @end example
@@ -5340,7 +5341,7 @@ buffer with @kbd{C-c C-c} to activate this change.
 If you want to add to the value of an existing property, append a @code{+} to
 the property name.  The following results in the property @code{var} having
 the value ``foo=1 bar=2''.
-@cindex property, +
+@cindex property, @code{+}
 @example
 #+PROPERTY: var  foo=1
 #+PROPERTY: var+ bar=2
@@ -5349,7 +5350,7 @@ the value ``foo=1 bar=2''.
 It is also possible to add to the values of inherited properties.  The
 following results in the @code{genres} property having the value ``Classic
 Baroque'' under the @code{Goldberg Variations} subtree.
-@cindex property, +
+@cindex property, @code{+}
 @example
 * CD collection
 ** Classic
@@ -5383,8 +5384,8 @@ in the current file will be offered as possible completions.
 @orgcmd{C-c C-x p,org-set-property}
 Set a property.  This prompts for a property name and a value.  If
 necessary, the property drawer is created as well.
-@item C-u M-x org-insert-drawer RET
-@cindex org-insert-drawer
+@item C-u M-x org-insert-drawer @key{RET}
+@cindex @code{org-insert-drawer}
 Insert a property drawer into the current entry.  The drawer will be
 inserted early in the entry, but after the lines with planning
 information like deadlines.
@@ -5393,7 +5394,7 @@ With the cursor in a property drawer, this executes property commands.
 @orgcmd{C-c C-c s,org-set-property}
 Set a property in the current entry.  Both the property and the value
 can be inserted using completion.
-@orgcmdkkcc{S-@key{right},S-@key{left},org-property-next-allowed-value,org-property-previous-allowed-value}
+@orgcmdkkcc{S-@key{RIGHT},S-@key{LEFT},org-property-next-allowed-value,org-property-previous-allowed-value}
 Switch property at point to the next/previous allowed value.
 @orgcmd{C-c C-c d,org-delete-property}
 Remove a property from the current entry.
@@ -5415,20 +5416,20 @@ a column view (@pxref{Column view}), or to use them in queries.  The
 following property names are special and should not be used as keys in the
 properties drawer:
 
-@cindex property, special, ALLTAGS
-@cindex property, special, BLOCKED
-@cindex property, special, CLOCKSUM
-@cindex property, special, CLOCKSUM_T
-@cindex property, special, CLOSED
-@cindex property, special, DEADLINE
-@cindex property, special, FILE
-@cindex property, special, ITEM
-@cindex property, special, PRIORITY
-@cindex property, special, SCHEDULED
-@cindex property, special, TAGS
-@cindex property, special, TIMESTAMP
-@cindex property, special, TIMESTAMP_IA
-@cindex property, special, TODO
+@cindex property, special, @code{ALLTAGS}
+@cindex property, special, @code{BLOCKED}
+@cindex property, special, @code{CLOCKSUM}
+@cindex property, special, @code{CLOCKSUM_T}
+@cindex property, special, @code{CLOSED}
+@cindex property, special, @code{DEADLINE}
+@cindex property, special, @code{FILE}
+@cindex property, special, @code{ITEM}
+@cindex property, special, @code{PRIORITY}
+@cindex property, special, @code{SCHEDULED}
+@cindex property, special, @code{TAGS}
+@cindex property, special, @code{TIMESTAMP}
+@cindex property, special, @code{TIMESTAMP_IA}
+@cindex property, special, @code{TODO}
 @example
 ALLTAGS      @r{All tags, including inherited ones.}
 BLOCKED      @r{"t" if task is currently blocked by children or siblings.}
@@ -5508,7 +5509,7 @@ search will stop at this value and return @code{nil}.
 Org mode has a few properties for which inheritance is hard-coded, at
 least for the special applications for which they are used:
 
-@cindex property, COLUMNS
+@cindex property, @code{COLUMNS}
 @table @code
 @item COLUMNS
 The @code{:COLUMNS:} property defines the format of column view
@@ -5517,16 +5518,16 @@ where a @code{:COLUMNS:} property is defined is used as the starting
 point for a column view table, independently of the location in the
 subtree from where columns view is turned on.
 @item CATEGORY
-@cindex property, CATEGORY
+@cindex property, @code{CATEGORY}
 For agenda view, a category set through a @code{:CATEGORY:} property
 applies to the entire subtree.
 @item ARCHIVE
-@cindex property, ARCHIVE
+@cindex property, @code{ARCHIVE}
 For archiving, the @code{:ARCHIVE:} property may define the archive
 location for the entire subtree (@pxref{Moving subtrees}).
 @item LOGGING
-@cindex property, LOGGING
-The LOGGING property may define logging settings for an entry or a
+@cindex property, @code{LOGGING}
+The @code{LOGGING} property may define logging settings for an entry or a
 subtree (@pxref{Tracking TODO state changes}).
 @end table
 
@@ -5571,7 +5572,7 @@ done by defining a column format line.
 
 To define a column format for an entire file, use a line like
 
-@cindex #+COLUMNS
+@cindex @code{#+COLUMNS}
 @example
 #+COLUMNS: %25ITEM %TAGS %PRIORITY %TODO
 @end example
@@ -5723,17 +5724,17 @@ Same as @kbd{r}.
 @orgcmd{q,org-columns-quit}
 Exit column view.
 @tsubheading{Editing values}
-@item @key{left} @key{right} @key{up} @key{down}
+@item @key{LEFT} @key{RIGHT} @key{UP} @key{DOWN}
 Move through the column view from field to field.
-@kindex S-@key{left}
-@kindex S-@key{right}
-@item  S-@key{left}/@key{right}
+@kindex S-LEFT
+@kindex S-RIGHT
+@item  S-@key{LEFT}/@key{RIGHT}
 Switch to the next/previous allowed value of the field.  For this, you
 have to have specified allowed values for a property.
 @item 1..9,0
 Directly select the Nth allowed value, @kbd{0} selects the 10th value.
 @orgcmdkkcc{n,p,org-columns-next-allowed-value,org-columns-previous-allowed-value}
-Same as @kbd{S-@key{left}/@key{right}}
+Same as @kbd{S-@key{LEFT}/@key{RIGHT}}
 @orgcmd{e,org-columns-edit-value}
 Edit the property at point.  For the special properties, this will
 invoke the same interface that you normally use to change that
@@ -5752,9 +5753,9 @@ current column view.
 @tsubheading{Modifying the table structure}
 @orgcmdkkcc{<,>,org-columns-narrow,org-columns-widen}
 Make the column narrower/wider by one character.
-@orgcmd{S-M-@key{right},org-columns-new}
+@orgcmd{S-M-@key{RIGHT},org-columns-new}
 Insert a new column, to the left of the current column.
-@orgcmd{S-M-@key{left},org-columns-delete}
+@orgcmd{S-M-@key{LEFT},org-columns-delete}
 Delete the current column.
 @end table
 
@@ -5766,7 +5767,7 @@ exported or printed directly.  If you want to capture a column view, use
 a @code{columnview} dynamic block (@pxref{Dynamic blocks}).  The frame
 of this block looks like this:
 
-@cindex #+BEGIN, columnview
+@cindex @code{#+BEGIN}, columnview
 @example
 * The column view
 #+BEGIN: columnview :hlines 1 :id "label"
@@ -5782,7 +5783,7 @@ This is the most important parameter.  Column view is a feature that is
 often localized to a certain (sub)tree, and the capture block might be
 at a different location in the file.  To identify the tree whose view to
 capture, you can use 4 values:
-@cindex property, ID
+@cindex property, @code{ID}
 @example
 local     @r{use the tree in which the capture block is located}
 global    @r{make a global view, including all headings in the file}
@@ -5790,7 +5791,7 @@ global    @r{make a global view, including all headings in the file}
           @r{run column view at the top of this file}
 "@var{ID}"      @r{call column view in the tree that has an @code{:ID:}}
           @r{property with the value @i{label}.  You can use}
-          @r{@kbd{M-x org-id-copy RET} to create a globally unique ID for}
+          @r{@kbd{M-x org-id-copy @key{RET}} to create a globally unique @code{ID} for}
           @r{the current entry and copy it to the kill-ring.}
 @end example
 @item :hlines
@@ -5814,7 +5815,7 @@ The following commands insert or update the dynamic block:
 @table @kbd
 @orgcmd{C-c C-x i,org-insert-columns-dblock}
 Insert a dynamic block capturing a column view.  You will be prompted
-for the scope or ID of the view.
+for the scope or @code{ID} of the view.
 @orgcmdkkc{C-c C-c,C-c C-x C-u,org-dblock-update}
 Update dynamic block at point.
 @orgcmd{C-u C-c C-x C-u,org-update-all-dblocks}
@@ -6008,11 +6009,11 @@ instead.
 Access the agenda for the date given by the timestamp or -range at
 point (@pxref{Weekly/daily agenda}).
 @c
-@orgcmdkkcc{S-@key{left},S-@key{right},org-timestamp-down-day,org-timestamp-up-day}
+@orgcmdkkcc{S-@key{LEFT},S-@key{RIGHT},org-timestamp-down-day,org-timestamp-up-day}
 Change date at cursor by one day.  These key bindings conflict with
 shift-selection and related modes (@pxref{Conflicts}).
 @c
-@orgcmdkkcc{S-@key{up},S-@key{down},org-timestamp-up,org-timestamp-down-down}
+@orgcmdkkcc{S-@key{UP},S-@key{DOWN},org-timestamp-up,org-timestamp-down-down}
 Change the item under the cursor in a timestamp.  The cursor can be on a
 year, month, day, hour or minute.  When the timestamp contains a time range
 like @samp{15:30-16:30}, modifying the first time will also shift the second,
@@ -6136,25 +6137,25 @@ from the minibuffer:
 @kindex M-v
 @kindex C-v
 @kindex mouse-1
-@kindex S-@key{right}
-@kindex S-@key{left}
-@kindex S-@key{down}
-@kindex S-@key{up}
-@kindex M-S-@key{right}
-@kindex M-S-@key{left}
-@kindex @key{RET}
-@kindex M-S-@key{down}
-@kindex M-S-@key{up}
+@kindex S-RIGHT
+@kindex S-LEFT
+@kindex S-DOWN
+@kindex S-UP
+@kindex M-S-RIGHT
+@kindex M-S-LEFT
+@kindex RET
+@kindex M-S-DOWN
+@kindex M-S-UP
 
 @example
 @key{RET}              @r{Choose date at cursor in calendar.}
 mouse-1            @r{Select date by clicking on it.}
-S-@key{right}/@key{left}   @r{One day forward/backward.}
-S-@key{down}/@key{up}      @r{One week forward/backward.}
-M-S-@key{right}/@key{left} @r{One month forward/backward.}
+S-@key{RIGHT}/@key{LEFT}   @r{One day forward/backward.}
+S-@key{DOWN}/@key{UP}      @r{One week forward/backward.}
+M-S-@key{RIGHT}/@key{LEFT} @r{One month forward/backward.}
 > / <              @r{Scroll calendar forward/backward by one month.}
 M-v / C-v          @r{Scroll calendar forward/backward by 3 months.}
-M-S-@key{down}/@key{up}    @r{Scroll calendar forward/backward by one year.}
+M-S-@key{DOWN}/@key{UP}    @r{Scroll calendar forward/backward by one year.}
 @end example
 
 @vindex org-read-date-display-live
@@ -6194,10 +6195,10 @@ following consequences:
 You cannot place the cursor onto a timestamp anymore, only before or
 after.
 @item
-The @kbd{S-@key{up}/@key{down}} keys can no longer be used to adjust
+The @kbd{S-@key{UP}/@key{DOWN}} keys can no longer be used to adjust
 each component of a timestamp.  If the cursor is at the beginning of
-the stamp, @kbd{S-@key{up}/@key{down}} will change the stamp by one day,
-just like @kbd{S-@key{left}/@key{right}}.  At the end of the stamp, the
+the stamp, @kbd{S-@key{UP}/@key{DOWN}} will change the stamp by one day,
+just like @kbd{S-@key{LEFT}/@key{RIGHT}}.  At the end of the stamp, the
 time will be changed by one minute.
 @item
 If the timestamp contains a range of clock times or a repeater, these
@@ -6222,7 +6223,7 @@ they refer to.
 
 @table @var
 @item DEADLINE
-@cindex DEADLINE keyword
+@cindex @code{DEADLINE} keyword
 
 Meaning: the task (most likely a TODO item, though not necessarily) is supposed
 to be finished on that date.
@@ -6248,7 +6249,7 @@ deactivated if the task gets scheduled and you set
 @code{org-agenda-skip-deadline-prewarning-if-scheduled} to @code{t}.
 
 @item SCHEDULED
-@cindex SCHEDULED keyword
+@cindex @code{SCHEDULED} keyword
 
 Meaning: you are planning to start working on that task on the given
 date.
@@ -6313,7 +6314,7 @@ an item:
 @table @kbd
 @c
 @orgcmd{C-c C-d,org-deadline}
-Insert @samp{DEADLINE} keyword along with a stamp.  Any CLOSED timestamp will
+Insert @code{DEADLINE} keyword along with a stamp.  Any CLOSED timestamp will
 be removed.  When called with a prefix arg, an existing deadline will be
 removed from the entry.  Depending on the variable
 @code{org-log-redeadline}@footnote{with corresponding @code{#+STARTUP}
@@ -6322,7 +6323,7 @@ keywords @code{logredeadline}, @code{lognoteredeadline}, and
 deadline.
 
 @orgcmd{C-c C-s,org-schedule}
-Insert @samp{SCHEDULED} keyword along with a stamp.  Any CLOSED timestamp
+Insert @code{SCHEDULED} keyword along with a stamp.  Any CLOSED timestamp
 will be removed.  When called with a prefix argument, remove the scheduling
 date from the entry.  Depending on the variable
 @code{org-log-reschedule}@footnote{with corresponding @code{#+STARTUP}
@@ -6356,8 +6357,8 @@ to the previous week before any current timestamp.
 @cindex tasks, repeated
 @cindex repeated tasks
 
-Some tasks need to be repeated again and again.  Org mode helps to
-organize such tasks using a so-called repeater in a DEADLINE, SCHEDULED,
+Some tasks need to be repeated again and again.  Org mode helps to organize
+such tasks using a so-called repeater in a @code{DEADLINE}, @code{SCHEDULED},
 or plain timestamp.  In the following example
 @example
 ** TODO Pay the rent
@@ -6374,18 +6375,18 @@ first and the warning period last: @code{DEADLINE: <2005-10-01 Sat +1m -3d>}.
 @vindex org-todo-repeat-to-state
 Deadlines and scheduled items produce entries in the agenda when they are
 over-due, so it is important to be able to mark such an entry as completed
-once you have done so.  When you mark a DEADLINE or a SCHEDULE with the TODO
-keyword DONE, it will no longer produce entries in the agenda.  The problem
-with this is, however, that then also the @emph{next} instance of the
-repeated entry will not be active.  Org mode deals with this in the following
-way: When you try to mark such an entry DONE (using @kbd{C-c C-t}), it will
-shift the base date of the repeating timestamp by the repeater interval, and
-immediately set the entry state back to TODO@footnote{In fact, the target
-state is taken from, in this sequence, the @code{REPEAT_TO_STATE} property or
-the variable @code{org-todo-repeat-to-state}.  If neither of these is
-specified, the target state defaults to the first state of the TODO state
-sequence.}.  In the example above, setting the state to DONE would actually
-switch the date like this:
+once you have done so.  When you mark a @code{DEADLINE} or a @code{SCHEDULED}
+with the TODO keyword DONE, it will no longer produce entries in the agenda.
+The problem with this is, however, that then also the @emph{next} instance of
+the repeated entry will not be active.  Org mode deals with this in the
+following way: When you try to mark such an entry DONE (using @kbd{C-c C-t}),
+it will shift the base date of the repeating timestamp by the repeater
+interval, and immediately set the entry state back to TODO@footnote{In fact,
+the target state is taken from, in this sequence, the @code{REPEAT_TO_STATE}
+property or the variable @code{org-todo-repeat-to-state}.  If neither of
+these is specified, the target state defaults to the first state of the TODO
+state sequence.}.  In the example above, setting the state to DONE would
+actually switch the date like this:
 
 @example
 ** TODO Pay the rent
@@ -6491,22 +6492,21 @@ what to do with it.
 @orgcmd{C-c C-x C-i,org-clock-in}
 @vindex org-clock-into-drawer
 @vindex org-clock-continuously
-@cindex property, LOG_INTO_DRAWER
-Start the clock on the current item (clock-in).  This inserts the CLOCK
-keyword together with a timestamp.  If this is not the first clocking of
-this item, the multiple CLOCK lines will be wrapped into a
-@code{:LOGBOOK:} drawer (see also the variable
-@code{org-clock-into-drawer}).  You can also overrule
-the setting of this variable for a subtree by setting a
-@code{CLOCK_INTO_DRAWER} or @code{LOG_INTO_DRAWER} property.
-When called with a @kbd{C-u} prefix argument,
-select the task from a list of recently clocked tasks.  With two @kbd{C-u
-C-u} prefixes, clock into the task at point and mark it as the default task;
-the default task will then always be available with letter @kbd{d} when
-selecting a clocking task.  With three @kbd{C-u C-u C-u} prefixes, force
-continuous clocking by starting the clock when the last clock stopped.@*
-@cindex property: CLOCK_MODELINE_TOTAL
-@cindex property: LAST_REPEAT
+@cindex property, @code{LOG_INTO_DRAWER}
+!Start the clock on the current item (clock-in).  This inserts the
+@code{CLOCK} keyword together with a timestamp.  If this is not the first
+clocking of this item, the multiple @code{CLOCK} lines will be wrapped into a
+@code{:LOGBOOK:} drawer (see also the variable @code{org-clock-into-drawer}).
+You can also overrule the setting of this variable for a subtree by setting a
+@code{CLOCK_INTO_DRAWER} or @code{LOG_INTO_DRAWER} property.  When called
+with a @kbd{C-u} prefix argument, select the task from a list of recently
+clocked tasks.  With two @kbd{C-u C-u} prefixes, clock into the task at point
+and mark it as the default task; the default task will then always be
+available with letter @kbd{d} when selecting a clocking task.  With three
+@kbd{C-u C-u C-u} prefixes, force continuous clocking by starting the clock
+when the last clock stopped.@*
+@cindex property, @code{CLOCK_MODELINE_TOTAL}
+@cindex property, @code{LAST_REPEAT}
 @vindex org-clock-modeline-total
 While the clock is running, the current clocking time is shown in the mode
 line, along with the title of the task.  The clock time shown will be all
@@ -6554,7 +6554,7 @@ clock duration keeps the same.
 @orgcmd{S-M-@key{up/down},org-timestamp-up/down}
 On @code{CLOCK} log lines, increase/decrease the timestamp at point and
 the one of the previous (or the next clock) timestamp by the same duration.
-For example, if you hit @kbd{S-M-@key{up}} to increase a clocked-out timestamp
+For example, if you hit @kbd{S-M-@key{UP}} to increase a clocked-out timestamp
 by five minutes, then the clocked-in timestamp of the next clock will be
 increased by five minutes.
 @orgcmd{C-c C-t,org-todo}
@@ -6605,7 +6605,7 @@ Update dynamic block at point.
 @orgkey{C-u C-c C-x C-u}
 Update all dynamic blocks (@pxref{Dynamic blocks}).  This is useful if
 you have several clock table blocks in a buffer.
-@orgcmdkxkc{S-@key{left},S-@key{right},org-clocktable-try-shift}
+@orgcmdkxkc{S-@key{LEFT},S-@key{RIGHT},org-clocktable-try-shift}
 Shift the current @code{:block} interval and update the table.  The cursor
 needs to be in the @code{#+BEGIN: clocktable} line for this command.  If
 @code{:block} is @code{today}, it will be shifted to @code{today-1} etc.
@@ -6615,7 +6615,7 @@ needs to be in the @code{#+BEGIN: clocktable} line for this command.  If
 Here is an example of the frame for a clock table as it is inserted into the
 buffer with the @kbd{C-c C-x C-r} command:
 
-@cindex #+BEGIN, clocktable
+@cindex @code{#+BEGIN}, clocktable
 @example
 #+BEGIN: clocktable :maxlevel 2 :emphasize nil :scope file
 #+END: clocktable
@@ -6655,7 +6655,7 @@ be selected:
              thismonth, lastmonth, thismonth-@var{N}  @r{a relative month}
              thisyear, lastyear, thisyear-@var{N}     @r{a relative year}
              untilnow
-             @r{Use @kbd{S-@key{left}/@key{right}} keys to shift the time interval.}
+             @r{Use @kbd{S-@key{LEFT}/@key{RIGHT}} keys to shift the time interval.}
 :tstart      @r{A time string specifying when to start considering times.}
              @r{Relative times like @code{"<-2w>"} can also be used.  See}
              @r{@ref{Matching tags and properties} for relative time syntax.}
@@ -6691,8 +6691,8 @@ but you can specify your own function using the @code{:formatter} parameter.
              @r{E.g., @code{:sort (1 . ?a)} sorts the first column alphabetically.}
 :compact     @r{Abbreviation for @code{:level nil :indent t :narrow 40! :tcolumns 1}}
              @r{All are overwritten except if there is an explicit @code{:narrow}}
-:timestamp   @r{A timestamp for the entry, when available.  Look for SCHEDULED,}
-             @r{DEADLINE, TIMESTAMP and TIMESTAMP_IA, in this order.}
+:timestamp   @r{A timestamp for the entry, when available.  Look for @code{SCHEDULED},}
+             @r{@code{DEADLINE}, @code{TIMESTAMP} and @code{TIMESTAMP_IA}, in this order.}
 :properties  @r{List of properties that should be shown in the table.  Each}
              @r{property will get its own column.}
 :inherit-props @r{When this flag is @code{t}, the values for @code{:properties} will be inherited.}
@@ -6805,7 +6805,8 @@ identical to dealing with away time due to idleness; it is just happening due
 to a recovery event rather than a set amount of idle time.
 
 You can also check all the files visited by your Org agenda for dangling
-clocks at any time using @kbd{M-x org-resolve-clocks RET} (or @kbd{C-c C-x C-z}).
+clocks at any time using @kbd{M-x org-resolve-clocks @key{RET}} (or @kbd{C-c
+C-x C-z}).
 
 @subsubheading Continuous clocking
 @cindex continuous clocking
@@ -6823,7 +6824,7 @@ with @code{org-clock-in} and two @kbd{C-u C-u} with @code{org-clock-in-last}.
 @section Effort estimates
 @cindex effort estimates
 
-@cindex property, Effort
+@cindex property, @code{EFFORT}
 If you want to plan your work in a very detailed way, or if you need to
 produce offers with quotations of the estimated work effort, you may want to
 assign effort estimates to entries.  If you are also clocking your work, you
@@ -6861,7 +6862,7 @@ In particular if you want to use this setup also in the agenda, a global
 setup may be advised.
 
 The way to assign estimates to individual items is then to switch to column
-mode, and to use @kbd{S-@key{right}} and @kbd{S-@key{left}} to change the
+mode, and to use @kbd{S-@key{RIGHT}} and @kbd{S-@key{LEFT}} to change the
 value.  The values you enter will immediately be summed up in the hierarchy.
 In the column next to it, any clocked time will be displayed.
 
@@ -6965,7 +6966,7 @@ If your configuration depends on @file{org-remember.el}, you need to update
 it and use the setup described below.  To convert your
 @code{org-remember-templates}, run the command
 @example
-@kbd{M-x org-capture-import-remember-templates RET}
+@kbd{M-x org-capture-import-remember-templates @key{RET}}
 @end example
 @noindent and then customize the new variable with @kbd{M-x
 customize-variable org-capture-templates}, check the result, and save the
@@ -7041,7 +7042,7 @@ Visit the last stored capture item in its buffer.
 @end table
 
 @vindex org-capture-bookmark
-@cindex org-capture-last-stored
+@cindex @code{org-capture-last-stored}
 You can also jump to the bookmark @code{org-capture-last-stored}, which will
 automatically be created unless you set @code{org-capture-bookmark} to
 @code{nil}.
@@ -7462,12 +7463,12 @@ Delete all of a task's attachments.  A safer way is to open the directory in
 @command{dired} and delete from there.
 
 @orgcmdtkc{s,C-c C-a s,org-attach-set-directory}
-@cindex property, ATTACH_DIR
+@cindex property, @code{ATTACH_DIR}
 Set a specific directory as the entry's attachment directory.  This works by
 putting the directory path into the @code{ATTACH_DIR} property.
 
 @orgcmdtkc{i,C-c C-a i,org-attach-set-inherit}
-@cindex property, ATTACH_DIR_INHERIT
+@cindex property, @code{ATTACH_DIR_INHERIT}
 Set the @code{ATTACH_DIR_INHERIT} property, so that children will use the
 same directory for attachments as the parent does.
 @end table
@@ -7641,14 +7642,14 @@ javascript:location.href='org-protocol://open-source?&url='+
       encodeURIComponent(location.href)
 @end example
 
-@cindex protocol, open-source, :base-url property
-@cindex :base-url property in open-source protocol
-@cindex protocol, open-source, :working-directory property
-@cindex :working-directory property in open-source protocol
-@cindex protocol, open-source, :online-suffix property
-@cindex :online-suffix property in open-source protocol
-@cindex protocol, open-source, :working-suffix property
-@cindex :working-suffix property in open-source protocol
+@cindex protocol, open-source, @code{:base-url} property
+@cindex @code{:base-url} property in open-source protocol
+@cindex protocol, open-source, @code{:working-directory} property
+@cindex @code{:working-directory} property in open-source protocol
+@cindex protocol, open-source, @code{:online-suffix} property
+@cindex @code{:online-suffix} property in open-source protocol
+@cindex protocol, open-source, @code{:working-suffix} property
+@cindex @code{:working-suffix} property in open-source protocol
 @vindex org-protocol-project-alist
 The variable @code{org-protocol-project-alist} maps URLs to local file names,
 by stripping URL parameters from the end and replacing the @code{:base-url}
@@ -7685,8 +7686,8 @@ to something like
 @code{open-source} handler probably cannot find a file named
 @file{/home/user/example/print/posters.html.php} and fails.
 
-@cindex protocol, open-source, :rewrites property
-@cindex :rewrites property in open-source protocol
+@cindex protocol, open-source, @code{:rewrites} property
+@cindex @code{:rewrites property} in open-source protocol
 Such an entry in @code{org-protocol-project-alist} may hold an additional
 property @code{:rewrites}.  This property is a list of cons cells, each of
 which maps a regular expression to a path relative to the
@@ -7837,12 +7838,12 @@ see the documentation string of the variable
 
 There is also an in-buffer option for setting this variable, for example:
 
-@cindex #+ARCHIVE
+@cindex @code{#+ARCHIVE}
 @example
 #+ARCHIVE: %s_done::
 @end example
 
-@cindex property, ARCHIVE
+@cindex property, @code{ARCHIVE}
 @noindent
 If you would like to have a special ARCHIVE location for a single entry
 or a (sub)tree, give the entry an @code{:ARCHIVE:} property with the
@@ -7909,7 +7910,7 @@ To do this, each subtree is checked for open TODO entries.  If none are
 found, the command offers to set the ARCHIVE tag for the child.  If the
 cursor is @emph{not} on a headline when this command is invoked, the
 level 1 trees will be checked.
-@orgcmd{C-@kbd{TAB},org-force-cycle-archived}
+@orgcmd{C-@key{TAB},org-force-cycle-archived}
 Cycle a tree even if it is tagged with ARCHIVE.
 @orgcmd{C-c C-x A,org-archive-to-archive-sibling}
 Move the current entry to the @emph{Archive Sibling}.  This is a sibling of
@@ -8021,8 +8022,7 @@ Remove current file from the list of agenda files.
 @orgcmd{C-',org-cycle-agenda-files}
 @itemx C-,
 Cycle through agenda file list, visiting one file after the other.
-@kindex M-x org-iswitchb
-@item M-x org-iswitchb RET
+@item M-x org-iswitchb @key{RET}
 Command to use an @code{iswitchb}-like interface to switch to and between Org
 buffers.
 @end table
@@ -8150,7 +8150,7 @@ The purpose of the weekly/daily @emph{agenda} is to act like a page of a
 paper agenda, showing all the tasks for the current week or day.
 
 @table @kbd
-@cindex org-agenda, command
+@cindex @code{org-agenda}, command
 @orgcmd{C-c a a,org-agenda-list}
 Compile an agenda for the current week from a list of Org files.  The agenda
 shows the entries for each day.  With a numeric prefix@footnote{For backward
@@ -8637,7 +8637,7 @@ associated with the item.
 @subsection Categories
 
 @cindex category
-@cindex #+CATEGORY
+@cindex @code{#+CATEGORY}
 The category is a broad label assigned to each agenda item.  By default, the
 category is simply derived from the file name, but you can also specify it
 with a special line in the buffer, like this:
@@ -8647,8 +8647,8 @@ with a special line in the buffer, like this:
 @end example
 
 @noindent
-@cindex property, CATEGORY
-If you would like to have a special CATEGORY for a single entry or a
+@cindex property, @code{CATEGORY}
+If you would like to have a special @code{CATEGORY} for a single entry or a
 (sub)tree, give the entry a @code{:CATEGORY:} property with the
 special category you want to apply as the value.
 
@@ -8788,12 +8788,13 @@ excluding the next tag.
 Org also supports automatic, context-aware tag filtering.  If the variable
 @code{org-agenda-auto-exclude-function} is set to a user-defined function,
 that function can decide which tags should be excluded from the agenda
-automatically.  Once this is set, the @kbd{/} command then accepts @kbd{RET}
-as a sub-option key and runs the auto exclusion logic.  For example, let's
-say you use a @code{Net} tag to identify tasks which need network access, an
-@code{Errand} tag for errands in town, and a @code{Call} tag for making phone
-calls.  You could auto-exclude these tags based on the availability of the
-Internet, and outside of business hours, with something like this:
+automatically.  Once this is set, the @kbd{/} command then accepts
+@kbd{@key{RET}} as a sub-option key and runs the auto exclusion logic.  For
+example, let's say you use a @code{Net} tag to identify tasks which need
+network access, an @code{Errand} tag for errands in town, and a @code{Call}
+tag for making phone calls.  You could auto-exclude these tags based on the
+availability of the Internet, and outside of business hours, with something
+like this:
 
 @smalllisp
 @group
@@ -8949,9 +8950,9 @@ the other commands, the cursor needs to be in the desired line.
 @tsubheading{Motion}
 @cindex motion commands in agenda
 @orgcmd{n,org-agenda-next-line}
-Next line (same as @key{down} and @kbd{C-n}).
+Next line (same as @key{DOWN} and @kbd{C-n}).
 @orgcmd{p,org-agenda-previous-line}
-Previous line (same as @key{up} and @kbd{C-p}).
+Previous line (same as @key{UP} and @kbd{C-p}).
 @orgcmd{N,org-agenda-next-item}
 Next item: same as next line, but only consider items.
 @orgcmd{P,org-agenda-previous-item}
@@ -9004,7 +9005,7 @@ Delete other windows.
 @xorgcmd{v t,org-agenda-fortnight-view}
 @xorgcmd{v m,org-agenda-month-view}
 @xorgcmd{v y,org-agenda-year-view}
-@xorgcmd{v SPC,org-agenda-reset-view}
+@xorgcmd{v @key{SPC},org-agenda-reset-view}
 @vindex org-agenda-span
 Switch to day/week/month/year view.  When switching to day or week view, this
 setting becomes the default for subsequent agenda refreshes.  Since month and
@@ -9102,8 +9103,8 @@ Toggle the time grid on and off.  See also the variables
 @c
 @orgcmd{r,org-agenda-redo}
 Recreate the agenda buffer, for example to reflect the changes after
-modification of the timestamps of items with @kbd{S-@key{left}} and
-@kbd{S-@key{right}}.  When the buffer is the global TODO list, a prefix
+modification of the timestamps of items with @kbd{S-@key{LEFT}} and
+@kbd{S-@key{RIGHT}}.  When the buffer is the global TODO list, a prefix
 argument is interpreted to create a selective list for a specific TODO
 keyword.
 @orgcmd{g,org-agenda-redo}
@@ -9167,8 +9168,8 @@ both in the agenda buffer and in the remote buffer.
 Change the TODO state of the item, both in the agenda and in the
 original org file.
 @c
-@orgcmd{C-S-@key{right},org-agenda-todo-nextset}
-@orgcmd{C-S-@key{left},org-agenda-todo-previousset}
+@orgcmd{C-S-@key{RIGHT},org-agenda-todo-nextset}
+@orgcmd{C-S-@key{LEFT},org-agenda-todo-previousset}
 Switch to the next/previous set of TODO keywords.
 @c
 @orgcmd{C-k,org-agenda-kill}
@@ -9218,12 +9219,12 @@ the priority cookie is removed from the entry.
 @orgcmd{P,org-agenda-show-priority}
 Display weighted priority of current item.
 @c
-@orgcmdkkc{+,S-@key{up},org-agenda-priority-up}
+@orgcmdkkc{+,S-@key{UP},org-agenda-priority-up}
 Increase the priority of the current item.  The priority is changed in
 the original buffer, but the agenda is not resorted.  Use the @kbd{r}
 key for this.
 @c
-@orgcmdkkc{-,S-@key{down},org-agenda-priority-down}
+@orgcmdkkc{-,S-@key{DOWN},org-agenda-priority-down}
 Decrease the priority of the current item.
 @c
 @orgcmdkkc{z,C-c C-z,org-agenda-add-note}
@@ -9241,19 +9242,19 @@ Schedule this item.  With prefix arg remove the scheduling timestamp
 @orgcmd{C-c C-d,org-agenda-deadline}
 Set a deadline for this item.  With prefix arg remove the deadline.
 @c
-@orgcmd{S-@key{right},org-agenda-do-date-later}
+@orgcmd{S-@key{RIGHT},org-agenda-do-date-later}
 Change the timestamp associated with the current line by one day into the
 future.  If the date is in the past, the first call to this command will move
 it to today.@*
 With a numeric prefix argument, change it by that many days.  For example,
-@kbd{3 6 5 S-@key{right}} will change it by a year.  With a @kbd{C-u} prefix,
+@kbd{3 6 5 S-@key{RIGHT}} will change it by a year.  With a @kbd{C-u} prefix,
 change the time by one hour.  If you immediately repeat the command, it will
 continue to change hours even without the prefix arg.  With a double @kbd{C-u
 C-u} prefix, do the same for changing minutes.@*
 The stamp is changed in the original Org file, but the change is not directly
 reflected in the agenda buffer.  Use @kbd{r} or @kbd{g} to update the buffer.
 @c
-@orgcmd{S-@key{left},org-agenda-do-date-earlier}
+@orgcmd{S-@key{LEFT},org-agenda-do-date-earlier}
 Change the timestamp associated with the current line by one day
 into the past.
 @c
@@ -9423,7 +9424,7 @@ calendars.
 @orgcmd{H,org-agenda-holidays}
 Show holidays for three months around the cursor date.
 
-@item M-x org-icalendar-combine-agenda-files RET
+@item M-x org-icalendar-combine-agenda-files @key{RET}
 Export a single iCalendar file containing entries from all agenda files.
 This is a globally available command, and also available in the agenda menu.
 
@@ -9860,7 +9861,7 @@ does not have a specific format---defined in a property, or in its file---it
 uses @code{org-columns-default-format}.
 
 @item
-@cindex property, special, CLOCKSUM
+@cindex property, special, @code{CLOCKSUM}
 If any of the columns has a summary type defined (@pxref{Column attributes}),
 turning on column view in the agenda will visit all relevant agenda files and
 make sure that the computations of this property are up to date.  This is
@@ -9884,7 +9885,7 @@ clocked time in the displayed period use clock table mode (press @kbd{R} in
 the agenda).
 
 @item
-@cindex property, special, CLOCKSUM_T
+@cindex property, special, @code{CLOCKSUM_T}
 When the column view in the agenda shows the @code{CLOCKSUM_T}, that is
 always today's clocked time for this item.  So even in the weekly agenda, the
 clocksum listed in column view only originates from today.  This lets you
@@ -9924,7 +9925,7 @@ To preserve the line breaks, indentation and blank lines in a region, but
 otherwise use normal formatting, you can use this construct, which can also
 be used to format poetry.
 
-@cindex #+BEGIN_VERSE
+@cindex @code{#+BEGIN_VERSE}
 @cindex verse blocks
 @example
 #+BEGIN_VERSE
@@ -9940,7 +9941,7 @@ When quoting a passage from another document, it is customary to format this
 as a paragraph that is indented on both the left and the right margin.  You
 can include quotations in Org mode documents like this:
 
-@cindex #+BEGIN_QUOTE
+@cindex @code{#+BEGIN_QUOTE}
 @cindex quote blocks
 @example
 #+BEGIN_QUOTE
@@ -9950,7 +9951,7 @@ but not any simpler -- Albert Einstein
 @end example
 
 If you would like to center some text, do it like this:
-@cindex #+BEGIN_CENTER
+@cindex @code{#+BEGIN_CENTER}
 @cindex center blocks
 @example
 #+BEGIN_CENTER
@@ -9994,8 +9995,8 @@ a horizontal line.
 @section Images and Tables
 
 @cindex tables, markup rules
-@cindex #+CAPTION
-@cindex #+NAME
+@cindex @code{#+CAPTION}
+@cindex @code{#+NAME}
 Both the native Org mode tables (@pxref{Tables}) and tables formatted with
 the @file{table.el} package will be exported properly.  For Org mode tables,
 the lines before the first horizontal separator line will become table header
@@ -10046,7 +10047,7 @@ or may not be handled.
 You can include literal examples that should not be subjected to
 markup.  Such examples will be typeset in monospace, so this is well suited
 for source code and similar examples.
-@cindex #+BEGIN_EXAMPLE
+@cindex @code{#+BEGIN_EXAMPLE}
 
 @example
 #+BEGIN_EXAMPLE
@@ -10085,7 +10086,7 @@ example@footnote{Code in @samp{src} blocks may also be evaluated either
 interactively or on export.  @xref{Working with source code}, for more
 information on evaluating code blocks.}, see @ref{Easy templates} for
 shortcuts to easily insert code blocks.
-@cindex #+BEGIN_SRC
+@cindex @code{#+BEGIN_SRC}
 
 @example
 #+BEGIN_SRC emacs-lisp
@@ -10234,7 +10235,7 @@ for display purposes only.
 @cindex dash, special symbol
 @cindex ellipsis, special symbol
 In addition to regular entities defined above, Org exports in a special
-way@footnote{This behaviour can be disabled with @code{-} export setting
+way@footnote{This behavior can be disabled with @code{-} export setting
 (@pxref{Export settings}).} the following commonly used character
 combinations: @samp{\-} is treated as a shy hyphen, @samp{--} and @samp{---}
 are converted into dashes, and @samp{...} becomes a compact set of dots.
@@ -10407,14 +10408,14 @@ To disable it, simply use
 
 CD@LaTeX{} mode is a minor mode that is normally used in combination with a
 major @LaTeX{} mode like AUC@TeX{} in order to speed-up insertion of
-environments and math templates.  Inside Org mode, you can make use of
-some of the features of CD@LaTeX{} mode.  You need to install
-@file{cdlatex.el} and @file{texmathp.el} (the latter comes also with
-AUC@TeX{}) from @url{https://staff.fnwi.uva.nl/c.dominik/Tools/cdlatex}.
-Don't use CD@LaTeX{} mode itself under Org mode, but use the light
-version @code{org-cdlatex-mode} that comes as part of Org mode.  Turn it
-on for the current buffer with @kbd{M-x org-cdlatex-mode RET}, or for all
-Org files with
+environments and math templates.  Inside Org mode, you can make use of some
+of the features of CD@LaTeX{} mode.  You need to install @file{cdlatex.el}
+and @file{texmathp.el} (the latter comes also with AUC@TeX{}) from
+@url{https://staff.fnwi.uva.nl/c.dominik/Tools/cdlatex}.  Don't use
+CD@LaTeX{} mode itself under Org mode, but use the light version
+@code{org-cdlatex-mode} that comes as part of Org mode.  Turn it on for the
+current buffer with @kbd{M-x org-cdlatex-mode @key{RET}}, or for all Org
+files with
 
 @lisp
 (add-hook 'org-mode-hook 'turn-on-org-cdlatex)
@@ -10427,7 +10428,7 @@ details see the documentation of CD@LaTeX{} mode):
 @item
 Environment templates can be inserted with @kbd{C-c @{}.
 @item
-@kindex @key{TAB}
+@kindex TAB
 The @key{TAB} key will do template expansion if the cursor is inside a
 @LaTeX{} fragment@footnote{Org mode has a method to test if the cursor is
 inside such a fragment, see the documentation of the function
@@ -10438,7 +10439,8 @@ the second brace.  Even outside fragments, @key{TAB} will expand
 environment abbreviations at the beginning of a line.  For example, if
 you write @samp{equ} at the beginning of a line and press @key{TAB},
 this abbreviation will be expanded to an @code{equation} environment.
-To get a list of all abbreviations, type @kbd{M-x cdlatex-command-help RET}.
+To get a list of all abbreviations, type @kbd{M-x cdlatex-command-help
+@key{RET}}.
 @item
 @kindex _
 @kindex ^
@@ -10600,7 +10602,7 @@ Org document by adjusting outline visibility settings.
 @section Export settings
 @cindex Export, settings
 
-@cindex #+OPTIONS
+@cindex @code{#+OPTIONS}
 Export options can be set: globally with variables; for an individual file by
 making variables buffer-local with in-buffer settings (@pxref{In-buffer
 settings}), by setting individual keywords, or by specifying them in a
@@ -10608,7 +10610,7 @@ compact form with the @code{#+OPTIONS} keyword; or for a tree by setting
 properties (@pxref{Properties and columns}).  Options set at a specific level
 override options set at a more general level.
 
-@cindex #+SETUPFILE
+@cindex @code{#+SETUPFILE}
 In-buffer settings may appear anywhere in the file, either directly or
 indirectly through a file included using @samp{#+SETUPFILE: filename or URL}
 syntax.  Option keyword sets tailored to a particular back-end can be
@@ -10616,37 +10618,37 @@ inserted from the export dispatcher (@pxref{The export dispatcher}) using the
 @code{Insert template} command by pressing @key{#}.  To insert keywords
 individually, a good way to make sure the keyword is correct is to type
 @code{#+} and then to use @kbd{M-@key{TAB}}@footnote{Many desktops intercept
-@kbd{M-TAB} to switch windows.  Use @kbd{C-M-i} or @kbd{@key{ESC} @key{TAB}}
-instead.} for completion.
+@kbd{M-@key{TAB}} to switch windows.  Use @kbd{C-M-i} or @kbd{@key{ESC}
+@key{TAB}} instead.} for completion.
 
 The export keywords available for every back-end, and their equivalent global
 variables, include:
 
 @table @samp
 @item AUTHOR
-@cindex #+AUTHOR
+@cindex @code{#+AUTHOR}
 @vindex user-full-name
 The document author (@code{user-full-name}).
 
 @item CREATOR
-@cindex #+CREATOR
+@cindex @code{#+CREATOR}
 @vindex org-export-creator-string
 Entity responsible for output generation (@code{org-export-creator-string}).
 
 @item DATE
-@cindex #+DATE
+@cindex @code{#+DATE}
 @vindex org-export-date-timestamp-format
 A date or a time-stamp@footnote{The variable
 @code{org-export-date-timestamp-format} defines how this time-stamp will be
 exported.}.
 
 @item EMAIL
-@cindex #+EMAIL
+@cindex @code{#+EMAIL}
 @vindex user-mail-address
 The email address (@code{user-mail-address}).
 
 @item LANGUAGE
-@cindex #+LANGUAGE
+@cindex @code{#+LANGUAGE}
 @vindex org-export-default-language
 Language to use for translating certain strings
 (@code{org-export-default-language}).  With @samp{#+LANGUAGE: fr}, for
@@ -10654,7 +10656,7 @@ example, Org translates @emph{Table of contents} to the French @emph{Table
 des matières}.
 
 @item SELECT_TAGS
-@cindex #+SELECT_TAGS
+@cindex @code{#+SELECT_TAGS}
 @vindex org-export-select-tags
 The default value is @code{:export:}.  When a tree is tagged with
 @code{:export:} (@code{org-export-select-tags}), Org selects that tree and
@@ -10663,7 +10665,7 @@ see below.  When selectively exporting files with @code{:export:} tags set,
 Org does not export any text that appears before the first headline.
 
 @item EXCLUDE_TAGS
-@cindex #+EXCLUDE_TAGS
+@cindex @code{#+EXCLUDE_TAGS}
 @vindex org-export-exclude-tags
 The default value is @code{:noexport:}.  When a tree is tagged with
 @code{:noexport:} (@code{org-export-exclude-tags}), Org excludes that tree
@@ -10673,12 +10675,12 @@ unconditionally excluded from the export, even if they have an
 code blocks contained in them.
 
 @item TITLE
-@cindex #+TITLE
+@cindex @code{#+TITLE}
 @cindex document title
 Org displays this title.  For long titles, use multiple @code{#+TITLE} lines.
 
 @item EXPORT_FILE_NAME
-@cindex #+EXPORT_FILE_NAME
+@cindex @code{#+EXPORT_FILE_NAME}
 The name of the output file to be generated.  Otherwise, Org generates the
 file name based on the buffer name and the extension based on the back-end
 format.
@@ -10784,7 +10786,7 @@ Toggle inclusion of inlinetasks (@code{org-export-with-inlinetasks}).
 
 @item num:
 @vindex org-export-with-section-numbers
-@cindex property, UNNUMBERED
+@cindex property, @code{UNNUMBERED}
 Toggle section-numbers (@code{org-export-with-section-numbers}).  When set to
 number @samp{n}, Org numbers only those headlines at level @samp{n} or above.
 Setting @code{UNNUMBERED} property to non-@code{nil} disables numbering of
@@ -10860,7 +10862,7 @@ respectively, @samp{EXPORT_DATE} and @samp{EXPORT_FILE_NAME}.  Except for
 @samp{SETUPFILE}, all other keywords listed above have an @samp{EXPORT_}
 equivalent.
 
-@cindex #+BIND
+@cindex @code{#+BIND}
 @vindex org-export-allow-bind-keywords
 If @code{org-export-allow-bind-keywords} is non-@code{nil}, Emacs variables
 can become buffer-local during export by using the BIND keyword.  Its syntax
@@ -10873,7 +10875,7 @@ settings that cannot be changed using keywords.
 @cindex list of tables
 @cindex list of listings
 
-@cindex #+TOC
+@cindex @code{#+TOC}
 @vindex org-export-with-toc
 Org normally inserts the table of contents directly before the first headline
 of the file.  Org sets the TOC depth the same as the headline levels in the
@@ -10919,7 +10921,7 @@ with captions.
 #+TOC: tables             @r{build a list of tables}
 @end example
 
-@cindex property, ALT_TITLE
+@cindex property, @code{ALT_TITLE}
 Normally Org uses the headline for its entry in the table of contents.  But
 with @code{ALT_TITLE} property, a different entry can be specified for the
 table of contents.
@@ -10929,7 +10931,7 @@ table of contents.
 @cindex include files, during export
 Include other files during export.  For example, to include your @file{.emacs}
 file, you could use:
-@cindex #+INCLUDE
+@cindex @code{#+INCLUDE}
 
 @example
 #+INCLUDE: "~/.emacs" src emacs-lisp
@@ -11001,7 +11003,7 @@ Visit the include file at point.
 @node Macro replacement
 @section Macro replacement
 @cindex macro replacement, during export
-@cindex #+MACRO
+@cindex @code{#+MACRO}
 
 @vindex org-export-global-macros
 Macros replace text snippets during export.  Macros are defined globally in
@@ -11093,9 +11095,9 @@ Lines starting with zero or more whitespace characters followed by one
 @samp{#} and a whitespace are treated as comments and, as such, are not
 exported.
 
-@cindex #+BEGIN_COMMENT
-Likewise, regions surrounded by @samp{#+BEGIN_COMMENT}
-... @samp{#+END_COMMENT} are not exported.
+@cindex @code{#+BEGIN_COMMENT}
+Likewise, regions surrounded by @code{#+BEGIN_COMMENT}
+... @code{#+END_COMMENT} are not exported.
 
 @cindex comment trees
 Finally, a @samp{COMMENT} keyword at the beginning of an entry, but after any
@@ -11151,7 +11153,7 @@ settings}).
 
 @table @samp
 @item SUBTITLE
-@cindex #+SUBTITLE (ASCII)
+@cindex @code{#+SUBTITLE} (ASCII)
 The document subtitle.  For long subtitles, use multiple @code{#+SUBTITLE}
 lines in the Org file.  Org prints them on one continuous line, wrapping into
 multiple lines if necessary.
@@ -11168,8 +11170,8 @@ where levels become lists, @pxref{Export settings}.
 To insert text within the Org file by the ASCII back-end, use one the
 following constructs, inline, keyword, or export block:
 
-@cindex #+ASCII
-@cindex #+BEGIN_EXPORT ascii
+@cindex @code{#+ASCII}
+@cindex @code{#+BEGIN_EXPORT ascii}
 @example
 Inline text @@@@ascii:and additional text@@@@ within a paragraph.
 
@@ -11181,7 +11183,7 @@ Org exports text in this block only when using ASCII back-end.
 @end example
 
 @subheading ASCII specific attributes
-@cindex #+ATTR_ASCII
+@cindex @code{#+ATTR_ASCII}
 @cindex horizontal rules, in ASCII export
 
 ASCII back-end recognizes only one attribute, @code{:width}, which specifies
@@ -11195,8 +11197,8 @@ syntax for specifying widths is:
 
 @subheading ASCII special blocks
 @cindex special blocks, in ASCII export
-@cindex #+BEGIN_JUSTIFYLEFT
-@cindex #+BEGIN_JUSTIFYRIGHT
+@cindex @code{#+BEGIN_JUSTIFYLEFT}
+@cindex @code{#+BEGIN_JUSTIFYRIGHT}
 
 Besides @code{#+BEGIN_CENTER} blocks (@pxref{Paragraphs}), ASCII back-end has
 these two left and right justification blocks:
@@ -11254,7 +11256,7 @@ output.  These keywords work similar to the general options settings
 
 @table @samp
 @item BEAMER_THEME
-@cindex #+BEAMER_THEME
+@cindex @code{#+BEAMER_THEME}
 @vindex org-beamer-theme
 The Beamer layout theme (@code{org-beamer-theme}).  Use square brackets for
 options.  For example:
@@ -11263,24 +11265,24 @@ options.  For example:
 @end smallexample
 
 @item BEAMER_FONT_THEME
-@cindex #+BEAMER_FONT_THEME
+@cindex @code{#+BEAMER_FONT_THEME}
 The Beamer font theme.
 
 @item BEAMER_INNER_THEME
-@cindex #+BEAMER_INNER_THEME
+@cindex @code{#+BEAMER_INNER_THEME}
 The Beamer inner theme.
 
 @item BEAMER_OUTER_THEME
-@cindex #+BEAMER_OUTER_THEME
+@cindex @code{#+BEAMER_OUTER_THEME}
 The Beamer outer theme.
 
 @item BEAMER_HEADER
-@cindex #+BEAMER_HEADER
+@cindex @code{#+BEAMER_HEADER}
 Arbitrary lines inserted in the preamble, just before the @samp{hyperref}
 settings.
 
 @item DESCRIPTION
-@cindex #+DESCRIPTION (Beamer)
+@cindex @code{#+DESCRIPTION} (Beamer)
 The document description.  For long descriptions, use multiple
 @code{#+DESCRIPTION} keywords.  By default, @samp{hyperref} inserts
 @code{#+DESCRIPTION} as metadata.  Use @code{org-latex-hyperref-template} to
@@ -11288,7 +11290,7 @@ configure document metadata.  Use @code{org-latex-title-command} to configure
 typesetting of description as part of front matter.
 
 @item KEYWORDS
-@cindex #+KEYWORDS (Beamer)
+@cindex @code{#+KEYWORDS} (Beamer)
 The keywords for defining the contents of the document.  Use multiple
 @code{#+KEYWORDS} lines if necessary.  By default, @samp{hyperref} inserts
 @code{#+KEYWORDS} as metadata.  Use @code{org-latex-hyperref-template} to
@@ -11296,7 +11298,7 @@ configure document metadata.  Use @code{org-latex-title-command} to configure
 typesetting of keywords as part of front matter.
 
 @item SUBTITLE
-@cindex #+SUBTITLE (Beamer)
+@cindex @code{#+SUBTITLE} (Beamer)
 @vindex org-beamer-subtitle-format
 Document's subtitle.  For typesetting, use @code{org-beamer-subtitle-format}
 string.  Use @code{org-latex-hyperref-template} to configure document
@@ -11318,7 +11320,7 @@ Org headlines become Beamer frames when the heading level in Org is equal to
 @code{org-beamer-frame-level} or @code{H} value in an @code{OPTIONS} line
 (@pxref{Export settings}).
 
-@cindex property, BEAMER_ENV
+@cindex property, @code{BEAMER_ENV}
 Org overrides headlines to frames conversion for the current tree of an Org
 file if it encounters the @code{BEAMER_ENV} property set to @code{frame} or
 @code{fullframe}.  Org ignores whatever @code{org-beamer-frame-level} happens
@@ -11337,7 +11339,7 @@ aid and has no semantic relevance.}.  For valid values see
 @code{org-beamer-environments-extra}.
 
 @item
-@cindex property, BEAMER_REF
+@cindex property, @code{BEAMER_REF}
 If @code{BEAMER_ENV} is set to @code{appendix}, Org exports the entry as an
 appendix.  When set to @code{note}, Org exports the entry as a note within
 the frame or between frames, depending on the entry's heading level.  When
@@ -11351,8 +11353,8 @@ not its content.  This is useful for inserting content between frames.  It is
 also useful for properly closing a @code{column} environment.
 @end itemize
 
-@cindex property, BEAMER_ACT
-@cindex property, BEAMER_OPT
+@cindex property, @code{BEAMER_ACT}
+@cindex property, @code{BEAMER_OPT}
 When @code{BEAMER_ACT} is set for a headline, Org export translates that
 headline as an overlay or action specification.  When enclosed in square
 brackets, Org export makes the overlay specification a default.  Use
@@ -11361,7 +11363,7 @@ or block.  The Beamer export back-end wraps with appropriate angular or
 square brackets.  It also adds the @code{fragile} option for any code that may
 require a verbatim block.
 
-@cindex property, BEAMER_COL
+@cindex property, @code{BEAMER_COL}
 To create a column on the Beamer slide, use the @code{BEAMER_COL} property
 for its headline in the Org file.  Set the value of @code{BEAMER_COL} to a
 decimal number representing the fraction of the total text width.  Beamer
@@ -11376,8 +11378,8 @@ needs, use the @code{BEAMER_ENV} property.
 @node Beamer specific syntax
 @subsection Beamer specific syntax
 Since Org's Beamer export back-end is an extension of the @LaTeX{} back-end,
-it recognizes other @LaTeX{} specific syntax---for example, @samp{#+LATEX:}
-or @samp{#+ATTR_LATEX:}.  @xref{@LaTeX{} export}, for details.
+it recognizes other @LaTeX{} specific syntax---for example, @code{#+LATEX:}
+or @code{#+ATTR_LATEX:}.  @xref{@LaTeX{} export}, for details.
 
 Beamer export wraps the table of contents generated with @code{toc:t}
 @code{OPTION} keyword in a @code{frame} environment.  Beamer export does not
@@ -11390,8 +11392,8 @@ contents}).  Use square brackets for specifying options.
 
 Insert Beamer-specific code using the following constructs:
 
-@cindex #+BEAMER
-@cindex #+BEGIN_EXPORT beamer
+@cindex @code{#+BEAMER}
+@cindex @code{#+BEGIN_EXPORT beamer}
 @example
 #+BEAMER: \pause
 
@@ -11412,7 +11414,7 @@ this example:
 A *@@@@beamer:<2->@@@@useful* feature
 @end example
 
-@cindex #+ATTR_BEAMER
+@cindex @code{#+ATTR_BEAMER}
 Beamer export recognizes the @code{ATTR_BEAMER} keyword with the following
 attributes from Beamer configurations: @code{:environment} for changing local
 Beamer environment, @code{:overlay} for specifying Beamer overlays in angular
@@ -11536,66 +11538,66 @@ described in @ref{Export settings}.
 
 @table @samp
 @item DESCRIPTION
-@cindex #+DESCRIPTION (HTML)
+@cindex @code{#+DESCRIPTION} (HTML)
 This is the document's description, which the HTML exporter inserts it as a
 HTML meta tag in the HTML file.  For long descriptions, use multiple
 @code{#+DESCRIPTION} lines.  The exporter takes care of wrapping the lines
 properly.
 
 @item HTML_DOCTYPE
-@cindex #+HTML_DOCTYPE
+@cindex @code{#+HTML_DOCTYPE}
 @vindex org-html-doctype
 Specify the document type, for example: HTML5 (@code{org-html-doctype}).
 
 @item HTML_CONTAINER
-@cindex #+HTML_CONTAINER
+@cindex @code{#+HTML_CONTAINER}
 @vindex org-html-container-element
 Specify the HTML container, such as @samp{div}, for wrapping sections and
 elements (@code{org-html-container-element}).
 
 @item HTML_LINK_HOME
-@cindex #+HTML_LINK_HOME
+@cindex @code{#+HTML_LINK_HOME}
 @vindex org-html-link-home
 The URL for home link (@code{org-html-link-home}).
 
 @item HTML_LINK_UP
-@cindex #+HTML_LINK_UP
+@cindex @code{#+HTML_LINK_UP}
 @vindex org-html-link-up
 The URL for the up link of exported HTML pages (@code{org-html-link-up}).
 
 @item HTML_MATHJAX
-@cindex #+HTML_MATHJAX
+@cindex @code{#+HTML_MATHJAX}
 @vindex org-html-mathjax-options
 Options for MathJax (@code{org-html-mathjax-options}).  MathJax is used to
 typeset @LaTeX{} math in HTML documents.  @xref{Math formatting in HTML
 export}, for an example.
 
 @item HTML_HEAD
-@cindex #+HTML_HEAD
+@cindex @code{#+HTML_HEAD}
 @vindex org-html-head
 Arbitrary lines for appending to the HTML document's head
 (@code{org-html-head}).
 
 @item HTML_HEAD_EXTRA
-@cindex #+HTML_HEAD_EXTRA
+@cindex @code{#+HTML_HEAD_EXTRA}
 @vindex org-html-head-extra
 More arbitrary lines for appending to the HTML document's head
 (@code{org-html-head-extra}).
 
 @item KEYWORDS
-@cindex #+KEYWORDS (HTML)
+@cindex @code{#+KEYWORDS} (HTML)
 Keywords to describe the document's content.  HTML exporter inserts these
 keywords as HTML meta tags.  For long keywords, use multiple
 @code{#+KEYWORDS} lines.
 
 @item LATEX_HEADER
-@cindex #+LATEX_HEADER (HTML)
+@cindex @code{#+LATEX_HEADER} (HTML)
 Arbitrary lines for appending to the preamble; HTML exporter appends when
 transcoding @LaTeX{} fragments to images (@pxref{Math formatting in HTML
 export}).
 
 @item SUBTITLE
-@cindex #+SUBTITLE (HTML)
+@cindex @code{#+SUBTITLE} (HTML)
 The document's subtitle.  HTML exporter formats subtitle if document type is
 @samp{HTML5} and the CSS has a @samp{subtitle} class.
 @end table
@@ -11729,14 +11731,13 @@ back-end can insert that HTML code in the output, use this inline syntax:
 text@@@@html:</b>@@@@}.  For larger raw HTML code blocks, use these HTML
 export code blocks:
 
-@cindex #+HTML
-@cindex #+BEGIN_EXPORT html
+@cindex @code{#+HTML}
 @example
 #+HTML: Literal HTML code for export
 @end example
 
 @noindent or
-@cindex #+BEGIN_EXPORT html
+@cindex @code{#+BEGIN_EXPORT html}
 
 @example
 #+BEGIN_EXPORT html
@@ -11773,7 +11774,7 @@ example, by using @code{#+ATTR_HTML} lines to specify new format attributes
 to @code{<a>} or @code{<img>} tags.  This example shows changing the link's
 @code{title} and @code{style}:
 
-@cindex #+ATTR_HTML
+@cindex @code{#+ATTR_HTML}
 @example
 #+ATTR_HTML: :title The Org mode homepage :style color:red;
 [[http://orgmode.org]]
@@ -11789,8 +11790,8 @@ exporting Org tables to HTML.  By default, the exporter does not draw frames
 and cell borders.  To change for this for a table, use the following lines
 before the table in the Org file:
 
-@cindex #+CAPTION
-@cindex #+ATTR_HTML
+@cindex @code{#+CAPTION}
+@cindex @code{#+ATTR_HTML}
 @example
 #+CAPTION: This is a table with lines around and between cells
 #+ATTR_HTML: :border 2 :rules all :frame border
@@ -11863,8 +11864,8 @@ Org file.  This example shows realignment to right, and adds @code{alt} and
 @code{title} attributes in support of text viewers and modern web accessibility
 standards.
 
-@cindex #+CAPTION
-@cindex #+ATTR_HTML
+@cindex @code{#+CAPTION}
+@cindex @code{#+ATTR_HTML}
 @example
 #+CAPTION: A black cat stalking a spider
 #+ATTR_HTML: :alt cat/spider image :title Action! :align right
@@ -11973,7 +11974,7 @@ p.creator           @r{creator info, about org mode version}
 .done               @r{the DONE keywords, all states that count as done}
 .WAITING            @r{each TODO keyword also uses a class named after itself}
 .timestamp          @r{timestamp}
-.timestamp-kwd      @r{keyword associated with a timestamp, like SCHEDULED}
+.timestamp-kwd      @r{keyword associated with a timestamp, like @code{SCHEDULED}}
 .timestamp-wrapper  @r{span around keyword plus timestamp}
 .tag                @r{tag in a headline}
 ._HOME              @r{each tag uses itself as a class, "@@" replaced by "_"}
@@ -12001,14 +12002,14 @@ p.footnote          @r{footnote definition paragraph, containing a footnote}
 @vindex org-html-head-include-default-style
 @vindex org-html-head
 @vindex org-html-head-extra
-@cindex #+HTML_INCLUDE_STYLE
+@cindex @code{#+HTML_INCLUDE_STYLE}
 The HTML export back-end includes a compact default style in each exported
 HTML file.  To override the default style with another style, use these
 keywords in the Org file.  They will replace the global defaults the HTML
 exporter uses.
 
-@cindex #+HTML_HEAD
-@cindex #+HTML_HEAD_EXTRA
+@cindex @code{#+HTML_HEAD}
+@cindex @code{#+HTML_HEAD_EXTRA}
 @example
 #+HTML_HEAD: <link rel="stylesheet" type="text/css" href="style1.css" />
 #+HTML_HEAD_EXTRA: <link rel="alternate stylesheet" type="text/css" href="style2.css" />
@@ -12058,7 +12059,7 @@ it on your own web server.
 
 To use this program, just add this line to the Org file:
 
-@cindex #+INFOJS_OPT
+@cindex @code{#+INFOJS_OPT}
 @example
 #+INFOJS_OPT: view:info toc:nil
 @end example
@@ -12179,7 +12180,7 @@ The @LaTeX{} export back-end has several additional keywords for customizing
 
 @table @samp
 @item DESCRIPTION
-@cindex #+DESCRIPTION (@LaTeX{})
+@cindex @code{#+DESCRIPTION} (@LaTeX{})
 The document's description.  The description along with author name,
 keywords, and related file metadata are inserted in the output file by the
 @samp{hyperref} package.  See @code{org-latex-hyperref-template} for
@@ -12188,7 +12189,7 @@ typesetting description into the document's front matter.  Use multiple
 @code{#+DESCRIPTION} lines for long descriptions.
 
 @item LATEX_CLASS
-@cindex #+LATEX_CLASS
+@cindex @code{#+LATEX_CLASS}
 @vindex org-latex-default-class
 @vindex org-latex-classes
 This is @LaTeX{} document class, such as @code{article}, @code{report},
@@ -12199,32 +12200,32 @@ default class name from the @code{org-latex-default-class} variable.  Org has
 element of @code{org-latex-classes}.
 
 @item LATEX_CLASS_OPTIONS
-@cindex #+LATEX_CLASS_OPTIONS
+@cindex @code{#+LATEX_CLASS_OPTIONS}
 Options the @LaTeX{} export back-end uses when calling the @LaTeX{} document
 class.
 
 @item LATEX_COMPILER
-@cindex #+LATEX_COMPILER
+@cindex @code{#+LATEX_COMPILER}
 @vindex org-latex-compiler
 The compiler, such as @samp{pdflatex}, @samp{xelatex}, @samp{lualatex}, for
 producing the PDF (@code{org-latex-compiler}).
 
 @item LATEX_HEADER
-@cindex #+LATEX_HEADER
+@cindex @code{#+LATEX_HEADER}
 @vindex org-latex-classes
 Arbitrary lines to add to the document's preamble, before the @samp{hyperref}
 settings.  See @code{org-latex-classes} for adjusting the structure and order
 of the @LaTeX{} headers.
 
 @item LATEX_HEADER_EXTRA
-@cindex #+LATEX_HEADER_EXTRA
+@cindex @code{#+LATEX_HEADER_EXTRA}
 @vindex org-latex-classes
 Arbitrary lines to add to the document's preamble, before the @samp{hyperref}
 settings.  See @code{org-latex-classes} for adjusting the structure and order
 of the @LaTeX{} headers.
 
 @item KEYWORDS
-@cindex #+KEYWORDS (@LaTeX{})
+@cindex @code{#+KEYWORDS} (@LaTeX{})
 The keywords for the document.  The description along with author name,
 keywords, and related file metadata are inserted in the output file by the
 @samp{hyperref} package.  See @code{org-latex-hyperref-template} for
@@ -12233,7 +12234,7 @@ typesetting description into the document's front matter.  Use multiple
 @code{#+KEYWORDS} lines if necessary.
 
 @item SUBTITLE
-@cindex #+SUBTITLE (@LaTeX{})
+@cindex @code{#+SUBTITLE} (@LaTeX{})
 @vindex org-latex-subtitle-separate
 @vindex org-latex-subtitle-format
 The document's subtitle.  It is typeset as per
@@ -12275,10 +12276,10 @@ exporter splices the values of @code{org-latex-default-packages-alist} and
 @code{org-latex-packages-alist}.  Use the same three variables to define
 custom sectioning or custom classes.
 
-@cindex #+LATEX_CLASS
-@cindex #+LATEX_CLASS_OPTIONS
-@cindex property, EXPORT_LATEX_CLASS
-@cindex property, EXPORT_LATEX_CLASS_OPTIONS
+@cindex @code{#+LATEX_CLASS}
+@cindex @code{#+LATEX_CLASS_OPTIONS}
+@cindex property, @code{EXPORT_LATEX_CLASS}
+@cindex property, @code{EXPORT_LATEX_CLASS_OPTIONS}
 The @LaTeX{} export back-end sends the @code{LATEX_CLASS_OPTIONS} keyword and
 @code{EXPORT_LATEX_CLASS_OPTIONS} property as options to the @LaTeX{}
 @code{\documentclass} macro.  The options and the syntax for specifying them,
@@ -12288,8 +12289,8 @@ including enclosing them in square brackets, follow @LaTeX{} conventions.
 #+LATEX_CLASS_OPTIONS: [a4paper,11pt,twoside,twocolumn]
 @end example
 
-@cindex #+LATEX_HEADER
-@cindex #+LATEX_HEADER_EXTRA
+@cindex @code{#+LATEX_HEADER}
+@cindex @code{#+LATEX_HEADER_EXTRA}
 The @LaTeX{} export back-end appends values from @code{LATEX_HEADER} and
 @code{LATEX_HEADER_EXTRA} keywords to the @LaTeX{} header.  The docstring for
 @code{org-latex-classes} explains in more detail.  Also note that @LaTeX{}
@@ -12323,14 +12324,14 @@ Code embedded in-line @@@@latex:any arbitrary LaTeX code@@@@ in a paragraph.
 @end example
 
 Inserting as one or more keyword lines in the Org file:
-@cindex #+LATEX
+@cindex @code{#+LATEX}
 @example
 #+LATEX: any arbitrary LaTeX code
 @end example
 
 Inserting as an export block in the Org file, where the back-end exports any
 code between begin and end markers:
-@cindex #+BEGIN_EXPORT latex
+@cindex @code{#+BEGIN_EXPORT latex}
 @example
 #+BEGIN_EXPORT latex
 any arbitrary LaTeX code
@@ -12340,7 +12341,7 @@ any arbitrary LaTeX code
 @node Tables in @LaTeX{} export
 @subsection Tables in @LaTeX{} export
 @cindex tables, in @LaTeX{} export
-@cindex #+ATTR_LATEX, in tables
+@cindex @code{#+ATTR_LATEX}, in tables
 
 The @LaTeX{} export back-end can pass several @LaTeX{} attributes for table
 contents and layout.  Besides specifying label and caption (@pxref{Images and
@@ -12444,7 +12445,7 @@ Set the caption with the @LaTeX{} command
 @subsection Images in @LaTeX{} export
 @cindex images, inline in @LaTeX{}
 @cindex inlining images in @LaTeX{}
-@cindex #+ATTR_LATEX, in images
+@cindex @code{#+ATTR_LATEX}, in images
 
 The @LaTeX{} export back-end processes image links in Org files that do not
 have descriptions, such as these links @samp{[[file:img.jpg]]} or
@@ -12514,7 +12515,7 @@ Set the @code{:comment-include} attribute to non-@code{nil} value for the
 @node Plain lists in @LaTeX{} export
 @subsection Plain lists in @LaTeX{} export
 @cindex plain lists, in @LaTeX{} export
-@cindex #+ATTR_LATEX, in plain lists
+@cindex @code{#+ATTR_LATEX}, in plain lists
 
 The @LaTeX{} export back-end accepts the @code{:environment} and
 @code{:options} attributes for plain lists.  Both attributes work together
@@ -12548,7 +12549,7 @@ four:
 @node Source blocks in @LaTeX{} export
 @subsection Source blocks in @LaTeX{} export
 @cindex source blocks, in @LaTeX{} export
-@cindex #+ATTR_LATEX, in source blocks
+@cindex @code{#+ATTR_LATEX}, in source blocks
 
 The @LaTeX{} export back-end can make source code blocks into floating
 objects through the attributes @code{:float} and @code{:options}.  For
@@ -12595,7 +12596,7 @@ variables.
 @subsection Example blocks in @LaTeX{} export
 @cindex example blocks, in @LaTeX{} export
 @cindex verbatim blocks, in @LaTeX{} export
-@cindex #+ATTR_LATEX, in example blocks
+@cindex @code{#+ATTR_LATEX}, in example blocks
 
 The @LaTeX{} export back-end wraps the contents of example blocks in a
 @samp{verbatim} environment.  To change this behavior to use another
@@ -12615,7 +12616,7 @@ This sentence is false.
 @cindex special blocks, in @LaTeX{} export
 @cindex abstract, in @LaTeX{} export
 @cindex proof, in @LaTeX{} export
-@cindex #+ATTR_LATEX, in special blocks
+@cindex @code{#+ATTR_LATEX}, in special blocks
 
 
 For other special blocks in the Org file, the @LaTeX{} export back-end makes
@@ -12663,7 +12664,7 @@ example:
 @node Horizontal rules in @LaTeX{} export
 @subsection Horizontal rules in @LaTeX{} export
 @cindex horizontal rules, in @LaTeX{} export
-@cindex #+ATTR_LATEX, in horizontal rules
+@cindex @code{#+ATTR_LATEX}, in horizontal rules
 
 The @LaTeX{} export back-end converts horizontal rules by the specified
 @code{:width} and @code{:thickness} attributes.  For example:
@@ -12747,10 +12748,10 @@ executable.  Without @file{zip}, export cannot finish.
 @anchor{x-export-to-odt}
 @cindex region, active
 @cindex active region
-@cindex transient-mark-mode
+@cindex @code{transient-mark-mode}
 @table @kbd
 @orgcmd{C-c C-e o o,org-odt-export-to-odt}
-@cindex property EXPORT_FILE_NAME
+@cindex property, @code{EXPORT_FILE_NAME}
 
 Export as OpenDocument Text file.
 
@@ -12787,13 +12788,13 @@ output.  Setting these keywords works similar to the general options
 
 @table @samp
 @item DESCRIPTION
-@cindex #+DESCRIPTION (ODT)
+@cindex @code{#+DESCRIPTION} (ODT)
 This is the document's description, which the ODT export back-end inserts as
 document metadata.  For long descriptions, use multiple @code{#+DESCRIPTION}
 lines.
 
 @item KEYWORDS
-@cindex #+KEYWORDS (ODT)
+@cindex @code{#+KEYWORDS} (ODT)
 The keywords for the document.  The ODT export back-end inserts the
 description along with author name, keywords, and related file metadata as
 metadata in the output file.  Use multiple @code{#+KEYWORDS} lines if
@@ -12848,7 +12849,7 @@ generic commands:
 @vindex org-odt-convert
 @table @kbd
 
-@item M-x org-odt-convert RET
+@item M-x org-odt-convert @key{RET}
 Convert an existing document from one format to another.  With a prefix
 argument, opens the newly produced file.
 @end table
@@ -12882,7 +12883,7 @@ Open one, modify, and save as either OpenDocument Text (@file{.odt}) or
 OpenDocument Template (@file{.ott}) file.
 
 @item
-@cindex #+ODT_STYLES_FILE
+@cindex @code{#+ODT_STYLES_FILE}
 @vindex org-odt-styles-file
 Customize the variable @code{org-odt-styles-file} and point it to the
 newly created file.  For additional configuration options
@@ -12941,7 +12942,7 @@ back-end honors any table alignments and relative widths for columns
 Note that the ODT export back-end interprets column widths as weighted
 ratios, the default weight being 1.
 
-@cindex #+ATTR_ODT
+@cindex @code{#+ATTR_ODT}
 
 Specifying @code{:rel-width} property on an @code{#+ATTR_ODT} line controls
 the width of the table.  For example:
@@ -12998,7 +12999,7 @@ when clicked jumps to @uref{http://Orgmode.org} website, do the following
 
 @subsubheading Sizing and scaling of embedded images
 
-@cindex #+ATTR_ODT
+@cindex @code{#+ATTR_ODT}
 Control the size and scale of the embedded images with the @code{#+ATTR_ODT}
 attribute.
 
@@ -13054,7 +13055,7 @@ height:width ratio, do the following
 
 @subsubheading Anchoring of images
 
-@cindex #+ATTR_ODT
+@cindex @code{#+ATTR_ODT}
 The ODT export back-end can anchor images to @samp{"as-char"},
 @samp{"paragraph"}, or @samp{"page"}.  Set the preferred anchor using the
 @code{:anchor} property of the @code{#+ATTR_ODT} line.
@@ -13123,10 +13124,10 @@ To quickly verify the reliability of the @LaTeX{}-to-MathML converter, use
 the following commands:
 
 @table @kbd
-@item M-x org-odt-export-as-odf RET
+@item M-x org-odt-export-as-odf @key{RET}
 Convert a @LaTeX{} math snippet to an OpenDocument formula (@file{.odf}) file.
 
-@item M-x org-odt-export-as-odf-and-open RET
+@item M-x org-odt-export-as-odf-and-open @key{RET}
 Convert a @LaTeX{} math snippet to an OpenDocument formula (@file{.odf}) file
 and open the formula file with the system-registered application.
 @end table
@@ -13452,7 +13453,7 @@ This paragraph is specially formatted and uses bold text.
 @subsubheading Customizing tables in ODT export
 @cindex tables, in ODT export
 
-@cindex #+ATTR_ODT
+@cindex @code{#+ATTR_ODT}
 Override the default table format by specifying a custom table style with the
 @code{#+ATTR_ODT} line.  For a discussion on default formatting of tables
 @pxref{Tables in ODT export}.
@@ -13696,52 +13697,52 @@ Texinfo output.  Setting these keywords works similar to the general options
 @table @samp
 
 @item SUBTITLE
-@cindex #+SUBTITLE (Texinfo)
+@cindex @code{#+SUBTITLE} (Texinfo)
 The document subtitle.
 
 @item SUBAUTHOR
-@cindex #+SUBAUTHOR
+@cindex @code{#+SUBAUTHOR}
 The document subauthor.
 
 @item TEXINFO_FILENAME
-@cindex #+TEXINFO_FILENAME
+@cindex @code{#+TEXINFO_FILENAME}
 The Texinfo filename.
 
 @item TEXINFO_CLASS
-@cindex #+TEXINFO_CLASS
+@cindex @code{#+TEXINFO_CLASS}
 @vindex org-texinfo-default-class
 The default document class (@code{org-texinfo-default-class}), which must be
 a member of @code{org-texinfo-classes}.
 
 @item TEXINFO_HEADER
-@cindex #+TEXINFO_HEADER
+@cindex @code{#+TEXINFO_HEADER}
 Arbitrary lines inserted at the end of the header.
 
 @item TEXINFO_POST_HEADER
-@cindex #+TEXINFO_POST_HEADER
+@cindex @code{#+TEXINFO_POST_HEADER}
 Arbitrary lines inserted after the end of the header.
 
 @item TEXINFO_DIR_CATEGORY
-@cindex #+TEXINFO_DIR_CATEGORY
+@cindex @code{#+TEXINFO_DIR_CATEGORY}
 The directory category of the document.
 
 @item TEXINFO_DIR_TITLE
-@cindex #+TEXINFO_DIR_TITLE
+@cindex @code{#+TEXINFO_DIR_TITLE}
 The directory title of the document.
 
 @item TEXINFO_DIR_DESC
-@cindex #+TEXINFO_DIR_DESC
+@cindex @code{#+TEXINFO_DIR_DESC}
 The directory description of the document.
 
 @item TEXINFO_PRINTED_TITLE
-@cindex #+TEXINFO_PRINTED_TITLE
+@cindex @code{#+TEXINFO_PRINTED_TITLE}
 The printed title of the document.
 @end table
 
 @node Texinfo file header
 @subsection Texinfo file header
 
-@cindex #+TEXINFO_FILENAME
+@cindex @code{#+TEXINFO_FILENAME}
 After creating the header for a Texinfo file, the Texinfo back-end
 automatically generates a name and destination path for the Info file.  To
 override this default with a more sensible path and name, specify the
@@ -13749,8 +13750,8 @@ override this default with a more sensible path and name, specify the
 
 @vindex org-texinfo-coding-system
 @vindex org-texinfo-classes
-@cindex #+TEXINFO_HEADER
-@cindex #+TEXINFO_CLASS
+@cindex @code{#+TEXINFO_HEADER}
+@cindex @code{#+TEXINFO_CLASS}
 Along with the output's file name, the Texinfo header also contains language
 details (@pxref{Export settings}) and encoding system as set in the
 @code{org-texinfo-coding-system} variable.  Insert @code{#+TEXINFO_HEADER}
@@ -13764,14 +13765,14 @@ setting the @code{#+TEXINFO_CLASS} keyword to that class.
 @node Texinfo title and copyright page
 @subsection Texinfo title and copyright page
 
-@cindex #+TEXINFO_PRINTED_TITLE
+@cindex @code{#+TEXINFO_PRINTED_TITLE}
 The default template for hard copy output has a title page with
 @code{#+TITLE} and @code{#+AUTHOR} (@pxref{Export settings}).  To replace the
 regular @code{#+TITLE} with something different for the printed version, use
 the @code{#+TEXINFO_PRINTED_TITLE} and @code{#+SUBTITLE} keywords.  Both
 expect raw Texinfo code for setting their values.
 
-@cindex #+SUBAUTHOR
+@cindex @code{#+SUBAUTHOR}
 If one @code{#+AUTHOR} is not sufficient, add multiple @code{#+SUBAUTHOR}
 keywords.  They have to be set in raw Texinfo code.
 
@@ -13781,7 +13782,7 @@ keywords.  They have to be set in raw Texinfo code.
 #+TEXINFO_PRINTED_TITLE: This Long Title@@inlinefmt@{tex,@@*@} Is Broken in @@TeX@{@}
 @end example
 
-@cindex property, COPYING
+@cindex property, @code{COPYING}
 Copying material is defined in a dedicated headline with a non-@code{nil}
 @code{:COPYING:} property.  The back-end inserts the contents within a
 @code{@@copying} command at the beginning of the document.  The heading
@@ -13809,9 +13810,9 @@ Copyright information is printed on the back of the title page.
 @cindex @code{install-info} parameters, in Texinfo export
 @cindex Texinfo export, @code{install-info} parameters
 
-@cindex #+TEXINFO_DIR_CATEGORY
-@cindex #+TEXINFO_DIR_TITLE
-@cindex #+TEXINFO_DIR_DESC
+@cindex @code{#+TEXINFO_DIR_CATEGORY}
+@cindex @code{#+TEXINFO_DIR_TITLE}
+@cindex @code{#+TEXINFO_DIR_DESC}
 The end result of the Texinfo export process is the creation of an Info file.
 This Info file's metadata has variables for category, title, and description:
 @code{#+TEXINFO_DIR_CATEGORY}, @code{#+TEXINFO_DIR_TITLE}, and
@@ -13831,7 +13832,7 @@ Here is an example that writes to the Info directory file:
 
 @vindex org-texinfo-classes
 @vindex org-texinfo-default-class
-@cindex #+TEXINFO_CLASS
+@cindex @code{#+TEXINFO_CLASS}
 The Texinfo export back-end uses a pre-defined scheme to convert Org
 headlines to an equivalent Texinfo structuring commands.  A scheme like this
 maps top-level headlines to numbered chapters tagged as @code{@@chapter} and
@@ -13846,12 +13847,12 @@ If an Org headline's level has no associated Texinfo structuring command, or
 is below a certain threshold (@pxref{Export settings}), then the Texinfo
 export back-end makes it into a list item.
 
-@cindex property, APPENDIX
+@cindex property, @code{APPENDIX}
 The Texinfo export back-end makes any headline with a non-@code{nil}
 @code{:APPENDIX:} property into an appendix.  This happens independent of the
 Org headline level or the @code{#+TEXINFO_CLASS}.
 
-@cindex property, DESCRIPTION
+@cindex property, @code{DESCRIPTION}
 The Texinfo export back-end creates a menu entry after the Org headline for
 each regular sectioning structure.  To override this with a shorter menu
 entry, use the @code{:ALT_TITLE:} property (@pxref{Table of contents}).
@@ -13877,22 +13878,22 @@ Top Node,,texinfo}, for more information.
 @node Indices
 @subsection Indices
 
-@cindex #+CINDEX
+@cindex @code{#+CINDEX}
 @cindex concept index, in Texinfo export
 @cindex Texinfo export, index, concept
-@cindex #+FINDEX
+@cindex @code{#+FINDEX}
 @cindex function index, in Texinfo export
 @cindex Texinfo export, index, function
-@cindex #+KINDEX
+@cindex @code{#+KINDEX}
 @cindex keystroke index, in Texinfo export
 @cindex Texinfo export, keystroke index
-@cindex #+PINDEX
+@cindex @code{#+PINDEX}
 @cindex program index, in Texinfo export
 @cindex Texinfo export, program index
-@cindex #+TINDEX
+@cindex @code{#+TINDEX}
 @cindex data type index, in Texinfo export
 @cindex Texinfo export, data type index
-@cindex #+VINDEX
+@cindex @code{#+VINDEX}
 @cindex variable index, in Texinfo export
 @cindex Texinfo export, variable index
 The Texinfo export back-end recognizes these indexing keywords if used in the
@@ -13905,7 +13906,7 @@ escaped with @samp{@@} if they not belong to a Texinfo command.
 #+CINDEX: Defining indexing entries
 @end example
 
-@cindex property, INDEX
+@cindex property, @code{INDEX}
 For the back-end to generate an index entry for a headline, set the
 @code{:INDEX:} property to @samp{cp} or @samp{vr}.  These abbreviations come
 from Texinfo that stand for concept index and variable index.  The Texinfo
@@ -13925,8 +13926,8 @@ inserts the index after its contents.
 
 Use any of the following three methods to insert or escape raw Texinfo code:
 
-@cindex #+TEXINFO
-@cindex #+BEGIN_EXPORT texinfo
+@cindex @code{#+TEXINFO}
+@cindex @code{#+BEGIN_EXPORT texinfo}
 @example
 Richard @@@@texinfo:@@sc@{@@@@Stallman@@@@texinfo:@}@@@@ commence' GNU.
 
@@ -13941,10 +13942,10 @@ This paragraph is preceded by...
 
 @node Plain lists in Texinfo export
 @subsection Plain lists in Texinfo export
-@cindex #+ATTR_TEXINFO, in plain lists
+@cindex @code{#+ATTR_TEXINFO}, in plain lists
 @cindex Two-column tables, in Texinfo export
 
-@cindex :table-type attribute, in Texinfo export
+@cindex @code{:table-type} attribute, in Texinfo export
 The Texinfo export back-end by default converts description lists in the Org
 file using the default command @code{@@table}, which results in a table with
 two columns.  To change this behavior, specify @code{:table-type} with
@@ -13952,14 +13953,14 @@ two columns.  To change this behavior, specify @code{:table-type} with
 @inforef{Two-column Tables,,texinfo}.
 
 @vindex org-texinfo-table-default-markup
-@cindex :indic attribute, in Texinfo export
+@cindex @code{:indic} attribute, in Texinfo export
 The Texinfo export back-end by default also applies a text highlight based on
 the defaults stored in @code{org-texinfo-table-default-markup}.  To override
 the default highlight command, specify another one with the @code{:indic}
 attribute.
 
 @cindex Multiple entries in two-column tables, in Texinfo export
-@cindex :sep attribute, in Texinfo export
+@cindex @code{:sep} attribute, in Texinfo export
 Org syntax is limited to one entry per list item.  Nevertheless, the Texinfo
 export back-end can split that entry according to any text provided through
 the @code{:sep} attribute.  Each part then becomes a new entry in the first
@@ -13985,7 +13986,7 @@ This is the common text for variables foo and bar.
 
 @node Tables in Texinfo export
 @subsection Tables in Texinfo export
-@cindex #+ATTR_TEXINFO, in tables
+@cindex @code{#+ATTR_TEXINFO}, in tables
 
 When exporting tables, the Texinfo export back-end uses the widest cell width
 in each column.  To override this and instead specify as fractions of line
@@ -13998,7 +13999,7 @@ length, use the @code{:columns} attribute.  See example below.
 
 @node Images in Texinfo export
 @subsection Images in Texinfo export
-@cindex #+ATTR_TEXINFO, in images
+@cindex @code{#+ATTR_TEXINFO}, in images
 
 Insert a file link to the image in the Org file, and the Texinfo export
 back-end inserts the image.  These links must have the usual supported image
@@ -14013,7 +14014,7 @@ the text using Texinfo code, as shown in the example:
 
 @node Special blocks in Texinfo export
 @subsection Special blocks
-@cindex #+ATTR_TEXINFO, in special blocks
+@cindex @code{#+ATTR_TEXINFO}, in special blocks
 
 The Texinfo export back-end converts special blocks to commands with the same
 name.  It also adds any @code{:options} attributes to the end of the command,
@@ -14136,7 +14137,7 @@ configure the variable @code{org-icalendar-categories}.  To assign clock
 alarms based on time, configure the @code{org-icalendar-alarm-time} variable.
 
 @vindex org-icalendar-store-UID
-@cindex property, ID
+@cindex property, @code{ID}
 The iCalendar format standard requires globally unique identifier---UID---for
 each entry.  The iCalendar export back-end creates UIDs during export.  To
 save a copy of the UID in the Org file set the variable
@@ -14165,26 +14166,27 @@ and write it to @code{org-icalendar-combined-agenda-file} file name.
 
 @vindex org-use-property-inheritance
 @vindex org-icalendar-include-body
-@cindex property, SUMMARY
-@cindex property, DESCRIPTION
-@cindex property, LOCATION
-@cindex property, TIMEZONE
-The iCalendar export back-end includes SUMMARY, DESCRIPTION, LOCATION and
-TIMEZONE properties from the Org entries when exporting.  To force the
-back-end to inherit the LOCATION and TIMEZONE properties, configure the
-@code{org-use-property-inheritance} variable.
-
-When Org entries do not have SUMMARY, DESCRIPTION and LOCATION properties,
-the iCalendar export back-end derives the summary from the headline, and
-derives the description from the body of the Org item.  The
-@code{org-icalendar-include-body} variable limits the maximum number of
+@cindex property, @code{SUMMARY}
+@cindex property, @code{DESCRIPTION}
+@cindex property, @code{LOCATION}
+@cindex property, @code{TIMEZONE}
+The iCalendar export back-end includes @code{SUMMARY}, @code{DESCRIPTION},
+@code{LOCATION} and @code{TIMEZONE} properties from the Org entries when
+exporting.  To force the back-end to inherit the @code{LOCATION} and
+@code{TIMEZONE} properties, configure the @code{org-use-property-inheritance}
+variable.
+
+When Org entries do not have @code{SUMMARY}, @code{DESCRIPTION} and
+@code{LOCATION} properties, the iCalendar export back-end derives the summary
+from the headline, and derives the description from the body of the Org item.
+The @code{org-icalendar-include-body} variable limits the maximum number of
 characters of the content are turned into its description.
 
-The TIMEZONE property can be used to specify a per-entry time zone, and will
-be applied to any entry with timestamp information.  Time zones should be
-specified as per the IANA time zone database format, e.g.@: ``Asia/Almaty''.
-Alternately, the property value can be ``UTC'', to force UTC time for this
-entry only.
+The @code{TIMEZONE} property can be used to specify a per-entry time zone,
+and will be applied to any entry with timestamp information.  Time zones
+should be specified as per the IANA time zone database format, e.g.@:
+``Asia/Almaty''.  Alternately, the property value can be ``UTC'', to force
+UTC time for this entry only.
 
 Exporting to iCalendar format depends in large part on the capabilities of
 the destination application.  Some are more lenient than others.  Consult the
@@ -14429,7 +14431,7 @@ In-place conversions are particularly handy for quick conversion of tables
 and lists in foreign buffers.  For example, turn on the minor mode @code{M-x
 orgstruct-mode} in an HTML buffer, then use the convenient Org keyboard
 commands to create a list, select it, and covert it to HTML with @code{M-x
-org-html-convert-region-to-html RET}.
+org-html-convert-region-to-html @key{RET}}.
 
 
 @node Publishing
@@ -14473,7 +14475,7 @@ and many other properties of a project.
 
 @node Project alist
 @subsection The variable @code{org-publish-project-alist}
-@cindex org-publish-project-alist
+@cindex @code{org-publish-project-alist}
 @cindex projects, for publishing
 
 @vindex org-publish-project-alist
@@ -14929,7 +14931,7 @@ The file will be created when first publishing a project with the
 "theindex.inc"}.  You can then build around this include statement by adding
 a title, style information, etc.
 
-@cindex #+INDEX
+@cindex @code{#+INDEX}
 Index entries are specified with @code{#+INDEX} keyword.  An entry that
 contains an exclamation mark will create a sub item.
 
@@ -15100,8 +15102,8 @@ such as not inside comments and fixed width areas.  Here's a sample
 #+END_SRC
 @end example
 
-Org can take the code in the block between the @samp{#+BEGIN_SRC} and
-@samp{#+END_SRC} tags, and format, compile, execute, and show the results.
+Org can take the code in the block between the @code{#+BEGIN_SRC} and
+@code{#+END_SRC} tags, and format, compile, execute, and show the results.
 Org can simplify many housekeeping tasks essential to modern code
 maintenance.  That's why these blocks in Org mode literature are sometimes
 referred to as @samp{live code} blocks (as compared to the static text and
@@ -15110,7 +15112,7 @@ block by tweaking the headers for compiling, execution, extraction.
 
 Org's @samp{src} code block type is one of many block types, such as quote,
 export, verse, latex, example, and verbatim.  This section pertains to
-@samp{src} code blocks between @samp{#+BEGIN_SRC} and @samp{#+END_SRC}
+@code{src} code blocks between @code{#+BEGIN_SRC} and @code{#+END_SRC}
 
 For editing @samp{src} code blocks, Org provides native Emacs major-modes.
 That leverages the latest Emacs features for that source code language mode.
@@ -15172,8 +15174,8 @@ Details of Org's facilities for working with source code are shown next.
 @section Structure of code blocks
 @cindex code block, structure
 @cindex source code, block structure
-@cindex #+NAME
-@cindex #+BEGIN_SRC
+@cindex @code{#+NAME}
+@cindex @code{#+BEGIN_SRC}
 
 Org offers two ways to structure source code in Org documents: in a
 @samp{src} block, and directly inline.  Both specifications are shown below.
@@ -15215,7 +15217,7 @@ results.  Code from other blocks, other files, and from table formulas
 (@pxref{The spreadsheet}) can use the name to reference a @samp{src} block.
 This naming serves the same purpose as naming Org tables.  Org mode requires
 unique names.  For duplicate names, Org mode's behavior is undefined.
-@cindex #+NAME
+@cindex @code{#+NAME}
 @item #+BEGIN_SRC
 @item #+END_SRC
 Mandatory.  They mark the start and end of a block that Org requires.  The
@@ -15426,7 +15428,7 @@ block header arguments: One, set @code{padline} (@pxref{padline}) to true
 @section Evaluating code blocks
 @cindex code block, evaluating
 @cindex source code, evaluating
-@cindex #+RESULTS
+@cindex @code{#+RESULTS}
 
 A note about security: With code evaluation comes the risk of harm.  Org
 safeguards by prompting for user's permission before executing any code in
@@ -15449,7 +15451,7 @@ evaluation from the @kbd{C-c C-c} key binding.} calls the
 @code{org-babel-execute-src-block} function, which executes the code in the
 block, collects the results, and inserts them in the buffer.
 
-@cindex #+CALL
+@cindex @code{#+CALL}
 By calling a named code block@footnote{Actually, the constructs call_<name>()
 and src_<lang>@{@} are not evaluated when they appear in a keyword line
 (i.e. lines starting with @code{#+KEYWORD:}, @pxref{In-buffer settings}).}
@@ -15732,7 +15734,7 @@ each line.  Note that Org currently accepts the plural spelling of
 @code{#+HEADER:} only as a convenience for backward-compatibility.  It may be
 removed at some point.
 
-@cindex #+HEADER:
+@cindex @code{#+HEADER:}
 
 Multi-line header arguments on an unnamed @samp{src} code block:
 
@@ -16146,7 +16148,7 @@ Interpreted as raw Org mode.  Inserted directly into the buffer.  Aligned if
 it is a table.  Usage example: @code{:results value raw}.
 @item @code{org}
 Results enclosed in a @code{BEGIN_SRC org} block.  For comma-escape, either
-@kbd{TAB} in the block, or export the file.  Usage example: @code{:results
+@key{TAB} in the block, or export the file.  Usage example: @code{:results
 value org}.
 @item @code{html}
 Results enclosed in a @code{BEGIN_EXPORT html} block.  Usage example:
@@ -16233,7 +16235,7 @@ output file, @code{:dir} specifies the default directory during @samp{src}
 code block execution.  If it is absent, then the directory associated with
 the current buffer is used.  In other words, supplying @code{:dir path}
 temporarily has the same effect as changing the current directory with
-@kbd{M-x cd path RET}, and then not supplying @code{:dir}.  Under the
+@kbd{M-x cd path @key{RET}}, and then not supplying @code{:dir}.  Under the
 surface, @code{:dir} simply sets the value of the Emacs variable
 @code{default-directory}.
 
@@ -17127,10 +17129,10 @@ Active key bindings in code blocks:
 @item @kbd{C-c C-c} @tab @code{org-babel-execute-src-block}
 @kindex C-c C-o
 @item @kbd{C-c C-o} @tab @code{org-babel-open-src-block-result}
-@kindex M-up
-@item @kbd{M-@key{up}}    @tab @code{org-babel-load-in-session}
-@kindex M-down
-@item @kbd{M-@key{down}}  @tab @code{org-babel-switch-to-session}
+@kindex M-UP
+@item @kbd{M-@key{UP}}    @tab @code{org-babel-load-in-session}
+@kindex M-DOWN
+@item @kbd{M-@key{DOWN}}  @tab @code{org-babel-switch-to-session}
 @end multitable
 
 Active key bindings in Org mode buffer:
@@ -17247,12 +17249,12 @@ emacs -Q --batch --eval "
 @chapter Miscellaneous
 
 @menu
-* Completion::                  M-TAB guesses completions
+* Completion::                  M-@key{TAB} guesses completions
 * Easy templates::              Quick insertion of structural elements
 * Speed keys::                  Electric commands at the beginning of a headline
 * Code evaluation security::    Org mode files evaluate inline code
 * Customization::               Adapting Org to changing tastes
-* In-buffer settings::          Overview of the #+KEYWORDS
+* In-buffer settings::          Overview of the @code{#+KEYWORDS}
 * The very busy C-c C-c key::   When in doubt, press C-c C-c
 * Clean view::                  Getting rid of leading stars in the outline
 * TTY keys::                    Using Org on a tty
@@ -17286,7 +17288,7 @@ is involved.  Such mode-specific hot keys have become an integral part of
 Emacs and Org provides several shortcuts.
 
 @table @kbd
-@kindex M-@key{TAB}
+@kindex M-TAB
 @item M-@key{TAB}
 Complete word at point
 @itemize @bullet
@@ -17300,7 +17302,7 @@ can be used in search links like @samp{[[*find this headline]]}.
 @item
 After @samp{:} in a headline, complete tags.  The list of tags is taken
 from the variable @code{org-tag-alist} (possibly set through the
-@samp{#+TAGS} in-buffer option, @pxref{Setting tags}), or it is created
+@code{#+TAGS} in-buffer option, @pxref{Setting tags}), or it is created
 dynamically from all tags used in the current buffer.
 @item
 After @samp{:} and not in a headline, complete property keys.  The list
@@ -17313,7 +17315,7 @@ After @samp{#+}, complete the special keywords like @samp{TYP_TODO} or
 file-specific @samp{OPTIONS}.  After option keyword is complete, pressing
 @kbd{M-@key{TAB}} again will insert example settings for that option.
 @item
-After @samp{#+STARTUP: }, complete startup keywords.
+After @code{#+STARTUP:}, complete startup keywords.
 @item
 When the point is anywhere else, complete dictionary words using Ispell.
 @end itemize
@@ -17457,8 +17459,8 @@ Org executes formulas in tables (@pxref{The spreadsheet}) either through the
 @cindex variables, for customization
 
 Org has more than 500 variables for customization.  They can be accessed
-through the usual @kbd{M-x org-customize RET} command.  Or through the Org
-menu, @code{Org->Customization->Browse Org Group}.  Org also has per-file
+through the usual @kbd{M-x org-customize @key{RET}} command.  Or through the
+Org menu, @code{Org->Customization->Browse Org Group}.  Org also has per-file
 settings for some variables (@pxref{In-buffer settings}).
 
 @node In-buffer settings
@@ -17477,13 +17479,13 @@ reopening the Org file in Emacs also activates the changes.
 @table @kbd
 @item #+ARCHIVE: %s_done::
 Sets the archive location of the agenda file.  This location applies to the
-lines until the next @samp{#+ARCHIVE} line, if any, in the Org file.  The
+lines until the next @code{#+ARCHIVE} line, if any, in the Org file.  The
 first archive location in the Org file also applies to any entries before it.
 The corresponding variable is @code{org-archive-location}.
 @item #+CATEGORY:
 Sets the category of the agenda file, which applies to the entire document.
 @item #+COLUMNS: %25ITEM ...
-@cindex property, COLUMNS
+@cindex property, @code{COLUMNS}
 Sets the default format for columns view.  Org uses this format for column
 views where there is no @code{COLUMNS} property.
 @item #+CONSTANTS: name1=value1 ...
@@ -17510,7 +17512,7 @@ have a lower ASCII number than the lowest priority.
 @item #+PROPERTY: Property_Name Value
 This line sets a default inheritance value for entries in the current
 buffer, most useful for specifying the allowed values of a property.
-@cindex #+SETUPFILE
+@cindex @code{#+SETUPFILE}
 @item #+SETUPFILE: file or URL
 The setup file or a URL pointing to such file is for additional in-buffer
 settings.  Org loads this file and parses it for any settings in it only when
@@ -17522,7 +17524,7 @@ parses the contents of this document as if it was included in the buffer.  It
 can be another Org file.  To visit the file (not a URL), @kbd{C-c '} while
 the cursor is on the line with the file name.
 @item #+STARTUP:
-@cindex #+STARTUP
+@cindex @code{#+STARTUP}
 Startup options Org uses when first visiting a file.
 
 The first set of options deals with the initial visibility of the outline
@@ -17703,7 +17705,7 @@ fnadjust    @r{automatically renumber and sort footnotes}
 nofnadjust  @r{do not renumber and sort automatically}
 @end example
 
-@cindex org-hide-block-startup
+@cindex @code{org-hide-block-startup}
 To hide blocks on startup, use these keywords.  The corresponding variable is
 @code{org-hide-block-startup}.
 @cindex @code{hideblocks}, STARTUP keyword
@@ -17713,7 +17715,7 @@ hideblocks   @r{Hide all begin/end blocks on startup}
 nohideblocks @r{Do not hide blocks on startup}
 @end example
 
-@cindex org-pretty-entities
+@cindex @code{org-pretty-entities}
 The display of entities as UTF-8 characters is governed by the variable
 @code{org-pretty-entities} and the keywords
 @cindex @code{entitiespretty}, STARTUP keyword
@@ -17728,11 +17730,11 @@ entitiesplain   @r{Leave entities plain}
 These lines specify valid tags for this file.  Org accepts multiple tags
 lines.  Tags could correspond to the @emph{fast tag selection} keys.  The
 corresponding variable is @code{org-tag-alist}.
-@cindex #+TBLFM
+@cindex @code{#+TBLFM}
 @item #+TBLFM:
 This line is for formulas for the table directly above.  A table can have
-multiple @samp{#+TBLFM:} lines.  On table recalculation, Org applies only the
-first @samp{#+TBLFM:} line.  For details see @ref{Using multiple #+TBLFM
+multiple @code{#+TBLFM:} lines.  On table recalculation, Org applies only the
+first @code{#+TBLFM:} line.  For details see @ref{Using multiple #+TBLFM
 lines} in @ref{Editing and debugging formulas}.
 @item #+TITLE:, #+AUTHOR:, #+EMAIL:, #+LANGUAGE:, #+DATE:,
 @itemx #+OPTIONS:, #+BIND:,
@@ -17748,7 +17750,7 @@ The corresponding variable is @code{org-todo-keywords}.
 @node The very busy C-c C-c key
 @section The very busy C-c C-c key
 @kindex C-c C-c
-@cindex C-c C-c, overview
+@cindex @kbd{C-c C-c}, overview
 
 The @kbd{C-c C-c} key in Org serves many purposes depending on the context.
 It is probably the most over-worked, multi-purpose key combination in Org.
@@ -17912,7 +17914,8 @@ one of the following lines:
 @end example
 
 To switch between single and double stars layouts, use @kbd{M-x
-org-convert-to-odd-levels RET} and @kbd{M-x org-convert-to-oddeven-levels}.
+org-convert-to-odd-levels @key{RET}} and @kbd{M-x
+org-convert-to-oddeven-levels @key{RET}}.
 @end enumerate
 
 @node TTY keys
@@ -17929,23 +17932,23 @@ normal @kbd{S-@key{cursor}} for editing timestamp might be better with
 @multitable @columnfractions 0.15 0.2 0.1 0.2
 @item @b{Default} @tab @b{Alternative 1} @tab @b{Speed key} @tab @b{Alternative 2}
 @item @kbd{S-@key{TAB}}     @tab @kbd{C-u @key{TAB}}       @tab @kbd{C} @tab
-@item @kbd{M-@key{left}}    @tab @kbd{C-c C-x l}           @tab @kbd{l} @tab @kbd{@key{Esc} @key{left}}
-@item @kbd{M-S-@key{left}}  @tab @kbd{C-c C-x L}           @tab @kbd{L} @tab
-@item @kbd{M-@key{right}}   @tab @kbd{C-c C-x r}           @tab @kbd{r} @tab @kbd{@key{Esc} @key{right}}
-@item @kbd{M-S-@key{right}} @tab @kbd{C-c C-x R}           @tab @kbd{R} @tab
-@item @kbd{M-@key{up}}      @tab @kbd{C-c C-x u}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{up}}
-@item @kbd{M-S-@key{up}}    @tab @kbd{C-c C-x U}           @tab @kbd{U} @tab
-@item @kbd{M-@key{down}}    @tab @kbd{C-c C-x d}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{down}}
-@item @kbd{M-S-@key{down}}  @tab @kbd{C-c C-x D}           @tab @kbd{D} @tab
+@item @kbd{M-@key{LEFT}}    @tab @kbd{C-c C-x l}           @tab @kbd{l} @tab @kbd{@key{Esc} @key{LEFT}}
+@item @kbd{M-S-@key{LEFT}}  @tab @kbd{C-c C-x L}           @tab @kbd{L} @tab
+@item @kbd{M-@key{RIGHT}}   @tab @kbd{C-c C-x r}           @tab @kbd{r} @tab @kbd{@key{Esc} @key{RIGHT}}
+@item @kbd{M-S-@key{RIGHT}} @tab @kbd{C-c C-x R}           @tab @kbd{R} @tab
+@item @kbd{M-@key{UP}}      @tab @kbd{C-c C-x u}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{UP}}
+@item @kbd{M-S-@key{UP}}    @tab @kbd{C-c C-x U}           @tab @kbd{U} @tab
+@item @kbd{M-@key{DOWN}}    @tab @kbd{C-c C-x d}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{DOWN}}
+@item @kbd{M-S-@key{DOWN}}  @tab @kbd{C-c C-x D}           @tab @kbd{D} @tab
 @item @kbd{S-@key{RET}}     @tab @kbd{C-c C-x c}           @tab @kbd{ } @tab
 @item @kbd{M-@key{RET}}     @tab @kbd{C-c C-x m}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{RET}}
 @item @kbd{M-S-@key{RET}}   @tab @kbd{C-c C-x M}           @tab @kbd{ } @tab
-@item @kbd{S-@key{left}}    @tab @kbd{C-c @key{left}}      @tab @kbd{ } @tab
-@item @kbd{S-@key{right}}   @tab @kbd{C-c @key{right}}     @tab @kbd{ } @tab
-@item @kbd{S-@key{up}}      @tab @kbd{C-c @key{up}}        @tab @kbd{ } @tab
-@item @kbd{S-@key{down}}    @tab @kbd{C-c @key{down}}      @tab @kbd{ } @tab
-@item @kbd{C-S-@key{left}}  @tab @kbd{C-c C-x @key{left}}  @tab @kbd{ } @tab
-@item @kbd{C-S-@key{right}} @tab @kbd{C-c C-x @key{right}} @tab @kbd{ } @tab
+@item @kbd{S-@key{LEFT}}    @tab @kbd{C-c @key{LEFT}}      @tab @kbd{ } @tab
+@item @kbd{S-@key{RIGHT}}   @tab @kbd{C-c @key{RIGHT}}     @tab @kbd{ } @tab
+@item @kbd{S-@key{UP}}      @tab @kbd{C-c @key{UP}}        @tab @kbd{ } @tab
+@item @kbd{S-@key{DOWN}}    @tab @kbd{C-c @key{DOWN}}      @tab @kbd{ } @tab
+@item @kbd{C-S-@key{LEFT}}  @tab @kbd{C-c C-x @key{LEFT}}  @tab @kbd{ } @tab
+@item @kbd{C-S-@key{RIGHT}} @tab @kbd{C-c C-x @key{RIGHT}} @tab @kbd{ } @tab
 @end multitable
 
 
@@ -18058,9 +18061,9 @@ bindings in Org files, and in the agenda buffer (but not during date
 selection).
 
 @example
-S-UP      @result{}  M-p             S-DOWN     @result{}  M-n
-S-LEFT    @result{}  M--             S-RIGHT    @result{}  M-+
-C-S-LEFT  @result{}  M-S--           C-S-RIGHT  @result{}  M-S-+
+S-@key{UP}      @result{}  M-p             S-@key{DOWN}     @result{}  M-n
+S-@key{LEFT}    @result{}  M--             S-@key{RIGHT}    @result{}  M-+
+C-S-@key{LEFT}  @result{}  M-S--           C-S-@key{RIGHT}  @result{}  M-S-+
 @end example
 
 @vindex org-disputed-keys
@@ -18427,7 +18430,7 @@ the mode is C, then:
 At the location of source, Org needs a special line to direct Orgtbl to
 translate and to find the target for inserting the translated table.  For
 example:
-@cindex #+ORGTBL
+@cindex @code{#+ORGTBL}
 @example
 #+ORGTBL: SEND table_name translation_function arguments...
 @end example
@@ -18465,7 +18468,7 @@ Put the table after an @samp{END} statement.  For example @samp{\bye} in
 @TeX{} and @samp{\end@{document@}} in @LaTeX{}.
 @item
 Comment and uncomment each line of the table during edits.  The @kbd{M-x
-orgtbl-toggle-comment RET} command makes toggling easy.
+orgtbl-toggle-comment @key{RET}} command makes toggling easy.
 @end itemize
 
 @node A @LaTeX{} example
@@ -18478,10 +18481,10 @@ provided by @file{comment.sty}.  To activate it, put
 radio table skeleton@footnote{By default this works only for @LaTeX{}, HTML,
 and Texinfo.  Configure the variable @code{orgtbl-radio-table-templates} to
 install templates for other export formats.}  with the command @kbd{M-x
-orgtbl-insert-radio-table RET}, which prompts for a table name.  For example,
-if @samp{salesfigures} is the name, the template inserts:
+orgtbl-insert-radio-table @key{RET}}, which prompts for a table name.  For
+example, if @samp{salesfigures} is the name, the template inserts:
 
-@cindex #+ORGTBL, SEND
+@cindex @code{#+ORGTBL}, @samp{SEND}
 @example
 % BEGIN RECEIVE ORGTBL salesfigures
 % END RECEIVE ORGTBL salesfigures
@@ -18497,7 +18500,7 @@ The line @code{#+ORGTBL: SEND} tells Orgtbl mode to use the function
 @code{orgtbl-to-latex} to convert the table to @LaTeX{} format, then insert
 the table at the target (receive) location named @code{salesfigures}.  Now
 the table is ready for data entry.  It can even use spreadsheet
-features@footnote{If the @samp{#+TBLFM} line contains an odd number of dollar
+features@footnote{If the @code{#+TBLFM} line contains an odd number of dollar
 characters, this may cause problems with font-lock in @LaTeX{} mode.  As
 shown in the example you can fix this by adding an extra line inside the
 @code{comment} environment that is used to balance the dollar expressions.
@@ -18628,14 +18631,14 @@ translator functions by posting them to the Org users mailing list,
 @node Radio lists
 @subsection Radio lists
 @cindex radio lists
-@cindex org-list-insert-radio-list
+@cindex @code{org-list-insert-radio-list}
 
 Call the @code{org-list-insert-radio-list} function to insert a radio list
 template in HTML, @LaTeX{}, and Texinfo mode documents.  Sending and
 receiving radio lists works is the same as for radio tables (@pxref{Radio
 tables}) except for these differences:
 
-@cindex #+ORGLST
+@cindex @code{#+ORGLST}
 @itemize @minus
 @item
 Orgstruct mode must be active.
@@ -18679,7 +18682,7 @@ time}).
 Dynamic blocks can have names and function parameters.  The syntax is similar
 to @samp{src} code block specifications:
 
-@cindex #+BEGIN:dynamic block
+@cindex @code{#+BEGIN}, dynamic block
 @example
 #+BEGIN: myblock :parameter1 value1 :parameter2 value2 ...
 
@@ -18941,7 +18944,7 @@ priority-n   @r{The computed numerical priority}
 
 @noindent
 If the selection of the agenda item was based on a timestamp, including those
-items with @samp{DEADLINE} and @samp{SCHEDULED} keywords, then Org includes
+items with @code{DEADLINE} and @code{SCHEDULED} keywords, then Org includes
 date and time in the output.
 
 If the selection of the agenda item was based on a timestamp  (or
diff --git a/doc/misc/pcl-cvs.texi b/doc/misc/pcl-cvs.texi
index 1163530e7a..4c61aed5b3 100644
--- a/doc/misc/pcl-cvs.texi
+++ b/doc/misc/pcl-cvs.texi
@@ -63,10 +63,11 @@ modify this GNU manual.''
 @node Top
 @top PCL-CVS
 
-This manual describes PCL-CVS, the GNU Emacs front-end to CVS@.  It
-is nowhere near complete, so you are advised to use @kbd{M-x
-customize-group RET pcl-cvs @key{RET}} and to look at the documentation strings
-of the various commands and major modes for further information.
+This manual describes PCL-CVS, the GNU Emacs front-end to CVS@.  It is
+nowhere near complete, so you are advised to use @kbd{M-x
+customize-group @key{RET} pcl-cvs @key{RET}} and to look at the
+documentation strings of the various commands and major modes for
+further information.
 @c This manual is updated to release 2.5 of PCL-CVS.
 
 @insertcopying
@@ -1109,7 +1110,7 @@ Tag all selected files by running @samp{cvs tag} on
 them (@code{cvs-mode-tag}).  It's usually preferable to tag a directory
 at a time.  Rather than selecting all files (which too often doesn't
 select all files but only the few that are displayed), clear the
-selection with @kbd{M-DEL} (@code{cvs-mode-unmark-all-files}), position
+selection with @kbd{M-@key{DEL}} (@code{cvs-mode-unmark-all-files}), position
 the cursor on the directory you want to tag and hit @kbd{t}.
 @end table
 
diff --git a/doc/misc/reftex.texi b/doc/misc/reftex.texi
index 55060d09b8..3803cb0eb7 100644
--- a/doc/misc/reftex.texi
+++ b/doc/misc/reftex.texi
@@ -3335,7 +3335,7 @@ have to rescan the buffer in order to see it.
 @findex reftex-arg-index
 @findex TeX-arg-index@r{, AUCTeX function}
 @findex TeX-insert-macro@r{, AUCTeX function}
-@kindex C-c @key{RET}
+@kindex C-c RET
 @b{@RefTeX{} supplies macro arguments}@* When you insert a macro
 interactively with @kbd{C-c @key{RET}}, @AUCTeX{} normally prompts for
 macro arguments.  Internally, it uses the functions
diff --git a/doc/misc/sem-user.texi b/doc/misc/sem-user.texi
index e82162621b..8484a7bfe2 100644
--- a/doc/misc/sem-user.texi
+++ b/doc/misc/sem-user.texi
@@ -1145,7 +1145,7 @@ Typing @kbd{RET} on a reference line jumps to that reference.
 
 @node MRU Bookmarks
 @section MRU Bookmarks mode
-@cindex semantic-mru-bookmark-mode
+@cindex @code{semantic-mru-bookmark-mode}
 
 Semantic MRU Bookmarks mode is a minor mode that keeps track of the
 tags you have edited, allowing you to quickly return to them later
@@ -1193,7 +1193,7 @@ declarations.  Other possible tag classes are @code{variable},
 
 @node Highlight Func Mode
 @section Highlight Func Mode
-@cindex semantic-highlight-func-mode
+@cindex @code{semantic-highlight-func-mode}
 
 Semantic Highlight Function minor mode highlights the declaration line
 of the current function or tag (that is to say, the first line that
@@ -1220,7 +1220,7 @@ Func mode.
 
 @node Tag Decoration Mode
 @section Tag Decoration Mode
-@cindex semantic-decoration-mode
+@cindex @code{semantic-decoration-mode}
 
 Semantic Tag Decoration mode ``decorates'' each tag based on certain
 arbitrary features of that tag.  Decorations are specified using the
diff --git a/doc/misc/ses.texi b/doc/misc/ses.texi
index 60963adcb2..aa4fe81ba5 100644
--- a/doc/misc/ses.texi
+++ b/doc/misc/ses.texi
@@ -209,7 +209,7 @@ remove blank cells from the returned list, which allows to use
 @findex keyboard-quit
 
 To create a new spreadsheet, visit a nonexistent file whose name ends
-  with ".ses".  For example, @kbd{C-x C-f test.ses RET}.
+with ".ses".  For example, @kbd{C-x C-f test.ses @key{RET}}.
 
 
 A @dfn{cell identifier} is a symbol with a column letter and a row
@@ -310,7 +310,7 @@ To enter something else (e.g., a vector), begin with a digit, then
 erase the digit and type whatever you want.
 
 @table @kbd
-@item RET
+@item @key{RET}
 Edit the existing formula in the current cell (@code{ses-edit-cell}).
 
 @item C-c C-c
@@ -357,7 +357,7 @@ Basic commands:
 @item w
 (@code{ses-set-column-width})
 
-@item TAB
+@item @key{TAB}
 Moves point to the next rightward cell, or inserts a new column if
 already at last cell on line, or inserts a new row if at endline
 (@code{ses-forward-or-insert}).
@@ -639,7 +639,7 @@ or a non-string is displayed as an error by using @code{#} filling.
 These commands set both formula and printer to @code{nil}:
 
 @table @kbd
-@item DEL
+@item @key{DEL}
 Clear cell and move left (@code{ses-clear-cell-backward}).
 
 @item C-d
@@ -1282,10 +1282,10 @@ avoid virus warnings, each function used in a formula needs
 
 @node Uses of defadvice in @acronym{SES}
 @section Uses of defadvice in @acronym{SES}
-@cindex defadvice
-@cindex undo-more
-@cindex copy-region-as-kill
-@cindex yank
+@findex defadvice
+@findex undo-more
+@findex copy-region-as-kill
+@findex yank
 
 @table @code
 @item undo-more
diff --git a/doc/misc/sieve.texi b/doc/misc/sieve.texi
index 37bb707f63..2d290b3688 100644
--- a/doc/misc/sieve.texi
+++ b/doc/misc/sieve.texi
@@ -123,7 +123,7 @@ bindings to manage Sieve scripts remotely. @xref{Managing Sieve}.
 
 @table @kbd
 
-@item C-c RET
+@item C-c @key{RET}
 @kindex C-c RET
 @findex sieve-manage
 @cindex manage remote sieve script
@@ -160,8 +160,8 @@ press RET on <new script> to create a new script.
 @end example
 
 One of the scripts are highlighted, and standard point navigation
-commands (@kbd{<up>}, @kbd{<down>} etc.)@: can be used to navigate the
-list.
+commands (@kbd{@key{UP}}, @kbd{@key{DOWN}} etc.)@: can be used to
+navigate the list.
 
 The following commands are available in the Manage Sieve buffer:
 
@@ -187,7 +187,7 @@ Deactivates all scripts.
 @findex sieve-remove
 Remove currently highlighted script.
 
-@item RET
+@item @key{RET}
 @item mouse-2
 @item f
 @kindex RET
@@ -272,7 +272,7 @@ The @file{sieve-manage.el} library contains low-level functionality
 for talking to a server with the @sc{managesieve} protocol.
 
 A number of user-visible variables exist, which all can be customized
-in the @code{sieve} group (@kbd{M-x customize-group RET sieve RET}):
+in the @code{sieve} group (@kbd{M-x customize-group @key{RET} sieve @key{RET}}):
 
 @table @code
 
diff --git a/doc/misc/smtpmail.texi b/doc/misc/smtpmail.texi
index 6da51f798d..c3387054ba 100644
--- a/doc/misc/smtpmail.texi
+++ b/doc/misc/smtpmail.texi
@@ -354,7 +354,7 @@ directory to hold queued messages.  It defaults to
   The function @code{smtpmail-send-queued-mail} can be used to send
 any queued mail when @code{smtpmail-queue-mail} is enabled.  It is
 typically invoked interactively with @kbd{M-x
-smtpmail-send-queued-mail RET} when you are connected to the internet.
+smtpmail-send-queued-mail @key{RET}} when you are connected to the internet.
 
 @node Server workarounds
 @chapter Server workarounds
diff --git a/doc/misc/speedbar.texi b/doc/misc/speedbar.texi
index 6286ac12a9..d67c4e6145 100644
--- a/doc/misc/speedbar.texi
+++ b/doc/misc/speedbar.texi
@@ -87,7 +87,7 @@ on.  @xref{Basic Navigation}.
 @chapter Introduction
 @cindex introduction
 
-To start using speedbar use the command @kbd{M-x speedbar RET} or
+To start using speedbar use the command @kbd{M-x speedbar @key{RET}} or
 select it from the @samp{Options->Show/Hide} sub-menu.  This command
 will open a new frame to summarize the local files.  On X Window
 systems or on MS-Windows, speedbar's frame is twenty characters wide,
@@ -188,7 +188,7 @@ these are available, some additional common bindings are available.
 
 @cindex common keys
 @table @kbd
-@item RET
+@item @key{RET}
 @itemx e
 Edit/Open the current group or tag.  This behavior is dependent on the
 mode.  In general, files or buffers are opened in the attached frame,
@@ -979,8 +979,8 @@ With a numeric argument (@kbd{C-u}), flush cached data before expanding.
 Contract the item under the cursor.
 @end table
 
-@cindex @code{speedbar-line-path}
-These function require that function @code{speedbar-line-path} be
+@cindex @code{speedbar-line-directory}
+These functions require that the function @code{speedbar-line-directory} be
 correctly overloaded to work.
 
 Next, register your extension like this;
@@ -1013,14 +1013,14 @@ like this:
 (speedbar-add-mode-functions-list
  '("MYEXTENSION"
    (speedbar-item-info . MyExtension-speedbar-item-info)
-   (speedbar-line-path . MyExtension-speedbar-line-path)))
+   (speedbar-line-directory . MyExtension-speedbar-line-directory)))
 @end example
 
 The first element in the list is the name of you extension.  The second
 is an alist of functions to overload.  The function to overload is
 first, followed by what you want called instead.
 
-For @code{speedbar-line-path} your function should take an optional DEPTH
+For @code{speedbar-line-directory} your function should take an optional DEPTH
 parameter.  This is the starting depth for heavily indented lines.  If
 it is not provided, you can derive it like this:
 
diff --git a/doc/misc/srecode.texi b/doc/misc/srecode.texi
index afa3af1035..2987f62974 100644
--- a/doc/misc/srecode.texi
+++ b/doc/misc/srecode.texi
@@ -105,11 +105,11 @@ item should appear.
 To toggle @srecode{} minor mode on and off use:
 
 @example
-M-x srecode-minor-mode RET
+M-x srecode-minor-mode @key{RET}
 @end example
 or
 @example
-M-x global-srecode-minor-mode RET
+M-x global-srecode-minor-mode @key{RET}
 @end example
 
 or add
@@ -276,7 +276,8 @@ If the variable @code{srecode-insert-ask-variable-method} is set to
 instead create ``fields'' in the buffer.  A field-editing layer
 provides simple interaction through the fields.  Typing in a field
 will cause all variable locations that are the same to edit at the
-same time.  Pressing TAB on a field will move you to the next field.
+same time.  Pressing @kbd{@key{TAB}} on a field will move you to the
+next field.
 
 @node SRecode Minor Mode
 @chapter SRecode Minor Mode
@@ -284,17 +285,17 @@ same time.  Pressing TAB on a field will move you to the next field.
 The Semantic Recode minor mode enables a keymap and menu that provides
 simple access to different templates or template applications.
 
-The key prefix is @key{C-c /}.
+The key prefix is @kbd{C-c /}.
 
 If the variable @code{srecode-takeover-INS-key} is set, then the key
-@key{<insert>} can also be used.
+@kbd{@key{INSERT}} can also be used.
 
 The most important key is bound to @code{srecode-insert} which is
-@key{C-c / /}, or @key{insert insert}.  @ref{Quick Start}.
+@kbd{C-c / /}, or @kbd{@key{INSERT} @key{INSERT}}.  @ref{Quick Start}.
 
 Major keybindings are:
 
-@table @key
+@table @kbd
 @item C-c / /
 Insert a template whose name is typed into the minibuffer.
 @item C-c / <lower case letter>
@@ -338,7 +339,7 @@ will not be prompted to fill in values while the template is
 inserted.  Instead, short regions will be highlighted, and the cursor
 placed in a field.  Typing in the field will then fill in the value.
 Several fields might be linked together.  In that case, typing in one
-area will modify the other linked areas.  Pressing TAB will move
+area will modify the other linked areas.  Pressing @key{TAB} will move
 between editable fields in the template.
 
 Once the cursor moves out of the are inserted by the template, all the
diff --git a/doc/misc/texinfo.tex b/doc/misc/texinfo.tex
index 0af2f09b52..1d78131e6b 100644
--- a/doc/misc/texinfo.tex
+++ b/doc/misc/texinfo.tex
@@ -3,7 +3,7 @@
 % Load plain if necessary, i.e., if running under initex.
 \expandafter\ifx\csname fmtname\endcsname\relax\input plain\fi
 %
-\def\texinfoversion{2018-02-24.16}
+\def\texinfoversion{2019-01-06.22}
 %
 % Copyright 1985, 1986, 1988, 1990, 1991, 1992, 1993, 1994, 1995,
 % 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006,
@@ -182,7 +182,7 @@
 % Hyphenation fixes.
 \hyphenation{
   Flor-i-da Ghost-script Ghost-view Mac-OS Post-Script
-  ap-pen-dix bit-map bit-maps
+  auto-ma-ti-cal-ly ap-pen-dix bit-map bit-maps
   data-base data-bases eshell fall-ing half-way long-est man-u-script
   man-u-scripts mini-buf-fer mini-buf-fers over-view par-a-digm
   par-a-digms rath-er rec-tan-gu-lar ro-bot-ics se-vere-ly set-up spa-ces
diff --git a/doc/misc/tramp.texi b/doc/misc/tramp.texi
index f2530cd6ea..3143904343 100644
--- a/doc/misc/tramp.texi
+++ b/doc/misc/tramp.texi
@@ -3059,6 +3059,22 @@ BSD mtree format
 @cindex @file{mtree} file archive suffix
 @cindex file archive suffix @file{mtree}
 
+@item @samp{.odb}, @samp{.odf}, @samp{.odg}, @samp{.odp}, @samp{.ods},
+@samp{.odt} ---
+OpenDocument formats
+@cindex @file{odb} file archive suffix
+@cindex @file{odf} file archive suffix
+@cindex @file{odg} file archive suffix
+@cindex @file{odp} file archive suffix
+@cindex @file{ods} file archive suffix
+@cindex @file{odt} file archive suffix
+@cindex file archive suffix @file{odb}
+@cindex file archive suffix @file{odf}
+@cindex file archive suffix @file{odg}
+@cindex file archive suffix @file{odp}
+@cindex file archive suffix @file{ods}
+@cindex file archive suffix @file{odt}
+
 @item @samp{.pax} ---
 Posix archives
 @cindex @file{pax} file archive suffix
@@ -3563,7 +3579,7 @@ Why is @file{~/.sh_history} file on the remote host growing?
 @vindex tramp-histfile-override
 Due to the remote shell saving tilde expansions triggered by
 @value{tramp}, the history file is probably growing rapidly.
-@value{tramp} can suppress this behaviour with the user option
+@value{tramp} can suppress this behavior with the user option
 @option{tramp-histfile-override}.  When set to @code{t}, environment
 variable @env{HISTFILE} is unset, and environment variables
 @env{HISTFILESIZE} @env{HISTSIZE} are set to 0.
diff --git a/doc/misc/url.texi b/doc/misc/url.texi
index ed39aab2a3..1acf5f2319 100644
--- a/doc/misc/url.texi
+++ b/doc/misc/url.texi
@@ -1263,19 +1263,6 @@ You can use this function to do completion of URLs from the history.
 @node Customization
 @chapter Customization
 
-@cindex environment variables
-  The following environment variables affect the @code{url} library's
-operation at startup.
-
-@table @code
-@item TMPDIR
-@vindex TMPDIR
-@vindex url-temporary-directory
-If this is defined, @code{url-temporary-directory} is initialized from
-it.  This variable was obsoleted in 23.1, please use
-@code{temporary-file-directory} instead.
-@end table
-
   The following user options affect the general operation of
 @code{url} library.
 
diff --git a/doc/misc/vhdl-mode.texi b/doc/misc/vhdl-mode.texi
index e94fba6fc6..8fc75106d5 100644
--- a/doc/misc/vhdl-mode.texi
+++ b/doc/misc/vhdl-mode.texi
@@ -100,7 +100,7 @@ How to customize the indentation engine.
 The major version number was incremented to 3 with the addition of
 many new features for editing VHDL code to the new indentation engine,
 which was introduced in major version 2. To find the minor revision
-number of this release, use @kbd{M-x vhdl-version RET}.
+number of this release, use @kbd{M-x vhdl-version @key{RET}}.
 
 A special word of thanks goes to Rod Whitby, who wrote the
 VHDL Mode indentation engine, and to Barry Warsaw, who wrote
@@ -119,7 +119,7 @@ makes everything highly self-explaining.
 @cindex   Getting Connected
 
 To get started, simply visit a @file{.vhd} file in Emacs; or type
-@kbd{M-x vhdl-mode RET}.
+@kbd{M-x vhdl-mode @key{RET}}.
 
 @node     New Indentation Engine
 @chapter  New Indentation Engine
@@ -302,11 +302,11 @@ being used.
 
 @vindex vhdl-echo-syntactic-information-p
 @vindex echo-syntactic-information-p @r{(vhdl-)}
-@cindex TAB
+@cindex @key{TAB}
 To help you configure VHDL Mode, you can set the variable
 @code{vhdl-echo-syntactic-information-p} to non-@code{nil} so that the
 syntactic component list and calculated offset will always be echoed in
-the minibuffer when you hit @kbd{TAB}.
+the minibuffer when you hit @kbd{@key{TAB}}.
 
 
 @ignore
@@ -322,7 +322,7 @@ the minibuffer when you hit @kbd{TAB}.
 @chapter  Customizing Indentation
 @cindex   Customizing Indentation
 
-@cindex vhdl-set-offset
+@cindex @code{vhdl-set-offset}
 @cindex set-offset (vhdl-)
 The @code{vhdl-offsets-alist} variable is where you customize all your
 indentations.  You simply need to decide what additional offset you want
@@ -334,7 +334,7 @@ pre-defined styles will suit your needs, but if not, this section will
 describe how to set up basic editing configurations.  @xref{Styles}, for
 an explanation of how to set up named styles.
 
-@cindex vhdl-basic-offset
+@cindex @code{vhdl-basic-offset}
 @cindex basic-offset (vhdl-)
 As mentioned previously, the variable @code{vhdl-offsets-alist} is an
 association list between syntactic symbols and the offsets to be applied
@@ -548,7 +548,7 @@ already built-in.  These include:
 @findex vhdl-set-style
 @findex set-style @r{(vhdl-)}
 If you'd like to experiment with these built-in styles you can simply
-type @kbd{M-x vhdl-set-style RET} in a VHDL Mode buffer.
+type @kbd{M-x vhdl-set-style @key{RET}} in a VHDL Mode buffer.
 
 You will be prompted for one of the above styles (with completion).
 Enter one of the styles and hit @kbd{RET}.  Note however that setting a
diff --git a/doc/misc/vip.texi b/doc/misc/vip.texi
index af4c05d8e4..59df749231 100644
--- a/doc/misc/vip.texi
+++ b/doc/misc/vip.texi
@@ -186,8 +186,8 @@ M-x vip-mode
 @node Modes in VIP
 @section Modes in VIP
 
-@kindex 032 @kbd{C-z} (@code{vip-change-mode-to-vi})
-@kindex 0301 @kbd{C-x C-z} (@code{suspend-emacs})
+@kindex 032 C-z @r{(}@code{vip-change-mode-to-vi}@r{)}
+@kindex 0301 C-x C-z @r{(}@code{suspend-emacs}@r{)}
 
 Loading VIP has the effect of globally binding @kbd{C-z} (@kbd{Control-z})
 to the function @code{vip-change-mode-to-vi}. The default binding of @kbd{C-z}
@@ -266,7 +266,7 @@ emacs mode             vi mode                 insert mode
 @node Emacs Mode
 @subsection Emacs Mode
 
-@kindex 032 @kbd{C-z} (@code{vip-change-mode-to-vi})
+@kindex 032 C-z @r{(}@code{vip-change-mode-to-vi}@r{)}
 
 You will be in this mode just after you loaded VIP@.  You can do all
 normal Emacs editing in this mode.  Note that the key @kbd{C-z} is globally
@@ -289,16 +289,16 @@ its content while you are in insert mode.
 
 @table @kbd
 @item @key{ESC}
-@kindex 033 @kbd{ESC} (@code{vip-change-mode-to-vi}) (insert mode)
+@kindex 033 ESC @r{(}@code{vip-change-mode-to-vi}@r{) (insert mode)}
 This key will take you back to vi mode.
 @item C-h
-@kindex 010 @kbd{C-h} (@code{vip-delete-backward-char}) (insert mode)
+@kindex 010 C-h @r{(}@code{vip-delete-backward-char}@r{) (insert mode)}
 Delete previous character.
 @item C-w
-@kindex 027 @kbd{C-w} (@code{vip-delete-backward-word}) (insert mode)
+@kindex 027 C-w @r{(}@code{vip-delete-backward-word}@r{) (insert mode)}
 Delete previous word.
 @item C-z
-@kindex 032 @kbd{C-z} (@code{vip-ESC}) (insert mode)
+@kindex 032 C-z @r{(}@code{vip-ESC}@r{) (insert mode)}
 Typing this key has the same effect as typing @key{ESC} in emacs mode.
 Thus typing @kbd{C-z x} in insert mode will have the same effect as typing
 @kbd{ESC x} in emacs mode.
@@ -332,8 +332,8 @@ The major differences from Vi are explained below.
 @node Undoing
 @subsection Undoing
 
-@kindex 165 @kbd{u} (@code{vip-undo})
-@kindex 056 @kbd{.} (@code{vip-repeat})
+@kindex 165 u @r{(}@code{vip-undo}@r{)}
+@kindex 056 . @r{(}@code{vip-repeat}@r{)}
 
 You can repeat undoing by the @kbd{.} key.  So, @kbd{u} will undo
 a single change, while @kbd{u .@: .@: .@:}, for instance, will undo 4 previous
@@ -350,14 +350,14 @@ then VIP will prompt you for a new word in the minibuffer by the prompt
 @samp{foo => }.  You can then enter @samp{bar} followed by @key{RET} or
 @key{ESC} to complete the command.  Before you enter @key{RET} or
 @key{ESC} you can abort the command by typing @kbd{C-g}.  In general,
-@kindex 007 @kbd{C-g} (@code{vip-keyboard-quit})
+@kindex 007 C-g @r{(}@code{vip-keyboard-quit})
 you can abort a partially formed command by typing @kbd{C-g}.
 
 @node Searching
 @subsection Searching
 
-@kindex 057 @kbd{/} (@code{vip-search-forward})
-@kindex 077 @kbd{?} (@code{vip-search-backward})
+@kindex 057 / @r{(}@code{vip-search-forward}@r{)}
+@kindex 077 ? @r{(}@code{vip-search-backward}@r{)}
 
 As in Vi, searching is done by @kbd{/} and @kbd{?}.  The string will be
 searched literally by default.  To invoke a regular expression search,
@@ -372,12 +372,12 @@ the buffer as in Vi.  You can change this by rebinding the variable
 @node z Command
 @subsection z Command
 
-@kindex 1723 @kbd{z H} (@code{vip-line-to-top})
-@kindex 1721 @kbd{z RET} (@code{vip-line-to-top})
-@kindex 1723 @kbd{z M} (@code{vip-line-to-middle})
-@kindex 1722 @kbd{z .} (@code{vip-line-to-middle})
-@kindex 1723 @kbd{z L} (@code{vip-line-to-bottom})
-@kindex 1722 @kbd{z -} (@code{vip-line-to-bottom})
+@kindex 1723 z H @r{(}@code{vip-line-to-top}@r{)}
+@kindex 1721 z RET @r{(}@code{vip-line-to-top}@r{)}
+@kindex 1723 z M @r{(}@code{vip-line-to-middle}@r{)}
+@kindex 1722 z . @r{(}@code{vip-line-to-middle}@r{)}
+@kindex 1723 z L @r{(}@code{vip-line-to-bottom}@r{)}
+@kindex 1722 z - @r{(}@code{vip-line-to-bottom}@r{)}
 
 For those of you who cannot remember which of @kbd{z} followed by @key{RET},
 @kbd{.}@: and @kbd{-} do what.  You can also use @kbd{z} followed by @kbd{H},
@@ -392,21 +392,21 @@ Some Vi commands which do not accept a count now accept one
 @table @kbd
 @item p
 @itemx P
-@kindex 160 @kbd{p} (@code{vip-put-back})
-@kindex 120 @kbd{P} (@code{vip-Put-back})
+@kindex 160 p @r{(}@code{vip-put-back}@r{)}
+@kindex 120 P @r{(}@code{vip-Put-back}@r{)}
 Given counts, text will be yanked (in Vi's sense) that many times.  Thus
 @kbd{3 p} is the same as @kbd{p p p}.
 @item o
 @itemx O
-@kindex 157 @kbd{o} (@code{vip-open-line})
-@kindex 117 @kbd{O} (@code{vip-Open-line})
+@kindex 157 o @r{(}@code{vip-open-line}@r{)}
+@kindex 117 O @r{(}@code{vip-Open-line}@r{)}
 Given counts, that many copies of text will be inserted. Thus
 @kbd{o a b c @key{ESC}} will insert 3 lines of @samp{abc} below the current
 line.
 @item /
 @itemx ?
-@kindex 057 @kbd{/} (@code{vip-search-forward})
-@kindex 077 @kbd{?} (@code{vip-search-backward})
+@kindex 057 / @r{(}@code{vip-search-forward}@r{)}
+@kindex 077 ? @r{(}@code{vip-search-backward}@r{)}
 Given a count @var{n}, @var{n}-th occurrence will be searched.
 @end table
 
@@ -417,7 +417,7 @@ Typing an @kbd{m} followed by a lower-case character @var{ch} marks the
 point to the register named @var{ch} as in Vi.  In addition to these, we
 have following key bindings for marking.
 
-@kindex 155 @kbd{m} (@code{vip-mark-point})
+@kindex 155 m @r{(}@code{vip-mark-point}@r{)}
 
 @table @kbd
 @item m <
@@ -451,34 +451,34 @@ Note that the keys below (except for @kbd{R}) are not used in Vi.
 
 @table @kbd
 @item C-a
-@kindex 001 @kbd{C-a} (@code{vip-beginning-of-line})
+@kindex 001 C-a @r{(}@code{vip-beginning-of-line}@r{)}
 Move point to the beginning of line.
 @item C-n
-@kindex 016 @kbd{C-n} (@code{vip-next-window})
+@kindex 016 C-n @r{(}@code{vip-next-window}@r{)}
 If you have two or more windows in the screen, this key will move point to
 the next window.
 @item C-o
-@kindex 017 @kbd{C-o} (@code{vip-open-line-at-point})
+@kindex 017 C-o @r{(}@code{vip-open-line-at-point}@r{)}
 Insert a newline and leave point before it, and then enter insert mode.
 @item C-r
-@kindex 022 @kbd{C-r} (@code{isearch-backward})
+@kindex 022 C-r @r{(}@code{isearch-backward}@r{)}
 Backward incremental search.
 @item C-s
-@kindex 023 @kbd{C-s} (@code{isearch-forward})
+@kindex 023 C-s @r{(}@code{isearch-forward}@r{)}
 Forward incremental search.
 @item C-c
 @itemx C-x
 @itemx @key{ESC}
-@kindex 003 @kbd{C-c} (@code{vip-ctl-c})
-@kindex 0300 @kbd{C-x} (@code{vip-ctl-x})
-@kindex 033 @kbd{ESC} (@code{vip-ESC})
+@kindex 003 C-c @r{(}@code{vip-ctl-c}@r{)}
+@kindex 0300 C-x @r{(}@code{vip-ctl-x}@r{)}
+@kindex 033 ESC @r{(}@code{vip-ESC}@r{)}
 These keys will exit from vi mode and return to emacs mode temporarily.  If
 you hit one of these keys, Emacs will be in emacs mode and will believe
 that you hit that key in emacs mode. For example, if you hit @kbd{C-x}
 followed by @kbd{2}, then the current window will be split into 2 and you
 will be in vi mode again.
 @item \
-@kindex 134 @kbd{\} (@code{vip-escape-to-emacs})
+@kindex 134 \ @r{(}@code{vip-escape-to-emacs}@r{)}
 Escape to emacs mode.  Hitting @kbd{\} will take you to emacs mode, and you
 can execute a single Emacs command.  After executing the Emacs command you
 will be in vi mode again.  You can give a count before typing @kbd{\}.
@@ -486,13 +486,13 @@ Thus @kbd{5 \ *}, as well as @kbd{\ C-u 5 *}, will insert @samp{*****}
 before point.  Similarly @kbd{1 0 \ C-p} will move the point 10 lines above
 the current line.
 @item K
-@kindex 113 @kbd{K} (@code{vip-kill-buffer})
+@kindex 113 K @r{(}@code{vip-kill-buffer}@r{)}
 Kill current buffer if it is not modified.  Useful when you selected a
 buffer which you did not want.
 @item Q
 @itemx R
-@kindex 121 @kbd{Q} (@code{vip-query-replace})
-@kindex 122 @kbd{R} (@code{vip-replace-string})
+@kindex 121 Q @r{(}@code{vip-query-replace}@r{)}
+@kindex 122 R @r{(}@code{vip-replace-string}@r{)}
 @kbd{Q} is for query replace and @kbd{R} is for replace.  By default,
 string to be replaced are treated literally.  If you wish to do a regular
 expression replace, first do replace with empty string as the string to be
@@ -500,39 +500,39 @@ replaced.  In this way, you can toggle between vanilla and regular
 expression replacement.
 @item v
 @itemx V
-@kindex 166 @kbd{v} (@code{vip-find-file})
-@kindex 126 @kbd{V} (@code{vip-find-file-other-window})
+@kindex 166 v @r{(}@code{vip-find-file}@r{)}
+@kindex 126 V @r{(}@code{vip-find-file-other-window}@r{)}
 These keys are used to Visit files.  @kbd{v} will switch to a buffer
 visiting file whose name can be entered in the minibuffer. @kbd{V} is
 similar, but will use window different from the current window.
 @item #
-@kindex 0430 @kbd{#} (@code{vip-command-argument})
+@kindex 0430 # @r{(}@code{vip-command-argument}@r{)}
 If followed by a certain character @var{ch}, it becomes an operator whose
 argument is the region determined by the motion command that follows.
 Currently, @var{ch} can be one of @kbd{c}, @kbd{C}, @kbd{g}, @kbd{q} and
 @kbd{s}.
 @item # c
-@kindex 0432 @kbd{# c} (@code{downcase-region})
+@kindex 0432 # c @r{(}@code{downcase-region}@r{)}
 Change upper-case characters in the region to lower case
 (@code{downcase-region}).
 @item # C
-@kindex 0431 @kbd{# C} (@code{upcase-region})
+@kindex 0431 # C @r{(}@code{upcase-region}@r{)}
 Change lower-case characters in the region to upper case. For instance,
 @kbd{# C 3 w} will capitalize 3 words from the current point
 (@code{upcase-region}).
 @item # g
-@kindex 0432 @kbd{# g} (@code{vip-global-execute})
+@kindex 0432 # g @r{(}@code{vip-global-execute}@r{)}
 Execute last keyboard macro for each line in the region
 (@code{vip-global-execute}).
 @item # q
-@kindex 0432 @kbd{# q} (@code{vip-quote-region})
+@kindex 0432 # q @r{(}@code{vip-quote-region}@r{)}
 Insert specified string at the beginning of each line in the region
 (@code{vip-quote-region}).
 @item # s
-@kindex 0432 @kbd{# s} (@code{spell-region})
+@kindex 0432 # s @r{(}@code{spell-region}@r{)}
 Check spelling of words in the region (@code{spell-region}).
 @item *
-@kindex 052 @kbd{*} (@code{vip-call-last-kbd-macro})
+@kindex 052 * @r{(}@code{vip-call-last-kbd-macro}@r{)}
 Call last keyboard macro.
 @end table
 
@@ -548,21 +548,21 @@ details.
 @table @kbd
 @item C-g
 @itemx g
-@kindex 007 @kbd{C-g} (@code{vip-keyboard-quit})
-@kindex 147 @kbd{g} (@code{vip-info-on-file})
+@kindex 007 C-g @r{(}@code{vip-keyboard-quit}@r{)}
+@kindex 147 g @r{(}@code{vip-info-on-file}@r{)}
 In Vi, @kbd{C-g} is used to get information about the file associated to
 the current buffer.  Here, @kbd{g} will do that, and @kbd{C-g} is
 used to abort a command (this is for compatibility with emacs mode.)
-@item SPC
+@item @key{SPC}
 @itemx @key{RET}
-@kindex 040 @kbd{SPC} (@code{vip-scroll})
-@kindex 015 @kbd{RET} (@code{vip-scroll-back})
+@kindex 040 SPC @r{(}@code{vip-scroll}@r{)}
+@kindex 015 RET @r{(}@code{vip-scroll-back}@r{)}
 Now these keys will scroll up and down the text of current window.
 Convenient for viewing the text.
 @item s
 @itemx S
-@kindex 163 @kbd{s} (@code{vip-switch-to-buffer})
-@kindex 123 @kbd{S} (@code{vip-switch-to-buffer-other-window})
+@kindex 163 s @r{(}@code{vip-switch-to-buffer}@r{)}
+@kindex 123 S @r{(}@code{vip-switch-to-buffer-other-window}@r{)}
 They are used to switch to a specified buffer.  Useful for switching to
 already existing buffer since buffer name completion is provided.  Also
 a default buffer will be given as part of the prompt, to which you can
@@ -570,8 +570,8 @@ switch by just typing @key{RET} key.  @kbd{s} is used to select buffer
 in the current window, while @kbd{S} selects buffer in another window.
 @item C
 @itemx X
-@kindex 103 @kbd{C} (@code{vip-ctl-c-equivalent})
-@kindex 1300 @kbd{X} (@code{vip-ctl-x-equivalent})
+@kindex 103 C @r{(}@code{vip-ctl-c-equivalent}@r{)}
+@kindex 1300 X @r{(}@code{vip-ctl-x-equivalent}@r{)}
 These keys will exit from vi mode and return to emacs mode temporarily.
 If you type @kbd{C} (@kbd{X}), Emacs will be in emacs mode and will believe
 that you have typed @kbd{C-c} (@kbd{C-x}) in emacs mode. Moreover,
@@ -588,7 +588,7 @@ vi mode again.
 
 In addition to these, @code{ctl-x-map} is slightly modified:
 
-@kindex 1301 @kbd{X 3} (@code{vip-buffer-in-two-windows})
+@kindex 1301 X 3 @r{(}@code{vip-buffer-in-two-windows}@r{)}
 
 @table @kbd
 @item X 3
@@ -604,19 +604,19 @@ basic functions related to windows, buffers and files.
 
 @table @kbd
 @item C-n
-@kindex 016 @kbd{C-n} (@code{vip-next-window})
+@kindex 016 C-n @r{(}@code{vip-next-window}@r{)}
 Switch to next window.
 @item X 1
 @itemx C-x 1
-@kindex 1301 @kbd{X 1} (@code{delete-other-windows})
+@kindex 1301 X 1 @r{(}@code{delete-other-windows}@r{)}
 Delete other windows.
 @item X 2
 @itemx C-x 2
-@kindex 1301 @kbd{X 2} (@code{split-window-vertically})
+@kindex 1301 X 2 @r{(}@code{split-window-vertically}@r{)}
 Split current window into two windows.
 @item X 3
 @itemx C-x 3
-@kindex 1301 @kbd{X 3} (@code{vip-buffer-in-two-windows})
+@kindex 1301 X 3 @r{(}@code{vip-buffer-in-two-windows}@r{)}
 Show current buffer in two windows.
 @end table
 
@@ -625,19 +625,19 @@ Show current buffer in two windows.
 
 @table @kbd
 @item s
-@kindex 163 @kbd{s} (@code{vip-switch-to-buffer})
+@kindex 163 s @r{(}@code{vip-switch-to-buffer}@r{)}
 Switch to the specified buffer in the current window
 (@code{vip-switch-to-buffer}).
 @item S
-@kindex 123 @kbd{S} (@code{vip-switch-to-buffer-other-window})
+@kindex 123 S @r{(}@code{vip-switch-to-buffer-other-window}@r{)}
 Switch to the specified buffer in another window
 (@code{vip-switch-to-buffer-other-window}).
 @item K
-@kindex 113 @kbd{K} (@code{vip-kill-buffer})
+@kindex 113 K @r{(}@code{vip-kill-buffer}@r{)}
 Kill the current buffer if it is not modified.
 @item X S
 @itemx C-x C-s
-@kindex 1302 @kbd{X S} (@code{save-buffer})
+@kindex 1302 X S @r{(}@code{save-buffer}@r{)}
 Save the current buffer in the file associated to the buffer.
 @end table
 
@@ -646,18 +646,18 @@ Save the current buffer in the file associated to the buffer.
 
 @table @kbd
 @item v
-@kindex 166 @kbd{v} (@code{vip-find-file})
+@kindex 166 v @r{(}@code{vip-find-file}@r{)}
 Visit specified file in the current window.
 @item V
-@kindex 126 @kbd{V} (@code{vip-find-file-other-window})
+@kindex 126 V @r{(}@code{vip-find-file-other-window}@r{)}
 Visit specified file in another window.
 @item X W
 @itemx C-x C-w
-@kindex 1302 @kbd{X W} (@code{write-file})
+@kindex 1302 X W @r{(}@code{write-file}@r{)}
 Write current buffer into the specified file.
 @item X I
 @itemx C-x C-i
-@kindex 1302 @kbd{X I} (@code{insert-file})
+@kindex 1302 X I @r{(}@code{insert-file}@r{)}
 
 Insert specified file at point.
 @end table
@@ -668,18 +668,18 @@ Insert specified file at point.
 @table @kbd
 @item X (
 @itemx C-x (
-@kindex 1301 @kbd{X (} (@code{start-kbd-macro})
+@kindex 1301 X ( @r{(}@code{start-kbd-macro}@r{)}
 Start remembering keyboard macro.
 @item X )
 @itemx C-x )
-@kindex 1301 @kbd{X )} (@code{end-kbd-macro})
+@kindex 1301 X ) @r{(}@code{end-kbd-macro}@r{)}
 Finish remembering keyboard macro.
 @item *
-@kindex 052 @kbd{*} (@code{vip-call-last-kbd-macro})
+@kindex 052 * @r{(}@code{vip-call-last-kbd-macro}@r{)}
 Call last remembered keyboard macro.
 @item X Z
 @itemx C-x C-z
-@kindex 1302 @kbd{X Z} (@code{suspend-emacs})
+@kindex 1302 X Z @r{(}@code{suspend-emacs}@r{)}
 Suspend Emacs.
 @item Z Z
 Exit Emacs.
@@ -715,15 +715,15 @@ commands described in this chapter are to be used in vi mode.
 
 @cindex numeric arguments
 @cindex count
-@kindex 061 @kbd{1} (numeric argument)
-@kindex 062 @kbd{2} (numeric argument)
-@kindex 063 @kbd{3} (numeric argument)
-@kindex 064 @kbd{4} (numeric argument)
-@kindex 065 @kbd{5} (numeric argument)
-@kindex 066 @kbd{6} (numeric argument)
-@kindex 067 @kbd{7} (numeric argument)
-@kindex 068 @kbd{8} (numeric argument)
-@kindex 069 @kbd{9} (numeric argument)
+@kindex 061 1 @r{(numeric argument)}
+@kindex 062 2 @r{(numeric argument)}
+@kindex 063 3 @r{(numeric argument)}
+@kindex 064 4 @r{(numeric argument)}
+@kindex 065 5 @r{(numeric argument)}
+@kindex 066 6 @r{(numeric argument)}
+@kindex 067 7 @r{(numeric argument)}
+@kindex 068 8 @r{(numeric argument)}
+@kindex 069 9 @r{(numeric argument)}
 
 Most Vi commands accept a @dfn{numeric argument} which can be supplied as
 a prefix to the commands.  A numeric argument is also called a @dfn{count}.
@@ -739,10 +739,10 @@ functions are the same in any of emacs, vi and insert mode.
 
 @table @kbd
 @item C-g
-@kindex 007 @kbd{C-g} (@code{vip-keyboard-quit})
+@kindex 007 C-g (@code{vip-keyboard-quit}@r{)}
 Quit.  Cancel running or partially typed command (@code{keyboard-quit}).
 @item C-l
-@kindex 014 @kbd{C-l} (@code{recenter})
+@kindex 014 C-l @r{(}@code{recenter}@r{)}
 Clear the screen and reprint everything (@code{recenter}).
 @end table
 
@@ -754,9 +754,9 @@ accessed from vi mode as easily as from emacs mode.
 @item C-x
 @itemx C-c
 @itemx @key{ESC}
-@kindex 003 @kbd{C-c} (@code{vip-ctl-c})
-@kindex 0300 @kbd{C-x} (@code{vip-ctl-x})
-@kindex 033 @kbd{ESC} (@code{vip-ESC})
+@kindex 003 C-c @r{(}@code{vip-ctl-c}@r{)}
+@kindex 0300 C-x @r{(}@code{vip-ctl-x}@r{)}
+@kindex 033 ESC @r{(}@code{vip-ESC}@r{)}
 Typing one of these keys have the same effect as typing it in emacs mode.
 Appropriate command will be executed according as the keys you type after
 it.  You will be in vi mode again after the execution of the command.
@@ -764,8 +764,8 @@ For instance, if you type @kbd{@key{ESC} <} (in vi mode) then the cursor will
 move to the beginning of the buffer and you will still be in vi mode.
 @item C
 @itemx X
-@kindex 103 @kbd{C} (@code{vip-ctl-c-equivalent})
-@kindex 1300 @kbd{X} (@code{vip-ctl-x-equivalent})
+@kindex 103 C @r{(}@code{vip-ctl-c-equivalent}@r{)}
+@kindex 1300 X @r{(}@code{vip-ctl-x-equivalent}@r{)}
 Typing one of these keys have the effect of typing the corresponding
 control character in emacs mode.  Moreover, if you type an upper-case
 character following it, that character will also be translated to the
@@ -773,7 +773,7 @@ corresponding control character.  Thus typing @kbd{X W} in vi mode is the
 same as typing @kbd{C-x C-w} in emacs mode.  You will be in vi mode again
 after the execution of a command.
 @item \
-@kindex 134 @kbd{\} (@code{vip-escape-to-emacs})
+@kindex 134 \ @r{(}@code{vip-escape-to-emacs}@r{)}
 Escape to emacs mode.  Hitting the @kbd{\} key will take you to emacs mode,
 and you can execute a single Emacs command.  After executing the
 Emacs command you will be in vi mode again.  You can give a count before
@@ -810,31 +810,31 @@ We have the following commands related to windows and buffers.
 
 @table @kbd
 @item C-n
-@kindex 016 @kbd{C-n} (@code{vip-next-window})
+@kindex 016 C-n @r{(}@code{vip-next-window}@r{)}
 Move cursor to the next-window (@code{vip-next-window}).
 @item X 1
-@kindex 1301 @kbd{X 1} (@code{delete-other-windows})
+@kindex 1301 X 1 @r{(}@code{delete-other-windows}@r{)}
 Delete other windows and make the selected window fill the screen
 @*(@code{delete-other-windows}).
 @item X 2
-@kindex 1301 @kbd{X 2} (@code{split-window-vertically})
+@kindex 1301 X 2 @r{(}@code{split-window-vertically}@r{)}
 Split current window into two windows (@code{split-window-vertically}).
 @item X 3
-@kindex 1301 @kbd{X 3} (@code{vip-buffer-in-two-windows})
+@kindex 1301 X 3 @r{(}@code{vip-buffer-in-two-windows}@r{)}
 Show current buffer in two windows.
 @item s @var{buffer} @key{RET}
-@kindex 163 @kbd{s} (@code{vip-switch-to-buffer})
+@kindex 163 s @r{(}@code{vip-switch-to-buffer}@r{)}
 Select or create a buffer named @var{buffer} (@code{vip-switch-to-buffer}).
 @item S @var{buffer} @key{RET}
-@kindex 123 @kbd{S} (@code{vip-switch-to-buffer-other-window})
+@kindex 123 S @r{(}@code{vip-switch-to-buffer-other-window}@r{)}
 Similar but select a buffer named @var{buffer} in another window
 @*(@code{vip-switch-to-buffer-other-window}).
 @item K
-@kindex 113 @kbd{K} (@code{vip-kill-buffer})
+@kindex 113 K @r{(}@code{vip-kill-buffer}@r{)}
 Kill the current buffer if it is not modified or if it is not associated
 with a file @*(@code{vip-kill-buffer}).
 @item X B
-@kindex 1302 @kbd{X B} (@code{list-buffers})
+@kindex 1302 X B @r{(}@code{list-buffers}@r{)}
 List the existing buffers (@code{list-buffers}).
 @end table
 
@@ -856,24 +856,24 @@ save and insert files.
 
 @table @kbd
 @item v @var{file} @key{RET}
-@kindex 166 @kbd{v} (@code{vip-find-file})
+@kindex 166 v @r{(}@code{vip-find-file}@r{)}
 Visit specified file in the current window (@code{vip-find-file}).
 @item V @var{file} @key{RET}
-@kindex 126 @kbd{V} (@code{vip-find-file-other-window})
+@kindex 126 V @r{(}@code{vip-find-file-other-window}@r{)}
 Visit specified file in another window (@code{vip-find-file-other-window}).
 @item X S
-@kindex 1302 @kbd{X S} (@code{save-buffer})
+@kindex 1302 X S @r{(}@code{save-buffer}@r{)}
 Save current buffer to the file associated with the buffer.  If no file is
 associated with the buffer, the name of the file to write out the content
 of the buffer will be asked in the minibuffer.
 @item X W @var{file} @key{RET}
-@kindex 1302 @kbd{X W} (@code{write-file})
+@kindex 1302 X W @r{(}@code{write-file}@r{)}
 Write current buffer into a specified file.
 @item X I @var{file} @key{RET}
-@kindex 1302 @kbd{X I} (@code{insert-file})
+@kindex 1302 X I @r{(}@code{insert-file}@r{)}
 Insert a specified file at point.
 @item g
-@kindex 147 @kbd{g} (@code{vip-info-on-file})
+@kindex 147 g @r{(}@code{vip-info-on-file}@r{)}
 Give information on the file associated with the current buffer.  Tell you
 the name of the file associated with the buffer, the line number of the
 current point and total line numbers in the buffer.  If no file is
@@ -940,29 +940,29 @@ buffer.
 @table @kbd
 @item @key{SPC}
 @itemx C-f
-@kindex 040 @kbd{SPC} (@code{vip-scroll})
-@kindex 006 @kbd{C-f} (@code{vip-scroll-back})
+@kindex 040 SPC @r{(}@code{vip-scroll}@r{)}
+@kindex 006 C-f @r{(}@code{vip-scroll-back}@r{)}
 Scroll text of current window upward almost full screen.  You can go
 @i{forward} in the buffer by this command (@code{vip-scroll}).
 @item @key{RET}
 @itemx C-b
-@kindex 015 @kbd{RET} (@code{vip-scroll-back})
-@kindex 002 @kbd{C-b} (@code{vip-scroll-back})
+@kindex 015 RET @r{(}@code{vip-scroll-back}@r{)}
+@kindex 002 C-b @r{(}@code{vip-scroll-back}@r{)}
 Scroll text of current window downward almost full screen.  You can go
 @i{backward} in the buffer by this command (@code{vip-scroll-back}).
 @item C-d
-@kindex 004 @kbd{C-d} (@code{vip-scroll-up})
+@kindex 004 C-d @r{(}@code{vip-scroll-up}@r{)}
 Scroll text of current window upward half screen.  You can go
 @i{down} in the buffer by this command (@code{vip-scroll-down}).
 @item C-u
-@kindex 025 @kbd{C-u} (@code{vip-scroll-down})
+@kindex 025 C-u @r{(}@code{vip-scroll-down}@r{)}
 Scroll text of current window downward half screen.  You can go
 @i{up} in the buffer by this command (@code{vip-scroll-up}).
 @item C-y
-@kindex 031 @kbd{C-y} (@code{vip-scroll-down-one})
+@kindex 031 C-y @r{(}@code{vip-scroll-down-one}@r{)}
 Scroll text of current window upward by one line (@code{vip-scroll-down-one}).
 @item C-e
-@kindex 005 @kbd{C-e} (@code{vip-scroll-up-one})
+@kindex 005 C-e @r{(}@code{vip-scroll-up-one}@r{)}
 Scroll text of current window downward by one line (@code{vip-scroll-up-one}).
 @end table
 @noindent
@@ -974,22 +974,22 @@ The following commands reposition point in the window.
 @table @kbd
 @item z H
 @itemx z @key{RET}
-@kindex 1723 @kbd{z H} (@code{vip-line-to-top})
-@kindex 1721 @kbd{z RET} (@code{vip-line-to-top})
+@kindex 1723 z H @r{(}@code{vip-line-to-top}@r{)}
+@kindex 1721 z RET @r{(}@code{vip-line-to-top}@r{)}
 Put point on the top (@i{home}) line in the window.  So the current line
 becomes the top line in the window.  Given a count @var{n}, point will be
 placed in the @var{n}-th line from top (@code{vip-line-to-top}).
 @item z M
 @itemx z .
-@kindex 1723 @kbd{z M} (@code{vip-line-to-middle})
-@kindex 1722 @kbd{z .} (@code{vip-line-to-middle})
+@kindex 1723 z M @r{(}@code{vip-line-to-middle}@r{)}
+@kindex 1722 z . @r{(}@code{vip-line-to-middle}@r{)}
 Put point on the @i{middle} line in the window.  Given a count @var{n},
 point will be placed in the @var{n}-th line from the middle line
 (@code{vip-line-to-middle}).
 @item z L
 @itemx z -
-@kindex 1723 @kbd{z L} (@code{vip-line-to-bottom})
-@kindex 1722 @kbd{z -} (@code{vip-line-to-bottom})
+@kindex 1723 z L @r{(}@code{vip-line-to-bottom}@r{)}
+@kindex 1722 z - @r{(}@code{vip-line-to-bottom}@r{)}
 Put point on the @i{bottom} line in the window.  Given a count @var{n},
 point will be placed in the @var{n}-th line from bottom
 (@code{vip-line-to-bottom}).
@@ -1004,7 +1004,7 @@ The following commands are used to mark positions in the buffer.
 
 @table @kbd
 @item m @var{ch}
-@kindex 155 @kbd{m} (@code{vip-mark-point})
+@kindex 155 m @r{(}@code{vip-mark-point}@r{)}
 Store current point in the register @var{ch}.  @var{ch} must be a
 lower-case @acronym{ASCII} letter.
 @item m <
@@ -1034,31 +1034,31 @@ to be described in the next section.
 
 @table @kbd
 @item h
-@kindex 150 @kbd{h} (@code{vip-backward-char})
+@kindex 150 h @r{(}@code{vip-backward-char}@r{)}
 Move point backward by one character.  Signal error if point is at the
 beginning of buffer, but (unlike Vi) do not complain otherwise
 (@code{vip-backward-char}).
 @item l
-@kindex 154 @kbd{l} (@code{vip-forward-char})
+@kindex 154 l @r{(}@code{vip-forward-char}@r{)}
 Move point backward by one character.  Signal error if point is at the
 end of buffer, but (unlike Vi) do not complain otherwise
 (@code{vip-forward-char}).
 @item j
-@kindex 152 @kbd{j} (@code{vip-next-line})
+@kindex 152 j @r{(}@code{vip-next-line}@r{)}
 Move point to the next line keeping the current column.  If point is on the
 last line of the buffer, a new line will be created and point will move to
 that line (@code{vip-next-line}).
 @item k
-@kindex 153 @kbd{k} (@code{vip-previous-line})
+@kindex 153 k @r{(}@code{vip-previous-line}@r{)}
 Move point to the previous line keeping the current column
 (@code{vip-next-line}).
 @item +
-@kindex 053 @kbd{+} (@code{vip-next-line-at-bol})
+@kindex 053 + @r{(}@code{vip-next-line-at-bol}@r{)}
 Move point to the next line at the first non-white character.  If point is
 on the last line of the buffer, a new line will be created and point will
 move to the beginning of that line (@code{vip-next-line-at-bol}).
 @item -
-@kindex 055 @kbd{-} (@code{vip-previous-line-at-bol})
+@kindex 055 - @r{(}@code{vip-previous-line-at-bol}@r{)}
 Move point to the previous line at the first non-white character
 (@code{vip-previous-line-at-bol}).
 @end table
@@ -1068,17 +1068,17 @@ many times.
 
 @table @kbd
 @item 0
-@kindex 060 @kbd{0} (@code{vip-beginning-of-line})
+@kindex 060 0 @r{(}@code{vip-beginning-of-line}@r{)}
 Move point to the beginning of line (@code{vip-beginning-of-line}).
 @item ^
-@kindex 136 @kbd{^} (@code{vip-bol-and-skip-white})
+@kindex 136 ^ @r{(}@code{vip-bol-and-skip-white}@r{)}
 Move point to the first non-white character on the line
 (@code{vip-bol-and-skip-white}).
 @item $
-@kindex 044 @kbd{$} (@code{vip-goto-eol})
+@kindex 044 $ @r{(}@code{vip-goto-eol}@r{)}
 Move point to the end of line (@code{vip-goto-eol}).
 @item @var{n} |
-@kindex 174 @kbd{|} (@code{vip-goto-col})
+@kindex 174 | @r{(}@code{vip-goto-col}@r{)}
 Move point to the @var{n}-th column on the line (@code{vip-goto-col}).
 @end table
 @noindent
@@ -1088,25 +1088,25 @@ Except for the @kbd{|} command, these commands neglect a count.
 
 @table @kbd
 @item w
-@kindex 167 @kbd{w} (@code{vip-forward-word})
+@kindex 167 w @r{(}@code{vip-forward-word}@r{)}
 Move point forward to the beginning of the next word
 (@code{vip-forward-word}).
 @item W
-@kindex 127 @kbd{W} (@code{vip-forward-Word})
+@kindex 127 W @r{(}@code{vip-forward-Word}@r{)}
 Move point forward to the beginning of the next word, where a @dfn{word} is
 considered as a sequence of non-white characters (@code{vip-forward-Word}).
 @item b
-@kindex 142 @kbd{b} (@code{vip-backward-word})
+@kindex 142 b @r{(}@code{vip-backward-word}@r{)}
 Move point backward to the beginning of a word (@code{vip-backward-word}).
 @item B
-@kindex 102 @kbd{B} (@code{vip-backward-Word})
+@kindex 102 B @r{(}@code{vip-backward-Word}@r{)}
 Move point backward to the beginning of a word, where a @i{word} is
 considered as a sequence of non-white characters (@code{vip-forward-Word}).
 @item e
-@kindex 145 @kbd{e} (@code{vip-end-of-word})
+@kindex 145 e @r{(}@code{vip-end-of-word}@r{)}
 Move point forward to the end of a word (@code{vip-end-of-word}).
 @item E
-@kindex 105 @kbd{E} (@code{vip-end-of-Word})
+@kindex 105 E @r{(}@code{vip-end-of-Word}@r{)}
 Move point forward to the end of a word, where a @i{word} is
 considered as a sequence of non-white characters (@code{vip-end-of-Word}).
 @end table
@@ -1120,17 +1120,17 @@ details of syntax table.
 
 @table @kbd
 @item H
-@kindex 110 @kbd{H} (@code{vip-window-top})
+@kindex 110 H @r{(}@code{vip-window-top}@r{)}
 Move point to the beginning of the @i{home} (top) line of the window.
 Given a count @var{n}, go to the @var{n}-th line from top
 (@code{vip-window-top}).
 @item M
-@kindex 115 @kbd{M} (@code{vip-window-middle})
+@kindex 115 M @r{(}@code{vip-window-middle}@r{)}
 Move point to the beginning of the @i{middle} line of the window.  Given
 a count @var{n}, go to the @var{n}-th line from the middle line
 (@code{vip-window-middle}).
 @item L
-@kindex 114 @kbd{L} (@code{vip-window-bottom})
+@kindex 114 L @r{(}@code{vip-window-bottom}@r{)}
 Move point to the beginning of the @i{lowest} (bottom) line of the
 window.  Given count, go to the @var{n}-th line from bottom
 (@code{vip-window-bottom}).
@@ -1140,19 +1140,19 @@ These commands can be used to go to the desired line visible on the screen.
 
 @table @kbd
 @item (
-@kindex 050 @kbd{(} (@code{vip-backward-sentence})
+@kindex 050 ( @r{(}@code{vip-backward-sentence}@r{)}
 Move point backward to the beginning of the sentence
 (@code{vip-backward-sentence}).
 @item )
-@kindex 051 @kbd{)} (@code{vip-forward-sentence})
+@kindex 051 ) @r{(}@code{vip-forward-sentence}@r{)}
 Move point forward to the end of the sentence
 (@code{vip-forward-sentence}).
 @item @{
-@kindex 173 @kbd{@{} (@code{vip-backward-paragraph})
+@kindex 173 @{ @r{(}@code{vip-backward-paragraph}@r{)}
 Move point backward to the beginning of the paragraph
 (@code{vip-backward-paragraph}).
 @item @}
-@kindex 175 @kbd{@}} (@code{vip-forward-paragraph})
+@kindex 175 @} @r{(}@code{vip-forward-paragraph}@r{)}
 Move point forward to the end of the paragraph
 (@code{vip-forward-paragraph}).
 @end table
@@ -1161,25 +1161,25 @@ A count repeats the effect for these commands.
 
 @table @kbd
 @item G
-@kindex 107 @kbd{G} (@code{vip-goto-line})
+@kindex 107 G @r{(}@code{vip-goto-line}@r{)}
 Given a count @var{n}, move point to the @var{n}-th line in the buffer on
 the first non-white character.  Without a count, go to the end of the buffer
 (@code{vip-goto-line}).
 @item ` `
-@kindex 140 @kbd{`} (@code{vip-goto-mark})
+@kindex 140 ` @r{(}@code{vip-goto-mark}@r{)}
 Exchange point and mark (@code{vip-goto-mark}).
 @item ` @var{ch}
 Move point to the position stored in the register @var{ch}.  @var{ch} must
 be a lower-case letter.
 @item ' '
-@kindex 047 @kbd{'} (@code{vip-goto-mark-and-skip-white})
+@kindex 047 ' @r{(}@code{vip-goto-mark-and-skip-white}@r{)}
 Exchange point and mark, and then move point to the first non-white
 character on the line (@code{vip-goto-mark-and-skip-white}).
 @item ' @var{ch}
 Move point to the position stored in the register @var{ch} and skip to the
 first non-white character on the line.  @var{ch} must be a lower-case letter.
 @item %
-@kindex 045 @kbd{%} (@code{vip-paren-match})
+@kindex 045 % @r{(}@code{vip-paren-match}@r{)}
 Move point to the matching parenthesis if point is looking at @kbd{(},
 @kbd{)}, @kbd{@{}, @kbd{@}}, @kbd{[} or @kbd{]}
 @*(@code{vip-paren-match}).
@@ -1194,27 +1194,27 @@ will repeat the effect.
 
 @table @kbd
 @item f @var{ch}
-@kindex 146 @kbd{f} (@code{vip-find-char-forward})
+@kindex 146 f @r{(}@code{vip-find-char-forward}@r{)}
 Move point forward to the character @var{ch} on the line.  Signal error if
 @var{ch} could not be found (@code{vip-find-char-forward}).
 @item F @var{ch}
-@kindex 106 @kbd{F} (@code{vip-find-char-backward})
+@kindex 106 F @r{(}@code{vip-find-char-backward}@r{)}
 Move point backward to the character @var{ch} on the line.  Signal error if
 @var{ch} could not be found (@code{vip-find-char-backward}).
 @item t @var{ch}
-@kindex 164 @kbd{t} (@code{vip-goto-char-forward})
+@kindex 164 t @r{(}@code{vip-goto-char-forward}@r{)}
 Move point forward upto the character @var{ch} on the line.  Signal error if
 @var{ch} could not be found (@code{vip-goto-char-forward}).
 @item T @var{ch}
-@kindex 124 @kbd{T} (@code{vip-goto-char-backward})
+@kindex 124 T @r{(}@code{vip-goto-char-backward}@r{)}
 Move point backward upto the character @var{ch} on the line.  Signal error if
 @var{ch} could not be found (@code{vip-goto-char-backward}).
 @item ;
-@kindex 073 @kbd{;} (@code{vip-repeat-find})
+@kindex 073 ; @r{(}@code{vip-repeat-find}@r{)}
 Repeat previous @kbd{f}, @kbd{t}, @kbd{F} or @kbd{T} command
 (@code{vip-repeat-find}).
 @item ,
-@kindex 054 @kbd{,} (@code{vip-repeat-find-opposite})
+@kindex 054 , @r{(}@code{vip-repeat-find-opposite}@r{)}
 Repeat previous @kbd{f}, @kbd{t}, @kbd{F} or @kbd{T} command, in the
 opposite direction (@code{vip-repeat-find-opposite}).
 @end table
@@ -1228,7 +1228,7 @@ Following commands are available for searching and replacing.
 
 @table @kbd
 @item / @var{string} @key{RET}
-@kindex 057 @kbd{/} (@code{vip-search-forward})
+@kindex 057 / @r{(}@code{vip-search-forward}@r{)}
 Search the first occurrence of the string @var{string} forward starting
 from point.  Given a count @var{n}, the @var{n}-th occurrence of
 @var{string} will be searched.  If the variable @code{vip-re-search} has value
@@ -1238,28 +1238,28 @@ empty string as @var{string} then the search mode will change from vanilla
 search to regular expression search and vice versa
 (@code{vip-search-forward}).
 @item ? @var{string} @key{RET}
-@kindex 077 @kbd{?} (@code{vip-search-backward})
+@kindex 077 ? @r{(}@code{vip-search-backward}@r{)}
 Same as @kbd{/}, except that search is done backward
 (@code{vip-search-backward}).
 @item n
-@kindex 156 @kbd{n} (@code{vip-search-next})
+@kindex 156 n @r{(}@code{vip-search-next}@r{)}
 Search the previous search pattern in the same direction as before
 (@code{vip-search-next}).
 @item N
-@kindex 116 @kbd{N} (@code{vip-search-Next})
+@kindex 116 N @r{(}@code{vip-search-Next}@r{)}
 Search the previous search pattern in the opposite direction
 (@code{vip-search-Next}).
 @item C-s
-@kindex 023 @kbd{C-s} (@code{isearch-forward})
+@kindex 023 C-s @r{(}@code{isearch-forward}@r{)}
 Search forward incrementally.  See GNU Emacs Manual for details
 (@code{isearch-forward}).
 @item C-r
-@kindex 022 @kbd{C-r} (@code{isearch-backward})
+@kindex 022 C-r @r{(}@code{isearch-backward}@r{)}
 Search backward incrementally (@code{isearch-backward}).
 @cindex vanilla (replacement)
 @cindex regular expression (replacement)
-@item R @var{string} RET @var{newstring}
-@kindex 122 @kbd{R} (@code{vip-replace-string})
+@item R @var{string} @key{RET} @var{newstring}
+@kindex 122 R @r{(}@code{vip-replace-string}@r{)}
 There are two modes of replacement, @dfn{vanilla} and @dfn{regular expression}.
 If the mode is @i{vanilla} you will get a prompt @samp{Replace string:},
 and if the mode is @i{regular expression} you will ge a prompt
@@ -1269,13 +1269,13 @@ vanilla, this command replaces every occurrence of @var{string} with
 @var{newstring}.  If the mode is regular expression, @var{string} is
 treated as a regular expression and every string matching the regular
 expression is replaced with @var{newstring} (@code{vip-replace-string}).
-@item Q @var{string} RET @var{newstring}
-@kindex 121 @kbd{Q} (@code{vip-query-replace})
+@item Q @var{string} @key{RET} @var{newstring}
+@kindex 121 Q @r{(}@code{vip-query-replace}@r{)}
 Same as @kbd{R} except that you will be asked form confirmation before each
 replacement
 @*(@code{vip-query-replace}).
 @item r @var{ch}
-@kindex 162 @kbd{r} (@code{vip-replace-char})
+@kindex 162 r @r{(}@code{vip-replace-char}@r{)}
 Replace the character point is looking at by the character @var{ch}.  Give
 count, replace that many characters by @var{ch} (@code{vip-replace-char}).
 @end table
@@ -1326,7 +1326,7 @@ command.
 
 @table @kbd
 @item d @var{motion-command}
-@kindex 1440 @kbd{d} (@code{vip-command-argument})
+@kindex 1440 d @r{(}@code{vip-command-argument}@r{)}
 Delete the region determined by the motion command @var{motion-command}.
 @end table
 @noindent
@@ -1337,7 +1337,7 @@ end of the buffer, since @kbd{G} is a line command.  A count given to the
 command above will become the count for the associated motion command.
 Thus, @kbd{3 d w} will delete three words.
 
-@kindex 042 @kbd{"} (@code{vip-command-argument})
+@kindex 042 " @r{(}@code{vip-command-argument}@r{)}
 It is also possible to save the deleted text into a register you specify.
 For example, you can say @kbd{" t 3 d w} to delete three words and save it
 to register @kbd{t}.  The name of a register is a lower-case letter between
@@ -1352,23 +1352,23 @@ We have more delete commands as below.
 
 @table @kbd
 @item d d
-@kindex 1442 @kbd{d d}
+@kindex 1442 d d
 Delete a line.  Given a count @var{n}, delete @var{n} lines.
 @item d r
-@kindex 1442 @kbd{d r}
+@kindex 1442 d r
 Delete current region.
 @item d R
-@kindex 1441 @kbd{d R}
+@kindex 1441 d R
 Expand current region and delete it.
 @item D
-@kindex 104 @kbd{D} (@code{vip-kill-line})
+@kindex 104 D @r{(}@code{vip-kill-line}@r{)}
 Delete to the end of a line (@code{vip-kill-line}).
 @item x
-@kindex 170 @kbd{x} (@code{vip-delete-char})
+@kindex 170 x @r{(}@code{vip-delete-char}@r{)}
 Delete a character after point.  Given @var{n}, delete @var{n} characters
 (@code{vip-delete-char}).
 @item @key{DEL}
-@kindex 177 @kbd{DEL} (@code{vip-delete-backward-char})
+@kindex 177 DEL @r{(}@code{vip-delete-backward-char}@r{)}
 Delete a character before point.  Given @var{n}, delete @var{n} characters
 (@code{vip-delete-backward-char}).
 @end table
@@ -1385,7 +1385,7 @@ commands that put back the yanked text into the buffer.
 
 @table @kbd
 @item y @var{motion-command}
-@kindex 1710 @kbd{y} (@code{vip-command-argument})
+@kindex 1710 y @r{(}@code{vip-command-argument}@r{)}
 Yank the region determined by the motion command @var{motion-command}.
 @end table
 @noindent
@@ -1398,14 +1398,14 @@ Use the following command to yank consecutive lines of text.
 @table @kbd
 @item y y
 @itemx Y
-@kindex 131 @kbd{Y} (@code{vip-yank-line})
-@kindex 1712 @kbd{y y} (@code{vip-yank-line})
+@kindex 131 Y @r{(}@code{vip-yank-line}@r{)}
+@kindex 1712 y y @r{(}@code{vip-yank-line}@r{)}
 Yank a line.  Given @var{n}, yank @var{n} lines (@code{vip-yank-line}).
 @item y r
-@kindex 1712 @kbd{y r}
+@kindex 1712 y r
 Yank current region.
 @item y R
-@kindex 1711 @kbd{y R}
+@kindex 1711 y R
 Expand current region and yank it.
 @end table
 
@@ -1416,7 +1416,7 @@ below.
 
 @table @kbd
 @item p
-@kindex 160 @kbd{p} (@code{vip-put-back})
+@kindex 160 p @r{(}@code{vip-put-back}@r{)}
 Insert, after the character point is looking at, most recently
 deleted/yanked text from anonymous register. Given a register name
 argument, the content of the named register will be put back.  Given a
@@ -1424,7 +1424,7 @@ count, the command will be repeated that many times. This command also
 checks if the text to put back ends with a new line character, and if so
 the text will be put below the current line (@code{vip-put-back}).
 @item P
-@kindex 120 @kbd{P} (@code{vip-Put-back})
+@kindex 120 P @r{(}@code{vip-Put-back}@r{)}
 Insert at point most recently deleted/yanked text from anonymous register.
 Given a register name argument, the content of the named register will
 be put back.  Given a count, the command will be repeated that many times.
@@ -1447,7 +1447,7 @@ Most commonly used change command takes the following form.
 
 @table @kbd
 @item c @var{motion-command}
-@kindex 1430 @kbd{c} (@code{vip-command-argument})
+@kindex 1430 c @r{(}@code{vip-command-argument}@r{)}
 Replace the content of the region determined by the motion command
 @var{motion-command} by the text you type.  If the motion command is a
 point command then you will type the text into minibuffer, and if the
@@ -1463,13 +1463,13 @@ command.
 
 @table @kbd
 @item c c
-@kindex 1432 @kbd{c c}
+@kindex 1432 c c
 Change a line.  Given a count, that many lines are changed.
 @item c r
-@kindex 1432 @kbd{c r}
+@kindex 1432 c r
 Change current region.
 @item c R
-@kindex 1431 @kbd{c R}
+@kindex 1431 c R
 Expand current region and change it.
 @end table
 
@@ -1481,13 +1481,13 @@ it.  It is also very easy to undo changes made by modifying commands.
 
 @table @kbd
 @item u
-@kindex 165 @kbd{u} (@code{vip-undo})
+@kindex 165 u @r{(}@code{vip-undo}@r{)}
 Undo the last change.  You can undo more by repeating undo by the repeat
 command @samp{.}.  For example, you can undo 5 previous changes by typing
 @samp{u....}.  If you type @samp{uu}, then the second @samp{u} undoes the
 first undo command (@code{vip-undo}).
 @item .
-@kindex 056 @kbd{.} (@code{vip-repeat})
+@kindex 056 . @r{(}@code{vip-repeat}@r{)}
 Repeat the last modifying command.  Given count @var{n} it becomes the new
 count for the repeated command.  Otherwise, the count for the last
 modifying command is used again (@code{vip-repeat}).
@@ -1500,12 +1500,12 @@ Miscellaneous Vi commands are collected here.
 
 @table @kbd
 @item Z Z
-@kindex 132 @kbd{Z Z} (@code{save-buffers-kill-emacs})
+@kindex 132 Z Z @r{(}@code{save-buffers-kill-emacs}@r{)}
 Exit Emacs.  If modified buffers exist, you will be asked whether you wish
 to save them or not (@code{save-buffers-kill-emacs}).
 @item !@: @var{motion-command} @var{format-command}
 @itemx @var{n} !@: !@: @var{format-command}
-@kindex 041 @kbd{!} (@code{vip-command-argument})
+@kindex 041 ! @r{(}@code{vip-command-argument}@r{)}
 The region determined by the motion command @var{motion-command} will be
 given to the shell command @var{format-command} and the region will be
 replaced by its output.  If a count is given, it will be passed to
@@ -1514,30 +1514,30 @@ between point and the 3rd line.  If @kbd{!} is used instead of
 @var{motion-command} then @var{n} lines will be processed by
 @var{format-command} (@code{vip-command-argument}).
 @item J
-@kindex 112 @kbd{J} (@code{vip-join-lines})
+@kindex 112 J @r{(}@code{vip-join-lines}@r{)}
 Join two lines.  Given count, join that many lines.  A space will be
 inserted at each junction (@code{vip-join-lines}).
 @item < @var{motion-command}
 @itemx @var{n} < <
-@kindex 074 @kbd{<} (@code{vip-command-argument})
+@kindex 074 < @r{(}@code{vip-command-argument}@r{)}
 Shift region determined by the motion command @var{motion-command} to
 left by @var{shift-width} (default is 8).  If @kbd{<} is used instead of
 @var{motion-command} then shift @var{n} lines
 @*(@code{vip-command-argument}).
 @item > @var{motion-command}
 @itemx @var{n} > >
-@kindex 076 @kbd{>} (@code{vip-command-argument})
+@kindex 076 > @r{(}@code{vip-command-argument}@r{)}
 Shift region determined by the motion command @var{motion-command} to
 right by @var{shift-width} (default is 8).  If @kbd{<} is used instead of
 @var{motion-command} then shift @var{n} lines
 @*(@code{vip-command-argument}).
 @item = @var{motion-command}
-@kindex 075 @kbd{=} (@code{vip-command-argument})
+@kindex 075 = @r{(}@code{vip-command-argument}@r{)}
 Indent region determined by the motion command @var{motion-command}.  If
 @kbd{=} is used instead of @var{motion-command} then indent @var{n} lines
 (@code{vip-command-argument}).
 @item *
-@kindex 052 @kbd{*} (@code{vip-call-last-kbd-macro})
+@kindex 052 * @r{(}@code{vip-call-last-kbd-macro}@r{)}
 Call last remembered keyboard macro.
 @item #
 A new vi operator. @xref{New Commands}, for more details.
@@ -1546,14 +1546,14 @@ A new vi operator. @xref{New Commands}, for more details.
 The following keys are reserved for future extensions, and currently
 assigned to a function that just beeps (@code{vip-nil}).
 
-@kindex 046 @kbd{&} (@code{vip-nil})
-@kindex 100 @kbd{@@} (@code{vip-nil})
-@kindex 125 @kbd{U} (@code{vip-nil})
-@kindex 133 @kbd{[} (@code{vip-nil})
-@kindex 135 @kbd{]} (@code{vip-nil})
-@kindex 137 @kbd{_} (@code{vip-nil})
-@kindex 161 @kbd{q} (@code{vip-nil})
-@kindex 176 @kbd{~} (@code{vip-nil})
+@kindex 046 & @r{(}@code{vip-nil}@r{)}
+@kindex 100 @@ @r{(}@code{vip-nil}@r{)}
+@kindex 125 U @r{(}@code{vip-nil}@r{)}
+@kindex 133 [ @r{(}@code{vip-nil}@r{)}
+@kindex 135 ] @r{(}@code{vip-nil}@r{)}
+@kindex 137 _ @r{(}@code{vip-nil}@r{)}
+@kindex 161 q @r{(}@code{vip-nil}@r{)}
+@kindex 176 ~ @r{(}@code{vip-nil}@r{)}
 
 @example
 &, @@, U, [, ], _, q, ~
@@ -1567,48 +1567,48 @@ keymap.  See GNU Emacs Manual for details.
 
 @table @kbd
 @item C-@@
-@kindex 000 @kbd{C-@@} (@code{set-mark-command})
+@kindex 000 C-@@ @r{(}@code{set-mark-command}@r{)}
 Set mark and push previous mark on mark ring (@code{set-mark-command}).
-@item TAB
-@kindex 011 TAB (@code{indent-for-tab-command})
+@item @key{TAB}
+@kindex 011 TAB @r{(}@code{indent-for-tab-command}@r{)}
 Indent line for current major mode (@code{indent-for-tab-command}).
 @item C-j
-@kindex 012 @kbd{C-j} (@code{electric-newline-and-maybe-indent})
+@kindex 012 C-j @r{(}@code{electric-newline-and-maybe-indent}@r{)}
 Insert a newline, and maybe indent according to mode.
 @item C-k
-@kindex 013 @kbd{C-k} (@code{kill-line})
+@kindex 013 C-k @r{(}@code{kill-line}@r{)}
 Kill the rest of the current line; before a newline, kill the newline.
 With a numeric argument, kill that many lines from point.  Negative arguments
 kill lines backward (@code{kill-line}).
 @item C-l
-@kindex 014 @kbd{C-l} (@code{recenter})
+@kindex 014 C-l @r{(}@code{recenter}@r{)}
 Clear the screen and reprint everything (@code{recenter}).
 @item @var{n} C-p
-@kindex 020 @kbd{C-p} (@code{previous-line})
+@kindex 020 C-p @r{(}@code{previous-line}@r{)}
 Move cursor vertically up @var{n} lines (@code{previous-line}).
 @item C-q
-@kindex 021 @kbd{C-q} (@code{quoted-insert})
+@kindex 021 C-q @r{(}@code{quoted-insert}@r{)}
 Read next input character and insert it.  Useful for inserting control
 characters
 @*(@code{quoted-insert}).
 @item C-r
-@kindex 022 @kbd{C-r} (@code{isearch-backward})
+@kindex 022 C-r @r{(}@code{isearch-backward}@r{)}
 Search backward incrementally (@code{isearch-backward}).
 @item C-s
-@kindex 023 @kbd{C-s} (@code{isearch-forward})
+@kindex 023 C-s @r{(}@code{isearch-forward}@r{)}
 Search forward incrementally (@code{isearch-forward}).
 @item @var{n} C-t
-@kindex 024 @kbd{C-t} (@code{transpose-chars})
+@kindex 024 C-t @r{(}@code{transpose-chars}@r{)}
 Interchange characters around point, moving forward one character.  With
 count @var{n}, take character before point and drag it forward past @var{n}
 other characters.  If no argument and at end of line, the previous two
 characters are exchanged (@code{transpose-chars}).
 @item @var{n} C-v
-@kindex 026 @kbd{C-v} (@code{scroll-up})
+@kindex 026 C-v @r{(}@code{scroll-up}@r{)}
 Scroll text upward @var{n} lines.  If @var{n} is not given, scroll near
 full screen (@code{scroll-up}).
 @item C-w
-@kindex 027 @kbd{C-w} (@code{kill-region})
+@kindex 027 C-w @r{(}@code{kill-region}@r{)}
 Kill between point and mark.  The text is save in the kill ring.  The
 command @kbd{P} or @kbd{p} can retrieve it from kill ring
 (@code{kill-region}).
@@ -1624,29 +1624,29 @@ and you can repeat them by the repeat command @kbd{.} (@code{vip-repeat}).
 
 @table @kbd
 @item i
-@kindex 151 @kbd{i} (@code{vip-insert})
+@kindex 151 i @r{(}@code{vip-insert}@r{)}
 Enter insert mode at point (@code{vip-insert}).
 @item I
-@kindex 111 @kbd{I} (@code{vip-Insert})
+@kindex 111 I @r{(}@code{vip-Insert}@r{)}
 Enter insert mode at the first non white character on the line
 (@code{vip-Insert}).
 @item a
-@kindex 141 @kbd{a} (@code{vip-append})
+@kindex 141 a @r{(}@code{vip-append}@r{)}
 Move point forward by one character and then enter insert mode
 (@code{vip-append}).
 @item A
-@kindex 101 @kbd{A} (@code{vip-Append})
+@kindex 101 A @r{(}@code{vip-Append}@r{)}
 Enter insert mode at end of line (@code{vip-Append}).
 @item o
-@kindex 157 @kbd{o} (@code{vip-open-line})
+@kindex 157 o @r{(}@code{vip-open-line}@r{)}
 Open a new line below the current line and enter insert mode
 (@code{vip-open-line}).
 @item O
-@kindex 117 @kbd{O} (@code{vip-Open-line})
+@kindex 117 O @r{(}@code{vip-Open-line}@r{)}
 Open a new line above the current line and enter insert mode
 (@code{vip-Open-line}).
 @item C-o
-@kindex 017 @kbd{C-o} (@code{vip-open-line-at-point})
+@kindex 017 C-o @r{(}@code{vip-open-line-at-point}@r{)}
 Insert a newline and leave point before it, and then enter insert mode
 @*(@code{vip-open-line-at-point}).
 @end table
@@ -1656,16 +1656,16 @@ differently from emacs mode.
 
 @table @kbd
 @item @key{ESC}
-@kindex 033 @kbd{ESC} (@code{vip-change-mode-to-vi}) (insert mode)
+@kindex 033 ESC @r{(}@code{vip-change-mode-to-vi}@r{) (insert mode)}
 This key will take you back to vi mode (@code{vip-change-mode-to-vi}).
 @item C-h
-@kindex 010 @kbd{C-h} (@code{delete-backward-char}) (insert mode)
+@kindex 010 C-h @r{(}@code{delete-backward-char}@r{) (insert mode)}
 Delete previous character (@code{delete-backward-char}).
 @item C-w
-@kindex 027 @kbd{C-w} (@code{vip-delete-backward-word}) (insert mode)
+@kindex 027 C-w @r{(}@code{vip-delete-backward-word}@r{) (insert mode)}
 Delete previous word (@code{vip-delete-backward-word}).
 @item C-z
-@kindex 032 @kbd{C-z} (@code{vip-ESC}) (insert mode)
+@kindex 032 C-z @r{(}@code{vip-ESC}@r{) (insert mode)}
 This key simulates @key{ESC} key in emacs mode.  For instance, typing
 @kbd{C-z x} in insert mode is the same as typing @kbd{ESC x} in emacs mode
 (@code{vip-ESC}).
@@ -1685,7 +1685,7 @@ commands while in insert mode.
 @node Ex Commands
 @chapter Ex Commands
 
-@kindex 072 @kbd{:} (@code{vip-ex})
+@kindex 072 : @r{(}@code{vip-ex}@r{)}
 
 In vi mode, you can execute an Ex command @var{ex-command} by typing:
 @example
diff --git a/doc/misc/viper.texi b/doc/misc/viper.texi
index 8948437632..2b300f6493 100644
--- a/doc/misc/viper.texi
+++ b/doc/misc/viper.texi
@@ -368,9 +368,9 @@ toggles Viperization of Emacs on and off.
 @node States in Viper
 @section States in Viper
 
-@kindex @kbd{C-z}
-@kindex @key{ESC}
-@kindex @kbd{i}
+@kindex C-z
+@kindex ESC
+@kindex i
 @cindex Emacs state
 @cindex Vi state
 @cindex Insert state
@@ -474,7 +474,7 @@ to allow Emacs keys in Insert state.
 @node Emacs State
 @subsection Emacs State
 
-@kindex @kbd{C-z}
+@kindex C-z
 @cindex Emacs state
 
 
@@ -514,7 +514,7 @@ exceptions are:
 
 @table @kbd
 @item C-x
-@kindex @kbd{C-x}
+@kindex C-x
 @kbd{C-x} is used to invoke Emacs commands, mainly those that do window
 management.  @kbd{C-x 2} will split a window, @kbd{C-x 0} will close a
 window.  @kbd{C-x 1} will close all other windows.  @kbd{C-xb} is used to
@@ -523,14 +523,14 @@ These are about the only necessary keystrokes.
 For the rest, see the GNU Emacs Manual.
 
 @item C-c
-@kindex @kbd{C-c}
+@kindex C-c
 For user levels 2 and higher, this key serves as a prefix key for the key
 sequences used by various major modes.  For users at Viper level 1, @kbd{C-c}
 simply beeps.
 
 @item C-g and C-]
-@kindex @kbd{C-g}
-@kindex @kbd{C-]}
+@kindex C-g
+@kindex C-]
 
 These are the Emacs @samp{quit} keys.
 There will be cases where you will have to
@@ -543,7 +543,7 @@ Edit,Recursive Edit,emacs,The GNU Emacs Manual}.
 At user level 1, @kbd{C-g} is bound to @code{viper-info-on-file}
 function instead.
 @item C-\
-@kindex @kbd{C-\}
+@kindex C-\
 @cindex Meta key
 
 Viper uses @key{ESC} as a switch between Insert and Vi states.  Emacs uses
@@ -569,7 +569,7 @@ about are:
 
 @table @samp
 @item Undo
-@kindex @kbd{u}
+@kindex u
 @kbd{u} will undo.  Undo can be repeated by the @kbd{.} key.  Undo itself
 can be undone.  Another @kbd{u} will change the direction.  The presence
 of repeatable undo means that @kbd{U}, undoing lines, is not very
@@ -599,7 +599,7 @@ to case-insensitive and back.
 @cindex vanilla search
 @cindex case-sensitive search
 @cindex case-insensitive search
-@kindex @kbd{C-c /}
+@kindex C-c /
 
 @item Ex commands
 @cindex Ex commands
@@ -1083,7 +1083,7 @@ remembered (This is called ``learn mode'' in some editors.)
 where @samp{register} is any character from @samp{a} through @samp{z}.  Then
 you can execute this macro using @kbd{@@register}.  It is, of course,
 possible to yank some text into a register and execute it using
-@kbd{@@register}.  Typing @kbd{@@@@}, @kbd{@@RET}, or @kbd{@@C-j} will
+@kbd{@@register}.  Typing @kbd{@@@@}, @kbd{@@@key{RET}}, or @kbd{@@C-j} will
 execute the last macro that was executed using @kbd{@@register}.
 
 Viper will automatically lowercase the register, so that pressing the
@@ -1302,8 +1302,8 @@ These commands have no Vi analogs.
 
 @table @kbd
 @item C-x, C-c
-@kindex @kbd{C-x}
-@kindex @kbd{C-c}
+@kindex C-x
+@kindex C-c
 These two keys invoke many important Emacs functions.  For example, if you
 hit @kbd{C-x} followed by @kbd{2}, then the current window will be split
 into 2.  Except for novice users, @kbd{C-c} is also set to execute an Emacs
@@ -1313,11 +1313,11 @@ configure @key{ESC} as Meta by setting @code{viper-no-multiple-ESC} to
 @kbd{C-\} in Insert, Replace, or Vi states will make Emacs think
 @kbd{Meta} has been hit.
 @item \
-@kindex @kbd{\}
+@kindex \
 Escape to Emacs to execute a single Emacs command.  For instance,
 @kbd{\ @key{ESC}} will act like a Meta key.
 @item Q
-@kindex @kbd{Q}
+@kindex Q
 @cindex query replace
 @kbd{Q} is for query replace.  By default,
 each string to be replaced is treated as a regular expression.  You can use
@@ -1327,16 +1327,16 @@ that @kbd{:se nomagic} turns Regexps off completely, unlike Vi).
 @item v
 @itemx V
 @itemx C-v
-@kindex @kbd{v}
-@kindex @kbd{V}
-@kindex @kbd{C-v}
+@kindex v
+@kindex V
+@kindex C-v
 These keys are used to visit files.  @kbd{v} will switch to a buffer
 visiting file whose name can be entered in the minibuffer.  @kbd{V} is
 similar, but will use a window different from the current window.
 @kbd{C-v} is like @kbd{V}, except that a new frame (X window) will be used
 instead of a new Emacs window.
 @item #
-@kindex @kbd{#}
+@kindex #
 If followed by a certain character @var{ch}, it becomes an operator whose
 argument is the region determined by the motion command that follows
 (indicated as <move>).
@@ -1344,34 +1344,34 @@ Currently, @var{ch} can be one of @kbd{c}, @kbd{C}, @kbd{g}, @kbd{q}, and
 @kbd{s}.  For instance, @kbd{#qr} will prompt you for a string and then
 prepend this string to each line in the buffer.
 @item # c
-@kindex @kbd{#c<move>}
+@kindex #c<move>
 @cindex changing case
 Change upper-case characters in the region to lower-case
 (@code{downcase-region}).
 Emacs command @kbd{M-l} does the same for words.
 @item # C
-@kindex @kbd{#C<move>}
+@kindex #C<move>
 Change lower-case characters in the region to upper-case.  For instance,
 @kbd{# C 3 w} will capitalize 3 words from the current point
 (@code{upcase-region}).
 Emacs command @kbd{M-u} does the same for words.
 @item # g
-@kindex @kbd{#g<move>}
+@kindex #g<move>
 Execute last keyboard macro for each line in the region
 (@code{viper-global-execute}).
 @item # q
-@kindex @kbd{#q<move>}
+@kindex #q<move>
 Insert specified string at the beginning of each line in the region
 (@code{viper-quote-region}).  The default string is composed of the comment
 character(s) appropriate for the current major mode.
 @item # s
-@kindex @kbd{#s<move>}
+@kindex #s<move>
 Check spelling of words in the region (@code{spell-region}).
 The function used for spelling is determined from the variable
 @code{viper-spell-function}.
 @vindex viper-spell-function
 @item *
-@kindex @kbd{*}
+@kindex *
 Call last keyboard macro.
 @item m .
 Set mark at point and push old mark off the ring
@@ -1382,41 +1382,41 @@ Set mark at beginning and end of buffer, respectively.
 Jump to mark and pop mark off the ring.  @xref{Mark,,Mark,emacs,The GNU
 Emacs Manual}, for more info.
 @item ] register
-@kindex @kbd{]<a-z>}
+@kindex ]<a-z>
 View contents of register
 @item [ textmarker
-@kindex @kbd{[<a-z>}
+@kindex [<a-z>
 View filename and position of textmarker
 @item @@#
 @item @@register
 @item @@!
-@kindex @kbd{@@#}
-@kindex @kbd{@@<a-z>}
-@kindex @kbd{@@!}
+@kindex @@#
+@kindex @@<a-z>
+@kindex @@!
 @cindex keyboard macros
 @cindex register execution
 
 Begin/end keyboard macro.  @@register has a different meaning when used after
 a @kbd{@@#}.  @xref{Macros and Registers}, for details
 @item []
-@kindex @kbd{[]}
+@kindex []
 Go to end of heading.
 @item g <@emph{movement command}>
 Search buffer for text delimited by movement command.  The canonical
 example is @kbd{gw} to search for the word under the cursor.
 @xref{Improved Search}, for details.
 @item C-g and C-]
-@kindex @kbd{C-g}
-@kindex @kbd{C-]}
+@kindex C-g
+@kindex C-]
 Quit and Abort Recursive edit.  These may be necessary on occasion.
 @xref{Vi State}, for a reason.
 @item C-c C-g
-@kindex @kbd{C-c C-g}
+@kindex C-c C-g
 Hitting @kbd{C-c} followed by @kbd{C-g} will display the information on the
 current buffer.  This is the same as hitting @kbd{C-g} in Vi, but, as
 explained above, @kbd{C-g} is needed for other purposes in Emacs.
 @item C-c /
-@kindex @kbd{C-c /}
+@kindex C-c /
 Without a prefix argument, this command toggles
 case-sensitive/case-insensitive search modes and plain vanilla/regular
 expression search.  With the prefix argument 1, i.e.,
@@ -1429,21 +1429,21 @@ this function.
 @cindex case-insensitive search
 
 @item M-p and M-n
-@kindex @kbd{M-p}
-@kindex @kbd{M-n}
+@kindex M-p
+@kindex M-n
 In the minibuffer, these commands navigate through the minibuffer
 histories, such as the history of search strings, Ex commands, etc.
 
 @item C-s
-@kindex @kbd{C-s}
+@kindex C-s
 If the minibuffer is entered via a Viper search commands @kbd{/} or @kbd{?},
 then typing this key inserts the last search string used by the
 Emacs incremental search command (that is bound to @kbd{C-s} everywhere
 except in this case).
 
 @item C-c M-p and C-c M-n
-@kindex @kbd{C-c M-p}
-@kindex @kbd{C-c M-n}
+@kindex C-c M-p
+@kindex C-c M-n
 @cindex Insertion history
 @cindex Insertion ring
 @cindex Command history
@@ -2669,10 +2669,10 @@ purpose of mouse search and mouse insert.  By default, this is set to
 @code{double-click-time} in Emacs and to
 @code{mouse-track-multi-click-time} milliseconds in XEmacs.
 @end table
-@kindex @kbd{S-mouse-1}
-@kindex @kbd{S-mouse-2}
-@kindex @kbd{meta shift button1up}
-@kindex @kbd{meta shift button2up}
+@kindex S-mouse-1
+@kindex S-mouse-2
+@kindex META SHIFT button1up
+@kindex META SHIFT button2up
 @vindex viper-multiclick-timeout
 @findex viper-mouse-click-insert-word
 @findex viper-mouse-click-search-word
@@ -3383,60 +3383,60 @@ don't want this macro, put
 in your Viper customization file.
 
 @end table
-@kindex @kbd{%}
-@kindex @kbd{C-c /}
-@kindex @kbd{N}
-@kindex @kbd{n}
-@kindex @kbd{?<cr>}
-@kindex @kbd{/<cr>}
-@kindex @kbd{?<string>}
-@kindex @kbd{/<string>}
-@kindex @kbd{''}
-@kindex @kbd{``}
-@kindex @kbd{]<a-z>}
-@kindex @kbd{[<a-z>}
-@kindex @kbd{'<a-z>}
-@kindex @kbd{`<a-z>}
-@kindex @kbd{m<a-z>}
-@kindex @kbd{[]}
-@kindex @kbd{[[}
-@kindex @kbd{]]}
-@kindex @kbd{@{}
-@kindex @kbd{@}}
-@kindex @kbd{(}
-@kindex @kbd{)}
-@kindex @kbd{M}
-@kindex @kbd{L}
-@kindex @kbd{H}
-@kindex @kbd{G}
-@kindex @kbd{E}
-@kindex @kbd{e}
-@kindex @kbd{B}
-@kindex @kbd{b}
-@kindex @kbd{W}
-@kindex @kbd{w}
-@kindex @kbd{,}
-@kindex @kbd{;}
-@kindex @kbd{T<char>}
-@kindex @kbd{F<char>}
-@kindex @kbd{t<char>}
-@kindex @kbd{f<char>}
-@kindex @kbd{|}
-@kindex @kbd{0}
-@kindex @kbd{<cr>}
-@kindex @kbd{+}
-@kindex @kbd{-}
-@kindex @kbd{^}
-@kindex @kbd{$}
-@kindex @kbd{C-p}
-@kindex @kbd{<lf>}
-@kindex @kbd{<sp>}
-@kindex @kbd{C-n}
-@kindex @kbd{C-h}
-@kindex @kbd{h}
-@kindex @kbd{j}
-@kindex @kbd{k}
-@kindex @kbd{l}
+@kindex %
+@kindex C-c /
+@kindex N
+@kindex n
+@kindex ?<cr>
+@kindex /<cr>
+@kindex ?<string>
+@kindex /<string>
+@kindex ''
+@kindex ``
+@kindex ]<a-z>
+@kindex [<a-z>
+@kindex '<a-z>
+@kindex `<a-z>
+@kindex m<a-z>
+@kindex []
+@kindex [[
+@kindex ]]
+@kindex @{
+@kindex @}
+@kindex (
+@kindex )
+@kindex M
+@kindex L
+@kindex H
+@kindex G
+@kindex E
+@kindex e
+@kindex B
+@kindex b
+@kindex W
+@kindex w
+@kindex ,
+@kindex ;
+@kindex T<char>
+@kindex F<char>
+@kindex t<char>
+@kindex f<char>
+@kindex |
+@kindex 0
+@kindex CR
+@kindex +
+@kindex -
+@kindex ^
+@kindex $
+@kindex C-p
+@kindex LF
+@kindex SPC
+@kindex C-n
+@kindex C-h
+@kindex h
+@kindex j
+@kindex k
+@kindex l
 @vindex viper-parse-sexp-ignore-comments
 
 @node Marking
@@ -3478,18 +3478,18 @@ Go to specified Viper mark.
 @item `<a-z>
 Go to specified Viper mark and go to the first CHAR on line.
 @end table
-@kindex @kbd{m<a-z>}
-@kindex @kbd{m.}
-@kindex @kbd{m>}
-@kindex @kbd{m<}
-@kindex @kbd{m,}
-@kindex @kbd{m^}
+@kindex m<a-z>
+@kindex m.
+@kindex m>
+@kindex m<
+@kindex m,
+@kindex m^
 @findex @kbd{Ex mark}
 @findex @kbd{Ex k}
-@kindex @kbd{''}
-@kindex @kbd{``}
-@kindex @kbd{`<a-z>}
-@kindex @kbd{'<a-z>}
+@kindex ''
+@kindex ``
+@kindex `<a-z>
+@kindex '<a-z>
 
 @node  Appending Text
 @subsection Appending Text
@@ -3556,22 +3556,22 @@ Since typing the above sequences of keys may be tedious, the
 functions doing the perusing can be bound to unused keyboard keys in the
 Viper customization file.  @xref{Viper Specials}, for details.
 @end table
-@kindex @kbd{C-c M-p}
-@kindex @kbd{C-c M-n}
-@kindex @kbd{.}
-@kindex @kbd{]<a-z>}
-@kindex @kbd{[<a-z>}
-@kindex @kbd{P}
-@kindex @kbd{p}
-@kindex @kbd{"<a-z1-9>p}
-@kindex @kbd{"<a-z1-9>P}
-@kindex @kbd{>>}
-@kindex @kbd{><move>}
-@kindex @kbd{O}
-@kindex @kbd{o}
-@kindex @kbd{i}
-@kindex @kbd{A}
-@kindex @kbd{a}
+@kindex C-c M-p
+@kindex C-c M-n
+@kindex .
+@kindex ]<a-z>
+@kindex [<a-z>
+@kindex P
+@kindex p
+@kindex "<a-z1-9>p
+@kindex "<a-z1-9>P
+@kindex >>
+@kindex ><move>
+@kindex O
+@kindex o
+@kindex i
+@kindex A
+@kindex a
 
 @node Editing in Insert State
 @subsection Editing in Insert State
@@ -3595,9 +3595,9 @@ Back to the begin of the change on the
 current line.
 
 @end table
-@kindex @kbd{C-u}
-@kindex @kbd{C-w}
-@kindex @kbd{C-v}
+@kindex C-u
+@kindex C-w
+@kindex C-v
 
 @node Deleting Text
 @subsection Deleting Text
@@ -3634,13 +3634,13 @@ shiftwidth to the left (layout!).
 @item <count>  <<
 Shift <count> lines one shiftwidth to the left.
 @end table
-@kindex @kbd{<<}
-@kindex @kbd{<<move>}
-@kindex @kbd{D}
-@kindex @kbd{dd}
-@kindex @kbd{d<move>}
-@kindex @kbd{X}
-@kindex @kbd{x}
+@kindex <<
+@kindex <<move>
+@kindex D
+@kindex dd
+@kindex d<move>
+@kindex X
+@kindex x
 
 @node Changing Text
 @subsection Changing Text
@@ -3727,28 +3727,28 @@ In Vi state, these keys are bound to functions that peruse the history of
 destructive Vi commands.
 @xref{Viper Specials}, for details.
 @end table
-@kindex @kbd{C-c M-p}
-@kindex @kbd{C-c M-n}
-@kindex @kbd{#q<move> }
-@kindex @kbd{#C<move>}
-@kindex @kbd{#c<move>}
-@kindex @kbd{&}
-@kindex @kbd{\&}
+@kindex C-c M-p
+@kindex C-c M-n
+@kindex #q<move>
+@kindex #C<move>
+@kindex #c<move>
+@kindex &
+@kindex \&
 @findex @kbd{Ex substitute/<pat>/<repl>/<f>}
 @findex @kbd{Ex s/<pat>/<repl>/<f>}
 @findex @kbd{Ex copy [z]}
 @findex @kbd{Ex t [z]}
 @findex @kbd{Ex move [z]}
-@kindex @kbd{J}
-@kindex @kbd{~}
-@kindex @kbd{=<move>}
-@kindex @kbd{C}
-@kindex @kbd{cc}
-@kindex @kbd{c<move>}
-@kindex @kbd{S}
-@kindex @kbd{s}
-@kindex @kbd{R}
-@kindex @kbd{r<char>}
+@kindex J
+@kindex ~
+@kindex =<move>
+@kindex C
+@kindex cc
+@kindex c<move>
+@kindex S
+@kindex s
+@kindex R
+@kindex r<char>
 
 @node Search and Replace
 @subsection Search and Replace
@@ -3817,21 +3817,21 @@ Execute <ex-command> on all lines that match <pattern>.
 @itemx :v /<pattern>/<ex-command>
 Execute <ex-command> on all lines that do not match <pattern>.
 @end table
-@kindex @kbd{&}
+@kindex &
 @findex @kbd{Ex substitute/<pat>/<repl>/<f>}
-@kindex @kbd{Q}
-@kindex @kbd{#g<move>}
+@kindex Q
+@kindex #g<move>
 @findex @kbd{Ex v}
 @findex @kbd{Ex g}
 @findex @kbd{Ex global}
 @findex @kbd{Ex vglobal}
 @findex @kbd{Ex tag <name>}
-@kindex @kbd{%}
-@kindex @kbd{N}
-@kindex @kbd{n}
-@kindex @kbd{g<move>}
-@kindex @kbd{?<string>}
-@kindex @kbd{/<string>}
+@kindex %
+@kindex N
+@kindex n
+@kindex g<move>
+@kindex ?<string>
+@kindex /<string>
 
 @node Yanking
 @subsection Yanking
@@ -3865,19 +3865,19 @@ be automatically down-cased.
 Put the contents of the (default undo) buffer
 <count> times before the cursor.  The register will
 @end table
-@kindex @kbd{P}
-@kindex @kbd{p}
-@kindex @kbd{"<a-z1-9>p}
-@kindex @kbd{"<a-z1-9>P}
-@kindex @kbd{]<a-z>}
-@kindex @kbd{[<a-z>}
-@kindex @kbd{m<a-z>}
-@kindex @kbd{Y}
-@kindex @kbd{yy}
-@kindex @kbd{"<A-Z>y<move>}
-@kindex @kbd{"<a-z>y<move>}
-@kindex @kbd{y<move>}
-@kindex @kbd{yank}
+@kindex P
+@kindex p
+@kindex "<a-z1-9>p
+@kindex "<a-z1-9>P
+@kindex ]<a-z>
+@kindex [<a-z>
+@kindex m<a-z>
+@kindex Y
+@kindex yy
+@kindex "<A-Z>y<move>
+@kindex "<a-z>y<move>
+@kindex y<move>
+@kindex yank
 @findex @kbd{Ex yank}
 
 @node Undoing
@@ -3902,9 +3902,9 @@ that have a @samp{~} appended to them.
 @findex @kbd{Ex rec}
 @findex @kbd{Ex e!}
 @findex @kbd{Ex q!}
-@kindex @kbd{.}
-@kindex @kbd{U}
-@kindex @kbd{u}
+@kindex .
+@kindex U
+@kindex u
 
 @node Display
 @section Display
@@ -3948,21 +3948,21 @@ Put line <count> at the bottom of the window
 Put line <count> in the center of the window
 (default the current line).
 @end table
-@kindex @kbd{zM}
-@kindex @kbd{zL}
-@kindex @kbd{zH}
-@kindex @kbd{z<cr>}
-@kindex @kbd{z.}
-@kindex @kbd{z-}
-@kindex @kbd{z<cr>}
-@kindex @kbd{C-b}
-@kindex @kbd{C-f}
-@kindex @kbd{C-u}
-@kindex @kbd{C-d}
-@kindex @kbd{C-y}
-@kindex @kbd{C-e}
-@kindex @kbd{C-l}
-@kindex @kbd{C-g}
+@kindex zM
+@kindex zL
+@kindex zH
+@kindex z<cr>
+@kindex z.
+@kindex z-
+@kindex z<cr>
+@kindex C-b
+@kindex C-f
+@kindex C-u
+@kindex C-d
+@kindex C-y
+@kindex C-e
+@kindex C-l
+@kindex C-g
 
 
 @node File and Buffer Handling
@@ -4078,11 +4078,11 @@ Read the file <name> into the buffer after the line <address>.
 Edit a file in current or another window, or in another frame.  File name
 is typed in minibuffer.  File completion and history are supported.
 @end table
-@kindex @kbd{v}
-@kindex @kbd{V}
+@kindex v
+@kindex V
 @findex @kbd{Ex args}
 @findex @kbd{Ex rew}
-@kindex @kbd{C-^}
+@kindex C-^
 @findex @kbd{Ex e!@: [<files>]}
 @findex @kbd{Ex e [<files>]}
 @findex @kbd{Ex edit [<files>]}
@@ -4096,7 +4096,7 @@ is typed in minibuffer.  File completion and history are supported.
 @findex @kbd{Ex r}
 @findex @kbd{Ex read}
 @findex @kbd{Ex pre}
-@kindex @kbd{ZZ}
+@kindex ZZ
 @findex @kbd{Ex wq}
 @findex @kbd{Ex w <file>}
 @findex @kbd{Ex w!@: <file>}
@@ -4171,14 +4171,14 @@ Show contents of textmarker.
 @item ]<a-z>
 Show contents of register.
 @end table
-@kindex @kbd{]<a-z>}
-@kindex @kbd{[<a-z>}
-@kindex @kbd{#g<move>}
-@kindex @kbd{*}
-@kindex @kbd{@@!<a-z>}
-@kindex @kbd{@@#}
-@kindex @kbd{@@@@}
-@kindex @kbd{@@<a-z>}
+@kindex ]<a-z>
+@kindex [<a-z>
+@kindex #g<move>
+@kindex *
+@kindex @@!<a-z>
+@kindex @@#
+@kindex @@@@
+@kindex @@<a-z>
 @findex @kbd{Ex unmap <char>}
 @findex @kbd{Ex map <char> <seq>}
 @findex @kbd{Ex unmap!@: <char>}
@@ -4410,16 +4410,16 @@ Undoes the last @kbd{C-y} and puts another kill from the kill ring.
 Using this command, you can try may different kills until you find the one
 you need.
 @end table
-@kindex @kbd{M-y}
-@kindex @kbd{C-y}
-@kindex @kbd{C-xC-f}
-@kindex @kbd{C-xo}
-@kindex @kbd{C-x2}
-@kindex @kbd{C-x1}
-@kindex @kbd{C-x0}
-@kindex @kbd{C-z}
-@kindex @kbd{C-\}
-@kindex @kbd{C-c\}
+@kindex M-y
+@kindex C-y
+@kindex C-x C-f
+@kindex C-x o
+@kindex C-x 2
+@kindex C-x 1
+@kindex C-x 0
+@kindex C-z
+@kindex C-\
+@kindex C-c\
 
 @node Mouse-bound Commands
 @section Mouse-bound Commands
@@ -4445,10 +4445,10 @@ Note: Viper sets this binding only if this mouse action is not
 already bound to something else.
 @xref{Viper Specials}, for more details.
 @end table
-@kindex @kbd{S-mouse-1}
-@kindex @kbd{S-mouse-2}
-@kindex @kbd{meta button1up}
-@kindex @kbd{meta button2up}
+@kindex S-mouse-1
+@kindex S-mouse-2
+@kindex META button1up
+@kindex META button2up
 
 @node GNU Free Documentation License
 @appendix GNU Free Documentation License
diff --git a/etc/NEWS b/etc/NEWS
index 0eb589f45d..9661bc0913 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -83,6 +83,15 @@ Customize the option 'mode-line-default-help-echo' to restore the old
 behavior where the tooltip text is also shown when the corresponding
 action does not apply.
 
++++
+** New hook 'server-after-make-frame-hook'.
+This hook is a convenient place to perform initializations in daemon
+mode which require GUI features to be available.  One example is
+restoration of the previous session using the desktop.el package: put
+the call to 'desktop-read' in this hook, if you want the GUI settings
+to be restored, or if desktop.el needs to interact with you during
+restoration of the session.
+
 +++
 ** New function 'logcount' calculates an integer's Hamming weight.
 
@@ -142,6 +151,16 @@ This can be controlled by the new `ecomplete-sort-predicate' variable.
 *** The 'ecompleterc' file is now placed in ~/.emacs.d/ecompleterc by default
 Of course it will still find it if you have it in ~/.ecompleterc
 
+** Gnus
+*** The function 'gnus-score-find-favorite-words' has been renamed
+from 'gnus-score-find-favourite-words'.
+
+** Htmlfontify
+*** The functions 'hfy-color', 'hfy-color-vals' and
+'hfy-fallback-color-values' and the variables 'hfy-fallback-color-map'
+and 'hfy-rgb-txt-color-map' have been renamed from names that used
+'colour' instead of 'color'.
+
 ** Smtpmail
 Authentication mechanisms can be added via external packages, by
 defining new cl-defmethod of smtpmail-try-auth-method.
@@ -180,6 +199,14 @@ created by 'edit-last-kbd-macro', and to save the macro by 'C-c C-c'.
 ---
 *** New filter ibuffer-filter-by-process; bound to '/E'.
 
+** Search and Replace
+
+*** 'search-exit-option' provides new options 'move' and 'shift-move'
+to extend the search string by yanking text that ends at the new
+position after moving point in the current buffer.  'shift-move'
+extends the search string by motion commands while holding down
+the shift key.
+
 ** Edebug
 
 +++
@@ -201,8 +228,10 @@ by default.
 
 *** rgrep, lgrep and zrgrep now hide part of the command line
 that contains a list of ignored directories and files.
-Clicking on the button with ellipsis unhides the truncated part.
-This truncation can be disabled by the new option 'grep-find-hide'.
+Clicking on the button with ellipsis unhides it.
+The abbreviation can be disabled by the new option
+'grep-find-abbreviate'.  The new command
+'grep-find-toggle-abbreviation' toggles it interactively.
 
 ** ERT
 
@@ -241,12 +270,23 @@ To restore the old behavior, use
     (add-hook 'eshell-expand-input-functions
               #'eshell-expand-history-references)
 
+*** The function 'shell-uniquify-list' has been renamed from
+'eshell-uniqify-list'.
+
+** Pcomplete
+*** The function 'pcomplete-uniquify-list' has been renamed from
+'pcomplete-uniqify-list'.
+
 ** Tramp
 
 +++
 *** New connection method "owncloud", which allows to access OwnCloud
 or NextCloud hosted files and directories.
 
+---
+** The options.el library has been removed.
+It was obsolete since Emacs 22.1, replaced by customize.
+
 
 * New Modes and Packages in Emacs 27.1
 
@@ -277,6 +317,46 @@ as new-style, bind the new variable 'force-new-style-backquotes' to t.
 'cl-struct-define' whose name clashes with a builtin type (e.g.,
 'integer' or 'hash-table') now signals an error.
 
+** When formatting a floating-point number as an octal or hexadecimal
+integer, Emacs now signals an error if the number is too large for the
+implementation to format (Bug#30408).
+
+---
+** Some functions and variables obsolete since Emacs 22 have been removed:
+archive-mouse-extract, assoc-ignore-case, assoc-ignore-representation,
+backward-text-line, blink-cursor, bookmark-exit-hooks,
+comint-use-prompt-regexp-instead-of-fields, compilation-finish-function,
+count-text-lines, cperl-vc-header-alist, custom-face-save-command,
+cvs-display-full-path, cvs-fileinfo->full-path, delete-frame-hook,
+derived-mode-class, describe-char-after, describe-project,
+desktop-basefilename, desktop-buffer-handlers,
+desktop-buffer-misc-functions, desktop-buffer-modes-to-save,
+desktop-enable, desktop-load-default, dired-omit-files-p,
+disabled-command-hook, dungeon-mode-map, electric-nroff-mode,
+electric-nroff-newline, electric-perl-terminator, focus-frame,
+forward-text-line, generic-define-mswindows-modes, generic-define-unix-modes,
+generic-font-lock-defaults, goto-address-at-mouse,
+highlight-changes-colours, ibuffer-elide-long-columns, ibuffer-hooks,
+ibuffer-mode-hooks, icalendar-convert-diary-to-ical,
+icalendar-extract-ical-from-buffer, imenu-always-use-completion-buffer-p,
+ipconfig-program, ipconfig-program-options, isearch-lazy-highlight-cleanup,
+isearch-lazy-highlight-cleanup, isearch-lazy-highlight-initial-delay,
+isearch-lazy-highlight-interval, isearch-lazy-highlight-max-at-a-time,
+iswitchb-use-fonts, latin1-char-displayable-p, mouse-wheel-click-button,
+mouse-wheel-down-button, mouse-wheel-up-button, new-frame, pascal-outline,
+process-kill-without-query, recentf-menu-append-commands-p,
+rmail-pop-password, rmail-pop-password-required, savehist-load,
+set-default-font, spam-list-of-processors,
+speedbar-add-ignored-path-regexp, speedbar-buffers-line-path,
+speedbar-buffers-line-path, speedbar-ignored-path-expressions,
+speedbar-ignored-path-regexp, speedbar-line-path, speedbar-path-line,
+timer-set-time-with-usecs, tooltip-gud-display, tooltip-gud-modes,
+tooltip-gud-toggle-dereference, unfocus-frame, unload-hook-features-list,
+update-autoloads-from-directories, vc-comment-ring, vc-comment-ring-index,
+vc-comment-search-forward, vc-comment-search-reverse, vc-comment-to-change-log,
+vc-diff-switches-list, vc-next-comment, vc-previous-comment, view-todo,
+x-lost-selection-hooks, x-sent-selection-hooks
+
 
 * Lisp Changes in Emacs 27.1
 
@@ -318,6 +398,9 @@ remote systems, which support this check.
 If the optional third argument is non-nil, 'make-string' will produce
 a multibyte string even if its second argument is an ASCII character.
 
+** (format "%d" X) no longer mishandles a floating-point number X that
+does not fit in a machine integer (Bug#30408).
+
 ** New JSON parsing and serialization functions 'json-serialize',
 'json-insert', 'json-parse-string', and 'json-parse-buffer'.  These
 are implemented in C using the Jansson library.
diff --git a/etc/NEWS.26 b/etc/NEWS.26
index a8880d0f32..eded00e655 100644
--- a/etc/NEWS.26
+++ b/etc/NEWS.26
@@ -431,9 +431,9 @@ always restricting the margin to a quarter of the window.
 
 +++
 ** Emacs can scroll horizontally using mouse, touchpad, and trackbar.
-You can enable this by customizing 'mwheel-tilt-scroll-p'.  If you
+You can enable this by customizing 'mouse-wheel-tilt-scroll'.  If you
 want to reverse the direction of the scroll, customize
-'mwheel-flip-direction'.
+'mouse-wheel-flip-direction'.
 
 +++
 ** The default GnuTLS priority string now includes %DUMBFW.
@@ -1219,7 +1219,7 @@ backend", which has been updated to benefit from the new UI features.
 ** Term
 
 ---
-*** `term-char-mode' now makes its buffer read-only.
+*** 'term-char-mode' now makes its buffer read-only.
 
 The buffer is made read-only to prevent changes from being made by
 anything other than the process filter; and movements of point away
@@ -1228,8 +1228,8 @@ correct position after each command.  This is needed to avoid states
 which are inconsistent with the state of the terminal understood by
 the inferior process.
 
-New user options `term-char-mode-buffer-read-only' and
-`term-char-mode-point-at-process-mark' control these behaviors, and
+New user options 'term-char-mode-buffer-read-only' and
+'term-char-mode-point-at-process-mark' control these behaviors, and
 are non-nil by default.  Customize these options to nil if you want
 the previous behavior.
 
@@ -1746,6 +1746,10 @@ instead of 0.8, to avoid rounding glitches.
 when a symbol's value is changed.  This is used to implement the new
 debugger command 'debug-on-variable-change'.
 
++++
+** New variable 'print-escape-control-characters' causes 'prin1' and
+'print' to output control characters as backslash sequences.
+
 +++
 ** Time conversion functions that accept a time zone rule argument now
 allow it to be OFFSET or a list (OFFSET ABBR), where the integer
diff --git a/etc/ORG-NEWS b/etc/ORG-NEWS
index 12eab44f0f..b9f3b0cdbe 100644
--- a/etc/ORG-NEWS
+++ b/etc/ORG-NEWS
@@ -1358,7 +1358,7 @@ don't have to be distinct on a heading.
 
 Grouptags had to previously be defined with { }.  This syntax is
 already used for exclusive tags and Grouptags need their own,
-non-exclusive syntax.  This behaviour is achieved with [ ].  Note: { }
+non-exclusive syntax.  This behavior is achieved with [ ].  Note: { }
 can still be used also for Grouptags but then only one of the given
 tags can be used on the headline at the same time.  Example:
 
@@ -1422,9 +1422,9 @@ Check the documentation for more details.
 
 Thanks to Jarmo Hurri for this feature.
 
-*** New behaviour for ~org-toggle-latex-fragment~
+*** New behavior for ~org-toggle-latex-fragment~
 
-The new behaviour is the following:
+The new behavior is the following:
 
 - With a double prefix argument or with a single prefix argument when
   point is before the first headline, toggle overlays in the whole
@@ -1623,10 +1623,10 @@ leading spaces within table cells.
 Org uses the MathJax CDN by default.  See the manual and the docstring
 of ~org-html-mathjax-options~ for details.
 
-*** New behaviour in `org-export-options-alist'
+*** New behavior in `org-export-options-alist'
 
 When defining a back-end, it is now possible to specify to give
-`parse' behaviour on a keyword.  It is equivalent to call
+`parse' behavior on a keyword.  It is equivalent to call
 `org-element-parse-secondary-string' on the value.
 
 However, parsed =KEYWORD= is automatically associated to an
@@ -1745,7 +1745,7 @@ everywhere in the buffer, possibly corrupting URLs.
 *** Removed option =org-babel-sh-command=
 
 This undocumented option defaulted to the value of =shell-file-name= at
-the time of loading =ob-shell=.  The new behaviour is to use the value
+the time of loading =ob-shell=.  The new behavior is to use the value
 of =shell-file-name= directly when the shell langage is =shell=.  To chose
 a different shell, either customize =shell-file-name= or bind this
 variable locally.
diff --git a/etc/TODO b/etc/TODO
index a6ab8787f7..de579746ac 100644
--- a/etc/TODO
+++ b/etc/TODO
@@ -216,7 +216,6 @@ Change them to use report-emacs-bug.
 **** lm-report-bug
 **** tramp-bug
 **** c-submit-bug-report
-**** ffap-bug and ffap-submit-bug (obsoleted)
 [Do all of them need changing?]
 
 ** Allow fringe indicators to display a tooltip (provide a help-echo property?)
diff --git a/lib-src/make-docfile.c b/lib-src/make-docfile.c
index f115748f30..a3c2801cad 100644
--- a/lib-src/make-docfile.c
+++ b/lib-src/make-docfile.c
@@ -43,6 +43,7 @@ along with GNU Emacs.  If not, see <https://www.gnu.org/licenses/>.  */
 #include <string.h>
 
 #include <binary-io.h>
+#include <c-ctype.h>
 #include <intprops.h>
 #include <min-max.h>
 #include <unlocked-io.h>
@@ -347,7 +348,7 @@ scan_keyword_or_put_char (char ch, struct rcsoc_state *state)
 	  state->pending_newlines = 2;
 	  state->pending_spaces = 0;
 
-	  /* Skip any whitespace between the keyword and the
+	  /* Skip any spaces and newlines between the keyword and the
 	     usage string.  */
 	  int c;
 	  do
@@ -367,6 +368,7 @@ scan_keyword_or_put_char (char ch, struct rcsoc_state *state)
 		fatal ("Unexpected EOF after keyword");
 	    }
 	  while (c != ' ' && c != ')');
+
 	  put_char ('f', state);
 	  put_char ('n', state);
 
@@ -421,7 +423,7 @@ read_c_string_or_comment (FILE *infile, int printflag, bool comment,
 
   c = getc (infile);
   if (comment)
-    while (c == '\n' || c == '\r' || c == '\t' || c == ' ')
+    while (c_isspace (c))
       c = getc (infile);
 
   while (c != EOF)
@@ -431,15 +433,14 @@ read_c_string_or_comment (FILE *infile, int printflag, bool comment,
 	  if (c == '\\')
 	    {
 	      c = getc (infile);
-	      if (c == '\n' || c == '\r')
+	      switch (c)
 		{
+		case '\n': case '\r':
 		  c = getc (infile);
 		  continue;
+		case 'n': c = '\n'; break;
+		case 't': c = '\t'; break;
 		}
-	      if (c == 'n')
-		c = '\n';
-	      if (c == 't')
-		c = '\t';
 	    }
 
 	  if (c == ' ')
@@ -510,10 +511,7 @@ write_c_args (char *func, char *buf, int minargs, int maxargs)
       char c = *p;
 
       /* Notice when a new identifier starts.  */
-      if ((('A' <= c && c <= 'Z')
-	   || ('a' <= c && c <= 'z')
-	   || ('0' <= c && c <= '9')
-	   || c == '_')
+      if ((c_isalnum (c) || c == '_')
 	  != in_ident)
 	{
 	  if (!in_ident)
@@ -556,11 +554,8 @@ write_c_args (char *func, char *buf, int minargs, int maxargs)
 	  else
 	    while (ident_length-- > 0)
 	      {
-		c = *ident_start++;
-		if (c >= 'a' && c <= 'z')
-		  /* Upcase the letter.  */
-		  c += 'A' - 'a';
-		else if (c == '_')
+		c = c_toupper (*ident_start++);
+		if (c == '_')
 		  /* Print underscore as hyphen.  */
 		  c = '-';
 		putchar (c);
@@ -965,7 +960,7 @@ scan_c_stream (FILE *infile)
 	    {
 	      c = getc (infile);
 	    }
-	  while (c == ',' || c == ' ' || c == '\t' || c == '\n' || c == '\r');
+	  while (c == ',' || c_isspace (c));
 
 	  /* Read in the identifier.  */
 	  do
@@ -977,8 +972,8 @@ scan_c_stream (FILE *infile)
 		fatal ("identifier too long");
 	      c = getc (infile);
 	    }
-	  while (! (c == ',' || c == ' ' || c == '\t'
-		    || c == '\n' || c == '\r'));
+	  while (! (c == ',' || c_isspace (c)));
+
 	  input_buffer[i] = '\0';
 	  memcpy (name, input_buffer, i + 1);
 
@@ -986,7 +981,8 @@ scan_c_stream (FILE *infile)
 	    {
 	      do
 		c = getc (infile);
-	      while (c == ' ' || c == '\t' || c == '\n' || c == '\r');
+	      while (c_isspace (c));
+
 	      if (c != '"')
 		continue;
 	      c = read_c_string_or_comment (infile, -1, false, 0);
@@ -1027,7 +1023,8 @@ scan_c_stream (FILE *infile)
 		  int scanned = 0;
 		  do
 		    c = getc (infile);
-		  while (c == ' ' || c == '\n' || c == '\r' || c == '\t');
+		  while (c_isspace (c));
+
 		  if (c < 0)
 		    goto eof;
 		  ungetc (c, infile);
@@ -1077,7 +1074,7 @@ scan_c_stream (FILE *infile)
 	  int d = getc (infile);
 	  if (d == EOF)
 	    goto eof;
-	  while (1)
+	  while (true)
 	    {
 	      if (c == '*' && d == '/')
 		break;
@@ -1092,13 +1089,14 @@ scan_c_stream (FILE *infile)
 	      if (c == EOF)
 		goto eof;
 	    }
-	  while (c == ' ' || c == '\n' || c == '\r' || c == '\t');
+	  while (c_isspace (c));
+
 	  /* Check for 'attributes:' token.  */
 	  if (c == 'a' && stream_match (infile, "ttributes:"))
 	    {
 	      char *p = input_buffer;
 	      /* Collect attributes up to ')'.  */
-	      while (1)
+	      while (true)
 		{
 		  c = getc (infile);
 		  if (c == EOF)
@@ -1120,7 +1118,7 @@ scan_c_stream (FILE *infile)
 	  continue;
 	}
 
-      while (c == ' ' || c == '\n' || c == '\r' || c == '\t')
+      while (c_isspace (c))
 	c = getc (infile);
 
       if (c == '"')
@@ -1130,17 +1128,18 @@ scan_c_stream (FILE *infile)
 	c = getc (infile);
       if (c == ',')
 	{
-	  c = getc (infile);
-	  while (c == ' ' || c == '\n' || c == '\r' || c == '\t')
+	  do
 	    c = getc (infile);
-	  while ((c >= 'a' && c <= 'z') || (c >= 'Z' && c <= 'Z'))
+	  while (c_isspace (c));
+
+	  while (c_isalpha (c))
 	    c = getc (infile);
 	  if (c == ':')
 	    {
 	      doc_keyword = true;
-	      c = getc (infile);
-	      while (c == ' ' || c == '\n' || c == '\r' || c == '\t')
+	      do
 		c = getc (infile);
+	      while (c_isspace (c));
 	    }
 	}
 
@@ -1191,8 +1190,14 @@ scan_c_stream (FILE *infile)
 	      /* Copy arguments into ARGBUF.  */
 	      *p++ = c;
 	      do
-		*p++ = c = getc (infile);
+		{
+		  c = getc (infile);
+		  if (c < 0)
+		    goto eof;
+		  *p++ = c;
+		}
 	      while (c != ')');
+
 	      *p = '\0';
 	      /* Output them.  */
 	      fputs ("\n\n", stdout);
@@ -1248,25 +1253,32 @@ scan_c_stream (FILE *infile)
 static void
 skip_white (FILE *infile)
 {
-  char c = ' ';
-  while (c == ' ' || c == '\t' || c == '\n' || c == '\r')
+  int c;
+  do
     c = getc (infile);
+  while (c_isspace (c));
+
   ungetc (c, infile);
 }
 
 static void
 read_lisp_symbol (FILE *infile, char *buffer)
 {
-  char c;
+  int c;
   char *fillp = buffer;
 
   skip_white (infile);
-  while (1)
+  while (true)
     {
       c = getc (infile);
       if (c == '\\')
-	*(++fillp) = getc (infile);
-      else if (c == ' ' || c == '\t' || c == '\n' || c == '\r' || c == '(' || c == ')')
+	{
+	  c = getc (infile);
+	  if (c < 0)
+	    return;
+	  *fillp++ = c;
+	}
+      else if (c_isspace (c) || c == '(' || c == ')' || c < 0)
 	{
 	  ungetc (c, infile);
 	  *fillp = 0;
@@ -1386,7 +1398,7 @@ scan_lisp_file (const char *filename, const char *mode)
 
 	      /* Read the length.  */
 	      while ((c = getc (infile),
-		      c >= '0' && c <= '9'))
+		      c_isdigit (c)))
 		{
 		  if (INT_MULTIPLY_WRAPV (length, 10, &length)
 		      || INT_ADD_WRAPV (length, c - '0', &length)
@@ -1418,7 +1430,7 @@ scan_lisp_file (const char *filename, const char *mode)
 	      while (c == '\n' || c == '\r')
 		c = getc (infile);
 	      /* Skip the following line.  */
-	      while (c != '\n' && c != '\r')
+	      while (! (c == '\n' || c == '\r' || c < 0))
 		c = getc (infile);
 	    }
 	  continue;
@@ -1456,7 +1468,7 @@ scan_lisp_file (const char *filename, const char *mode)
 	      continue;
 	    }
 	  else
-	    while (c != ')')
+	    while (! (c == ')' || c < 0))
 	      c = getc (infile);
 	  skip_white (infile);
 
@@ -1600,7 +1612,8 @@ scan_lisp_file (const char *filename, const char *mode)
 		}
 	    }
 	  skip_white (infile);
-	  if ((c = getc (infile)) != '\"')
+	  c = getc (infile);
+	  if (c != '\"')
 	    {
 	      fprintf (stderr, "## autoload of %s unparsable (%s)\n",
 		       buffer, filename);
diff --git a/lib/binary-io.h b/lib/binary-io.h
index 8a63204c25..96880ddb5b 100644
--- a/lib/binary-io.h
+++ b/lib/binary-io.h
@@ -47,10 +47,8 @@ _GL_INLINE_HEADER_BEGIN
   /* Use a function rather than a macro, to avoid gcc warnings
      "warning: statement with no effect".  */
 BINARY_IO_INLINE int
-__gl_setmode (int fd, int mode)
+__gl_setmode (int fd _GL_UNUSED, int mode _GL_UNUSED)
 {
-  (void) fd;
-  (void) mode;
   return O_BINARY;
 }
 #endif
@@ -59,7 +57,7 @@ __gl_setmode (int fd, int mode)
 extern int __gl_setmode_check (int);
 #else
 BINARY_IO_INLINE int
-__gl_setmode_check (int fd) { return 0; }
+__gl_setmode_check (int fd _GL_UNUSED) { return 0; }
 #endif
 
 /* Set FD's mode to MODE, which should be either O_TEXT or O_BINARY.
diff --git a/lib/fpending.c b/lib/fpending.c
index c84e3a5b4e..7bc235deda 100644
--- a/lib/fpending.c
+++ b/lib/fpending.c
@@ -32,7 +32,8 @@ __fpending (FILE *fp)
   /* Most systems provide FILE as a struct and the necessary bitmask in
      <stdio.h>, because they need it for implementing getc() and putc() as
      fast macros.  */
-#if defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
+#if defined _IO_EOF_SEEN || defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1
+  /* GNU libc, BeOS, Haiku, Linux libc5 */
   return fp->_IO_write_ptr - fp->_IO_write_base;
 #elif defined __sferror || defined __DragonFly__ || defined __ANDROID__
   /* FreeBSD, NetBSD, OpenBSD, DragonFly, Mac OS X, Cygwin, Minix 3, Android */
diff --git a/lib/stdio-impl.h b/lib/stdio-impl.h
index 78d896e9f5..05c5752a24 100644
--- a/lib/stdio-impl.h
+++ b/lib/stdio-impl.h
@@ -18,6 +18,12 @@
    the same implementation of stdio extension API, except that some fields
    have different naming conventions, or their access requires some casts.  */
 
+/* Glibc 2.28 made _IO_IN_BACKUP private.  For now, work around this
+   problem by defining it ourselves.  FIXME: Do not rely on glibc
+   internals.  */
+#if !defined _IO_IN_BACKUP && defined _IO_EOF_SEEN
+# define _IO_IN_BACKUP 0x100
+#endif
 
 /* BSD stdio derived implementations.  */
 
diff --git a/lisp/allout.el b/lisp/allout.el
index a0456d5bd2..af71ea75ce 100644
--- a/lisp/allout.el
+++ b/lisp/allout.el
@@ -1522,7 +1522,7 @@ the Emacs buffer state, if file variable adjustments are enabled.  See
 `allout-enable-file-variable-adjustment' for details about that.")
 (make-variable-buffer-local 'allout-passphrase-verifier-string)
 (make-obsolete-variable 'allout-passphrase-verifier-string
-			'allout-passphrase-verifier-string "23.3")
+			"it is no longer used." "23.3")
 ;;;###autoload
 (put 'allout-passphrase-verifier-string 'safe-local-variable 'stringp)
 ;;;_   = allout-passphrase-hint-string
@@ -1538,7 +1538,7 @@ state, if file variable adjustments are enabled.  See
 (make-variable-buffer-local 'allout-passphrase-hint-string)
 (setq-default allout-passphrase-hint-string "")
 (make-obsolete-variable 'allout-passphrase-hint-string
-			'allout-passphrase-hint-string "23.3")
+			"it is no longer used." "23.3")
 ;;;###autoload
 (put 'allout-passphrase-hint-string 'safe-local-variable 'stringp)
 ;;;_   = allout-after-save-decrypt
diff --git a/lisp/arc-mode.el b/lisp/arc-mode.el
index ce3ec09e28..4ddb29dcbb 100644
--- a/lisp/arc-mode.el
+++ b/lisp/arc-mode.el
@@ -1010,8 +1010,6 @@ using `make-temp-file', and the generated name is returned."
       (kill-local-variable 'buffer-file-coding-system)
       (after-insert-file-set-coding (- (point-max) (point-min))))))
 
-(define-obsolete-function-alias 'archive-mouse-extract 'archive-extract "22.1")
-
 (defun archive-extract (&optional other-window-p event)
   "In archive mode, extract this entry of the archive into its own buffer."
   (interactive (list nil last-input-event))
diff --git a/lisp/auth-source.el b/lisp/auth-source.el
index 8ef5f7140a..66e1897b87 100644
--- a/lisp/auth-source.el
+++ b/lisp/auth-source.el
@@ -1315,9 +1315,7 @@ See `auth-source-search' for details on SPEC."
                                                    (string-match (car item) file))
                                            (setq ret (cdr item))
                                            (setq check nil)))
-                                       ;; FIXME: `ret' unused.
-                                       ;; Should we return it here?
-                                       ))
+                                       ret))
                                     (t 'never)))
                                   (plain (or (eval default) (read-passwd prompt))))
                              ;; ask if we don't know what to do (in which case
diff --git a/lisp/autoinsert.el b/lisp/autoinsert.el
index 53586c5418..7858041440 100644
--- a/lisp/autoinsert.el
+++ b/lisp/autoinsert.el
@@ -386,7 +386,7 @@ Matches the visited file name against the elements of `auto-insert-alist'."
 	      (not (eq this-command 'auto-insert))
 	      (set-buffer-modified-p (eq auto-insert t)))))
   ;; Return nil so that it could be used in
-  ;; `find-file-not-found-hooks', though that's probably inadvisable.
+  ;; `find-file-not-found-functions', though that's probably inadvisable.
   nil)
 
 
diff --git a/lisp/bookmark.el b/lisp/bookmark.el
index 70b63a22b8..a454ccb3ae 100644
--- a/lisp/bookmark.el
+++ b/lisp/bookmark.el
@@ -2251,8 +2251,6 @@ strings returned are not."
   "Hook run at the end of loading library `bookmark.el'.")
 
 ;; Exit Hook, called from kill-emacs-hook
-(define-obsolete-variable-alias 'bookmark-exit-hooks
-  'bookmark-exit-hook "22.1")
 (defvar bookmark-exit-hook nil
   "Hook run when Emacs exits.")
 
diff --git a/lisp/calendar/icalendar.el b/lisp/calendar/icalendar.el
index ca3adfaeeb..c1a3e0a421 100644
--- a/lisp/calendar/icalendar.el
+++ b/lisp/calendar/icalendar.el
@@ -43,13 +43,13 @@
 
 ;;  0.06:  (2004-10-06)
 ;;  - Bugfixes regarding icalendar-import-format-*.
-;;  - Fix in icalendar-convert-diary-to-ical -- thanks to Philipp Grau.
+;;  - Fix in icalendar-export-file -- thanks to Philipp Grau.
 
 ;;  0.05: (2003-06-19)
 ;;  - New import format scheme: Replaced icalendar-import-prefix-*,
 ;;    icalendar-import-ignored-properties, and
 ;;    icalendar-import-separator with icalendar-import-format(-*).
-;;  - icalendar-import-file and icalendar-convert-diary-to-ical
+;;  - icalendar-import-file and icalendar-export-file
 ;;    have an extra parameter which should prevent them from
 ;;    erasing their target files (untested!).
 ;;  - Tested with Emacs 21.3.2
@@ -996,9 +996,6 @@ Finto iCalendar file: ")
     (set-buffer (find-file diary-filename))
     (icalendar-export-region (point-min) (point-max) ical-filename)))
 
-(define-obsolete-function-alias 'icalendar-convert-diary-to-ical
-  'icalendar-export-file "22.1")
-
 (defvar icalendar--uid-count 0
   "Auxiliary counter for creating unique ids.")
 
@@ -2027,9 +2024,6 @@ buffer `*icalendar-errors*'."
       ;; return nil, i.e. import did not work
       nil)))
 
-(define-obsolete-function-alias 'icalendar-extract-ical-from-buffer
-  'icalendar-import-buffer "22.1")
-
 (defun icalendar--format-ical-event (event)
   "Create a string representation of an iCalendar EVENT."
   (if (functionp icalendar-import-format)
diff --git a/lisp/cedet/ede.el b/lisp/cedet/ede.el
index 76acf8a941..5bbc2d0f85 100644
--- a/lisp/cedet/ede.el
+++ b/lisp/cedet/ede.el
@@ -1095,6 +1095,7 @@ Flush the dead projects from the project cache."
     ))
 
 (defvar ede--disable-inode)             ;Defined in ede/files.el.
+(declare-function ede--project-inode "ede/files" (proj))
 
 (defun ede-global-list-sanity-check ()
   "Perform a sanity check to make sure there are no duplicate projects."
diff --git a/lisp/cedet/semantic/bovine/grammar.el b/lisp/cedet/semantic/bovine/grammar.el
index 0eab01b58b..1746f3e6ff 100644
--- a/lisp/cedet/semantic/bovine/grammar.el
+++ b/lisp/cedet/semantic/bovine/grammar.el
@@ -475,6 +475,7 @@ Menu items are appended to the common grammar menu.")
 	 ;; This is with-demoted-errors.
 	 (condition-case err
 	     (with-current-buffer (find-file-noselect infile)
+	       (setq infile buffer-file-name)
 	       (if outdir (setq default-directory outdir))
 	       (semantic-grammar-create-package nil t))
 	   (error (message "%s" (error-message-string err)) nil)))
@@ -509,8 +510,12 @@ Menu items are appended to the common grammar menu.")
 
 ;;; Commentary:
 ;;
-;; This file was generated from admin/grammars/"
-		lang ".by.
+;; This file was generated from "
+		(if (string-match "\\(admin/grammars/.*\\.by\\)\\'" infile)
+		    (match-string 1 infile)
+		  (concat "admin/grammars/"
+			  (if (string-equal lang "scm") "scheme" lang) ".by"))
+".
 
 ;;; Code:
 ")
diff --git a/lisp/cedet/semantic/sb.el b/lisp/cedet/semantic/sb.el
index 739f674214..443c3839bb 100644
--- a/lisp/cedet/semantic/sb.el
+++ b/lisp/cedet/semantic/sb.el
@@ -298,11 +298,7 @@ TEXT TOKEN and INDENT are the details."
   "Jump to the location specified in token.
 TEXT TOKEN and INDENT are the details."
   (let ((file
-	 (or
-	  (cond ((fboundp 'speedbar-line-path)
-		 (speedbar-line-directory indent))
-		((fboundp 'speedbar-line-directory)
-		 (speedbar-line-directory indent)))
+	 (or (speedbar-line-directory indent)
 	  ;; If speedbar cannot figure this out, extract the filename from
 	  ;; the token.  True for Analysis mode.
 	  (semantic-tag-file-name token)))
diff --git a/lisp/cedet/semantic/texi.el b/lisp/cedet/semantic/texi.el
index 9769ae8928..7fe1932479 100644
--- a/lisp/cedet/semantic/texi.el
+++ b/lisp/cedet/semantic/texi.el
@@ -365,6 +365,8 @@ Optional argument POINT is where to look for the environment."
 (eval-when-compile
   (require 'semantic/analyze))
 
+(declare-function semantic-analyze-context "semantic/analyze")
+
 (define-mode-local-override semantic-analyze-current-context
   texinfo-mode (point)
   "Analysis context makes no sense for texinfo.  Return nil."
diff --git a/lisp/comint.el b/lisp/comint.el
index 3163afeff4..3182cba866 100644
--- a/lisp/comint.el
+++ b/lisp/comint.el
@@ -429,9 +429,6 @@ See `comint-send-input'."
   :type 'boolean
   :group 'comint)
 
-(define-obsolete-variable-alias 'comint-use-prompt-regexp-instead-of-fields
-  'comint-use-prompt-regexp "22.1")
-
 ;; Note: If it is decided to purge comint-prompt-regexp from the source
 ;; entirely, searching for uses of this variable will help to identify
 ;; places that need attention.
@@ -454,8 +451,8 @@ This is run before the process is cranked up."
   "Hook run each time a process is exec'd by `comint-exec'.
 This is called after the process is cranked up.  It is useful for things that
 must be done each time a process is executed in a Comint mode buffer (e.g.,
-`(process-kill-without-query)').  In contrast, the `comint-mode-hook' is only
-executed once when the buffer is created."
+`set-process-query-on-exit-flag').  In contrast, `comint-mode-hook' is only
+executed once, when the buffer is created."
   :type 'hook
   :group 'comint)
 
diff --git a/lisp/cus-edit.el b/lisp/cus-edit.el
index 816c7f7881..a12897e799 100644
--- a/lisp/cus-edit.el
+++ b/lisp/cus-edit.el
@@ -3790,10 +3790,6 @@ Optional EVENT is the location for the menu."
   (custom-save-all)
   (custom-face-state-set-and-redraw widget))
 
-;; For backward compatibility.
-(define-obsolete-function-alias 'custom-face-save-command 'custom-face-save
-  "22.1")
-
 (defun custom-face-reset-saved (widget)
   "Restore WIDGET to the face's default attributes.
 If there is a saved face, restore it; otherwise reset to the
diff --git a/lisp/descr-text.el b/lisp/descr-text.el
index ddd7d801d2..d8f8188eb1 100644
--- a/lisp/descr-text.el
+++ b/lisp/descr-text.el
@@ -835,8 +835,6 @@ relevant to POS."
           (if text-props-desc (insert text-props-desc))
           (setq buffer-read-only t))))))
 
-(define-obsolete-function-alias 'describe-char-after 'describe-char "22.1")
-
 ;;; Describe-Char-ElDoc
 
 (defun describe-char-eldoc--truncate (name width)
diff --git a/lisp/desktop.el b/lisp/desktop.el
index 8bd44658d8..55ec71c1b9 100644
--- a/lisp/desktop.el
+++ b/lisp/desktop.el
@@ -158,8 +158,6 @@ Used at desktop read to provide backward compatibility.")
   "Save status of Emacs when you exit."
   :group 'frames)
 
-;; Maintained for backward compatibility
-(define-obsolete-variable-alias 'desktop-enable 'desktop-save-mode "22.1")
 ;;;###autoload
 (define-minor-mode desktop-save-mode
   "Toggle desktop saving (Desktop Save mode).
@@ -248,9 +246,6 @@ the normal hook `desktop-not-loaded-hook' is run."
   :group 'desktop
   :version "22.2")
 
-(define-obsolete-variable-alias 'desktop-basefilename
-                                'desktop-base-file-name "22.1")
-
 (defcustom desktop-base-file-name
   (convert-standard-filename ".emacs.desktop")
   "Name of file for Emacs desktop, excluding the directory part."
@@ -392,7 +387,7 @@ or `desktop-modes-not-to-save'."
 
 ;; Skip tramp and ange-ftp files
 (defcustom desktop-files-not-to-save
-  "\\(^/[^/:]*:\\|(ftp)$\\)"
+  "\\(\\`/[^/:]*:\\|(ftp)\\'\\)"
   "Regexp identifying files whose buffers are to be excluded from saving.
 The default value excludes buffers visiting remote files."
   :type '(choice (const :tag "None" nil)
@@ -494,10 +489,6 @@ When file names are returned, they should be formatted using the call
 Later, when `desktop-read' evaluates the desktop file, auxiliary information
 is passed as the argument DESKTOP-BUFFER-MISC to functions in
 `desktop-buffer-mode-handlers'.")
-(make-obsolete-variable 'desktop-buffer-modes-to-save
-                        'desktop-save-buffer "22.1")
-(make-obsolete-variable 'desktop-buffer-misc-functions
-                        'desktop-save-buffer "22.1")
 
 ;;;###autoload
 (defvar desktop-buffer-mode-handlers nil
@@ -541,12 +532,9 @@ can guess how to load the mode's definition.")
 
 ;;;###autoload
 (put 'desktop-buffer-mode-handlers 'risky-local-variable t)
-(make-obsolete-variable 'desktop-buffer-handlers
-                        'desktop-buffer-mode-handlers "22.1")
 
 (defcustom desktop-minor-mode-table
-  '((auto-fill-function auto-fill-mode)
-    (defining-kbd-macro nil)
+  '((defining-kbd-macro nil)
     (isearch-mode nil)
     (vc-mode nil)
     (vc-dired-mode nil)
@@ -713,12 +701,12 @@ if different)."
     (if (symbolp var)
 	(set-default var nil)
       (set-default var (eval (cdr var)))))
-  (let ((preserve-regexp (concat "^\\("
+  (let ((preserve-regexp (concat "\\`\\("
                                  (mapconcat (lambda (regexp)
                                               (concat "\\(" regexp "\\)"))
                                             desktop-clear-preserve-buffers
                                             "\\|")
-                                 "\\)$")))
+                                 "\\)\\'")))
     (dolist (buffer (buffer-list))
       (let ((bufname (buffer-name buffer)))
 	(unless (or (eq (aref bufname 0) ?\s) ;; Don't kill internal buffers
@@ -746,7 +734,7 @@ if different)."
 
 ;; ----------------------------------------------------------------------------
 (unless noninteractive
-  (add-hook 'kill-emacs-hook 'desktop-kill))
+  (add-hook 'kill-emacs-hook #'desktop-kill))
 
 (defun desktop-kill ()
   "If `desktop-save-mode' is non-nil, do what `desktop-save' says to do.
@@ -815,6 +803,7 @@ buffer, which is (in order):
               (symbol-value minor-mode)
               (let* ((special (assq minor-mode desktop-minor-mode-table))
                      (value (cond (special (cadr special))
+                                  ((get minor-mode :minor-mode-function))
                                   ((functionp minor-mode) minor-mode))))
                 (when value (cl-pushnew value ret))))))
     ;; point and mark, and read-only status
@@ -900,8 +889,8 @@ QUOTE may be `may' (value may be quoted),
        (cons nil
              `(let ((mk (make-marker)))
                 (add-hook 'desktop-delay-hook
-                          `(lambda ()
-                             (set-marker ,mk ,,pos (get-buffer ,,buf))))
+                          (lambda ()
+                            (set-marker mk ,pos (get-buffer ,buf))))
                 mk))))
     (t                                  ; Save as text.
      (cons 'may "Unprintable entity"))))
@@ -1085,7 +1074,7 @@ without further confirmation."
 
 	(with-temp-buffer
 	  (insert
-	   ";; -*- mode: emacs-lisp; coding: emacs-mule; -*-\n"
+	   ";; -*- mode: emacs-lisp; lexical-binding:t; coding: utf-8-emacs; -*-\n"
 	   desktop-header
 	   ";; Created " (current-time-string) "\n"
 	   ";; Desktop file format version " (format "%d" desktop-io-file-version) "\n"
@@ -1098,7 +1087,7 @@ without further confirmation."
 	  (desktop-save-frameset)
 	  (unless (memq 'desktop-saved-frameset desktop-globals-to-save)
 	    (desktop-outvar 'desktop-saved-frameset))
-	  (mapc (function desktop-outvar) desktop-globals-to-save)
+	  (mapc #'desktop-outvar desktop-globals-to-save)
 	  (setq desktop-saved-frameset nil) ; after saving desktop-globals-to-save
 	  (when (memq 'kill-ring desktop-globals-to-save)
 	    (insert
@@ -1107,9 +1096,9 @@ without further confirmation."
 	     " kill-ring))\n"))
 
 	  (insert "\n;; Buffer section -- buffers listed in same order as in buffer list:\n")
-	  (dolist (l (mapcar 'desktop-buffer-info (buffer-list)))
+	  (dolist (l (mapcar #'desktop-buffer-info (buffer-list)))
 	    (let ((base (pop l)))
-	      (when (apply 'desktop-save-buffer-p l)
+	      (when (apply #'desktop-save-buffer-p l)
 		(insert "("
 			(if (or (not (integerp eager))
 				(if (zerop eager)
@@ -1140,9 +1129,9 @@ without further confirmation."
 				  ;; This is saved after the timestamp
 				  (search-forward (format "%S" desktop--app-id) nil t))
 			     (point))))
-		 (checksum (and beg (md5 (current-buffer) beg (point-max) 'emacs-mule))))
+		 (checksum (and beg (md5 (current-buffer) beg (point-max) 'utf-8-emacs))))
 	    (unless (and checksum (equal checksum desktop-file-checksum))
-	      (let ((coding-system-for-write 'emacs-mule))
+	      (let ((coding-system-for-write 'utf-8-emacs))
 		(write-region (point-min) (point-max) (desktop-full-file-name) nil 'nomessage))
 	      (setq desktop-file-checksum checksum)
 	      ;; We remember when it was modified (which is presumably just now).
@@ -1241,12 +1230,12 @@ Using it may cause conflicts.  Use it anyway? " owner)))))
 	    ;; disabled when loading the desktop fails with errors,
 	    ;; thus not overwriting the desktop with broken contents.
 	    (setq desktop-autosave-was-enabled
-		  (memq 'desktop-auto-save-set-timer
-                        ;; Use the toplevel value of the hook, in case some
+		  (memq #'desktop-auto-save-set-timer
+                        ;; Use the global value of the hook, in case some
                         ;; feature makes window-configuration-change-hook
                         ;; buffer-local, and puts there stuff which
                         ;; doesn't include our timer.
-                        (default-toplevel-value
+                        (default-value
                           'window-configuration-change-hook)))
 	    (desktop-auto-save-disable)
 	    ;; Evaluate desktop buffer and remember when it was modified.
@@ -1265,7 +1254,7 @@ Using it may cause conflicts.  Use it anyway? " owner)))))
 	      ;; We want buffers existing prior to evaluating the desktop (and
 	      ;; not reused) to be placed at the end of the buffer list, so we
 	      ;; move them here.
-	      (mapc 'bury-buffer
+	      (mapc #'bury-buffer
 		    (nreverse (cdr (memq desktop-first-buffer (nreverse (buffer-list))))))
 	      (switch-to-buffer (car (buffer-list))))
 	    (run-hooks 'desktop-delay-hook)
@@ -1309,17 +1298,6 @@ Using it may cause conflicts.  Use it anyway? " owner)))))
       (message "No desktop file.")
       nil)))
 
-;; ----------------------------------------------------------------------------
-;; Maintained for backward compatibility
-;;;###autoload
-(defun desktop-load-default ()
-  "Load the `default' start-up library manually.
-Also inhibit further loading of it."
-  (declare (obsolete desktop-save-mode "22.1"))
-  (unless inhibit-default-init	        ; safety check
-    (load "default" t t)
-    (setq inhibit-default-init t)))
-
 ;; ----------------------------------------------------------------------------
 ;;;###autoload
 (defun desktop-change-dir (dirname)
@@ -1350,10 +1328,10 @@ directory DIRNAME."
 (defun desktop-auto-save-enable (&optional timeout)
   (when (and (integerp (or timeout desktop-auto-save-timeout))
 	     (> (or timeout desktop-auto-save-timeout) 0))
-    (add-hook 'window-configuration-change-hook 'desktop-auto-save-set-timer)))
+    (add-hook 'window-configuration-change-hook #'desktop-auto-save-set-timer)))
 
 (defun desktop-auto-save-disable ()
-  (remove-hook 'window-configuration-change-hook 'desktop-auto-save-set-timer)
+  (remove-hook 'window-configuration-change-hook #'desktop-auto-save-set-timer)
   (desktop-auto-save-cancel-timer))
 
 (defun desktop-auto-save ()
@@ -1608,7 +1586,7 @@ ARGS must be an argument list for `desktop-create-buffer'."
       (let ((desktop-first-buffer nil)
             (desktop-buffer-ok-count 0)
             (desktop-buffer-fail-count 0))
-        (apply 'desktop-create-buffer args)
+        (apply #'desktop-create-buffer args)
         (run-hooks 'desktop-delay-hook)
         (setq desktop-delay-hook nil)
         (bury-buffer (get-buffer buffer-name))
diff --git a/lisp/dired-aux.el b/lisp/dired-aux.el
index b837fb4e5e..e8b5e6755e 100644
--- a/lisp/dired-aux.el
+++ b/lisp/dired-aux.el
@@ -1842,7 +1842,8 @@ Optional arg HOW-TO determines how to treat the target.
       rfn-list  - list of the relative names for the marked files.
       fn-list   - list of the absolute names for the marked files.
       target    - the name of the target itself.
-      The rest of into-dir are optional arguments.
+    The rest of elements of the list returned by HOW-TO are optional
+    arguments for the function that is the first element of the list.
    For any other return value, TARGET is treated as a directory."
   (or op1 (setq op1 operation))
   (let* ((fn-list (dired-get-marked-files nil arg nil nil t))
diff --git a/lisp/dired-x.el b/lisp/dired-x.el
index fa36083e14..a1c2f4484c 100644
--- a/lisp/dired-x.el
+++ b/lisp/dired-x.el
@@ -137,8 +137,6 @@ folding to be used on case-insensitive filesystems only."
       (file-name-case-insensitive-p dir)
     dired-omit-case-fold))
 
-;; For backward compatibility
-(define-obsolete-variable-alias 'dired-omit-files-p 'dired-omit-mode "22.1")
 (define-minor-mode dired-omit-mode
   "Toggle omission of uninteresting files in Dired (Dired-Omit mode).
 With a prefix argument ARG, enable Dired-Omit mode if ARG is
diff --git a/lisp/emacs-lisp/autoload.el b/lisp/emacs-lisp/autoload.el
index 92ad6155b5..5274ec880c 100644
--- a/lisp/emacs-lisp/autoload.el
+++ b/lisp/emacs-lisp/autoload.el
@@ -324,6 +324,7 @@ put the output in."
 	    (setcdr p nil)
 	    (princ "\n(" outbuf)
 	    (let ((print-escape-newlines t)
+		  (print-escape-control-characters t)
                   (print-quoted t)
 		  (print-escape-nonascii t))
 	      (dolist (elt form)
@@ -348,6 +349,7 @@ put the output in."
 		       outbuf))
 	      (terpri outbuf)))
 	(let ((print-escape-newlines t)
+	      (print-escape-control-characters t)
               (print-quoted t)
 	      (print-escape-nonascii t))
 	  (print form outbuf)))))))
@@ -1143,9 +1145,6 @@ write its autoloads into the specified file instead."
       ;; file-local autoload-generated-file settings.
       (autoload-save-buffers))))
 
-(define-obsolete-function-alias 'update-autoloads-from-directories
-    'update-directory-autoloads "22.1")
-
 ;;;###autoload
 (defun batch-update-autoloads ()
   "Update loaddefs.el autoloads in batch mode.
diff --git a/lisp/emacs-lisp/bytecomp.el b/lisp/emacs-lisp/bytecomp.el
index 1bf6d04b63..b3ea9300b0 100644
--- a/lisp/emacs-lisp/bytecomp.el
+++ b/lisp/emacs-lisp/bytecomp.el
@@ -3119,7 +3119,13 @@ for symbols generated by the byte compiler itself."
              (when (assq var byte-compile-lexical-variables)
                (byte-compile-report-error
                 (format-message "%s cannot use lexical var `%s'" fn var))))))
-        (when (macroexp--const-symbol-p fn)
+        ;; Warn about using obsolete hooks.
+        (if (memq fn '(add-hook remove-hook))
+            (let ((hook (car-safe (cdr form))))
+              (if (eq (car-safe hook) 'quote)
+                  (byte-compile-check-variable (cadr hook) nil))))
+        (when (and (byte-compile-warning-enabled-p 'suspicious)
+                   (macroexp--const-symbol-p fn))
           (byte-compile-warn "`%s' called as a function" fn))
 	(when (and (byte-compile-warning-enabled-p 'interactive-only)
 		   interactive-only)
diff --git a/lisp/emacs-lisp/cl-macs.el b/lisp/emacs-lisp/cl-macs.el
index 4d4640cbe0..9600230c07 100644
--- a/lisp/emacs-lisp/cl-macs.el
+++ b/lisp/emacs-lisp/cl-macs.el
@@ -771,13 +771,15 @@ The result of the body appears to the compiler as a quoted constant."
 ;;;###autoload
 (defmacro cl-case (expr &rest clauses)
   "Eval EXPR and choose among clauses on that value.
-Each clause looks like (KEYLIST BODY...).  EXPR is evaluated and compared
-against each key in each KEYLIST; the corresponding BODY is evaluated.
-If no clause succeeds, cl-case returns nil.  A single atom may be used in
-place of a KEYLIST of one atom.  A KEYLIST of t or `otherwise' is
-allowed only in the final clause, and matches if no other keys match.
-Key values are compared by `eql'.
-\n(fn EXPR (KEYLIST BODY...)...)"
+Each clause looks like (KEYLIST BODY...).  EXPR is evaluated and
+compared against each key in each KEYLIST; the corresponding BODY
+is evaluated.  If no clause succeeds, cl-case returns nil.  A
+single non-nil atom may be used in place of a KEYLIST of one
+atom.  A KEYLIST of t or `otherwise' is allowed only in the final
+clause, and matches if no other keys match.  Key values are
+compared by `eql'.
+
+\(fn EXPR (KEYLIST BODY...)...)"
   (declare (indent 1) (debug (form &rest (sexp body))))
   (macroexp-let2 macroexp-copyable-p temp expr
     (let* ((head-list nil))
diff --git a/lisp/emacs-lisp/derived.el b/lisp/emacs-lisp/derived.el
index 547f5cd805..6b47ffea07 100644
--- a/lisp/emacs-lisp/derived.el
+++ b/lisp/emacs-lisp/derived.el
@@ -286,19 +286,6 @@ No problems result if this variable is not bound.
 	 ;; Run the hooks (and delayed-after-hook-functions), if any.
 	 (run-mode-hooks ',hook)))))
 
-;; PUBLIC: find the ultimate class of a derived mode.
-
-(defun derived-mode-class (mode)
-  "Find the class of a major MODE.
-A mode's class is the first ancestor which is NOT a derived mode.
-Use the `derived-mode-parent' property of the symbol to trace backwards.
-Since major-modes might all derive from `fundamental-mode', this function
-is not very useful."
-  (declare (obsolete derived-mode-p "22.1"))
-  (while (get mode 'derived-mode-parent)
-    (setq mode (get mode 'derived-mode-parent)))
-  mode)
-
 
 ;;; PRIVATE
 
diff --git a/lisp/emacs-lisp/eieio.el b/lisp/emacs-lisp/eieio.el
index de08e37286..1e1419f6eb 100644
--- a/lisp/emacs-lisp/eieio.el
+++ b/lisp/emacs-lisp/eieio.el
@@ -403,7 +403,7 @@ If EXTRA, include that in the string returned to represent the symbol."
 
 (cl-defgeneric eieio-object-set-name-string (obj name)
   "Set the string which is OBJ's NAME."
-  (declare (obsolete "inherit from `eieio-named' and use (setf (slot-value OBJ 'object-name) NAME) instead" "25.1"))
+  (declare (obsolete "inherit from `eieio-named' and use (setf (slot-value OBJ \\='object-name) NAME) instead" "25.1"))
   (cl-check-type name string)
   (setf (gethash obj eieio--object-names) name))
 (define-obsolete-function-alias
diff --git a/lisp/emacs-lisp/ert.el b/lisp/emacs-lisp/ert.el
index a47108545d..3beb8a070f 100644
--- a/lisp/emacs-lisp/ert.el
+++ b/lisp/emacs-lisp/ert.el
@@ -676,6 +676,7 @@ and is displayed in front of the value of MESSAGE-FORM."
 (cl-defstruct ert-test-result
   (messages nil)
   (should-forms nil)
+  (duration 0)
   )
 (cl-defstruct (ert-test-passed (:include ert-test-result)))
 (cl-defstruct (ert-test-result-with-condition (:include ert-test-result))
@@ -1230,6 +1231,11 @@ SELECTOR is the selector that was used to select TESTS."
         (ert-run-test test)
       (setf (aref (ert--stats-test-end-times stats) pos) (current-time))
       (let ((result (ert-test-most-recent-result test)))
+        (setf (ert-test-result-duration result)
+              (float-time
+               (time-subtract
+                (aref (ert--stats-test-end-times stats) pos)
+                (aref (ert--stats-test-start-times stats) pos))))
         (ert--stats-set-test-and-result stats pos test result)
         (funcall listener 'test-ended stats test result))
       (setf (ert--stats-current-test stats) nil))))
@@ -1336,6 +1342,9 @@ RESULT must be an `ert-test-result-with-condition'."
 (defvar ert-quiet nil
   "Non-nil makes ERT only print important information in batch mode.")
 
+(defvar ert-batch-print-duration nil
+  "Non-nil makes ERT print duration time of single tests in batch mode.")
+
 ;;;###autoload
 (defun ert-run-tests-batch (&optional selector)
   "Run the tests specified by SELECTOR, printing results to the terminal.
@@ -1446,13 +1455,17 @@ Returns the stats object."
             (let* ((max (prin1-to-string (length (ert--stats-tests stats))))
                    (format-string (concat "%9s  %"
                                           (prin1-to-string (length max))
-                                          "s/" max "  %S")))
+                                          "s/" max "  %S"
+                                          (if ert-batch-print-duration
+                                              " (%f sec)"))))
               (message format-string
                        (ert-string-for-test-result result
                                                    (ert-test-result-expected-p
                                                     test result))
                        (1+ (ert--stats-test-pos stats test))
-                       (ert-test-name test))))))))
+                       (ert-test-name test)
+                       (if ert-batch-print-duration
+                           (ert-test-result-duration result)))))))))
    nil))
 
 ;;;###autoload
@@ -1535,7 +1548,14 @@ Ran \\([0-9]+\\) tests, \\([0-9]+\\) results as expected\
       (mapc (lambda (l) (message "  %s" l)) notests))
     (when badtests
       (message "%d files did not finish:" (length badtests))
-      (mapc (lambda (l) (message "  %s" l)) badtests))
+      (mapc (lambda (l) (message "  %s" l)) badtests)
+      (if (getenv "EMACS_HYDRA_CI")
+          (with-temp-buffer
+            (dolist (f badtests)
+              (erase-buffer)
+              (insert-file-contents f)
+              (message "Contents of unfinished file %s:" f)
+              (message "-----\n%s\n-----" (buffer-string))))))
     (when unexpected
       (message "%d files contained unexpected results:" (length unexpected))
       (mapc (lambda (l) (message "  %s" l)) unexpected))
diff --git a/lisp/emacs-lisp/ewoc.el b/lisp/emacs-lisp/ewoc.el
index 262d4d8594..52d8451f4b 100644
--- a/lisp/emacs-lisp/ewoc.el
+++ b/lisp/emacs-lisp/ewoc.el
@@ -500,7 +500,7 @@ Return the node (or nil if we just passed the last node)."
 
 (defun ewoc-goto-node (ewoc node)
   "Move point to NODE in EWOC."
-  (ewoc--set-buffer-bind-dll ewoc
+  (with-current-buffer (ewoc--buffer ewoc)
     (goto-char (ewoc--node-start-marker node))
     (if goal-column (move-to-column goal-column))
     (setf (ewoc--last-node ewoc) node)))
diff --git a/lisp/emacs-lisp/generic.el b/lisp/emacs-lisp/generic.el
index e2009bf4c2..194fa1e1c2 100644
--- a/lisp/emacs-lisp/generic.el
+++ b/lisp/emacs-lisp/generic.el
@@ -96,8 +96,6 @@
 ;; Internal Variables
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
-(define-obsolete-variable-alias 'generic-font-lock-defaults
-  'generic-font-lock-keywords "22.1")
 (defvar generic-font-lock-keywords nil
   "Keywords for `font-lock-defaults' in a generic mode.")
 (make-variable-buffer-local 'generic-font-lock-keywords)
diff --git a/lisp/emacs-lisp/syntax.el b/lisp/emacs-lisp/syntax.el
index 6106720f7a..ad1a9665ff 100644
--- a/lisp/emacs-lisp/syntax.el
+++ b/lisp/emacs-lisp/syntax.el
@@ -363,12 +363,6 @@ An \"outermost position\" means one that it is outside of any syntactic entity:
 outside of any parentheses, comments, or strings encountered in the scan.
 If no such position is recorded in PPSS (because the end of the scan was
 itself at the outermost level), return nil."
-  ;; BEWARE! We rely on the undocumented 9th field.  The 9th field currently
-  ;; contains the list of positions of the enclosing open-parens.
-  ;; I.e. those positions are outside of any string/comment and the first of
-  ;; those is outside of any paren (i.e. corresponds to a nil ppss).
-  ;; If this list is empty but we are in a string or comment, then the 8th
-  ;; field contains a similar "toplevel" position.
   (or (car (nth 9 ppss))
       (nth 8 ppss)))
 
diff --git a/lisp/emacs-lisp/timer.el b/lisp/emacs-lisp/timer.el
index b1e12b1fd5..795554fec5 100644
--- a/lisp/emacs-lisp/timer.el
+++ b/lisp/emacs-lisp/timer.el
@@ -141,20 +141,6 @@ omitted, they are treated as zero."
   (setf (timer--time timer)
         (timer-relative-time (timer--time timer) secs usecs psecs)))
 
-(defun timer-set-time-with-usecs (timer time usecs &optional delta)
-  "Set the trigger time of TIMER to TIME plus USECS.
-TIME must be in the internal format returned by, e.g., `current-time'.
-The microsecond count from TIME is ignored, and USECS is used instead.
-If optional fourth argument DELTA is a positive number, make the timer
-fire repeatedly that many seconds apart."
-  (declare (obsolete "use `timer-set-time' and `timer-inc-time' instead."
-		     "22.1"))
-  (setf (timer--time timer) time)
-  (setf (timer--usecs timer) usecs)
-  (setf (timer--psecs timer) 0)
-  (setf (timer--repeat-delay timer) (and (numberp delta) (> delta 0) delta))
-  timer)
-
 (defun timer-set-function (timer function &optional args)
   "Make TIMER call FUNCTION with optional ARGS when triggering."
   (timer--check timer)
diff --git a/lisp/emacs-lisp/unsafep.el b/lisp/emacs-lisp/unsafep.el
index f6b569bc7f..03f22ebf1a 100644
--- a/lisp/emacs-lisp/unsafep.el
+++ b/lisp/emacs-lisp/unsafep.el
@@ -93,7 +93,7 @@ in the parse.")
 (put 'unsafep-vars 'risky-local-variable t)
 
 ;;Side-effect-free functions from subr.el
-(dolist (x '(assoc-default assoc-ignore-case butlast last match-string
+(dolist (x '(assoc-default butlast last match-string
 	     match-string-no-properties member-ignore-case remove remq))
   (put x 'side-effect-free t))
 
diff --git a/lisp/emulation/cua-base.el b/lisp/emulation/cua-base.el
index a737bb6c11..ff23484dd0 100644
--- a/lisp/emulation/cua-base.el
+++ b/lisp/emulation/cua-base.el
@@ -852,8 +852,6 @@ With numeric prefix arg, copy to register 0-9 instead."
   (if (fboundp 'cua--cancel-rectangle)
       (cua--cancel-rectangle)))
 
-(declare-function x-clipboard-yank "../term/x-win" ())
-
 (put 'cua-paste 'delete-selection 'yank)
 (defun cua-paste (arg)
   "Paste last cut or copied region or rectangle.
@@ -884,10 +882,8 @@ If global mark is active, copy from register or one character."
 	 ((consp regtxt) (cua--insert-rectangle regtxt))
 	 ((stringp regtxt) (insert-for-yank regtxt))
 	 (t (message "Unknown data in register %c" cua--register))))
-       ((eq this-original-command 'clipboard-yank)
-	(clipboard-yank))
-       ((eq this-original-command 'x-clipboard-yank)
-	(x-clipboard-yank))
+       ((memq this-original-command '(clipboard-yank x-clipboard-yank))
+        (funcall this-original-command))
        (t (yank arg)))))))
 
 
diff --git a/lisp/emulation/viper-ex.el b/lisp/emulation/viper-ex.el
index 347e66f8ff..d95a828614 100644
--- a/lisp/emulation/viper-ex.el
+++ b/lisp/emulation/viper-ex.el
@@ -548,9 +548,13 @@ reversed."
       (setq viper-ex-work-buf (get-buffer-create viper-ex-work-buf-name))
       (set-buffer viper-ex-work-buf)
       (goto-char (point-max)))
-    (cond ((looking-back quit-regex1) (exit-minibuffer))
-	  ((looking-back stay-regex)  (insert " "))
-	  ((looking-back quit-regex2) (exit-minibuffer))
+    (cond ((looking-back quit-regex1 (line-beginning-position))
+	   (exit-minibuffer))
+	  ;; Almost certainly point-min should be line-beginning-position,
+	  ;; but probably the two are identical anyway, and who really cares?
+	  ((looking-back stay-regex (point-min)) (insert " "))
+	  ((looking-back quit-regex2 (line-beginning-position))
+	   (exit-minibuffer))
 	  (t (insert " ")))))
 
 (declare-function viper-tmp-insert-at-eob "viper-cmd" (msg))
diff --git a/lisp/emulation/viper.el b/lisp/emulation/viper.el
index 7292fd58c1..c8eca30e88 100644
--- a/lisp/emulation/viper.el
+++ b/lisp/emulation/viper.el
@@ -300,6 +300,8 @@
 
 ;;; Code:
 
+(require 'cl-lib)
+
 ;; compiler pacifier
 (defvar mark-even-if-inactive)
 (defvar quail-mode)
@@ -900,7 +902,7 @@ Two differences:
   (viper-setup-ESC-to-escape t)
 
   (add-hook 'change-major-mode-hook #'viper-major-mode-change-sentinel)
-  (add-hook 'find-file-hooks #'set-viper-state-in-major-mode)
+  (add-hook 'find-file-hook #'set-viper-state-in-major-mode)
 
   ;; keep this because many modes we don't know about use this hook
   (defvar text-mode-hook)
diff --git a/lisp/epa-hook.el b/lisp/epa-hook.el
index d99a3ef51a..135c956c3f 100644
--- a/lisp/epa-hook.el
+++ b/lisp/epa-hook.el
@@ -95,7 +95,7 @@ the mode if ARG is omitted or nil."
   :initialize 'custom-initialize-delay
   (setq file-name-handler-alist
 	(delq epa-file-handler file-name-handler-alist))
-  (remove-hook 'find-file-hooks 'epa-file-find-file-hook)
+  (remove-hook 'find-file-hook 'epa-file-find-file-hook)
   (setq auto-mode-alist (delq epa-file-auto-mode-alist-entry
 			      auto-mode-alist))
   (when auto-encryption-mode
diff --git a/lisp/epa-mail.el b/lisp/epa-mail.el
index 077666ac89..c819f6734c 100644
--- a/lisp/epa-mail.el
+++ b/lisp/epa-mail.el
@@ -111,7 +111,7 @@ If no one is selected, default secret key is used.  "
 
 (defun epa-mail-default-recipients ()
   "Return the default list of encryption recipients for a mail buffer."
-  (let ((config (epg-configuration))
+  (let ((config (epg-find-configuration 'OpenPGP))
 	recipients-string real-recipients)
     (save-excursion
       (goto-char (point-min))
diff --git a/lisp/erc/erc-dcc.el b/lisp/erc/erc-dcc.el
index 764c6cc617..5bc8c2f38b 100644
--- a/lisp/erc/erc-dcc.el
+++ b/lisp/erc/erc-dcc.el
@@ -54,7 +54,9 @@
 ;;; Code:
 
 (require 'erc)
-(eval-when-compile (require 'pcomplete))
+;; Strictly speaking, should only be needed at compile time.
+;; Require at run-time too to silence compiler.
+(require 'pcomplete)
 
 ;;;###autoload(autoload 'erc-dcc-mode "erc-dcc")
 (define-erc-module dcc nil
diff --git a/lisp/eshell/em-cmpl.el b/lisp/eshell/em-cmpl.el
index 1f44007746..a9b29aef4c 100644
--- a/lisp/eshell/em-cmpl.el
+++ b/lisp/eshell/em-cmpl.el
@@ -167,6 +167,9 @@ to writing a completion function."
   (eshell-cmpl--custom-variable-docstring 'pcomplete-suffix-list)
   :type (get 'pcomplete-suffix-list 'custom-type)
   :group 'pcomplete)
+;; Only labelled obsolete in 26.1, but all it does it set
+;; pcomplete-suffix-list, which is itself obsolete since 24.1.
+(make-obsolete-variable 'eshell-cmpl-suffix-list nil "24.1")
 
 (defcustom eshell-cmpl-recexact nil
   (eshell-cmpl--custom-variable-docstring 'pcomplete-recexact)
@@ -259,8 +262,9 @@ to writing a completion function."
        eshell-cmpl-ignore-case)
   (set (make-local-variable 'pcomplete-autolist)
        eshell-cmpl-autolist)
-  (set (make-local-variable 'pcomplete-suffix-list)
-       eshell-cmpl-suffix-list)
+  (if (boundp 'pcomplete-suffix-list)
+      (set (make-local-variable 'pcomplete-suffix-list)
+           eshell-cmpl-suffix-list))
   (set (make-local-variable 'pcomplete-recexact)
        eshell-cmpl-recexact)
   (set (make-local-variable 'pcomplete-man-function)
@@ -434,7 +438,7 @@ to writing a completion function."
 	    (setq comps-in-path (cdr comps-in-path)))
 	  (setq paths (cdr paths)))
 	;; Add aliases which are currently visible, and Lisp functions.
-	(pcomplete-uniqify-list
+	(pcomplete-uniquify-list
 	 (if glob-name
 	     completions
 	   (setq completions
diff --git a/lisp/eshell/em-dirs.el b/lisp/eshell/em-dirs.el
index 37cb6b169a..ec380e6701 100644
--- a/lisp/eshell/em-dirs.el
+++ b/lisp/eshell/em-dirs.el
@@ -207,7 +207,7 @@ Thus, this does not include the current directory.")
   (when eshell-cd-on-directory
     (make-local-variable 'eshell-interpreter-alist)
     (setq eshell-interpreter-alist
-	  (cons (cons #'(lambda (file args)
+	  (cons (cons #'(lambda (file _args)
                           (eshell-lone-directory-p file))
 		      'eshell-dirs-substitute-cd)
 		eshell-interpreter-alist)))
@@ -282,7 +282,7 @@ Thus, this does not include the current directory.")
 (defvar pcomplete-stub)
 (defvar pcomplete-last-completion-raw)
 (declare-function pcomplete-actual-arg "pcomplete")
-(declare-function pcomplete-uniqify-list "pcomplete")
+(declare-function pcomplete-uniquify-list "pcomplete")
 
 (defun eshell-complete-user-reference ()
   "If there is a user reference, complete it."
@@ -293,14 +293,14 @@ Thus, this does not include the current directory.")
       (throw 'pcomplete-completions
 	     (progn
 	       (eshell-read-user-names)
-	       (pcomplete-uniqify-list
+	       (pcomplete-uniquify-list
 		(mapcar
 		 (function
 		  (lambda (user)
 		    (file-name-as-directory (cdr user))))
 		 eshell-user-names)))))))
 
-(defun eshell/pwd (&rest args)
+(defun eshell/pwd (&rest _args)
   "Change output from `pwd' to be cleaner."
   (let* ((path default-directory)
 	 (len (length path)))
diff --git a/lisp/eshell/em-pred.el b/lisp/eshell/em-pred.el
index 61af4048d5..b3b16d909b 100644
--- a/lisp/eshell/em-pred.el
+++ b/lisp/eshell/em-pred.el
@@ -131,7 +131,7 @@ The format of each entry is
     (?e . #'(lambda (lst) (mapcar 'file-name-extension lst)))
     (?t . #'(lambda (lst) (mapcar 'file-name-nondirectory lst)))
     (?q . #'(lambda (lst) (mapcar 'eshell-escape-arg lst)))
-    (?u . #'(lambda (lst) (eshell-uniqify-list lst)))
+    (?u . #'(lambda (lst) (eshell-uniquify-list lst)))
     (?o . #'(lambda (lst) (sort lst 'string-lessp)))
     (?O . #'(lambda (lst) (nreverse (sort lst 'string-lessp))))
     (?j . (eshell-join-members))
diff --git a/lisp/eshell/em-script.el b/lisp/eshell/em-script.el
index 1b0b220d5b..a5d8e96ba8 100644
--- a/lisp/eshell/em-script.el
+++ b/lisp/eshell/em-script.el
@@ -61,7 +61,7 @@ This includes when running `eshell-command'."
   "Initialize the script parsing code."
   (make-local-variable 'eshell-interpreter-alist)
   (setq eshell-interpreter-alist
-	(cons (cons #'(lambda (file args)
+	(cons (cons #'(lambda (file _args)
                         (string= (file-name-nondirectory file)
                                  "eshell"))
                     'eshell/source)
diff --git a/lisp/eshell/em-tramp.el b/lisp/eshell/em-tramp.el
index c45453bf28..004c495490 100644
--- a/lisp/eshell/em-tramp.el
+++ b/lisp/eshell/em-tramp.el
@@ -26,6 +26,7 @@
 ;;; Code:
 
 (require 'esh-util)
+(require 'esh-cmd)
 
 (eval-when-compile
   (require 'esh-mode)
diff --git a/lisp/eshell/em-unix.el b/lisp/eshell/em-unix.el
index c3448de407..a18fb85507 100644
--- a/lisp/eshell/em-unix.el
+++ b/lisp/eshell/em-unix.el
@@ -965,7 +965,7 @@ Show wall-clock time elapsed during execution of COMMAND.")
 				  (eshell-stringify-list
 				   (eshell-flatten-list (cdr time-args))))))))
 
-(defun eshell/whoami (&rest args)
+(defun eshell/whoami (&rest _args)
   "Make \"whoami\" Tramp aware."
   (or (file-remote-p default-directory 'user) (user-login-name)))
 
diff --git a/lisp/eshell/em-xtra.el b/lisp/eshell/em-xtra.el
index ce73474fb7..cc84d19854 100644
--- a/lisp/eshell/em-xtra.el
+++ b/lisp/eshell/em-xtra.el
@@ -25,8 +25,10 @@
 
 (require 'esh-util)
 (eval-when-compile
-  (require 'eshell)
-  (require 'pcomplete))
+  (require 'eshell))
+;; Strictly speaking, should only be needed at compile time.
+;; Require at run-time too to silence compiler.
+(require 'pcomplete)
 (require 'compile)
 
 ;; There are no items in this custom group, but eshell modules (ab)use
diff --git a/lisp/eshell/esh-ext.el b/lisp/eshell/esh-ext.el
index 1bfab23c22..ba5182deb4 100644
--- a/lisp/eshell/esh-ext.el
+++ b/lisp/eshell/esh-ext.el
@@ -37,8 +37,8 @@
 
 (eval-when-compile
   (require 'cl-lib)
-  (require 'esh-io)
   (require 'esh-cmd))
+(require 'esh-io)
 (require 'esh-arg)
 (require 'esh-opt)
 (require 'esh-proc)
diff --git a/lisp/eshell/esh-opt.el b/lisp/eshell/esh-opt.el
index 3af8fd7cac..b802696306 100644
--- a/lisp/eshell/esh-opt.el
+++ b/lisp/eshell/esh-opt.el
@@ -95,8 +95,8 @@ BODY-FORMS.  If instead an external command is run (because of
 an unknown option), the tag `eshell-external' will be thrown with
 the new process for its value.
 
-Lastly, any remaining arguments will be available in a locally
-interned variable `args' (created using a `let' form)."
+Lastly, any remaining arguments will be available in the locally
+let-bound variable `args'."
   (declare (debug (form form sexp body)))
   `(let* ((temp-args
            ,(if (memq ':preserve-args (cadr options))
@@ -111,6 +111,8 @@ interned variable `args' (created using a `let' form)."
                                ;; `options' is of the form (quote OPTS).
                                (cadr options))))
           (args processed-args))
+     ;; Silence unused lexical variable warning if body does not use `args'.
+     (ignore args)
      ,@body-forms))
 
 ;;; Internal Functions:
diff --git a/lisp/eshell/esh-proc.el b/lisp/eshell/esh-proc.el
index 59fb9b926d..b3bd7a7245 100644
--- a/lisp/eshell/esh-proc.el
+++ b/lisp/eshell/esh-proc.el
@@ -87,8 +87,8 @@ variable's value to take effect."
   "Called each time a process is exec'd by `eshell-gather-process-output'.
 It is passed one argument, which is the process that was just started.
 It is useful for things that must be done each time a process is
-executed in an eshell mode buffer (e.g., `process-kill-without-query').
-In contrast, `eshell-mode-hook' is only executed once when the buffer
+executed in an eshell mode buffer (e.g., `set-process-query-on-exit-flag').
+In contrast, `eshell-mode-hook' is only executed once, when the buffer
 is created."
   :type 'hook
   :group 'eshell-proc)
@@ -158,7 +158,7 @@ The signals which will cause this to happen are matched by
 
 (defalias 'eshell/wait 'eshell-wait-for-process)
 
-(defun eshell/jobs (&rest args)
+(defun eshell/jobs (&rest _args)
   "List processes, if there are any."
   (and (fboundp 'process-list)
        (process-list)
diff --git a/lisp/eshell/esh-util.el b/lisp/eshell/esh-util.el
index 5d38c27eb1..5ef1ae4129 100644
--- a/lisp/eshell/esh-util.el
+++ b/lisp/eshell/esh-util.el
@@ -295,7 +295,7 @@ Prepend remote identification of `default-directory', if any."
 	(nconc new-list (list a))))
     (cdr new-list)))
 
-(defun eshell-uniqify-list (l)
+(defun eshell-uniquify-list (l)
   "Remove occurring multiples in L.  You probably want to sort first."
   (let ((m l))
     (while m
@@ -305,6 +305,9 @@ Prepend remote identification of `default-directory', if any."
 	(setcdr m (cddr m)))
       (setq m (cdr m))))
   l)
+(define-obsolete-function-alias
+  'eshell-uniqify-list
+  'eshell-uniquify-list "27.1")
 
 (defun eshell-stringify (object)
   "Convert OBJECT into a string value."
diff --git a/lisp/eshell/esh-var.el b/lisp/eshell/esh-var.el
index 1af03d367c..b5dce80de8 100644
--- a/lisp/eshell/esh-var.el
+++ b/lisp/eshell/esh-var.el
@@ -343,6 +343,8 @@ This function is explicit for adding to `eshell-parse-argument-hook'."
 					       obarray 'boundp))
 	      (pcomplete-here))))
 
+;; FIXME the real "env" command does more than this, it runs a program
+;; in a modified environment.
 (defun eshell/env (&rest args)
   "Implementation of `env' in Lisp."
   (eshell-init-print-buffer)
diff --git a/lisp/ffap.el b/lisp/ffap.el
index 4e479d1b82..22be2f8536 100644
--- a/lisp/ffap.el
+++ b/lisp/ffap.el
@@ -248,7 +248,7 @@ it passes it on to `dired'."
 
 (defcustom ffap-newfile-prompt nil
   ;; Suggestion from RHOGEE, 11 Jul 1994.  Disabled, I think this is
-  ;; better handled by `find-file-not-found-hooks'.
+  ;; better handled by `find-file-not-found-functions'.
   "Whether `find-file-at-point' prompts about a nonexistent file."
   :type 'boolean
   :group 'ffap)
diff --git a/lisp/filenotify.el b/lisp/filenotify.el
index 5d37f39a70..59a8c0e88a 100644
--- a/lisp/filenotify.el
+++ b/lisp/filenotify.el
@@ -423,7 +423,7 @@ DESCRIPTOR should be an object returned by `file-notify-add-watch'."
 
 ;; TODO:
 ;; * Watching a /dir/file may receive events for dir.
-;;   (This may be the desired behaviour.)
+;;   (This may be the desired behavior.)
 ;; * Watching a file in an already watched directory
 ;;   If the file is created and *then* a watch is added to that file, the
 ;;   watch might receive events which occurred prior to it being created,
diff --git a/lisp/files.el b/lisp/files.el
index 4b67b02c38..8ec2bde588 100644
--- a/lisp/files.el
+++ b/lisp/files.el
@@ -473,7 +473,7 @@ location of point in the current buffer."
   :group 'find-file)
 
 ;;;It is not useful to make this a local variable.
-;;;(put 'find-file-not-found-hooks 'permanent-local t)
+;;;(put 'find-file-not-found-functions 'permanent-local t)
 (define-obsolete-variable-alias 'find-file-not-found-hooks
     'find-file-not-found-functions "22.1")
 (defvar find-file-not-found-functions nil
@@ -483,7 +483,8 @@ Variable `buffer-file-name' is already set up.
 The functions are called in the order given until one of them returns non-nil.")
 
 ;;;It is not useful to make this a local variable.
-;;;(put 'find-file-hooks 'permanent-local t)
+;;;(put 'find-file-hook 'permanent-local t)
+;; I found some external files still using the obsolete form in 2018.
 (define-obsolete-variable-alias 'find-file-hooks 'find-file-hook "22.1")
 (defcustom find-file-hook nil
   "List of functions to be called after a buffer is loaded from a file.
@@ -494,6 +495,7 @@ functions are called."
   :options '(auto-insert)
   :version "22.1")
 
+;; I found some external files still using the obsolete form in 2018.
 (define-obsolete-variable-alias 'write-file-hooks 'write-file-functions "22.1")
 (defvar write-file-functions nil
   "List of functions to be called before saving a buffer to a file.
@@ -513,11 +515,13 @@ node `(elisp)Saving Buffers'.)  To perform various checks or
 updates before the buffer is saved, use `before-save-hook'.")
 (put 'write-file-functions 'permanent-local t)
 
+;; I found some files still using the obsolete form in 2018.
 (defvar local-write-file-hooks nil)
 (make-variable-buffer-local 'local-write-file-hooks)
 (put 'local-write-file-hooks 'permanent-local t)
 (make-obsolete-variable 'local-write-file-hooks 'write-file-functions "22.1")
 
+;; I found some files still using the obsolete form in 2018.
 (define-obsolete-variable-alias 'write-contents-hooks
     'write-contents-functions "22.1")
 (defvar write-contents-functions nil
@@ -5206,9 +5210,14 @@ about certain files that you'd usually rather not save."
 
 (defun save-some-buffers (&optional arg pred)
   "Save some modified file-visiting buffers.  Asks user about each one.
-You can answer `y' to save, `n' not to save, `C-r' to look at the
-buffer in question with `view-buffer' before deciding or `d' to
-view the differences using `diff-buffer-with-file'.
+You can answer `y' or SPC to save, `n' or DEL not to save, `C-r'
+to look at the buffer in question with `view-buffer' before
+deciding, `d' to view the differences using
+`diff-buffer-with-file', `!' to save the buffer and all remaining
+buffers without any further querying, `.' to save only the
+current buffer and skip the remaining ones and `q' or RET to exit
+the function without saving any more buffers.  `C-h' displays a
+help message describing these options.
 
 This command first saves any buffers where `buffer-save-without-query' is
 non-nil, without asking.
diff --git a/lisp/frame.el b/lisp/frame.el
index 0ed7d6a64f..fbf2f6e773 100644
--- a/lisp/frame.el
+++ b/lisp/frame.el
@@ -614,9 +614,6 @@ frame.")
 (defvar after-setting-font-hook nil
   "Functions to run after a frame's font has been changed.")
 
-;; Alias, kept temporarily.
-(define-obsolete-function-alias 'new-frame 'make-frame "22.1")
-
 (defvar frame-inherited-parameters '()
   "Parameters `make-frame' copies from the selected to the new frame.")
 
@@ -1147,8 +1144,6 @@ FRAME defaults to the selected frame."
 (declare-function x-list-fonts "xfaces.c"
                   (pattern &optional face frame maximum width))
 
-(define-obsolete-function-alias 'set-default-font 'set-frame-font "23.1")
-
 (defun set-frame-font (font &optional keep-size frames)
   "Set the default font to FONT.
 When called interactively, prompt for the name of a font, and use
@@ -2113,10 +2108,6 @@ a live frame and defaults to the selected one."
         (delete-frame this))
       (setq this next))))
 
-;; miscellaneous obsolescence declarations
-(define-obsolete-variable-alias 'delete-frame-hook
-    'delete-frame-functions "22.1")
-
 
 ;;; Window dividers.
 (defgroup window-divider nil
@@ -2352,8 +2343,6 @@ This is done when a frame gets focus.  Blink timers may be stopped by
     (remove-hook 'post-command-hook 'blink-cursor-check)
     (blink-cursor--start-idle-timer)))
 
-(define-obsolete-variable-alias 'blink-cursor 'blink-cursor-mode "22.1")
-
 (define-minor-mode blink-cursor-mode
   "Toggle cursor blinking (Blink Cursor mode).
 With a prefix argument ARG, enable Blink Cursor mode if ARG is
@@ -2439,7 +2428,7 @@ See also `toggle-frame-maximized'."
        frame `((fullscreen . fullboth) (fullscreen-restore . ,fullscreen))))
     ;; Manipulating a frame without waiting for the fullscreen
     ;; animation to complete can cause a crash, or other unexpected
-    ;; behaviour, on macOS (bug#28496).
+    ;; behavior, on macOS (bug#28496).
     (when (featurep 'cocoa) (sleep-for 0.5))))
 
 
diff --git a/lisp/generic-x.el b/lisp/generic-x.el
index 3e3ddc5ceb..d8a7fe3a73 100644
--- a/lisp/generic-x.el
+++ b/lisp/generic-x.el
@@ -241,30 +241,11 @@ This hook will be installed if the variable
     spice-generic-mode)
   "List of generic modes that are not defined by default.")
 
-(defcustom generic-define-mswindows-modes
-  (memq system-type '(windows-nt ms-dos))
-  "Non-nil means the modes in `generic-mswindows-modes' will be defined.
-This is a list of MS-Windows specific generic modes.  This variable
-only affects the default value of `generic-extras-enable-list'."
-  :group 'generic-x
-  :type 'boolean
-  :version "22.1")
-(make-obsolete-variable 'generic-define-mswindows-modes 'generic-extras-enable-list "22.1")
-
-(defcustom generic-define-unix-modes
-  (not (memq system-type '(windows-nt ms-dos)))
-  "Non-nil means the modes in `generic-unix-modes' will be defined.
-This is a list of Unix specific generic modes.  This variable only
-affects the default value of `generic-extras-enable-list'."
-  :group 'generic-x
-  :type 'boolean
-  :version "22.1")
-(make-obsolete-variable 'generic-define-unix-modes 'generic-extras-enable-list "22.1")
-
 (defcustom generic-extras-enable-list
   (append generic-default-modes
-	  (if generic-define-mswindows-modes generic-mswindows-modes)
-	  (if generic-define-unix-modes generic-unix-modes)
+          (if (memq system-type '(windows-nt ms-dos))
+              generic-mswindows-modes
+            generic-unix-modes)
 	  nil)
   "List of generic modes to define.
 Each entry in the list should be a symbol.  If you set this variable
diff --git a/lisp/gnus/gnus-score.el b/lisp/gnus/gnus-score.el
index ec07d1ab15..ad11ff4a5c 100644
--- a/lisp/gnus/gnus-score.el
+++ b/lisp/gnus/gnus-score.el
@@ -514,7 +514,7 @@ of the last successful match.")
   "f" gnus-score-edit-file
   "F" gnus-score-flush-cache
   "t" gnus-score-find-trace
-  "w" gnus-score-find-favourite-words)
+  "w" gnus-score-find-favorite-words)
 
 ;; Summary score file commands
 
@@ -2517,7 +2517,7 @@ the score file and its full name, including the directory.")
     (set-buffer gnus-summary-buffer)
     (setq gnus-newsgroup-scored old-scored)))
 
-(defun gnus-score-find-favourite-words ()
+(defun gnus-score-find-favorite-words ()
   "List words used in scoring."
   (interactive)
   (let ((alists (gnus-score-load-files (gnus-all-score-files)))
@@ -2553,6 +2553,9 @@ the score file and its full name, including the directory.")
 	(pop rules))
       (goto-char (point-min))
       (gnus-configure-windows 'score-words))))
+(define-obsolete-function-alias
+  'gnus-score-find-favourite-words
+  'gnus-score-find-favorite-words "27.1")
 
 (defun gnus-summary-rescore ()
   "Redo the entire scoring process in the current summary."
diff --git a/lisp/gnus/gnus-sum.el b/lisp/gnus/gnus-sum.el
index a28c00be94..468f2b195e 100644
--- a/lisp/gnus/gnus-sum.el
+++ b/lisp/gnus/gnus-sum.el
@@ -2370,7 +2370,7 @@ increase the score of each group you read."
 	  ["Edit current score file" gnus-score-edit-current-scores t]
 	  ["Edit score file..." gnus-score-edit-file t]
 	  ["Trace score" gnus-score-find-trace t]
-	  ["Find words" gnus-score-find-favourite-words t]
+	  ["Find words" gnus-score-find-favorite-words t]
 	  ["Rescore buffer" gnus-summary-rescore t]
 	  ["Increase score..." gnus-summary-increase-score t]
 	  ["Lower score..." gnus-summary-lower-score t]))))
diff --git a/lisp/gnus/gnus.el b/lisp/gnus/gnus.el
index 123b64ac6c..fb2ae192f1 100644
--- a/lisp/gnus/gnus.el
+++ b/lisp/gnus/gnus.el
@@ -752,6 +752,7 @@ be set in `.emacs' instead."
   (cdr (assq gnus-logo-color-style gnus-logo-color-alist))
   "Colors used for the Gnus logo.")
 
+(defvar image-load-path)
 (declare-function image-size "image.c" (spec &optional pixels frame))
 
 (defun gnus-group-startup-message (&optional x y)
diff --git a/lisp/gnus/mm-decode.el b/lisp/gnus/mm-decode.el
index e1a0435b55..372b6da44b 100644
--- a/lisp/gnus/mm-decode.el
+++ b/lisp/gnus/mm-decode.el
@@ -1,4 +1,4 @@
-;;; mm-decode.el --- Functions for decoding MIME things
+;;; mm-decode.el --- Functions for decoding MIME things  -*- lexical-binding:t -*-
 
 ;; Copyright (C) 1998-2018 Free Software Foundation, Inc.
 
@@ -773,15 +773,16 @@ MIME-Version header before proceeding."
       (insert-buffer-substring obuf beg)
       (current-buffer))))
 
-(defun mm-display-parts (handle &optional no-default)
-  (if (stringp (car handle))
-      (mapcar 'mm-display-parts (cdr handle))
-    (if (bufferp (car handle))
-	(save-restriction
-	  (narrow-to-region (point) (point))
-	  (mm-display-part handle)
-	  (goto-char (point-max)))
-      (mapcar 'mm-display-parts handle))))
+(defun mm-display-parts (handle)
+  (cond
+   ((stringp (car handle)) (mapcar #'mm-display-parts (cdr handle)))
+   ((bufferp (car handle))
+    (save-restriction
+      (narrow-to-region (point) (point))
+      (mm-display-part handle)
+      (goto-char (point-max))))
+   (t
+    (mapcar #'mm-display-parts handle))))
 
 (autoload 'mailcap-parse-mailcaps "mailcap")
 (autoload 'mailcap-mime-info "mailcap")
@@ -961,15 +962,15 @@ external if displayed external."
 				      mm-external-terminal-program
 				      "-e" shell-file-name
 				      shell-command-switch command)
-		       `(lambda (process state)
-			  (if (eq 'exit (process-status process))
-			      (run-at-time
-			       60.0 nil
-			       (lambda ()
-				 (ignore-errors (delete-file ,file))
-				 (ignore-errors (delete-directory
-						 ,(file-name-directory
-						   file))))))))
+		       (lambda (process _state)
+			 (if (eq 'exit (process-status process))
+			     (run-at-time
+			      60.0 nil
+			      (lambda ()
+				(ignore-errors (delete-file file))
+				(ignore-errors (delete-directory
+						(file-name-directory
+						 file))))))))
 		    (require 'term)
 		    (require 'gnus-win)
 		    (set-buffer
@@ -982,13 +983,13 @@ external if displayed external."
 		    (term-char-mode)
 		    (set-process-sentinel
 		     (get-buffer-process buffer)
-		     `(lambda (process state)
-			(when (eq 'exit (process-status process))
-			  (ignore-errors (delete-file ,file))
-			  (ignore-errors
-			    (delete-directory ,(file-name-directory file)))
-			  (gnus-configure-windows
-			   ',gnus-current-window-configuration))))
+                     (let ((wc gnus-current-window-configuration))
+		       (lambda (process _state)
+			 (when (eq 'exit (process-status process))
+			   (ignore-errors (delete-file file))
+			   (ignore-errors
+			     (delete-directory (file-name-directory file)))
+			   (gnus-configure-windows wc)))))
 		    (gnus-configure-windows 'display-term))
 		(mm-handle-set-external-undisplayer handle (cons file buffer))
 		(add-to-list 'mm-temp-files-to-be-deleted file t))
@@ -1032,34 +1033,29 @@ external if displayed external."
 				   shell-command-switch command)
 		    (set-process-sentinel
 		     (get-buffer-process buffer)
-		     (lexical-let ((outbuf outbuf)
-				   (file file)
-				   (buffer buffer)
-				   (command command)
-				   (handle handle))
-		       (lambda (process state)
-			 (when (eq (process-status process) 'exit)
-			   (run-at-time
-			    60.0 nil
-			    (lambda ()
-			      (ignore-errors (delete-file file))
-			      (ignore-errors (delete-directory
-					      (file-name-directory file)))))
-			   (when (buffer-live-p outbuf)
-			     (with-current-buffer outbuf
-			       (let ((buffer-read-only nil)
-				     (point (point)))
-				 (forward-line 2)
-				 (let ((start (point)))
-				   (mm-insert-inline
-				    handle (with-current-buffer buffer
-					     (buffer-string)))
-				   (put-text-property start (point)
-						      'face 'mm-command-output))
-				 (goto-char point))))
-			   (when (buffer-live-p buffer)
-			     (kill-buffer buffer)))
-			 (message "Displaying %s...done" command)))))
+		     (lambda (process _state)
+		       (when (eq (process-status process) 'exit)
+			 (run-at-time
+			  60.0 nil
+			  (lambda ()
+			    (ignore-errors (delete-file file))
+			    (ignore-errors (delete-directory
+					    (file-name-directory file)))))
+			 (when (buffer-live-p outbuf)
+			   (with-current-buffer outbuf
+			     (let ((buffer-read-only nil)
+				   (point (point)))
+			       (forward-line 2)
+			       (let ((start (point)))
+				 (mm-insert-inline
+				  handle (with-current-buffer buffer
+					   (buffer-string)))
+				 (put-text-property start (point)
+						    'face 'mm-command-output))
+			       (goto-char point))))
+			 (when (buffer-live-p buffer)
+			   (kill-buffer buffer)))
+		       (message "Displaying %s...done" command))))
 		(mm-handle-set-external-undisplayer
 		 handle (cons file buffer))
 		(add-to-list 'mm-temp-files-to-be-deleted file t))
@@ -1170,9 +1166,9 @@ external if displayed external."
     (goto-char (point-min))))
 
 (defun mm-assoc-string-match (alist type)
-  (dolist (elem alist)
+  (cl-dolist (elem alist)
     (when (string-match (car elem) type)
-      (return elem))))
+      (cl-return elem))))
 
 (defun mm-automatic-display-p (handle)
   "Say whether the user wants HANDLE to be displayed automatically."
@@ -1302,8 +1298,6 @@ are ignored."
 			 'gnus-decoded)
 		     (with-current-buffer (mm-handle-buffer handle)
 		       (buffer-string)))
-		    ((mm-multibyte-p)
-		     (string-to-multibyte (mm-get-part handle no-cache)))
 		    (t
 		     (mm-get-part handle no-cache)))))
     (save-restriction
@@ -1448,8 +1442,7 @@ text/html\\(?:;\\s-*charset=\\([^\t\n\r \"'>]+\\)\\)?[^>]*>" nil t)
 (defun mm-pipe-part (handle &optional cmd)
   "Pipe HANDLE to a process.
 Use CMD as the process."
-  (let ((name (mail-content-type-get (mm-handle-type handle) 'name))
-	(command (or cmd
+  (let ((command (or cmd
 		     (read-shell-command
 		      "Shell command on MIME part: " mm-last-shell-command))))
     (mm-with-unibyte-buffer
@@ -1784,6 +1777,9 @@ If RECURSIVE, search recursively."
 (declare-function shr-insert-document "shr" (dom))
 (defvar shr-blocked-images)
 (defvar shr-use-fonts)
+(defvar shr-width)
+(defvar shr-content-function)
+(defvar shr-inhibit-images)
 
 (defun mm-shr (handle)
   ;; Require since we bind its variables.
@@ -1840,10 +1836,11 @@ text/html;\\s-*charset=\\([^\t\n\r \"'>]+\\)[^>]*>" nil t)
       (mm-convert-shr-links)
       (mm-handle-set-undisplayer
        handle
-       `(lambda ()
-	  (let ((inhibit-read-only t))
-	    (delete-region ,(point-min-marker)
-			   ,(point-max-marker))))))))
+       (let ((min (point-min-marker))
+             (max (point-max-marker)))
+         (lambda ()
+	   (let ((inhibit-read-only t))
+	     (delete-region min max))))))))
 
 (defvar shr-image-map)
 
diff --git a/lisp/gnus/mm-extern.el b/lisp/gnus/mm-extern.el
index e2f8bd4af3..fbae669ce9 100644
--- a/lisp/gnus/mm-extern.el
+++ b/lisp/gnus/mm-extern.el
@@ -1,4 +1,4 @@
-;;; mm-extern.el --- showing message/external-body
+;;; mm-extern.el --- showing message/external-body  -*- lexical-binding:t -*-
 
 ;; Copyright (C) 2000-2018 Free Software Foundation, Inc.
 
@@ -24,8 +24,6 @@
 
 ;;; Code:
 
-(eval-when-compile (require 'cl))
-
 (require 'mm-util)
 (require 'mm-decode)
 (require 'mm-url)
@@ -33,13 +31,13 @@
 (defvar gnus-article-mime-handles)
 
 (defvar mm-extern-function-alist
-  '((local-file . mm-extern-local-file)
-    (url . mm-extern-url)
-    (anon-ftp . mm-extern-anon-ftp)
-    (ftp . mm-extern-ftp)
-;;;     (tftp . mm-extern-tftp)
-    (mail-server . mm-extern-mail-server)
-;;;     (afs . mm-extern-afs))
+  `((local-file . ,#'mm-extern-local-file)
+    (url . ,#'mm-extern-url)
+    (anon-ftp . ,#'mm-extern-anon-ftp)
+    (ftp . ,#'mm-extern-ftp)
+    ;; (tftp . ,#'mm-extern-tftp)
+    (mail-server . ,#'mm-extern-mail-server)
+    ;; (afs . ,#'mm-extern-afs))
     ))
 
 (defvar mm-extern-anonymous "anonymous")
@@ -72,7 +70,6 @@
 	 (name (cdr (assq 'name params)))
 	 (site (cdr (assq 'site params)))
 	 (directory (cdr (assq 'directory params)))
-	 (mode (cdr (assq 'mode params)))
 	 (path (concat "/" (or mm-extern-anonymous
 			       (read-string (format "ID for %s: " site)))
 		       "@" site ":" directory "/" name))
diff --git a/lisp/gnus/mml-sec.el b/lisp/gnus/mml-sec.el
index 099e5372b4..dc10763da8 100644
--- a/lisp/gnus/mml-sec.el
+++ b/lisp/gnus/mml-sec.el
@@ -647,6 +647,7 @@ The passphrase is read and cached."
       (when passphrase
 	(let ((password-cache-expiry (mml-secure-cache-expiry-interval
 				      (epg-context-protocol context))))
+	  ;; FIXME test passphrase works before caching it.
 	  (password-cache-add password-cache-key-id passphrase))
 	(mml-secure-add-secret-key-id password-cache-key-id)
 	(copy-sequence passphrase)))))
@@ -903,7 +904,7 @@ If no one is selected, symmetric encryption will be performed.  "
 (defun mml-secure-epg-encrypt (protocol cont &optional sign)
   ;; Based on code appearing inside mml2015-epg-encrypt.
   (let* ((context (epg-make-context protocol))
-	 (config (epg-configuration))
+	 (config (epg-find-configuration 'OpenPGP))
 	 (sender (message-options-get 'message-sender))
 	 (recipients (mml-secure-recipients protocol context config sender))
 	 (signer-names (mml-secure-signer-names protocol sender))
diff --git a/lisp/gnus/nnheader.el b/lisp/gnus/nnheader.el
index 14bd14924f..77afb09a2a 100644
--- a/lisp/gnus/nnheader.el
+++ b/lisp/gnus/nnheader.el
@@ -945,7 +945,7 @@ first.  Otherwise, find the newest one, though it may take a time."
   "Like `insert-file-contents', q.v., but only reads in the file.
 A buffer may be modified in several ways after reading into the buffer due
 to advanced Emacs features, such as file-name-handlers, format decoding,
-find-file-hooks, etc.
+find-file-hook, etc.
   This function ensures that none of these modifications will take place."
   (let ((coding-system-for-read nnheader-file-coding-system))
     (mm-insert-file-contents filename visit beg end replace)))
diff --git a/lisp/gnus/nnir.el b/lisp/gnus/nnir.el
index 55e00a0b69..0a7d829614 100644
--- a/lisp/gnus/nnir.el
+++ b/lisp/gnus/nnir.el
@@ -644,7 +644,7 @@ skips all prompting."
       (add-hook 'gnus-summary-mode-hook 'nnir-mode)
       (nnoo-change-server 'nnir server definitions))))
 
-(deffoo nnir-request-group (group &optional server dont-check info)
+(deffoo nnir-request-group (group &optional server dont-check _info)
   (nnir-possibly-change-group group server)
   (let ((pgroup (gnus-group-guess-full-name-from-command-method group))
 	length)
@@ -669,7 +669,9 @@ skips all prompting."
                          group)))) ; group name
   nnir-artlist)
 
-(deffoo nnir-retrieve-headers (articles &optional group server fetch-old)
+(defvar gnus-inhibit-demon)
+
+(deffoo nnir-retrieve-headers (articles &optional _group _server _fetch-old)
   (with-current-buffer nntp-server-buffer
     (let ((gnus-inhibit-demon t)
 	  (articles-by-group (nnir-categorize
@@ -716,6 +718,8 @@ skips all prompting."
       (mapc 'nnheader-insert-nov headers)
       'nov)))
 
+(defvar gnus-article-decode-hook)
+
 (deffoo nnir-request-article (article &optional group server to-buffer)
   (nnir-possibly-change-group group server)
   (if (and (stringp article)
@@ -753,7 +757,7 @@ skips all prompting."
             (cons artfullgroup artno)))))))
 
 (deffoo nnir-request-move-article (article group server accept-form
-					   &optional last internal-move-group)
+					   &optional last _internal-move-group)
   (nnir-possibly-change-group group server)
   (let* ((artfullgroup (nnir-article-group article))
 	 (artno (nnir-article-number article))
@@ -803,7 +807,8 @@ skips all prompting."
 		(error "Can't warp to a pseudo-article")))
 	 (backend-article-group (nnir-article-group cur))
          (backend-article-number (nnir-article-number cur))
-	 (quit-config (gnus-ephemeral-group-p gnus-newsgroup-name)))
+;	 (quit-config (gnus-ephemeral-group-p gnus-newsgroup-name))
+	 )
 
     ;; what should we do here? we could leave all the buffers around
     ;; and assume that we have to exit from them one by one. or we can
@@ -818,7 +823,7 @@ skips all prompting."
     (gnus-summary-read-group-1 backend-article-group t t  nil
                                nil (list backend-article-number))))
 
-(deffoo nnir-request-update-mark (group article mark)
+(deffoo nnir-request-update-mark (_group article mark)
   (let ((artgroup (nnir-article-group article))
 	(artnumber (nnir-article-number article)))
     (or (and artgroup
@@ -956,7 +961,7 @@ details on the language and supported extensions."
   (save-excursion
     (let ((qstring (cdr (assq 'query query)))
           (server (cadr (gnus-server-to-method srv)))
-          (defs (nth 2 (gnus-server-to-method srv)))
+;;          (defs (nth 2 (gnus-server-to-method srv)))
           (criteria (or (cdr (assq 'criteria query))
                         (cdr (assoc nnir-imap-default-search-key
                                     nnir-imap-search-arguments))))
@@ -1177,7 +1182,7 @@ returning the one at the supplied position."
 ;; - article number
 ;; - file size
 ;; - group
-(defun nnir-run-swish++ (query server &optional group)
+(defun nnir-run-swish++ (query server &optional _group)
   "Run QUERY against swish++.
 Returns a vector of (group name, file name) pairs (also vectors,
 actually).
@@ -1267,7 +1272,7 @@ Windows NT 4.0."
                                   (nnir-artitem-rsv y)))))))))
 
 ;; Swish-E interface.
-(defun nnir-run-swish-e (query server &optional group)
+(defun nnir-run-swish-e (query server &optional _group)
   "Run given query against swish-e.
 Returns a vector of (group name, file name) pairs (also vectors,
 actually).
@@ -1433,7 +1438,7 @@ Tested with swish-e-2.0.1 on Windows NT 4.0."
       )))
 
 ;; Namazu interface
-(defun nnir-run-namazu (query server &optional group)
+(defun nnir-run-namazu (query server &optional _group)
   "Run given query against Namazu.  Returns a vector of (group name, file name)
 pairs (also vectors, actually).
 
@@ -1502,7 +1507,7 @@ Tested with Namazu 2.0.6 on a GNU/Linux system."
                                (> (nnir-artitem-rsv x)
                                   (nnir-artitem-rsv y)))))))))
 
-(defun nnir-run-notmuch (query server &optional group)
+(defun nnir-run-notmuch (query server &optional _group)
   "Run QUERY against notmuch.
 Returns a vector of (group name, file name) pairs (also vectors,
 actually)."
@@ -1667,7 +1672,7 @@ actually)."
   "Run a search against a gmane back-end server."
       (let* ((case-fold-search t)
 	     (qstring (cdr (assq 'query query)))
-	     (server (cadr (gnus-server-to-method srv)))
+;;	     (server (cadr (gnus-server-to-method srv)))
 	     (groupspec (mapconcat
 			 (lambda (x)
 			   (if (string-match-p "gmane" x)
@@ -1809,8 +1814,7 @@ article came from is also searched."
 	groups)
     (gnus-request-list method)
     (with-current-buffer nntp-server-buffer
-      (let ((cur (current-buffer))
-	    name)
+      (let ((cur (current-buffer)))
 	(goto-char (point-min))
 	(unless (or (null nnir-ignored-newsgroups)
 		    (string= nnir-ignored-newsgroups ""))
@@ -1851,7 +1855,7 @@ article came from is also searched."
 (declare-function gnus-registry-action "gnus-registry"
                   (action data-header from &optional to method))
 
-(defun nnir-registry-action (action data-header from &optional to method)
+(defun nnir-registry-action (action data-header _from &optional to method)
   "Call `gnus-registry-action' with the original article group."
   (gnus-registry-action
    action
@@ -1886,7 +1890,7 @@ article came from is also searched."
        (gnus-group-find-parameter pgroup)))))
 
 
-(deffoo nnir-request-create-group (group &optional server args)
+(deffoo nnir-request-create-group (group &optional _server args)
   (message "Creating nnir group %s" group)
   (let* ((group (gnus-group-prefixed-name  group '(nnir "nnir")))
          (specs (assq 'nnir-specs args))
@@ -1907,13 +1911,13 @@ article came from is also searched."
     (nnir-request-update-info group (gnus-get-info group)))
   t)
 
-(deffoo nnir-request-delete-group (group &optional force server)
+(deffoo nnir-request-delete-group (_group &optional _force _server)
   t)
 
-(deffoo nnir-request-list (&optional server)
+(deffoo nnir-request-list (&optional _server)
   t)
 
-(deffoo nnir-request-scan (group method)
+(deffoo nnir-request-scan (_group _method)
   t)
 
 (deffoo nnir-request-close ()
diff --git a/lisp/gnus/nnmaildir.el b/lisp/gnus/nnmaildir.el
index 3e4a87cee7..dc97b32f0b 100644
--- a/lisp/gnus/nnmaildir.el
+++ b/lisp/gnus/nnmaildir.el
@@ -1779,14 +1779,11 @@ This variable is set by `nnmaildir-request-article'.")
       t)))
 
 (defun nnmaildir-close-server (&optional server)
-  (defvar flist) (defvar ls) (defvar dirs) (defvar dir)
-  (defvar files) (defvar file) (defvar x)
-  (let (flist ls dirs dir files file x)
-    (nnmaildir--prepare server nil)
-    (when nnmaildir--cur-server
-      (setq server nnmaildir--cur-server
-	    nnmaildir--cur-server nil)
-      (unintern (nnmaildir--srv-address server) nnmaildir--servers)))
+  (nnmaildir--prepare server nil)
+  (when nnmaildir--cur-server
+    (setq server nnmaildir--cur-server
+	  nnmaildir--cur-server nil)
+    (unintern (nnmaildir--srv-address server) nnmaildir--servers))
   t)
 
 (defun nnmaildir-request-close ()
diff --git a/lisp/gnus/smime.el b/lisp/gnus/smime.el
index 3e722d2d82..ab2a5b0f81 100644
--- a/lisp/gnus/smime.el
+++ b/lisp/gnus/smime.el
@@ -234,10 +234,12 @@ must be set in `ldap-host-parameters-alist'."
 If `cache-key' and `password-cache' is non-nil then cache the
 password under `cache-key'."
   (let ((passphrase
-	 (password-read-and-add
+	 (password-read
 	  "Passphrase for secret key (RET for no passphrase): " cache-key)))
     (if (string= passphrase "")
 	nil
+      ;; FIXME test passphrase works before caching it.
+      (and passphrase cache-key (password-cache-add cache-key passphrase))
       passphrase)))
 
 ;; OpenSSL wrappers.
diff --git a/lisp/gnus/spam.el b/lisp/gnus/spam.el
index de8aa77efc..97e63404c4 100644
--- a/lisp/gnus/spam.el
+++ b/lisp/gnus/spam.el
@@ -408,16 +408,12 @@ Only meaningful if you enable `spam-use-regex-body'."
   "Spam ifile configuration."
   :group 'spam)
 
-(make-obsolete-variable 'spam-ifile-path 'spam-ifile-program
-                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-ifile-program (executable-find "ifile")
   "Name of the ifile program."
   :type '(choice (file :tag "Location of ifile")
                  (const :tag "ifile is not installed"))
   :group 'spam-ifile)
 
-(make-obsolete-variable 'spam-ifile-database-path 'spam-ifile-database
-                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-ifile-database nil
   "File name of the ifile database."
   :type '(choice (file :tag "Location of the ifile database")
@@ -447,8 +443,6 @@ your main source of newsgroup names."
   "Spam bogofilter configuration."
   :group 'spam)
 
-(make-obsolete-variable 'spam-bogofilter-path 'spam-bogofilter-program
-                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-bogofilter-program (executable-find "bogofilter")
   "Name of the Bogofilter program."
   :type '(choice (file :tag "Location of bogofilter")
@@ -499,8 +493,6 @@ When nil, use the default location."
   "Spam bsfilter configuration."
   :group 'spam)
 
-(make-obsolete-variable 'spam-bsfilter-path 'spam-bsfilter-program
-                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-bsfilter-program (executable-find "bsfilter")
   "Name of the Bsfilter program."
   :type '(choice (file :tag "Location of bsfilter")
@@ -565,8 +557,6 @@ When nil, use the default spamoracle database."
   "Spam SpamAssassin configuration."
   :group 'spam)
 
-(make-obsolete-variable 'spam-spamassassin-path
-  'spam-spamassassin-program "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-assassin-program (executable-find "spamassassin")
   "Name of the spamassassin program.
 Hint: set this to \"spamc\" if you have spamd running.  See the spamc and
@@ -597,8 +587,6 @@ identification"
   :type 'string
   :group 'spam-spamassassin)
 
-(make-obsolete-variable 'spam-sa-learn-path 'spam-sa-learn-program
-                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-sa-learn-program (executable-find "sa-learn")
   "Name of the sa-learn program."
   :type '(choice (file :tag "Location of spamassassin")
@@ -1256,73 +1244,40 @@ Will not return a nil score."
         (setq found backend)))
     found))
 
-(defvar spam-list-of-processors
-  ;; note the nil processors are not defined in gnus.el
-  '((gnus-group-spam-exit-processor-bogofilter   spam spam-use-bogofilter)
-    (gnus-group-spam-exit-processor-bsfilter     spam spam-use-bsfilter)
-    (gnus-group-spam-exit-processor-blacklist    spam spam-use-blacklist)
-    (gnus-group-spam-exit-processor-ifile        spam spam-use-ifile)
-    (gnus-group-spam-exit-processor-stat         spam spam-use-stat)
-    (gnus-group-spam-exit-processor-spamoracle   spam spam-use-spamoracle)
-    (gnus-group-spam-exit-processor-spamassassin spam spam-use-spamassassin)
-    (gnus-group-spam-exit-processor-report-gmane spam spam-use-gmane) ;; Buggy?
-    (gnus-group-ham-exit-processor-ifile         ham spam-use-ifile)
-    (gnus-group-ham-exit-processor-bogofilter    ham spam-use-bogofilter)
-    (gnus-group-ham-exit-processor-bsfilter      ham spam-use-bsfilter)
-    (gnus-group-ham-exit-processor-stat          ham spam-use-stat)
-    (gnus-group-ham-exit-processor-whitelist     ham spam-use-whitelist)
-    (gnus-group-ham-exit-processor-BBDB          ham spam-use-BBDB)
-    (gnus-group-ham-exit-processor-copy          ham spam-use-ham-copy)
-    (gnus-group-ham-exit-processor-spamassassin  ham spam-use-spamassassin)
-    (gnus-group-ham-exit-processor-spamoracle    ham spam-use-spamoracle))
-  "The OBSOLETE `spam-list-of-processors' list.
-This list contains pairs associating the obsolete ham/spam exit
-processor variables with a classification and a spam-use-*
-variable.  When the processor variable is nil, just the
-classification and spam-use-* check variable are used.  This is
-superseded by the new spam backend code, so it's only consulted
-for backwards compatibility.")
-(make-obsolete-variable 'spam-list-of-processors nil "22.1")
-
 (defun spam-group-processor-p (group backend &optional classification)
   "Checks if GROUP has a BACKEND with CLASSIFICATION registered.
-Also accepts the obsolete processors, which can be found in
-gnus.el and in spam-list-of-processors.  In the case of mover
-backends, checks the setting of `spam-summary-exit-behavior' in
-addition to the set values for the group."
+In the case of mover backends, checks the setting of
+`spam-summary-exit-behavior' in addition to the set values for the group."
   (if (and (stringp group)
            (symbolp backend))
-      (let ((old-style (assq backend spam-list-of-processors))
-            (parameters (nth 0 (gnus-parameter-spam-process group)))
+      (let ((parameters (nth 0 (gnus-parameter-spam-process group)))
             found)
-        (if old-style  ; old-style processor
-            (spam-group-processor-p group (nth 2 old-style) (nth 1 old-style))
-          ;; now search for the parameter
-          (dolist (parameter parameters)
-            (when (and (null found)
-                       (listp parameter)
-                       (eq classification (nth 0 parameter))
-                       (eq backend (nth 1 parameter)))
-              (setq found t)))
-
-          ;; now, if the parameter was not found, do the
-          ;; spam-summary-exit-behavior-logic for mover backends
-          (unless found
-            (when (spam-backend-mover-p backend)
-              (setq
-               found
-               (cond
-                ((eq spam-summary-exit-behavior 'move-all) t)
-                ((eq spam-summary-exit-behavior 'move-none) nil)
-                ((eq spam-summary-exit-behavior 'default)
-                 (or (eq classification 'spam) ;move spam out of all groups
-                     ;; move ham out of spam groups
-                     (and (eq classification 'ham)
-                          (spam-group-spam-contents-p group))))
-                (t (gnus-error 5 "Unknown spam-summary-exit-behavior: %s"
-                               spam-summary-exit-behavior))))))
-
-          found))
+        ;; now search for the parameter
+        (dolist (parameter parameters)
+          (when (and (null found)
+                     (listp parameter)
+                     (eq classification (nth 0 parameter))
+                     (eq backend (nth 1 parameter)))
+            (setq found t)))
+
+        ;; now, if the parameter was not found, do the
+        ;; spam-summary-exit-behavior-logic for mover backends
+        (unless found
+          (when (spam-backend-mover-p backend)
+            (setq
+             found
+             (cond
+              ((eq spam-summary-exit-behavior 'move-all) t)
+              ((eq spam-summary-exit-behavior 'move-none) nil)
+              ((eq spam-summary-exit-behavior 'default)
+               (or (eq classification 'spam) ;move spam out of all groups
+                   ;; move ham out of spam groups
+                   (and (eq classification 'ham)
+                        (spam-group-spam-contents-p group))))
+              (t (gnus-error 5 "Unknown spam-summary-exit-behavior: %s"
+                             spam-summary-exit-behavior))))))
+
+        found)
     nil))
 
 ;;}}}
diff --git a/lisp/help.el b/lisp/help.el
index e923546032..0830dc5d3c 100644
--- a/lisp/help.el
+++ b/lisp/help.el
@@ -308,8 +308,6 @@ If that doesn't give a function, return nil."
   (interactive)
   (browse-url "https://www.gnu.org/gnu/thegnuproject.html"))
 
-(define-obsolete-function-alias 'describe-project 'describe-gnu-project "22.2")
-
 (defun describe-no-warranty ()
   "Display info on all the kinds of warranty Emacs does NOT have."
   (interactive)
@@ -413,9 +411,6 @@ With argument, display info only for the selected version."
   (interactive "P")
   (view-help-file "TODO"))
 
-(define-obsolete-function-alias 'view-todo 'view-emacs-todo "22.2")
-
-
 (defun view-echo-area-messages ()
   "View the log of recent echo-area messages: the `*Messages*' buffer.
 The number of messages retained in that buffer
diff --git a/lisp/hfy-cmap.el b/lisp/hfy-cmap.el
index 6dea345f28..4ec24cea70 100644
--- a/lisp/hfy-cmap.el
+++ b/lisp/hfy-cmap.el
@@ -1,15 +1,15 @@
-;;; hfy-cmap.el --- Fallback colour name -> rgb mapping for `htmlfontify'
+;;; hfy-cmap.el --- Fallback color name -> rgb mapping for `htmlfontify'
 
 ;; Copyright (C) 2002-2003, 2009-2018 Free Software Foundation, Inc.
 
 ;; Emacs Lisp Archive Entry
 ;; Package: htmlfontify
 ;; Filename: hfy-cmap.el
-;; Keywords: colour, rgb
+;; Keywords: color, rgb
 ;; Author: Vivek Dasmohapatra <vivek@etla.org>
 ;; Maintainer: Vivek Dasmohapatra <vivek@etla.org>
 ;; Created: 2002-01-20
-;; Description: fallback code for colour name -> rgb mapping
+;; Description: fallback code for color name -> rgb mapping
 ;; URL: http://rtfm.etla.org/emacs/htmlfontify/
 ;; Last-Updated: Sat 2003-02-15 03:49:32 +0000
 
@@ -32,7 +32,7 @@
 
 ;;; Code:
 
-(defconst hfy-fallback-colour-map
+(defconst hfy-fallback-color-map
   '(("snow"                    65535 64250 64250)
     ("ghost white"             63736 63736 65535)
     ("GhostWhite"              63736 63736 65535)
@@ -785,8 +785,14 @@
     ("DarkRed"                 35723     0     0)
     ("light green"             37008 61166 37008)
     ("LightGreen"              37008 61166 37008)) )
+(define-obsolete-variable-alias
+  'hfy-fallback-colour-map
+  'hfy-fallback-color-map "27.1")
 
-(defvar hfy-rgb-txt-colour-map nil)
+(defvar hfy-rgb-txt-color-map nil)
+(define-obsolete-variable-alias
+  'hfy-rgb-txt-colour-map
+  'hfy-rgb-txt-color-map "27.1")
 
 (defvar hfy-rgb-load-path
   (list "/etc/X11"
@@ -806,8 +812,8 @@
 (defun htmlfontify-load-rgb-file (&optional file)
   "Load an X11 style rgb.txt FILE.
 Search `hfy-rgb-load-path' if FILE is not specified.
-Loads the variable `hfy-rgb-txt-colour-map', which is used by
-`hfy-fallback-colour-values'."
+Loads the variable `hfy-rgb-txt-color-map', which is used by
+`hfy-fallback-color-values'."
   (interactive
    (list
     (read-file-name "rgb.txt (equivalent) file: " "" nil t (hfy-rgb-file))))
@@ -822,25 +828,28 @@ Loads the variable `hfy-rgb-txt-colour-map', which is used by
 	  (htmlfontify-unload-rgb-file)
 	  (while (/= end-of-rgb 1)
 	    (if (looking-at hfy-rgb-regex)
-		(setq hfy-rgb-txt-colour-map
+		(setq hfy-rgb-txt-color-map
 		      (cons (list (match-string 4)
 				  (string-to-number (match-string 1))
 				  (string-to-number (match-string 2))
 				  (string-to-number (match-string 3)))
-			    hfy-rgb-txt-colour-map)) )
+			    hfy-rgb-txt-color-map)) )
 	    (setq end-of-rgb (forward-line)))
 	  (kill-buffer rgb-buffer)))))
 
 (defun htmlfontify-unload-rgb-file ()
   "Unload the current color name -> rgb translation map."
   (interactive)
-  (setq hfy-rgb-txt-colour-map nil))
+  (setq hfy-rgb-txt-color-map nil))
 
 ;;;###autoload
-(defun hfy-fallback-colour-values (colour-string)
+(defun hfy-fallback-color-values (color-string)
   "Use a fallback method for obtaining the rgb values for a color."
-  (cdr (assoc-string colour-string (or hfy-rgb-txt-colour-map
-                                       hfy-fallback-colour-map))) )
+  (cdr (assoc-string color-string (or hfy-rgb-txt-color-map
+				      hfy-fallback-color-map))) )
+(define-obsolete-function-alias
+  'hfy-fallback-colour-values
+  'hfy-fallback-color-values "27.1")
 
 (provide 'hfy-cmap)
 
diff --git a/lisp/hilit-chg.el b/lisp/hilit-chg.el
index de1ae0d457..9d4d2d8b38 100644
--- a/lisp/hilit-chg.el
+++ b/lisp/hilit-chg.el
@@ -204,9 +204,6 @@
   :group 'highlight-changes)
 
 ;; A (not very good) default list of colors to rotate through.
-(define-obsolete-variable-alias 'highlight-changes-colours
-                                'highlight-changes-colors "22.1")
-
 (defcustom highlight-changes-colors
   (if (eq (frame-parameter nil 'background-mode) 'light)
       ;; defaults for light background:
@@ -300,9 +297,9 @@ modes only."
 
 (defcustom highlight-changes-global-changes-existing-buffers nil
   "If non-nil, toggling global Highlight Changes mode affects existing buffers.
-Normally, `global-highlight-changes' affects only new buffers (to be
+Normally, `global-highlight-changes-mode' affects only new buffers (to be
 created).  However, if `highlight-changes-global-changes-existing-buffers'
-is non-nil, then turning on `global-highlight-changes' will turn on
+is non-nil, then turning on `global-highlight-changes-mode' will turn on
 Highlight Changes mode in suitable buffers, and turning the mode off will
 remove it from existing buffers."
   :type 'boolean
diff --git a/lisp/htmlfontify.el b/lisp/htmlfontify.el
index dfa6bde297..23efcd1298 100644
--- a/lisp/htmlfontify.el
+++ b/lisp/htmlfontify.el
@@ -584,22 +584,23 @@ therefore no longer care about) will be invalid at any time.\n
       (if (memq elt set-b) (setq interq (cons elt interq))))
     interq))
 
-(defun hfy-colour-vals (colour)
-  "Where COLOUR is a color name or #XXXXXX style triplet, return a
+(defun hfy-color-vals (color)
+  "Where COLOR is a color name or #XXXXXX style triplet, return a
 list of three (16 bit) rgb values for said color.\n
-If a window system is unavailable, calls `hfy-fallback-colour-values'."
-  (if (string-match hfy-triplet-regex colour)
+If a window system is unavailable, calls `hfy-fallback-color-values'."
+  (if (string-match hfy-triplet-regex color)
       (mapcar
-       (lambda (x) (* (string-to-number (match-string x colour) 16) 257))
+       (lambda (x) (* (string-to-number (match-string x color) 16) 257))
        '(1 2 3))
-    ;;(message ">> %s" colour)
+    ;;(message ">> %s" color)
     (if window-system
         (if (fboundp 'color-values)
-            (color-values colour)
+            (color-values color)
           ;;(message "[%S]" window-system)
-          (x-color-values colour))
+          (x-color-values color))
       ;; blarg - tty colors are no good - go fetch some X colors:
-      (hfy-fallback-colour-values colour))))
+      (hfy-fallback-color-values color))))
+(define-obsolete-function-alias 'hfy-colour-vals 'hfy-color-vals "27.1")
 
 (defvar hfy-cperl-mode-kludged-p nil)
 
@@ -738,7 +739,7 @@ FILE is the name of the file being rendered, in case it is needed."
   "Replace the end of a CSS style declaration STYLE-STRING with the contents
 of the variable `hfy-src-doc-link-style', removing text matching the regex
 `hfy-src-doc-link-unstyle' first, if necessary."
-  ;;(message "hfy-colour-vals");;DBUG
+  ;;(message "hfy-color-vals");;DBUG
   (if (string-match hfy-src-doc-link-unstyle style-string)
       (setq style-string (replace-match "" 'fixed-case 'literal style-string)))
   (if (and (not (string-match hfy-src-doc-link-style style-string))
@@ -751,19 +752,19 @@ of the variable `hfy-src-doc-link-style', removing text matching the regex
 
 ;; utility functions - cast emacs style specification values into their
 ;; css2 equivalents:
-(defun hfy-triplet (colour)
-  "Takes a COLOUR name (string) and return a CSS rgb(R, G, B) triplet string.
+(defun hfy-triplet (color)
+  "Takes a COLOR name (string) and return a CSS rgb(R, G, B) triplet string.
 Uses the definition of \"white\" to map the numbers to the 0-255 range, so
 if you've redefined white, (esp. if you've redefined it to have a triplet
 member lower than that of the color you are processing) strange things
 may happen."
-  ;;(message "hfy-colour-vals");;DBUG
+  ;;(message "hfy-color-vals");;DBUG
   ;; TODO?  Can we do somehow do better than this?
   (cond
-   ((equal colour "unspecified-fg") (setq colour "black"))
-   ((equal colour "unspecified-bg") (setq colour "white")))
-  (let ((white (mapcar (lambda (I) (float (1+ I))) (hfy-colour-vals "white")))
-        (rgb16 (mapcar (lambda (I) (float (1+ I))) (hfy-colour-vals  colour))))
+   ((equal color "unspecified-fg") (setq color "black"))
+   ((equal color "unspecified-bg") (setq color "white")))
+  (let ((white (mapcar (lambda (I) (float (1+ I))) (hfy-color-vals "white")))
+        (rgb16 (mapcar (lambda (I) (float (1+ I))) (hfy-color-vals  color))))
     (if rgb16
         ;;(apply 'format "rgb(%d, %d, %d)"
         ;; Use #rrggbb instead, it is smaller
@@ -774,8 +775,9 @@ may happen."
                        '(0 1 2))))))
 
 (defun hfy-family (family) (list (cons "font-family"  family)))
-(defun hfy-bgcol  (colour) (list (cons "background"   (hfy-triplet colour))))
-(defun hfy-colour (colour) (list (cons "color"        (hfy-triplet colour))))
+(defun hfy-bgcol  (color) (list (cons "background"   (hfy-triplet color))))
+(defun hfy-color (color) (list (cons "color"        (hfy-triplet color))))
+(define-obsolete-function-alias 'hfy-colour 'hfy-color "27.1")
 (defun hfy-width  (width)  (list (cons "font-stretch" (symbol-name  width))))
 
 (defcustom hfy-font-zoom 1.05
@@ -825,17 +827,17 @@ regular specifiers."
       (let ((tag (car  spec))
             (val (cadr spec)))
         (cons (cl-case tag
-                (:color (cons "colour" val))
+                (:color (cons "color" val))
                 (:width (cons "width"  val))
                 (:style (cons "style"  val)))
               (hfy-box-to-border-assoc (cddr spec))))))
 
 (defun hfy-box-to-style (spec)
   (let* ((css (hfy-box-to-border-assoc  spec))
-         (col (cdr      (assoc "colour" css)))
+         (col (cdr      (assoc "color" css)))
          (s   (cdr      (assoc "style"  css))))
     (list
-     (if col (cons "border-color" (cdr (assoc "colour" css))))
+     (if col (cons "border-color" (cdr (assoc "color" css))))
      (cons "border-width" (format "%dpx" (or (cdr (assoc "width" css)) 1)))
      (cons "border-style" (cl-case s
                             (released-button "outset")
@@ -1014,7 +1016,7 @@ merged by the user - `hfy-flatten-style' should do this."
                        (:width          (hfy-width     val))
                        (:weight         (hfy-weight    val))
                        (:slant          (hfy-slant     val))
-                       (:foreground     (hfy-colour    val))
+                       (:foreground     (hfy-color     val))
                        (:background     (hfy-bgcol     val))
                        (:box            (hfy-box       val))
                        (:height         (hfy-size      val))
@@ -1828,10 +1830,11 @@ fontified.  This is a simple convenience wrapper around
    (noninteractive
     (message "hfy batch mode (%s:%S)"
              (or (buffer-file-name) (buffer-name)) major-mode)
-    (if (fboundp 'font-lock-ensure)
+    (if (fboundp 'font-lock-ensure)     ; Emacs >= 25.1
         (font-lock-ensure)
       (when font-lock-defaults
-        (font-lock-fontify-buffer))))
+        ; Silence "interactive use only" warning on Emacs >= 25.1.
+        (with-no-warnings (font-lock-fontify-buffer)))))
    ((fboundp #'jit-lock-fontify-now)
     (message "hfy jit-lock mode (%S %S)" window-system major-mode)
     (jit-lock-fontify-now))
diff --git a/lisp/ibuffer.el b/lisp/ibuffer.el
index 38fffcb976..0fd2971934 100644
--- a/lisp/ibuffer.el
+++ b/lisp/ibuffer.el
@@ -224,14 +224,6 @@ view of the buffers."
   :group 'ibuffer)
 (defvar ibuffer-sorting-reversep nil)
 
-(defcustom ibuffer-elide-long-columns nil
-  "If non-nil, then elide column entries which exceed their max length."
-  :type 'boolean
-  :group 'ibuffer)
-(make-obsolete-variable 'ibuffer-elide-long-columns
-                        "use the :elide argument of `ibuffer-formats'."
-                        "22.1")
-
 (defcustom ibuffer-eliding-string "..."
   "The string to use for eliding long columns."
   :type 'string
@@ -349,15 +341,11 @@ directory, like `default-directory'."
   :type 'regexp
   :group 'ibuffer)
 
-(define-obsolete-variable-alias 'ibuffer-hooks 'ibuffer-hook "22.1")
-
 (defcustom ibuffer-hook nil
   "Hook run when `ibuffer' is called."
   :type 'hook
   :group 'ibuffer)
 
-(define-obsolete-variable-alias 'ibuffer-mode-hooks 'ibuffer-mode-hook "22.1")
-
 (defcustom ibuffer-mode-hook nil
   "Hook run upon entry into `ibuffer-mode'."
   :type 'hook
@@ -952,7 +940,6 @@ directory, like `default-directory'."
 (defvar ibuffer-compiled-formats nil)
 (defvar ibuffer-cached-formats nil)
 (defvar ibuffer-cached-eliding-string nil)
-(defvar ibuffer-cached-elide-long-columns 0)
 
 (defvar ibuffer-sorting-functions-alist nil
   "An alist of functions which describe how to sort buffers.
@@ -1589,7 +1576,7 @@ If point is on a group name, this function operates on that group."
 
 (defun ibuffer-compile-make-eliding-form (strvar elide from-end-p)
   (let ((ellipsis (propertize ibuffer-eliding-string 'font-lock-face 'bold)))
-    (if (or elide (with-no-warnings ibuffer-elide-long-columns))
+    (if elide
 	`(if (> strlen 5)
 	     ,(if from-end-p
                   ;; FIXME: this should probably also be using
@@ -1789,9 +1776,6 @@ If point is on a group name, this function operates on that group."
 	      (not (eq ibuffer-cached-formats ibuffer-formats))
 	      (null ibuffer-cached-eliding-string)
 	      (not (equal ibuffer-cached-eliding-string ibuffer-eliding-string))
-	      (eql 0 ibuffer-cached-elide-long-columns)
-	      (not (eql ibuffer-cached-elide-long-columns
-			(with-no-warnings ibuffer-elide-long-columns)))
 	      (and ext-loaded
 		   (not (eq ibuffer-cached-filter-formats
 			    ibuffer-filter-format-alist))
@@ -1800,8 +1784,7 @@ If point is on a group name, this function operates on that group."
       (message "Formats have changed, recompiling...")
       (ibuffer-recompile-formats)
       (setq ibuffer-cached-formats ibuffer-formats
-	    ibuffer-cached-eliding-string ibuffer-eliding-string
-	    ibuffer-cached-elide-long-columns (with-no-warnings ibuffer-elide-long-columns))
+	    ibuffer-cached-eliding-string ibuffer-eliding-string)
       (when ext-loaded
 	(setq ibuffer-cached-filter-formats ibuffer-filter-format-alist))
       (message "Formats have changed, recompiling...done"))))
@@ -2746,7 +2729,6 @@ will be inserted before the group at point."
   (set (make-local-variable 'ibuffer-compiled-formats) nil)
   (set (make-local-variable 'ibuffer-cached-formats) nil)
   (set (make-local-variable 'ibuffer-cached-eliding-string) nil)
-  (set (make-local-variable 'ibuffer-cached-elide-long-columns) nil)
   (set (make-local-variable 'ibuffer-current-format) nil)
   (set (make-local-variable 'ibuffer-did-modification) nil)
   (set (make-local-variable 'ibuffer-tmp-hide-regexps) nil)
diff --git a/lisp/ido.el b/lisp/ido.el
index da0c9d463d..7ff3d6820b 100644
--- a/lisp/ido.el
+++ b/lisp/ido.el
@@ -1135,6 +1135,9 @@ selected.")
 (defvar ido-current-directory nil
   "Current directory for `ido-find-file'.")
 
+(defvar ido-predicate nil
+  "Current completion predicate.")
+
 (defvar ido-auto-merge-timer nil
   "Delay timer for auto merge.")
 
@@ -3480,6 +3483,11 @@ it is put to the start of the list."
     (if ido-temp-list
 	(nconc ido-temp-list ido-current-buffers)
       (setq ido-temp-list ido-current-buffers))
+    (if ido-predicate
+        (setq ido-temp-list (seq-filter
+                             (lambda (name)
+                               (funcall ido-predicate (cons name (get-buffer name))))
+                             ido-temp-list)))
     (if default
 	(setq ido-temp-list
 	      (cons default (delete default ido-temp-list))))
@@ -4845,10 +4853,13 @@ Modified from `icomplete-completions'."
 Return the name of a buffer selected.
 PROMPT is the prompt to give to the user.  DEFAULT if given is the default
 buffer to be selected, which will go to the front of the list.
-If REQUIRE-MATCH is non-nil, an existing buffer must be selected."
+If REQUIRE-MATCH is non-nil, an existing buffer must be selected.
+Optional arg PREDICATE if non-nil is a function limiting the
+buffers that can be considered."
   (let* ((ido-current-directory nil)
 	 (ido-directory-nonreadable nil)
 	 (ido-directory-too-big nil)
+         (ido-predicate predicate)
 	 (ido-context-switch-command 'ignore)
 	 (buf (ido-read-internal 'buffer prompt 'ido-buffer-history default require-match)))
     (if (eq ido-exit 'fallback)
diff --git a/lisp/image.el b/lisp/image.el
index b69bf93054..ab868f7db3 100644
--- a/lisp/image.el
+++ b/lisp/image.el
@@ -971,7 +971,8 @@ default is 20%."
                         0.8)))
 
 (defun image--get-image ()
-  (let ((image (get-text-property (point) 'display)))
+  "Return the image at point."
+  (let ((image (get-char-property (point) 'display)))
     (unless (eq (car-safe image) 'image)
       (error "No image under point"))
     image))
@@ -1026,10 +1027,7 @@ default is 20%."
 (defun image-save ()
   "Save the image under point."
   (interactive)
-  (let ((image (get-text-property (point) 'display)))
-    (when (or (not (consp image))
-              (not (eq (car image) 'image)))
-      (error "No image under point"))
+  (let ((image (image--get-image)))
     (with-temp-buffer
       (let ((file (plist-get (cdr image) :file)))
         (if file
diff --git a/lisp/imenu.el b/lisp/imenu.el
index f56e7b5039..b4d7d90359 100644
--- a/lisp/imenu.el
+++ b/lisp/imenu.el
@@ -102,14 +102,7 @@ This variable is buffer-local."
   :type 'integer
   :group 'imenu)
 
-(defvar imenu-always-use-completion-buffer-p nil)
-(make-obsolete-variable 'imenu-always-use-completion-buffer-p
-			'imenu-use-popup-menu "22.1")
-
-(defcustom imenu-use-popup-menu
-  (if imenu-always-use-completion-buffer-p
-      (not (eq imenu-always-use-completion-buffer-p 'never))
-    'on-mouse)
+(defcustom imenu-use-popup-menu 'on-mouse
   "Use a popup menu rather than a minibuffer prompt.
 If nil, always use a minibuffer prompt.
 If t, always use a popup menu,
@@ -119,8 +112,7 @@ If `on-mouse' use a popup menu when `imenu' was invoked with the mouse."
 		 (other :tag "Always" t))
   :group 'imenu)
 
-(defcustom imenu-eager-completion-buffer
-  (not (eq imenu-always-use-completion-buffer-p 'never))
+(defcustom imenu-eager-completion-buffer t
   "If non-nil, eagerly popup the completion buffer."
   :type 'boolean
   :group 'imenu
diff --git a/lisp/international/latin1-disp.el b/lisp/international/latin1-disp.el
index 657f79097c..df2c1dc9a8 100644
--- a/lisp/international/latin1-disp.el
+++ b/lisp/international/latin1-disp.el
@@ -201,10 +201,6 @@ character set: `latin-2', `hebrew' etc."
 	 (char (and info (decode-char (car (remq 'ascii info)) ?\ ))))
     (and char (char-displayable-p char))))
 
-;; Backwards compatibility.
-(define-obsolete-function-alias 'latin1-char-displayable-p
-  'char-displayable-p "22.1")
-
 (defun latin1-display-setup (set &optional force)
   "Set up Latin-1 display for characters in the given SET.
 SET must be a member of `latin1-display-sets'.  Normally, check
diff --git a/lisp/isearch.el b/lisp/isearch.el
index a41adf0c2c..84b121af9e 100644
--- a/lisp/isearch.el
+++ b/lisp/isearch.el
@@ -67,8 +67,26 @@
 
 
 (defcustom search-exit-option t
-  "Non-nil means random control characters terminate incremental search."
-  :type 'boolean)
+  "Defines what control characters do in incremental search.
+If t, random control and meta characters terminate the search
+and are then executed normally.
+If `edit', edit the search string instead of exiting.
+If `move', extend the search string by motion commands
+that have the `isearch-move' property on their symbols.
+If `shift-move', extend the search string by motion commands
+while holding down the shift key.
+Both `move' and `shift-move' extend the search string by yanking text
+that ends at the new position after moving point in the current buffer.
+If `append', the characters which you type that are not interpreted by
+the incremental search are simply appended to the search string.
+If nil, run the command without exiting Isearch."
+  :type '(choice (const :tag "Terminate incremental search" t)
+                 (const :tag "Edit the search string" edit)
+                 (const :tag "Extend the search string by motion commands" move)
+                 (const :tag "Extend the search string by shifted motion keys" shift-move)
+                 (const :tag "Append control characters to the search string" append)
+                 (const :tag "Don't terminate incremental search" nil))
+  :version "27.1")
 
 (defcustom search-slow-window-lines 1
   "Number of lines in slow search display windows.
@@ -305,10 +323,6 @@ this variable is set to the symbol `all-windows'."
   :group 'isearch
   :group 'matching)
 
-(define-obsolete-variable-alias 'isearch-lazy-highlight-cleanup
-                                'lazy-highlight-cleanup
-                                "22.1")
-
 (defcustom lazy-highlight-cleanup t
   "Controls whether to remove extra highlighting after a search.
 If this is nil, extra highlighting can be \"manually\" removed with
@@ -316,28 +330,16 @@ If this is nil, extra highlighting can be \"manually\" removed with
   :type 'boolean
   :group 'lazy-highlight)
 
-(define-obsolete-variable-alias 'isearch-lazy-highlight-initial-delay
-                                'lazy-highlight-initial-delay
-                                "22.1")
-
 (defcustom lazy-highlight-initial-delay 0.25
   "Seconds to wait before beginning to lazily highlight all matches."
   :type 'number
   :group 'lazy-highlight)
 
-(define-obsolete-variable-alias 'isearch-lazy-highlight-interval
-                                'lazy-highlight-interval
-                                "22.1")
-
 (defcustom lazy-highlight-interval 0 ; 0.0625
   "Seconds between lazily highlighting successive matches."
   :type 'number
   :group 'lazy-highlight)
 
-(define-obsolete-variable-alias 'isearch-lazy-highlight-max-at-a-time
-                                'lazy-highlight-max-at-a-time
-                                "22.1")
-
 (defcustom lazy-highlight-max-at-a-time nil ; 20 (bug#25751)
   "Maximum matches to highlight at a time (for `lazy-highlight').
 Larger values may reduce Isearch's responsiveness to user input;
@@ -2391,6 +2393,7 @@ the bottom."
   (goto-char isearch-point))
 
 (defvar isearch-pre-scroll-point nil)
+(defvar isearch-pre-move-point nil)
 
 (defun isearch-pre-command-hook ()
   "Decide whether to exit Isearch mode before executing the command.
@@ -2398,8 +2401,9 @@ Don't exit Isearch if the key sequence that invoked this command
 is bound in `isearch-mode-map', or if the invoked command is
 a prefix argument command (when `isearch-allow-prefix' is non-nil),
 or it is a scrolling command (when `isearch-allow-scroll' is non-nil).
-Otherwise, exit Isearch (when `search-exit-option' is non-nil)
-before the command is executed globally with terminated Isearch."
+Otherwise, exit Isearch (when `search-exit-option' is t)
+before the command is executed globally with terminated Isearch.
+See more for options in `search-exit-option'."
   (let* ((key (this-single-command-keys))
 	 (main-event (aref key 0)))
     (cond
@@ -2427,22 +2431,47 @@ before the command is executed globally with terminated Isearch."
       ;; Swallow the up-event.
       (read-event)
       (setq this-command 'isearch-edit-string))
+     ;; Don't terminate the search for motion commands.
+     ((or (and (eq search-exit-option 'move)
+               (symbolp this-command)
+               (eq (get this-command 'isearch-move) t))
+          (and (eq search-exit-option 'shift-move)
+               this-command-keys-shift-translated))
+      (setq this-command-keys-shift-translated nil)
+      (setq isearch-pre-move-point (point)))
+     ;; Append control characters to the search string
+     ((eq search-exit-option 'append)
+      (when (cl-every #'characterp key)
+        (isearch-process-search-string key key))
+      (setq this-command 'ignore))
      ;; Other characters terminate the search and are then executed normally.
      (search-exit-option
       (isearch-done)
-      (isearch-clean-overlays))
-     ;; If search-exit-option is nil, run the command without exiting Isearch.
-     (t
-      (isearch-process-search-string key key)))))
+      (isearch-clean-overlays)))))
 
 (defun isearch-post-command-hook ()
-  (when isearch-pre-scroll-point
+  (cond
+   (isearch-pre-scroll-point
     (let ((ab-bel (isearch-string-out-of-window isearch-pre-scroll-point)))
       (if ab-bel
 	  (isearch-back-into-window (eq ab-bel 'above) isearch-pre-scroll-point)
 	(goto-char isearch-pre-scroll-point)))
     (setq isearch-pre-scroll-point nil)
-    (isearch-update)))
+    (isearch-update))
+   ((memq search-exit-option '(move shift-move))
+    (when (and isearch-pre-move-point
+               (not (eq isearch-pre-move-point (point))))
+      (let ((string (buffer-substring-no-properties
+                     (or isearch-other-end isearch-opoint) (point))))
+        (if isearch-regexp (setq string (regexp-quote string)))
+        (setq isearch-string string)
+        (setq isearch-message (mapconcat 'isearch-text-char-description
+                                         string ""))
+        (setq isearch-yank-flag t)
+        (setq isearch-forward (<= (or isearch-other-end isearch-opoint) (point)))
+        (goto-char isearch-pre-move-point)
+        (isearch-search-and-update)))
+    (setq isearch-pre-move-point nil))))
 
 (defun isearch-quote-char (&optional count)
   "Quote special characters for incremental search.
@@ -3157,10 +3186,6 @@ This function is called when exiting an incremental search if
     (cancel-timer isearch-lazy-highlight-timer)
     (setq isearch-lazy-highlight-timer nil)))
 
-(define-obsolete-function-alias 'isearch-lazy-highlight-cleanup
-                                'lazy-highlight-cleanup
-                                "22.1")
-
 (defun isearch-lazy-highlight-new-loop (&optional beg end)
   "Cleanup any previous `lazy-highlight' loop and begin a new one.
 BEG and END specify the bounds within which highlighting should occur.
diff --git a/lisp/ldefs-boot.el b/lisp/ldefs-boot.el
index 9dfdab43dc..650122e1c5 100644
--- a/lisp/ldefs-boot.el
+++ b/lisp/ldefs-boot.el
@@ -1969,7 +1969,8 @@ result.  The overhead of the `lambda's is accounted for.
 
 (autoload 'benchmark "benchmark" "\
 Print the time taken for REPETITIONS executions of FORM.
-Interactively, REPETITIONS is taken from the prefix arg.
+Interactively, REPETITIONS is taken from the prefix arg, and
+the command prompts for the form to benchmark.
 For non-interactive use see also `benchmark-run' and
 `benchmark-run-compiled'.
 
@@ -2927,6 +2928,7 @@ Like `bug-reference-mode', but only buttonize in comments and strings.
 (put 'byte-compile-dynamic 'safe-local-variable 'booleanp)
 (put 'byte-compile-disable-print-circle 'safe-local-variable 'booleanp)
 (put 'byte-compile-dynamic-docstrings 'safe-local-variable 'booleanp)
+(put 'byte-compile-error-on-warn 'safe-local-variable 'booleanp)
 
 (put 'byte-compile-warnings 'safe-local-variable (lambda (v) (or (symbolp v) (null (delq nil (mapcar (lambda (x) (not (symbolp x))) v))))))
 
@@ -6192,7 +6194,7 @@ For example, the MH-E package updates this alist as follows:
 
 The value of PACKAGE needs to be unique and it needs to match the
 PACKAGE value appearing in the :package-version keyword.  Since
-the user might see the value in a error message, a good choice is
+the user might see the value in an error message, a good choice is
 the official name of the package, such as MH-E or Gnus.")
 
 (defalias 'customize-changed 'customize-changed-options)
@@ -9813,8 +9815,11 @@ the mode if ARG is omitted or nil.
 
 Electric Pair mode is a global minor mode.  When enabled, typing
 an open parenthesis automatically inserts the corresponding
-closing parenthesis.  (Likewise for brackets, etc.). To toggle
-the mode in a single buffer, use `electric-pair-local-mode'.
+closing parenthesis, and vice versa.  (Likewise for brackets, etc.).
+If the region is active, the parentheses (brackets, etc.) are
+inserted around the region instead.
+
+To toggle the mode in a single buffer, use `electric-pair-local-mode'.
 
 \(fn &optional ARG)" t nil)
 
@@ -9893,7 +9898,8 @@ FUNSYM must be a symbol of a defined function.
 (autoload 'elp-instrument-list "elp" "\
 Instrument, for profiling, all functions in `elp-function-list'.
 Use optional LIST if provided instead.
-If called interactively, read LIST using the minibuffer.
+If called interactively, prompt for LIST in the minibuffer;
+type \"nil\" to use `elp-function-list'.
 
 \(fn &optional LIST)" t nil)
 
@@ -15143,7 +15149,7 @@ file name to `*.gz', and sets `grep-highlight-matches' to `always'.
 
 (defalias 'rzgrep 'zrgrep)
 
-(if (fboundp 'register-definition-prefixes) (register-definition-prefixes "grep" '("rgrep-" "grep-" "kill-grep")))
+(if (fboundp 'register-definition-prefixes) (register-definition-prefixes "grep" '("grep-" "rgrep-" "kill-grep")))
 
 ;;;***
 
@@ -16525,7 +16531,7 @@ See the documentation for `calendar-holidays' for details.")
 (autoload 'holidays "holidays" "\
 Display the holidays for last month, this month, and next month.
 If called with an optional prefix argument ARG, prompts for month and year.
-This function is suitable for execution in a init file.
+This function is suitable for execution in an init file.
 
 \(fn &optional ARG)" t nil)
 
@@ -16796,7 +16802,7 @@ Extract iCalendar events from current buffer.
 
 This function searches the current buffer for the first iCalendar
 object, reads it and adds all VEVENT elements to the diary
-DIARY-FILE.
+DIARY-FILENAME.
 
 It will ask for each appointment whether to add it to the diary
 unless DO-NOT-ASK is non-nil.  When called interactively,
@@ -16809,7 +16815,7 @@ Return code t means that importing worked well, return code nil
 means that an error has occurred.  Error messages will be in the
 buffer `*icalendar-errors*'.
 
-\(fn &optional DIARY-FILE DO-NOT-ASK NON-MARKING)" t nil)
+\(fn &optional DIARY-FILENAME DO-NOT-ASK NON-MARKING)" t nil)
 
 (if (fboundp 'register-definition-prefixes) (register-definition-prefixes "icalendar" '("icalendar-")))
 
@@ -17335,6 +17341,8 @@ Return the name of a buffer selected.
 PROMPT is the prompt to give to the user.  DEFAULT if given is the default
 buffer to be selected, which will go to the front of the list.
 If REQUIRE-MATCH is non-nil, an existing buffer must be selected.
+Optional arg PREDICATE if non-nil is a function limiting the
+buffers that can be considered.
 
 \(fn PROMPT &optional DEFAULT REQUIRE-MATCH PREDICATE)" nil nil)
 
@@ -17913,8 +17921,8 @@ If non-nil this pattern is passed to `imenu--generic-function' to
 create a buffer index.
 
 For example, see the value of `fortran-imenu-generic-expression'
-used by `fortran-mode' with `imenu-syntax-alist' set locally to
-give the characters which normally have \"symbol\" syntax
+used by `fortran-mode' with `imenu-syntax-alist' set locally so that
+characters which normally have \"symbol\" syntax are considered to have
 \"word\" syntax during matching.")
 (put 'imenu-generic-expression 'risky-local-variable t)
 
@@ -22012,7 +22020,7 @@ QUALITY can be:
 ;;;### (autoloads nil "mwheel" "mwheel.el" (0 0 0 0))
 ;;; Generated autoloads from mwheel.el
 
-(if (fboundp 'register-definition-prefixes) (register-definition-prefixes "mwheel" '("mwheel-" "mouse-wheel-")))
+(if (fboundp 'register-definition-prefixes) (register-definition-prefixes "mwheel" '("mouse-wheel-" "mwheel-")))
 
 ;;;***
 
@@ -23246,6 +23254,7 @@ Coloring:
 
 ;;;### (autoloads nil "org" "org/org.el" (0 0 0 0))
 ;;; Generated autoloads from org/org.el
+(push (purecopy '(org 9 1 6)) package--builtin-versions)
 
 (autoload 'org-babel-do-load-languages "org" "\
 Load the languages defined in `org-babel-load-languages'.
@@ -24408,8 +24417,6 @@ activate the package system at any time.")
 Load Emacs Lisp packages, and activate them.
 The variable `package-load-list' controls which packages to load.
 If optional arg NO-ACTIVATE is non-nil, don't activate packages.
-If `user-init-file' does not mention `(package-initialize)', add
-it to the file.
 If called as part of loading `user-init-file', set
 `package-enable-at-startup' to nil, to prevent accidentally
 loading packages twice.
@@ -26421,7 +26428,7 @@ Optional argument FACE specifies the face to do the highlighting.
 
 ;;;### (autoloads nil "python" "progmodes/python.el" (0 0 0 0))
 ;;; Generated autoloads from progmodes/python.el
-(push (purecopy '(python 0 25 2)) package--builtin-versions)
+(push (purecopy '(python 0 26 1)) package--builtin-versions)
 
 (add-to-list 'auto-mode-alist (cons (purecopy "\\.py[iw]?\\'") 'python-mode))
 
@@ -29843,13 +29850,6 @@ Like `mail' command, but display mail buffer in another frame.
 
 (put 'server-auth-dir 'risky-local-variable t)
 
-(defvar server-name "server" "\
-The name of the Emacs server, if this Emacs process creates one.
-The command `server-start' makes use of this.  It should not be
-changed while a server is running.")
-
-(custom-autoload 'server-name "server" t)
-
 (autoload 'server-start "server" "\
 Allow this Emacs process to be a server for client processes.
 This starts a server communications subprocess through which client
@@ -31725,7 +31725,7 @@ Args are NAME BUFFER HOST PORT.
 NAME is name for process.  It is modified if necessary to make it unique.
 BUFFER is the buffer (or `buffer-name') to associate with the process.
  Process output goes at end of that buffer, unless you specify
- an output stream or filter function to handle the output.
+ a filter function to handle the output.
  BUFFER may be also nil, meaning that this process is not associated
  with any buffer
 Third arg is name of the host to connect to, or its IP address.
@@ -34063,7 +34063,7 @@ Todo mode revisit this file or, with option
 file was last visited.
 
 If you call this command before you have created any todo file in
-the current format, and you have an todo file in old format, it
+the current format, and you have a todo file in old format, it
 will ask you whether to convert that file and show it.
 Otherwise, calling this command before any todo file exists
 prompts for a file name and an initial category (defaulting to
@@ -34313,6 +34313,27 @@ Discard Tramp from loading remote files.
 ;;;;;;  0 0))
 ;;; Generated autoloads from net/tramp-archive.el
 
+(defvar tramp-archive-enabled (featurep 'dbusbind) "\
+Non-nil when file archive support is available.")
+
+(defconst tramp-archive-suffixes '("7z" "apk" "ar" "cab" "CAB" "cpio" "deb" "depot" "exe" "iso" "jar" "lzh" "LZH" "msu" "MSU" "mtree" "pax" "rar" "rpm" "shar" "tar" "tbz" "tgz" "tlz" "txz" "warc" "xar" "xpi" "xps" "zip" "ZIP") "\
+List of suffixes which indicate a file archive.
+It must be supported by libarchive(3).")
+
+(defconst tramp-archive-compression-suffixes '("bz2" "gz" "lrz" "lz" "lz4" "lzma" "lzo" "uu" "xz" "Z") "\
+List of suffixes which indicate a compressed file.
+It must be supported by libarchive(3).")
+
+(defmacro tramp-archive-autoload-file-name-regexp nil "\
+Regular expression matching archive file names." `(concat "\\`" "\\(" ".+" "\\." (regexp-opt tramp-archive-suffixes) "\\(?:" "\\." (regexp-opt tramp-archive-compression-suffixes) "\\)*" "\\)" "\\(" "/" ".*" "\\)" "\\'"))
+
+(defun tramp-register-archive-file-name-handler nil "\
+Add archive file name handler to `file-name-handler-alist'." (when tramp-archive-enabled (add-to-list 'file-name-handler-alist (cons (tramp-archive-autoload-file-name-regexp) 'tramp-autoload-file-name-handler)) (put 'tramp-archive-file-name-handler 'safe-magic t)))
+
+(add-hook 'after-init-hook 'tramp-register-archive-file-name-handler)
+
+(add-hook 'tramp-archive-unload-hook (lambda nil (remove-hook 'after-init-hook 'tramp-register-archive-file-name-handler)))
+
 (if (fboundp 'register-definition-prefixes) (register-definition-prefixes "tramp-archive" '("tramp-" "with-parsed-tramp-archive-file-name")))
 
 ;;;***
@@ -35867,7 +35888,10 @@ When called interactively with a prefix argument, prompt for REMOTE-LOCATION.
 \(fn &optional REMOTE-LOCATION)" t nil)
 
 (autoload 'vc-region-history "vc" "\
-Show the history of the region FROM..TO.
+Show the history of the region between FROM and TO.
+
+If called interactively, show the history between point and
+mark.
 
 \(fn FROM TO)" t nil)
 
diff --git a/lisp/loadhist.el b/lisp/loadhist.el
index e2b2ccd510..b8d9e2de0d 100644
--- a/lisp/loadhist.el
+++ b/lisp/loadhist.el
@@ -141,8 +141,6 @@ These are symbols with hooklike values whose names don't end in
 `-hook' or `-hooks', from which `unload-feature' should try to remove
 pertinent symbols.")
 
-(define-obsolete-variable-alias 'unload-hook-features-list
-    'unload-function-defs-list "22.2")
 (defvar unload-function-defs-list nil
   "List of definitions in the Lisp library being unloaded.
 
diff --git a/lisp/mail/rmail.el b/lisp/mail/rmail.el
index 4e5873c06e..f2fdcb6367 100644
--- a/lisp/mail/rmail.el
+++ b/lisp/mail/rmail.el
@@ -191,9 +191,6 @@ Its name should end with a slash."
   :group 'rmail-retrieve
   :type '(choice (const nil) string))
 
-(define-obsolete-variable-alias 'rmail-pop-password
-  'rmail-remote-password "22.1")
-
 (defcustom rmail-remote-password nil
   "Password to use when reading mail from a remote server.
 This setting is ignored for mailboxes whose URL already contains a password."
@@ -202,9 +199,6 @@ This setting is ignored for mailboxes whose URL already contains a password."
   :group 'rmail-retrieve
   :version "22.1")
 
-(define-obsolete-variable-alias 'rmail-pop-password-required
-  'rmail-remote-password-required "22.1")
-
 (defcustom rmail-remote-password-required nil
   "Non-nil if a password is required when reading mail from a remote server."
   :type 'boolean
diff --git a/lisp/mh-e/mh-acros.el b/lisp/mh-e/mh-acros.el
index ac31127ce6..fb8a16bd81 100644
--- a/lisp/mh-e/mh-acros.el
+++ b/lisp/mh-e/mh-acros.el
@@ -90,9 +90,10 @@ loads \"cl\" appropriately."
   "Create function NAME.
 If FUNCTION exists, then NAME becomes an alias for FUNCTION.
 Otherwise, create function NAME with ARG-LIST and BODY."
-  `(if (fboundp ',function)
-       (defalias ',name ',function)
-     (defun ,name ,arg-list ,@body)))
+  `(defalias ',name
+     (if (fboundp ',function)
+         ',function
+       (lambda ,arg-list ,@body))))
 (put 'defun-mh 'lisp-indent-function 'defun)
 (put 'defun-mh 'doc-string-elt 4)
 
diff --git a/lisp/mh-e/mh-comp.el b/lisp/mh-e/mh-comp.el
index a9f809cfa1..941529330e 100644
--- a/lisp/mh-e/mh-comp.el
+++ b/lisp/mh-e/mh-comp.el
@@ -305,17 +305,19 @@ message and scan line."
         (file-name buffer-file-name)
         (config mh-previous-window-config)
         (coding-system-for-write
-         (if (and (local-variable-p 'buffer-file-coding-system
-                                    (current-buffer)) ;XEmacs needs two args
-                  ;; We're not sure why, but buffer-file-coding-system
-                  ;; tends to get set to undecided-unix.
-                  (not (memq buffer-file-coding-system
-                             '(undecided undecided-unix undecided-dos))))
-             buffer-file-coding-system
-           (or (and (boundp 'sendmail-coding-system) sendmail-coding-system)
-               (and (default-boundp 'buffer-file-coding-system)
-                    (default-value 'buffer-file-coding-system))
-               'iso-latin-1))))
+         (if (fboundp 'select-message-coding-system)
+             (select-message-coding-system) ; Emacs has this since at least 21.1
+           (if (and (local-variable-p 'buffer-file-coding-system
+                                      (current-buffer)) ;XEmacs needs two args
+                    ;; We're not sure why, but buffer-file-coding-system
+                    ;; tends to get set to undecided-unix.
+                    (not (memq buffer-file-coding-system
+                               '(undecided undecided-unix undecided-dos))))
+               buffer-file-coding-system
+             (or (and (boundp 'sendmail-coding-system) sendmail-coding-system)
+                 (and (default-boundp 'buffer-file-coding-system)
+                      (default-value 'buffer-file-coding-system))
+                 'iso-latin-1)))))
     ;; Older versions of spost do not support -msgid and -mime.
     (unless mh-send-uses-spost-flag
       ;; Adding a Message-ID field looks good, makes it easier to search for
@@ -1054,6 +1056,7 @@ letter."
 (defun mh-insert-x-mailer ()
   "Append an X-Mailer field to the header.
 The versions of MH-E, Emacs, and MH are shown."
+  (or mh-variant-in-use (mh-variant-set mh-variant))
   ;; Lazily initialize mh-x-mailer-string.
   (when (and mh-insert-x-mailer-flag (null mh-x-mailer-string))
     (setq mh-x-mailer-string
diff --git a/lisp/mh-e/mh-compat.el b/lisp/mh-e/mh-compat.el
index 2307812736..ffeb6937f7 100644
--- a/lisp/mh-e/mh-compat.el
+++ b/lisp/mh-e/mh-compat.el
@@ -65,7 +65,8 @@ Simulate NOERROR argument in XEmacs which lacks it."
 Case is ignored if CASE-FOLD is non-nil.
 This function is used by Emacs versions that lack `assoc-string',
 introduced in Emacs 22."
-  (if case-fold
+  ;; Test for fboundp is solely to silence compiler for Emacs >= 22.1.
+  (if (and case-fold (fboundp 'assoc-ignore-case))
       (assoc-ignore-case key list)
     (assoc key list)))
 
@@ -307,7 +308,8 @@ This function is used by XEmacs that lacks `replace-regexp-in-string'.
 The function `replace-in-string' is used instead.
 The arguments FIXEDCASE, SUBEXP, and START, used by
 `replace-in-string' are ignored."
-  (replace-in-string string regexp rep literal))
+  (if (featurep 'xemacs)                ; silence Emacs compiler
+      (replace-in-string string regexp rep literal)))
 
 (defun-mh mh-test-completion
   test-completion (string collection &optional predicate)
diff --git a/lisp/mh-e/mh-e.el b/lisp/mh-e/mh-e.el
index 05ff672da5..4515144d14 100644
--- a/lisp/mh-e/mh-e.el
+++ b/lisp/mh-e/mh-e.el
@@ -410,6 +410,8 @@ gnus-version)
   (require 'gnus)
   gnus-version)
 
+(defvar mh-variant)
+
 ;;;###autoload
 (defun mh-version ()
   "Display version information about MH-E and the MH mail handling system."
@@ -430,6 +432,7 @@ gnus-version)
   ;; Emacs version.
   (insert (emacs-version) "\n\n")
   ;; MH version.
+  (or mh-variant-in-use (mh-variant-set mh-variant))
   (if mh-variant-in-use
       (insert mh-variant-in-use "\n"
               " mh-progs:\t" mh-progs "\n"
@@ -876,6 +879,7 @@ variant."
 (defun mh-variant-p (&rest variants)
   "Return t if variant is any of VARIANTS.
 Currently known variants are `MH', `nmh', and `gnu-mh'."
+  (or mh-variant-in-use (mh-variant-set mh-variant))
   (let ((variant-in-use
          (cadr (assoc 'variant (assoc mh-variant-in-use (mh-variants))))))
     (not (null (member variant-in-use variants)))))
@@ -941,6 +945,8 @@ finally GNU mailutils MH."
       (when (not (mh-variant-set-variant variant))
         (message "Warning: %s variant not found. Autodetecting..." variant)
         (mh-variant-set 'autodetect)))
+     ((null valid-list)
+      (message "Unknown variant %s; can't find MH anywhere" variant))
      (t
       (message "Unknown variant %s; use %s"
                variant
@@ -972,6 +978,7 @@ necessary and can actually cause problems."
   :set (lambda (symbol value)
          (set-default symbol value)     ;Done in mh-variant-set-variant!
          (mh-variant-set value))
+  :initialize 'custom-initialize-default
   :group 'mh-e
   :package-version '(MH-E . "8.0"))
 
diff --git a/lisp/mh-e/mh-folder.el b/lisp/mh-e/mh-folder.el
index 23cc2baab7..82e28e8741 100644
--- a/lisp/mh-e/mh-folder.el
+++ b/lisp/mh-e/mh-folder.el
@@ -88,7 +88,7 @@ the MH mail system."
 When desktop creates a buffer, DESKTOP-BUFFER-FILE-NAME holds the
 file name to visit, DESKTOP-BUFFER-NAME holds the desired buffer
 name, and DESKTOP-BUFFER-MISC holds a list of miscellaneous info
-used by the `desktop-buffer-handlers' functions."
+used by the `desktop-buffer-mode-handlers' functions."
   (mh-find-path)
   (mh-visit-folder desktop-buffer-name)
   (current-buffer))
diff --git a/lisp/mh-e/mh-thread.el b/lisp/mh-e/mh-thread.el
index 41a79b6f0b..ff8e6602e5 100644
--- a/lisp/mh-e/mh-thread.el
+++ b/lisp/mh-e/mh-thread.el
@@ -647,20 +647,17 @@ Only information about messages in MSG-LIST are added to the tree."
 
 (defun mh-thread-set-tables (folder)
   "Use the tables of FOLDER in current buffer."
-  (mh-flet
-   ((mh-get-table (symbol)
-                  (with-current-buffer folder
-                    (symbol-value symbol))))
-   (setq mh-thread-id-hash (mh-get-table 'mh-thread-id-hash))
-   (setq mh-thread-subject-hash (mh-get-table 'mh-thread-subject-hash))
-   (setq mh-thread-id-table (mh-get-table 'mh-thread-id-table))
-   (setq mh-thread-id-index-map (mh-get-table 'mh-thread-id-index-map))
-   (setq mh-thread-index-id-map (mh-get-table 'mh-thread-index-id-map))
-   (setq mh-thread-scan-line-map (mh-get-table 'mh-thread-scan-line-map))
-   (setq mh-thread-subject-container-hash
-         (mh-get-table 'mh-thread-subject-container-hash))
-   (setq mh-thread-duplicates (mh-get-table 'mh-thread-duplicates))
-   (setq mh-thread-history (mh-get-table 'mh-thread-history))))
+  (dolist (v '(mh-thread-id-hash
+               mh-thread-subject-hash
+               mh-thread-id-table
+               mh-thread-id-index-map
+               mh-thread-index-id-map
+               mh-thread-scan-line-map
+               mh-thread-subject-container-hash
+               mh-thread-duplicates
+               mh-thread-history))
+    ;; Emacs >= 22.1: (buffer-local-value v folder).
+    (set v (with-current-buffer folder (symbol-value v)))))
 
 (defun mh-thread-process-in-reply-to (reply-to-header)
   "Extract message id's from REPLY-TO-HEADER.
diff --git a/lisp/mh-e/mh-utils.el b/lisp/mh-e/mh-utils.el
index 66d87262bc..7bda0a6847 100644
--- a/lisp/mh-e/mh-utils.el
+++ b/lisp/mh-e/mh-utils.el
@@ -177,6 +177,7 @@ been set. This hook can be used the change the value of these
 variables if you need to run with different values between MH and
 MH-E."
   (unless mh-find-path-run
+    (or mh-variant-in-use (mh-variant-set mh-variant))
     ;; Sanity checks.
     (if (and (getenv "MH")
              (not (file-readable-p (getenv "MH"))))
diff --git a/lisp/minibuffer.el b/lisp/minibuffer.el
index e3ae2912a8..3227917494 100644
--- a/lisp/minibuffer.el
+++ b/lisp/minibuffer.el
@@ -987,7 +987,8 @@ Moves point to the end of the new text."
 (defcustom completion-cycle-threshold nil
   "Number of completion candidates below which cycling is used.
 Depending on this setting `completion-in-region' may use cycling,
-like `minibuffer-force-complete'.
+whereby invoking a completion command several times in a row
+completes to each of the candidates in turn, in a cyclic manner.
 If nil, cycling is never used.
 If t, cycling is always used.
 If an integer, cycling is used so long as there are not more
@@ -2951,6 +2952,8 @@ or a symbol, see `completion-pcm--merge-completions'."
         (`(,(and s1 (pred stringp)) ,(and s2 (pred stringp)) . ,rest)
          (setq p (cons (concat s1 s2) rest)))
         (`(,(and p1 (pred symbolp)) ,(and p2 (guard (eq p1 p2))) . ,_)
+         ;; Unused lexical variable warning due to body not using p1, p2.
+         ;; https://debbugs.gnu.org/16771
          (setq p (cdr p)))
         (`(star ,(pred symbolp) . ,rest) (setq p `(star . ,rest)))
         (`(,(pred symbolp) star . ,rest) (setq p `(star . ,rest)))
diff --git a/lisp/mwheel.el b/lisp/mwheel.el
index cbd7813762..f055df9ee8 100644
--- a/lisp/mwheel.el
+++ b/lisp/mwheel.el
@@ -52,38 +52,25 @@
   ;; Sync the bindings.
   (when (bound-and-true-p mouse-wheel-mode) (mouse-wheel-mode 1)))
 
-(defvar mouse-wheel-down-button 4)
-(make-obsolete-variable 'mouse-wheel-down-button
-                        'mouse-wheel-down-event
-			"22.1")
 (defcustom mouse-wheel-down-event
   (if (or (featurep 'w32-win) (featurep 'ns-win))
       'wheel-up
-    (intern (format "mouse-%s" mouse-wheel-down-button)))
+    'mouse-4)
   "Event used for scrolling down."
   :group 'mouse
   :type 'symbol
   :set 'mouse-wheel-change-button)
 
-(defvar mouse-wheel-up-button 5)
-(make-obsolete-variable 'mouse-wheel-up-button
-                        'mouse-wheel-up-event
-			"22.1")
 (defcustom mouse-wheel-up-event
   (if (or (featurep 'w32-win) (featurep 'ns-win))
       'wheel-down
-    (intern (format "mouse-%s" mouse-wheel-up-button)))
+    'mouse-5)
   "Event used for scrolling up."
   :group 'mouse
   :type 'symbol
   :set 'mouse-wheel-change-button)
 
-(defvar mouse-wheel-click-button 2)
-(make-obsolete-variable 'mouse-wheel-click-button
-                        'mouse-wheel-click-event
-			"22.1")
-(defcustom mouse-wheel-click-event
-  (intern (format "mouse-%s" mouse-wheel-click-button))
+(defcustom mouse-wheel-click-event 'mouse-2
   "Event that should be temporarily inhibited after mouse scrolling.
 The mouse wheel is typically on the mouse-2 button, so it may easily
 happen that text is accidentally yanked into the buffer when
@@ -150,30 +137,18 @@ This can be slightly disconcerting, but some people prefer it."
 
 ;;; For tilt-scroll
 ;;;
-(defcustom mwheel-tilt-scroll-p nil
+(defcustom mouse-wheel-tilt-scroll nil
   "Enable scroll using tilting mouse wheel."
   :group 'mouse
   :type 'boolean
   :version "26.1")
 
-(defcustom mwheel-flip-direction nil
+(defcustom mouse-wheel-flip-direction nil
   "Swap direction of 'wheel-right and 'wheel-left."
   :group 'mouse
   :type 'boolean
   :version "26.1")
 
-(defcustom mwheel-scroll-left-function 'scroll-left
-  "Function that does the job of scrolling left."
-  :group 'mouse
-  :type 'function
-  :version "26.1")
-
-(defcustom mwheel-scroll-right-function 'scroll-right
-  "Function that does the job of scrolling right."
-  :group 'mouse
-  :type 'function
-  :version "26.1")
-
 (eval-and-compile
   (if (fboundp 'event-button)
       (fset 'mwheel-event-button 'event-button)
@@ -211,6 +186,12 @@ This can be slightly disconcerting, but some people prefer it."
 (defvar mwheel-scroll-down-function 'scroll-down
   "Function that does the job of scrolling downward.")
 
+(defvar mwheel-scroll-left-function 'scroll-left
+  "Function that does the job of scrolling left.")
+
+(defvar mwheel-scroll-right-function 'scroll-right
+  "Function that does the job of scrolling right.")
+
 (defvar mouse-wheel-left-event
   (if (or (featurep 'w32-win) (featurep 'ns-win))
       'wheel-left
@@ -293,13 +274,13 @@ non-Windows systems."
                    ;; Make sure we do indeed scroll to the end of the buffer.
                    (end-of-buffer (while t (funcall mwheel-scroll-up-function)))))
                 ((eq button mouse-wheel-left-event) ; for tilt scroll
-                 (when mwheel-tilt-scroll-p
-                   (funcall (if mwheel-flip-direction
+                 (when mouse-wheel-tilt-scroll
+                   (funcall (if mouse-wheel-flip-direction
                                 mwheel-scroll-right-function
                               mwheel-scroll-left-function) amt)))
                 ((eq button mouse-wheel-right-event) ; for tilt scroll
-                 (when mwheel-tilt-scroll-p
-                   (funcall (if mwheel-flip-direction
+                 (when mouse-wheel-tilt-scroll
+                   (funcall (if mouse-wheel-flip-direction
                                 mwheel-scroll-left-function
                               mwheel-scroll-right-function) amt)))
 		(t (error "Bad binding in mwheel-scroll"))))
diff --git a/lisp/net/ange-ftp.el b/lisp/net/ange-ftp.el
index b1e0bf24aa..c3650afa9a 100644
--- a/lisp/net/ange-ftp.el
+++ b/lisp/net/ange-ftp.el
@@ -3633,7 +3633,7 @@ so return the size on the remote host exactly. See RFC 3659."
 ;; 			     newname))
 ;; 	res)
 ;;     (set-process-sentinel proc 'ange-ftp-copy-file-locally-sentinel)
-;;     (process-kill-without-query proc)
+;;     (set-process-query-on-exit-flag proc nil)
 ;;     (with-current-buffer (process-buffer proc)
 ;;       (set (make-local-variable 'copy-cont) cont))))
 ;;
diff --git a/lisp/net/eudc-bob.el b/lisp/net/eudc-bob.el
index 57b748b150..584d1a9d0d 100644
--- a/lisp/net/eudc-bob.el
+++ b/lisp/net/eudc-bob.el
@@ -312,7 +312,7 @@ display a button."
 	(define-key map [return] 'goto-address-at-point)
 	(define-key map (if (featurep 'xemacs)
 			    [button2]
-			  [down-mouse-2]) 'goto-address-at-mouse)
+			  [down-mouse-2]) 'goto-address-at-point)
 	map))
 
 (set-keymap-parent eudc-bob-image-keymap eudc-bob-generic-keymap)
diff --git a/lisp/net/eww.el b/lisp/net/eww.el
index caac96a485..66b1767b56 100644
--- a/lisp/net/eww.el
+++ b/lisp/net/eww.el
@@ -1532,7 +1532,8 @@ Differences in #targets are ignored."
                   eww-download-directory)))
       (goto-char (point-min))
       (re-search-forward "\r?\n\r?\n")
-      (write-region (point) (point-max) file)
+      (let ((coding-system-for-write 'no-conversion))
+        (write-region (point) (point-max) file))
       (message "Saved %s" file))))
 
 (defun eww-decode-url-file-name (string)
diff --git a/lisp/net/goto-addr.el b/lisp/net/goto-addr.el
index ed615d10eb..cc1cdd1518 100644
--- a/lisp/net/goto-addr.el
+++ b/lisp/net/goto-addr.el
@@ -220,10 +220,6 @@ and `goto-address-fontify-p'."
 ;; code to find and goto addresses; much of this has been blatantly
 ;; snarfed from browse-url.el
 
-;;;###autoload
-(define-obsolete-function-alias
-  'goto-address-at-mouse 'goto-address-at-point "22.1")
-
 ;;;###autoload
 (defun goto-address-at-point (&optional event)
   "Send to the e-mail address or load the URL at point.
diff --git a/lisp/net/net-utils.el b/lisp/net/net-utils.el
index 9edd42b857..c9e80804bd 100644
--- a/lisp/net/net-utils.el
+++ b/lisp/net/net-utils.el
@@ -86,8 +86,6 @@ These options can be used to limit how many ICMP packets are emitted."
   :group 'net-utils
   :type  '(repeat string))
 
-(define-obsolete-variable-alias 'ipconfig-program 'ifconfig-program "22.2")
-
 (defcustom ifconfig-program
   (cond ((eq system-type 'windows-nt) "ipconfig")
         ((executable-find "ifconfig") "ifconfig")
@@ -99,9 +97,6 @@ These options can be used to limit how many ICMP packets are emitted."
   :group 'net-utils
   :type  'string)
 
-(define-obsolete-variable-alias 'ipconfig-program-options
-  'ifconfig-program-options "22.2")
-
 (defcustom ifconfig-program-options
   (cond ((string-match "ipconfig\\'" ifconfig-program) '("/all"))
         ((string-match "ifconfig\\'" ifconfig-program) '("-a"))
diff --git a/lisp/net/quickurl.el b/lisp/net/quickurl.el
index 5321807cd6..a5ba26bcdc 100644
--- a/lisp/net/quickurl.el
+++ b/lisp/net/quickurl.el
@@ -116,8 +116,13 @@
   :type  'function
   :group 'quickurl)
 
-(defcustom quickurl-assoc-function #'assoc-ignore-case
+(defun quickurl--assoc-function (key alist)
+  "Default function for `quickurl-assoc-function'."
+  (assoc-string key alist t))
+
+(defcustom quickurl-assoc-function #'quickurl--assoc-function
   "Function to use for alist lookup into `quickurl-urls'."
+  :version "26.1"                 ; was the obsolete assoc-ignore-case
   :type  'function
   :group 'quickurl)
 
@@ -150,7 +155,7 @@ could be used here."
 (defconst quickurl-reread-hook-postfix
     "
 ;; Local Variables:
-;; eval: (progn (require 'quickurl) (add-hook 'local-write-file-hooks (lambda () (quickurl-read) nil)))
+;; eval: (progn (require 'quickurl) (add-hook 'write-file-functions (lambda () (quickurl-read) nil) nil t))
 ;; End:
 "
   "Example `quickurl-postfix' text that adds a local variable to the
diff --git a/lisp/net/tramp-adb.el b/lisp/net/tramp-adb.el
index cb80506786..7a0ea71aee 100644
--- a/lisp/net/tramp-adb.el
+++ b/lisp/net/tramp-adb.el
@@ -458,13 +458,13 @@ pass to the OPERATION."
 			   result)))))))))
 
 (defun tramp-adb-get-ls-command (vec)
-  "Determine `ls' command at its arguments."
+  "Determine `ls' command and its arguments."
   (with-tramp-connection-property vec "ls"
     (tramp-message vec 5 "Finding a suitable `ls' command")
     (cond
      ;; Support Android derived systems where "ls" command is provided
      ;; by GNU Coreutils. Force "ls" to print one column and set
-     ;; time-style to imitate other "ls" flavours.
+     ;; time-style to imitate other "ls" flavors.
      ((tramp-adb-send-command-and-check
        vec "ls --time-style=long-iso /dev/null")
       "ls -1 --time-style=long-iso")
diff --git a/lisp/net/tramp-archive.el b/lisp/net/tramp-archive.el
index 87b69767f0..0b5a351dea 100644
--- a/lisp/net/tramp-archive.el
+++ b/lisp/net/tramp-archive.el
@@ -62,6 +62,7 @@
 ;; * ".lzh", ".LZH" - Microsoft Windows compressed LHA archives
 ;; * ".msu", ".MSU" - Microsoft Windows Update packages
 ;; * ".mtree" - BSD mtree format
+;; * ".odb" ".odf" ".odg" ".odp" ".ods" ".odt" - OpenDocument formats
 ;; * ".pax" - Posix archives
 ;; * ".rar" - RAR archives
 ;; * ".rpm" - Red Hat packages
@@ -126,9 +127,9 @@
 ;; <https://github.com/libarchive/libarchive/wiki/LibarchiveFormats>
 ;;;###autoload
 (defconst tramp-archive-suffixes
-  ;; "cab", "lzh" and "zip" are included with lower and upper letters,
-  ;; because Microsoft Windows provides them often with capital
-  ;; letters.
+  ;; "cab", "lzh", "msu" and "zip" are included with lower and upper
+  ;; letters, because Microsoft Windows provides them often with
+  ;; capital letters.
   '("7z" ;; 7-Zip archives.
     "apk" ;; Android package kits.  Not in libarchive testsuite.
     "ar" ;; UNIX archiver formats.
@@ -142,6 +143,7 @@
     "lzh" "LZH" ;; Microsoft Windows compressed LHA archives.
     "msu" "MSU" ;; Microsoft Windows Update packages.  Not in testsuite.
     "mtree" ;; BSD mtree format.
+    "odb" "odf" "odg" "odp" "ods" "odt" ;; OpenDocument formats.  Not in testsuite.
     "pax" ;; Posix archives.
     "rar" ;; RAR archives.
     "rpm" ;; Red Hat packages.
diff --git a/lisp/net/tramp-sh.el b/lisp/net/tramp-sh.el
index ff5d404aaa..0cdf42de68 100644
--- a/lisp/net/tramp-sh.el
+++ b/lisp/net/tramp-sh.el
@@ -962,15 +962,16 @@ busybox awk '{}' </dev/null"
 (defconst tramp-vc-registered-read-file-names
   "echo \"(\"
 while read file; do
+    quoted=`echo \"$file\" | sed -e \"s/\\\"/\\\\\\\\\\\\\\\\\\\"/\"`
     if %s \"$file\"; then
-	echo \"(\\\"$file\\\" \\\"file-exists-p\\\" t)\"
+	echo \"(\\\"$quoted\\\" \\\"file-exists-p\\\" t)\"
     else
-	echo \"(\\\"$file\\\" \\\"file-exists-p\\\" nil)\"
+	echo \"(\\\"$quoted\\\" \\\"file-exists-p\\\" nil)\"
     fi
     if %s \"$file\"; then
-	echo \"(\\\"$file\\\" \\\"file-readable-p\\\" t)\"
+	echo \"(\\\"$quoted\\\" \\\"file-readable-p\\\" t)\"
     else
-	echo \"(\\\"$file\\\" \\\"file-readable-p\\\" nil)\"
+	echo \"(\\\"$quoted\\\" \\\"file-readable-p\\\" nil)\"
     fi
 done
 echo \")\""
@@ -2054,6 +2055,7 @@ file names."
 	  (t2 (tramp-tramp-file-p newname))
 	  (length (tramp-compat-file-attribute-size
 		   (file-attributes (file-truename filename))))
+	  ;; `file-extended-attributes' exists since Emacs 24.4.
 	  (attributes (and preserve-extended-attributes
 			   (apply 'file-extended-attributes (list filename)))))
 
@@ -4173,7 +4175,7 @@ process to set up.  VEC specifies the connection."
 	      cs-encode
 	      (coding-system-change-eol-conversion
 	       cs-encode (if (string-match "^Darwin" uname) 'mac 'unix)))
-	(tramp-send-command vec "echo foo ; echo bar" t)
+	(tramp-send-command vec "(echo foo ; echo bar)" t)
 	(goto-char (point-min))
 	(when (search-forward "\r" nil t)
 	  (setq cs-decode (coding-system-change-eol-conversion cs-decode 'dos)))
diff --git a/lisp/net/tramp.el b/lisp/net/tramp.el
index bae039dba1..fe9f197694 100644
--- a/lisp/net/tramp.el
+++ b/lisp/net/tramp.el
@@ -3564,7 +3564,7 @@ support symbolic links."
 		  (concat (file-remote-p filename)
 			  (substitute-in-file-name localname))))))
       ;; "/m:h:~" does not work for completion.  We use "/m:h:~/".
-      (if (string-match "^~$" localname)
+      (if (and (stringp localname) (string-equal "~" localname))
 	  (concat filename "/")
 	filename))))
 
@@ -4459,6 +4459,7 @@ Invokes `password-read' if available, `read-passwd' else."
 					  auth-passwd))))
 	       ;; Try the password cache.
 	       (let ((password (password-read pw-prompt key)))
+		 ;; FIXME test password works before caching it.
 		 (password-cache-add key password)
 		 password)
 	       ;; Else, get the password interactively.
diff --git a/lisp/novice.el b/lisp/novice.el
index b9cd568ace..aaad4fabfe 100644
--- a/lisp/novice.el
+++ b/lisp/novice.el
@@ -34,9 +34,6 @@
 ;; The command is found in this-command
 ;; and the keys are returned by (this-command-keys).
 
-;;;###autoload
-(define-obsolete-variable-alias 'disabled-command-hook
-  'disabled-command-function "22.1")
 ;;;###autoload
 (defvar disabled-command-function 'disabled-command-function
   "Function to call to handle disabled commands.
diff --git a/lisp/obsolete/iswitchb.el b/lisp/obsolete/iswitchb.el
index 55e81d08d1..d03621df3c 100644
--- a/lisp/obsolete/iswitchb.el
+++ b/lisp/obsolete/iswitchb.el
@@ -353,8 +353,6 @@ See also `iswitchb-newbuffer'."
   :type 'boolean
   :group 'iswitchb)
 
-(define-obsolete-variable-alias 'iswitchb-use-fonts 'iswitchb-use-faces "22.1")
-
 (defcustom iswitchb-use-faces t
   "Non-nil means use font-lock faces for showing first match."
   :type 'boolean
diff --git a/lisp/obsolete/options.el b/lisp/obsolete/options.el
deleted file mode 100644
index 41637a6ecf..0000000000
--- a/lisp/obsolete/options.el
+++ /dev/null
@@ -1,140 +0,0 @@
-;;; options.el --- edit Options command for Emacs
-
-;; Copyright (C) 1985, 2001-2018 Free Software Foundation, Inc.
-
-;; Maintainer: emacs-devel@gnu.org
-;; Obsolete-since: 22.1
-
-;; This file is part of GNU Emacs.
-
-;; GNU Emacs is free software: you can redistribute it and/or modify
-;; it under the terms of the GNU General Public License as published by
-;; the Free Software Foundation, either version 3 of the License, or
-;; (at your option) any later version.
-
-;; GNU Emacs is distributed in the hope that it will be useful,
-;; but WITHOUT ANY WARRANTY; without even the implied warranty of
-;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-;; GNU General Public License for more details.
-
-;; You should have received a copy of the GNU General Public License
-;; along with GNU Emacs.  If not, see <https://www.gnu.org/licenses/>.
-
-;;; Commentary:
-
-;; This code provides functions to list and edit the values of all global
-;; option variables known to loaded Emacs Lisp code.  There are two entry
-;; points, `list-options' and `edit' options'.  The latter enters a major
-;; mode specifically for editing option values.  Do `M-x describe-mode' in
-;; that context for more details.
-
-;; The customization buffer feature is intended to make this obsolete.
-
-;;; Code:
-
-;;;###autoload
-(defun list-options ()
-  "Display a list of Emacs user options, with values and documentation.
-It is now better to use Customize instead."
-  (interactive)
-  (with-output-to-temp-buffer "*List Options*"
-    (let (vars)
-      (princ "This facility is obsolete; we recommend using M-x customize instead.")
-
-      (mapatoms (function (lambda (sym)
-			    (if (custom-variable-p sym)
-				(setq vars (cons sym vars))))))
-      (setq vars (sort vars 'string-lessp))
-      (while vars
-	(let ((sym (car vars)))
-	  (when (boundp sym)
-	    (princ ";; ")
-	    (prin1 sym)
-	    (princ ":\n\t")
-	    (prin1 (symbol-value sym))
-	    (terpri)
-	    (princ (substitute-command-keys
-		    (documentation-property sym 'variable-documentation)))
-	    (princ "\n;;\n"))
-	  (setq vars (cdr vars))))
-      (with-current-buffer "*List Options*"
-	(Edit-options-mode)
-	(setq buffer-read-only t)))))
-
-;;;###autoload
-(defun edit-options ()
-  "Edit a list of Emacs user option values.
-Selects a buffer containing such a list,
-in which there are commands to set the option values.
-Type \\[describe-mode] in that buffer for a list of commands.
-
-The Custom feature is intended to make this obsolete."
-  (interactive)
-  (list-options)
-  (pop-to-buffer "*List Options*"))
-
-(defvar Edit-options-mode-map
-  (let ((map (make-keymap)))
-    (define-key map "s" 'Edit-options-set)
-    (define-key map "x" 'Edit-options-toggle)
-    (define-key map "1" 'Edit-options-t)
-    (define-key map "0" 'Edit-options-nil)
-    (define-key map "p" 'backward-paragraph)
-    (define-key map " " 'forward-paragraph)
-    (define-key map "n" 'forward-paragraph)
-    map)
-  "")
-
-;; Edit Options mode is suitable only for specially formatted data.
-(put 'Edit-options-mode 'mode-class 'special)
-
-(define-derived-mode Edit-options-mode emacs-lisp-mode "Options"
-  "\\<Edit-options-mode-map>\
-Major mode for editing Emacs user option settings.
-Special commands are:
-\\[Edit-options-set] -- set variable point points at.  New value read using minibuffer.
-\\[Edit-options-toggle] -- toggle variable, t -> nil, nil -> t.
-\\[Edit-options-t] -- set variable to t.
-\\[Edit-options-nil] -- set variable to nil.
-Changed values made by these commands take effect immediately.
-
-Each variable description is a paragraph.
-For convenience, the characters \\[backward-paragraph] and \\[forward-paragraph] move back and forward by paragraphs."
-  (setq-local paragraph-separate "[^\^@-\^?]")
-  (setq-local paragraph-start "\t")
-  (setq-local truncate-lines t))
-
-(defun Edit-options-set () (interactive)
-  (Edit-options-modify
-   (lambda (var) (eval-minibuffer (concat "New " (symbol-name var) ": ")))))
-
-(defun Edit-options-toggle () (interactive)
-  (Edit-options-modify (lambda (var) (not (symbol-value var)))))
-
-(defun Edit-options-t () (interactive)
-  (Edit-options-modify (lambda (var) t)))
-
-(defun Edit-options-nil () (interactive)
-  (Edit-options-modify (lambda (var) nil)))
-
-(defun Edit-options-modify (modfun)
-  (save-excursion
-   (let ((buffer-read-only nil) var pos)
-     (re-search-backward "^;; \\|\\`")
-     (forward-char 3)
-     (setq pos (point))
-     (save-restriction
-       (narrow-to-region pos (progn (end-of-line) (1- (point))))
-       (goto-char pos)
-       (setq var (read (current-buffer))))
-     (goto-char pos)
-     (forward-line 1)
-     (forward-char 1)
-     (save-excursion
-       (set var (funcall modfun var)))
-     (kill-sexp 1)
-     (prin1 (symbol-value var) (current-buffer)))))
-
-(provide 'options)
-
-;;; options.el ends here
diff --git a/lisp/obsolete/tpu-mapper.el b/lisp/obsolete/tpu-mapper.el
index 6a5a83c888..4cc2404e4e 100644
--- a/lisp/obsolete/tpu-mapper.el
+++ b/lisp/obsolete/tpu-mapper.el
@@ -56,7 +56,7 @@
           (set-buffer "Keys")
           (insert (format"(global-set-key %s %s)\n" tpu-key func))
           (set-buffer "Gold-Keys")
-          (insert (format "(define-key GOLD-map %s %s)\n" tpu-key gold-func))))
+          (insert (format "(define-key tpu-gold-map %s %s)\n" tpu-key gold-func))))
     (message "Press %s%s: " ident descrip)
     (setq tpu-key-seq (read-event)
           tpu-key (format "[%s]" tpu-key-seq))
@@ -203,7 +203,7 @@ your local X guru can try to figure out why the key is being ignored."
 ")
   (set-buffer "Directions")
 
-  (tpu-map-key "PF1"  " - The GOLD key"               "GOLD-map"                 "'keyboard-quit")
+  (tpu-map-key "PF1"  " - The GOLD key"               "tpu-gold-map"              "'keyboard-quit")
   (tpu-map-key "PF2"  " - The Keypad Help key"        "'tpu-help"                 "'help-for-help")
   (tpu-map-key "PF3"  " - The Find/Find-Next key"     "'tpu-search-again"         "'tpu-search")
   (tpu-map-key "PF4"  " - The Del/Undelete Line key"  "'tpu-delete-current-line"  "'tpu-undelete-lines")
diff --git a/lisp/org/org-agenda.el b/lisp/org/org-agenda.el
index 9aaec33070..3d4379b022 100644
--- a/lisp/org/org-agenda.el
+++ b/lisp/org/org-agenda.el
@@ -2201,10 +2201,14 @@ The following commands are available:
   (add-hook 'post-command-hook 'org-agenda-update-agenda-type nil 'local)
   (add-hook 'pre-command-hook 'org-unhighlight nil 'local)
   ;; Make sure properties are removed when copying text
-  (add-hook 'filter-buffer-substring-functions
-	    (lambda (fun start end delete)
-	      (substring-no-properties (funcall fun start end delete)))
-	    nil t)
+  (if (boundp 'filter-buffer-substring-functions)
+      (add-hook 'filter-buffer-substring-functions
+                (lambda (fun start end delete)
+                  (substring-no-properties (funcall fun start end delete)))
+                nil t)
+    ;; Emacs >= 24.4.
+    (add-function :filter-return (local 'filter-buffer-substring-function)
+                  #'substring-no-properties))
   (unless org-agenda-keep-modes
     (setq org-agenda-follow-mode org-agenda-start-with-follow-mode
 	  org-agenda-entry-text-mode org-agenda-start-with-entry-text-mode))
diff --git a/lisp/org/org-element.el b/lisp/org/org-element.el
index 844349c2fc..a63aae5329 100644
--- a/lisp/org/org-element.el
+++ b/lisp/org/org-element.el
@@ -4721,7 +4721,7 @@ indentation removed from its contents."
 ;; Cache is enabled by default, but can be disabled globally with
 ;; `org-element-use-cache'.  `org-element-cache-sync-idle-time',
 ;; org-element-cache-sync-duration' and `org-element-cache-sync-break'
-;; can be tweaked to control caching behaviour.
+;; can be tweaked to control caching behavior.
 ;;
 ;; Internally, parsed elements are stored in an AVL tree,
 ;; `org-element--cache'.  This tree is updated lazily: whenever
diff --git a/lisp/org/org-indent.el b/lisp/org/org-indent.el
index ef68c3c4fa..f2cd6a66fb 100644
--- a/lisp/org/org-indent.el
+++ b/lisp/org/org-indent.el
@@ -183,11 +183,15 @@ during idle time."
 		  org-hide-leading-stars)
       (setq-local org-hide-leading-stars t))
     (org-indent--compute-prefixes)
-    (add-hook 'filter-buffer-substring-functions
-	      (lambda (fun start end delete)
-		(org-indent-remove-properties-from-string
-		 (funcall fun start end delete)))
-	      nil t)
+    (if (boundp 'filter-buffer-substring-functions)
+	(add-hook 'filter-buffer-substring-functions
+		  (lambda (fun start end delete)
+		    (org-indent-remove-properties-from-string
+		     (funcall fun start end delete)))
+		  nil t)
+      ;; Emacs >= 24.4.
+      (add-function :filter-return (local 'filter-buffer-substring-function)
+		    #'org-indent-remove-properties-from-string))
     (add-hook 'after-change-functions 'org-indent-refresh-maybe nil 'local)
     (add-hook 'before-change-functions
 	      'org-indent-notify-modified-headline nil 'local)
@@ -211,10 +215,13 @@ during idle time."
     (when (boundp 'org-hide-leading-stars-before-indent-mode)
       (setq-local org-hide-leading-stars
 		  org-hide-leading-stars-before-indent-mode))
-    (remove-hook 'filter-buffer-substring-functions
-		 (lambda (fun start end delete)
-		   (org-indent-remove-properties-from-string
-		    (funcall fun start end delete))))
+    (if (boundp 'filter-buffer-substring-functions)
+	(remove-hook 'filter-buffer-substring-functions
+		     (lambda (fun start end delete)
+		       (org-indent-remove-properties-from-string
+			(funcall fun start end delete))))
+      (remove-function (local 'filter-buffer-substring-function)
+		       #'org-indent-remove-properties-from-string))
     (remove-hook 'after-change-functions 'org-indent-refresh-maybe 'local)
     (remove-hook 'before-change-functions
 		 'org-indent-notify-modified-headline 'local)
diff --git a/lisp/org/org-pcomplete.el b/lisp/org/org-pcomplete.el
index a7cc09def4..1acb61590f 100644
--- a/lisp/org/org-pcomplete.el
+++ b/lisp/org/org-pcomplete.el
@@ -194,7 +194,7 @@ When completing for #+STARTUP, for example, this function returns
   "Complete arguments for the #+LANGUAGE file option."
   (require 'ox)
   (pcomplete-here
-   (pcomplete-uniqify-list
+   (pcomplete-uniquify-list
     (list org-export-default-language "en"))))
 
 (defvar org-default-priority)
@@ -219,7 +219,7 @@ When completing for #+STARTUP, for example, this function returns
 (defun pcomplete/org-mode/file-option/startup ()
   "Complete arguments for the #+STARTUP file option."
   (while (pcomplete-here
-	  (let ((opts (pcomplete-uniqify-list
+	  (let ((opts (pcomplete-uniquify-list
 		       (mapcar 'car org-startup-options))))
 	    ;; Some options are mutually exclusive, and shouldn't be completed
 	    ;; against if certain other options have already been seen.
@@ -248,7 +248,7 @@ When completing for #+STARTUP, for example, this function returns
 (defun pcomplete/org-mode/file-option/options ()
   "Complete arguments for the #+OPTIONS file option."
   (while (pcomplete-here
-	  (pcomplete-uniqify-list
+	  (pcomplete-uniquify-list
 	   (append
 	    ;; Hard-coded OPTION items always available.
 	    '("H:" "\\n:" "num:" "timestamp:" "arch:" "author:" "c:"
@@ -267,7 +267,7 @@ When completing for #+STARTUP, for example, this function returns
 (defun pcomplete/org-mode/file-option/infojs_opt ()
   "Complete arguments for the #+INFOJS_OPT file option."
   (while (pcomplete-here
-	  (pcomplete-uniqify-list
+	  (pcomplete-uniquify-list
 	   (mapcar (lambda (item) (format "%s:" (car item)))
 		   (bound-and-true-p org-html-infojs-opts-table))))))
 
@@ -283,7 +283,7 @@ When completing for #+STARTUP, for example, this function returns
 (defun pcomplete/org-mode/link ()
   "Complete against defined #+LINK patterns."
   (pcomplete-here
-   (pcomplete-uniqify-list
+   (pcomplete-uniquify-list
     (copy-sequence
      (append (mapcar 'car org-link-abbrev-alist-local)
 	     (mapcar 'car org-link-abbrev-alist))))))
@@ -293,13 +293,13 @@ When completing for #+STARTUP, for example, this function returns
   "Complete against TeX-style HTML entity names."
   (require 'org-entities)
   (while (pcomplete-here
-	  (pcomplete-uniqify-list (remove nil (mapcar 'car-safe org-entities)))
+	  (pcomplete-uniquify-list (remove nil (mapcar 'car-safe org-entities)))
 	  (substring pcomplete-stub 1))))
 
 (defvar org-todo-keywords-1)
 (defun pcomplete/org-mode/todo ()
   "Complete against known TODO keywords."
-  (pcomplete-here (pcomplete-uniqify-list (copy-sequence org-todo-keywords-1))))
+  (pcomplete-here (pcomplete-uniquify-list (copy-sequence org-todo-keywords-1))))
 
 (defvar org-todo-line-regexp)
 (defun pcomplete/org-mode/searchhead ()
@@ -315,14 +315,14 @@ This needs more work, to handle headings with lots of spaces in them."
 	       (push (org-make-org-heading-search-string
 		      (match-string-no-properties 3))
 		     tbl)))
-	   (pcomplete-uniqify-list tbl)))
+	   (pcomplete-uniquify-list tbl)))
        (substring pcomplete-stub 1))))
 
 (defun pcomplete/org-mode/tag ()
   "Complete a tag name.  Omit tags already set."
   (while (pcomplete-here
 	  (mapcar (lambda (x) (concat x ":"))
-		  (let ((lst (pcomplete-uniqify-list
+		  (let ((lst (pcomplete-uniquify-list
 			      (or (remq
 				   nil
 				   (mapcar (lambda (x) (org-string-nw-p (car x)))
@@ -339,7 +339,7 @@ This needs more work, to handle headings with lots of spaces in them."
   (pcomplete-here
    (mapcar (lambda (x)
 	     (concat x ": "))
-	   (let ((lst (pcomplete-uniqify-list
+	   (let ((lst (pcomplete-uniquify-list
 		       (copy-sequence
 			(org-buffer-property-keys nil t t t)))))
 	     (dolist (prop (org-entry-properties))
diff --git a/lisp/org/org-table.el b/lisp/org/org-table.el
index 3932671e8b..4bb5c91ce8 100644
--- a/lisp/org/org-table.el
+++ b/lisp/org/org-table.el
@@ -5428,7 +5428,7 @@ which will prompt for the width."
 ;; - orgtbl-uc-draw-cont (smooth unicode)
 
 ;; This is best viewed with the "DejaVu Sans Mono" font
-;; (use M-x set-default-font).
+;; (use M-x set-frame-font).
 
 (defun orgtbl-uc-draw-grid (value min max &optional width)
   "Draw a bar in a table using block unicode characters.
diff --git a/lisp/org/org.el b/lisp/org/org.el
index 4e4620549c..3ec6b4eabe 100644
--- a/lisp/org/org.el
+++ b/lisp/org/org.el
@@ -10641,7 +10641,7 @@ a timestamp or a link."
 		   (save-excursion
 		     ;; Do not validate action when point is on the
 		     ;; spaces right after the footnote label, in
-		     ;; order to be on par with behaviour on links.
+		     ;; order to be on par with behavior on links.
 		     (skip-chars-forward " \t")
 		     (let ((begin
 			    (org-element-property :contents-begin context)))
@@ -10794,7 +10794,7 @@ there is one, return it."
        (cons link end)))))
 
 ;; TODO: These functions are deprecated since `org-open-at-point'
-;; hard-codes behaviour for "file+emacs" and "file+sys" types.
+;; hard-codes behavior for "file+emacs" and "file+sys" types.
 (defun org-open-file-with-system (path)
   "Open file at PATH using the system way of opening it."
   (org-open-file path 'system))
@@ -19316,6 +19316,9 @@ INCLUDE-LINKED is passed to `org-display-inline-images'."
     (org-toggle-inline-images)
     (org-toggle-inline-images)))
 
+;; For without-x builds.
+(declare-function image-refresh "image" (spec &optional frame))
+
 (defun org-display-inline-images (&optional include-linked refresh beg end)
   "Display inline images.
 
@@ -22905,7 +22908,7 @@ matches in paragraphs or comments, use it."
 		      (match-string 0)
 		    "")))))))))))
 
-(declare-function message-goto-body "message" ())
+(declare-function message-goto-body "message" (&optional interactive))
 (defvar message-cite-prefix-regexp)	; From message.el
 
 (defun org-fill-element (&optional justify)
diff --git a/lisp/org/ox-odt.el b/lisp/org/ox-odt.el
index cdee568fc8..1fc697a6a8 100644
--- a/lisp/org/ox-odt.el
+++ b/lisp/org/ox-odt.el
@@ -2192,6 +2192,10 @@ SHORT-CAPTION are strings."
     (org-odt-create-manifest-file-entry media-type target-file)
     target-file))
 
+;; For --without-x builds.
+(declare-function clear-image-cache "image.c" (&optional filter))
+(declare-function image-size "image.c" (spec &optional pixels frame))
+
 (defun org-odt--image-size
   (file info &optional user-width user-height scale dpi embed-as)
   (let* ((--pixels-to-cms
diff --git a/lisp/outline.el b/lisp/outline.el
index 7cf56abd23..669935bbc1 100644
--- a/lisp/outline.el
+++ b/lisp/outline.el
@@ -1100,28 +1100,26 @@ convenient way to make a table of contents of the buffer."
     (save-restriction
       (narrow-to-region beg end)
       (goto-char (point-min))
-      (let ((buffer (current-buffer))
-	    start end)
-	(with-temp-buffer
-	  (with-current-buffer buffer
-	    ;; Boundary condition: starting on heading:
-	    (when (outline-on-heading-p)
-	      (outline-back-to-heading)
-	      (setq start (point)
-		    end (progn (outline-end-of-heading)
-			       (point)))
-	      (insert-buffer-substring buffer start end)
-	      (insert "\n\n")))
-	  (let ((temp-buffer (current-buffer)))
-	    (with-current-buffer buffer
-	      (while (outline-next-heading)
-		(unless (outline-invisible-p)
-		  (setq start (point)
-			end (progn (outline-end-of-heading) (point)))
-		  (with-current-buffer temp-buffer
-		    (insert-buffer-substring buffer start end)
-		    (insert "\n\n"))))))
-	  (kill-new (buffer-string)))))))
+      (let ((buffer (current-buffer)) start end)
+        (with-temp-buffer
+          (let ((temp-buffer (current-buffer)))
+            (with-current-buffer buffer
+              ;; Boundary condition: starting on heading:
+              (when (outline-on-heading-p)
+                (outline-back-to-heading)
+                (setq start (point)
+                      end (progn (outline-end-of-heading) (point)))
+                (with-current-buffer temp-buffer
+                  (insert-buffer-substring buffer start end)
+                  (insert "\n\n")))
+              (while (outline-next-heading)
+                (unless (outline-invisible-p)
+                  (setq start (point)
+                        end (progn (outline-end-of-heading) (point)))
+                  (with-current-buffer temp-buffer
+                    (insert-buffer-substring buffer start end)
+                    (insert "\n\n"))))))
+          (kill-new (buffer-string)))))))
 
 (provide 'outline)
 (provide 'noutline)
diff --git a/lisp/pcmpl-cvs.el b/lisp/pcmpl-cvs.el
index a3e2b2f5b3..dedc007223 100644
--- a/lisp/pcmpl-cvs.el
+++ b/lisp/pcmpl-cvs.el
@@ -122,7 +122,7 @@
     (let (cmds)
       (while (re-search-forward "^\\s-+\\([a-z]+\\)" nil t)
 	(setq cmds (cons (match-string 1) cmds)))
-      (pcomplete-uniqify-list cmds))))
+      (pcomplete-uniquify-list cmds))))
 
 (defun pcmpl-cvs-modules ()
   "Return a list of available modules under CVS."
@@ -132,7 +132,7 @@
     (let (entries)
       (while (re-search-forward "\\(\\S-+\\)$" nil t)
 	(setq entries (cons (match-string 1) entries)))
-      (pcomplete-uniqify-list entries))))
+      (pcomplete-uniquify-list entries))))
 
 (defun pcmpl-cvs-tags (&optional opers)
   "Return all the tags which could apply to the files related to OPERS."
@@ -149,7 +149,7 @@
 	    (error "Error in output from `cvs status -v'"))
 	  (setq tags (cons (match-string 1) tags))
 	  (forward-line))))
-    (pcomplete-uniqify-list tags)))
+    (pcomplete-uniquify-list tags)))
 
 (defun pcmpl-cvs-entries (&optional opers)
   "Return the Entries for the current directory.
@@ -187,6 +187,6 @@ operation character applies, as displayed by `cvs -n update'."
                 (setq entries (cons text entries))))
             (forward-line)))))
     (setq pcomplete-stub nondir)
-    (pcomplete-uniqify-list entries)))
+    (pcomplete-uniquify-list entries)))
 
 ;;; pcmpl-cvs.el ends here
diff --git a/lisp/pcmpl-gnu.el b/lisp/pcmpl-gnu.el
index 505d10c164..16c992662d 100644
--- a/lisp/pcmpl-gnu.el
+++ b/lisp/pcmpl-gnu.el
@@ -125,7 +125,7 @@
 	(while (re-search-forward
 		(concat "^\\s-*\\([^\n#%.$][^:=\n]*\\)\\s-*:[^=]") nil t)
 	  (setq rules (append (split-string (match-string 1)) rules))))
-      (pcomplete-uniqify-list rules))))
+      (pcomplete-uniquify-list rules))))
 
 (defcustom pcmpl-gnu-tarfile-regexp
   "\\.t\\(ar\\(\\.\\(gz\\|bz2\\|Z\\|xz\\)\\)?\\|gz\\|a[zZ]\\|z2\\)\\'"
diff --git a/lisp/pcmpl-linux.el b/lisp/pcmpl-linux.el
index ce42486fda..18cc647aac 100644
--- a/lisp/pcmpl-linux.el
+++ b/lisp/pcmpl-linux.el
@@ -43,7 +43,7 @@
   "Completion for GNU/Linux `kill', using /proc filesystem."
   (if (pcomplete-match "^-\\(.*\\)" 0)
       (pcomplete-here
-       (pcomplete-uniqify-list
+       (pcomplete-uniquify-list
 	(split-string
 	 (pcomplete-process-result "kill" "-l")))
        (pcomplete-match-string 1 0)))
@@ -82,7 +82,7 @@
 		 (args (split-string line " ")))
 	    (setq points (cons (nth 1 args) points)))
 	  (forward-line)))
-      (pcomplete-uniqify-list points))))
+      (pcomplete-uniquify-list points))))
 
 (defun pcomplete-pare-list (l r)
   "Destructively remove from list L all elements matching any in list R.
@@ -109,7 +109,7 @@ Test is done using `equal'."
 	    (setq points (cons (nth 1 args) points)))
 	  (forward-line)))
       (pcomplete-pare-list
-       (pcomplete-uniqify-list points)
+       (pcomplete-uniquify-list points)
        (cons "swap" (pcmpl-linux-mounted-directories))))))
 
 ;;; pcmpl-linux.el ends here
diff --git a/lisp/pcmpl-rpm.el b/lisp/pcmpl-rpm.el
index d3250babe6..74ddb8b9d7 100644
--- a/lisp/pcmpl-rpm.el
+++ b/lisp/pcmpl-rpm.el
@@ -96,7 +96,7 @@
 		    (pcomplete-process-result
 		     "rpm" "-q" (car pkgs) flag)))
       (setq pkgs (cdr pkgs)))
-    (pcomplete-uniqify-list (cdr provs))))
+    (pcomplete-uniquify-list (cdr provs))))
 
 (defsubst pcmpl-rpm-files ()
   (pcomplete-dirs-or-entries "\\.rpm\\'"))
diff --git a/lisp/pcmpl-unix.el b/lisp/pcmpl-unix.el
index 90dde26599..1b11afd36b 100644
--- a/lisp/pcmpl-unix.el
+++ b/lisp/pcmpl-unix.el
@@ -111,7 +111,7 @@ documentation), this function returns nil."
 						(point))) ":")))
 	    (setq names (cons (nth 0 fields) names)))
 	  (forward-line))))
-    (pcomplete-uniqify-list names)))
+    (pcomplete-uniquify-list names)))
 
 (defsubst pcmpl-unix-group-names ()
   "Read the contents of /etc/group for group names."
diff --git a/lisp/pcomplete.el b/lisp/pcomplete.el
index 6078dfd744..6bdea68c0b 100644
--- a/lisp/pcomplete.el
+++ b/lisp/pcomplete.el
@@ -272,6 +272,39 @@ to all arguments, such as variable names after a $."
   "Complete amongst a list of directories and executables."
   (pcomplete-entries regexp 'file-executable-p))
 
+(defmacro pcomplete-here (&optional form stub paring form-only)
+  "Complete against the current argument, if at the end.
+If completion is to be done here, evaluate FORM to generate the completion
+table which will be used for completion purposes.  If STUB is a
+string, use it as the completion stub instead of the default (which is
+the entire text of the current argument).
+
+For an example of when you might want to use STUB: if the current
+argument text is `long-path-name/', you don't want the completions
+list display to be cluttered by `long-path-name/' appearing at the
+beginning of every alternative.  Not only does this make things less
+intelligible, but it is also inefficient.  Yet, if the completion list
+does not begin with this string for every entry, the current argument
+won't complete correctly.
+
+The solution is to specify a relative stub.  It allows you to
+substitute a different argument from the current argument, almost
+always for the sake of efficiency.
+
+If PARING is nil, this argument will be pared against previous
+arguments using the function `file-truename' to normalize them.
+PARING may be a function, in which case that function is used for
+normalization.  If PARING is t, the argument dealt with by this
+call will not participate in argument paring.  If it is the
+integer 0, all previous arguments that have been seen will be
+cleared.
+
+If FORM-ONLY is non-nil, only the result of FORM will be used to
+generate the completions list.  This means that the hook
+`pcomplete-try-first-hook' will not be run."
+  (declare (debug t))
+  `(pcomplete--here (lambda () ,form) ,stub ,paring ,form-only))
+
 (defcustom pcomplete-command-completion-function
   (function
    (lambda ()
@@ -950,7 +983,7 @@ Arguments NO-GANGING and ARGS-FOLLOW are currently ignored."
 		(function
 		 (lambda (opt)
 		   (concat "-" opt)))
-		(pcomplete-uniqify-list choices))))
+		(pcomplete-uniquify-list choices))))
     (let ((arg (pcomplete-arg)))
       (when (and (> (length arg) 1)
 		 (stringp arg)
@@ -1014,39 +1047,6 @@ See the documentation for `pcomplete-here'."
              ;; byte-compiled with the older code.
              (eval form)))))
 
-(defmacro pcomplete-here (&optional form stub paring form-only)
-  "Complete against the current argument, if at the end.
-If completion is to be done here, evaluate FORM to generate the completion
-table which will be used for completion purposes.  If STUB is a
-string, use it as the completion stub instead of the default (which is
-the entire text of the current argument).
-
-For an example of when you might want to use STUB: if the current
-argument text is `long-path-name/', you don't want the completions
-list display to be cluttered by `long-path-name/' appearing at the
-beginning of every alternative.  Not only does this make things less
-intelligible, but it is also inefficient.  Yet, if the completion list
-does not begin with this string for every entry, the current argument
-won't complete correctly.
-
-The solution is to specify a relative stub.  It allows you to
-substitute a different argument from the current argument, almost
-always for the sake of efficiency.
-
-If PARING is nil, this argument will be pared against previous
-arguments using the function `file-truename' to normalize them.
-PARING may be a function, in which case that function is used for
-normalization.  If PARING is t, the argument dealt with by this
-call will not participate in argument paring.  If it is the
-integer 0, all previous arguments that have been seen will be
-cleared.
-
-If FORM-ONLY is non-nil, only the result of FORM will be used to
-generate the completions list.  This means that the hook
-`pcomplete-try-first-hook' will not be run."
-  (declare (debug t))
-  `(pcomplete--here (lambda () ,form) ,stub ,paring ,form-only))
-
 
 (defmacro pcomplete-here* (&optional form stub form-only)
   "An alternate form which does not participate in argument paring."
@@ -1269,7 +1269,7 @@ If specific documentation can't be given, be generic."
 
 ;; general utilities
 
-(defun pcomplete-uniqify-list (l)
+(defun pcomplete-uniquify-list (l)
   "Sort and remove multiples in L."
   (setq l (sort l 'string-lessp))
   (let ((m l))
@@ -1280,6 +1280,9 @@ If specific documentation can't be given, be generic."
 	(setcdr m (cddr m)))
       (setq m (cdr m))))
   l)
+(define-obsolete-function-alias
+  'pcomplete-uniqify-list
+  'pcomplete-uniquify-list "27.1")
 
 (defun pcomplete-process-result (cmd &rest args)
   "Call CMD using `call-process' and return the simplest result."
diff --git a/lisp/play/dunnet.el b/lisp/play/dunnet.el
index f22cc240c0..2b8bd9d6b8 100644
--- a/lisp/play/dunnet.el
+++ b/lisp/play/dunnet.el
@@ -2349,7 +2349,6 @@ for a moment, then straighten yourself up.\n")
 ;;;; This section sets up the keymaps for interactive and batch dunnet.
 ;;;;
 
-(define-obsolete-variable-alias 'dungeon-mode-map 'dun-mode-map "22.1")
 (define-key dun-mode-map "\r" 'dun-parse)
 (defvar dungeon-batch-map (make-keymap))
 (if (string= (substring emacs-version 0 2) "18")
diff --git a/lisp/play/gametree.el b/lisp/play/gametree.el
index de8abd7abe..5b05ae13e2 100644
--- a/lisp/play/gametree.el
+++ b/lisp/play/gametree.el
@@ -586,8 +586,7 @@ shogi, etc.) players, it is a slightly modified version of Outline mode.
 
 \\{gametree-mode-map}"
   (auto-fill-mode 0)
-  (make-local-variable 'write-contents-hooks)
-  (add-hook 'write-contents-hooks 'gametree-save-and-hack-layout))
+  (add-hook 'write-contents-functions 'gametree-save-and-hack-layout nil t))
 
 ;;;; Goodies for mousing users
 (defun gametree-mouse-break-line-here (event)
diff --git a/lisp/progmodes/ada-mode.el b/lisp/progmodes/ada-mode.el
index 2d3f6e22a6..76c9be93d0 100644
--- a/lisp/progmodes/ada-mode.el
+++ b/lisp/progmodes/ada-mode.el
@@ -231,7 +231,7 @@ It may be `downcase-word', `upcase-word', `ada-loose-case-word' or
   "Non-nil means remove trailing spaces and untabify the buffer before saving."
   :type 'boolean :group 'ada)
 (make-obsolete-variable 'ada-clean-buffer-before-saving
-			"use the `write-file-functions' hook."
+			"it has no effect - use `write-file-functions' hook."
 			"23.2")
 
 
diff --git a/lisp/progmodes/bat-mode.el b/lisp/progmodes/bat-mode.el
index 2910a7a104..51acc6a949 100644
--- a/lisp/progmodes/bat-mode.el
+++ b/lisp/progmodes/bat-mode.el
@@ -84,6 +84,8 @@
          . 'bat-label-face)
         ("\\_<\\(defined\\|set\\)\\_>[ \t]*\\(\\(\\sw\\|\\s_\\)+\\)"
          (2 font-lock-variable-name-face))
+        ("%~\\([0-9]\\)"
+         (1 font-lock-variable-name-face))
         ("%\\([^%~ \n]+\\)%?"
          (1 font-lock-variable-name-face))
         ("!\\([^!%~ \n]+\\)!?"  ; delayed-expansion !variable!
diff --git a/lisp/progmodes/compile.el b/lisp/progmodes/compile.el
index 422974379b..15503ee0b2 100644
--- a/lisp/progmodes/compile.el
+++ b/lisp/progmodes/compile.el
@@ -99,16 +99,6 @@ The function receives one argument, the name of the major mode of the
 compilation buffer.  It should return a string.
 If nil, compute the name with `(concat \"*\" (downcase major-mode) \"*\")'.")
 
-;;;###autoload
-(defvar compilation-finish-function nil
-  "Function to call when a compilation process finishes.
-It is called with two arguments: the compilation buffer, and a string
-describing how the process finished.")
-
-(make-obsolete-variable 'compilation-finish-function
-  "use `compilation-finish-functions', but it works a little differently."
-  "22.1")
-
 ;;;###autoload
 (defvar compilation-finish-functions nil
   "Functions to call when a compilation process finishes.
@@ -2101,7 +2091,6 @@ by replacing the first word, e.g., `compilation-scroll-output' from
 		   compilation-error-regexp-alist
 		   compilation-error-regexp-alist-alist
 		   compilation-error-screen-columns
-		   compilation-finish-function
 		   compilation-finish-functions
 		   compilation-first-column
 		   compilation-mode-font-lock-keywords
@@ -2245,9 +2234,6 @@ commands of Compilation major mode are available.  See
     (force-mode-line-update)
     (if (and opoint (< opoint omax))
 	(goto-char opoint))
-    (with-no-warnings
-      (if compilation-finish-function
-	  (funcall compilation-finish-function cur-buffer msg)))
     (run-hook-with-args 'compilation-finish-functions cur-buffer msg)))
 
 ;; Called when compilation process changes state.
diff --git a/lisp/progmodes/cperl-mode.el b/lisp/progmodes/cperl-mode.el
index 8c0682ac1c..09a26ddbe0 100644
--- a/lisp/progmodes/cperl-mode.el
+++ b/lisp/progmodes/cperl-mode.el
@@ -390,13 +390,6 @@ Affects: `cperl-font-lock', `cperl-electric-lbrace-space',
   :type '(repeat string)
      :group 'cperl)
 
-;; This became obsolete...
-(defvar cperl-vc-header-alist nil)
-(make-obsolete-variable
- 'cperl-vc-header-alist
- "use cperl-vc-rcs-header or cperl-vc-sccs-header instead."
- "22.1")
-
 ;; (defcustom cperl-clobber-mode-lists
 ;;   (not
 ;;    (and
@@ -1727,9 +1720,8 @@ or as help on variables `cperl-tips', `cperl-problems',
   (when (featurep 'xemacs)
     ;; This one is obsolete...
     (set (make-local-variable 'vc-header-alist)
-         (or cperl-vc-header-alist      ; Avoid warning
-	     `((SCCS ,(car cperl-vc-sccs-header))
-	       (RCS ,(car cperl-vc-rcs-header))))))
+	 `((SCCS ,(car cperl-vc-sccs-header))
+	   (RCS ,(car cperl-vc-rcs-header)))))
   (cond ((boundp 'compilation-error-regexp-alist-alist);; xemacs 20.x
 	 (set (make-local-variable 'compilation-error-regexp-alist-alist)
 	      (cons (cons 'cperl (car cperl-compilation-error-regexp-alist))
diff --git a/lisp/progmodes/ebrowse.el b/lisp/progmodes/ebrowse.el
index ca64af5c91..08b1acd4da 100644
--- a/lisp/progmodes/ebrowse.el
+++ b/lisp/progmodes/ebrowse.el
@@ -1107,7 +1107,7 @@ Tree mode key bindings:
          (and tree (ebrowse-build-tree-obarray tree)))
     (set (make-local-variable 'ebrowse--frozen-flag) nil)
 
-    (add-hook 'local-write-file-hooks 'ebrowse-write-file-hook-fn nil t)
+    (add-hook 'write-file-functions 'ebrowse-write-file-hook-fn nil t)
     (modify-syntax-entry ?_ (char-to-string (char-syntax ?a)))
     (when tree
       (ebrowse-redraw-tree)
@@ -4023,7 +4023,7 @@ If VIEW is non-nil, view else find source files."
 
 (defun ebrowse-write-file-hook-fn ()
   "Write current buffer as a class tree.
-Installed on `local-write-file-hooks'."
+Added to `write-file-functions'."
   (ebrowse-save-tree)
   t)
 
diff --git a/lisp/progmodes/flymake.el b/lisp/progmodes/flymake.el
index a47f13fea3..56f43e4bb3 100644
--- a/lisp/progmodes/flymake.el
+++ b/lisp/progmodes/flymake.el
@@ -48,6 +48,10 @@
 (require 'thingatpt) ; end-of-thing
 (require 'warnings) ; warning-numeric-level, display-warning
 (require 'compile) ; for some faces
+;; We need the next require to avoid compiler warnings and run-time
+;; errors about mouse-wheel-up/down-event in builds --without-x, where
+;; mwheel is not preloaded.
+(require 'mwheel)
 ;; when-let*, if-let*, hash-table-keys, hash-table-values:
 (eval-when-compile (require 'subr-x))
 
diff --git a/lisp/progmodes/gdb-mi.el b/lisp/progmodes/gdb-mi.el
index c664799ab0..88e34d8df9 100644
--- a/lisp/progmodes/gdb-mi.el
+++ b/lisp/progmodes/gdb-mi.el
@@ -792,7 +792,7 @@ detailed description of this mode.
   (gud-def gud-tbreak "tbreak %f:%l" "\C-t"
 	   "Set temporary breakpoint at current line.")
   (gud-def gud-jump
-	   (progn (gud-call "tbreak %f:%l") (gud-call "jump %f:%l"))
+	   (progn (gud-call "tbreak %f:%l" arg) (gud-call "jump %f:%l"))
 	   "\C-j" "Set execution address to current line.")
 
   (gud-def gud-up     "up %p"     "<" "Up N stack frames (numeric arg).")
diff --git a/lisp/progmodes/glasses.el b/lisp/progmodes/glasses.el
index de176019a5..c3e8ac35f3 100644
--- a/lisp/progmodes/glasses.el
+++ b/lisp/progmodes/glasses.el
@@ -326,10 +326,10 @@ add virtual separators (like underscores) at places they belong to."
       (if glasses-mode
 	  (progn
 	    (jit-lock-register 'glasses-change)
-	    (add-hook 'local-write-file-hooks
+	    (add-hook 'write-file-functions
 		      'glasses-convert-to-unreadable nil t))
 	(jit-lock-unregister 'glasses-change)
-	(remove-hook 'local-write-file-hooks
+	(remove-hook 'write-file-functions
 		     'glasses-convert-to-unreadable t)))))
 
 
diff --git a/lisp/progmodes/grep.el b/lisp/progmodes/grep.el
index 9b2c6f112c..8c0e46f35a 100644
--- a/lisp/progmodes/grep.el
+++ b/lisp/progmodes/grep.el
@@ -286,6 +286,11 @@ See `compilation-error-screen-columns'"
     (define-key map [menu-bar grep]
       (cons "Grep" (make-sparse-keymap "Grep")))
 
+    (define-key map [menu-bar grep grep-find-toggle-abbreviation]
+      '(menu-item "Toggle command abbreviation"
+                  grep-find-toggle-abbreviation
+                  :help "Toggle showing verbose command options"))
+    (define-key map [menu-bar grep compilation-separator3] '("----"))
     (define-key map [menu-bar grep compilation-kill-compilation]
       '(menu-item "Kill Grep" kill-compilation
 		  :help "Kill the currently running grep process"))
@@ -308,7 +313,7 @@ See `compilation-error-screen-columns'"
     (define-key map [menu-bar grep compilation-recompile]
       '(menu-item "Repeat grep" recompile
 		  :help "Run grep again"))
-    (define-key map [menu-bar grep compilation-separator2] '("----"))
+    (define-key map [menu-bar grep compilation-separator1] '("----"))
     (define-key map [menu-bar grep compilation-first-error]
       '(menu-item "First Match" first-error
 		  :help "Restart at the first match, visit corresponding location"))
@@ -433,24 +438,26 @@ See `compilation-error-regexp-alist' for format details.")
                       help-echo "Number of matches so far")
     "]"))
 
-(defcustom grep-find-hide t
+(defcustom grep-find-abbreviate t
   "If non-nil, hide part of rgrep/lgrep/zrgrep command line.
 The hidden part contains a list of ignored directories and files.
 Clicking on the button-like ellipsis unhides the abbreviated part
-and reveals the entire command line."
+and reveals the entire command line.  The visibility of the
+abbreviated part can also be toggled with
+`grep-find-toggle-abbreviation'."
   :type 'boolean
   :version "27.1"
   :group 'grep)
 
-(defvar grep-find-hide-properties
+(defvar grep-find-abbreviate-properties
   (let ((ellipsis (if (char-displayable-p ?…) "[…]" "[...]"))
         (map (make-sparse-keymap)))
     (define-key map [down-mouse-2] 'mouse-set-point)
-    (define-key map [mouse-2] 'grep-find-show)
-    (define-key map "\C-m" 'grep-find-show)
+    (define-key map [mouse-2] 'grep-find-toggle-abbreviation)
+    (define-key map "\C-m" 'grep-find-toggle-abbreviation)
     `(face nil display ,ellipsis mouse-face highlight
       help-echo "RET, mouse-2: show unabbreviated command"
-      keymap ,map))
+      keymap ,map abbreviated-command t))
   "Properties of button-like ellipsis on part of rgrep command line.")
 
 (defvar grep-mode-font-lock-keywords
@@ -476,10 +483,12 @@ and reveals the entire command line."
              `(face nil display ,(match-string 2)))))
      ;; Hide excessive part of rgrep command
      ("^find \\(\\. -type d .*\\\\)\\)"
-      (1 (when grep-find-hide grep-find-hide-properties)))
+      (1 (if grep-find-abbreviate grep-find-abbreviate-properties
+           '(face nil abbreviated-command t))))
      ;; Hide excessive part of lgrep command
      ("^grep \\( *--exclude.*--exclude[^ ]+\\)"
-      (1 (when grep-find-hide grep-find-hide-properties))))
+      (1 (if grep-find-abbreviate grep-find-abbreviate-properties
+           '(face nil abbreviated-command t)))))
    "Additional things to highlight in grep output.
 This gets tacked on the end of the generated expressions.")
 
@@ -1195,23 +1204,19 @@ to specify a command to run."
                  (shell-quote-argument ")")
                  " -prune -o ")))))
 
-(defun grep-find-show ()
-  "Show the hidden part of rgrep/lgrep/zrgrep command line."
+(defun grep-find-toggle-abbreviation ()
+  "Toggle showing the hidden part of rgrep/lgrep/zrgrep command line."
   (interactive)
-  (when (get-text-property (point) 'display)
-    (let ((beg (or (previous-single-property-change
-                    (min (point-max) (1+ (point))) 'display)
-                   (point)))
-          (end (or (next-single-property-change
-                    (point) 'display)
-                   (point)))
-          (inhibit-modification-hooks t)
-          (inhibit-read-only t)
-	  (buffer-undo-list t)
-	  (modified (buffer-modified-p)))
-      (remove-list-of-text-properties
-       beg end '(display help-echo mouse-face help-echo keymap))
-      (set-buffer-modified-p modified))))
+  (with-silent-modifications
+    (let* ((beg (next-single-property-change (point-min) 'abbreviated-command))
+           (end (when beg
+                  (next-single-property-change beg 'abbreviated-command))))
+      (if end
+          (if (get-text-property beg 'display)
+              (remove-list-of-text-properties
+               beg end '(display help-echo mouse-face help-echo keymap))
+            (add-text-properties beg end grep-find-abbreviate-properties))
+        (user-error "No abbreviated part to hide/show")))))
 
 ;;;###autoload
 (defun zrgrep (regexp &optional files dir confirm template)
@@ -1230,6 +1235,8 @@ file name to `*.gz', and sets `grep-highlight-matches' to `always'."
 	   (grep-find-template nil)
 	   (grep-find-command nil)
 	   (grep-host-defaults-alist nil)
+           ;; `zgrep' doesn't support the `--null' option.
+	   (grep-use-null-filename-separator nil)
 	   ;; Use for `grep-read-files'
 	   (grep-files-aliases '(("all" . "* .*")
 				 ("gz"  . "*.gz"))))
diff --git a/lisp/progmodes/gud.el b/lisp/progmodes/gud.el
index 72f5769558..2664d03e72 100644
--- a/lisp/progmodes/gud.el
+++ b/lisp/progmodes/gud.el
@@ -378,6 +378,7 @@ we're in the GUD buffer)."
        (if (not gud-running)
 	 ,(if (stringp cmd)
 	      `(gud-call ,cmd arg)
+	    ;; Unused lexical warning if cmd does not use "arg".
 	    cmd))))
      ,(if key `(local-set-key ,(concat "\C-c" key) ',func))
      ,(if key `(global-set-key (vconcat gud-key-prefix ,key) ',func))))
@@ -771,7 +772,7 @@ the buffer in which this command was invoked."
   (gud-def gud-cont   "cont"     "\C-r" "Continue with display.")
   (gud-def gud-finish "finish"   "\C-f" "Finish executing current function.")
   (gud-def gud-jump
-	   (progn (gud-call "tbreak %f:%l") (gud-call "jump %f:%l"))
+	   (progn (gud-call "tbreak %f:%l" arg) (gud-call "jump %f:%l"))
 	   "\C-j" "Set execution address to current line.")
 
   (gud-def gud-up     "up %p"     "<" "Up N stack frames (numeric arg).")
@@ -3396,9 +3397,6 @@ it if ARG is omitted or nil."
 	(kill-local-variable 'gdb-define-alist)
 	(remove-hook 'after-save-hook 'gdb-create-define-alist t))))
 
-(define-obsolete-variable-alias 'tooltip-gud-modes
-                                'gud-tooltip-modes "22.1")
-
 (defcustom gud-tooltip-modes '(gud-mode c-mode c++-mode fortran-mode
 					python-mode)
   "List of modes for which to enable GUD tooltips."
@@ -3406,9 +3404,6 @@ it if ARG is omitted or nil."
   :group 'gud
   :group 'tooltip)
 
-(define-obsolete-variable-alias 'tooltip-gud-display
-                                'gud-tooltip-display "22.1")
-
 (defcustom gud-tooltip-display
   '((eq (tooltip-event-buffer gud-tooltip-event)
 	(marker-buffer gud-overlay-arrow-position)))
@@ -3500,8 +3495,6 @@ With arg, dereference expr if ARG is positive, otherwise do not dereference."
   (message "Dereferencing is now %s."
 	   (if gud-tooltip-dereference "on" "off")))
 
-(define-obsolete-function-alias 'tooltip-gud-toggle-dereference
-                                'gud-tooltip-dereference "22.1")
 (defvar tooltip-use-echo-area)
 (declare-function tooltip-show "tooltip" (text &optional use-echo-area))
 (declare-function tooltip-strip-prompt "tooltip" (process output))
diff --git a/lisp/progmodes/idlw-help.el b/lisp/progmodes/idlw-help.el
index cbdca015e9..54e740be11 100644
--- a/lisp/progmodes/idlw-help.el
+++ b/lisp/progmodes/idlw-help.el
@@ -1181,9 +1181,10 @@ Useful when source code is displayed as help.  See the option
 	(with-syntax-table idlwave-mode-syntax-table
           (set (make-local-variable 'font-lock-defaults)
                idlwave-font-lock-defaults)
-          (if (fboundp 'font-lock-ensure)
+          (if (fboundp 'font-lock-ensure) ; Emacs >= 25.1
               (font-lock-ensure)
-            (font-lock-fontify-buffer))))))
+            ;; Silence "interactive use only" warning on Emacs >= 25.1.
+            (with-no-warnings (font-lock-fontify-buffer)))))))
 
 
 (defun idlwave-help-error (name type class keyword)
diff --git a/lisp/progmodes/meta-mode.el b/lisp/progmodes/meta-mode.el
index 7d20e02d80..e207d22ff4 100644
--- a/lisp/progmodes/meta-mode.el
+++ b/lisp/progmodes/meta-mode.el
@@ -47,8 +47,8 @@
 ;; `metafont-mode-hook' and `metapost-mode-hook' which apply to the
 ;; individual modes.  In addition, there are several variables and
 ;; regexps controlling e.g. the behavior of the indentation function,
-;; which may be customized via `edit-options'.  Please refer to the
-;; docstrings in the code below for details.
+;; which may be customized.  Please refer to the docstrings in the code
+;; below for details.
 
 ;; Availability:
 ;;
diff --git a/lisp/progmodes/octave.el b/lisp/progmodes/octave.el
index c768d8d6f4..f5d764e16c 100644
--- a/lisp/progmodes/octave.el
+++ b/lisp/progmodes/octave.el
@@ -1165,6 +1165,8 @@ q: Don't fix\n" func file))
   "Face used to highlight function comment block.")
 
 (eval-when-compile (require 'texinfo))
+;; Undo the effects of texinfo loading tex-mode loading compile.
+(declare-function compilation-forget-errors "compile" ())
 
 (defun octave-font-lock-texinfo-comment ()
   (let ((kws
diff --git a/lisp/progmodes/pascal.el b/lisp/progmodes/pascal.el
index 83f15d495b..58dc213d8a 100644
--- a/lisp/progmodes/pascal.el
+++ b/lisp/progmodes/pascal.el
@@ -1403,7 +1403,6 @@ The default is a name found in the buffer around point."
     map)
   "Keymap used in Pascal Outline mode.")
 
-(define-obsolete-function-alias 'pascal-outline 'pascal-outline-mode "22.1")
 (define-minor-mode pascal-outline-mode
   "Outline-line minor mode for Pascal mode.
 With a prefix argument ARG, enable the mode if ARG is positive,
@@ -1425,7 +1424,7 @@ Pascal Outline mode provides some additional commands.
 \\[pascal-show-all]\t- Show the whole buffer.
 \\[pascal-hide-other-defuns]\
 \t- Hide everything but the current function (function under the cursor).
-\\[pascal-outline]\t- Leave Pascal Outline mode."
+\\[pascal-outline-mode]\t- Leave Pascal Outline mode."
   :init-value nil :lighter " Outl" :keymap pascal-outline-map
   (add-to-invisibility-spec '(pascal . t))
   (unless pascal-outline-mode
diff --git a/lisp/progmodes/perl-mode.el b/lisp/progmodes/perl-mode.el
index 99480788f5..e667a97015 100644
--- a/lisp/progmodes/perl-mode.el
+++ b/lisp/progmodes/perl-mode.el
@@ -165,7 +165,7 @@
     ;; Fontify function and package names in declarations.
     ("\\<\\(package\\|sub\\)\\>[ \t]*\\(\\sw+\\)?"
      (1 font-lock-keyword-face) (2 font-lock-function-name-face nil t))
-    ("\\<\\(import\\|no\\|require\\|use\\)\\>[ \t]*\\(\\sw+\\)?"
+    ("\\(^\\|[^$@%&\\]\\)\\<\\(import\\|no\\|require\\|use\\)\\>[ \t]*\\(\\sw+\\)?"
      (1 font-lock-keyword-face) (2 font-lock-constant-face nil t)))
   "Subdued level highlighting for Perl mode.")
 
@@ -745,8 +745,6 @@ Turning on Perl mode runs the normal hook `perl-mode-hook'."
       0					;Existing comment at bol stays there.
     comment-column))
 
-(define-obsolete-function-alias 'electric-perl-terminator
-  'perl-electric-terminator "22.1")
 (defun perl-electric-noindent-p (_char)
   ;; To reproduce the old behavior, ;, {, }, and : are made electric, but
   ;; we only want them to be electric at EOL.
diff --git a/lisp/progmodes/python.el b/lisp/progmodes/python.el
index 142e6eb3f3..afafd1b42c 100644
--- a/lisp/progmodes/python.el
+++ b/lisp/progmodes/python.el
@@ -647,15 +647,15 @@ The type returned can be `comment', `string' or `paren'."
    ((python-rx string-delimiter)
     (0 (ignore (python-syntax-stringify))))))
 
+(define-obsolete-variable-alias 'python--prettify-symbols-alist
+  'python-prettify-symbols-alist "26.1")
+
 (defvar python-prettify-symbols-alist
   '(("lambda"  . ?λ)
     ("and" . ?∧)
     ("or" . ?∨))
   "Value for `prettify-symbols-alist' in `python-mode'.")
 
-(define-obsolete-variable-alias 'python--prettify-symbols-alist
-  'python-prettify-symbols-alist "26.1")
-
 (defsubst python-syntax-count-quotes (quote-char &optional point limit)
   "Count number of quotes around point (max is 3).
 QUOTE-CHAR is the quote char to count.  Optional argument POINT is
@@ -1520,7 +1520,7 @@ of the statement."
                        ;; narrowing.
                        (cl-assert (> string-start last-string-end)
                                   :show-args
-                                  "
+                                  "\
 Overlapping strings detected (start=%d, last-end=%d)")
                        (goto-char string-start)
                        (if (python-syntax-context 'paren)
@@ -3196,10 +3196,10 @@ t when called interactively."
                      (insert-file-contents
                       (or temp-file-name file-name))
                      (python-info-encoding)))
-         (file-name (expand-file-name (file-local-name file-name)))
+         (file-name (file-local-name (expand-file-name file-name)))
          (temp-file-name (when temp-file-name
-                           (expand-file-name
-                            (file-local-name temp-file-name)))))
+                           (file-local-name (expand-file-name
+                                             temp-file-name)))))
     (python-shell-send-string
      (format
       (concat
@@ -5299,6 +5299,7 @@ REPORT-FN is Flymake's callback function."
     (save-excursion (insert (make-string 2 last-command-event)))))
 
 (defvar electric-indent-inhibit)
+(defvar prettify-symbols-alist)
 
 ;;;###autoload
 (define-derived-mode python-mode prog-mode "Python"
@@ -5393,10 +5394,8 @@ REPORT-FN is Flymake's callback function."
            "`outline-level' function for Python mode."
            (1+ (/ (current-indentation) python-indent-offset))))
 
-  (when (and (boundp 'prettify-symbols-alist)
-             (boundp 'python--prettify-symbols-alist))
-    (set (make-local-variable 'prettify-symbols-alist)
-         python--prettify-symbols-alist))
+  (set (make-local-variable 'prettify-symbols-alist)
+       python-prettify-symbols-alist)
 
   (python-skeleton-add-menu-items)
 
diff --git a/lisp/progmodes/sql.el b/lisp/progmodes/sql.el
index d20c579f66..9bb2cf4bdf 100644
--- a/lisp/progmodes/sql.el
+++ b/lisp/progmodes/sql.el
@@ -4406,7 +4406,8 @@ The default comes from `process-coding-system-alist' and
                            (or coding 'utf-8))
                     (when (string-match (format "\\.%s\\'" (car cs)) nlslang)
                       (setq coding (cdr cs)))))
-    (set-buffer-process-coding-system coding coding)))
+    (set-process-coding-system (get-buffer-process (current-buffer))
+                               coding coding)))
 
 (defun sql-oracle-save-settings (sqlbuf)
   "Save most SQL*Plus settings so they may be reset by \\[sql-redirect]."
diff --git a/lisp/progmodes/verilog-mode.el b/lisp/progmodes/verilog-mode.el
index 48dee4bef3..6657761902 100644
--- a/lisp/progmodes/verilog-mode.el
+++ b/lisp/progmodes/verilog-mode.el
@@ -3966,7 +3966,9 @@ Key bindings specific to `verilog-mode-map' are:
             #'verilog-completion-at-point nil 'local)
 
   ;; Stuff for autos
-  (add-hook 'write-contents-hooks 'verilog-auto-save-check nil 'local)
+  (add-hook (if (boundp 'write-contents-hooks) 'write-contents-hooks
+	      'write-contents-functions) ; Emacs >= 22.1
+	    'verilog-auto-save-check nil 'local)
   ;; verilog-mode-hook call added by define-derived-mode
   )
 
diff --git a/lisp/progmodes/vhdl-mode.el b/lisp/progmodes/vhdl-mode.el
index a841f87f3c..f6cb2419de 100644
--- a/lisp/progmodes/vhdl-mode.el
+++ b/lisp/progmodes/vhdl-mode.el
@@ -4953,8 +4953,8 @@ Key bindings:
 (defun vhdl-write-file-hooks-init ()
   "Add/remove hooks when buffer is saved."
   (if vhdl-modify-date-on-saving
-      (add-hook 'local-write-file-hooks 'vhdl-template-modify-noerror nil t)
-    (remove-hook 'local-write-file-hooks 'vhdl-template-modify-noerror t))
+      (add-hook 'write-file-functions 'vhdl-template-modify-noerror nil t)
+    (remove-hook 'write-file-functions 'vhdl-template-modify-noerror t))
   (if (featurep 'xemacs) (make-local-hook 'after-save-hook))
   (add-hook 'after-save-hook 'vhdl-add-modified-file nil t))
 
diff --git a/lisp/progmodes/xref.el b/lisp/progmodes/xref.el
index e0f5b2d367..5a9a7a925a 100644
--- a/lisp/progmodes/xref.el
+++ b/lisp/progmodes/xref.el
@@ -501,8 +501,9 @@ SELECT is `quit', also quit the *xref* window."
              (xref-buffer (current-buffer)))
         (cond (select
                (if (eq select 'quit) (quit-window nil nil))
-               (with-current-buffer xref-buffer
-                 (select-window (xref--show-pos-in-buf marker buf))))
+               (select-window
+                (with-current-buffer xref-buffer
+                  (xref--show-pos-in-buf marker buf))))
               (t
                (save-selected-window
                  (xref--with-dedicated-window
@@ -692,6 +693,10 @@ references displayed in the current *xref* buffer."
     (dotimes (_ n)
       (setq xref (xref--search-property 'xref-item backward)))
     (cond (xref
+           ;; Save the current position (when the buffer is visible,
+           ;; it gets reset to that window's point from time to time).
+           (let ((win (get-buffer-window (current-buffer))))
+             (and win (set-window-point win (point))))
            (xref--show-location (xref-item-location xref) t))
           (t
            (error "No %s xref" (if backward "previous" "next"))))))
diff --git a/lisp/recentf.el b/lisp/recentf.el
index b33f22d959..c3c4e45922 100644
--- a/lisp/recentf.el
+++ b/lisp/recentf.el
@@ -228,10 +228,6 @@ This item will replace the \"More...\" item."
   :group 'recentf
   :type 'boolean)
 
-(define-obsolete-variable-alias 'recentf-menu-append-commands-p
-                                'recentf-menu-append-commands-flag
-                                "22.1")
-
 (defcustom recentf-menu-append-commands-flag t
   "Non-nil means to append command items to the menu."
   :group 'recentf
diff --git a/lisp/savehist.el b/lisp/savehist.el
index fbb5f53390..0a261b0b0c 100644
--- a/lisp/savehist.el
+++ b/lisp/savehist.el
@@ -204,29 +204,6 @@ histories, which is probably undesirable."
 	 (signal (car errvar) (cdr errvar)))))
     (savehist-install)))
 
-(defun savehist-load ()
-  "Load the variables stored in `savehist-file' and turn on Savehist mode.
-If `savehist-file' is in the old format that doesn't record
-the value of `savehist-minibuffer-history-variables', that
-value is deducted from the contents of the file."
-  (declare (obsolete savehist-mode "22.1"))
-  (savehist-mode 1)
-  ;; Old versions of savehist distributed with XEmacs didn't save
-  ;; savehist-minibuffer-history-variables.  If that variable is nil
-  ;; after loading the file, try to intuit the intended value.
-  (when (null savehist-minibuffer-history-variables)
-    (setq savehist-minibuffer-history-variables
-          (with-temp-buffer
-	    (ignore-errors
-	      (insert-file-contents savehist-file))
-            (let ((vars ()) form)
-              (while (setq form (condition-case nil
-				    (read (current-buffer)) (error nil)))
-		;; Each form read is of the form (setq VAR VALUE).
-		;; Collect VAR, i.e. (nth form 1).
-                (push (nth 1 form) vars))
-              vars)))))
-
 (defun savehist-install ()
   "Hook Savehist into Emacs.
 Normally invoked by calling `savehist-mode' to set the minor mode.
diff --git a/lisp/server.el b/lisp/server.el
index a892203c24..ff03cbe622 100644
--- a/lisp/server.el
+++ b/lisp/server.el
@@ -188,6 +188,13 @@ space (this means characters from ! to ~; or from code 33 to
   :group 'server
   :type 'hook)
 
+(defcustom server-after-make-frame-hook nil
+  "Hook run when the Emacs server creates a client frame.
+The created frame is selected when the hook is called."
+  :group 'server
+  :type 'hook
+  :version "27.1")
+
 (defcustom server-done-hook nil
   "Hook run when done editing a buffer for the Emacs server."
   :group 'server
@@ -1336,9 +1343,11 @@ The following commands are accepted by the client:
            ((or isearch-mode (minibufferp))
             nil)
            ((and frame (null buffers))
+            (run-hooks 'server-after-make-frame-hook)
             (message "%s" (substitute-command-keys
                            "When done with this frame, type \\[delete-frame]")))
            ((not (null buffers))
+            (run-hooks 'server-after-make-frame-hook)
             (server-switch-buffer (car buffers) nil (cdr (car files)))
             (run-hooks 'server-switch-hook)
             (unless nowait
diff --git a/lisp/ses.el b/lisp/ses.el
index 9097bf5d81..bcf8bdb636 100644
--- a/lisp/ses.el
+++ b/lisp/ses.el
@@ -2495,7 +2495,7 @@ to are recalculated first."
          prefix-length)
     (when (and prefix (null (string= prefix "")))
       (setq prefix-length (length prefix))
-      (maphash (lambda (key val)
+      (maphash (lambda (key _val)
                  (let ((key-name (symbol-name key)))
                    (when (and (>= (length key-name) prefix-length)
                               (string= prefix (substring key-name 0 prefix-length)))
@@ -2648,7 +2648,7 @@ cells."
          prefix-length)
     (when prefix
       (setq prefix-length (length prefix))
-      (maphash (lambda (key val)
+      (maphash (lambda (key _val)
                  (let ((key-name (symbol-name key)))
                    (when (and (>= (length key-name) prefix-length)
                               (string= prefix (substring key-name 0 prefix-length)))
diff --git a/lisp/simple.el b/lisp/simple.el
index edcb73ce2e..65108250ea 100644
--- a/lisp/simple.el
+++ b/lisp/simple.el
@@ -123,6 +123,12 @@ similar mode is started, or when it is used with \\[next-error]
 or \\[compile-goto-error].")
 (make-variable-buffer-local 'next-error-last-buffer)
 
+;; next-error-last-buffer is made buffer-local to keep the reference
+;; to the parent buffer used to navigate to the current buffer, so the
+;; next call of next-buffer will use the same parent buffer to
+;; continue navigation from it.
+(make-variable-buffer-local 'next-error-last-buffer)
+
 (defvar next-error-function nil
   "Function to use to find the next error in the current buffer.
 The function is called with 2 parameters:
@@ -1125,6 +1131,7 @@ the actual saved text might be different from what was killed."
 
 (defun mark-whole-buffer ()
   "Put point at beginning and mark at end of buffer.
+Also push mark at point before pushing mark at end of buffer.
 If narrowing is in effect, only uses the accessible part of the buffer.
 You probably should not use this function in Lisp programs;
 it is usually a mistake for a Lisp function to use any subroutine
diff --git a/lisp/speedbar.el b/lisp/speedbar.el
index 7915a52df3..a231163715 100644
--- a/lisp/speedbar.el
+++ b/lisp/speedbar.el
@@ -637,9 +637,6 @@ Created from `speedbar-ignored-directory-expressions' with the function
 Use the function `speedbar-add-ignored-directory-regexp', or customize the
 variable `speedbar-ignored-directory-expressions' to modify this variable.")
 
-(define-obsolete-variable-alias 'speedbar-ignored-path-expressions
-  'speedbar-ignored-directory-expressions "22.1")
-
 (defcustom speedbar-ignored-directory-expressions
   '("[/\\]logs?[/\\]\\'")
   "List of regular expressions matching directories speedbar will ignore.
@@ -4077,26 +4074,6 @@ TEXT is the buffer's name, TOKEN and INDENT are unused."
 	 (setq font-lock-global-modes (delq 'speedbar-mode
 					    font-lock-global-modes)))))
 
-;;; Obsolete variables and functions
-
-(define-obsolete-variable-alias
-  'speedbar-ignored-path-regexp 'speedbar-ignored-directory-regexp "22.1")
-
-(define-obsolete-function-alias 'speedbar-add-ignored-path-regexp
-  'speedbar-add-ignored-directory-regexp "22.1")
-
-(define-obsolete-function-alias 'speedbar-line-path
-  'speedbar-line-directory "22.1")
-
-(define-obsolete-function-alias 'speedbar-buffers-line-path
-  'speedbar-buffers-line-directory "22.1")
-
-(define-obsolete-function-alias 'speedbar-path-line
-  'speedbar-directory-line "22.1")
-
-(define-obsolete-function-alias 'speedbar-buffers-line-path
-  'speedbar-buffers-line-directory "22.1")
-
 (provide 'speedbar)
 
 ;; run load-time hooks
diff --git a/lisp/subr.el b/lisp/subr.el
index 056392a926..113bd978b6 100644
--- a/lisp/subr.el
+++ b/lisp/subr.el
@@ -680,20 +680,6 @@ If TEST is omitted or nil, `equal' is used."
       (setq tail (cdr tail)))
     value))
 
-(defun assoc-ignore-case (key alist)
-  "Like `assoc', but ignores differences in case and text representation.
-KEY must be a string.  Upper-case and lower-case letters are treated as equal.
-Unibyte strings are converted to multibyte for comparison."
-  (declare (obsolete assoc-string "22.1"))
-  (assoc-string key alist t))
-
-(defun assoc-ignore-representation (key alist)
-  "Like `assoc', but ignores differences in text representation.
-KEY must be a string.
-Unibyte strings are converted to multibyte for comparison."
-  (declare (obsolete assoc-string "22.1"))
-  (assoc-string key alist nil))
-
 (defun member-ignore-case (elt list)
   "Like `member', but ignore differences in case and text representation.
 ELT must be a string.  Upper-case and lower-case letters are treated as equal.
@@ -1463,12 +1449,6 @@ be a list of the form returned by `event-start' and `event-end'."
   (declare (obsolete log "24.4"))
   (log x 10))
 
-;; These are used by VM and some old programs
-(defalias 'focus-frame 'ignore "")
-(make-obsolete 'focus-frame "it does nothing." "22.1")
-(defalias 'unfocus-frame 'ignore "")
-(make-obsolete 'unfocus-frame "it does nothing." "22.1")
-
 (set-advertised-calling-convention
  'all-completions '(string collection &optional predicate) "23.1")
 (set-advertised-calling-convention 'unintern '(name obarray) "23.3")
@@ -1491,11 +1471,6 @@ be a list of the form returned by `event-start' and `event-end'."
 (make-obsolete-variable 'command-debug-status
                         "expect it to be removed in a future version." "25.2")
 
-(define-obsolete-variable-alias 'x-lost-selection-hooks
-  'x-lost-selection-functions "22.1")
-(define-obsolete-variable-alias 'x-sent-selection-hooks
-  'x-sent-selection-functions "22.1")
-
 ;; This was introduced in 21.4 for pre-unicode unification.  That
 ;; usage was rendered obsolete in 23.1 which uses Unicode internally.
 ;; Other uses are possible, so this variable is not _really_ obsolete,
@@ -2173,19 +2148,6 @@ process."
        (memq (process-status process)
 	     '(run open listen connect stop))))
 
-;; compatibility
-
-(defun process-kill-without-query (process &optional _flag)
-  "Say no query needed if PROCESS is running when Emacs is exited.
-Optional second argument if non-nil says to require a query.
-Value is t if a query was formerly required."
-  (declare (obsolete
-            "use `process-query-on-exit-flag' or `set-process-query-on-exit-flag'."
-            "22.1"))
-  (let ((old (process-query-on-exit-flag process)))
-    (set-process-query-on-exit-flag process nil)
-    old))
-
 (defun process-kill-buffer-query-function ()
   "Ask before killing a buffer that has a running process."
   (let ((process (get-buffer-process (current-buffer))))
diff --git a/lisp/term.el b/lisp/term.el
index a0313d88da..91eab771cf 100644
--- a/lisp/term.el
+++ b/lisp/term.el
@@ -487,7 +487,7 @@ inconsistent with the state of the terminal understood by the
 inferior process.  Only the process filter is allowed to make
 changes to the buffer.
 
-Customize this option to nil if you want the previous behaviour."
+Customize this option to nil if you want the previous behavior."
   :version "26.1"
   :type 'boolean
   :group 'term)
@@ -508,7 +508,7 @@ commands can be invoked on the mouse-selected point or region,
 until the process filter (or user) moves point to the process
 mark once again.
 
-Customize this option to nil if you want the previous behaviour."
+Customize this option to nil if you want the previous behavior."
   :version "26.1"
   :type 'boolean
   :group 'term)
@@ -598,8 +598,8 @@ This is run before the process is cranked up."
   "Called each time a process is exec'd by `term-exec'.
 This is called after the process is cranked up.  It is useful for things that
 must be done each time a process is executed in a term mode buffer (e.g.,
-`process-kill-without-query').  In contrast, `term-mode-hook' is only
-executed once when the buffer is created."
+`set-process-query-on-exit-flag').  In contrast, `term-mode-hook' is only
+executed once, when the buffer is created."
   :type 'hook
   :group 'term)
 
@@ -2891,9 +2891,11 @@ See `term-prompt-regexp'."
                 ;; If the last char was written in last column,
                 ;; back up one column, but remember we did so.
                 ;; Thus we emulate xterm/vt100-style line-wrapping.
-                (cond ((eq (term-current-column) term-width)
-                       (term-move-columns -1)
-                       (setq term-do-line-wrapping t)))
+                (when (eq (term-current-column) term-width)
+                  (term-move-columns -1)
+                  ;; We check after ctrl sequence handling if point
+                  ;; was moved (and leave line-wrapping state if so).
+                  (setq term-do-line-wrapping (point)))
                 (setq term-current-column nil)
                 (setq i funny))
               (pcase-exhaustive (and (<= ctl-end str-length) (aref str i))
@@ -2993,6 +2995,9 @@ See `term-prompt-regexp'."
                      (substring str i ctl-end)))))
                 ;; Ignore NUL, Shift Out, Shift In.
                 ((or ?\0 #xE #xF 'nil) nil))
+              ;; Leave line-wrapping state if point was moved.
+              (unless (eq term-do-line-wrapping (point))
+                (setq term-do-line-wrapping nil))
               (if (term-handling-pager)
                   (progn
                     ;; Finish stuff to get ready to handle PAGER.
diff --git a/lisp/term/pc-win.el b/lisp/term/pc-win.el
index 9c1b471d48..e0e412e162 100644
--- a/lisp/term/pc-win.el
+++ b/lisp/term/pc-win.el
@@ -272,7 +272,7 @@ Consult the selection.  Treat empty strings as if they were unset."
 (fset 'iconify-or-deiconify-frame 'ignore)
 
 ;; From lisp/frame.el
-(fset 'set-default-font 'ignore)
+(fset 'set-frame-font 'ignore)
 (fset 'set-mouse-color 'ignore)		; We cannot, I think.
 (fset 'set-cursor-color 'ignore)	; Hardware determined by char under.
 (fset 'set-border-color 'ignore)	; Not useful.
diff --git a/lisp/textmodes/flyspell.el b/lisp/textmodes/flyspell.el
index d87cb5e72e..e462669626 100644
--- a/lisp/textmodes/flyspell.el
+++ b/lisp/textmodes/flyspell.el
@@ -1944,6 +1944,10 @@ spell-check."
       (call-interactively flyspell--prev-meta-tab-binding)
     (let ((pos     (point))
           (old-max (point-max)))
+      ;; Flush a possibly stale cache from previous invocations of
+      ;; flyspell-auto-correct-word.
+      (if (not (eq last-command 'flyspell-auto-correct-word))
+          (setq flyspell-auto-correct-region nil))
       ;; Use the correct dictionary.
       (flyspell-accept-buffer-local-defs)
       (if (and (eq flyspell-auto-correct-pos pos)
diff --git a/lisp/textmodes/nroff-mode.el b/lisp/textmodes/nroff-mode.el
index 9c846292f1..6955ed25e1 100644
--- a/lisp/textmodes/nroff-mode.el
+++ b/lisp/textmodes/nroff-mode.el
@@ -328,13 +328,6 @@ otherwise off."
 	(kill-buffer viewbuf))
     (Man-getpage-in-background file)))
 
-;; Old names that were not namespace clean.
-(define-obsolete-function-alias 'count-text-lines 'nroff-count-text-lines "22.1")
-(define-obsolete-function-alias 'forward-text-line 'nroff-forward-text-line "22.1")
-(define-obsolete-function-alias 'backward-text-line 'nroff-backward-text-line "22.1")
-(define-obsolete-function-alias 'electric-nroff-newline 'nroff-electric-newline "22.1")
-(define-obsolete-function-alias 'electric-nroff-mode 'nroff-electric-mode "22.1")
-
 (provide 'nroff-mode)
 
 ;;; nroff-mode.el ends here
diff --git a/lisp/textmodes/reftex-toc.el b/lisp/textmodes/reftex-toc.el
index 6637da4b14..9c158a5f56 100644
--- a/lisp/textmodes/reftex-toc.el
+++ b/lisp/textmodes/reftex-toc.el
@@ -1096,7 +1096,7 @@ always show the current section in connection with the option
       (when (eq reftex-auto-recenter-toc 'frame)
         (unless reftex-toc-auto-recenter-timer
           (reftex-toggle-auto-toc-recenter))
-        (add-hook 'delete-frame-hook 'reftex-toc-delete-frame-hook)))))
+        (add-hook 'delete-frame-functions 'reftex-toc-delete-frame-hook)))))
 
 (defun reftex-toc-delete-frame-hook (frame)
   (if (and reftex-toc-auto-recenter-timer
diff --git a/lisp/url/url-auth.el b/lisp/url/url-auth.el
index 4f7b544674..67e701ecb1 100644
--- a/lisp/url/url-auth.el
+++ b/lisp/url/url-auth.el
@@ -194,7 +194,7 @@ key cache `url-digest-auth-storage'."
   (base64-encode-string
    (apply 'format "%016x%04x%04x%05x%05x" (random) (current-time)) t))
 
-(defun url-digest-auth-nonce-count (nonce)
+(defun url-digest-auth-nonce-count (_nonce)
   "The number requests sent to server with the given NONCE.
 This count includes the request we're preparing here.
 
diff --git a/lisp/url/url-handlers.el b/lisp/url/url-handlers.el
index 1fe0af65ff..7d0320cb5b 100644
--- a/lisp/url/url-handlers.el
+++ b/lisp/url/url-handlers.el
@@ -41,6 +41,9 @@
 (declare-function mm-decode-string "mm-bodies" (string charset))
 ;; mm-decode loads mail-parse.
 (declare-function mail-content-type-get "mail-parse" (ct attribute))
+;; mm-decode loads mm-bodies, which loads mm-util.
+(declare-function mm-charset-to-coding-system "mm-util"
+                 (charset &optional lbt allow-override silent))
 
 ;; Implementation status
 ;; ---------------------
diff --git a/lisp/vc/add-log.el b/lisp/vc/add-log.el
index bc2be4aadb..175c82f8c0 100644
--- a/lisp/vc/add-log.el
+++ b/lisp/vc/add-log.el
@@ -898,7 +898,7 @@ non-nil, otherwise in local time."
              (insert (if use-hard-newlines hard-newline "\n")
                      (if use-hard-newlines hard-newline "\n"))
              (forward-line -2)
-             (indent-relative-maybe))
+             (indent-relative-first-indent-point))
             (t
              ;; Make a new item.
              (while (looking-at "\\sW")
diff --git a/lisp/vc/ediff-merg.el b/lisp/vc/ediff-merg.el
index ad72d7570c..b67f520ca0 100644
--- a/lisp/vc/ediff-merg.el
+++ b/lisp/vc/ediff-merg.el
@@ -194,7 +194,7 @@ Buffer B."
 
 (defun ediff-set-merge-mode ()
   (normal-mode t)
-  (remove-hook 'local-write-file-hooks 'ediff-set-merge-mode))
+  (remove-hook 'write-file-functions 'ediff-set-merge-mode t))
 
 
 ;; Go over all diffs starting with DIFF-NUM and copy regions into buffer C
diff --git a/lisp/vc/ediff-util.el b/lisp/vc/ediff-util.el
index 8670ba4603..1158b7146e 100644
--- a/lisp/vc/ediff-util.el
+++ b/lisp/vc/ediff-util.el
@@ -347,7 +347,7 @@ to invocation.")
 	      (goto-char (point-min))
 	      (funcall (ediff-with-current-buffer buf major-mode))
 	      (widen) ; merge buffer is always widened
-	      (add-hook 'local-write-file-hooks 'ediff-set-merge-mode nil t)
+	      (add-hook 'write-file-functions 'ediff-set-merge-mode nil t)
 	      )))
       (setq buffer-read-only nil
 	    ediff-buffer-A buffer-A
@@ -778,8 +778,8 @@ Reestablish the default window display."
 	  (select-frame-set-input-focus ediff-control-frame)
 	(raise-frame ediff-control-frame)
 	(select-frame ediff-control-frame)
-	(if (fboundp 'focus-frame)
-	    (focus-frame ediff-control-frame))))
+	(and (featurep 'xemacs) (fboundp 'focus-frame)
+	     (focus-frame ediff-control-frame))))
 
   ;; Redisplay whatever buffers are showing, if there is a selected difference
   (let ((control-frame ediff-control-frame)
diff --git a/lisp/vc/log-edit.el b/lisp/vc/log-edit.el
index 89b6201bab..6ff782a606 100644
--- a/lisp/vc/log-edit.el
+++ b/lisp/vc/log-edit.el
@@ -203,10 +203,7 @@ when this variable is set to nil.")
 
 (defconst log-edit-maximum-comment-ring-size 32
   "Maximum number of saved comments in the comment ring.")
-(define-obsolete-variable-alias 'vc-comment-ring 'log-edit-comment-ring "22.1")
 (defvar log-edit-comment-ring (make-ring log-edit-maximum-comment-ring-size))
-(define-obsolete-variable-alias 'vc-comment-ring-index
-  'log-edit-comment-ring-index "22.1")
 (defvar log-edit-comment-ring-index nil)
 (defvar log-edit-last-comment-match "")
 
@@ -311,13 +308,6 @@ automatically."
     (or (eobp) (looking-at "\n\n")
 	(insert "\n"))))
 
-;; Compatibility with old names.
-(define-obsolete-function-alias 'vc-previous-comment 'log-edit-previous-comment "22.1")
-(define-obsolete-function-alias 'vc-next-comment 'log-edit-next-comment "22.1")
-(define-obsolete-function-alias 'vc-comment-search-reverse 'log-edit-comment-search-backward "22.1")
-(define-obsolete-function-alias 'vc-comment-search-forward 'log-edit-comment-search-forward "22.1")
-(define-obsolete-function-alias 'vc-comment-to-change-log 'log-edit-comment-to-change-log "22.1")
-
 ;;;
 ;;; Actual code
 ;;;
diff --git a/lisp/vc/pcvs-info.el b/lisp/vc/pcvs-info.el
index 7e72767055..edcfc6e6c4 100644
--- a/lisp/vc/pcvs-info.el
+++ b/lisp/vc/pcvs-info.el
@@ -39,9 +39,6 @@
 ;;;; config variables
 ;;;;
 
-(define-obsolete-variable-alias 'cvs-display-full-path
-    'cvs-display-full-name "22.1")
-
 (defcustom cvs-display-full-name t
   "Specifies how the filenames should be displayed in the listing.
 If non-nil, their full filename name will be displayed, else only the
@@ -211,8 +208,6 @@ to confuse some users sometimes."
       ;; Here, I use `concat' rather than `expand-file-name' because I want
       ;; the resulting path to stay relative if `dir' is relative.
       (concat dir (cvs-fileinfo->file fileinfo)))))
-(define-obsolete-function-alias 'cvs-fileinfo->full-path
-    'cvs-fileinfo->full-name "22.1")
 
 (defun cvs-fileinfo->pp-name (fi)
   "Return the filename of FI as it should be displayed."
diff --git a/lisp/vc/vc-dir.el b/lisp/vc/vc-dir.el
index db595331bb..18da6e3357 100644
--- a/lisp/vc/vc-dir.el
+++ b/lisp/vc/vc-dir.el
@@ -697,7 +697,7 @@ share the same state."
 (defun vc-dir-unmark ()
   "Unmark the current file or all files in the region.
 If the region is active, unmark all the files in the region.
-Otherwise mark the file on the current line and move to the next
+Otherwise unmark the file on the current line and move to the next
 line."
   (interactive)
   (vc-dir-mark-unmark 'vc-dir-unmark-file))
diff --git a/lisp/vc/vc.el b/lisp/vc/vc.el
index 01dc47e808..7646af075f 100644
--- a/lisp/vc/vc.el
+++ b/lisp/vc/vc.el
@@ -1649,11 +1649,6 @@ to override the value of `vc-diff-switches' and `diff-switches'."
       ;; any switches in diff-switches.
       (when (listp switches) switches))))
 
-;; Old def for compatibility with Emacs-21.[123].
-(defmacro vc-diff-switches-list (backend)
-  (declare (obsolete vc-switches "22.1"))
-  `(vc-switches ',backend 'diff))
-
 (defun vc-diff-finish (buffer messages)
   ;; The empty sync output case has already been handled, so the only
   ;; possibility of an empty output is for an async process.
diff --git a/lisp/w32-fns.el b/lisp/w32-fns.el
index b400c8d4a6..825420c426 100644
--- a/lisp/w32-fns.el
+++ b/lisp/w32-fns.el
@@ -256,7 +256,7 @@ bit output with no translation."
 
 (when (boundp 'w32-charset-info-alist)
   ;; The last charset we add becomes the "preferred" charset for the return
-  ;; value from w32-select-font etc, so list the most important charsets last.
+  ;; value from x-select-font etc, so list the most important charsets last.
   (w32-add-charset-info "iso8859-14" 'w32-charset-ansi  28604)
   (w32-add-charset-info "iso8859-15" 'w32-charset-ansi  28605)
   ;; The following two are included for pattern matching.
diff --git a/lisp/woman.el b/lisp/woman.el
index 1a603dba2f..c83a04874a 100644
--- a/lisp/woman.el
+++ b/lisp/woman.el
@@ -1759,8 +1759,8 @@ Leave point at end of new text.  Return length of inserted text."
 	   (condition-case ()
 	       (insert-file-contents filename nil)
 	     (file-error
-	      ;; Run find-file-not-found-hooks until one returns non-nil.
-	      ;; (run-hook-with-args-until-success 'find-file-not-found-hooks)
+	      ;; Run find-file-not-found-functions until one returns non-nil.
+	      ;; (run-hook-with-args-until-success 'find-file-not-found-functions)
 	      (insert "\n***** File " filename " not found! *****\n\n")))))))
 
 
diff --git a/src/alloc.c b/src/alloc.c
index a50bb81409..cc52d66b32 100644
--- a/src/alloc.c
+++ b/src/alloc.c
@@ -3596,7 +3596,7 @@ struct marker_block
 static struct marker_block *marker_block;
 static int marker_block_index = MARKER_BLOCK_SIZE;
 
-static union Lisp_Misc *marker_free_list;
+static union Lisp_Misc *misc_free_list;
 
 /* Return a newly allocated Lisp_Misc object of specified TYPE.  */
 
@@ -3607,10 +3607,10 @@ allocate_misc (enum Lisp_Misc_Type type)
 
   MALLOC_BLOCK_INPUT;
 
-  if (marker_free_list)
+  if (misc_free_list)
     {
-      XSETMISC (val, marker_free_list);
-      marker_free_list = marker_free_list->u_free.chain;
+      XSETMISC (val, misc_free_list);
+      misc_free_list = misc_free_list->u_free.chain;
     }
   else
     {
@@ -3642,8 +3642,8 @@ void
 free_misc (Lisp_Object misc)
 {
   XMISCANY (misc)->type = Lisp_Misc_Free;
-  XMISC (misc)->u_free.chain = marker_free_list;
-  marker_free_list = XMISC (misc);
+  XMISC (misc)->u_free.chain = misc_free_list;
+  misc_free_list = XMISC (misc);
   consing_since_gc -= sizeof (union Lisp_Misc);
   total_free_markers++;
 }
@@ -6974,7 +6974,7 @@ sweep_misc (void)
   /* Put all unmarked misc's on free list.  For a marker, first
      unchain it from the buffer it points into.  */
 
-  marker_free_list = 0;
+  misc_free_list = 0;
 
   for (mblk = marker_block; mblk; mblk = *mprev)
     {
@@ -7001,8 +7001,8 @@ sweep_misc (void)
                  We could leave the type alone, since nobody checks it,
                  but this might catch bugs faster.  */
               mblk->markers[i].m.u_marker.type = Lisp_Misc_Free;
-              mblk->markers[i].m.u_free.chain = marker_free_list;
-              marker_free_list = &mblk->markers[i].m;
+              mblk->markers[i].m.u_free.chain = misc_free_list;
+              misc_free_list = &mblk->markers[i].m;
               this_free++;
             }
           else
@@ -7019,7 +7019,7 @@ sweep_misc (void)
         {
           *mprev = mblk->next;
           /* Unhook from the free list.  */
-          marker_free_list = mblk->markers[0].m.u_free.chain;
+          misc_free_list = mblk->markers[0].m.u_free.chain;
           lisp_free (mblk);
         }
       else
diff --git a/src/data.c b/src/data.c
index 1bb48722fa..06604faaae 100644
--- a/src/data.c
+++ b/src/data.c
@@ -1290,7 +1290,7 @@ If the base used is not 10, STRING is always parsed as an integer.  */)
   while (*p == ' ' || *p == '\t')
     p++;
 
-  val = string_to_number (p, b, 1);
+  val = string_to_number (p, b, true);
   return NILP (val) ? make_number (0) : val;
 }
 
diff --git a/src/dispextern.h b/src/dispextern.h
index 3d975d1203..15e56c910e 100644
--- a/src/dispextern.h
+++ b/src/dispextern.h
@@ -2424,6 +2424,10 @@ struct it
      descent/ascent (line-height property).  Reset after this glyph.  */
   bool_bf constrain_row_ascent_descent_p : 1;
 
+  /* If true, glyphs for line number display were already produced for
+     the current row.  */
+  bool_bf line_number_produced_p : 1;
+
   enum line_wrap_method line_wrap;
 
   /* The ID of the default face to use.  One of DEFAULT_FACE_ID,
@@ -2603,6 +2607,12 @@ struct it
   /* The line number of point's line, or zero if not computed yet.  */
   ptrdiff_t pt_lnum;
 
+  /* Number of pixels to offset tab stops due to width fixup of the
+     first glyph that crosses first_visible_x.  This is only needed on
+     GUI frames, only when display-line-numbers is in effect, and only
+     in hscrolled windows.  */
+  int tab_offset;
+
   /* Left fringe bitmap number (enum fringe_bitmap_type).  */
   unsigned left_user_fringe_bitmap : FRINGE_ID_BITS;
 
diff --git a/src/editfns.c b/src/editfns.c
index 21b8f6104f..041af87acd 100644
--- a/src/editfns.c
+++ b/src/editfns.c
@@ -118,14 +118,10 @@ emacs_mktime_z (timezone_t tz, struct tm *tm)
   return t;
 }
 
-/* Allocate a timezone, signaling on failure.  */
-static timezone_t
-xtzalloc (char const *name)
+static _Noreturn void
+invalid_time_zone_specification (Lisp_Object zone)
 {
-  timezone_t tz = tzalloc (name);
-  if (!tz)
-    memory_full (SIZE_MAX);
-  return tz;
+  xsignal2 (Qerror, build_string ("Invalid time zone specification"), zone);
 }
 
 /* Free a timezone, except do not free the time zone for local time.
@@ -206,9 +202,27 @@ tzlookup (Lisp_Object zone, bool settz)
 	    }
 	}
       else
-	xsignal2 (Qerror, build_string ("Invalid time zone specification"),
-		  zone);
-      new_tz = xtzalloc (zone_string);
+	invalid_time_zone_specification (zone);
+
+      new_tz = tzalloc (zone_string);
+
+#if defined __NetBSD_Version__ && __NetBSD_Version__ < 700000000
+      /* NetBSD 6 tzalloc mishandles POSIX TZ strings (Bug#30738).
+	 If possible, fall back on tzdb.  */
+      if (!new_tz && errno != ENOMEM && plain_integer
+	  && XINT (zone) % (60 * 60) == 0)
+	{
+	  sprintf (tzbuf, "Etc/GMT%+"pI"d", - (XINT (zone) / (60 * 60)));
+	  new_tz = tzalloc (zone_string);
+	}
+#endif
+
+      if (!new_tz)
+	{
+	  if (errno == ENOMEM)
+	    memory_full (SIZE_MAX);
+	  invalid_time_zone_specification (zone);
+	}
     }
 
   if (settz)
@@ -2867,32 +2881,30 @@ styled_format (ptrdiff_t nargs, Lisp_Object *args, bool message)
 		 and with pM inserted for integer formats.
 		 At most two flags F can be specified at once.  */
 	      char convspec[sizeof "%FF.*d" + max (INT_AS_LDBL, pMlen)];
-	      {
-		char *f = convspec;
-		*f++ = '%';
-		/* MINUS_FLAG and ZERO_FLAG are dealt with later.  */
-		*f = '+'; f +=  plus_flag;
-		*f = ' '; f += space_flag;
-		*f = '#'; f += sharp_flag;
-                *f++ = '.';
-                *f++ = '*';
-		if (float_conversion)
-		  {
-		    if (INT_AS_LDBL)
-		      {
-			*f = 'L';
-			f += INTEGERP (arg);
-		      }
-		  }
-		else if (conversion != 'c')
-		  {
-		    memcpy (f, pMd, pMlen);
-		    f += pMlen;
-		    zero_flag &= ! precision_given;
-		  }
-		*f++ = conversion;
-		*f = '\0';
-	      }
+	      char *f = convspec;
+	      *f++ = '%';
+	      /* MINUS_FLAG and ZERO_FLAG are dealt with later.  */
+	      *f = '+'; f +=  plus_flag;
+	      *f = ' '; f += space_flag;
+	      *f = '#'; f += sharp_flag;
+	      *f++ = '.';
+	      *f++ = '*';
+	      if (float_conversion)
+		{
+		  if (INT_AS_LDBL)
+		    {
+		      *f = 'L';
+		      f += INTEGERP (arg);
+		    }
+		}
+	      else if (conversion != 'c')
+		{
+		  memcpy (f, pMd, pMlen);
+		  f += pMlen;
+		  zero_flag &= ! precision_given;
+		}
+	      *f++ = conversion;
+	      *f = '\0';
 
 	      int prec = -1;
 	      if (precision_given)
@@ -2934,29 +2946,20 @@ styled_format (ptrdiff_t nargs, Lisp_Object *args, bool message)
 		}
 	      else if (conversion == 'd' || conversion == 'i')
 		{
-		  /* For float, maybe we should use "%1.0f"
-		     instead so it also works for values outside
-		     the integer range.  */
-		  printmax_t x;
 		  if (INTEGERP (arg))
-		    x = XINT (arg);
+		    {
+		      printmax_t x = XINT (arg);
+		      sprintf_bytes = sprintf (sprintf_buf, convspec, prec, x);
+		    }
 		  else
 		    {
-		      double d = XFLOAT_DATA (arg);
-		      if (d < 0)
-			{
-			  x = TYPE_MINIMUM (printmax_t);
-			  if (x < d)
-			    x = d;
-			}
-		      else
-			{
-			  x = TYPE_MAXIMUM (printmax_t);
-			  if (d < x)
-			    x = d;
-			}
+		      strcpy (f - pMlen - 1, "f");
+		      double x = XFLOAT_DATA (arg);
+		      sprintf_bytes = sprintf (sprintf_buf, convspec, 0, x);
+		      char c0 = sprintf_buf[0];
+		      bool signedp = ! ('0' <= c0 && c0 <= '9');
+		      prec = min (precision, sprintf_bytes - signedp);
 		    }
-		  sprintf_bytes = sprintf (sprintf_buf, convspec, prec, x);
 		}
 	      else
 		{
@@ -2967,22 +2970,19 @@ styled_format (ptrdiff_t nargs, Lisp_Object *args, bool message)
 		  else
 		    {
 		      double d = XFLOAT_DATA (arg);
-		      if (d < 0)
-			x = 0;
-		      else
-			{
-			  x = TYPE_MAXIMUM (uprintmax_t);
-			  if (d < x)
-			    x = d;
-			}
+		      double uprintmax = TYPE_MAXIMUM (uprintmax_t);
+		      if (! (0 <= d && d < uprintmax + 1))
+			xsignal1 (Qoverflow_error, arg);
+		      x = d;
 		    }
 		  sprintf_bytes = sprintf (sprintf_buf, convspec, prec, x);
 		}
 
 	      /* Now the length of the formatted item is known, except it omits
 		 padding and excess precision.  Deal with excess precision
-		 first.  This happens only when the format specifies
-		 ridiculously large precision.  */
+		 first.  This happens when the format specifies ridiculously
+		 large precision, or when %d or %i formats a float that would
+		 ordinarily need fewer digits than a specified precision.  */
 	      ptrdiff_t excess_precision
 		= precision_given ? precision - prec : 0;
 	      ptrdiff_t leading_zeros = 0, trailing_zeros = 0;
@@ -3379,7 +3379,16 @@ transpose_markers (ptrdiff_t start1, ptrdiff_t end1,
     }
 }
 
-DEFUN ("transpose-regions", Ftranspose_regions, Stranspose_regions, 4, 5, 0,
+DEFUN ("transpose-regions", Ftranspose_regions, Stranspose_regions, 4, 5,
+       "(if (< (length mark-ring) 2)\
+	    (error \"Other region must be marked before transposing two regions\")\
+	  (let* ((num (if current-prefix-arg\
+			 (prefix-numeric-value current-prefix-arg)\
+			0))\
+		 (ring-length (length mark-ring))\
+		 (eltnum (mod num ring-length))\
+		 (eltnum2 (mod (1+ num) ring-length)))\
+	    (list (point) (mark) (elt mark-ring eltnum) (elt mark-ring eltnum2))))",
        doc: /* Transpose region STARTR1 to ENDR1 with STARTR2 to ENDR2.
 The regions should not be overlapping, because the size of the buffer is
 never changed in a transposition.
@@ -3387,7 +3396,14 @@ never changed in a transposition.
 Optional fifth arg LEAVE-MARKERS, if non-nil, means don't update
 any markers that happen to be located in the regions.
 
-Transposing beyond buffer boundaries is an error.  */)
+Transposing beyond buffer boundaries is an error.
+
+Interactively, STARTR1 and ENDR1 are point and mark; STARTR2 and ENDR2
+are the last two marks pushed to the mark ring; LEAVE-MARKERS is nil.
+If a prefix argument N is given, STARTR2 and ENDR2 are the two
+successive marks N entries back in the mark ring.  A negative prefix
+argument instead counts forward from the oldest mark in the mark
+ring.  */)
   (Lisp_Object startr1, Lisp_Object endr1, Lisp_Object startr2, Lisp_Object endr2, Lisp_Object leave_markers)
 {
   register ptrdiff_t start1, end1, start2, end2;
diff --git a/src/fns.c b/src/fns.c
index 31b0ab633e..9b73929e72 100644
--- a/src/fns.c
+++ b/src/fns.c
@@ -2939,8 +2939,6 @@ extract_data_from_object (Lisp_Object spec,
 
       record_unwind_current_buffer ();
 
-      CHECK_BUFFER (object);
-
       struct buffer *bp = XBUFFER (object);
       set_buffer_internal (bp);
 
@@ -3062,6 +3060,9 @@ extract_data_from_object (Lisp_Object spec,
 #endif
     }
 
+  if (!STRINGP (object))
+    signal_error ("Invalid object argument",
+		  NILP (object) ? build_string ("nil") : object);
   return SSDATA (object);
 }
 
diff --git a/src/frame.c b/src/frame.c
index 33df48cf9d..2f0e962a30 100644
--- a/src/frame.c
+++ b/src/frame.c
@@ -1318,7 +1318,7 @@ do_switch_frame (Lisp_Object frame, int track, int for_deletion, Lisp_Object nor
   /* We want to make sure that the next event generates a frame-switch
      event to the appropriate frame.  This seems kludgy to me, but
      before you take it out, make sure that evaluating something like
-     (select-window (frame-root-window (new-frame))) doesn't end up
+     (select-window (frame-root-window (make-frame))) doesn't end up
      with your typing being interpreted in the new frame instead of
      the one you're actually typing in.  */
 #ifdef HAVE_WINDOW_SYSTEM
diff --git a/src/lread.c b/src/lread.c
index 1f91947422..49a1bfe54d 100644
--- a/src/lread.c
+++ b/src/lread.c
@@ -2603,7 +2603,7 @@ read_integer (Lisp_Object readcharfun, EMACS_INT radix)
       invalid_syntax (buf);
     }
 
-  return string_to_number (buf, radix, 0);
+  return string_to_number (buf, radix, false);
 }
 
 
@@ -3412,7 +3412,7 @@ read1 (Lisp_Object readcharfun, int *pch, bool first_in_list)
 
 	if (!quoted && !uninterned_symbol)
 	  {
-	    Lisp_Object result = string_to_number (read_buffer, 10, 0);
+	    Lisp_Object result = string_to_number (read_buffer, 10, false);
 	    if (! NILP (result))
 	      return unbind_to (count, result);
 	  }
diff --git a/src/nsterm.m b/src/nsterm.m
index c6e11eca6d..b171a37567 100644
--- a/src/nsterm.m
+++ b/src/nsterm.m
@@ -3487,23 +3487,38 @@ Note that CURSOR_WIDTH is meaningful only for (h)bar cursors.
             {
 	      struct font *font = font_for_underline_metrics (s);
               unsigned long descent = s->y + s->height - s->ybase;
+              unsigned long minimum_offset;
+              BOOL underline_at_descent_line, use_underline_position_properties;
+              Lisp_Object val = buffer_local_value (Qunderline_minimum_offset,
+                                                    s->w->contents);
+              if (INTEGERP (val))
+                minimum_offset = XFASTINT (val);
+              else
+                minimum_offset = 1;
+              val = buffer_local_value (Qx_underline_at_descent_line,
+                                        s->w->contents);
+              underline_at_descent_line = !(NILP (val) || EQ (val, Qunbound));
+              val = buffer_local_value (Qx_use_underline_position_properties,
+                                        s->w->contents);
+              use_underline_position_properties =
+		!(NILP (val) || EQ (val, Qunbound));
 
               /* Use underline thickness of font, defaulting to 1. */
               thickness = (font && font->underline_thickness > 0)
                 ? font->underline_thickness : 1;
 
               /* Determine the offset of underlining from the baseline. */
-              if (x_underline_at_descent_line)
+              if (underline_at_descent_line)
                 position = descent - thickness;
-              else if (x_use_underline_position_properties
+              else if (use_underline_position_properties
                        && font && font->underline_position >= 0)
                 position = font->underline_position;
               else if (font)
                 position = lround (font->descent / 2);
               else
-                position = underline_minimum_offset;
+                position = minimum_offset;
 
-              position = max (position, underline_minimum_offset);
+              position = max (position, minimum_offset);
 
               /* Ensure underlining is not cropped. */
               if (descent <= position)
@@ -9465,6 +9480,8 @@ Nil means use fullscreen the old (< 10.7) way.  The old way works better with
 	       x_use_underline_position_properties,
      doc: /* SKIP: real doc in xterm.c.  */);
   x_use_underline_position_properties = 0;
+  DEFSYM (Qx_use_underline_position_properties,
+	  "x-use-underline-position-properties");
 
   DEFVAR_BOOL ("x-underline-at-descent-line",
 	       x_underline_at_descent_line,
@@ -9475,6 +9492,7 @@ Nil means use fullscreen the old (< 10.7) way.  The old way works better with
 variable `x-use-underline-position-properties', which is usually at the
 baseline level.  The default value is nil.  */);
   x_underline_at_descent_line = 0;
+  DEFSYM (Qx_underline_at_descent_line, "x-underline-at-descent-line");
 
   /* Tell Emacs about this window system.  */
   Fprovide (Qns, Qnil);
diff --git a/src/print.c b/src/print.c
index b3c0f6f38f..a8bbb9d37a 100644
--- a/src/print.c
+++ b/src/print.c
@@ -313,6 +313,25 @@ printchar (unsigned int ch, Lisp_Object fun)
     }
 }
 
+/* Output an octal escape for C.  If C is less than '\100' consult the
+   following character (if any) to see whether to use three octal
+   digits to avoid misinterpretation of the next character.  The next
+   character after C will be taken from DATA, starting at byte
+   location I, if I is less than SIZE.  Use PRINTCHARFUN to output
+   each character.  */
+
+static void
+octalout (unsigned char c, unsigned char *data, ptrdiff_t i, ptrdiff_t size,
+	  Lisp_Object printcharfun)
+{
+  int digits = (c > '\77' || (i < size && '0' <= data[i] && data[i] <= '7')
+		? 3
+		: c > '\7' ? 2 : 1);
+  printchar ('\\', printcharfun);
+  do
+    printchar ('0' + ((c >> (3 * --digits)) & 7), printcharfun);
+  while (digits != 0);
+}
 
 /* Output SIZE characters, SIZE_BYTE bytes from string PTR using
    method PRINTCHARFUN.  PRINTCHARFUN nil means output to
@@ -1367,32 +1386,33 @@ print_vectorlike (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag,
     case PVEC_BOOL_VECTOR:
       {
 	EMACS_INT size = bool_vector_size (obj);
-	ptrdiff_t size_in_chars = bool_vector_bytes (size);
-	ptrdiff_t real_size_in_chars = size_in_chars;
+	ptrdiff_t size_in_bytes = bool_vector_bytes (size);
+	ptrdiff_t real_size_in_bytes = size_in_bytes;
+	unsigned char *data = bool_vector_uchar_data (obj);
 
 	int len = sprintf (buf, "#&%"pI"d\"", size);
 	strout (buf, len, len, printcharfun);
 
-	/* Don't print more characters than the specified maximum.
+	/* Don't print more bytes than the specified maximum.
 	   Negative values of print-length are invalid.  Treat them
 	   like a print-length of nil.  */
 	if (NATNUMP (Vprint_length)
-	    && XFASTINT (Vprint_length) < size_in_chars)
-	  size_in_chars = XFASTINT (Vprint_length);
+	    && XFASTINT (Vprint_length) < size_in_bytes)
+	  size_in_bytes = XFASTINT (Vprint_length);
 
-	for (ptrdiff_t i = 0; i < size_in_chars; i++)
+	for (ptrdiff_t i = 0; i < size_in_bytes; i++)
 	  {
 	    maybe_quit ();
-	    unsigned char c = bool_vector_uchar_data (obj)[i];
+	    unsigned char c = data[i];
 	    if (c == '\n' && print_escape_newlines)
 	      print_c_string ("\\n", printcharfun);
 	    else if (c == '\f' && print_escape_newlines)
 	      print_c_string ("\\f", printcharfun);
-	    else if (c > '\177')
+	    else if (c > '\177'
+		     || (print_escape_control_characters && c_iscntrl (c)))
 	      {
 		/* Use octal escapes to avoid encoding issues.  */
-		int len = sprintf (buf, "\\%o", c);
-		strout (buf, len, len, printcharfun);
+		octalout (c, data, i + 1, size_in_bytes, printcharfun);
 	      }
 	    else
 	      {
@@ -1402,7 +1422,7 @@ print_vectorlike (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag,
 	      }
 	  }
 
-	if (size_in_chars < real_size_in_chars)
+	if (size_in_bytes < real_size_in_bytes)
 	  print_c_string (" ...", printcharfun);
 	printchar ('\"', printcharfun);
       }
@@ -1854,9 +1874,7 @@ print_object (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag)
 		     (when requested) a non-ASCII character in a unibyte buffer,
 		     print single-byte non-ASCII string chars
 		     using octal escapes.  */
-		  char outbuf[5];
-		  int len = sprintf (outbuf, "\\%03o", c + 0u);
-		  strout (outbuf, len, len, printcharfun);
+		  octalout (c, SDATA (obj), i_byte, size_byte, printcharfun);
 		  need_nonhex = false;
 		}
 	      else if (multibyte
@@ -1870,7 +1888,6 @@ print_object (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag)
 		}
 	      else
 		{
-                  bool still_need_nonhex = false;
 		  /* If we just had a hex escape, and this character
 		     could be taken as part of it,
 		     output `\ ' to prevent that.  */
@@ -1884,22 +1901,16 @@ print_object (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag)
                            ? (c = 'n', true)
                            : c == '\f' && print_escape_newlines
                            ? (c = 'f', true)
-                           : c == '\0' && print_escape_control_characters
-                           ? (c = '0', still_need_nonhex = true)
                            : c == '\"' || c == '\\')
                     {
                       printchar ('\\', printcharfun);
                       printchar (c, printcharfun);
                     }
                   else if (print_escape_control_characters && c_iscntrl (c))
-                    {
-                      char outbuf[1 + 3 + 1];
-                      int len = sprintf (outbuf, "\\%03o", c + 0u);
-                      strout (outbuf, len, len, printcharfun);
-                    }
+		    octalout (c, SDATA (obj), i_byte, size_byte, printcharfun);
                   else
                     printchar (c, printcharfun);
-		  need_nonhex = still_need_nonhex;
+		  need_nonhex = false;
 		}
 	    }
 	  printchar ('\"', printcharfun);
diff --git a/src/process.c b/src/process.c
index 17a46d3ed3..1f0565ef65 100644
--- a/src/process.c
+++ b/src/process.c
@@ -1734,9 +1734,9 @@ create_process (Lisp_Object process, char **new_argv, Lisp_Object current_dir)
     {
       /* Make the pty be the controlling terminal of the process.  */
 #ifdef HAVE_PTYS
-      /* First, disconnect its current controlling terminal.  */
-      if (pty_flag)
-	setsid ();
+      /* First, disconnect its current controlling terminal.
+	 Do this even if !PTY_FLAG; see Bug#30762.  */
+      setsid ();
       /* Make the pty's terminal the controlling terminal.  */
       if (pty_flag && forkin >= 0)
 	{
@@ -6434,7 +6434,7 @@ SIGCODE may be an integer, or a symbol whose name is a signal name.  */)
       if (NILP (tem))
 	{
 	  Lisp_Object process_number
-	    = string_to_number (SSDATA (process), 10, 1);
+	    = string_to_number (SSDATA (process), 10, true);
 	  if (NUMBERP (process_number))
 	    tem = process_number;
 	}
diff --git a/src/term.c b/src/term.c
index 03310d2c81..cf8484ee7c 100644
--- a/src/term.c
+++ b/src/term.c
@@ -1593,13 +1593,13 @@ produce_glyphs (struct it *it)
 			+ it->continuation_lines_width);
       int x0 = absolute_x;
       /* Adjust for line numbers.  */
-      if (!NILP (Vdisplay_line_numbers))
+      if (!NILP (Vdisplay_line_numbers) && it->line_number_produced_p)
 	absolute_x -= it->lnum_pixel_width;
       int next_tab_x
 	= (((1 + absolute_x + it->tab_width - 1)
 	    / it->tab_width)
 	   * it->tab_width);
-      if (!NILP (Vdisplay_line_numbers))
+      if (!NILP (Vdisplay_line_numbers) && it->line_number_produced_p)
 	next_tab_x += it->lnum_pixel_width;
       int nspaces;
 
diff --git a/src/w32term.c b/src/w32term.c
index 23220d6027..acbcbac220 100644
--- a/src/w32term.c
+++ b/src/w32term.c
@@ -2475,31 +2475,52 @@ x_draw_glyph_string (struct glyph_string *s)
               else
                 {
 		  struct font *font = font_for_underline_metrics (s);
+		  unsigned long minimum_offset;
+		  BOOL underline_at_descent_line;
+		  BOOL use_underline_position_properties;
+		  Lisp_Object val
+		    = buffer_local_value (Qunderline_minimum_offset,
+					s->w->contents);
+		  if (INTEGERP (val))
+		    minimum_offset = XFASTINT (val);
+		  else
+		    minimum_offset = 1;
+		  val = buffer_local_value (Qx_underline_at_descent_line,
+					    s->w->contents);
+		  underline_at_descent_line
+		    = !(NILP (val) || EQ (val, Qunbound));
+		  val
+		    = buffer_local_value (Qx_use_underline_position_properties,
+					  s->w->contents);
+		  use_underline_position_properties
+		    = !(NILP (val) || EQ (val, Qunbound));
 
                   /* Get the underline thickness.  Default is 1 pixel.  */
                   if (font && font->underline_thickness > 0)
                     thickness = font->underline_thickness;
                   else
                     thickness = 1;
-                  if (x_underline_at_descent_line || !font)
+                  if (underline_at_descent_line
+                      || !font)
                     position = (s->height - thickness) - (s->ybase - s->y);
                   else
                     {
-                      /* Get the underline position.  This is the recommended
-                         vertical offset in pixels from the baseline to the top of
-                         the underline.  This is a signed value according to the
+                      /* Get the underline position.  This is the
+                         recommended vertical offset in pixels from
+                         the baseline to the top of the underline.
+                         This is a signed value according to the
                          specs, and its default is
 
                          ROUND ((maximum_descent) / 2), with
                          ROUND (x) = floor (x + 0.5)  */
 
-                      if (x_use_underline_position_properties
+                      if (use_underline_position_properties
                           && font->underline_position >= 0)
                         position = font->underline_position;
                       else
                         position = (font->descent + 1) / 2;
                     }
-                  position = max (position, underline_minimum_offset);
+                  position = max (position, minimum_offset);
                 }
               /* Check the sanity of thickness and position.  We should
                  avoid drawing underline out of the current line area.  */
@@ -7385,6 +7406,8 @@ the cursor have no effect.  */);
 	       x_use_underline_position_properties,
      doc: /* SKIP: real doc in xterm.c.  */);
   x_use_underline_position_properties = 0;
+  DEFSYM (Qx_use_underline_position_properties,
+	  "x-use-underline-position-properties");
 
   DEFVAR_BOOL ("x-underline-at-descent-line",
 	       x_underline_at_descent_line,
@@ -7395,6 +7418,7 @@ A value of nil means to draw the underline according to the value of the
 variable `x-use-underline-position-properties', which is usually at the
 baseline level.  The default value is nil.  */);
   x_underline_at_descent_line = 0;
+  DEFSYM (Qx_underline_at_descent_line, "x-underline-at-descent-line");
 
   DEFVAR_LISP ("x-toolkit-scroll-bars", Vx_toolkit_scroll_bars,
 	       doc: /* SKIP: real doc in xterm.c.  */);
diff --git a/src/window.c b/src/window.c
index 678d4d0703..aef079b9d5 100644
--- a/src/window.c
+++ b/src/window.c
@@ -5008,6 +5008,9 @@ and redisplay normally--don't erase and redraw the frame.  */)
   EMACS_INT iarg UNINIT;
   int this_scroll_margin;
 
+  /* For reasons why we signal an error here, see
+     http://lists.gnu.org/archive/html/emacs-devel/2014-06/msg00053.html,
+     http://lists.gnu.org/archive/html/emacs-devel/2014-06/msg00094.html.  */
   if (buf != current_buffer)
     error ("`recenter'ing a window that does not display current-buffer.");
 
diff --git a/src/xdisp.c b/src/xdisp.c
index 747545d7ef..4e7ee0b8fb 100644
--- a/src/xdisp.c
+++ b/src/xdisp.c
@@ -8716,8 +8716,12 @@ move_it_in_display_line_to (struct it *it,
 
   if (it->hpos == 0)
     {
-      /* If line numbers are being displayed, produce a line number.  */
-      if (should_produce_line_number (it))
+      /* If line numbers are being displayed, produce a line number.
+	 But don't do that if we are to reach first_visible_x, because
+	 line numbers are not relevant to stuff that is not visible on
+	 display.  */
+      if (!((op && MOVE_TO_X) && to_x == it->first_visible_x)
+	  && should_produce_line_number (it))
 	{
 	  if (it->current_x == it->first_visible_x)
 	    maybe_produce_line_number (it);
@@ -9594,6 +9598,7 @@ move_it_to (struct it *it, ptrdiff_t to_charpos, int to_x, int to_y, int to_vpos
       it->current_x = line_start_x;
       line_start_x = 0;
       it->hpos = 0;
+      it->line_number_produced_p = false;
       it->current_y += it->max_ascent + it->max_descent;
       ++it->vpos;
       last_height = it->max_ascent + it->max_descent;
@@ -10132,17 +10137,48 @@ include the height of both, if present, in the return value.  */)
   itdata = bidi_shelve_cache ();
   SET_TEXT_POS (startp, start, CHAR_TO_BYTE (start));
   start_display (&it, w, startp);
-
-  if (NILP (x_limit))
-    x = move_it_to (&it, end, -1, max_y, -1, MOVE_TO_POS | MOVE_TO_Y);
-  else
+  /* It makes no sense to measure dimensions of region of text that
+     crosses the point where bidi reordering changes scan direction.
+     By using unidirectional movement here we at least support the use
+     case of measuring regions of text that have a uniformly R2L
+     directionality, and regions that begin and end in text of the
+     same directionality.  */
+  it.bidi_p = false;
+
+  int move_op = MOVE_TO_POS | MOVE_TO_Y;
+  int to_x = -1;
+  if (!NILP (x_limit))
     {
       it.last_visible_x = max_x;
       /* Actually, we never want move_it_to stop at to_x.  But to make
 	 sure that move_it_in_display_line_to always moves far enough,
-	 we set it to INT_MAX and specify MOVE_TO_X.  */
-      x = move_it_to (&it, end, INT_MAX, max_y, -1,
-		      MOVE_TO_POS | MOVE_TO_X | MOVE_TO_Y);
+	 we set to_x to INT_MAX and specify MOVE_TO_X.  */
+      move_op |= MOVE_TO_X;
+      to_x = INT_MAX;
+    }
+
+  void *it2data = NULL;
+  struct it it2;
+  SAVE_IT (it2, it, it2data);
+
+  x = move_it_to (&it, end, to_x, max_y, -1, move_op);
+
+  /* We could have a display property at END, in which case asking
+     move_it_to to stop at END will overshoot and stop at position
+     after END.  So we try again, stopping before END, and account for
+     the width of the last buffer position manually.  */
+  if (IT_CHARPOS (it) > end)
+    {
+      end--;
+      RESTORE_IT (&it, &it2, it2data);
+      x = move_it_to (&it, end, to_x, max_y, -1, move_op);
+      /* Add the width of the thing at TO, but only if we didn't
+	 overshoot it; if we did, it is already accounted for.  */
+      if (IT_CHARPOS (it) == end)
+	x += it.pixel_width;
+    }
+  if (!NILP (x_limit))
+    {
       /* Don't return more than X-LIMIT.  */
       if (x > max_x)
         x = max_x;
@@ -21173,6 +21209,8 @@ maybe_produce_line_number (struct it *it)
       it->max_phys_descent = max (it->max_phys_descent, tem_it.max_phys_descent);
     }
 
+  it->line_number_produced_p = true;
+
   bidi_unshelve_cache (itdata, false);
 }
 
@@ -21290,6 +21328,8 @@ display_line (struct it *it, int cursor_vpos)
   row->displays_text_p = true;
   row->starts_in_middle_of_char_p = it->starts_in_middle_of_char_p;
   it->starts_in_middle_of_char_p = false;
+  it->tab_offset = 0;
+  it->line_number_produced_p = false;
 
   /* Arrange the overlays nicely for our purposes.  Usually, we call
      display_line on only one line at a time, in which case this
@@ -21334,6 +21374,10 @@ display_line (struct it *it, int cursor_vpos)
 	      || move_result == MOVE_POS_MATCH_OR_ZV))
 	it->current_x = it->first_visible_x;
 
+      /* In case move_it_in_display_line_to above "produced" the line
+	 number.  */
+      it->line_number_produced_p = false;
+
       /* Record the smallest positions seen while we moved over
 	 display elements that are not visible.  This is needed by
 	 redisplay_internal for optimizing the case where the cursor
@@ -21553,6 +21597,10 @@ display_line (struct it *it, int cursor_vpos)
 	  row->extra_line_spacing = max (row->extra_line_spacing,
 					 it->max_extra_line_spacing);
 	  if (it->current_x - it->pixel_width < it->first_visible_x
+	      /* When line numbers are displayed, row->x should not be
+		 offset, as the first glyph after the line number can
+		 never be partially visible.  */
+	      && !line_number_needed
 	      /* In R2L rows, we arrange in extend_face_to_end_of_line
 		 to add a right offset to the line, by a suitable
 		 change to the stretch glyph that is the leftmost
@@ -21794,7 +21842,8 @@ display_line (struct it *it, int cursor_vpos)
 		  if (it->bidi_p)
 		    RECORD_MAX_MIN_POS (it);
 
-		  if (x < it->first_visible_x && !row->reversed_p)
+		  if (x < it->first_visible_x && !row->reversed_p
+		      && !line_number_needed)
 		    /* Glyph is partially visible, i.e. row starts at
 		       negative X position.  Don't do that in R2L
 		       rows, where we arrange to add a right offset to
@@ -21810,6 +21859,7 @@ display_line (struct it *it, int cursor_vpos)
 		     be taken care of in produce_special_glyphs.  */
 		  if (row->reversed_p
 		      && new_x > it->last_visible_x
+		      && !line_number_needed
 		      && !(it->line_wrap == TRUNCATE
 			   && WINDOW_LEFT_FRINGE_WIDTH (it->w) == 0))
 		    {
@@ -22439,6 +22489,11 @@ Value is the new character position of point.  */)
 		    new_pos += (row->reversed_p ? -dir : dir);
 		  else
 		    new_pos -= (row->reversed_p ? -dir : dir);
+		  new_pos = clip_to_bounds (BEGV, new_pos, ZV);
+		  /* If we didn't move, we've hit BEGV or ZV, so we
+		     need to signal a suitable error.  */
+		  if (new_pos == PT)
+		    break;
 		}
 	      else if (BUFFERP (g->object))
 		new_pos = g->charpos;
@@ -28270,8 +28325,14 @@ x_produce_glyphs (struct it *it)
 	      int x = it->current_x + it->continuation_lines_width;
 	      int x0 = x;
 	      /* Adjust for line numbers, if needed.   */
-	      if (!NILP (Vdisplay_line_numbers) && x0 >= it->lnum_pixel_width)
-		x -= it->lnum_pixel_width;
+	      if (!NILP (Vdisplay_line_numbers) && it->line_number_produced_p)
+		{
+		  x -= it->lnum_pixel_width;
+		  /* Restore the original TAB width, if required.  */
+		  if (x + it->tab_offset >= it->first_visible_x)
+		    x += it->tab_offset;
+		}
+
 	      int next_tab_x = ((1 + x + tab_width - 1) / tab_width) * tab_width;
 
 	      /* If the distance from the current position to the next tab
@@ -28279,10 +28340,19 @@ x_produce_glyphs (struct it *it)
 		 tab stop after that.  */
 	      if (next_tab_x - x < font->space_width)
 		next_tab_x += tab_width;
-	      if (!NILP (Vdisplay_line_numbers) && x0 >= it->lnum_pixel_width)
-		next_tab_x += (it->lnum_pixel_width
-			       - ((it->w->hscroll * font->space_width)
-				  % tab_width));
+	      if (!NILP (Vdisplay_line_numbers) && it->line_number_produced_p)
+		{
+		  next_tab_x += it->lnum_pixel_width;
+		  /* If the line is hscrolled, and the TAB starts before
+		     the first visible pixel, simulate negative row->x.  */
+		  if (x < it->first_visible_x)
+		    {
+		      next_tab_x -= it->first_visible_x - x;
+		      it->tab_offset = it->first_visible_x - x;
+		    }
+		  else
+		    next_tab_x -= it->tab_offset;
+		}
 
 	      it->pixel_width = next_tab_x - x0;
 	      it->nglyphs = 1;
@@ -32971,6 +33041,7 @@ particularly when using variable `x-use-underline-position-properties'
 with fonts that specify an UNDERLINE_POSITION relatively close to the
 baseline.  The default value is 1.  */);
   underline_minimum_offset = 1;
+  DEFSYM (Qunderline_minimum_offset, "underline-minimum-offset");
 
   DEFVAR_BOOL ("display-hourglass", display_hourglass_p,
 	       doc: /* Non-nil means show an hourglass pointer, when Emacs is busy.
diff --git a/src/xfaces.c b/src/xfaces.c
index 1d56e52c68..43bda0a292 100644
--- a/src/xfaces.c
+++ b/src/xfaces.c
@@ -3352,8 +3352,8 @@ DEFUN ("internal-set-lisp-face-attribute-from-resource",
     value = Qunspecified;
   else if (EQ (attr, QCheight))
     {
-      value = Fstring_to_number (value, make_number (10));
-      if (XINT (value) <= 0)
+      value = Fstring_to_number (value, Qnil);
+      if (!INTEGERP (value) || XINT (value) <= 0)
 	signal_error ("Invalid face height from X resource", value);
     }
   else if (EQ (attr, QCbold) || EQ (attr, QCitalic))
diff --git a/src/xterm.c b/src/xterm.c
index a1ea60ec58..91ec742770 100644
--- a/src/xterm.c
+++ b/src/xterm.c
@@ -3397,33 +3397,53 @@ x_draw_glyph_string (struct glyph_string *s)
               else
                 {
 		  struct font *font = font_for_underline_metrics (s);
+		  unsigned long minimum_offset;
+		  bool underline_at_descent_line;
+		  bool use_underline_position_properties;
+		  Lisp_Object val
+		    = buffer_local_value (Qunderline_minimum_offset,
+					  s->w->contents);
+		  if (INTEGERP (val))
+		    minimum_offset = XFASTINT (val);
+		  else
+		    minimum_offset = 1;
+		  val = buffer_local_value (Qx_underline_at_descent_line,
+					    s->w->contents);
+		  underline_at_descent_line
+		    = !(NILP (val) || EQ (val, Qunbound));
+		  val
+		    = buffer_local_value (Qx_use_underline_position_properties,
+					  s->w->contents);
+		  use_underline_position_properties
+		    = !(NILP (val) || EQ (val, Qunbound));
 
                   /* Get the underline thickness.  Default is 1 pixel.  */
                   if (font && font->underline_thickness > 0)
                     thickness = font->underline_thickness;
                   else
                     thickness = 1;
-                  if (x_underline_at_descent_line)
+                  if (underline_at_descent_line)
                     position = (s->height - thickness) - (s->ybase - s->y);
                   else
                     {
-                      /* Get the underline position.  This is the recommended
-                         vertical offset in pixels from the baseline to the top of
-                         the underline.  This is a signed value according to the
+                      /* Get the underline position.  This is the
+                         recommended vertical offset in pixels from
+                         the baseline to the top of the underline.
+                         This is a signed value according to the
                          specs, and its default is
 
                          ROUND ((maximum descent) / 2), with
                          ROUND(x) = floor (x + 0.5)  */
 
-                      if (x_use_underline_position_properties
+                      if (use_underline_position_properties
                           && font && font->underline_position >= 0)
                         position = font->underline_position;
                       else if (font)
                         position = (font->descent + 1) / 2;
                       else
-                        position = underline_minimum_offset;
+                        position = minimum_offset;
                     }
-                  position = max (position, underline_minimum_offset);
+                  position = max (position, minimum_offset);
                 }
               /* Check the sanity of thickness and position.  We should
                  avoid drawing underline out of the current line area.  */
@@ -10766,6 +10786,8 @@ UNDERLINE_POSITION font properties, set this to nil.  You can also use
 `underline-minimum-offset' to override the font's UNDERLINE_POSITION for
 small font display sizes.  */);
   x_use_underline_position_properties = true;
+  DEFSYM (Qx_use_underline_position_properties,
+	  "x-use-underline-position-properties");
 
   DEFVAR_BOOL ("x-underline-at-descent-line",
 	       x_underline_at_descent_line,
@@ -10776,6 +10798,7 @@ A value of nil means to draw the underline according to the value of the
 variable `x-use-underline-position-properties', which is usually at the
 baseline level.  The default value is nil.  */);
   x_underline_at_descent_line = false;
+  DEFSYM (Qx_underline_at_descent_line, "x-underline-at-descent-line");
 
   DEFVAR_BOOL ("x-mouse-click-focus-ignore-position",
 	       x_mouse_click_focus_ignore_position,
diff --git a/test/Makefile.in b/test/Makefile.in
index a9650fdd39..dd9e519c42 100644
--- a/test/Makefile.in
+++ b/test/Makefile.in
@@ -99,14 +99,20 @@ TEST_LOCALE = C
 # If you just want a pass/fail, setting this to no is much faster.
 TEST_LOAD_EL ?= yes
 
+# Additional settings for ert.
+ert_opts =
+
 # Maximum length of lines in ert backtraces; nil for no limit.
 # (if empty, use the default ert-batch-backtrace-right-margin).
 TEST_BACKTRACE_LINE_LENGTH =
 
-ifeq (${TEST_BACKTRACE_LINE_LENGTH},)
-ert_opts =
-else
-ert_opts = --eval '(setq ert-batch-backtrace-right-margin ${TEST_BACKTRACE_LINE_LENGTH})'
+ifneq (${TEST_BACKTRACE_LINE_LENGTH},)
+ert_opts += --eval '(setq ert-batch-backtrace-right-margin ${TEST_BACKTRACE_LINE_LENGTH})'
+endif
+
+# Whether the tests shall also report their duration.
+ifdef TEST_PRINT_TEST_DURATION
+ert_opts += --eval '(setq ert-batch-print-duration t)'
 endif
 
 ifeq (@HAVE_MODULES@, yes)
@@ -152,7 +158,6 @@ endif
 WRITE_LOG = > $@ 2>&1 || { STAT=$$?; cat $@; exit $$STAT; }
 ifdef EMACS_HYDRA_CI
 ## On Hydra, always show logs for certain problematic tests.
-lisp/emacs-lisp/eieio-tests/eieio-tests.log \
 lisp/net/tramp-tests.log \
 : WRITE_LOG = 2>&1 | tee $@
 endif
@@ -300,3 +305,9 @@ distclean: clean
 	rm -f Makefile
 
 maintainer-clean: distclean bootstrap-clean
+
+.PHONY: check-declare
+
+check-declare:
+	$(emacs) -l check-declare \
+	  --eval '(check-declare-directory "$(srcdir)")'
diff --git a/test/README b/test/README
index 1cd9db3bb8..17135a0274 100644
--- a/test/README
+++ b/test/README
@@ -50,6 +50,11 @@ nicer backtraces.  To run the compiled version of a test use
 
     make TEST_LOAD_EL=no ...
 
+Sometimes, it is necessary to trace the duration time for single tests.
+This is controlled by the environment variable TEST_PRINT_TEST_DURATION
+
+    make TEST_PRINT_TEST_DURATION=1 ...
+
 
 (Also, see etc/compilation.txt for compilation mode font lock tests.)
 
diff --git a/test/lisp/dired-tests.el b/test/lisp/dired-tests.el
index 0284b9f0a4..78c09c8e69 100644
--- a/test/lisp/dired-tests.el
+++ b/test/lisp/dired-tests.el
@@ -211,12 +211,12 @@
                          (concat (file-name-as-directory test-dir)
                                  (file-name-as-directory "test-subdir"))))
           (push (dired-find-file) buffers)
-          (let ((pt2 (point)))          ; Point is on test-file.
-            (switch-to-buffer buf)
-            ;; Sanity check: point should now be back on the subdirectory.
-            (should (eq (point) pt1))
-            (push (dired test-dir) buffers)
-            (should (eq (point) pt1))))
+          ;; Point is on test-file.
+          (switch-to-buffer buf)
+          ;; Sanity check: point should now be back on the subdirectory.
+          (should (eq (point) pt1))
+          (push (dired test-dir) buffers)
+          (should (eq (point) pt1)))
       (dolist (buf buffers)
         (when (buffer-live-p buf) (kill-buffer buf)))
       (delete-directory test-dir t))))
@@ -225,7 +225,7 @@
   "Test for https://debbugs.gnu.org/cgi/bugreport.cgi?bug=27243#61 ."
   (let ((test-dir (make-temp-file "test-dir-" t))
         (dired-auto-revert-buffer t)
-        test-subdir1 test-subdir2 allbufs)
+        allbufs)
     (unwind-protect
         (progn
           (with-current-buffer (find-file-noselect test-dir)
@@ -295,9 +295,9 @@
 
 (ert-deftest dired-test-bug27899 ()
   "Test for https://debbugs.gnu.org/27899 ."
-  (let* ((dir (expand-file-name "src" source-directory))
-	 (buf (dired (list dir "cygw32.c" "alloc.c" "w32xfns.c" "xdisp.c")))
-         (orig dired-hide-details-mode))
+  (dired (list (expand-file-name "src" source-directory)
+               "cygw32.c" "alloc.c" "w32xfns.c" "xdisp.c"))
+  (let ((orig dired-hide-details-mode))
     (dired-goto-file (expand-file-name "cygw32.c"))
     (forward-line 0)
     (unwind-protect
@@ -363,8 +363,7 @@
 (defmacro dired-test-with-temp-dirs (just-empty-dirs &rest body)
   "Helper macro for Bug#27940 test."
   (declare (indent 1) (debug body))
-  (let ((dir (make-symbol "dir"))
-        (ignore-funcs (make-symbol "ignore-funcs")))
+  (let ((dir (make-symbol "dir")))
     `(let* ((,dir (make-temp-file "bug27940" t))
             (dired-deletion-confirmer (lambda (_) "yes")) ; Suppress prompts.
             (inhibit-message t)
diff --git a/test/lisp/emacs-lisp/benchmark-tests.el b/test/lisp/emacs-lisp/benchmark-tests.el
index 8de7818bdb..cba53aefc9 100644
--- a/test/lisp/emacs-lisp/benchmark-tests.el
+++ b/test/lisp/emacs-lisp/benchmark-tests.el
@@ -23,9 +23,9 @@
 (require 'ert)
 
 (ert-deftest benchmark-tests ()
-  (let (str t-long t-short)
-    (should (consp (benchmark-run nil (1+ 0))))
-    (should (consp (benchmark-run 1 (1+ 0))))
+  (let (str t-long t-short m)
+    (should (consp (benchmark-run nil (setq m (1+ 0)))))
+    (should (consp (benchmark-run 1 (setq m (1+ 0)))))
     (should (stringp (benchmark nil (1+ 0))))
     (should (stringp (benchmark 1 (1+ 0))))
     (should (consp (benchmark-run-compiled nil (1+ 0))))
@@ -33,10 +33,10 @@
     ;; First test is heavier, must need longer time.
     (should (> (car (benchmark-run nil
                       (let ((n 100000)) (while (> n 1) (setq n (1- n))))))
-               (car (benchmark-run nil (1+ 0)))))
+               (car (benchmark-run nil (setq m (1+ 0))))))
     (should (> (car (benchmark-run nil
                       (let ((n 100000)) (while (> n 1) (setq n (1- n))))))
-               (car (benchmark-run nil (1+ 0)))))
+               (car (benchmark-run nil (setq m (1+ 0))))))
     (should (> (car (benchmark-run-compiled nil
                       (let ((n 100000)) (while (> n 1) (setq n (1- n))))))
                (car (benchmark-run-compiled nil (1+ 0)))))
@@ -46,6 +46,8 @@
     (setq str (benchmark nil '(1+ 0)))
     (string-match "Elapsed time: \\([0-9.]+\\)" str)
     (setq t-short (string-to-number (match-string 1 str)))
-    (should (> t-long t-short))))
+    (should (> t-long t-short))
+    ;; Silence compiler.
+    m))
 
 ;;; benchmark-tests.el ends here.
diff --git a/test/lisp/emacs-lisp/eieio-tests/eieio-tests.el b/test/lisp/emacs-lisp/eieio-tests/eieio-tests.el
index 69dc16443f..5ba094c007 100644
--- a/test/lisp/emacs-lisp/eieio-tests/eieio-tests.el
+++ b/test/lisp/emacs-lisp/eieio-tests/eieio-tests.el
@@ -887,34 +887,15 @@ Subclasses to override slot attributes.")
   (should (= (length (eieio-build-class-alist 'opt-test1 nil)) 2))
   (should (= (length (eieio-build-class-alist 'opt-test1 t)) 1)))
 
-(mapatoms (lambda (a)
-            (when (and (fboundp a)
-                       (string-match "\\`cl--?generic"
-                                     (symbol-name a)))
-              (trace-function-background a))))
-
 (defclass eieio--testing () ())
 
 (defmethod constructor :static ((_x eieio--testing) newname &rest _args)
   (list newname 2))
 
-(defun eieio-test-dump-trace ()
-  (message "%s" (with-current-buffer "*trace-output*"
-                  (goto-char (point-min))
-                  (while (re-search-forward "[\0-\010\013-\037]" nil t)
-                    (insert (prog1 (format "\\%03o" (char-before))
-                              (delete-char -1))))
-                  (buffer-string))))
-(eieio-test-dump-trace)
-
 (ert-deftest eieio-test-37-obsolete-name-in-constructor ()
   ;; FIXME repeated intermittent failures on hydra and elsewhere (bug#24503).
   :tags '(:unstable)
-  (with-current-buffer "*trace-output*"
-    (erase-buffer))
-  (unwind-protect
-      (should (equal (eieio--testing "toto") '("toto" 2)))
-    (eieio-test-dump-trace)))
+  (should (equal (eieio--testing "toto") '("toto" 2))))
 
 (ert-deftest eieio-autoload ()
   "Tests to see whether reftex-auc has been autoloaded"
diff --git a/test/lisp/emacs-lisp/package-tests.el b/test/lisp/emacs-lisp/package-tests.el
index 83f5228488..0059c546ac 100644
--- a/test/lisp/emacs-lisp/package-tests.el
+++ b/test/lisp/emacs-lisp/package-tests.el
@@ -473,8 +473,8 @@ Must called from within a `tar-mode' buffer."
 		       (let ((process-environment
 			      (cons (format "HOME=%s" homedir)
 				    process-environment)))
-			 (epg-check-configuration (epg-configuration))
-			 (epg-find-configuration 'OpenPGP))
+			 (epg-check-configuration
+                          (epg-find-configuration 'OpenPGP)))
 		     (delete-directory homedir t)))))
   (let* ((keyring (expand-file-name "key.pub" package-test-data-dir))
 	 (package-test-data-dir
diff --git a/test/lisp/eshell/em-ls-tests.el b/test/lisp/eshell/em-ls-tests.el
index 1ce832f1dc..c5c9eac324 100644
--- a/test/lisp/eshell/em-ls-tests.el
+++ b/test/lisp/eshell/em-ls-tests.el
@@ -26,6 +26,7 @@
 
 (require 'ert)
 (require 'em-ls)
+(require 'dired)
 
 (ert-deftest em-ls-test-bug27631 ()
   "Test for https://debbugs.gnu.org/27631 ."
diff --git a/test/lisp/hi-lock-tests.el b/test/lisp/hi-lock-tests.el
index 40d76ee9de..4c639b03dc 100644
--- a/test/lisp/hi-lock-tests.el
+++ b/test/lisp/hi-lock-tests.el
@@ -29,7 +29,7 @@
     (with-temp-buffer
       (insert "a A b B\n")
       (cl-letf (((symbol-function 'completing-read)
-                   (lambda (prompt coll x y z hist defaults)
+                   (lambda (_prompt _coll _x _y _z _hist defaults)
                      (car defaults))))
         (dotimes (_ 2)
           (let ((face (hi-lock-read-face-name)))
@@ -41,7 +41,7 @@
     (with-temp-buffer
       (insert "foo bar")
       (cl-letf (((symbol-function 'completing-read)
-                 (lambda (prompt coll x y z hist defaults)
+                 (lambda (_prompt _coll _x _y _z _hist defaults)
                    (car defaults))))
         (hi-lock-set-pattern "9999" (hi-lock-read-face-name)) ; No match
         (hi-lock-set-pattern "foo" (hi-lock-read-face-name)))
diff --git a/test/lisp/international/mule-tests.el b/test/lisp/international/mule-tests.el
index 3c3bae1493..59c9ff5aab 100644
--- a/test/lisp/international/mule-tests.el
+++ b/test/lisp/international/mule-tests.el
@@ -36,4 +36,7 @@
                      (find-auto-coding "" (buffer-size)))
                    '(utf-8 . :coding)))))
 
+;; Stop "Local Variables" above causing confusion when visiting this file.
+
+
 ;;; mule-tests.el ends here
diff --git a/test/lisp/ls-lisp-tests.el b/test/lisp/ls-lisp-tests.el
index d16ffa3acd..91e8b0b701 100644
--- a/test/lisp/ls-lisp-tests.el
+++ b/test/lisp/ls-lisp-tests.el
@@ -26,6 +26,7 @@
 ;;; Code:
 (require 'ert)
 (require 'ls-lisp)
+(require 'dired)
 
 (ert-deftest ls-lisp-unload ()
   "Test for https://debbugs.gnu.org/xxxxx ."
diff --git a/test/lisp/net/tramp-archive-tests.el b/test/lisp/net/tramp-archive-tests.el
index 33916f82da..a3201bdba4 100644
--- a/test/lisp/net/tramp-archive-tests.el
+++ b/test/lisp/net/tramp-archive-tests.el
@@ -809,7 +809,7 @@ This tests also `file-executable-p', `file-writable-p' and `set-file-modes'."
   (skip-unless (tramp-archive--test-emacs27-p))
 
   ;; tramp-archive is neither loaded at Emacs startup, nor when
-  ;; loading a file like "/ssh::" (which loads Tramp).
+  ;; loading a file like "/mock::foo" (which loads Tramp).
   (let ((default-directory (expand-file-name temporary-file-directory))
 	(code
 	 "(progn \
@@ -818,7 +818,7 @@ This tests also `file-executable-p', `file-writable-p' and `set-file-modes'."
 	    (file-attributes %S \"/\") \
 	    (message \"tramp-archive loaded: %%s %%s\" \
               (featurep 'tramp) (featurep 'tramp-archive)))"))
-    (dolist (file `("/ssh::foo" ,(concat tramp-archive-test-archive "foo")))
+    (dolist (file `("/mock::foo" ,(concat tramp-archive-test-archive "foo")))
       (should
        (string-match
 	(format
diff --git a/test/lisp/net/tramp-tests.el b/test/lisp/net/tramp-tests.el
index d11bf46fd6..193d3c9a4b 100644
--- a/test/lisp/net/tramp-tests.el
+++ b/test/lisp/net/tramp-tests.el
@@ -4722,6 +4722,8 @@ process sentinels.  They shall not disturb each other."
 
   ;; This test could be blocked on hydra.  So we set a timeout of 300
   ;; seconds, and we send a SIGUSR1 signal after 300 seconds.
+  ;; This clearly doesn't work though, because the test not
+  ;; infrequently hangs for hours until killed by the infrastructure.
   (with-timeout (300 (tramp--test-timeout-handler))
     (define-key special-event-map [sigusr1] 'tramp--test-timeout-handler)
     (tramp--test-instrument-test-case (if (getenv "EMACS_HYDRA_CI") 10 0)
@@ -4746,6 +4748,7 @@ process sentinels.  They shall not disturb each other."
             (or
              (ignore-errors
                (string-to-number (getenv "REMOTE_PARALLEL_PROCESSES")))
+	     (if (getenv "EMACS_HYDRA_CI") 5)
              10))
            ;; On hydra, timings are bad.
            (timer-repeat
diff --git a/test/lisp/progmodes/bat-mode-tests.el b/test/lisp/progmodes/bat-mode-tests.el
index 4fa8de10c6..5b824841d4 100644
--- a/test/lisp/progmodes/bat-mode-tests.el
+++ b/test/lisp/progmodes/bat-mode-tests.el
@@ -63,10 +63,11 @@
   "Test fontification of iteration variables."
   (should
    (equal
-    (bat-test-fontify "echo %%a\necho %%~dp1\necho %%~$PATH:I")
+    (bat-test-fontify "echo %%a\necho %%~dp1\necho %%~$PATH:I\necho %%~1")
     "<span class=\"builtin\">echo</span> %%<span class=\"variable-name\">a</span>
 <span class=\"builtin\">echo</span> %%~dp<span class=\"variable-name\">1</span>
-<span class=\"builtin\">echo</span> %%~$<span class=\"variable-name\">PATH</span>:<span class=\"variable-name\">I</span>")))
+<span class=\"builtin\">echo</span> %%~$<span class=\"variable-name\">PATH</span>:<span class=\"variable-name\">I</span>
+<span class=\"builtin\">echo</span> %%~<span class=\"variable-name\">1</span>")))
 
 (defun bat-test-fill-paragraph (str)
   "Return the result of invoking `fill-paragraph' on STR in a `bat-mode' buffer."
diff --git a/test/lisp/progmodes/ruby-mode-tests.el b/test/lisp/progmodes/ruby-mode-tests.el
index b16698fba1..72d83affae 100644
--- a/test/lisp/progmodes/ruby-mode-tests.el
+++ b/test/lisp/progmodes/ruby-mode-tests.el
@@ -705,13 +705,15 @@ VALUES-PLIST is a list with alternating index and value elements."
 
 (ert-deftest ruby-forward-sexp-skips-method-calls-with-keyword-names ()
   (ruby-with-temp-buffer ruby-sexp-test-example
-    (goto-line 2)
+    (goto-char (point-min))
+    (forward-line 1)
     (ruby-forward-sexp)
     (should (= 8 (line-number-at-pos)))))
 
 (ert-deftest ruby-backward-sexp-skips-method-calls-with-keyword-names ()
   (ruby-with-temp-buffer ruby-sexp-test-example
-    (goto-line 8)
+    (goto-char (point-min))
+    (forward-line 7)
     (end-of-line)
     (ruby-backward-sexp)
     (should (= 2 (line-number-at-pos)))))
diff --git a/test/lisp/ses-tests.el b/test/lisp/ses-tests.el
index c9966e237f..c773c9b396 100644
--- a/test/lisp/ses-tests.el
+++ b/test/lisp/ses-tests.el
@@ -38,7 +38,7 @@ interactively."
       (dolist (c '((0 0 1) (1 0 (1+ A1))))
         (apply 'ses-cell-set-formula c)
         (apply 'ses-calculate-cell (list (car c) (cadr c) nil)))
-      (should (eq A2 2)))))
+      (should (eq (bound-and-true-p A2) 2)))))
 
 (ert-deftest ses-tests-plain-formula ()
   "Check that setting A1 to 1 and A2 to (1+ A1), makes A2 value
@@ -49,13 +49,16 @@ equal to 2. This is done  using interactive calls."
       (dolist (c '((0 0 1) (1 0 (1+ A1))))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook)
-      (should (eq A2 2)))))
+      (should (eq (bound-and-true-p A2) 2)))))
 
 ;; PLAIN CELL RENAMING TESTS
 ;; ======================================================================
 
+(defvar ses--foo)
+(defvar ses--cells)
+
 (ert-deftest ses-tests-lowlevel-renamed-cell ()
-  "Check that renaming A1 to `foo' and setting `foo' to 1 and A2 to (1+ foo), makes A2 value equal to 2.
+  "Check that renaming A1 to `ses--foo' and setting `ses--foo' to 1 and A2 to (1+ ses--foo), makes A2 value equal to 2.
 This is done using low level functions, `ses-rename-cell' is not
 called but instead we use text replacement in the buffer
 previously passed in text mode."
@@ -69,63 +72,63 @@ previously passed in text mode."
       (text-mode)
       (goto-char (point-min))
       (while (re-search-forward "\\<A1\\>" nil t)
-        (replace-match "foo" t t))
+        (replace-match "ses--foo" t t))
       (ses-mode)
       (should-not  (local-variable-p 'A1))
-      (should (eq foo 1))
-      (should (equal (ses-cell-formula 1 0) '(ses-safe-formula (1+ foo))))
-      (should (eq A2 2)))))
+      (should (eq ses--foo 1))
+      (should (equal (ses-cell-formula 1 0) '(ses-safe-formula (1+ ses--foo))))
+      (should (eq (bound-and-true-p A2) 2)))))
 
 (ert-deftest ses-tests-renamed-cell ()
-  "Check that renaming A1 to `foo' and setting `foo' to 1 and A2
-to (1+ foo), makes A2 value equal to 2."
+  "Check that renaming A1 to `ses--foo' and setting `ses--foo' to 1 and A2
+to (1+ ses--foo), makes A2 value equal to 2."
   (let ((ses-initial-size '(2 . 1)))
     (with-temp-buffer
       (ses-mode)
-      (ses-rename-cell 'foo (ses-get-cell 0 0))
-      (dolist (c '((0 0 1) (1 0 (1+ foo))))
+      (ses-rename-cell 'ses--foo (ses-get-cell 0 0))
+      (dolist (c '((0 0 1) (1 0 (1+ ses--foo))))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook)
       (should-not  (local-variable-p 'A1))
-      (should (eq foo 1))
-      (should (equal (ses-cell-formula 1 0) '(1+ foo)))
-      (should (eq A2 2)))))
+      (should (eq ses--foo 1))
+      (should (equal (ses-cell-formula 1 0) '(1+ ses--foo)))
+      (should (eq (bound-and-true-p A2) 2)))))
 
 (ert-deftest ses-tests-renamed-cell-after-setting ()
   "Check that setting A1 to 1 and A2 to (1+ A1), and then
-renaming A1 to `foo' makes `foo' value equal to 2."
+renaming A1 to `ses--foo' makes `ses--foo' value equal to 2."
   (let ((ses-initial-size '(2 . 1)))
     (with-temp-buffer
       (ses-mode)
       (dolist (c '((0 0 1) (1 0 (1+ A1))))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook); deferred recalc
-      (ses-rename-cell 'foo (ses-get-cell 0 0))
+      (ses-rename-cell 'ses--foo (ses-get-cell 0 0))
       (should-not  (local-variable-p 'A1))
-      (should (eq foo 1))
-      (should (equal (ses-cell-formula 1 0) '(1+ foo)))
-      (should (eq A2 2)))))
+      (should (eq ses--foo 1))
+      (should (equal (ses-cell-formula 1 0) '(1+ ses--foo)))
+      (should (eq (bound-and-true-p A2) 2)))))
 
 (ert-deftest ses-tests-renaming-cell-with-one-symbol-formula ()
   "Check that setting A1 to 1 and A2 to A1, and then renaming A1
-to `foo' makes `foo' value equal to 1. Then set A1 to 2 and check
-that `foo' becomes 2."
+to `ses--foo' makes `ses--foo' value equal to 1. Then set A1 to 2 and check
+that `ses--foo' becomes 2."
   (let ((ses-initial-size '(3 . 1)))
     (with-temp-buffer
       (ses-mode)
       (dolist (c '((0 0 1) (1 0 A1)))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook); deferred recalc
-      (ses-rename-cell 'foo (ses-get-cell 0 0))
+      (ses-rename-cell 'ses--foo (ses-get-cell 0 0))
       (ses-command-hook); deferred recalc
       (should-not  (local-variable-p 'A1))
-      (should (eq foo 1))
-      (should (equal (ses-cell-formula 1 0) 'foo))
-      (should (eq A2 1))
+      (should (eq ses--foo 1))
+      (should (equal (ses-cell-formula 1 0) 'ses--foo))
+      (should (eq (bound-and-true-p A2) 1))
       (funcall-interactively 'ses-edit-cell 0 0 2)
       (ses-command-hook); deferred recalc
-      (should (eq A2 2))
-      (should (eq foo 2)))))
+      (should (eq (bound-and-true-p A2) 2))
+      (should (eq ses--foo 2)))))
 
 
 ;; ROW INSERTION TESTS
@@ -144,32 +147,31 @@ to A2 and inserting a row, makes A2 value empty, and A3 equal to
       (ses-jump 'A2)
       (ses-insert-row 1)
       (ses-command-hook)
-      (should-not A2)
-      (should (eq A3 2)))))
+      (should-not (bound-and-true-p A2))
+      (should (eq (bound-and-true-p A3) 2)))))
 
-; (defvar ses-tests-trigger nil)
+(defvar ses--bar)
 
 (ert-deftest ses-tests-renamed-cells-row-insertion ()
-  "Check that setting A1 to 1 and A2 to (1+ A1), and then renaming A1 to `foo' and A2 to `bar' jumping
-to `bar' and inserting a row, makes A2 value empty, and `bar' equal to
+  "Check that setting A1 to 1 and A2 to (1+ A1), and then renaming A1 to `ses--foo' and A2 to `ses--bar' jumping
+to `ses--bar' and inserting a row, makes A2 value empty, and `ses--bar' equal to
 2."
-  (setq ses-tests-trigger nil)
   (let ((ses-initial-size '(2 . 1)))
     (with-temp-buffer
       (ses-mode)
       (dolist (c '((0 0 1) (1 0 (1+ A1))))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook)
-      (ses-rename-cell 'foo (ses-get-cell 0 0))
+      (ses-rename-cell 'ses--foo (ses-get-cell 0 0))
       (ses-command-hook)
-      (ses-rename-cell 'bar (ses-get-cell 1 0))
+      (ses-rename-cell 'ses--bar (ses-get-cell 1 0))
       (ses-command-hook)
-      (should (eq bar 2))
-      (ses-jump 'bar)
+      (should (eq ses--bar 2))
+      (ses-jump 'ses--bar)
       (ses-insert-row 1)
       (ses-command-hook)
-      (should-not A2)
-      (should (eq bar 2)))))
+      (should-not (bound-and-true-p A2))
+      (should (eq ses--bar 2)))))
 
 
 (provide 'ses-tests)
diff --git a/test/lisp/simple-tests.el b/test/lisp/simple-tests.el
index 91fdd5e816..64b341bd46 100644
--- a/test/lisp/simple-tests.el
+++ b/test/lisp/simple-tests.el
@@ -489,13 +489,12 @@ See Bug#21722."
       (should (equal pos (point))))))
 
 (ert-deftest line-number-at-pos-when-passing-point ()
-  (let (pos)
-    (with-temp-buffer
-      (insert "a\nb\nc\nd\n")
-      (should (equal (line-number-at-pos 1) 1))
-      (should (equal (line-number-at-pos 3) 2))
-      (should (equal (line-number-at-pos 5) 3))
-      (should (equal (line-number-at-pos 7) 4)))))
+  (with-temp-buffer
+    (insert "a\nb\nc\nd\n")
+    (should (equal (line-number-at-pos 1) 1))
+    (should (equal (line-number-at-pos 3) 2))
+    (should (equal (line-number-at-pos 5) 3))
+    (should (equal (line-number-at-pos 7) 4))))
 
 
 ;;; Auto fill.
diff --git a/test/lisp/term-tests.el b/test/lisp/term-tests.el
index 234dfa1f0d..8aaa61a210 100644
--- a/test/lisp/term-tests.el
+++ b/test/lisp/term-tests.el
@@ -124,6 +124,18 @@ line6\r
                     40 12 (list "\eAnSiTc /f" "oo/\n") 'default-directory)
                    "/foo/"))))
 
+(ert-deftest term-line-wrapping-then-motion ()
+  "Make sure we reset the line-wrapping state after moving cursor.
+A real-life example is the default zsh prompt which writes spaces
+to the end of line (triggering line-wrapping state), and then
+sends a carriage return followed by another space to overwrite
+the first character of the line."
+  (let* ((width 10)
+         (strs (list "x" (make-string (1- width) ?_)
+                     "\r_")))
+    (should (equal (term-test-screen-from-input width 12 strs)
+                   (make-string width ?_)))))
+
 (provide 'term-tests)
 
 ;;; term-tests.el ends here
diff --git a/test/lisp/vc/diff-mode-tests.el b/test/lisp/vc/diff-mode-tests.el
index 1e35f9f7cd..7900e41b25 100644
--- a/test/lisp/vc/diff-mode-tests.el
+++ b/test/lisp/vc/diff-mode-tests.el
@@ -182,7 +182,7 @@ youthfulness
             (with-temp-buffer
               (cd temp-dir)
               (insert patch)
-              (beginning-of-buffer)
+              (goto-char (point-min))
               (diff-apply-hunk)
               (diff-apply-hunk)
               (diff-apply-hunk))
diff --git a/test/lisp/vc/vc-tests.el b/test/lisp/vc/vc-tests.el
index c48fd448b4..ffab0ff456 100644
--- a/test/lisp/vc/vc-tests.el
+++ b/test/lisp/vc/vc-tests.el
@@ -109,7 +109,7 @@
 (require 'ert)
 (require 'vc)
 
-(declare-function w32-application-type "w32proc")
+(declare-function w32-application-type "w32proc.c")
 
 ;; The working horses.
 
diff --git a/test/src/eval-tests.el b/test/src/eval-tests.el
index fd12184995..50051dfd23 100644
--- a/test/src/eval-tests.el
+++ b/test/src/eval-tests.el
@@ -64,4 +64,24 @@ crash/abort/malloc assert failure on the next test."
         (signal-hook-function #'ignore))
     (should-error (eval-tests--exceed-specbind-limit))))
 
+(defun eval-tests--exceed-specbind-limit ()
+  (defvar eval-tests--var1)
+  (defvar eval-tests--var2)
+  ;; Bind two variables, to make extra sure we hit the
+  ;; `max-specpdl-size' limit before the `max-lisp-eval-depth' limit.
+  (let ((eval-tests--var1 1)
+        (eval-tests--var2 2))
+    ;; Recurse until we hit the limit.
+    (eval-tests--exceed-specbind-limit)))
+
+(ert-deftest eval-exceed-specbind-with-signal-hook ()
+  "Test for Bug#30481.
+Check that Emacs doesn't crash when exceeding specbind limit with
+`signal-hook-function' bound.  NOTE: Without the fix for
+Bug#30481, this test can appear to pass, but cause a
+crash/abort/malloc assert failure on the next test."
+  (let ((max-specpdl-size (/ max-lisp-eval-depth 2))
+        (signal-hook-function #'ignore))
+    (should-error (eval-tests--exceed-specbind-limit))))
+
 ;;; eval-tests.el ends here
diff --git a/test/src/json-tests.el b/test/src/json-tests.el
index 3bbf9eb96b..09067bad8c 100644
--- a/test/src/json-tests.el
+++ b/test/src/json-tests.el
@@ -26,6 +26,11 @@
 (require 'cl-lib)
 (require 'map)
 
+(declare-function json-serialize "json.c" (object))
+(declare-function json-insert "json.c" (object))
+(declare-function json-parse-string "json.c" (string &rest args))
+(declare-function json-parse-buffer "json.c" (&rest args))
+
 (define-error 'json-tests--error "JSON test error")
 
 (ert-deftest json-serialize/roundtrip ()
-- 
2.21.0


From 8f73c663408b89e925737d9086c62c5d510a5972 Mon Sep 17 00:00:00 2001
From: Johannes Altmanninger <aclopte@gmail.com>
Date: Mon, 7 Jan 2019 18:18:16 +0100
Subject: [PATCH 004/297] Add dependency to remacs-bindings sources for
 generated-bindings (#1217)

This ensures that the generated bindings are updated whenever a symbol
is blacklisted, for example.
---
 src/Makefile.in | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/Makefile.in b/src/Makefile.in
index d1502a03d7..0e345c4f3f 100644
--- a/src/Makefile.in
+++ b/src/Makefile.in
@@ -617,7 +617,9 @@ GLOBALS_FILE=$(rust_srcdir)/generated/globals.rs
 # built. That creates a circular dependency which we can break by not
 # depending on it as this is not a file that changes under normal
 # operation.
-$(DEFINITIONS_FILE) $(BINDINGS_FILE) $(GLOBALS_FILE): $(filter-out ./macuvs.h,$(HEADERS)) $(rust_srcdir)/wrapper.h
+$(DEFINITIONS_FILE) $(BINDINGS_FILE) $(GLOBALS_FILE): $(filter-out ./macuvs.h,$(HEADERS)) $(rust_srcdir)/wrapper.h \
+							$(rust_srcdir)/remacs-bindings/Cargo.toml \
+							$(rust_srcdir)/remacs-bindings/src/main.rs
 	$(MKDIR_P) $(dir $@)
 	RUSTFLAGS="$(RUSTFLAGS)" \
 	EMACS_CFLAGS="$(EMACS_CFLAGS)" \
-- 
2.21.0


From 9ecf2b9a5a772695827dd7434e8937688c4cf03a Mon Sep 17 00:00:00 2001
From: Johannes Altmanninger <aclopte@gmail.com>
Date: Mon, 7 Jan 2019 18:19:49 +0100
Subject: [PATCH 005/297] Port mapc (#1216)

Fixes #916
---
 rust_src/remacs-bindings/src/main.rs |  1 +
 rust_src/src/fns.rs                  | 22 +++++++++++++++++++---
 src/fns.c                            | 17 -----------------
 3 files changed, 20 insertions(+), 20 deletions(-)

diff --git a/rust_src/remacs-bindings/src/main.rs b/rust_src/remacs-bindings/src/main.rs
index d7a00db763..de10148e84 100644
--- a/rust_src/remacs-bindings/src/main.rs
+++ b/rust_src/remacs-bindings/src/main.rs
@@ -247,6 +247,7 @@ fn run_bindgen(path: &str) {
                 .blacklist_item("USE_LSB_TAG")
                 .blacklist_item("VALMASK")
                 .blacklist_item("PSEUDOVECTOR_FLAG")
+                .blacklist_item("Fmapc")
                 // these two are found by bindgen on mac, but not linux
                 .blacklist_item("EMACS_INT_MAX")
                 .blacklist_item("VAL_MAX")
diff --git a/rust_src/src/fns.rs b/rust_src/src/fns.rs
index abb4d632ca..5aa84c1854 100644
--- a/rust_src/src/fns.rs
+++ b/rust_src/src/fns.rs
@@ -1,5 +1,7 @@
 //* Random utility Lisp functions.
 
+use std::ptr;
+
 use libc;
 
 use remacs_macros::lisp_fn;
@@ -8,18 +10,19 @@ use crate::{
     eval::{un_autoload, unbind_to},
     lisp::defsubr,
     lisp::LispObject,
-    lists::{assq, car, get, member, memq, put},
+    lists::{assq, car, get, mapcar1, member, memq, put},
     lists::{LispCons, LispConsCircularChecks, LispConsEndChecks},
     numbers::LispNumber,
     obarray::loadhist_attach,
     objects::equal,
+    remacs_sys::Fload,
     remacs_sys::Vautoload_queue,
     remacs_sys::{concat as lisp_concat, globals, record_unwind_protect},
-    remacs_sys::{equal_kind, Lisp_Type},
-    remacs_sys::{Fload, Fmapc},
+    remacs_sys::{equal_kind, EmacsInt, Lisp_Type},
     remacs_sys::{Qfuncall, Qlistp, Qnil, Qprovide, Qquote, Qrequire, Qsubfeatures, Qt},
     symbols::LispSymbolRef,
     threads::c_specpdl_index,
+    vectors::length,
 };
 
 /// Return t if FEATURE is present in this Emacs.
@@ -90,6 +93,19 @@ pub fn quote(args: LispCons) -> LispObject {
     args.car()
 }
 
+/// Apply FUNCTION to each element of SEQUENCE, and make a list of the
+/// results.  The result is a list just as long as SEQUENCE.  SEQUENCE
+/// may be a list, a vector, a bool-vector, or a string.
+#[lisp_fn]
+pub fn mapc(function: LispObject, sequence: LispObject) -> LispObject {
+    let leni = length(sequence) as EmacsInt;
+    if sequence.is_char_table() {
+        wrong_type!(Qlistp, sequence);
+    }
+    mapcar1(leni, ptr::null_mut(), function, sequence);
+    sequence
+}
+
 /* List of features currently being require'd, innermost first.  */
 
 declare_GC_protected_static!(require_nesting_list, Qnil);
diff --git a/src/fns.c b/src/fns.c
index 9b73929e72..b9854768a2 100644
--- a/src/fns.c
+++ b/src/fns.c
@@ -1543,22 +1543,6 @@ SEQUENCE may be a list, a vector, a bool-vector, or a string.  */)
   return ret;
 }
 
-DEFUN ("mapc", Fmapc, Smapc, 2, 2, 0,
-       doc: /* Apply FUNCTION to each element of SEQUENCE for side effects only.
-Unlike `mapcar', don't accumulate the results.  Return SEQUENCE.
-SEQUENCE may be a list, a vector, a bool-vector, or a string.  */)
-  (Lisp_Object function, Lisp_Object sequence)
-{
-  register EMACS_INT leni;
-
-  leni = XFASTINT (Flength (sequence));
-  if (CHAR_TABLE_P (sequence))
-    wrong_type_argument (Qlistp, sequence);
-  mapcar1 (leni, 0, function, sequence);
-
-  return sequence;
-}
-
 DEFUN ("mapcan", Fmapcan, Smapcan, 2, 2, 0,
        doc: /* Apply FUNCTION to each element of SEQUENCE, and concatenate
 the results by altering them (using `nconc').
@@ -3175,7 +3159,6 @@ this variable.  */);
   defsubr (&Sfillarray);
   defsubr (&Snconc);
   defsubr (&Smapcar);
-  defsubr (&Smapc);
   defsubr (&Smapcan);
   defsubr (&Smapconcat);
   defsubr (&Syes_or_no_p);
-- 
2.21.0


From 57d07282029316af2006f877745559877147ba62 Mon Sep 17 00:00:00 2001
From: Roey Darwish Dror <roey.ghost@gmail.com>
Date: Mon, 7 Jan 2019 19:22:02 +0200
Subject: [PATCH 006/297] Port clear-face-cache (fix #1164) (#1204)

face_change is blacklisted from the Rust bindgen due to name
shadowing, so I added set_face_change in order to access it from Rust.
---
 rust_src/src/lib.rs    |  1 +
 rust_src/src/xfaces.rs | 21 +++++++++++++++++++++
 src/dispextern.h       |  2 ++
 src/xfaces.c           | 17 +++++------------
 4 files changed, 29 insertions(+), 12 deletions(-)
 create mode 100644 rust_src/src/xfaces.rs

diff --git a/rust_src/src/lib.rs b/rust_src/src/lib.rs
index cd527b8daa..f4f3d80ae4 100644
--- a/rust_src/src/lib.rs
+++ b/rust_src/src/lib.rs
@@ -122,6 +122,7 @@ mod util;
 mod vectors;
 mod window_configuration;
 mod windows;
+mod xfaces;
 mod xml;
 
 #[cfg(all(not(test), target_os = "macos", feature = "unexecmacosx"))]
diff --git a/rust_src/src/xfaces.rs b/rust_src/src/xfaces.rs
new file mode 100644
index 0000000000..fa9365f1c4
--- /dev/null
+++ b/rust_src/src/xfaces.rs
@@ -0,0 +1,21 @@
+//! "Face" primitives.
+
+use remacs_macros::lisp_fn;
+
+use crate::{
+    lisp::defsubr,
+    remacs_sys::{clear_face_cache, set_face_change, windows_or_buffers_changed},
+};
+
+/// Clear face caches on all frames.
+/// Optional THOROUGHLY non-nil means try to free unused fonts, too.
+#[lisp_fn(min = "0", name = "clear-face-cache", c_name = "clear_face_cache")]
+pub fn clear_face_cache_lisp(thoroughly: bool) {
+    unsafe {
+        clear_face_cache(thoroughly);
+        set_face_change(true);
+        windows_or_buffers_changed = 53;
+    }
+}
+
+include!(concat!(env!("OUT_DIR"), "/xfaces_exports.rs"));
diff --git a/src/dispextern.h b/src/dispextern.h
index 15e56c910e..e26947554d 100644
--- a/src/dispextern.h
+++ b/src/dispextern.h
@@ -1812,6 +1812,8 @@ GLYPH_CODE_P (Lisp_Object gc)
 
 extern bool face_change;
 
+void set_face_change(bool value);
+
 /* For reordering of bidirectional text.  */
 
 /* UAX#9's max_depth value.  */
diff --git a/src/xfaces.c b/src/xfaces.c
index 43bda0a292..9b527bddc4 100644
--- a/src/xfaces.c
+++ b/src/xfaces.c
@@ -356,6 +356,11 @@ static struct face *realize_non_ascii_face (struct frame *, Lisp_Object,
 			      Utilities
  ***********************************************************************/
 
+void set_face_change(bool value)
+{
+    face_change = value;
+}
+
 #ifdef HAVE_X_WINDOWS
 
 #ifdef DEBUG_X_COLORS
@@ -646,17 +651,6 @@ clear_face_cache (bool clear_fonts_p)
 #endif /* HAVE_WINDOW_SYSTEM */
 }
 
-DEFUN ("clear-face-cache", Fclear_face_cache, Sclear_face_cache, 0, 1, 0,
-       doc: /* Clear face caches on all frames.
-Optional THOROUGHLY non-nil means try to free unused fonts, too.  */)
-  (Lisp_Object thoroughly)
-{
-  clear_face_cache (!NILP (thoroughly));
-  face_change = true;
-  windows_or_buffers_changed = 53;
-  return Qnil;
-}
-
 
 /***********************************************************************
 			      X Pixmaps
@@ -6303,7 +6297,6 @@ syms_of_xfaces (void)
   defsubr (&Sdump_face);
   defsubr (&Sshow_face_resources);
 #endif /* GLYPH_DEBUG */
-  defsubr (&Sclear_face_cache);
   defsubr (&Stty_suppress_bold_inverse_default_colors);
 
 #if defined DEBUG_X_COLORS && defined HAVE_X_WINDOWS
-- 
2.21.0


From 68f4f713af908dc6d4efd128456c5871b88f38c9 Mon Sep 17 00:00:00 2001
From: Nick Drozd <nicholasdrozd@gmail.com>
Date: Mon, 7 Jan 2019 22:42:05 -0600
Subject: [PATCH 007/297] Add tuple conversions, cut as_tuple and
 as_cons_or_error (#1215)

This change complements 6f4ac71065. I wanted to make it possible to
destructure arbitrary conses, as in

  let (a, (b, c)) = obj.into();

but I don't think that's possible. A little destructuring is possible
though, and this replaces `as_tuple` with it. `as_cons_or_error` is
also cut along the way, in favor of `from`/`into`. Most instances of
`as_cons` are also cut.

A few style changes have also been made wrt destructuring, like

  -        self.valcell.as_cons_or_error().cdr()
  +        let (_, d) = self.valcell.into();
  +        d

I think this is a little more in keeping with the Rust mindset of
exhaustive matching -- the caller explicitly acknowledges that there
is another value in the cons cell, and that that value is being thrown
away.
---
 rust_src/src/buffers.rs    |  3 +-
 rust_src/src/casefiddle.rs |  2 +-
 rust_src/src/crypto/mod.rs |  6 ++-
 rust_src/src/data.rs       |  9 ++--
 rust_src/src/eval.rs       | 89 ++++++++++++++++++--------------------
 rust_src/src/ffi.rs        |  2 +-
 rust_src/src/fns.rs        |  4 +-
 rust_src/src/fonts.rs      |  4 +-
 rust_src/src/keymap.rs     | 48 +++++++++-----------
 rust_src/src/lisp.rs       | 13 +++---
 rust_src/src/lists.rs      | 72 ++++++++++++++++++++----------
 rust_src/src/minibuf.rs    |  4 +-
 rust_src/src/process.rs    | 11 ++---
 rust_src/src/time.rs       | 22 +++++-----
 rust_src/src/windows.rs    |  8 ++--
 15 files changed, 157 insertions(+), 140 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index df4a4e7e5e..641422b743 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -557,7 +557,8 @@ impl LispBufferLocalValueRef {
     }
 
     pub fn get_value(self) -> LispObject {
-        self.valcell.as_cons_or_error().cdr()
+        let (_, d) = self.valcell.into();
+        d
     }
 }
 
diff --git a/rust_src/src/casefiddle.rs b/rust_src/src/casefiddle.rs
index c6e099d7af..f374f4cb82 100644
--- a/rust_src/src/casefiddle.rs
+++ b/rust_src/src/casefiddle.rs
@@ -189,7 +189,7 @@ fn casefiddle_region(
         );
 
         for elt in bounds.iter_cars(LispConsEndChecks::off, LispConsCircularChecks::off) {
-            let (car, cdr) = elt.as_cons_or_error().as_tuple();
+            let (car, cdr) = elt.into();
             unsafe { casify_region(action, car, cdr) };
         }
     }
diff --git a/rust_src/src/crypto/mod.rs b/rust_src/src/crypto/mod.rs
index 234842db65..3897fc8bbe 100755
--- a/rust_src/src/crypto/mod.rs
+++ b/rust_src/src/crypto/mod.rs
@@ -123,8 +123,10 @@ fn get_coding_system_for_buffer(
         // Check file-coding-system-alist.
         let mut args = [Qwrite_region, start, end, file_name];
         let val = unsafe { Ffind_operation_coding_system(4, args.as_mut_ptr()) };
-        if val.is_cons() && val.as_cons_or_error().cdr().is_not_nil() {
-            return val.as_cons_or_error().cdr();
+        if let Some((_, d)) = val.into() {
+            if d.is_not_nil() {
+                return d;
+            }
         }
     }
     if buffer.buffer_file_coding_system_.is_not_nil() {
diff --git a/rust_src/src/data.rs b/rust_src/src/data.rs
index 05175db120..04afcb8a7a 100644
--- a/rust_src/src/data.rs
+++ b/rust_src/src/data.rs
@@ -371,7 +371,8 @@ fn default_value(mut symbol: LispSymbolRef) -> LispObject {
             if !fwd.is_null() && blv.valcell.eq(blv.defcell) {
                 unsafe { do_symval_forwarding(fwd) }
             } else {
-                blv.defcell.as_cons_or_error().cdr()
+                let (_, d) = blv.defcell.into();
+                d
             }
         }
         symbol_redirect::SYMBOL_FORWARDED => {
@@ -573,8 +574,7 @@ pub unsafe extern "C" fn store_symval_forwarding(
                     }
                 } else {
                     prop = Fget(predicate, Qrange);
-                    if prop.is_cons() {
-                        let (min, max) = prop.as_cons_or_error().as_tuple();
+                    if let Some((min, max)) = prop.into() {
                         let args = [min, newval, max];
                         if !newval.is_number() || leq(&args) {
                             wrong_range(min, max, newval);
@@ -800,7 +800,8 @@ pub fn fset(mut symbol: LispSymbolRef, definition: LispObject) -> LispObject {
     }
 
     if is_autoload(function) {
-        put(symbol, Qautoload, function.as_cons_or_error().cdr());
+        let (_, d) = function.into();
+        put(symbol, Qautoload, d);
     }
 
     // Convert to eassert or remove after GC bug is found.  In the
diff --git a/rust_src/src/eval.rs b/rust_src/src/eval.rs
index 5335270e1c..326f884571 100644
--- a/rust_src/src/eval.rs
+++ b/rust_src/src/eval.rs
@@ -79,15 +79,15 @@ where
 /// If COND yields nil, and there are no ELSE's, the value is nil.
 /// usage: (if COND THEN ELSE...)
 #[lisp_fn(name = "if", c_name = "if", min = "2", unevalled = "true")]
-pub fn lisp_if(args: LispObject) -> LispObject {
-    let cell = args.as_cons_or_error();
-    let cond = unsafe { eval_sub(cell.car()) };
-    let cnsq = cell.cdr().as_cons_or_error();
+pub fn lisp_if(args: LispCons) -> LispObject {
+    let (cond, consq) = args.into();
+    let (then, else_) = consq.into();
+    let result = unsafe { eval_sub(cond) };
 
-    if cond.is_not_nil() {
-        unsafe { eval_sub(cnsq.car()) }
+    if result.is_not_nil() {
+        unsafe { eval_sub(then) }
     } else {
-        progn(cnsq.cdr())
+        progn(else_)
     }
 }
 
@@ -105,7 +105,7 @@ pub fn cond(args: LispObject) -> LispObject {
     let mut val = Qnil;
 
     for clause in args.iter_cars(LispConsEndChecks::off, LispConsCircularChecks::off) {
-        let (head, tail) = clause.as_cons_or_error().as_tuple();
+        let (head, tail) = clause.into();
         val = unsafe { eval_sub(head) };
         if val != Qnil {
             if tail.is_not_nil() {
@@ -140,7 +140,7 @@ pub extern "C" fn prog_ignore(body: LispObject) {
 /// usage: (prog1 FIRST BODY...)
 #[lisp_fn(min = "1", unevalled = "true")]
 pub fn prog1(args: LispCons) -> LispObject {
-    let (first, body) = args.as_tuple();
+    let (first, body) = args.into();
 
     let val = unsafe { eval_sub(first) };
     progn(body);
@@ -153,10 +153,10 @@ pub fn prog1(args: LispCons) -> LispObject {
 /// usage: (prog2 FORM1 FORM2 BODY...)
 #[lisp_fn(min = "2", unevalled = "true")]
 pub fn prog2(args: LispCons) -> LispObject {
-    let (form1, tail) = args.as_tuple();
+    let (form1, tail) = args.into();
 
     unsafe { eval_sub(form1) };
-    prog1(tail.as_cons_or_error())
+    prog1(tail.into())
 }
 
 /// Set each SYM to the value of its VAL.
@@ -208,17 +208,15 @@ def_lisp_sym!(Qsetq, "setq");
 /// `quote' cannot do that.
 /// usage: (function ARG)
 #[lisp_fn(min = "1", unevalled = "true")]
-pub fn function(args: LispObject) -> LispObject {
-    let cell = args.as_cons_or_error();
-    let (quoted, tail) = cell.as_tuple();
+pub fn function(args: LispCons) -> LispObject {
+    let (quoted, tail) = args.into();
 
     if tail.is_not_nil() {
-        wrong_number_of_arguments!(Qfunction, length(args));
+        wrong_number_of_arguments!(Qfunction, length(args.into()));
     }
 
     if unsafe { globals.Vinternal_interpreter_environment != Qnil } {
-        if let Some(cell) = quoted.as_cons() {
-            let (first, mut cdr) = cell.as_tuple();
+        if let Some((first, mut cdr)) = quoted.into() {
             if first.eq(Qlambda) {
                 // This is a lambda expression within a lexical environment;
                 // return an interpreted closure instead of a simple lambda.
@@ -228,15 +226,16 @@ pub fn function(args: LispObject) -> LispObject {
                     .and_then(|c| c.cdr().as_cons())
                     .and_then(|c| c.car().as_cons());
                 if let Some(cell) = tmp {
-                    let (typ, tail) = cell.as_tuple();
+                    let (typ, tail) = cell.into();
                     if typ.eq(QCdocumentation) {
                         // Handle the special (:documentation <form>) to build the docstring
                         // dynamically.
 
                         let docstring = unsafe { eval_sub(car(tail)) };
                         docstring.as_string_or_error();
-                        let (a, b) = cdr.as_cons().unwrap().as_tuple();
-                        cdr = (a, (docstring, b.as_cons().unwrap().cdr())).into();
+                        let (a, b) = cdr.into();
+                        let (_, bd) = b.into();
+                        cdr = (a, (docstring, bd)).into();
                     }
                 }
 
@@ -285,7 +284,7 @@ pub fn special_variable_p(symbol: LispSymbolRef) -> bool {
 /// usage: (defconst SYMBOL INITVALUE [DOCSTRING])
 #[lisp_fn(min = "2", unevalled = "true")]
 pub fn defconst(args: LispCons) -> LispSymbolRef {
-    let (sym, tail) = args.as_tuple();
+    let (sym, tail) = args.into();
 
     let mut docstring = if cdr(tail).is_not_nil() {
         if cdr(cdr(tail)).is_not_nil() {
@@ -328,11 +327,11 @@ fn let_binding_value(obj: LispObject) -> (LispObject, LispObject) {
     if obj.is_symbol() {
         (obj, Qnil)
     } else {
-        let (front, tail) = obj.as_cons_or_error().as_tuple();
+        let (front, tail) = obj.into();
         let (to_eval, tail) = if tail.is_nil() {
             (Qnil, tail)
         } else {
-            tail.as_cons_or_error().as_tuple()
+            tail.into()
         };
 
         if tail.is_nil() {
@@ -352,7 +351,7 @@ fn let_binding_value(obj: LispObject) -> (LispObject, LispObject) {
 #[lisp_fn(name = "let*", min = "1", unevalled = "true")]
 pub fn letX(args: LispCons) -> LispObject {
     let count = c_specpdl_index();
-    let (varlist, body) = args.as_tuple();
+    let (varlist, body) = args.into();
 
     let lexenv = unsafe { globals.Vinternal_interpreter_environment };
 
@@ -413,7 +412,7 @@ pub fn letX(args: LispCons) -> LispObject {
 #[lisp_fn(name = "let", c_name = "let", min = "1", unevalled = "true")]
 pub fn lisp_let(args: LispCons) -> LispObject {
     let count = c_specpdl_index();
-    let (varlist, body) = args.as_tuple();
+    let (varlist, body) = args.into();
 
     varlist.check_list();
 
@@ -465,7 +464,7 @@ pub fn lisp_let(args: LispCons) -> LispObject {
 /// usage: (while TEST BODY...)
 #[lisp_fn(name = "while", c_name = "while", min = "1", unevalled = "true")]
 pub fn lisp_while(args: LispCons) {
-    let (test, body) = args.as_tuple();
+    let (test, body) = args.into();
 
     while unsafe { eval_sub(test) } != Qnil {
         unsafe { maybe_quit() };
@@ -483,12 +482,11 @@ pub fn lisp_while(args: LispCons) {
 /// definitions to shadow the loaded ones for use in file byte-compilation.
 #[lisp_fn(min = "1")]
 pub fn macroexpand(mut form: LispObject, environment: LispObject) -> LispObject {
-    while let Some(form_cell) = form.as_cons() {
+    while let Some((mut sym, body)) = form.into() {
         // Come back here each time we expand a macro call,
         // in case it expands into another macro call.
 
         // Set SYM, give DEF and TEM right values in case SYM is not a symbol.
-        let (mut sym, body) = form_cell.as_tuple();
         let mut def = sym;
         let mut tem = Qnil;
 
@@ -513,13 +511,12 @@ pub fn macroexpand(mut form: LispObject, environment: LispObject) -> LispObject
             // SYM is not mentioned in ENVIRONMENT.
             // Look at its function definition.
             def = autoload_do_load(def, sym, Qmacro);
-            match def.as_cons() {
-                Some(cell) => {
-                    let func = cell.car();
+            match def.into() {
+                Some((func, cdr)) => {
                     if !func.eq(Qmacro) {
                         break;
                     }
-                    cell.cdr()
+                    cdr
                 }
                 None => {
                     // Not defined or definition not suitable.
@@ -527,7 +524,7 @@ pub fn macroexpand(mut form: LispObject, environment: LispObject) -> LispObject
                 }
             }
         } else {
-            let next = tem.as_cons_or_error().cdr();
+            let (_, next) = tem.into();
             if next.is_nil() {
                 break;
             }
@@ -636,17 +633,16 @@ pub fn commandp(function: LispObject, for_call_interactively: bool) -> bool {
         return (vl.is_pseudovector(pvec_type::PVEC_COMPILED)
             && vl.pseudovector_size() > EmacsInt::from(Lisp_Compiled::COMPILED_INTERACTIVE))
             || has_interactive_prop;
-    } else if let Some(cell) = fun.as_cons() {
+    } else if let Some((funcar, d)) = fun.into() {
         // Lists may represent commands.
-        let funcar = cell.car();
         if funcar.eq(Qclosure) {
-            let bound = assq(Qinteractive, cdr(cdr(cell.cdr())));
+            let bound = assq(Qinteractive, cdr(cdr(d)));
             return bound.is_not_nil() || has_interactive_prop;
         } else if funcar.eq(Qlambda) {
-            let bound = assq(Qinteractive, cdr(cell.cdr()));
+            let bound = assq(Qinteractive, cdr(d));
             return bound.is_not_nil() || has_interactive_prop;
         } else if funcar.eq(Qautoload) {
-            let value = car(cdr(cdr(cell.cdr())));
+            let value = car(cdr(cdr(d)));
             return value.is_not_nil() || has_interactive_prop;
         }
     }
@@ -724,9 +720,9 @@ pub extern "C" fn FUNCTIONP(object: LispObject) -> bool {
                         }
                     }
 
-                    return match it.rest().as_cons() {
+                    return match it.rest().into() {
                         None => true,
-                        Some(c) => c.car().is_nil(),
+                        Some((a, _)) => a.is_nil(),
                     };
                 }
             }
@@ -737,8 +733,7 @@ pub extern "C" fn FUNCTIONP(object: LispObject) -> bool {
         !subr.is_unevalled()
     } else if obj.is_byte_code_function() || obj.is_module_function() {
         true
-    } else if let Some(cons) = obj.as_cons() {
-        let car = cons.car();
+    } else if let Some((car, _)) = obj.into() {
         car.eq(Qlambda) || car.eq(Qclosure)
     } else {
         false
@@ -752,7 +747,7 @@ pub unsafe extern "C" fn un_autoload(oldqueue: LispObject) {
     Vautoload_queue = oldqueue;
 
     for first in queue.iter_cars(LispConsEndChecks::off, LispConsCircularChecks::off) {
-        let (first, second) = first.as_cons_or_error().as_tuple();
+        let (first, second) = first.into();
 
         if first.eq(0) {
             globals.Vfeatures = second;
@@ -1057,9 +1052,7 @@ fn resolve_fun(fun: LispObject) -> Result<LispFun, LispFunError> {
             return Ok(LispFun::LambdaFun(fun));
         }
 
-        if let Some(cons) = fun.as_cons() {
-            let funcar = cons.car();
-
+        if let Some((funcar, _)) = fun.into() {
             if !funcar.is_symbol() {
                 return Err(LispFunError::InvalidFun);
             }
@@ -1201,7 +1194,7 @@ pub extern "C" fn unbind_to(count: libc::ptrdiff_t, value: LispObject) -> LispOb
 /// usage: (unwind-protect BODYFORM UNWINDFORMS...)
 #[lisp_fn(min = "1", unevalled = "true")]
 pub fn unwind_protect(args: LispCons) -> LispObject {
-    let (bodyform, unwindforms) = args.as_tuple();
+    let (bodyform, unwindforms) = args.into();
     let count = c_specpdl_index();
 
     unsafe { record_unwind_protect(Some(prog_ignore), unwindforms) };
@@ -1218,7 +1211,7 @@ pub fn unwind_protect(args: LispCons) -> LispObject {
 /// usage: (catch TAG BODY...)
 #[lisp_fn(min = "1", unevalled = "true")]
 pub fn catch(args: LispCons) -> LispObject {
-    let (tag, body) = args.as_tuple();
+    let (tag, body) = args.into();
 
     let val = unsafe { eval_sub(tag) };
 
diff --git a/rust_src/src/ffi.rs b/rust_src/src/ffi.rs
index eee19cfd33..8fe387baf4 100644
--- a/rust_src/src/ffi.rs
+++ b/rust_src/src/ffi.rs
@@ -28,7 +28,7 @@ pub extern "C" fn arithcompare(
 
 #[no_mangle]
 pub extern "C" fn lucid_event_type_list_p(event: LispObject) -> bool {
-    keyboard::lucid_event_type_list_p(event.as_cons())
+    keyboard::lucid_event_type_list_p(event.into())
 }
 
 #[no_mangle]
diff --git a/rust_src/src/fns.rs b/rust_src/src/fns.rs
index 5aa84c1854..6dbcb0b29e 100644
--- a/rust_src/src/fns.rs
+++ b/rust_src/src/fns.rs
@@ -67,8 +67,8 @@ pub fn provide(feature: LispSymbolRef, subfeature: LispObject) -> LispObject {
     }
     // Run any load-hooks for this file.
     unsafe {
-        if let Some(c) = assq(feature.into(), globals.Vafter_load_alist).as_cons() {
-            Fmapc(Qfuncall, c.cdr());
+        if let Some((_, d)) = assq(feature.into(), globals.Vafter_load_alist).into() {
+            Fmapc(Qfuncall, d);
         }
     }
     feature.into()
diff --git a/rust_src/src/fonts.rs b/rust_src/src/fonts.rs
index 3e84ee61cb..2d2ecf345e 100644
--- a/rust_src/src/fonts.rs
+++ b/rust_src/src/fonts.rs
@@ -137,8 +137,8 @@ pub fn font_match_p(spec: LispObject, font: LispObject) -> bool {
 #[lisp_fn(min = "1")]
 pub fn find_font(spec: LispObject, frame: LispObject) -> LispObject {
     let val = unsafe { Flist_fonts(spec, frame, LispObject::from(1), Qnil) };
-    match val.as_cons() {
-        Some(cons) => cons.car(),
+    match val.into() {
+        Some((a, _)) => a,
         None => val,
     }
 }
diff --git a/rust_src/src/keymap.rs b/rust_src/src/keymap.rs
index a88351a006..5c082a25af 100644
--- a/rust_src/src/keymap.rs
+++ b/rust_src/src/keymap.rs
@@ -14,7 +14,7 @@ use crate::{
     keyboard::lucid_event_type_list_p,
     lisp::{defsubr, LispObject},
     lists::{nth, setcdr},
-    lists::{LispConsCircularChecks, LispConsEndChecks},
+    lists::{LispCons, LispConsCircularChecks, LispConsEndChecks},
     obarray::intern,
     remacs_sys::{
         access_keymap, copy_keymap_item, describe_vector, make_save_funcptr_ptr_obj,
@@ -106,22 +106,21 @@ pub extern "C" fn get_keymap(
             break;
         }
 
-        if let Some(cons) = object.as_cons() {
-            if cons.car().eq(Qkeymap) {
+        if let Some((car, _)) = object.into() {
+            if car.eq(Qkeymap) {
                 return object;
             }
         }
 
         let tem = indirect_function(object);
-        if let Some(cons) = tem.as_cons() {
-            if cons.car().eq(Qkeymap) {
+        if let Some((car, _)) = tem.into() {
+            if car.eq(Qkeymap) {
                 return tem;
             }
 
             // Should we do an autoload?  Autoload forms for keymaps have
             // Qkeymap as their fifth element.
-            if (autoload || !error_if_not_keymap) && cons.car().eq(Qautoload) && object.is_symbol()
-            {
+            if (autoload || !error_if_not_keymap) && car.eq(Qautoload) && object.is_symbol() {
                 let tail = nth(4, tem);
                 if tail.eq(Qkeymap) {
                     if autoload {
@@ -233,7 +232,7 @@ pub fn set_keymap_parent(keymap: LispObject, parent: LispObject) -> LispObject {
     }
 
     // Skip past the initial element 'keymap'.
-    let mut prev = keymap.as_cons_or_error();
+    let mut prev = LispCons::from(keymap);
     let mut list;
 
     loop {
@@ -289,8 +288,7 @@ pub unsafe extern "C" fn map_keymap(
 ) {
     let mut map = get_keymap(map, true, autoload);
     while map.is_cons() {
-        if let Some(cons) = map.as_cons() {
-            let (car, cdr) = cons.as_tuple();
+        if let Some((car, cdr)) = map.into() {
             if keymapp(car) {
                 map_keymap(car, fun, args, data, autoload);
                 map = cdr;
@@ -344,10 +342,9 @@ pub unsafe extern "C" fn map_keymap_internal(
     data: *mut c_void,
 ) -> LispObject {
     let map = map;
-    let tail = match map.as_cons() {
+    let tail = match map.into() {
         None => Qnil,
-        Some(cons) => {
-            let (car, cdr) = cons.as_tuple();
+        Some((car, cdr)) => {
             if car.eq(Qkeymap) {
                 cdr
             } else {
@@ -367,8 +364,7 @@ pub unsafe extern "C" fn map_keymap_internal(
                 break;
             }
 
-            if let Some(binding_cons) = binding.as_cons() {
-                let (car, cdr) = binding_cons.as_tuple();
+            if let Some((car, cdr)) = binding.into() {
                 map_keymap_item(fun, args, car, cdr, data);
             } else if binding.is_vector() {
                 if let Some(binding_vec) = binding.as_vectorlike() {
@@ -498,7 +494,7 @@ pub fn lookup_key(keymap: LispObject, key: LispObject, accept_default: LispObjec
         let mut c = aref(key, idx);
         idx += 1;
 
-        if c.is_cons() && lucid_event_type_list_p(c.as_cons()) {
+        if c.is_cons() && lucid_event_type_list_p(c.into()) {
             c = unsafe { Fevent_convert_list(c) };
         }
 
@@ -643,14 +639,13 @@ pub extern "C" fn copy_keymap_1(chartable: LispObject, idx: LispObject, elt: Lis
 /// is not copied.
 #[lisp_fn]
 pub fn copy_keymap(keymap: LispObject) -> LispObject {
-    let mut keymap = get_keymap(keymap, true, false);
+    let keymap = get_keymap(keymap, true, false);
     let mut tail = list!(Qkeymap);
     let copy = tail;
 
-    keymap = keymap.as_cons_or_error().cdr(); // Skip the `keymap' symbol.
+    let (_, mut keymap) = keymap.into(); // Skip the `keymap' symbol.
 
-    while let Some(cons) = keymap.as_cons() {
-        let mut elt = cons.car();
+    while let Some((mut elt, kmd)) = keymap.into() {
         if elt.eq(Qkeymap) {
             break;
         }
@@ -664,22 +659,21 @@ pub fn copy_keymap(keymap: LispObject) -> LispObject {
             for (i, obj) in v.iter().enumerate() {
                 v2.set(i, unsafe { copy_keymap_item(obj) });
             }
-        } else if let Some(cons_1) = elt.as_cons() {
-            let front = cons_1.car();
+        } else if let Some((front, back)) = elt.into() {
             if front.eq(Qkeymap) {
                 // This is a sub keymap
                 elt = copy_keymap(elt);
             } else {
-                elt = (front, unsafe { copy_keymap_item(cons_1.cdr()) }).into();
+                elt = (front, unsafe { copy_keymap_item(back) }).into();
             }
         }
 
-        setcdr(tail.as_cons().unwrap(), list!(elt));
-        tail = tail.as_cons().unwrap().cdr();
-        keymap = cons.cdr();
+        setcdr(tail.into(), list!(elt));
+        tail = LispCons::from(tail).cdr();
+        keymap = kmd;
     }
 
-    setcdr(tail.as_cons().unwrap(), keymap);
+    setcdr(tail.into(), keymap);
     copy
 }
 
diff --git a/rust_src/src/lisp.rs b/rust_src/src/lisp.rs
index efb47e0a25..16d1ae06b9 100644
--- a/rust_src/src/lisp.rs
+++ b/rust_src/src/lisp.rs
@@ -507,9 +507,10 @@ impl_alistval_iter! {LiveBufferIter, LispBufferRef, unsafe { Vbuffer_alist }}
 impl_alistval_iter! {ProcessIter, LispProcessRef, unsafe { Vprocess_alist }}
 
 pub fn is_autoload(function: LispObject) -> bool {
-    function
-        .as_cons()
-        .map_or(false, |cell| cell.car().eq(Qautoload))
+    match function.into() {
+        None => false,
+        Some((car, _)) => car.eq(Qautoload),
+    }
 }
 
 impl LispObject {
@@ -619,9 +620,9 @@ impl Debug for LispObject {
             Lisp_Type::Lisp_Cons => {
                 let mut cdr = *self;
                 write!(f, "'(")?;
-                while let Some(cons) = cdr.as_cons() {
-                    write!(f, "{:?} ", cons.car())?;
-                    cdr = cons.cdr();
+                while let Some((a, d)) = cdr.into() {
+                    write!(f, "{:?} ", a)?;
+                    cdr = d;
                 }
                 if cdr.is_nil() {
                     write!(f, ")")?;
diff --git a/rust_src/src/lists.rs b/rust_src/src/lists.rs
index 2d50f87256..ec7aec73e7 100644
--- a/rust_src/src/lists.rs
+++ b/rust_src/src/lists.rs
@@ -39,10 +39,6 @@ impl LispObject {
             None
         }
     }
-
-    pub fn as_cons_or_error(self) -> LispCons {
-        self.as_cons().unwrap_or_else(|| wrong_type!(Qconsp, self))
-    }
 }
 
 impl LispObject {
@@ -236,14 +232,14 @@ impl Iterator for CarIter {
 
 impl From<LispObject> for LispCons {
     fn from(o: LispObject) -> Self {
-        o.as_cons_or_error()
+        o.as_cons().unwrap_or_else(|| wrong_type!(Qconsp, o))
     }
 }
 
 impl From<LispObject> for Option<LispCons> {
     fn from(o: LispObject) -> Self {
         if o.is_list() {
-            Some(o.as_cons_or_error())
+            Some(LispCons::from(o))
         } else {
             None
         }
@@ -262,6 +258,28 @@ impl<S: Into<LispObject>, T: Into<LispObject>> From<(S, T)> for LispObject {
     }
 }
 
+impl From<LispCons> for (LispObject, LispObject) {
+    fn from(c: LispCons) -> Self {
+        (c.car(), c.cdr())
+    }
+}
+
+impl From<LispObject> for (LispObject, LispObject) {
+    fn from(o: LispObject) -> Self {
+        LispCons::from(o).into()
+    }
+}
+
+impl From<LispObject> for Option<(LispObject, LispObject)> {
+    fn from(o: LispObject) -> Self {
+        if o.is_cons() {
+            Some(o.into())
+        } else {
+            None
+        }
+    }
+}
+
 impl LispCons {
     fn _extract(self) -> *mut Lisp_Cons {
         self.0.get_untaggedptr() as *mut Lisp_Cons
@@ -277,10 +295,6 @@ impl LispCons {
         unsafe { (*self._extract()).u.s.as_ref().u.cdr }
     }
 
-    pub fn as_tuple(self) -> (LispObject, LispObject) {
-        (self.car(), self.cdr())
-    }
-
     /// Set the car of the cons cell.
     pub fn set_car(self, n: LispObject) {
         unsafe {
@@ -320,8 +334,8 @@ impl LispCons {
         loop {
             match (it1.next(), it2.next()) {
                 (Some(cons1), Some(cons2)) => {
-                    let (item1, tail1) = cons1.as_tuple();
-                    let (item2, tail2) = cons2.as_tuple();
+                    let (item1, tail1) = cons1.into();
+                    let (item2, tail2) = cons2.into();
                     if !unsafe { internal_equal(item1, item2, kind, item_depth, item_ht) } {
                         return false;
                     } else if tail1.eq(tail2) {
@@ -415,7 +429,8 @@ pub fn car(list: LispObject) -> LispObject {
     if list.is_nil() {
         list
     } else {
-        list.as_cons_or_error().car()
+        let (a, _) = list.into();
+        a
     }
 }
 
@@ -429,20 +444,27 @@ pub fn cdr(list: LispObject) -> LispObject {
     if list.is_nil() {
         list
     } else {
-        list.as_cons_or_error().cdr()
+        let (_, d) = list.into();
+        d
     }
 }
 
 /// Return the car of OBJECT if it is a cons cell, or else nil.
 #[lisp_fn]
 pub fn car_safe(object: LispObject) -> LispObject {
-    object.as_cons().map_or(Qnil, |cons| cons.car())
+    match object.into() {
+        Some((car, _)) => car,
+        None => Qnil,
+    }
 }
 
 /// Return the cdr of OBJECT if it is a cons cell, or else nil.
 #[lisp_fn]
 pub fn cdr_safe(object: LispObject) -> LispObject {
-    object.as_cons().map_or(Qnil, |cons| cons.cdr())
+    match object.into() {
+        Some((_, cdr)) => cdr,
+        None => Qnil,
+    }
 }
 
 /// Take cdr N times on LIST, return the result.
@@ -572,7 +594,7 @@ pub fn delq(elt: LispObject, list: LispObject) -> LispObject {
     let mut prev = None;
     list.iter_tails(LispConsEndChecks::on, LispConsCircularChecks::on)
         .fold(list, |remaining, tail| {
-            let (item, rest) = tail.as_tuple();
+            let (item, rest) = tail.into();
             if elt.eq(item) {
                 match prev {
                     Some(cons) => setcdr(cons, rest),
@@ -632,7 +654,7 @@ where
         .iter_tails_plist(end_checks, circular_checks)
         .step_by(2)
     {
-        match tail.cdr().as_cons() {
+        match tail.cdr().into() {
             None => {
                 // need an extra check here to catch odd-length lists
                 if end_checks == LispConsEndChecks::on && LispObject::from(tail).is_not_nil() {
@@ -641,9 +663,9 @@ where
 
                 break;
             }
-            Some(tail_cdr_cons) => {
+            Some((tail_cdr_cons_car, _)) => {
                 if cmp(tail.car(), prop) {
-                    return tail_cdr_cons.car();
+                    return tail_cdr_cons_car;
                 }
             }
         }
@@ -700,8 +722,10 @@ where
     match last_cons {
         None => (prop, (val, Qnil)).into(),
         Some(last_cons) => {
-            let last_cons_cdr = last_cons.cdr().as_cons_or_error();
-            last_cons_cdr.set_cdr((prop, (val, last_cons_cdr.cdr())).into());
+            let (_, last_cons_cdr) = last_cons.into();
+            let last_cons_cdr = LispCons::from(last_cons_cdr);
+            let (_, lcc_cdr) = last_cons_cdr.into();
+            last_cons_cdr.set_cdr((prop, (val, lcc_cdr)).into());
             plist
         }
     }
@@ -789,7 +813,7 @@ pub fn sort_list(list: LispObject, pred: LispObject) -> LispObject {
 
     let item = nthcdr(length / 2 - 1, list);
     let back = cdr(item);
-    setcdr(item.as_cons_or_error(), Qnil);
+    setcdr(item.into(), Qnil);
 
     let front = sort_list(list, pred);
     let back = sort_list(back, pred);
@@ -842,7 +866,7 @@ pub fn merge(mut l1: LispObject, mut l2: LispObject, pred: LispObject) -> LispOb
                 value = item;
             }
         };
-        tail = item.as_cons();
+        tail = item.into();
     }
 }
 
diff --git a/rust_src/src/minibuf.rs b/rust_src/src/minibuf.rs
index 061ed56da3..63d246bf16 100644
--- a/rust_src/src/minibuf.rs
+++ b/rust_src/src/minibuf.rs
@@ -336,9 +336,9 @@ pub fn read_string(
 
     if let Some(s) = val.as_string() {
         if s.len_chars() == 0 && default_value.is_not_nil() {
-            val = match default_value.as_cons() {
+            val = match default_value.into() {
                 None => default_value,
-                Some(c) => c.car(),
+                Some((a, _)) => a,
             }
         }
     }
diff --git a/rust_src/src/process.rs b/rust_src/src/process.rs
index f166ff0019..cb2bdb53af 100644
--- a/rust_src/src/process.rs
+++ b/rust_src/src/process.rs
@@ -279,8 +279,8 @@ pub fn process_status(process: LispObject) -> LispObject {
         unsafe { update_status(process.as_mut()) };
     }
     let mut status = process.status;
-    if let Some(c) = status.as_cons() {
-        status = c.car();
+    if let Some((a, _)) = status.into() {
+        status = a;
     };
     let process_type = process.ptype();
     if process_type.eq(Qnetwork) || process_type.eq(Qserial) || process_type.eq(Qpipe) {
@@ -488,9 +488,10 @@ pub fn process_exit_status(mut process: LispProcessRef) -> LispObject {
         unsafe { update_status(process.as_mut()) };
     }
     let status = process.status;
-    status
-        .as_cons()
-        .map_or_else(|| LispObject::from(0), |cons| car(cons.cdr()))
+    match status.into() {
+        None => 0.into(),
+        Some((_, d)) => car(d),
+    }
 }
 
 /// Return non-nil if PROCESS has given the terminal to a
diff --git a/rust_src/src/time.rs b/rust_src/src/time.rs
index b27e6976c3..cc954646bf 100644
--- a/rust_src/src/time.rs
+++ b/rust_src/src/time.rs
@@ -176,18 +176,16 @@ pub unsafe extern "C" fn disassemble_lisp_time(
     let mut psec = LispObject::from(0);
     let mut len = 4;
 
-    if let Some(cons) = specified_time.as_cons() {
-        high = cons.car();
-        low = cons.cdr();
-
-        if let Some(cons) = cons.cdr().as_cons() {
-            let low_tail = cons.cdr();
-            low = cons.car();
-            if let Some(cons) = low_tail.as_cons() {
-                usec = cons.car();
-                let low_tail = cons.cdr();
-                if let Some(cons) = low_tail.as_cons() {
-                    psec = cons.car();
+    if let Some((car, cdr)) = specified_time.into() {
+        high = car;
+        low = cdr;
+
+        if let Some((a, low_tail)) = cdr.into() {
+            low = a;
+            if let Some((a, low_tail)) = low_tail.into() {
+                usec = a;
+                if let Some((a, _)) = low_tail.into() {
+                    psec = a;
                 } else {
                     len = 3;
                 }
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 732bb9799b..1a758bd642 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -218,8 +218,10 @@ impl LispWindowRef {
     }
 
     pub fn get_parameter(self, parameter: LispObject) -> LispObject {
-        let result = assq(parameter, self.window_parameters);
-        result.as_cons().map_or(Qnil, |c| c.cdr())
+        match assq(parameter, self.window_parameters).into() {
+            Some((_, cdr)) => cdr,
+            None => Qnil,
+        }
     }
 }
 
@@ -662,7 +664,7 @@ pub fn set_window_parameter(
     if old_alist_elt.is_nil() {
         win.window_parameters = ((parameter, value), win.window_parameters).into();
     } else {
-        setcdr(old_alist_elt.as_cons_or_error(), value);
+        setcdr(old_alist_elt.into(), value);
     }
     value
 }
-- 
2.21.0


From 98160ff6b0dd609ea1c35cdbc5dd1291cc12c380 Mon Sep 17 00:00:00 2001
From: Johannes Altmanninger <aclopte@gmail.com>
Date: Wed, 9 Jan 2019 00:02:18 +0100
Subject: [PATCH 008/297] Quote RUSTFLAGS in lib-src/Makefile.in (#1225)

Fixes #1135.

This prevents occasional build failures when settings custom
RUSTFLAGS. The build failure occured when executing below command on a
clean checkout.

./autogen.sh && ./configure --enable-rust-debug && \
make -j4 RUSTFLAGS="-C target-cpu=native" all
---
 lib-src/Makefile.in | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lib-src/Makefile.in b/lib-src/Makefile.in
index 17199b2866..6d9d56702b 100644
--- a/lib-src/Makefile.in
+++ b/lib-src/Makefile.in
@@ -383,7 +383,7 @@ TAGS: etags${EXEEXT} ${tagsfiles}
 
 cargo_manifest=../rust_src/remacs-lib/Cargo.toml
 $(RUST_ARCHIVE): $(rust_srcdir)/remacs-lib/**
-	RUSTFLAGS=$(RUSTFLAGS) \
+	RUSTFLAGS="$(RUSTFLAGS)" \
 	$(CARGO_BUILD) $(CARGO_FLAGS) --manifest-path=$(cargo_manifest)
 
 remacs-libclean:
-- 
2.21.0


From d1b99cd4456c56ed713d1fd10faa413d611160d1 Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Tue, 8 Jan 2019 16:24:00 -0800
Subject: [PATCH 009/297] Revert "Sync from Emacs 2018-03-15 (#1218)" (#1219)

This reverts commit 45b27a8423618f958ab961896591e75b85289a24.
---
 Makefile.in                                   |    1 -
 admin/automerge                               |    2 +-
 admin/grammars/scheme.by                      |    5 -
 build-aux/config.guess                        |    4 +-
 build-aux/config.sub                          |    6 +-
 build-aux/install-sh                          |    4 +-
 build-aux/move-if-change                      |    4 +-
 build-aux/update-copyright                    |    4 +-
 configure.ac                                  |   27 +-
 doc/emacs/basic.texi                          |   10 +-
 doc/emacs/buffers.texi                        |   22 +-
 doc/emacs/building.texi                       |   13 +-
 doc/emacs/commands.texi                       |   12 +-
 doc/emacs/custom.texi                         |   23 +-
 doc/emacs/dired.texi                          |    6 +-
 doc/emacs/display.texi                        |   57 +-
 doc/emacs/emacs.texi                          |    4 +-
 doc/emacs/files.texi                          |    7 +-
 doc/emacs/fixit.texi                          |   23 +-
 doc/emacs/frames.texi                         |   28 +-
 doc/emacs/glossary.texi                       |   78 +-
 doc/emacs/help.texi                           |    1 +
 doc/emacs/killing.texi                        |    5 +-
 doc/emacs/macos.texi                          |    2 +-
 doc/emacs/maintaining.texi                    |   20 +-
 doc/emacs/mini.texi                           |   28 +-
 doc/emacs/misc.texi                           |   10 +-
 doc/emacs/msdos.texi                          |   16 +-
 doc/emacs/mule.texi                           |   25 +-
 doc/emacs/programs.texi                       |   37 +-
 doc/emacs/rmail.texi                          |    4 +-
 doc/emacs/search.texi                         |   26 +-
 doc/emacs/text.texi                           |   79 +-
 doc/emacs/trouble.texi                        |    4 +-
 doc/emacs/xresources.texi                     |  130 +-
 doc/lispintro/emacs-lisp-intro.texi           |   18 +-
 doc/lispref/display.texi                      |   13 +-
 doc/lispref/files.texi                        |    4 +-
 doc/lispref/frames.texi                       |    6 -
 doc/lispref/hooks.texi                        |    1 -
 doc/lispref/keymaps.texi                      |    2 +-
 doc/lispref/numbers.texi                      |    5 +-
 doc/lispref/streams.texi                      |    8 -
 doc/lispref/strings.texi                      |    2 +-
 doc/lispref/text.texi                         |    2 +-
 doc/lispref/tips.texi                         |    3 +-
 doc/lispref/variables.texi                    |    5 +-
 doc/misc/calc.texi                            |   73 +-
 doc/misc/cc-mode.texi                         |   42 +-
 doc/misc/dbus.texi                            |    6 +-
 doc/misc/dired-x.texi                         |    2 +-
 doc/misc/ebrowse.texi                         |    6 +-
 doc/misc/ede.texi                             |   32 +-
 doc/misc/ediff.texi                           |    4 +-
 doc/misc/edt.texi                             |    4 +-
 doc/misc/efaq-w32.texi                        |   34 +-
 doc/misc/efaq.texi                            |   14 +-
 doc/misc/eieio.texi                           |    6 +-
 doc/misc/emacs-mime.texi                      |    8 +-
 doc/misc/epa.texi                             |   24 +-
 doc/misc/erc.texi                             |   24 +-
 doc/misc/ert.texi                             |   10 +-
 doc/misc/eshell.texi                          |   18 +-
 doc/misc/eww.texi                             |    2 +-
 doc/misc/forms.texi                           |   24 +-
 doc/misc/gnus-faq.texi                        |   36 +-
 doc/misc/gnus-news.texi                       |    2 +-
 doc/misc/gnus.texi                            | 1555 +++++++++--------
 doc/misc/htmlfontify.texi                     |   12 +-
 doc/misc/idlwave.texi                         |    8 +-
 doc/misc/ido.texi                             |    4 +-
 doc/misc/mairix-el.texi                       |   24 +-
 doc/misc/message.texi                         |   20 +-
 doc/misc/mh-e.texi                            |  169 +-
 doc/misc/newsticker.texi                      |   20 +-
 doc/misc/org.texi                             | 1035 ++++++-----
 doc/misc/pcl-cvs.texi                         |   11 +-
 doc/misc/reftex.texi                          |    2 +-
 doc/misc/sem-user.texi                        |    6 +-
 doc/misc/ses.texi                             |   16 +-
 doc/misc/sieve.texi                           |   10 +-
 doc/misc/smtpmail.texi                        |    2 +-
 doc/misc/speedbar.texi                        |   12 +-
 doc/misc/srecode.texi                         |   17 +-
 doc/misc/texinfo.tex                          |    4 +-
 doc/misc/tramp.texi                           |   18 +-
 doc/misc/url.texi                             |   13 +
 doc/misc/vhdl-mode.texi                       |   14 +-
 doc/misc/vip.texi                             |  446 ++---
 doc/misc/viper.texi                           |  436 ++---
 etc/NEWS                                      |   87 +-
 etc/NEWS.26                                   |   14 +-
 etc/ORG-NEWS                                  |   12 +-
 etc/TODO                                      |    1 +
 lib-src/make-docfile.c                        |   95 +-
 lib/binary-io.h                               |    6 +-
 lib/fpending.c                                |    3 +-
 lib/stdio-impl.h                              |    6 -
 lisp/allout.el                                |    4 +-
 lisp/arc-mode.el                              |    2 +
 lisp/auth-source.el                           |    4 +-
 lisp/autoinsert.el                            |    2 +-
 lisp/bookmark.el                              |    2 +
 lisp/calendar/icalendar.el                    |   10 +-
 lisp/cedet/ede.el                             |    1 -
 lisp/cedet/semantic/bovine/grammar.el         |    9 +-
 lisp/cedet/semantic/sb.el                     |    6 +-
 lisp/cedet/semantic/texi.el                   |    2 -
 lisp/comint.el                                |    7 +-
 lisp/cus-edit.el                              |    4 +
 lisp/descr-text.el                            |    2 +
 lisp/desktop.el                               |   64 +-
 lisp/dired-aux.el                             |    3 +-
 lisp/dired-x.el                               |    2 +
 lisp/emacs-lisp/autoload.el                   |    5 +-
 lisp/emacs-lisp/bytecomp.el                   |    8 +-
 lisp/emacs-lisp/cl-macs.el                    |   16 +-
 lisp/emacs-lisp/derived.el                    |   13 +
 lisp/emacs-lisp/eieio.el                      |    2 +-
 lisp/emacs-lisp/ert.el                        |   26 +-
 lisp/emacs-lisp/ewoc.el                       |    2 +-
 lisp/emacs-lisp/generic.el                    |    2 +
 lisp/emacs-lisp/syntax.el                     |    6 +
 lisp/emacs-lisp/timer.el                      |   14 +
 lisp/emacs-lisp/unsafep.el                    |    2 +-
 lisp/emulation/cua-base.el                    |    8 +-
 lisp/emulation/viper-ex.el                    |   10 +-
 lisp/emulation/viper.el                       |    4 +-
 lisp/epa-hook.el                              |    2 +-
 lisp/epa-mail.el                              |    2 +-
 lisp/erc/erc-dcc.el                           |    4 +-
 lisp/eshell/em-cmpl.el                        |   10 +-
 lisp/eshell/em-dirs.el                        |    8 +-
 lisp/eshell/em-pred.el                        |    2 +-
 lisp/eshell/em-script.el                      |    2 +-
 lisp/eshell/em-tramp.el                       |    1 -
 lisp/eshell/em-unix.el                        |    2 +-
 lisp/eshell/em-xtra.el                        |    6 +-
 lisp/eshell/esh-ext.el                        |    2 +-
 lisp/eshell/esh-opt.el                        |    6 +-
 lisp/eshell/esh-proc.el                       |    6 +-
 lisp/eshell/esh-util.el                       |    5 +-
 lisp/eshell/esh-var.el                        |    2 -
 lisp/ffap.el                                  |    2 +-
 lisp/filenotify.el                            |    2 +-
 lisp/files.el                                 |   19 +-
 lisp/frame.el                                 |   13 +-
 lisp/generic-x.el                             |   25 +-
 lisp/gnus/gnus-score.el                       |    7 +-
 lisp/gnus/gnus-sum.el                         |    2 +-
 lisp/gnus/gnus.el                             |    1 -
 lisp/gnus/mm-decode.el                        |  125 +-
 lisp/gnus/mm-extern.el                        |   19 +-
 lisp/gnus/mml-sec.el                          |    3 +-
 lisp/gnus/nnheader.el                         |    2 +-
 lisp/gnus/nnir.el                             |   40 +-
 lisp/gnus/nnmaildir.el                        |   13 +-
 lisp/gnus/smime.el                            |    4 +-
 lisp/gnus/spam.el                             |  103 +-
 lisp/help.el                                  |    5 +
 lisp/hfy-cmap.el                              |   35 +-
 lisp/hilit-chg.el                             |    7 +-
 lisp/htmlfontify.el                           |   53 +-
 lisp/ibuffer.el                               |   22 +-
 lisp/ido.el                                   |   13 +-
 lisp/image.el                                 |    8 +-
 lisp/imenu.el                                 |   12 +-
 lisp/international/latin1-disp.el             |    4 +
 lisp/isearch.el                               |   85 +-
 lisp/ldefs-boot.el                            |   74 +-
 lisp/loadhist.el                              |    2 +
 lisp/mail/rmail.el                            |    6 +
 lisp/mh-e/mh-acros.el                         |    7 +-
 lisp/mh-e/mh-comp.el                          |   25 +-
 lisp/mh-e/mh-compat.el                        |    6 +-
 lisp/mh-e/mh-e.el                             |    7 -
 lisp/mh-e/mh-folder.el                        |    2 +-
 lisp/mh-e/mh-thread.el                        |   25 +-
 lisp/mh-e/mh-utils.el                         |    1 -
 lisp/minibuffer.el                            |    5 +-
 lisp/mwheel.el                                |   49 +-
 lisp/net/ange-ftp.el                          |    2 +-
 lisp/net/eudc-bob.el                          |    2 +-
 lisp/net/eww.el                               |    3 +-
 lisp/net/goto-addr.el                         |    4 +
 lisp/net/net-utils.el                         |    5 +
 lisp/net/quickurl.el                          |    9 +-
 lisp/net/tramp-adb.el                         |    4 +-
 lisp/net/tramp-archive.el                     |    8 +-
 lisp/net/tramp-sh.el                          |   12 +-
 lisp/net/tramp.el                             |    3 +-
 lisp/novice.el                                |    3 +
 lisp/obsolete/iswitchb.el                     |    2 +
 lisp/obsolete/options.el                      |  140 ++
 lisp/obsolete/tpu-mapper.el                   |    4 +-
 lisp/org/org-agenda.el                        |   12 +-
 lisp/org/org-element.el                       |    2 +-
 lisp/org/org-indent.el                        |   25 +-
 lisp/org/org-pcomplete.el                     |   20 +-
 lisp/org/org-table.el                         |    2 +-
 lisp/org/org.el                               |    9 +-
 lisp/org/ox-odt.el                            |    4 -
 lisp/outline.el                               |   42 +-
 lisp/pcmpl-cvs.el                             |    8 +-
 lisp/pcmpl-gnu.el                             |    2 +-
 lisp/pcmpl-linux.el                           |    6 +-
 lisp/pcmpl-rpm.el                             |    2 +-
 lisp/pcmpl-unix.el                            |    2 +-
 lisp/pcomplete.el                             |   73 +-
 lisp/play/dunnet.el                           |    1 +
 lisp/play/gametree.el                         |    3 +-
 lisp/progmodes/ada-mode.el                    |    2 +-
 lisp/progmodes/bat-mode.el                    |    2 -
 lisp/progmodes/compile.el                     |   14 +
 lisp/progmodes/cperl-mode.el                  |   12 +-
 lisp/progmodes/ebrowse.el                     |    4 +-
 lisp/progmodes/flymake.el                     |    4 -
 lisp/progmodes/gdb-mi.el                      |    2 +-
 lisp/progmodes/glasses.el                     |    4 +-
 lisp/progmodes/grep.el                        |   57 +-
 lisp/progmodes/gud.el                         |   11 +-
 lisp/progmodes/idlw-help.el                   |    5 +-
 lisp/progmodes/meta-mode.el                   |    4 +-
 lisp/progmodes/octave.el                      |    2 -
 lisp/progmodes/pascal.el                      |    3 +-
 lisp/progmodes/perl-mode.el                   |    4 +-
 lisp/progmodes/python.el                      |   21 +-
 lisp/progmodes/sql.el                         |    3 +-
 lisp/progmodes/verilog-mode.el                |    4 +-
 lisp/progmodes/vhdl-mode.el                   |    4 +-
 lisp/progmodes/xref.el                        |    9 +-
 lisp/recentf.el                               |    4 +
 lisp/savehist.el                              |   23 +
 lisp/server.el                                |    9 -
 lisp/ses.el                                   |    4 +-
 lisp/simple.el                                |    7 -
 lisp/speedbar.el                              |   23 +
 lisp/subr.el                                  |   38 +
 lisp/term.el                                  |   19 +-
 lisp/term/pc-win.el                           |    2 +-
 lisp/textmodes/flyspell.el                    |    4 -
 lisp/textmodes/nroff-mode.el                  |    7 +
 lisp/textmodes/reftex-toc.el                  |    2 +-
 lisp/url/url-auth.el                          |    2 +-
 lisp/url/url-handlers.el                      |    3 -
 lisp/vc/add-log.el                            |    2 +-
 lisp/vc/ediff-merg.el                         |    2 +-
 lisp/vc/ediff-util.el                         |    6 +-
 lisp/vc/log-edit.el                           |   10 +
 lisp/vc/pcvs-info.el                          |    5 +
 lisp/vc/vc-dir.el                             |    2 +-
 lisp/vc/vc.el                                 |    5 +
 lisp/w32-fns.el                               |    2 +-
 lisp/woman.el                                 |    4 +-
 src/alloc.c                                   |   20 +-
 src/data.c                                    |    2 +-
 src/dispextern.h                              |   10 -
 src/editfns.c                                 |  150 +-
 src/fns.c                                     |    5 +-
 src/frame.c                                   |    2 +-
 src/lread.c                                   |    4 +-
 src/nsterm.m                                  |   26 +-
 src/print.c                                   |   57 +-
 src/process.c                                 |    8 +-
 src/term.c                                    |    4 +-
 src/w32term.c                                 |   36 +-
 src/window.c                                  |    3 -
 src/xdisp.c                                   |  103 +-
 src/xfaces.c                                  |    4 +-
 src/xterm.c                                   |   37 +-
 test/Makefile.in                              |   21 +-
 test/README                                   |    5 -
 test/lisp/dired-tests.el                      |   23 +-
 test/lisp/emacs-lisp/benchmark-tests.el       |   14 +-
 .../emacs-lisp/eieio-tests/eieio-tests.el     |   21 +-
 test/lisp/emacs-lisp/package-tests.el         |    4 +-
 test/lisp/eshell/em-ls-tests.el               |    1 -
 test/lisp/hi-lock-tests.el                    |    4 +-
 test/lisp/international/mule-tests.el         |    3 -
 test/lisp/ls-lisp-tests.el                    |    1 -
 test/lisp/net/tramp-archive-tests.el          |    4 +-
 test/lisp/net/tramp-tests.el                  |    3 -
 test/lisp/progmodes/bat-mode-tests.el         |    5 +-
 test/lisp/progmodes/ruby-mode-tests.el        |    6 +-
 test/lisp/ses-tests.el                        |   80 +-
 test/lisp/simple-tests.el                     |   13 +-
 test/lisp/term-tests.el                       |   12 -
 test/lisp/vc/diff-mode-tests.el               |    2 +-
 test/lisp/vc/vc-tests.el                      |    2 +-
 test/src/eval-tests.el                        |   20 -
 test/src/json-tests.el                        |    5 -
 291 files changed, 3865 insertions(+), 4005 deletions(-)
 create mode 100644 lisp/obsolete/options.el

diff --git a/Makefile.in b/Makefile.in
index 95771e0193..7a178004cd 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -1180,7 +1180,6 @@ check-declare:
 	  exit 1; \
 	fi
 	$(MAKE) -C lisp $@
-	$(MAKE) -C test $@
 
 .PHONY: rustfmt
 
diff --git a/admin/automerge b/admin/automerge
index e88711f8d6..520961f1e8 100755
--- a/admin/automerge
+++ b/admin/automerge
@@ -138,7 +138,7 @@ trap "rm -f $tempfile 2> /dev/null" EXIT
 
 [ "$reset" ] && {
     echo "Resetting..."
-    git reset -q --hard origin/master || die "reset error"
+    git reset --hard origin/master || die "reset error"
 
     echo "Pulling..."
     git pull -q --ff-only || die "pull error"
diff --git a/admin/grammars/scheme.by b/admin/grammars/scheme.by
index 5ea25508fd..ce9fff0286 100644
--- a/admin/grammars/scheme.by
+++ b/admin/grammars/scheme.by
@@ -20,11 +20,6 @@
 %package semantic-scm-by
 %provide semantic/bovine/scm-by
 
-%{
-(declare-function semantic-parse-region "semantic"
-		  (start end &optional nonterminal depth returnonerror))
-}
-
 %languagemode  scheme-mode
 %start         scheme
 
diff --git a/build-aux/config.guess b/build-aux/config.guess
index 958a24cdf4..f50dcdb6de 100755
--- a/build-aux/config.guess
+++ b/build-aux/config.guess
@@ -2,7 +2,7 @@
 # Attempt to guess a canonical system name.
 #   Copyright 1992-2018 Free Software Foundation, Inc.
 
-timestamp='2018-03-08'
+timestamp='2018-02-24'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -1473,7 +1473,7 @@ EOF
 exit 1
 
 # Local variables:
-# eval: (add-hook 'before-save-hook 'time-stamp)
+# eval: (add-hook 'write-file-functions 'time-stamp)
 # time-stamp-start: "timestamp='"
 # time-stamp-format: "%:y-%02m-%02d"
 # time-stamp-end: "'"
diff --git a/build-aux/config.sub b/build-aux/config.sub
index 9ccf09a7a3..1d8e98bcee 100755
--- a/build-aux/config.sub
+++ b/build-aux/config.sub
@@ -2,7 +2,7 @@
 # Configuration validation subroutine script.
 #   Copyright 1992-2018 Free Software Foundation, Inc.
 
-timestamp='2018-03-08'
+timestamp='2018-02-22'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -1376,7 +1376,7 @@ case $os in
 	      | -ekkobsd* | -kfreebsd* | -freebsd* | -riscix* | -lynxos* \
 	      | -bosx* | -nextstep* | -cxux* | -aout* | -elf* | -oabi* \
 	      | -ptx* | -coff* | -ecoff* | -winnt* | -domain* | -vsta* \
-	      | -udi* | -eabi* | -lites* | -ieee* | -go32* | -aux* | -hcos* \
+	      | -udi* | -eabi* | -lites* | -ieee* | -go32* | -aux* \
 	      | -chorusos* | -chorusrdb* | -cegcc* | -glidix* \
 	      | -cygwin* | -msys* | -pe* | -psos* | -moss* | -proelf* | -rtems* \
 	      | -midipix* | -mingw32* | -mingw64* | -linux-gnu* | -linux-android* \
@@ -1794,7 +1794,7 @@ echo "$basic_machine$os"
 exit
 
 # Local variables:
-# eval: (add-hook 'before-save-hook 'time-stamp)
+# eval: (add-hook 'write-file-functions 'time-stamp)
 # time-stamp-start: "timestamp='"
 # time-stamp-format: "%:y-%02m-%02d"
 # time-stamp-end: "'"
diff --git a/build-aux/install-sh b/build-aux/install-sh
index 5f3d36cb76..ac159ceda4 100755
--- a/build-aux/install-sh
+++ b/build-aux/install-sh
@@ -1,7 +1,7 @@
 #!/bin/sh
 # install - install a program, script, or datafile
 
-scriptversion=2018-03-07.03; # UTC
+scriptversion=2017-09-23.17; # UTC
 
 # This originates from X11R5 (mit/util/scripts/install.sh), which was
 # later released in X11R6 (xc/config/util/install.sh) with the
@@ -501,7 +501,7 @@ do
 done
 
 # Local variables:
-# eval: (add-hook 'before-save-hook 'time-stamp)
+# eval: (add-hook 'write-file-hooks 'time-stamp)
 # time-stamp-start: "scriptversion="
 # time-stamp-format: "%:y-%02m-%02d.%02H"
 # time-stamp-time-zone: "UTC0"
diff --git a/build-aux/move-if-change b/build-aux/move-if-change
index 5da3eae80a..f15923613c 100755
--- a/build-aux/move-if-change
+++ b/build-aux/move-if-change
@@ -2,7 +2,7 @@
 # Like mv $1 $2, but if the files are the same, just delete $1.
 # Status is zero if successful, nonzero otherwise.
 
-VERSION='2018-03-07 03:47'; # UTC
+VERSION='2017-09-13 06:45'; # UTC
 # The definition above must lie within the first 8 lines in order
 # for the Emacs time-stamp write hook (at end) to update it.
 # If you change this file with Emacs, please let the write hook
@@ -75,7 +75,7 @@ else
 fi
 
 ## Local Variables:
-## eval: (add-hook 'before-save-hook 'time-stamp)
+## eval: (add-hook 'write-file-hooks 'time-stamp)
 ## time-stamp-start: "VERSION='"
 ## time-stamp-format: "%:y-%02m-%02d %02H:%02M"
 ## time-stamp-time-zone: "UTC0"
diff --git a/build-aux/update-copyright b/build-aux/update-copyright
index f2fc97e368..3bb26abea1 100755
--- a/build-aux/update-copyright
+++ b/build-aux/update-copyright
@@ -3,7 +3,7 @@ eval '(exit $?0)' && eval 'exec perl -wS -0777 -pi "$0" "$@"'
     if 0;
 # Update an FSF copyright year list to include the current year.
 
-my $VERSION = '2018-03-07.03:47'; # UTC
+my $VERSION = '2018-01-04.14:48'; # UTC
 
 # Copyright (C) 2009-2018 Free Software Foundation, Inc.
 #
@@ -269,7 +269,7 @@ else
 # coding: utf-8
 # mode: perl
 # indent-tabs-mode: nil
-# eval: (add-hook 'before-save-hook 'time-stamp)
+# eval: (add-hook 'write-file-hooks 'time-stamp)
 # time-stamp-start: "my $VERSION = '"
 # time-stamp-format: "%:y-%02m-%02d.%02H:%02M"
 # time-stamp-time-zone: "UTC0"
diff --git a/configure.ac b/configure.ac
index 34b9bcffee..141cfe2b0f 100644
--- a/configure.ac
+++ b/configure.ac
@@ -365,12 +365,7 @@ OPTION_DEFAULT_OFF([w32], [use native MS Windows GUI in a Cygwin build])
 OPTION_DEFAULT_ON([gpm],[don't use -lgpm for mouse support on a GNU/Linux console])
 OPTION_DEFAULT_ON([dbus],[don't compile with D-Bus support])
 AC_ARG_WITH([gconf],[AS_HELP_STRING([--with-gconf],
-[compile with Gconf support (Gsettings replaces this)])],[],
-[if test $with_features = yes; then
-with_gconf=maybe
-else
-with_gconf=no
-fi])
+[compile with Gconf support (Gsettings replaces this)])],[],[with_gconf=maybe])
 OPTION_DEFAULT_ON([gsettings],[don't compile with GSettings support])
 OPTION_DEFAULT_ON([selinux],[don't compile with SELinux support])
 OPTION_DEFAULT_ON([gnutls],[don't use -lgnutls for SSL/TLS support])
@@ -3386,26 +3381,6 @@ fi
 AC_SUBST(LCMS2_CFLAGS)
 AC_SUBST(LCMS2_LIBS)
 
-HAVE_ZLIB=no
-LIBZ=
-if test "${with_zlib}" != "no"; then
-  OLIBS=$LIBS
-  AC_SEARCH_LIBS([inflateEnd], [z], [HAVE_ZLIB=yes])
-  LIBS=$OLIBS
-  case $ac_cv_search_inflateEnd in
-    -*) LIBZ=$ac_cv_search_inflateEnd ;;
-  esac
-fi
-if test "${HAVE_ZLIB}" = "yes"; then
-  AC_DEFINE([HAVE_ZLIB], 1, [Define to 1 if you have the zlib library (-lz).])
-  ### mingw32 doesn't use -lz, since it loads the library dynamically.
-  if test "${opsys}" = "mingw32"; then
-     LIBZ=
-  fi
-fi
-AC_SUBST(ZLIB_CFLAGS)
-AC_SUBST(ZLIB_LIBS)
-
 ### Dynamic modules support
 LIBMODULES=
 HAVE_MODULES=no
diff --git a/doc/emacs/basic.texi b/doc/emacs/basic.texi
index 3fec5f44de..aa91f0555e 100644
--- a/doc/emacs/basic.texi
+++ b/doc/emacs/basic.texi
@@ -218,14 +218,14 @@ preserves position within the line, like @kbd{C-n}.
 @item C-a
 @itemx @key{Home}
 @kindex C-a
-@kindex HOME
+@kindex HOME key
 @findex move-beginning-of-line
 Move to the beginning of the line (@code{move-beginning-of-line}).
 
 @item C-e
 @itemx @key{End}
 @kindex C-e
-@kindex END
+@kindex END key
 @findex move-end-of-line
 Move to the end of the line (@code{move-end-of-line}).
 
@@ -277,7 +277,7 @@ On graphical displays, @kbd{C-@key{HOME}} does the same.
 
 @item M->
 @kindex M->
-@kindex C-END
+@kindex C-@key{END}
 @findex end-of-buffer
 Move to the end of the buffer (@code{end-of-buffer}).  On graphical
 displays, @kbd{C-@key{END}} does the same.
@@ -728,7 +728,7 @@ direction.
 @findex digit-argument
 @findex negative-argument
   The easiest way to specify a numeric argument is to type a digit
-and/or a minus sign while holding down the @key{Meta} key.  For
+and/or a minus sign while holding down the @key{META} key.  For
 example,
 
 @example
@@ -742,7 +742,7 @@ well as @kbd{M--}, are bound to commands (@code{digit-argument} and
 command.  @kbd{M--} without digits normally means @minus{}1.
 
 If you enter more than one digit, you need not hold down the
-@key{Meta} key for the second and subsequent digits.  Thus, to move
+@key{META} key for the second and subsequent digits.  Thus, to move
 down fifty lines, type
 
 @example
diff --git a/doc/emacs/buffers.texi b/doc/emacs/buffers.texi
index dd7a653186..f8c1856058 100644
--- a/doc/emacs/buffers.texi
+++ b/doc/emacs/buffers.texi
@@ -32,13 +32,6 @@ buffer.  When there is only one Emacs window, the buffer displayed in
 that window is current.  When there are multiple windows, the buffer
 displayed in the @dfn{selected window} is current.  @xref{Windows}.
 
-@cindex buffer contents
-@cindex contents of a buffer
-  A buffer's @dfn{contents} consist of a series of characters, each of
-which optionally carries a set of text properties
-(@pxref{International Chars, Text properties}) that can specify more
-information about that character.
-
   Aside from its textual contents, each buffer records several pieces
 of information, such as what file it is visiting (if any), whether it
 is modified, and what major mode and minor modes are in effect
@@ -238,14 +231,13 @@ Scroll through buffer @var{buffer}.  @xref{View Mode}.
 @kindex C-x C-q
 @vindex buffer-read-only
 @cindex read-only buffer
-  A buffer can be @dfn{read-only}, which means that commands to insert
-or delete its text are not allowed.  (However, other commands, like
-@kbd{C-x @key{RET} f}, can still mark it as modified, @pxref{Text
-Coding}).  The mode line indicates read-only buffers with @samp{%%} or
-@samp{%*} near the left margin.  @xref{Mode Line}.  Read-only buffers
-are usually made by subsystems such as Dired and Rmail that have
-special commands to operate on the text.  Visiting a file whose access
-control says you cannot write it also makes the buffer read-only.
+  A buffer can be @dfn{read-only}, which means that commands to change
+its contents are not allowed.  The mode line indicates read-only
+buffers with @samp{%%} or @samp{%*} near the left margin.  @xref{Mode
+Line}.  Read-only buffers are usually made by subsystems such as Dired
+and Rmail that have special commands to operate on the text.  Visiting
+a file whose access control says you cannot write it also makes the
+buffer read-only.
 
 @findex read-only-mode
 @vindex view-read-only
diff --git a/doc/emacs/building.texi b/doc/emacs/building.texi
index d751cb4c48..d79efd089f 100644
--- a/doc/emacs/building.texi
+++ b/doc/emacs/building.texi
@@ -427,17 +427,14 @@ the variable @code{grep-files-aliases}.
 @kbd{M-x rgrep}.  The default value includes the data directories used
 by various version control systems.
 
-@vindex grep-find-abbreviate
-@findex grep-find-toggle-abbreviation
+@vindex grep-find-hide
   By default, the shell commands constructed for @code{lgrep},
 @code{rgrep}, and @code{zgrep} are abbreviated for display by
 concealing the part that contains a long list of files and directories
 to ignore.  You can reveal the concealed part by clicking on the
-button with ellipsis, which represents them.  You can also
-interactively toggle viewing the concealed part by typing @kbd{M-x
-grep-find-toggle-abbreviation}.  To disable this abbreviation of the
-shell commands, customize the option @code{grep-find-abbreviate} to a
-@code{nil} value.
+button with ellipsis, which represents them.  To disable this
+abbreviation of the shell commands, customize the option
+@code{grep-find-hide} to a @code{nil} value.
 
 @node Flymake
 @section Finding Syntax Errors On The Fly
@@ -1495,7 +1492,7 @@ Evaluate all the Emacs Lisp expressions in the buffer.
 @ifinfo
 @c This uses 'colon' instead of a literal ':' because Info cannot
 @c cope with a ':' in a menu.
-@kindex M-colon
+@kindex M-@key{colon}
 @end ifinfo
 @ifnotinfo
 @kindex M-:
diff --git a/doc/emacs/commands.texi b/doc/emacs/commands.texi
index a992dedc92..8b8b0c7aad 100644
--- a/doc/emacs/commands.texi
+++ b/doc/emacs/commands.texi
@@ -44,25 +44,25 @@ are certain characters found on non-English keyboards
 @cindex M-
   Emacs also recognizes control characters that are entered using
 @dfn{modifier keys}.  Two commonly-used modifier keys are
-@key{Control} (usually labeled @key{Ctrl}), and @key{Meta} (usually
-labeled @key{Alt})@footnote{We refer to @key{Alt} as @key{Meta} for
+@key{Control} (usually labeled @key{Ctrl}), and @key{META} (usually
+labeled @key{Alt})@footnote{We refer to @key{Alt} as @key{META} for
 historical reasons.}.  For example, @kbd{Control-a} is entered by
 holding down the @key{Ctrl} key while pressing @kbd{a}; we will refer
-to this as @kbd{C-a} for short.  Similarly, @kbd{@key{Meta}-a}, or @kbd{M-a}
+to this as @kbd{C-a} for short.  Similarly, @kbd{@key{META}-a}, or @kbd{M-a}
 for short, is entered by holding down the @key{Alt} key and pressing
 @kbd{a}.  Modifier keys can also be applied to non-alphanumerical
 characters, e.g., @kbd{C-@key{F1}} or @kbd{M-@key{LEFT}}.
 
-@cindex @key{ESC} replacing @key{Meta} key
+@cindex @key{ESC} replacing @key{META} key
   You can also type Meta characters using two-character sequences
 starting with @key{ESC}.  Thus, you can enter @kbd{M-a} by typing
 @kbd{@key{ESC} a}.  You can enter @kbd{C-M-a} (holding down both
 @key{Ctrl} and @key{Alt}, then pressing @kbd{a}) by typing
-@kbd{@key{ESC} C-a}.  Unlike @key{Meta}, @key{ESC} is entered as a
+@kbd{@key{ESC} C-a}.  Unlike @key{META}, @key{ESC} is entered as a
 separate character.  You don't hold down @key{ESC} while typing the
 next character; instead, press @key{ESC} and release it, then enter
 the next character.  This feature is useful on certain text terminals
-where the @key{Meta} key does not function reliably.
+where the @key{META} key does not function reliably.
 
 @cindex keys stolen by window manager
 @cindex window manager, keys stolen by
diff --git a/doc/emacs/custom.texi b/doc/emacs/custom.texi
index a5ce85440a..05925f043c 100644
--- a/doc/emacs/custom.texi
+++ b/doc/emacs/custom.texi
@@ -1414,8 +1414,6 @@ commands, and @dfn{keymaps}, which record key bindings.  It also
 explains how to customize key bindings, which is done by editing your
 init file (@pxref{Init Rebinding}).
 
-@cindex reserved key bindings
-@cindex keys, reserved
   Since most modes define their own key bindings, activating a mode
 might override your custom key bindings.  A small number of keys are
 reserved for user-defined bindings, and should not be used by modes,
@@ -1742,11 +1740,10 @@ characters.  For example, here's how to bind @kbd{C-x M-l} to
 (global-set-key "\C-x\M-l" 'make-symbolic-link)
 @end example
 
-  To bind a key sequence including @key{TAB}, @key{RET}, @key{ESC}, or
-@key{DEL}, the string should contain the Emacs Lisp escape sequence
-@samp{\t}, @samp{\r}, @samp{\e}, or @samp{\d} respectively.  Here is
-an example which binds @kbd{C-x @key{TAB}} to @code{indent-rigidly}
-(@pxref{Indentation}):
+  To put @key{TAB}, @key{RET}, @key{ESC}, or @key{DEL} in the string,
+use the Emacs Lisp escape sequences @samp{\t}, @samp{\r}, @samp{\e},
+and @samp{\d} respectively.  Here is an example which binds @kbd{C-x
+@key{TAB}} to @code{indent-rigidly} (@pxref{Indentation}):
 
 @example
 (global-set-key "\C-x\t" 'indent-rigidly)
@@ -1820,11 +1817,11 @@ historical.
 characters case-sensitive when you customize Emacs.  For instance, you
 could make @kbd{M-a} and @kbd{M-A} run different commands.
 
-  Although only the @key{Control} and @key{Meta} modifier keys are
+  Although only the @key{Control} and @key{META} modifier keys are
 commonly used, Emacs supports three other modifier keys.  These are
 called @key{Super}, @key{Hyper}, and @key{Alt}.  Few terminals provide
 ways to use these modifiers; the key labeled @key{Alt} on most
-keyboards usually issues the @key{Meta} modifier, not @key{Alt}.  The
+keyboards usually issues the @key{META} modifier, not @key{Alt}.  The
 standard key bindings in Emacs do not include any characters with
 these modifiers.  However, you can customize Emacs to assign meanings
 to them.  The modifier bits are labeled as @samp{s-}, @samp{H-} and
@@ -1894,7 +1891,7 @@ the numeric keypad produces @code{kp-8}, which is translated to
 such as @kbd{8} or @key{UP}, it affects the equivalent keypad key too.
 However, if you rebind a @samp{kp-} key directly, that won't affect
 its non-keypad equivalent.  Note that the modified keys are not
-translated: for instance, if you hold down the @key{Meta} key while
+translated: for instance, if you hold down the @key{META} key while
 pressing the @samp{8} key on the numeric keypad, that generates
 @kbd{M-@key{kp-8}}.
 
@@ -2162,7 +2159,7 @@ loading of this library, use the option @samp{--no-site-file}.
 better to put them in @file{default.el}, so that users can more easily
 override them.
 
-@cindex @file{site-lisp} directories
+@cindex site-lisp directories
   You can place @file{default.el} and @file{site-start.el} in any of
 the directories which Emacs searches for Lisp libraries.  The variable
 @code{load-path} (@pxref{Lisp Libraries}) specifies these directories.
@@ -2240,8 +2237,8 @@ sequences are mandatory.
 
 @samp{\C-} can be used as a prefix for a control character, as in
 @samp{\C-s} for @acronym{ASCII} control-S, and @samp{\M-} can be used as a prefix for
-a Meta character, as in @samp{\M-a} for @kbd{@key{Meta}-A} or
-@samp{\M-\C-a} for @kbd{@key{Ctrl}-@key{Meta}-A}.
+a Meta character, as in @samp{\M-a} for @kbd{@key{META}-A} or
+@samp{\M-\C-a} for @kbd{@key{Ctrl}-@key{META}-A}.
 
 @xref{Init Non-ASCII}, for information about including
 non-@acronym{ASCII} in your init file.
diff --git a/doc/emacs/dired.texi b/doc/emacs/dired.texi
index f99377d1f7..b924a6d16b 100644
--- a/doc/emacs/dired.texi
+++ b/doc/emacs/dired.texi
@@ -1240,7 +1240,7 @@ contents of the corresponding subdirectory.
   If you use @kbd{C-x d} or some other Dired command to visit a
 directory that is already being shown in a Dired buffer, Dired
 switches to that buffer but does not update it.  If the buffer is not
-up-to-date, Dired displays a warning telling you to type @kbd{g} to
+up-to-date, Dired displays a warning telling you to type @key{g} to
 update it.  You can also tell Emacs to revert each Dired buffer
 automatically when you revisit it, by setting the variable
 @code{dired-auto-revert-buffer} to a non-@code{nil} value.
@@ -1370,8 +1370,8 @@ C-c}.
 
 @node Image-Dired
 @section Viewing Image Thumbnails in Dired
-@cindex @code{image-dired} mode
-@cindex @code{image-dired}
+@cindex image-dired mode
+@cindex image-dired
 
   Image-Dired is a facility for browsing image files.  It provides viewing
 the images either as thumbnails or in full size, either inside Emacs
diff --git a/doc/emacs/display.texi b/doc/emacs/display.texi
index 42a5227983..64a1d4b5fa 100644
--- a/doc/emacs/display.texi
+++ b/doc/emacs/display.texi
@@ -526,7 +526,7 @@ frames as if they have a dark background, whereas a value of
 background.
 
 @cindex background color
-@cindex @code{default face}
+@cindex default face
   You can customize a face to alter its attributes, and save those
 customizations for future Emacs sessions.  @xref{Face Customization},
 for details.
@@ -535,7 +535,7 @@ for details.
 of its attributes are specified.  Its background color is also used as
 the frame's background color.  @xref{Colors}.
 
-@cindex @code{cursor} face
+@cindex cursor face
   Another special face is the @code{cursor} face.  On graphical
 displays, the background color of this face is used to draw the text
 cursor.  None of the other attributes of this face have any effect;
@@ -627,10 +627,10 @@ but you should not make it a variable-width font.
 @item fixed-pitch-serif
 This face is like @code{fixed-pitch}, except the font has serifs and
 looks more like traditional typewriting.
-@cindex @code{variable-pitch} face
+@cindex variable-pitch face
 @item variable-pitch
 This face forces use of a variable-width font.
-@cindex @code{shadow} face
+@cindex shadow face
 @item shadow
 This face is used for making the text less noticeable than the surrounding
 ordinary text.  Usually this can be achieved by using shades of gray in
@@ -656,8 +656,8 @@ This face is used to highlight lazy matches for Isearch and Query
 Replace (matches other than the current one).
 @item region
 This face is used for displaying an active region (@pxref{Mark}).
-When Emacs is built with GTK+ support, its colors are taken from the
-current GTK+ theme.
+When Emacs is built with GTK support, its colors are taken from the
+current GTK theme.
 @item secondary-selection
 This face is used for displaying a secondary X selection (@pxref{Secondary
 Selection}).
@@ -685,40 +685,40 @@ frame:
 
 @table @code
 @item mode-line
-@cindex @code{mode-line} face
+@cindex mode-line face
 @cindex faces for mode lines
 This face is used for the mode line of the currently selected window,
 and for menu bars when toolkit menus are not used.  By default, it's
 drawn with shadows for a raised effect on graphical displays, and
 drawn as the inverse of the default face on non-windowed terminals.
 @item mode-line-inactive
-@cindex @code{mode-line-inactive} face
+@cindex mode-line-inactive face
 Like @code{mode-line}, but used for mode lines of the windows other
 than the selected one (if @code{mode-line-in-non-selected-windows} is
 non-@code{nil}).  This face inherits from @code{mode-line}, so changes
 in that face affect mode lines in all windows.
 @item mode-line-highlight
-@cindex @code{mode-line-highlight} face
+@cindex mode-line-highlight face
 Like @code{highlight}, but used for mouse-sensitive portions of text
 on mode lines.  Such portions of text typically pop up tooltips
 (@pxref{Tooltips}) when the mouse pointer hovers above them.
 @item mode-line-buffer-id
-@cindex @code{mode-line-buffer-id} face
+@cindex mode-line-buffer-id face
 This face is used for buffer identification parts in the mode line.
 @item header-line
-@cindex @code{header-line} face
+@cindex header-line face
 Similar to @code{mode-line} for a window's header line, which appears
 at the top of a window just as the mode line appears at the bottom.
 Most windows do not have a header line---only some special modes, such
 Info mode, create one.
 @item header-line-highlight
-@cindex @code{header-line-highlight} face
+@cindex header-line-highlight face
 Similar to @code{highlight} and @code{mode-line-highlight}, but used
 for mouse-sensitive portions of text on header lines.  This is a
 separate face because the @code{header-line} face might be customized
 in a way that does not interact well with @code{highlight}.
 @item vertical-border
-@cindex @code{vertical-border} face
+@cindex vertical-border face
 This face is used for the vertical divider between windows on text
 terminals.
 @item minibuffer-prompt
@@ -741,7 +741,7 @@ The @code{:background} attribute of this face specifies the color of
 the text cursor.  @xref{Cursor Display}.
 @item tooltip
 This face is used for tooltip text.  By default, if Emacs is built
-with GTK+ support, tooltips are drawn via GTK+ and this face has no
+with GTK support, tooltips are drawn via GTK and this face has no
 effect.  @xref{Tooltips}.
 @item mouse
 This face determines the color of the mouse pointer.
@@ -971,7 +971,7 @@ version.)
 Highlight text that matches @var{regexp} using face @var{face}
 (@code{highlight-regexp}).  The highlighting will remain as long as
 the buffer is loaded.  For example, to highlight all occurrences of
-the word ``whim'' using the default face (a yellow background), type
+the word ``whim'' using the default face (a yellow background)
 @kbd{M-s h r whim @key{RET} @key{RET}}.  Any face can be used for
 highlighting, Hi Lock provides several of its own and these are
 pre-loaded into a list of default values.  While being prompted
@@ -1177,7 +1177,7 @@ empty lines at the end of a buffer, without realizing it.  In most
 cases, this @dfn{trailing whitespace} has no effect, but sometimes it
 can be a nuisance.
 
-@cindex @code{trailing-whitespace} face
+@cindex trailing-whitespace face
   You can make trailing whitespace at the end of a line visible by
 setting the buffer-local variable @code{show-trailing-whitespace} to
 @code{t}.  Then Emacs displays trailing whitespace, using the face
@@ -1258,7 +1258,7 @@ Highlight empty lines.
 @item big-indent
 @vindex whitespace-big-indent-regexp
 Highlight too-deep indentation.  By default any sequence of at least 4
-consecutive tab characters or 32 consecutive space characters is
+consecutive TAB characters or 32 consecutive SPC characters is
 highlighted.  To change that, customize the regular expression
 @code{whitespace-big-indent-regexp}.
 
@@ -1508,8 +1508,8 @@ as octal escape sequences instead of caret escape sequences.
 @cindex non-breaking space
 @cindex non-breaking hyphen
 @cindex soft hyphen
-@cindex @code{escape-glyph} face
-@cindex @code{nobreak-space} face
+@cindex escape-glyph face
+@cindex nobreak-space face
   Some non-@acronym{ASCII} characters have the same appearance as an
 @acronym{ASCII} space or hyphen (minus) character.  Such characters
 can cause problems if they are entered into a buffer without your
@@ -1531,7 +1531,7 @@ elisp, The Emacs Lisp Reference Manual}.
 
 @cindex glyphless characters
 @cindex characters with no font glyphs
-@cindex @code{glyphless-char} face
+@cindex glyphless-char face
   On graphical displays, some characters may have no glyphs in any of
 the fonts available to Emacs.  These @dfn{glyphless characters} are
 normally displayed as boxes containing the hexadecimal character code.
@@ -1546,7 +1546,7 @@ for details.
 
 @cindex curly quotes, and terminal capabilities
 @cindex curved quotes, and terminal capabilities
-@cindex @code{homoglyph} face
+@cindex homoglyph face
 
 Emacs tries to determine if the curved quotes @samp{‘} and @samp{’}
 can be displayed on the current display.  By default, if this seems to
@@ -1649,8 +1649,8 @@ Emacs can display long lines by @dfn{truncation}.  This means that all
 the characters that do not fit in the width of the screen or window do
 not appear at all.  On graphical displays, a small straight arrow in
 the fringe indicates truncation at either end of the line.  On text
-terminals, this is indicated with @samp{$} signs in the rightmost
-and/or leftmost columns.
+terminals, this is indicated with @samp{$} signs in the leftmost
+and/or rightmost columns.
 
 @vindex truncate-lines
 @findex toggle-truncate-lines
@@ -1676,9 +1676,8 @@ line truncation.  @xref{Split Window}, for the variable
 @dfn{word wrap}.  Here, each long logical line is divided into two or
 more screen lines, like in ordinary line continuation.  However, Emacs
 attempts to wrap the line at word boundaries near the right window
-edge.  (If the line's direction is right-to-left, it is wrapped at the
-left window edge instead.)  This makes the text easier to read, as
-wrapping does not occur in the middle of words.
+edge.  This makes the text easier to read, as wrapping does not occur
+in the middle of words.
 
 @cindex mode, Visual Line
 @cindex Visual Line mode
@@ -1689,8 +1688,8 @@ To turn on Visual Line mode in the current buffer, type @kbd{M-x
 visual-line-mode}; repeating this command turns it off.  You can also
 turn on Visual Line mode using the menu bar: in the Options menu,
 select the @samp{Line Wrapping in this Buffer} submenu, followed by
-the @samp{Word Wrap (Visual Line mode)} menu item.  While Visual Line
-mode is enabled, the mode line shows the string @samp{wrap} in the
+the @samp{Word Wrap (Visual Line Mode)} menu item.  While Visual Line
+mode is enabled, the mode-line shows the string @samp{wrap} in the
 mode display.  The command @kbd{M-x global-visual-line-mode} toggles
 Visual Line mode in all buffers.
 
@@ -1802,7 +1801,7 @@ may wish to customize the variables
 @code{display-line-numbers-width} to a large enough value, to avoid
 occasional miscalculations of space reserved for the line numbers.
 
-@cindex @code{line-number} face
+@cindex line-number face
 The line numbers are displayed in a special face @code{line-number}.
 The current line number is displayed in a different face,
 @code{line-number-current-line}, so you can make the current line's
diff --git a/doc/emacs/emacs.texi b/doc/emacs/emacs.texi
index a9be170241..e289cb5802 100644
--- a/doc/emacs/emacs.texi
+++ b/doc/emacs/emacs.texi
@@ -1223,8 +1223,8 @@ GTK resources
 
 * GTK Resource Basics::   Basic usage of GTK+ resources.
 * GTK Widget Names::      How GTK+ widgets are named.
-* GTK Names in Emacs::    GTK+ widgets used by Emacs.
-* GTK styles::            What can be customized in a GTK+ widget.
+* GTK Names in Emacs::    GTK widgets used by Emacs.
+* GTK styles::            What can be customized in a GTK widget.
 
 Emacs and macOS / GNUstep
 
diff --git a/doc/emacs/files.texi b/doc/emacs/files.texi
index 034a4edfd6..3fc0dc915e 100644
--- a/doc/emacs/files.texi
+++ b/doc/emacs/files.texi
@@ -281,7 +281,7 @@ files.  Firstly, when Emacs is built with a suitable GUI toolkit,
 commands invoked with the mouse (by clicking on the menu bar or tool
 bar) use the toolkit's standard file selection dialog instead of
 prompting for the file name in the minibuffer.  On GNU/Linux and Unix
-platforms, Emacs does this when built with GTK+, LessTif, and Motif
+platforms, Emacs does this when built with GTK, LessTif, and Motif
 toolkits; on MS-Windows and Mac, the GUI version does that by default.
 For information on how to customize this, see @ref{Dialog Boxes}.
 
@@ -400,14 +400,11 @@ possible responses are analogous to those of @code{query-replace}:
 
 @table @kbd
 @item y
-@item @key{SPC}
 Save this buffer and ask about the rest of the buffers.
 @item n
-@item @key{DEL}
 Don't save this buffer, but ask about the rest of the buffers.
 @item !
 Save this buffer and all the rest with no more questions.
-@item q
 @c following generates acceptable underfull hbox
 @item @key{RET}
 Terminate @code{save-some-buffers} without any more saving.
@@ -1860,7 +1857,7 @@ variable @code{tramp-mode} to @code{nil}.  You can turn off the
 feature in individual cases by quoting the file name with @samp{/:}
 (@pxref{Quoted File Names}).
 
-@cindex @code{ange-ftp}
+@cindex ange-ftp
   Remote file access through FTP is handled by the Ange-FTP package, which
 is documented in the following.  Remote file access through the other
 methods is handled by the Tramp package, which has its own manual.
diff --git a/doc/emacs/fixit.texi b/doc/emacs/fixit.texi
index 0cb8565c6a..7cacac4240 100644
--- a/doc/emacs/fixit.texi
+++ b/doc/emacs/fixit.texi
@@ -149,12 +149,6 @@ Transpose two words (@code{transpose-words}).
 Transpose two balanced expressions (@code{transpose-sexps}).
 @item C-x C-t
 Transpose two lines (@code{transpose-lines}).
-@item M-x transpose-sentences
-Transpose two sentences (@code{transpose-sentences}).
-@item M-x transpose-paragraphs
-Transpose two paragraphs (@code{transpose-paragraphs}).
-@item M-x transpose-regions
-Transpose two regions.
 @end table
 
 @kindex C-t
@@ -189,14 +183,10 @@ punctuation characters between the words do not move.  For example,
 @samp{@w{BAR FOO,}}.  When point is at the end of the line, it will
 transpose the word before point with the first word on the next line.
 
-@findex transpose-sentences
-@findex transpose-paragraphs
   @kbd{C-M-t} (@code{transpose-sexps}) is a similar command for
 transposing two expressions (@pxref{Expressions}), and @kbd{C-x C-t}
-(@code{transpose-lines}) exchanges lines.  @kbd{M-x
-transpose-sentences} and @kbd{M-x transpose-paragraphs} transpose
-sentences and paragraphs, respectively.  These commands work like
-@kbd{M-t} except as regards the units of text they transpose.
+(@code{transpose-lines}) exchanges lines.  They work like @kbd{M-t}
+except as regards the units of text they transpose.
 
   A numeric argument to a transpose command serves as a repeat count: it
 tells the transpose command to move the character (or word or
@@ -214,15 +204,6 @@ otherwise a command with a repeat count of zero would do nothing): to
 transpose the character (or word or expression or line) ending after
 point with the one ending after the mark.
 
-@findex transpose-regions
-  @kbd{M-x transpose-regions} transposes the text between point and
-mark with the text between the last two marks pushed to the mark ring
-(@pxref{Setting Mark}).  With a numeric prefix argument, it transposes
-the text between point and mark with the text between two successive
-marks that many entries back in the mark ring.  This command is best
-used for transposing multiple characters (or words or sentences or
-paragraphs) in one go.
-
 @node Fixing Case
 @section Case Conversion
 
diff --git a/doc/emacs/frames.texi b/doc/emacs/frames.texi
index 35ffe95e49..84e0fb2d25 100644
--- a/doc/emacs/frames.texi
+++ b/doc/emacs/frames.texi
@@ -200,13 +200,13 @@ buffers are scrolled.  The variable
 @code{mouse-wheel-progressive-speed} determines whether the scroll
 speed is linked to how fast you move the wheel.
 
-@vindex mouse-wheel-tilt-scroll
-@vindex mouse-wheel-flip-direction
+@vindex mwheel-tilt-scroll-p
+@vindex mwheel-flip-direction
 Emacs can also support horizontal scrolling if your mouse's wheel can
 be tilted.  This feature is off by default; the variable
-@code{mouse-wheel-tilt-scroll} turns it on.  If you'd like to reverse
-the direction of horizontal scrolling, customize the variable
-@code{mouse-wheel-flip-direction} to a non-@code{nil} value.
+@code{mwheel-tilt-scroll-p} turns it on.  If you'd like to reverse the
+direction of horizontal scrolling, customize the variable
+@code{mwheel-flip-direction} to a non-@code{nil} value.
 
 
 @node Word and Line Mouse
@@ -472,14 +472,14 @@ cycles through all the frames on your terminal.
 @findex delete-other-frames
 Delete all frames on the current terminal, except the selected one.
 
-@item M-@key{F10}
-@kindex M-F10
+@item M-<F10>
+@kindex M-<F10>
 @findex toggle-frame-maximized
 Toggle the maximization state of the current frame.  When a frame is
 maximized, it fills the screen.
 
-@item @key{F11>}
-@kindex F11
+@item <F11>
+@kindex <F11>
 @findex toggle-frame-fullscreen
 Toggle full-screen mode for the current frame.  (The difference
 between full-screen and maximized is normally that the former
@@ -894,7 +894,7 @@ that server's selected frame.
 
 @node Frame Parameters
 @section Frame Parameters
-@vindex default-frame-alist
+@cindex default-frame-alist
 
   You can control the default appearance and behavior of all frames by
 specifying a default list of @dfn{frame parameters} in the variable
@@ -918,7 +918,7 @@ default font to @samp{Monospace-10}:
   For a list of frame parameters and their effects, see @ref{Frame
 Parameters,,, elisp, The Emacs Lisp Reference Manual}.
 
-@vindex initial-frame-alist
+@cindex initial-frame-alist
   You can also specify a list of frame parameters which apply to just
 the initial frame, by customizing the variable
 @code{initial-frame-alist}.
@@ -992,11 +992,11 @@ end of the buffer is shown; if @code{nil}, the thumb will be at the
 bottom when the end of the buffer is shown.  You cannot over-scroll
 when the entire buffer is visible.
 
-@cindex @code{scroll-bar} face
+@cindex scroll-bar face
   The visual appearance of the scroll bars is controlled by the
-@code{scroll-bar} face.  (Some toolkits, such as GTK+ and MS-Windows,
+@code{scroll-bar} face.  (Some toolkits, such as GTK and MS-Windows,
 ignore this face; the scroll-bar appearance there can only be
-customized system-wide, for GTK+ @pxref{GTK resources}).
+customized system-wide, for GTK @pxref{GTK resources}).
 
 @cindex vertical border
   On graphical frames, vertical scroll bars implicitly serve to separate
diff --git a/doc/emacs/glossary.texi b/doc/emacs/glossary.texi
index 2d2f14efda..94f2c27cbc 100644
--- a/doc/emacs/glossary.texi
+++ b/doc/emacs/glossary.texi
@@ -29,7 +29,7 @@ Alt is the name of a modifier bit that a keyboard input character may
 have.  To make a character Alt, type it while holding down the @key{Alt}
 key.  Such characters are given names that start with @kbd{@key{Alt}-}
 (usually written @kbd{A-} for short).  (Note that many terminals have a
-key labeled @key{Alt} that is really a @key{Meta} key.)  @xref{User
+key labeled @key{Alt} that is really a @key{META} key.)  @xref{User
 Input, Alt}.
 
 @item Argument
@@ -103,14 +103,13 @@ supports both of these forms, as well as any mixture of them---this
 is ``bidirectional text''.  @xref{Bidirectional Editing}.
 
 @item Bind
-@anchor{Glossary---Bind}
 To bind a key sequence means to give it a binding (q.v.).
 @xref{Rebinding}.
 
 @anchor{Glossary---Binding}
 @item Binding
 A key sequence gets its meaning in Emacs by having a binding, which is a
-command (q.v.)---a Lisp function that is run when you type that
+command (q.v.), a Lisp function that is run when you type that
 sequence.  @xref{Commands,Binding}.  Customization often involves
 rebinding a character to a different command function.  The bindings of
 all key sequences are recorded in the keymaps (q.v.).  @xref{Keymaps}.
@@ -142,8 +141,8 @@ are visiting (q.v.@:) some file.  @xref{Buffers}.
 
 @item Buffer Selection History
 Emacs keeps a buffer selection history that records how recently each
-Emacs buffer has been selected.  This is used for choosing which
-buffer to select.  @xref{Buffers}.
+Emacs buffer has been selected.  This is used for choosing a buffer to
+select.  @xref{Buffers}.
 
 @item Bug
 A bug is an incorrect or unreasonable behavior of a program, or
@@ -174,7 +173,7 @@ misspelling.
 
 @item @kbd{C-M-}
 @kbd{C-M-} in the name of a character is an abbreviation for
-Control-Meta.  If your terminal lacks a real @key{Meta} key, you type
+Control-Meta.  If your terminal lacks a real @key{META} key, you type
 a Control-Meta character by typing @key{ESC} and then typing the
 corresponding Control character.  @xref{User Input,C-M-}.
 
@@ -221,9 +220,9 @@ the clipboard is used @emph{instead} of the primary selection.
 @xref{Clipboard}.
 
 @item Coding System
-A coding system is a way to encode text characters in a file or in a
-stream of information.  Emacs has the ability to convert text to or
-from a variety of coding systems when reading or writing it.
+A coding system is an encoding for representing text characters in a
+file or in a stream of information.  Emacs has the ability to convert
+text to or from a variety of coding systems when reading or writing it.
 @xref{Coding Systems}.
 
 @item Command
@@ -264,12 +263,12 @@ executes faster.
 
 @item Complete Key
 A complete key is a key sequence that fully specifies one action to be
-performed by Emacs.  For example, @kbd{X} and @kbd{C-f} and @kbd{C-x
-m} are complete keys.  Complete keys derive their meanings from being
-bound (@pxref{Glossary---Bind}) to commands (q.v.).  Thus, @kbd{X} is
-conventionally bound to a command to insert @samp{X} in the buffer;
-@kbd{C-x m} is conventionally bound to a command to begin composing a
-mail message.  @xref{Keys}.
+performed by Emacs.  For example, @kbd{X} and @kbd{C-f} and @kbd{C-x m}
+are complete keys.  Complete keys derive their meanings from being bound
+(q.v.@:) to commands (q.v.).  Thus, @kbd{X} is conventionally bound to
+a command to insert @samp{X} in the buffer; @kbd{C-x m} is
+conventionally bound to a command to begin composing a mail message.
+@xref{Keys}.
 
 @item Completion
 Completion is what Emacs does when it automatically expands an
@@ -282,11 +281,11 @@ file names.  Completion usually occurs when @key{TAB}, @key{SPC} or
 @anchor{Glossary---Continuation Line}
 @item Continuation Line
 When a line of text is longer than the width of the window, it
-normally takes up more than one screen line when displayed (but see
-@ref{Glossary---Truncation}).  We say that the text line is continued,
-and all screen lines used for it after the first are called
-continuation lines.  @xref{Continuation Lines}.  A related Emacs
-feature is filling (q.v.).
+normally (but see @ref{Glossary---Truncation}) takes up more than one
+screen line when displayed.  We say that the text line is continued, and all
+screen lines used for it after the first are called continuation
+lines.  @xref{Continuation Lines}.  A related Emacs feature is
+filling (q.v.).
 
 @item Control Character
 A control character is a character that you type by holding down the
@@ -419,7 +418,7 @@ Variables}.
 On GNU and other Unix-like systems, directory names are strings that
 end in @samp{/}.  For example, @file{/no-such-dir/} is a directory
 name whereas @file{/tmp} is not, even though @file{/tmp} names a file
-that happens to be a directory.  On MS-Windows the relationship is more
+that happens to be a directory.  On MS-DOS the relationship is more
 complicated.  @xref{Directory Names,,, elisp, the Emacs Lisp Reference
 Manual}.
 
@@ -507,7 +506,7 @@ Such messages appear in the echo area, accompanied by a beep.
 
 @item @key{ESC}
 @key{ESC} is a character used as a prefix for typing Meta characters on
-keyboards lacking a @key{Meta} key.  Unlike the @key{Meta} key (which,
+keyboards lacking a @key{META} key.  Unlike the @key{META} key (which,
 like the @key{SHIFT} key, is held down while another character is
 typed), you press the @key{ESC} key as you would press a letter key, and
 it applies to the next character you type.
@@ -720,11 +719,10 @@ customizing the various hooks, you can modify Emacs's behavior without
 changing any of its code.  @xref{Hooks}.
 
 @item Hyper
-Hyper is the name of a modifier bit that a keyboard input character
-may have.  To make a character Hyper, type it while holding down the
+Hyper is the name of a modifier bit that a keyboard input character may
+have.  To make a character Hyper, type it while holding down the
 @key{Hyper} key.  Such characters are given names that start with
-@kbd{Hyper-} (usually written @kbd{H-} for short).  @xref{Modifier
-Keys}.
+@kbd{Hyper-} (usually written @kbd{H-} for short).  @xref{User Input}.
 
 @item i.e.
 Short for ``id est'' in Latin, which means ``that is''.
@@ -881,7 +879,7 @@ A local value of a variable (q.v.@:) applies to only one buffer.
 @xref{Locals}.
 
 @item @kbd{M-}
-@kbd{M-} in the name of a character is an abbreviation for @key{Meta},
+@kbd{M-} in the name of a character is an abbreviation for @key{META},
 one of the modifier keys that can accompany any character.
 @xref{User Input,M-}.
 
@@ -939,15 +937,15 @@ a keyboard interface to navigate it.  @xref{Menu Bars}.
 
 @item Meta
 Meta is the name of a modifier bit which you can use in a command
-character.  To enter a meta character, you hold down the @key{Meta}
+character.  To enter a meta character, you hold down the @key{META}
 key while typing the character.  We refer to such characters with
 names that start with @kbd{Meta-} (usually written @kbd{M-} for
-short).  For example, @kbd{M-<} is typed by holding down @key{Meta}
+short).  For example, @kbd{M-<} is typed by holding down @key{META}
 and at the same time typing @kbd{<} (which itself is done, on most
 terminals, by holding down @key{SHIFT} and typing @kbd{,}).
 @xref{User Input,Meta}.
 
-On some terminals, the @key{Meta} key is actually labeled @key{Alt}
+On some terminals, the @key{META} key is actually labeled @key{Alt}
 or @key{Edit}.
 
 @item Meta Character
@@ -1091,9 +1089,8 @@ The primary selection is one particular X selection (q.v.); it is the
 selection that most X applications use for transferring text to and from
 other applications.
 
-The Emacs commands that mark or select text set the primary selection,
-and clicking the mouse inserts text from the primary selection when
-appropriate.  @xref{Shift Selection}.
+The Emacs kill commands set the primary selection and the yank command
+uses the primary selection when appropriate.  @xref{Killing}.
 
 @item Prompt
 A prompt is text used to ask you for input.  Displaying a prompt
@@ -1344,11 +1341,10 @@ which characters balance each other like parentheses, etc.
 Manual}.
 
 @item Super
-Super is the name of a modifier bit that a keyboard input character
-may have.  To make a character Super, type it while holding down the
+Super is the name of a modifier bit that a keyboard input character may
+have.  To make a character Super, type it while holding down the
 @key{SUPER} key.  Such characters are given names that start with
-@kbd{Super-} (usually written @kbd{s-} for short).  @xref{Modifier
-Keys}.
+@kbd{Super-} (usually written @kbd{s-} for short).  @xref{User Input}.
 
 @item Suspending
 Suspending Emacs means stopping it temporarily and returning control
@@ -1495,13 +1491,13 @@ Emacs divides a frame (q.v.@:) into one or more windows, each of which
 can display the contents of one buffer (q.v.@:) at any time.
 @xref{Screen}, for basic information on how Emacs uses the screen.
 @xref{Windows}, for commands to control the use of windows.  Some
-other editors use the term ``window'' for what we call a ``frame'' in
-Emacs.
+other editors use the term ``window'' for what we call a ``frame''
+(q.v.@:) in Emacs.
 
 @item Window System
 A window system is software that operates on a graphical display
-(q.v.), to subdivide the screen so that multiple applications can have
-their own windows at the same time.  All modern operating systems
+(q.v.), to subdivide the screen so that multiple applications can
+have their] own windows at the same time.  All modern operating systems
 include a window system.
 
 @item Word Abbrev
diff --git a/doc/emacs/help.texi b/doc/emacs/help.texi
index a5700760d4..e005fe358d 100644
--- a/doc/emacs/help.texi
+++ b/doc/emacs/help.texi
@@ -4,6 +4,7 @@
 @c See file emacs.texi for copying conditions.
 @node Help
 @chapter Help
+@kindex Help
 @cindex help
 @cindex self-documentation
 @findex help-command
diff --git a/doc/emacs/killing.texi b/doc/emacs/killing.texi
index 4c47c8b047..19aa9077d7 100644
--- a/doc/emacs/killing.texi
+++ b/doc/emacs/killing.texi
@@ -590,7 +590,7 @@ you can access it using the following Emacs commands:
 @table @kbd
 @findex mouse-set-secondary
 @kindex M-Drag-mouse-1
-@cindex @code{secondary-selection} face
+@cindex secondary-selection face
 @item M-Drag-mouse-1
 Set the secondary selection, with one end at the place where you press
 down the button, and the other end at the place where you release it
@@ -857,8 +857,7 @@ region is active.
 
 Unlike the standard region, the region-rectangle can have its corners
 extended past the end of buffer, or inside stretches of white space
-that point normally cannot enter, like in the middle of a TAB
-character.
+that point normally cannot enter, like the TAB.
 
 @findex rectangle-exchange-point-and-mark
 @findex exchange-point-and-mark@r{, in rectangle-mark-mode}
diff --git a/doc/emacs/macos.texi b/doc/emacs/macos.texi
index 4982c78f2e..bf37d67b64 100644
--- a/doc/emacs/macos.texi
+++ b/doc/emacs/macos.texi
@@ -35,7 +35,7 @@ Support}), but we hope to improve it in the future.
 @section Basic Emacs usage under macOS and GNUstep
 
   By default, the @key{Alt} and @key{Option} keys are the same as
-@key{Meta}.  The Mac @key{Cmd} key is the same as @key{Super}, and
+@key{META}.  The Mac @key{Cmd} key is the same as @key{Super}, and
 Emacs provides a set of key bindings using this modifier key that mimic
 other Mac / GNUstep applications (@pxref{Mac / GNUstep Events}).  You
 can change these bindings in the usual way (@pxref{Key Bindings}).
diff --git a/doc/emacs/maintaining.texi b/doc/emacs/maintaining.texi
index 824f1b0f7f..29ded9e3a3 100644
--- a/doc/emacs/maintaining.texi
+++ b/doc/emacs/maintaining.texi
@@ -628,7 +628,7 @@ they use the concept of checking out individual files.
 @node Log Buffer
 @subsection Features of the Log Entry Buffer
 
-@kindex C-c C-c @r{(Log Edit mode)}
+@cindex C-c C-c @r{(Log Edit mode)}
 @findex log-edit-done
   When you tell VC to commit a change, it pops up a buffer named
 @file{*vc-log*}.  In this buffer, you should write a @dfn{log entry}
@@ -1078,7 +1078,7 @@ Revert the work file(s) in the current VC fileset to the last revision
 @findex vc-revert
 @vindex vc-revert-show-diff
   If you want to discard all the changes you have made to the current
-VC fileset, type @kbd{C-x v u} (@code{vc-revert}).  This shows
+VC fileset, type @kbd{C-x v u} (@code{vc-revert-buffer}).  This shows
 you a diff between the work file(s) and the revision from which you
 started editing, and asks for confirmation for discarding the changes.
 If you agree, the fileset is reverted.  If you don't want @kbd{C-x v
@@ -1812,8 +1812,6 @@ Find definition of identifier, and display it in a new frame
 @item M-,
 Go back to where you previously invoked @kbd{M-.} and friends
 (@code{xref-pop-marker-stack}).
-@item M-x xref-etags-mode
-Switch @code{xref} to use the @code{etags} backend.
 @end table
 
 @kindex M-.
@@ -1873,20 +1871,6 @@ where you were with @kbd{M-,}.  @kbd{M-,} allows you to retrace your
 steps to a depth determined by the variable
 @code{xref-marker-ring-length}, which defaults to 16.
 
-@findex xref-etags-mode
-  Some major modes install @code{xref} support facilities that might
-sometimes fail to find certain identifiers.  For example, in Emacs
-Lisp mode (@pxref{Lisp Eval}) @kbd{M-.} will by default find only
-functions and variables from Lisp packages which are loaded into the
-current Emacs session or are auto-loaded (@pxref{Autoload,,, elisp,
-The Emacs Lisp Reference Manual}).  If @kbd{M-.} fails to find some
-identifiers, you can try forcing @code{xref} to use the @code{etags}
-backend (@pxref{Xref}).  To this end, turn on the Xref Etags minor
-mode with @w{@kbd{M-x xref-etags-mode}}, then invoke @kbd{M-.} again.
-(For this to work, be sure to run @command{etags} to create the tags
-table in the directory tree of the source files, see @ref{Create Tags
-Table}.)
-
 @node Xref Commands
 @subsubsection Commands Available in the @file{*xref*} Buffer
 @cindex commands in @file{*xref*} buffers
diff --git a/doc/emacs/mini.texi b/doc/emacs/mini.texi
index 0dd7cde6cf..8278de7f31 100644
--- a/doc/emacs/mini.texi
+++ b/doc/emacs/mini.texi
@@ -337,6 +337,12 @@ window.  You can display the same list with @kbd{?}
 used with the completion list:
 
 @table @kbd
+@findex mouse-choose-completion
+@item mouse-1
+@itemx mouse-2
+Clicking mouse button 1 or 2 on a completion alternative chooses it
+(@code{mouse-choose-completion}).
+
 @findex switch-to-completions
 @item M-v
 @itemx @key{PageUp}
@@ -349,32 +355,18 @@ the same.  You can also select the window in other ways
 
 @findex choose-completion
 @item @key{RET}
-@itemx mouse-1
-@itemx mouse-2
 While in the completion list buffer, this chooses the completion at
 point (@code{choose-completion}).
 
 @findex next-completion
-@item @key{TAB}
 @item @key{RIGHT}
-While in the completion list buffer, these keys move point to the
-following completion alternative (@code{next-completion}).
+While in the completion list buffer, this moves point to the following
+completion alternative (@code{next-completion}).
 
 @findex previous-completion
-@item @key{S-TAB}
 @item @key{LEFT}
-While in the completion list buffer, these keys move point to the
-previous completion alternative (@code{previous-completion}).
-
-@findex quit-window
-@item @kbd{q}
-While in the completion list buffer, this quits the window showing it
-and selects the window showing the minibuffer (@code{quit-window}).
-
-@findex kill-current-buffer
-@item @kbd{z}
-While in the completion list buffer, kill it and delete the window
-showing it (@code{kill-current-buffer}).
+While in the completion list buffer, this moves point to the previous
+completion alternative (@code{previous-completion}).
 @end table
 
 @node Completion Exit
diff --git a/doc/emacs/misc.texi b/doc/emacs/misc.texi
index 68bd308983..d8f202f684 100644
--- a/doc/emacs/misc.texi
+++ b/doc/emacs/misc.texi
@@ -409,7 +409,7 @@ is needed.  For OpenDocument and Microsoft Office documents, the
 @code{unoconv} tool is needed.}, and displaying those images.
 
 @findex doc-view-toggle-display
-@findex doc-view-minor-mode
+@cindex doc-view-minor-mode
   When you visit a document file that can be displayed with DocView
 mode, Emacs automatically uses DocView mode @footnote{The needed
 external tools for the document type must be available, and Emacs must
@@ -2463,6 +2463,12 @@ sessions, or add this line in your init file (@pxref{Init File}):
 (desktop-save-mode 1)
 @end example
 
+@vindex desktop-auto-save-timeout
+@noindent
+When @code{desktop-save-mode} is active and the desktop file exists,
+Emacs auto-saves it every @code{desktop-auto-save-timeout}
+seconds, if that is non-@code{nil} and non-zero.
+
 @findex desktop-change-dir
 @findex desktop-revert
 @vindex desktop-path
@@ -2529,7 +2535,7 @@ e.g., the daemon cannot use GUI features, so parameters such as frame
 position, size, and decorations cannot be restored.  For that reason,
 you may wish to delay restoring the desktop in daemon mode until the
 first client connects, by calling @code{desktop-read} in a hook
-function that you add to @code{server-after-make-frame-hook}
+function that you add to @code{after-make-frame-functions}
 (@pxref{Creating Frames,,, elisp, The Emacs Lisp Reference Manual}).
 
 @node Recursive Edit
diff --git a/doc/emacs/msdos.texi b/doc/emacs/msdos.texi
index dc282e18d5..e49280e88d 100644
--- a/doc/emacs/msdos.texi
+++ b/doc/emacs/msdos.texi
@@ -116,7 +116,7 @@ invoked---that will always give you an editor.  When invoked via
 the program that invoked @command{emacsclient}.
 @end enumerate
 
-@cindex @command{emacsclient}, on MS-Windows
+@cindex emacsclient, on MS-Windows
 Note that, due to limitations of MS-Windows, Emacs cannot have both
 GUI and text-mode frames in the same session.  It also cannot open
 text-mode frames on more than a single @dfn{Command Prompt} window,
@@ -533,7 +533,7 @@ Windows-specific variables in this category.
 @ifnottex
 @vindex w32-alt-is-meta
 @cindex @code{Alt} key (MS-Windows)
-  By default, the key labeled @key{Alt} is mapped as the @key{Meta}
+  By default, the key labeled @key{Alt} is mapped as the @key{META}
 key.  If you wish it to produce the @code{Alt} modifier instead, set
 the variable @code{w32-alt-is-meta} to a @code{nil} value.
 
@@ -591,8 +591,8 @@ Windows key and @key{R} opens the Windows @code{Run} dialog.
 
   The hotkey registrations always also include all the shift and
 control modifier combinations for the given hotkey; that is,
-registering @kbd{s-a} as a hotkey gives you @kbd{S-s-a},
-@kbd{C-s-a} and @kbd{C-S-s-a} as well.
+registering @kbd{s-@key{a}} as a hotkey gives you @kbd{S-s-@key{a}},
+@kbd{C-s-@key{a}} and @kbd{C-S-s-@key{a}} as well.
 
   On Windows 98 and ME, the hotkey registration is more restricted.
 The desired hotkey must always be fully specified, and
@@ -656,8 +656,8 @@ value other than the above modifier symbols.
 @cindex @code{Alt} key invokes menu (Windows)
   Emacs compiled as a native Windows application normally turns off
 the Windows feature that tapping the @key{Alt} key invokes the Windows
-menu.  The reason is that the @key{Alt} serves as @key{Meta} in Emacs.
-When using Emacs, users often press the @key{Meta} key temporarily and
+menu.  The reason is that the @key{Alt} serves as @key{META} in Emacs.
+When using Emacs, users often press the @key{META} key temporarily and
 then change their minds; if this has the effect of bringing up the
 Windows menu, it alters the meaning of subsequent commands.  Many
 users find this frustrating.
@@ -680,14 +680,14 @@ its normal effect: for example, @kbd{@key{Lwindow}} opens the
 
 @vindex w32-recognize-altgr
 @kindex AltGr @r{(MS-Windows)}
-@cindex @key{AltGr} key (MS-Windows)
+@cindex AltGr key (MS-Windows)
   The variable @code{w32-recognize-altgr} controls whether the
 @key{AltGr} key (if it exists on your keyboard), or its equivalent,
 the combination of the right @key{Alt} and left @key{Ctrl} keys
 pressed together, is recognized as the @key{AltGr} key.  The default
 is @code{t}, which means these keys produce @code{AltGr}; setting it
 to @code{nil} causes @key{AltGr} or the equivalent key combination to
-be interpreted as the combination of @key{Ctrl} and @key{Meta}
+be interpreted as the combination of @key{Ctrl} and @key{META}
 modifiers.
 @end ifnottex
 
diff --git a/doc/emacs/mule.texi b/doc/emacs/mule.texi
index d05ec1afee..01184e2ae1 100644
--- a/doc/emacs/mule.texi
+++ b/doc/emacs/mule.texi
@@ -51,7 +51,7 @@ others.
 @item
 You can insert non-@acronym{ASCII} characters or search for them.  To do that,
 you can specify an input method (@pxref{Select Input Method}) suitable
-for your language, or use the default input method set up when you choose
+for your language, or use the default input method set up when you chose
 your language environment.  If
 your keyboard can produce non-@acronym{ASCII} characters, you can select an
 appropriate keyboard coding system (@pxref{Terminal Coding}), and Emacs
@@ -698,7 +698,7 @@ carriage-return (Mac).
 Describe coding system @var{coding} (@code{describe-coding-system}).
 
 @item C-h C @key{RET}
-Describe the coding systems currently in use (@code{describe-coding-system}).
+Describe the coding systems currently in use.
 
 @item M-x list-coding-systems
 Display a list of all the supported coding systems.
@@ -935,7 +935,7 @@ or a local variables list at the end (@pxref{File Variables}).  You do
 this by defining a value for the ``variable'' named @code{coding}.
 Emacs does not really have a variable @code{coding}; instead of
 setting a variable, this uses the specified coding system for the
-file.  For example, @w{@samp{-*-mode: C; coding: latin-1; -*-}} specifies
+file.  For example, @samp{-*-mode: C; coding: latin-1;-*-} specifies
 use of the Latin-1 coding system, as well as C mode.  When you specify
 the coding explicitly in the file, that overrides
 @code{file-coding-system-alist}.
@@ -1206,13 +1206,13 @@ using the internal Emacs representation.
 @cindex file-name encoding, MS-Windows
 @vindex w32-unicode-filenames
   When Emacs runs on MS-Windows versions that are descendants of the
-NT family (Windows 2000, XP, and all the later versions), the value of
-@code{file-name-coding-system} is largely ignored, as Emacs by default
-uses APIs that allow passing Unicode file names directly.  By
-contrast, on Windows 9X, file names are encoded using
-@code{file-name-coding-system}, which should be set to the codepage
-(@pxref{Coding Systems, codepage}) pertinent for the current system
-locale.  The value of the variable @code{w32-unicode-filenames}
+NT family (Windows 2000, XP, Vista, Windows 7, and all the later
+versions), the value of @code{file-name-coding-system} is largely
+ignored, as Emacs by default uses APIs that allow passing Unicode file
+names directly.  By contrast, on Windows 9X, file names are encoded
+using @code{file-name-coding-system}, which should be set to the
+codepage (@pxref{Coding Systems, codepage}) pertinent for the current
+system locale.  The value of the variable @code{w32-unicode-filenames}
 controls whether Emacs uses the Unicode APIs when it calls OS
 functions that accept file names.  This variable is set by the startup
 code to @code{nil} on Windows 9X, and to @code{t} on newer versions of
@@ -1778,9 +1778,8 @@ of the first character you read precedes that of the next character.
 Reordering of bidirectional text into the @dfn{visual} order happens
 at display time.  As a result, character positions no longer increase
 monotonically with their positions on display.  Emacs implements the
-Unicode Bidirectional Algorithm (UBA) described in the
-@uref{http://unicode.org/reports/tr9/, Unicode Standard Annex #9}, for
-reordering of bidirectional text for display.
+Unicode Bidirectional Algorithm (UBA) described in the Unicode
+Standard Annex #9, for reordering of bidirectional text for display.
 It deviates from the UBA only in how continuation lines are displayed
 when text direction is opposite to the base paragraph direction,
 e.g., when a long line of English text appears in a right-to-left
diff --git a/doc/emacs/programs.texi b/doc/emacs/programs.texi
index 13f4656fe8..6af661ec02 100644
--- a/doc/emacs/programs.texi
+++ b/doc/emacs/programs.texi
@@ -86,14 +86,13 @@ mode for the C programming language is @code{c-mode}.
 @cindex Awk mode
   Emacs has programming language modes for Lisp, Scheme, the
 Scheme-based DSSSL expression language, Ada, ASM, AWK, C, C++,
-Fortran, Icon, IDL (CORBA), IDLWAVE, Java, Javascript, M4, Makefiles,
-Metafont (@TeX{}'s companion for font creation), Modula2, Object
-Pascal, Objective-C, Octave, Pascal, Perl, Pike, PostScript, Prolog,
-Python, Ruby, Simula, SQL, Tcl, Verilog, and VHDL@.  An alternative
-mode for Perl is called CPerl mode.  Modes are also available for the
-scripting languages of the common GNU and Unix shells, and
-MS-Windows @samp{BAT} files, and for makefiles, DNS master
-files, and various sorts of configuration files.
+Fortran, Icon, IDL (CORBA), IDLWAVE, Java, Javascript, Metafont
+(@TeX{}'s companion for font creation), Modula2, Object Pascal, Objective-C,
+Octave, Pascal, Perl, Pike, PostScript, Prolog, Python, Ruby, Simula, Tcl,
+and VHDL@.  An alternative mode for Perl is called CPerl mode.  Modes are
+also available for the scripting languages of the common GNU and Unix
+shells, and MS-Windows @samp{BAT} files, and for makefiles,
+DNS master files, and various sorts of configuration files.
 
   Ideally, Emacs should have a major mode for each programming
 language that you might want to edit.  If it doesn't have a mode for
@@ -816,13 +815,11 @@ options which control the operation of this mode include:
 
 @itemize @bullet
 @item
-@vindex show-paren-highlight-openparen
-@code{show-paren-highlight-openparen} controls whether to highlight
+@code{show-paren-highlight-open-paren} controls whether to highlight
 an open paren when point stands just before it, and hence its position
 is marked by the cursor anyway.  The default is non-@code{nil} (yes).
 
 @item
-@vindex show-paren-style
 @code{show-paren-style} controls whether just the two parens, or also
 the space between them get highlighted.  The valid options here are
 @code{parenthesis} (show the matching paren), @code{expression}
@@ -831,12 +828,10 @@ the space between them get highlighted.  The valid options here are
 expression otherwise).
 
 @item
-@vindex show-paren-when-point-inside-paren
 @code{show-paren-when-point-inside-paren}, when non-@code{nil}, causes
 highlighting also when point is on the inside of a parenthesis.
 
 @item
-@vindex show-paren-when-point-in-periphery
 @code{show-paren-when-point-in-periphery}, when non-@code{nil}, causes
 highlighting also when point is in whitespace at the beginning or end
 of a line, and there is a paren at, respectively, the first or last,
@@ -1013,7 +1008,7 @@ effect as @kbd{C-u M-;} by typing @kbd{M-x comment-kill}
 (@code{comment-dwim} actually calls @code{comment-kill} as a
 subroutine when it is given a prefix argument).
 
-@kindex C-c C-c @r{(C mode)}
+@kindex C-c C-c (C mode)
 @findex comment-region
 @findex uncomment-region
   The command @kbd{M-x comment-region} is equivalent to calling
@@ -1630,7 +1625,7 @@ behind.  A prefix argument acts as a repeat count.  With a negative
 argument, move backward.
 
 @item M-a
-@kindex M-a @r{(C mode)}
+@kindex M-a (C mode)
 @findex c-beginning-of-statement
 Move point to the beginning of the innermost C statement
 (@code{c-beginning-of-statement}).  If point is already at the beginning
@@ -1641,7 +1636,7 @@ In comments or in strings which span more than one line, this command
 moves by sentences instead of statements.
 
 @item M-e
-@kindex M-e @r{(C mode)}
+@kindex M-e (C mode)
 @findex c-end-of-statement
 Move point to the end of the innermost C statement or sentence; like
 @kbd{M-a} except that it moves in the other direction
@@ -1706,17 +1701,17 @@ preprocessor commands.
 @item C-c C-@key{DEL}
 @itemx C-c @key{DEL}
 @findex c-hungry-delete-backwards
-@kindex C-c C-DEL @r{(C Mode)}
-@kindex C-c DEL @r{(C Mode)}
+@kindex C-c C-DEL (C Mode)
+@kindex C-c DEL (C Mode)
 Delete the entire block of whitespace preceding point (@code{c-hungry-delete-backwards}).
 
 @item C-c C-d
 @itemx C-c C-@key{Delete}
 @itemx C-c @key{Delete}
 @findex c-hungry-delete-forward
-@kindex C-c C-d @r{(C Mode)}
-@kindex C-c C-Delete @r{(C Mode)}
-@kindex C-c Delete @r{(C Mode)}
+@kindex C-c C-d (C Mode)
+@kindex C-c C-Delete (C Mode)
+@kindex C-c Delete (C Mode)
 Delete the entire block of whitespace after point (@code{c-hungry-delete-forward}).
 @end table
 
diff --git a/doc/emacs/rmail.texi b/doc/emacs/rmail.texi
index cb62ce3652..e9371f39a9 100644
--- a/doc/emacs/rmail.texi
+++ b/doc/emacs/rmail.texi
@@ -802,7 +802,7 @@ its contents.
 @vindex rmail-enable-mime-composing
 @findex unforward-rmail-message
   Rmail offers two formats for forwarded messages.  The default is to
-use the MIME format (@pxref{Rmail Display}).  This includes the original
+use MIME (@pxref{Rmail Display}) format.  This includes the original
 message as a separate part.  You can use a simpler format if you
 prefer, by setting the variable @code{rmail-enable-mime-composing} to
 @code{nil}.  In this case, Rmail just includes the original message
@@ -1092,7 +1092,7 @@ Sort messages of current Rmail buffer by author's name.
 @findex rmail-sort-by-recipient
 @item C-c C-s C-r
 @itemx M-x rmail-sort-by-recipient
-Sort messages of current Rmail buffer by recipient's name.
+Sort messages of current Rmail buffer by recipient's names.
 
 @findex rmail-sort-by-correspondent
 @item C-c C-s C-c
diff --git a/doc/emacs/search.texi b/doc/emacs/search.texi
index 8ac9794c37..9d7ff59bee 100644
--- a/doc/emacs/search.texi
+++ b/doc/emacs/search.texi
@@ -92,7 +92,7 @@ the first @samp{F} previously found.  After another @kbd{O}, the
 cursor moves to just after the first @samp{FOO}.
 
 @cindex faces for highlighting search matches
-@cindex @code{isearch} face
+@cindex isearch face
   At each step, Emacs highlights the @dfn{current match}---the buffer
 text that matches the search string---using the @code{isearch} face
 (@pxref{Faces}).  @xref{Search Customizations}, for various options
@@ -280,7 +280,7 @@ down-casing.
 @node Error in Isearch
 @subsection Errors in Incremental Search
 
-@cindex @code{isearch-fail} face
+@cindex isearch-fail face
   If your string is not found at all, the echo area says @samp{Failing
 I-Search}, and the cursor moves past the place where Emacs found as
 much of your string as it could.  Thus, if you search for @samp{FOOT},
@@ -437,7 +437,7 @@ of the keymap @code{isearch-mode-map} (@pxref{Keymaps}).
 
 This subsection describes how to control whether typing a command not
 specifically meaningful in searches exits the search before executing
-the command.  It also describes three categories of commands which you
+the command.  It also describes two categories of commands which you
 can type without exiting the current incremental search, even though
 they are not themselves part of incremental search.
 
@@ -446,7 +446,7 @@ they are not themselves part of incremental search.
 search exits the search before executing the command.  Thus, the
 command operates on the buffer from which you invoked the search.
 However, if you customize the variable @code{search-exit-option} to
-@code{append}, the characters which you type that are not interpreted by
+@code{nil}, the characters which you type that are not interpreted by
 the incremental search are simply appended to the search string.  This
 is so you could include in the search string control characters, such
 as @kbd{C-a}, that would normally exit the search and invoke the
@@ -507,18 +507,6 @@ change point, the buffer contents, the match data, the current buffer,
 or the selected window and frame.  The command must not itself attempt
 an incremental search.  This feature is disabled if
 @code{isearch-allow-scroll} is @code{nil} (which it is by default).
-
-@item Motion Commands
-@cindex motion commands, during incremental search
-When @code{search-exit-option} is customized to @code{shift-move},
-you can extend the search string by holding down the shift key while
-typing cursor motion commands.  It will yank text that ends at the new
-position after moving point in the current buffer.
-
-When @code{search-exit-option} is @code{move}, you can extend the
-search string without using the shift key for cursor motion commands,
-but it applies only for certain motion command that have the
-@code{isearch-move} property on their symbols.
 @end table
 
 @node Isearch Minibuffer
@@ -1564,8 +1552,8 @@ replacements are not added to the command history, and cannot be
 reused.
 
 @cindex faces for highlighting query replace
-@cindex @code{query-replace} face
-@cindex @code{lazy-highlight} face, in replace
+@cindex query-replace face
+@cindex lazy-highlight face, in replace
 @vindex query-replace-highlight
 @vindex query-replace-lazy-highlight
 @vindex query-replace-show-replacement
@@ -1881,7 +1869,7 @@ setting the variable @code{search-highlight} to @code{nil}.
 
 @cindex lazy highlighting customizations
 @vindex isearch-lazy-highlight
-@cindex @code{lazy-highlight} face
+@cindex lazy-highlight face
   The other matches for the search string that are visible on display
 are highlighted using the @code{lazy-highlight} face.  Setting the
 variable @code{isearch-lazy-highlight} to @code{nil} disables this
diff --git a/doc/emacs/text.texi b/doc/emacs/text.texi
index 6a5fc7c6f6..d32bb3c768 100644
--- a/doc/emacs/text.texi
+++ b/doc/emacs/text.texi
@@ -117,7 +117,7 @@ cognate to @kbd{C-@@}, which is an alias for @kbd{C-@key{SPC}}.
 @findex backward-word
   The commands @kbd{M-f} (@code{forward-word}) and @kbd{M-b}
 (@code{backward-word}) move forward and backward over words.  These
-@key{Meta}-based key sequences are analogous to the key sequences
+@key{META}-based key sequences are analogous to the key sequences
 @kbd{C-f} and @kbd{C-b}, which move over single characters.  The
 analogy extends to numeric arguments, which serve as repeat counts.
 @kbd{M-f} with a negative argument moves backward, and @kbd{M-b} with
@@ -1331,7 +1331,7 @@ quad click: exit all folds and hide text.
 @c FIXME not marked as a user variable
 @vindex foldout-mouse-modifiers
   You can specify different modifier keys (instead of
-@kbd{@key{Ctrl}-@key{Meta}-}) by setting @code{foldout-mouse-modifiers}; but if
+@kbd{@key{Ctrl}-@key{META}-}) by setting @code{foldout-mouse-modifiers}; but if
 you have already loaded the @file{foldout.el} library, you must reload
 it in order for this to take effect.
 
@@ -1380,19 +1380,19 @@ buffer cycles the visibility of the entire outline structure, between
 (i) showing only top-level heading lines, (ii) showing all heading
 lines but no body lines, and (iii) showing everything.
 
-@kindex M-UP @r{(Org Mode)}
-@kindex M-DOWN @r{(Org Mode)}
-@kindex M-LEFT @r{(Org Mode)}
-@kindex M-RIGHT @r{(Org Mode)}
+@kindex M-<up> @r{(Org Mode)}
+@kindex M-<down> @r{(Org Mode)}
+@kindex M-<left> @r{(Org Mode)}
+@kindex M-<right> @r{(Org Mode)}
 @findex org-metaup
 @findex org-metadown
 @findex org-metaleft
 @findex org-metaright
   You can move an entire entry up or down in the buffer, including its
-body lines and subtree (if any), by typing @kbd{M-@key{UP}}
-(@code{org-metaup}) or @kbd{M-@key{DOWN}} (@code{org-metadown}) on the
+body lines and subtree (if any), by typing @kbd{M-<up>}
+(@code{org-metaup}) or @kbd{M-<down>} (@code{org-metadown}) on the
 heading line.  Similarly, you can promote or demote a heading line
-with @kbd{M-@key{LEFT}} (@code{org-metaleft}) and @kbd{M-@key{RIGHT}}
+with @kbd{M-<left>} (@code{org-metaleft}) and @kbd{M-<right>}
 (@code{org-metaright}).  These commands execute their global bindings
 if invoked on a body line.
 
@@ -1461,9 +1461,8 @@ etc.
 export and publication.  To export the current buffer, type @kbd{C-c
 C-e} (@code{org-export}) anywhere in an Org buffer.  This command
 prompts for an export format; currently supported formats include
-HTML, @LaTeX{}, Texinfo, OpenDocument (@file{.odt}), iCalendar,
-Markdown, man-page, and PDF@.  Some formats, such as PDF, require
-certain system tools to be installed.
+HTML, @LaTeX{}, OpenDocument (@file{.odt}), and PDF@.  Some formats,
+such as PDF, require certain system tools to be installed.
 
 @vindex org-publish-project-alist
   To export several files at once to a specific directory, either
@@ -1522,14 +1521,14 @@ with @LaTeX{}.}.
   Emacs provides a @TeX{} major mode for each of these variants: Plain
 @TeX{} mode, @LaTeX{} mode, Doc@TeX{} mode, and Sli@TeX{} mode.  Emacs
 selects the appropriate mode by looking at the contents of the buffer.
-(This is done by invoking the @code{tex-mode} command, which is
-normally called automatically when you visit a @TeX{}-like file.
-@xref{Choosing Modes}.)  If the contents are insufficient to determine
-this, Emacs chooses the mode specified by the variable
-@code{tex-default-mode}; its default value is @code{latex-mode}.  If
-Emacs does not guess right, you can select the correct variant of
-@TeX{} mode using the commands @code{plain-tex-mode},
-@code{latex-mode}, @code{slitex-mode}, or @code{doctex-mode}.
+(This is done by the @code{tex-mode} command, which is normally called
+automatically when you visit a @TeX{}-like file.  @xref{Choosing
+Modes}.)  If the contents are insufficient to determine this, Emacs
+chooses the mode specified by the variable @code{tex-default-mode};
+its default value is @code{latex-mode}.  If Emacs does not guess
+right, you can select the correct variant of @TeX{} mode using the
+command @kbd{M-x plain-tex-mode}, @kbd{M-x latex-mode}, @kbd{M-x
+slitex-mode}, or @kbd{doctex-mode}.
 
   The following sections document the features of @TeX{} mode and its
 variants.  There are several other @TeX{}-related Emacs packages,
@@ -1702,16 +1701,14 @@ chapter of a larger document).
 @table @kbd
 @item C-c C-b
 Invoke @TeX{} on the entire current buffer (@code{tex-buffer}).
-
 @item C-c C-r
 Invoke @TeX{} on the current region, together with the buffer's header
 (@code{tex-region}).
-
 @item C-c C-f
 Invoke @TeX{} on the current file (@code{tex-file}).
 
 @item C-c C-v
-Preview the output from the last @kbd{C-c C-b}, @kbd{C-c C-r}, or @kbd{C-c
+Preview the output from the last @kbd{C-c C-r}, @kbd{C-c C-b}, or @kbd{C-c
 C-f} command (@code{tex-view}).
 
 @item C-c C-p
@@ -1746,7 +1743,7 @@ C-p} (@code{tex-print}) to print a hardcopy of the output file.
 @cindex @env{TEXINPUTS} environment variable
 @vindex tex-directory
   By default, @kbd{C-c C-b} runs @TeX{} in the current directory.  The
-output of @TeX{} is also created in this directory.  To run @TeX{} in a
+output of @TeX{} also goes in this directory.  To run @TeX{} in a
 different directory, change the variable @code{tex-directory} to
 the desired directory.  If your environment variable @env{TEXINPUTS}
 contains relative names, or if your files contain
@@ -1892,16 +1889,14 @@ keys (@pxref{Completion}).
 
 @vindex tex-shell-hook
 @vindex tex-mode-hook
-@vindex doctex-mode-hook
 @vindex latex-mode-hook
 @vindex slitex-mode-hook
 @vindex plain-tex-mode-hook
   Entering any variant of @TeX{} mode runs the hooks
 @code{text-mode-hook} and @code{tex-mode-hook}.  Then it runs either
-@code{plain-tex-mode-hook}, @code{doctex-mode-hook},
-@code{latex-mode-hook}, or @code{slitex-mode-hook}, whichever is
-appropriate.  Starting the @TeX{} shell runs the hook
-@code{tex-shell-hook}.  @xref{Hooks}.
+@code{plain-tex-mode-hook}, @code{latex-mode-hook}, or
+@code{slitex-mode-hook}, whichever is appropriate.  Starting the
+@TeX{} shell runs the hook @code{tex-shell-hook}.  @xref{Hooks}.
 
 @findex iso-iso2tex
 @findex iso-tex2iso
@@ -2007,8 +2002,7 @@ characters themselves (@code{sgml-name-8bit-mode}).
 @kindex C-c C-v @r{(SGML mode)}
 @findex sgml-validate
 Run a shell command (which you must specify) to validate the current
-buffer as SGML (@code{sgml-validate}).  (In HTML mode this key
-sequence runs a different command.)
+buffer as SGML (@code{sgml-validate}).
 
 @item C-c @key{TAB}
 @kindex C-c TAB @r{(SGML mode)}
@@ -2067,27 +2061,27 @@ hook @code{text-mode-hook}, then @code{nroff-mode-hook}
 separators, pages are separated by @samp{.bp} commands, and comments
 start with backslash-doublequote.  It also defines these commands:
 
-@findex nroff-forward-text-line
-@findex nroff-backward-text-line
-@findex nroff-count-text-lines
+@findex forward-text-line
+@findex backward-text-line
+@findex count-text-lines
 @kindex M-n @r{(Nroff mode)}
 @kindex M-p @r{(Nroff mode)}
 @kindex M-? @r{(Nroff mode)}
 @table @kbd
 @item M-n
 Move to the beginning of the next line that isn't an nroff command
-(@code{nroff-forward-text-line}).  An argument is a repeat count.
+(@code{forward-text-line}).  An argument is a repeat count.
 @item M-p
-Like @kbd{M-n} but move up (@code{nroff-backward-text-line}).
+Like @kbd{M-n} but move up (@code{backward-text-line}).
 @item M-?
 Displays in the echo area the number of text lines (lines that are not
-nroff commands) in the region (@code{nroff-count-text-lines}).
+nroff commands) in the region (@code{count-text-lines}).
 @end table
 
-@findex nroff-electric-mode
+@findex electric-nroff-mode
   Electric Nroff mode is a buffer-local minor mode that can be used
 with Nroff mode.  To toggle this minor mode, type @kbd{M-x
-nroff-electric-mode} (@pxref{Minor Modes}).  When the mode is on, each
+electric-nroff-mode} (@pxref{Minor Modes}).  When the mode is on, each
 time you type @key{RET} to end a line containing an nroff command that
 opens a kind of grouping, the nroff command to close that grouping is
 automatically inserted on the following line.
@@ -2181,7 +2175,7 @@ text properties.
 @cindex soft newline
 @cindex newlines, hard and soft
 
-@findex use-hard-newlines
+@cindex use-hard-newlines
   In Enriched mode, Emacs distinguishes between two different kinds of
 newlines, @dfn{hard} newlines and @dfn{soft} newlines.  You can also
 enable or disable this feature in other buffers, by typing @kbd{M-x
@@ -2765,7 +2759,8 @@ Invoking @kbd{M-x table-capture} on that text produces this table:
 to plain text, removing its cell borders.
 
   One application of this pair of commands is to edit a text in
-layout.  Look at the following three paragraphs:
+layout.  Look at the following three paragraphs (the latter two are
+indented with header lines):
 
 @example
 table-capture is a powerful command.
@@ -2918,7 +2913,7 @@ right-hand buffer.)
 @kindex F2 RET
 @kindex C-x 6 RET
 @findex 2C-newline
-  The command @kbd{@key{F2} @key{RET}} or @kbd{C-x 6 @key{RET}}
+  The command @kbd{C-x 6 @key{RET}} or @kbd{@key{F2} @key{RET}}
 (@code{2C-newline}) inserts a newline in each of the two buffers at
 corresponding positions.  This is the easiest way to add a new line to
 the two-column text while editing it in split buffers.
diff --git a/doc/emacs/trouble.texi b/doc/emacs/trouble.texi
index ea02bb8da8..efe26cf7bf 100644
--- a/doc/emacs/trouble.texi
+++ b/doc/emacs/trouble.texi
@@ -1394,8 +1394,8 @@ patches) over all your contributions.
 @node Service
 @section How To Get Help with GNU Emacs
 @cindex help in using Emacs
-@cindex @samp{help-gnu-emacs} mailing list
-@cindex @samp{gnu.emacs.help} newsgroup
+@cindex help-gnu-emacs mailing list
+@cindex gnu.emacs.help newsgroup
 
 If you need help installing, using or changing GNU Emacs, there are
 two ways to find it:
diff --git a/doc/emacs/xresources.texi b/doc/emacs/xresources.texi
index db2c6ffafd..096e747a04 100644
--- a/doc/emacs/xresources.texi
+++ b/doc/emacs/xresources.texi
@@ -12,10 +12,10 @@ resources, as is usual for programs that use X.
 graphical widgets, such as the menu-bar, scroll-bar, and dialog boxes,
 is determined by
 @ifnottex
-GTK+ resources, which we will also describe.
+GTK resources, which we will also describe.
 @end ifnottex
 @iftex
-GTK+ resources.
+GTK resources.
 @end iftex
 When Emacs is built without GTK+ support, the appearance of these
 widgets is determined by additional X resources.
@@ -28,7 +28,7 @@ system registry (@pxref{MS-Windows Registry}).
 * Table of Resources::  Table of specific X resources that affect Emacs.
 * Lucid Resources::     X resources for Lucid menus.
 * Motif Resources::     X resources for Motif and LessTif menus.
-* GTK resources::       Resources for GTK+ widgets.
+* GTK resources::       Resources for GTK widgets.
 @end menu
 
 @node Resources
@@ -119,29 +119,28 @@ named @samp{Emacs}.  If you write @samp{Emacs} instead of
 regardless of frame titles and regardless of the name of the
 executable file.
 
-@item -xrm @var{resource-value}
+@item -xrm @var{resource-values}
 @opindex --xrm
-@itemx --xrm=@var{resource-value}
+@itemx --xrm=@var{resource-values}
 @cindex resource values, command-line argument
 This option specifies X resource values for the present Emacs job.
 
-@var{resource-value} should have the same format that you would use
-inside a file of X resources.  Several @samp{-xrm} options are
-possible to include multiple resource specifications.  You can also
-use @samp{#include "@var{filename}"} as @var{resource-value} to
-include a file full of resource specifications.  Resource values
-specified with @samp{-xrm} take precedence over all other resource
-specifications.
+@var{resource-values} should have the same format that you would use
+inside a file of X resources.  To include multiple resource
+specifications in @var{resource-values}, put a newline between them,
+just as you would in a file.  You can also use @samp{#include
+"@var{filename}"} to include a file full of resource specifications.
+Resource values specified with @samp{-xrm} take precedence over all
+other resource specifications.
 @end table
 @end ifnottex
 
 @node Table of Resources
 @appendixsec Table of X Resources for Emacs
 
-  The table below lists the X resource names that Emacs recognizes.
-Note that some of the resources have no effect in Emacs compiled with
-various X toolkits (GTK+, Lucid, etc.)---we indicate below when this
-is the case.
+  This table lists the X resource names that Emacs recognizes,
+excluding those that control the appearance of graphical widgets like
+the menu bar:
 
 @table @asis
 @item @code{background} (class @code{Background})
@@ -161,16 +160,16 @@ Width of the frame's external border, in pixels.  This has no effect
 if Emacs is compiled with GTK+ support.
 @end ifnottex
 
-@item @code{cursorBlink} (class @code{CursorBlink})
-If the value of this resource is @samp{off} or @samp{false} or
-@samp{0} at startup, Emacs disables Blink Cursor mode (@pxref{Cursor
-Display}).
-
 @item @code{cursorColor} (class @code{Foreground})
 Text cursor color.  If this resource is specified when Emacs starts
 up, Emacs sets its value as the background color of the @code{cursor}
 face (@pxref{Faces}).
 
+@item @code{cursorBlink} (class @code{CursorBlink})
+If the value of this resource is @samp{off} or @samp{false} or
+@samp{0} at startup, Emacs disables Blink Cursor mode (@pxref{Cursor
+Display}).
+
 @item @code{font} (class @code{Font})
 Font name for the @code{default} face (@pxref{Fonts}).  You can also
 specify a fontset name (@pxref{Fontsets}).
@@ -185,13 +184,6 @@ in which case Emacs tries using all available font backends.
 @item @code{foreground} (class @code{Foreground})
 Default foreground color for text.
 
-@item @code{fullscreen} (class @code{Fullscreen})
-The desired fullscreen size.  The value can be one of @code{fullboth},
-@code{maximized}, @code{fullwidth} or @code{fullheight}, which
-correspond to the command-line options @samp{-fs}, @samp{-mm},
-@samp{-fw}, and @samp{-fh} (@pxref{Window Size X}).  Note that this
-applies to the initial frame only.
-
 @item @code{geometry} (class @code{Geometry})
 Window size and position.  The value should be a size and position
 specification, of the same form as in the @samp{-g} or
@@ -201,15 +193,18 @@ The size applies to all frames in the Emacs session, but the position
 applies only to the initial Emacs frame (or, in the case of a resource
 for a specific frame name, only that frame).
 
+
 Be careful not to specify this resource as @samp{emacs*geometry}, as
 that may affect individual menus as well as the main Emacs frame.
 
-@ifnottex
-@item @code{horizontalScrollBars} (class @code{ScrollBars})
-If the value of this resource is @samp{off} or @samp{false} or
-@samp{0}, Emacs disables Horizontal Scroll Bar mode at startup
-(@pxref{Scroll Bars}).
+@item @code{fullscreen} (class @code{Fullscreen})
+The desired fullscreen size.  The value can be one of @code{fullboth},
+@code{maximized}, @code{fullwidth} or @code{fullheight}, which
+correspond to the command-line options @samp{-fs}, @samp{-mm},
+@samp{-fw}, and @samp{-fh} (@pxref{Window Size X}).  Note that this
+applies to the initial frame only.
 
+@ifnottex
 @item @code{iconName} (class @code{Title})
 Name to display in the icon.
 
@@ -323,8 +318,8 @@ This is only relevant if your Emacs is built with XIM support.  It
 might be useful to turn off XIM on slow X client/server links.
 
 @item @code{verticalScrollBars} (class @code{ScrollBars})
-Give frames scroll bars on the left if @samp{left}, on the right if
-@samp{right}; don't have scroll bars if @samp{off} (@pxref{Scroll Bars}).
+Give frames scroll bars if @samp{on}; don't have scroll bars if
+@samp{off}.
 
 @ifnottex
 @item @code{visualClass} (class @code{VisualClass})
@@ -351,13 +346,13 @@ resources.  @xref{Face Customization}.
 @cindex Lucid Widget X Resources
 
   If Emacs is compiled with the X toolkit support using Lucid widgets,
-you can use X resources to customize the appearance of the menu bar
-(@pxref{Menu Bar}), pop-up menus, and dialog boxes (@pxref{Dialog
-Boxes}).  The resources for the menu bar fall in the
-@samp{pane.menubar} class (following, as always, either the name of
-the Emacs executable or @samp{Emacs} for all Emacs invocations).  The
-resources for the pop-up menu are in the @samp{menu*} class.  The
-resources for dialog boxes are in the @samp{dialog*} class.
+you can use X resources to customize the appearance of the menu bar,
+pop-up menus, and dialog boxes.  The resources for the menu bar fall
+in the @samp{pane.menubar} class (following, as always, either the
+name of the Emacs executable or @samp{Emacs} for all Emacs
+invocations).  The resources for the pop-up menu are in the
+@samp{menu*} class.  The resources for dialog boxes are in the
+@samp{dialog*} class.
 
   For example, to display menu bar entries with the @samp{Courier-12}
 font (@pxref{Fonts}), write this:
@@ -379,12 +374,12 @@ Here is a list of resources for menu bars, pop-up menus, and dialogs:
 Font for menu item text.
 @item fontSet
 Fontset for menu item text.
+@item foreground
+Foreground color.
 @item background
 Background color.
 @item buttonForeground
 Foreground color for a selected item.
-@item foreground
-Foreground color.
 @ifnottex
 @item horizontalSpacing
 Horizontal spacing in pixels between items.  Default is 3.
@@ -408,15 +403,14 @@ Margin of the menu bar, in characters.  Default is 1.
 
   If Emacs is compiled with the X toolkit support using Motif or
 LessTif widgets, you can use X resources to customize the appearance
-of the menu bar (@pxref{Menu Bar}), pop-up menus, and dialog boxes
-(@pxref{Dialog Boxes}).  However, the resources are organized
-differently from Lucid widgets.
+of the menu bar, pop-up menus, and dialog boxes.  However, the
+resources are organized differently from Lucid widgets.
 
   The resource names for the menu bar are in the @samp{pane.menubar}
 class, and they must be specified in this form:
 
 @smallexample
-Emacs.pane.menubar.@var{subwidget}.@var{resource}: @var{value}
+Emacs.pane.menubar.@var{subwidget}.@var{resource}:  @var{value}
 @end smallexample
 
 @noindent
@@ -433,7 +427,7 @@ For example, to specify the font @samp{8x16} for all menu bar items,
 including submenus, write this:
 
 @smallexample
-Emacs.pane.menubar.*.fontList: 8x16
+Emacs.pane.menubar.*.fontList:  8x16
 @end smallexample
 
   Each item in a submenu also has its own name for X resources; for
@@ -477,7 +471,7 @@ itself, you must first specify the resource for all of them, then
 override the value for submenus alone.  Here is an example:
 
 @smallexample
-Emacs.pane.menubar.*.fontList: 9x18
+Emacs.pane.menubar.*.fontList:  8x16
 Emacs.pane.menubar.popup_*.fontList: 8x16
 @end smallexample
 
@@ -514,9 +508,9 @@ The color for the border shadow, on the top and the left.
 @end ifnottex
 
 @node GTK resources
-@appendixsec GTK+ resources
+@appendixsec GTK resources
 @cindex GTK+ resources
-@cindex resource files for GTK+
+@cindex resource files for GTK
 @cindex @file{~/.gtkrc-2.0} file
 @cindex @file{~/.emacs.d/gtkrc} file
 
@@ -531,7 +525,7 @@ resources are specified in either the file @file{~/.emacs.d/gtkrc}
 (for Emacs-specific GTK+ resources), or @file{~/.gtkrc-2.0} (for
 general GTK+ resources).  We recommend using @file{~/.emacs.d/gtkrc},
 since GTK+ seems to ignore @file{~/.gtkrc-2.0} when running GConf with
-GNOME@.  Note, however, that some GTK+ themes may override
+GNOME@.  Note, however, that some GTK themes may override
 customizations in @file{~/.emacs.d/gtkrc}; there is nothing we can do
 about this.  GTK+ resources do not affect aspects of Emacs unrelated
 to GTK+ widgets, such as fonts and colors in the main Emacs window;
@@ -554,15 +548,15 @@ system, see
 @menu
 * GTK Resource Basics::   Basic usage of GTK+ resources.
 * GTK Widget Names::      How GTK+ widgets are named.
-* GTK Names in Emacs::    GTK+ widgets used by Emacs.
-* GTK styles::            What can be customized in a GTK+ widget.
+* GTK Names in Emacs::    GTK widgets used by Emacs.
+* GTK styles::            What can be customized in a GTK widget.
 @end menu
 
 @node GTK Resource Basics
-@appendixsubsec GTK+ Resource Basics
+@appendixsubsec GTK Resource Basics
 
   In a GTK+ 2 resource file (usually @file{~/.emacs.d/gtkrc}), the
-simplest kind of a resource setting simply assigns a value to a
+simplest kinds of resource settings simply assign a value to a
 variable.  For example, putting the following line in the resource
 file changes the font on all GTK+ widgets to @samp{courier-12}:
 
@@ -617,8 +611,8 @@ widget "*verticalScrollBar*" style "scroll"
 @end smallexample
 
 @node GTK Widget Names
-@appendixsubsec GTK+ widget names
-@cindex GTK+ widget names
+@appendixsubsec GTK widget names
+@cindex GTK widget names
 
   A GTK+ widget is specified by a @dfn{widget name} and a @dfn{widget
 class}.  The widget name refers to a specific widget
@@ -662,9 +656,9 @@ widget "*" style "my_style"
 @end smallexample
 
 @node GTK Names in Emacs
-@appendixsubsec GTK+ Widget Names in Emacs
-@cindex GTK+ widget names in Emacs
-@cindex GTK+ widget classes
+@appendixsubsec GTK Widget Names in Emacs
+@cindex GTK widget names in Emacs
+@cindex GTK widget classes
 
   The GTK+ widgets used by an Emacs frame are listed below:
 
@@ -726,8 +720,8 @@ widget_class "*Menu*" style "my_menu_style"
 @end smallexample
 
 @node GTK styles
-@appendixsubsec GTK+ styles
-@cindex GTK+ styles
+@appendixsubsec GTK styles
+@cindex GTK styles
 
   Here is an example of two GTK+ style declarations:
 
@@ -776,24 +770,20 @@ possible states are:
 @table @code
 @item NORMAL
 This is the default state for widgets.
-
 @item ACTIVE
 This is the state for a widget that is ready to do something.  It is
 also for the trough of a scroll bar, i.e., @code{bg[ACTIVE] = "red"}
 sets the scroll bar trough to red.  Buttons that have been armed
 (pressed but not released yet) are in this state.
-
 @item PRELIGHT
 This is the state for a widget that can be manipulated, when the mouse
 pointer is over it---for example when the mouse is over the thumb in
 the scroll bar or over a menu item.  When the mouse is over a button
 that is not pressed, the button is in this state.
-
 @item SELECTED
 This is the state for data that has been selected by the user.  It can
 be selected text or items selected in a list.  This state is not used
 in Emacs.
-
 @item INSENSITIVE
 This is the state for widgets that are visible, but they cannot be
 manipulated in the usual way---for example, buttons that can't be
@@ -815,14 +805,14 @@ dialog.
 
 @item bg_pixmap[@var{state}] = "@var{pixmap}"
 This specifies an image background (instead of a background color).
-@var{pixmap} should be the image file name.  GTK+ can use a number of
+@var{pixmap} should be the image file name.  GTK can use a number of
 image file formats, including XPM, XBM, GIF, JPEG and PNG@.  If you
 want a widget to use the same image as its parent, use
 @samp{<parent>}.  If you don't want any image, use @samp{<none>}.
 @samp{<none>} is the way to cancel a background image inherited from a
 parent style.
 
-You can't specify the file by its absolute file name.  GTK+ looks for
+You can't specify the file by its absolute file name.  GTK looks for
 the pixmap file in directories specified in @code{pixmap_path}.
 @code{pixmap_path} is a colon-separated list of directories within
 double quotes, specified at the top level in a @file{gtkrc} file
diff --git a/doc/lispintro/emacs-lisp-intro.texi b/doc/lispintro/emacs-lisp-intro.texi
index c86ca43954..16216bb774 100644
--- a/doc/lispintro/emacs-lisp-intro.texi
+++ b/doc/lispintro/emacs-lisp-intro.texi
@@ -5882,7 +5882,7 @@ find and use again and again.
 @node New insert-buffer
 @subsection New Body for @code{insert-buffer}
 @findex insert-buffer@r{, new version body}
-@cindex new version body for @code{insert-buffer}
+@cindex new version body for insert-buffer
 
 The body in the GNU Emacs 22 version is more confusing than the original.
 
@@ -13254,7 +13254,7 @@ If you are reading this inside of GNU Emacs and you want to see the
 whole function, you can type @kbd{C-h f} (@code{describe-function})
 and the name of the function.  This gives you the function
 documentation and the name of the library containing the function's
-source.  Place point over the name of the library and press the @key{RET}
+source.  Place point over the name of the library and press the RET
 key; you will be taken directly to the source.  (Be sure to install
 your sources!  Without them, you are like a person who tries to drive
 a car with his eyes shut!)
@@ -14739,7 +14739,7 @@ In Emacs 22
   "Edit file FILENAME.
 Switch to a buffer visiting file FILENAME,
 creating one if none already exists.
-Interactively, the default if you just type @key{RET} is the current directory,
+Interactively, the default if you just type RET is the current directory,
 but the visited file name is available through the minibuffer history:
 type M-n to pull it into the minibuffer.
 
@@ -15917,8 +15917,8 @@ a regular expression, including functions that are not interactive.
 What we want to look for is some command that prints or inserts
 columns.  Very likely, the name of the function will contain either
 the word ``print'' or the word ``insert'' or the word ``column''.
-Therefore, we can simply type @kbd{M-x apropos @key{RET}
-print\|insert\|column @key{RET}} and look at the result.  On my system, this
+Therefore, we can simply type @kbd{M-x apropos RET
+print\|insert\|column RET} and look at the result.  On my system, this
 command once took quite some time, and then produced a list of 79
 functions and variables.  Now it does not take much time at all and
 produces a list of 211 functions and variables.  Scanning down the
@@ -18147,7 +18147,7 @@ You can enter the debugger when you call the function by calling
 Type:
 
 @smallexample
-M-x debug-on-entry @key{RET} triangle-bugged @key{RET}
+M-x debug-on-entry RET triangle-bugged RET
 @end smallexample
 
 @need 1250
@@ -18255,7 +18255,7 @@ To cancel the effect of @code{debug-on-entry}, call
 @code{cancel-debug-on-entry} and the name of the function, like this:
 
 @smallexample
-M-x cancel-debug-on-entry @key{RET} triangle-bugged @key{RET}
+M-x cancel-debug-on-entry RET triangle-bugged RET
 @end smallexample
 
 @noindent
@@ -18341,7 +18341,7 @@ this by positioning your cursor within or just after the definition
 and typing
 
 @smallexample
-M-x edebug-defun @key{RET}
+M-x edebug-defun RET
 @end smallexample
 
 @noindent
@@ -18552,7 +18552,7 @@ one of those long, but decipherable functions.  You can look up
 
 In this instance, since the code is Lisp, the @file{*Help*} buffer
 contains the name of the library containing the function's source.
-You can put point over the name of the library and press the @key{RET} key,
+You can put point over the name of the library and press the RET key,
 which in this situation is bound to @code{help-follow}, and be taken
 directly to the source, in the same way as @kbd{M-.}
 (@code{find-tag}).
diff --git a/doc/lispref/display.texi b/doc/lispref/display.texi
index 7348b1bf6b..3ae317ae78 100644
--- a/doc/lispref/display.texi
+++ b/doc/lispref/display.texi
@@ -3292,7 +3292,7 @@ nominal heights and widths would suggest.
 @defun x-list-fonts name &optional reference-face frame maximum width
 This function returns a list of available font names that match
 @var{name}.  @var{name} should be a string containing a font name in
-either the Fontconfig, GTK+, or XLFD format (@pxref{Fonts,,, emacs, The
+either the Fontconfig, GTK, or XLFD format (@pxref{Fonts,,, emacs, The
 GNU Emacs Manual}).  Within an XLFD string, wildcard characters may be
 used: the @samp{*} character matches any substring, and the @samp{?}
 character matches any single character.  Case is ignored when matching
@@ -3550,7 +3550,7 @@ specifications are as follows:
 
 @table @code
 @item :name
-The font name (a string), in either XLFD, Fontconfig, or GTK+ format.
+The font name (a string), in either XLFD, Fontconfig, or GTK format.
 @xref{Fonts,,, emacs, The GNU Emacs Manual}.
 
 @item :family
@@ -5387,6 +5387,7 @@ hint to ImageMagick to help it detect the image type.
 Specifies a rotation angle in degrees.
 
 @item :index @var{frame}
+@c Doesn't work: https://debbugs.gnu.org/7978
 @xref{Multi-Frame Images}.
 @end table
 
@@ -5395,8 +5396,8 @@ Specifies a rotation angle in degrees.
 @cindex SVG images
 
 SVG (Scalable Vector Graphics) is an XML format for specifying images.
-If your Emacs build has SVG support, you can create and manipulate
-these images with the following functions.
+If your Emacs build has with SVG support, you can create and manipulate
+these images with the following commands.
 
 @defun svg-create width height &rest args
 Create a new, empty SVG image with the specified dimensions.
@@ -5410,7 +5411,7 @@ The default width (in pixels) of any lines created.
 The default stroke color on any lines created.
 @end table
 
-This function returns an SVG structure, and all the following functions
+This function returns an SVG structure, and all the following commands
 work on that structure.
 @end defun
 
@@ -5992,7 +5993,7 @@ debugging.
 @cindex embedded widgets
 @cindex webkit browser widget
 
-  Emacs is able to display native widgets, such as GTK+ WebKit widgets,
+  Emacs is able to display native widgets, such as GTK WebKit widgets,
 in Emacs buffers when it was built with the necessary support
 libraries and is running on a graphical terminal.  To test whether
 Emacs supports display of embedded widgets, check that the
diff --git a/doc/lispref/files.texi b/doc/lispref/files.texi
index 6c6655c77d..68cc3df49a 100644
--- a/doc/lispref/files.texi
+++ b/doc/lispref/files.texi
@@ -3250,7 +3250,7 @@ shown above; the details are crucial for proper behavior in the case of
 multiple handlers, and for operations that have two file names that may
 each have handlers.
 
-@kindex safe-magic @r{(property)}
+@kindex safe-magic (@r{property})
   Handlers that don't really do anything special for actual access to the
 file---such as the ones that implement completion of host names for
 remote file names---should have a non-@code{nil} @code{safe-magic}
@@ -3260,7 +3260,7 @@ file names, by prefixing them with @samp{/:}.  But if the handler that
 would be used for them has a non-@code{nil} @code{safe-magic}
 property, the @samp{/:} is not added.
 
-@kindex operations @r{(property)}
+@kindex operations (@r{property})
   A file name handler can have an @code{operations} property to
 declare which operations it handles in a nontrivial way.  If this
 property has a non-@code{nil} value, it should be a list of
diff --git a/doc/lispref/frames.texi b/doc/lispref/frames.texi
index 459f05cb1c..2f9bb39886 100644
--- a/doc/lispref/frames.texi
+++ b/doc/lispref/frames.texi
@@ -181,12 +181,6 @@ the value of that parameter in the created frame to its value in the
 selected frame.
 @end defvar
 
-@defopt server-after-make-frame-hook
-A normal hook run when the Emacs server creates a client frame.  When
-this hook is called, the created frame is the selected one.
-@xref{Emacs Server,,, emacs, The GNU Emacs Manual}.
-@end defopt
-
 
 @node Multiple Terminals
 @section Multiple Terminals
diff --git a/doc/lispref/hooks.texi b/doc/lispref/hooks.texi
index e374d02def..db4e413921 100644
--- a/doc/lispref/hooks.texi
+++ b/doc/lispref/hooks.texi
@@ -66,7 +66,6 @@ not exactly a hook, but does a similar job.
 
 @item after-make-frame-functions
 @itemx before-make-frame-hook
-@itemx server-after-make-frame-hook
 @xref{Creating Frames}.
 
 @c Not general enough?
diff --git a/doc/lispref/keymaps.texi b/doc/lispref/keymaps.texi
index cc2e11e0b6..e39db7f6d0 100644
--- a/doc/lispref/keymaps.texi
+++ b/doc/lispref/keymaps.texi
@@ -2750,7 +2750,7 @@ If the value is @code{grow-only}, the tool bar expands automatically,
 but does not contract automatically.  To contract the tool bar, the
 user has to redraw the frame by entering @kbd{C-l}.
 
-If Emacs is built with GTK+ or Nextstep, the tool bar can only show one
+If Emacs is built with GTK or Nextstep, the tool bar can only show one
 line, so this variable has no effect.
 @end defvar
 
diff --git a/doc/lispref/numbers.texi b/doc/lispref/numbers.texi
index f1180cf754..e692ee1cc2 100644
--- a/doc/lispref/numbers.texi
+++ b/doc/lispref/numbers.texi
@@ -53,9 +53,8 @@ but many machines provide a wider range.  Many examples in this
 chapter assume the minimum integer width of 30 bits.
 @cindex overflow
 
-  The Lisp reader reads an integer as a nonempty sequence
-of decimal digits with optional initial sign and optional
-final period.  A decimal integer that is out of the
+  The Lisp reader reads an integer as a sequence of digits with optional
+initial sign and optional final period.  An integer that is out of the
 Emacs range is treated as a floating-point number.
 
 @example
diff --git a/doc/lispref/streams.texi b/doc/lispref/streams.texi
index a07500715e..8f531347dc 100644
--- a/doc/lispref/streams.texi
+++ b/doc/lispref/streams.texi
@@ -778,14 +778,6 @@ In the second expression, the local binding of
 @code{prin1}, but not during the printing of the result.
 @end defvar
 
-@defvar print-escape-control-characters
-If this variable is non-@code{nil}, control characters in strings are
-printed as backslash sequences by the print functions @code{prin1} and
-@code{print} that print with quoting.  If this variable and
-@code{print-escape-newlines} are both non-@code{nil}, the latter takes
-precedences for newlines and formfeeds.
-@end defvar
-
 @defvar print-escape-nonascii
 If this variable is non-@code{nil}, then unibyte non-@acronym{ASCII}
 characters in strings are unconditionally printed as backslash sequences
diff --git a/doc/lispref/strings.texi b/doc/lispref/strings.texi
index 8a9e27d00e..5452ea6879 100644
--- a/doc/lispref/strings.texi
+++ b/doc/lispref/strings.texi
@@ -727,7 +727,7 @@ minus sign if the argument is negative.
      @result{} "-23.5"
 @end example
 
-@cindex @code{int-to-string}
+@cindex int-to-string
 @code{int-to-string} is a semi-obsolete alias for this function.
 
 See also the function @code{format} in @ref{Formatting Strings}.
diff --git a/doc/lispref/text.texi b/doc/lispref/text.texi
index e992c0f561..9de270c2d8 100644
--- a/doc/lispref/text.texi
+++ b/doc/lispref/text.texi
@@ -3862,7 +3862,7 @@ clicks on the link quickly without moving the mouse.  This behavior is
 controlled by the user option @code{mouse-1-click-follows-link}.
 @xref{Mouse References,,, emacs, The GNU Emacs Manual}.
 
-@kindex follow-link @r{(text or overlay property)}
+@cindex follow-link (text or overlay property)
   To set up the link so that it obeys
 @code{mouse-1-click-follows-link}, you must either (1) apply a
 @code{follow-link} text or overlay property to the link text, or (2)
diff --git a/doc/lispref/tips.texi b/doc/lispref/tips.texi
index c62cfcfa8f..0695d9b7b1 100644
--- a/doc/lispref/tips.texi
+++ b/doc/lispref/tips.texi
@@ -1043,8 +1043,7 @@ the place to write arbitrary keywords that describe their package,
 rather than just the relevant Finder keywords.
 
 @item Homepage
-@itemx URL
-These lines state the homepage of the library.
+This line states the homepage of the library.
 
 @item Package-Version
 If @samp{Version} is not suitable for use by the package manager, then
diff --git a/doc/lispref/variables.texi b/doc/lispref/variables.texi
index 55bca5edcc..203838d9d8 100644
--- a/doc/lispref/variables.texi
+++ b/doc/lispref/variables.texi
@@ -165,7 +165,7 @@ receive local values, which are the actual arguments supplied to the
 function call; these local bindings take effect within the body of the
 function.  To take another example, the @code{let} special form
 explicitly establishes local bindings for specific variables, which
-take effect only within the body of the @code{let} form.
+take effect within the body of the @code{let} form.
 
   We also speak of the @dfn{global binding}, which is where
 (conceptually) the global value is kept.
@@ -204,8 +204,7 @@ bindings:
 This special form sets up local bindings for a certain set of
 variables, as specified by @var{bindings}, and then evaluates all of
 the @var{forms} in textual order.  Its return value is the value of
-the last form in @var{forms}.  The local bindings set up by @code{let}
-will be in effect only within the body of @var{forms}.
+the last form in @var{forms}.
 
 Each of the @var{bindings} is either @w{(i) a} symbol, in which case
 that symbol is locally bound to @code{nil}; or @w{(ii) a} list of the
diff --git a/doc/misc/calc.texi b/doc/misc/calc.texi
index be78a53ed6..a4a091f243 100644
--- a/doc/misc/calc.texi
+++ b/doc/misc/calc.texi
@@ -9710,7 +9710,7 @@ The @kbd{C-x * x} command also turns the Calculator off, no matter which
 user interface (standard, Keypad, or Embedded) is currently active.
 It also cancels @code{calc-edit} mode if used from there.
 
-@kindex d SPC
+@kindex d @key{SPC}
 @pindex calc-refresh
 @cindex Refreshing a garbled display
 @cindex Garbled displays, refreshing
@@ -10268,7 +10268,7 @@ information is cleared whenever you give any command that adds new undo
 information, i.e., if you undo, then enter a number on the stack or make
 any other change, then it will be too late to redo.
 
-@kindex M-RET
+@kindex M-@key{RET}
 @pindex calc-last-args
 @cindex Last-arguments feature
 @cindex Arguments, restoring
@@ -10906,27 +10906,27 @@ degrees, minutes, and seconds.
 @ignore
 @mindex @null
 @end ignore
-@kindex ' @r{(HMS forms)}
+@kindex ' (HMS forms)
 @ignore
 @mindex @null
 @end ignore
-@kindex " @r{(HMS forms)}
+@kindex " (HMS forms)
 @ignore
 @mindex @null
 @end ignore
-@kindex h @r{(HMS forms)}
+@kindex h (HMS forms)
 @ignore
 @mindex @null
 @end ignore
-@kindex o @r{(HMS forms)}
+@kindex o (HMS forms)
 @ignore
 @mindex @null
 @end ignore
-@kindex m @r{(HMS forms)}
+@kindex m (HMS forms)
 @ignore
 @mindex @null
 @end ignore
-@kindex s @r{(HMS forms)}
+@kindex s (HMS forms)
 The default format for HMS values is
 @samp{@var{hours}@@ @var{mins}' @var{secs}"}.  During entry, the letters
 @samp{h} (for ``hours'') or
@@ -11125,7 +11125,7 @@ integers but this is not required.
 @ignore
 @mindex M
 @end ignore
-@kindex M @r{(modulo forms)}
+@kindex M (modulo forms)
 @ignore
 @mindex mod
 @end ignore
@@ -11280,7 +11280,7 @@ would indeed have been negligible.
 @ignore
 @mindex p
 @end ignore
-@kindex p @r{(error forms)}
+@kindex p (error forms)
 @tindex +/-
 To enter an error form during regular numeric entry, use the @kbd{p}
 (``plus-or-minus'') key to type the @samp{+/-} symbol.  (If you try actually
@@ -11732,8 +11732,8 @@ type, such as numbers, vectors, formulas, and incomplete objects.)
 @section Stack Manipulation Commands
 
 @noindent
-@kindex RET
-@kindex SPC
+@kindex @key{RET}
+@kindex @key{SPC}
 @pindex calc-enter
 @cindex Duplicating stack entries
 To duplicate the top object on the stack, press @key{RET} or @key{SPC}
@@ -11749,7 +11749,7 @@ For example, with @samp{10 20 30} on the stack,
 @kbd{C-u - 2 @key{RET}} creates @samp{10 20 30 20}, and
 @kbd{C-u 0 @key{RET}} creates @samp{10 20 30 10 20 30}.
 
-@kindex LFD
+@kindex @key{LFD}
 @pindex calc-over
 The @key{LFD} (@code{calc-over}) command (on a key marked Line-Feed if you
 have it, else on @kbd{C-j}) is like @code{calc-enter}
@@ -11759,7 +11759,7 @@ Thus with @samp{10 20 30} on the stack, @key{LFD} and @kbd{C-u 2 @key{LFD}}
 are both equivalent to @kbd{C-u - 2 @key{RET}}, producing
 @samp{10 20 30 20}.
 
-@kindex DEL
+@kindex @key{DEL}
 @kindex C-d
 @pindex calc-pop
 @cindex Removing stack entries
@@ -11777,7 +11777,7 @@ For example, with @samp{10 20 30} on the stack,
 @kbd{C-u - 2 @key{DEL}} leaves @samp{10 30}, and
 @kbd{C-u 0 @key{DEL}} leaves an empty stack.
 
-@kindex M-DEL
+@kindex M-@key{DEL}
 @pindex calc-pop-above
 The @kbd{M-@key{DEL}} (@code{calc-pop-above}) command is to @key{DEL} what
 @key{LFD} is to @key{RET}:  It interprets the sign of the numeric
@@ -11798,7 +11798,7 @@ specified element of the stack regardless of the cursor  position.
 Similarly, @key{DEL} will remove the corresponding elements from the
 stack.
 
-@kindex TAB
+@kindex @key{TAB}
 @pindex calc-roll-down
 To exchange the top two elements of the stack, press @key{TAB}
 (@code{calc-roll-down}).  Given a positive numeric prefix argument, the
@@ -11812,7 +11812,7 @@ For example, with @samp{10 20 30 40 50} on the stack,
 @kbd{C-u - 2 @key{TAB}} creates @samp{40 50 10 20 30}, and
 @kbd{C-u 0 @key{TAB}} creates @samp{50 40 30 20 10}.
 
-@kindex M-TAB
+@kindex M-@key{TAB}
 @pindex calc-roll-up
 The command @kbd{M-@key{TAB}} (@code{calc-roll-up}) is analogous to @key{TAB}
 except that it rotates upward instead of downward.  Also, the default
@@ -13075,7 +13075,7 @@ refresh the stack to leave the stack display alone.  The word ``Dirty''
 will appear in the mode line when Calc thinks the stack display may not
 reflect the latest mode settings.
 
-@kindex d RET
+@kindex d @key{RET}
 @pindex calc-refresh-top
 The @kbd{d @key{RET}} (@code{calc-refresh-top}) command reformats the
 top stack entry according to all the current modes.  Positive prefix
@@ -16682,8 +16682,8 @@ or matrix argument, these functions operate element-wise.
 @ignore
 @mindex v p
 @end ignore
-@kindex v p @r{(complex)}
-@kindex V p @r{(complex)}
+@kindex v p (complex)
+@kindex V p (complex)
 @pindex calc-pack
 The @kbd{v p} (@code{calc-pack}) command can pack the top two numbers on
 the stack into a composite object such as a complex number.  With
@@ -16694,8 +16694,8 @@ with an argument of @mathit{-2}, it produces a polar complex number.
 @ignore
 @mindex v u
 @end ignore
-@kindex v u @r{(complex)}
-@kindex V u @r{(complex)}
+@kindex v u (complex)
+@kindex V u (complex)
 @pindex calc-unpack
 The @kbd{v u} (@code{calc-unpack}) command takes the complex number
 (or other composite object) on the top of the stack and unpacks it
@@ -20234,7 +20234,7 @@ the conjugate transpose of its argument, i.e., @samp{conj(trn(x))}.
 @ignore
 @mindex A
 @end ignore
-@kindex A @r{(vectors)}
+@kindex A (vectors)
 @pindex calc-abs (vectors)
 @ignore
 @mindex abs
@@ -20280,7 +20280,7 @@ exactly three elements.
 @ignore
 @mindex &
 @end ignore
-@kindex & @r{(matrices)}
+@kindex & (matrices)
 @pindex calc-inv (matrices)
 @ignore
 @mindex inv
@@ -21942,7 +21942,7 @@ If you select an element of a vector and press @key{DEL}, that
 element is deleted from the vector.  If you delete one side of
 an equation or inequality, only the opposite side remains.
 
-@kindex j DEL
+@kindex j @key{DEL}
 @pindex calc-del-selection
 The @kbd{j @key{DEL}} (@code{calc-del-selection}) command is like
 @key{DEL} but with the auto-selecting behavior of @kbd{j '} and
@@ -21950,7 +21950,7 @@ The @kbd{j @key{DEL}} (@code{calc-del-selection}) command is like
 indicated by the cursor, or, in the absence of a selection, it
 deletes the sub-formula indicated by the cursor position.
 
-@kindex j RET
+@kindex j @key{RET}
 @pindex calc-grab-selection
 (There is also an auto-selecting @kbd{j @key{RET}} (@code{calc-copy-selection})
 command.)
@@ -31292,7 +31292,7 @@ for @code{Save} have no effect.
 You can modify Embedded mode's behavior by setting various Lisp
 variables described here.  These variables are customizable
 (@pxref{Customizing Calc}), or you can use @kbd{M-x set-variable}
-to adjust a variable on the fly.
+or @kbd{M-x edit-options} to adjust a variable on the fly.
 (Another possibility would be to use a file-local variable annotation at
 the end of the file;
 @pxref{File Variables, , Local Variables in Files, emacs, the Emacs manual}.)
@@ -31311,8 +31311,9 @@ regular expression is not completely plain, let's go through it
 in detail.
 
 The surrounding @samp{" "} marks quote the text between them as a
-Lisp string.  If you left them off, @code{set-variable} (for example)
-would try to read the regular expression as a Lisp program.
+Lisp string.  If you left them off, @code{set-variable} or
+@code{edit-options} would try to read the regular expression as a
+Lisp program.
 
 The most obvious property of this regular expression is that it
 contains indecently many backslashes.  There are actually two levels
@@ -35347,13 +35348,13 @@ followed by  @kbd{=}, @kbd{&}, @kbd{#}, @kbd{\}, @kbd{/}, @kbd{+} or
 @kbd{-} as well as @kbd{*} to start Calc, and so in many cases the last
 character of the prefix can simply be typed twice.
 
-Calc is controlled by many variables, most of which can be reset from
-within Calc.  Some variables are less involved with actual calculation
-and can be set outside of Calc using Emacs's customization facilities.
-These variables are listed below.  Typing @kbd{M-x customize-variable
-@key{RET} @var{variable-name} @key{RET}} will bring up a buffer in
-which the variable's value can be redefined.  Typing @kbd{M-x
-customize-group @key{RET} calc @key{RET}} will bring up a buffer which
+Calc is controlled by many variables, most of which can be reset
+from within Calc.  Some variables are less involved with actual
+calculation and can be set outside of Calc using Emacs's
+customization facilities.  These variables are listed below.
+Typing @kbd{M-x customize-variable RET @var{variable-name} RET}
+will bring up a buffer in which the variable's value can be redefined.
+Typing @kbd{M-x customize-group RET calc RET} will bring up a buffer which
 contains all of Calc's customizable variables.  (These variables can
 also be reset by putting the appropriate lines in your .emacs file;
 @xref{Init File, ,Init File, emacs, The GNU Emacs Manual}.)
diff --git a/doc/misc/cc-mode.texi b/doc/misc/cc-mode.texi
index 5a229c1cd6..a506213ea2 100644
--- a/doc/misc/cc-mode.texi
+++ b/doc/misc/cc-mode.texi
@@ -356,9 +356,9 @@ Customizing Macros
 
 @cindex BOCM
 @cindex history
-@cindex @file{awk-mode.el}
-@cindex @file{c-mode.el}
-@cindex @file{c++-mode.el}
+@cindex awk-mode.el
+@cindex c-mode.el
+@cindex c++-mode.el
 
 Welcome to @ccmode{}, a GNU Emacs mode for editing files containing C,
 C++, Objective-C, Java, CORBA IDL (and the variants CORBA PSDL and
@@ -577,9 +577,9 @@ for the latest information on Emacs version and package compatibility
 
 @deffn Command c-version
 @findex version @r{(c-)}
-You can find out what version of @ccmode{} you are using by visiting a
-C file and entering @kbd{M-x c-version @key{RET}}.  You should see
-this message in the echo area:
+You can find out what version of @ccmode{} you are using by visiting a C
+file and entering @kbd{M-x c-version RET}.  You should see this message in
+the echo area:
 
 @example
 Using CC Mode version 5.XX
@@ -920,8 +920,8 @@ must be in column zero.  See @ref{Defuns,,,@emacsman{},
 
 @item @kbd{C-M-a} (AWK Mode) (@code{c-awk-beginning-of-defun})
 @itemx @kbd{C-M-e} (AWK Mode) (@code{c-awk-end-of-defun})
-@kindex C-M-a @r{(AWK Mode)}
-@kindex C-M-e @r{(AWK Mode)}
+@kindex C-M-a (AWK Mode)
+@kindex C-M-e (AWK Mode)
 @findex c-awk-beginning-of-defun
 @findex awk-beginning-of-defun @r{(c-)}
 @findex c-awk-end-of-defun
@@ -1521,7 +1521,7 @@ deletion.
 @kindex DEL
 @findex c-electric-backspace
 @findex electric-backspace @r{(c-)}
-This command is run by default when you hit the @kbd{@key{DEL}} key.  When
+This command is run by default when you hit the @kbd{DEL} key.  When
 hungry delete mode is enabled, it deletes any amount of whitespace in
 the backwards direction.  Otherwise, or when used with a prefix
 argument or in a literal (@pxref{Auto-newlines}), the command just
@@ -1567,8 +1567,8 @@ rather than using the minor mode toggling.
 
 @table @asis
 @item @kbd{C-c C-@key{DEL}}, or @kbd{C-c @key{DEL}} (@code{c-hungry-delete-backwards})@footnote{This command was formerly known as @code{c-hungry-backspace}.}
-@kindex C-c C-Backspace
-@kindex C-c Backspace
+@kindex C-c C-<backspace>
+@kindex C-c <backspace>
 @kindex C-c C-DEL
 @kindex C-c DEL
 @findex c-hungry-delete-backwards
@@ -1581,21 +1581,21 @@ a character terminal.
 
 @item @kbd{C-c C-d}, @kbd{C-c C-@key{DELETE}}, or @kbd{C-c @key{DELETE}} (@code{c-hungry-delete-forward})
 @kindex C-c C-d
-@kindex C-c C-Delete
-@kindex C-c Delete
+@kindex C-c C-<DELETE>
+@kindex C-c <DELETE>
 @findex c-hungry-delete-forward
 @findex hungry-delete-forward @r{(c-)}
 Delete any amount of whitespace in the forward direction (regardless
 whether hungry-delete mode is enabled or not).  This command is bound
-to both @kbd{C-c C-@key{Delete}} and @kbd{C-c @key{Delete}} for the
+to both @kbd{C-c C-@key{DELETE}} and @kbd{C-c @key{DELETE}} for the
 same reason as for @key{DEL} above.
 @end table
 @end table
 
-@kindex Delete
-@kindex Backspace
+@kindex <delete>
+@kindex <backspace>
 
-When we talk about @kbd{@key{DEL}}, and @kbd{@key{Delete}} above, we
+When we talk about @kbd{@key{DEL}}, and @kbd{@key{DELETE}} above, we
 actually do so without connecting them to the physical keys commonly
 known as @key{Backspace} and @key{Delete}.  The default bindings to
 those two keys depends on the flavor of (X)Emacs you are using.
@@ -1708,7 +1708,7 @@ nomenclature and treat them as separate words:
 @item     @kbd{M-b}   @tab @code{backward-word}      @tab @code{c-backward-subword}
 @item     @kbd{M-@@}  @tab @code{mark-word}          @tab @code{c-mark-subword}
 @item     @kbd{M-d}   @tab @code{kill-word}          @tab @code{c-kill-subword}
-@item     @kbd{M-@key{DEL}} @tab @code{backward-kill-word} @tab @code{c-backward-kill-subword}
+@item     @kbd{M-DEL} @tab @code{backward-kill-word} @tab @code{c-backward-kill-subword}
 @item     @kbd{M-t}   @tab @code{transpose-words}    @tab @code{c-transpose-subwords}
 @item     @kbd{M-c}   @tab @code{capitalize-word}    @tab @code{c-capitalize-subword}
 @item     @kbd{M-u}   @tab @code{upcase-word}        @tab @code{c-upcase-subword}
@@ -4734,7 +4734,7 @@ Once again, line 8 is assigned as @code{brace-entry-open} as is line
 with anchor point at the @samp{@{} of line 8@footnote{This extra
 syntactic element was introduced in @ccmode{} 5.33.1 to allow extra
 flexibility in indenting the second line of such a construct.  You can
-preserve the behavior resulting from the former syntactic analysis by
+preserve the behaviour resulting from the former syntactic analysis by
 giving @code{brace-list-entry} an offset of
 @code{c-lineup-under-anchor} (@pxref{Misc Line-Up}).}, and
 @code{brace-list-entry} anchored on the @samp{1} of line 8.
@@ -7250,13 +7250,13 @@ Set the variable @code{c-basic-offset}.  @xref{Getting Started}.
 @item
 @kindex RET
 @kindex C-j
-@emph{Why does/doesn't the @kbd{@key{RET}} key indent the new line?}
+@emph{Why does/doesn't the @kbd{RET} key indent the new line?}
 
 Emacs's convention used to be that @kbd{RET} just adds a newline, and that
 @kbd{C-j} adds a newline and indents it.  In Emacs-24.4, this convention was
 reversed.
 
-If you use an older Emacs and you want @kbd{@key{RET}} do this
+If you use an older Emacs and you want @kbd{RET} do this
 too, add this to your @code{c-initialization-hook}:
 
 @example
diff --git a/doc/misc/dbus.texi b/doc/misc/dbus.texi
index 5b14382d8b..b425bb0c00 100644
--- a/doc/misc/dbus.texi
+++ b/doc/misc/dbus.texi
@@ -1815,7 +1815,7 @@ The function returns a number, which counts the connections this Emacs
 session has established to the @var{bus} under the same unique name
 (see @code{dbus-get-unique-name}).  It depends on the libraries Emacs
 is linked with, and on the environment Emacs is running.  For example,
-if Emacs is linked with the GTK+ toolkit, and it runs in a GTK+-aware
+if Emacs is linked with the gtk toolkit, and it runs in a GTK-aware
 environment like Gnome, another connection might already be
 established.
 
@@ -1837,9 +1837,9 @@ Example: You initialize a connection to the AT-SPI bus on your host:
 
 @result{} "unix:abstract=/tmp/dbus-2yzWHOCdSD,guid=a490dd26625870ca1298b6e10000fd7f"
 
-;; If Emacs is built with GTK+ support, and you run in a GTK+-enabled
+;; If Emacs is built with gtk support, and you run in a GTK enabled
 ;; environment (like a GNOME session), the initialization reuses the
-;; connection established by GTK+'s atk bindings.
+;; connection established by GTK's atk bindings.
 (dbus-init-bus my-bus)
 
 @result{} 2
diff --git a/doc/misc/dired-x.texi b/doc/misc/dired-x.texi
index 60e978c9d9..130c06b40e 100644
--- a/doc/misc/dired-x.texi
+++ b/doc/misc/dired-x.texi
@@ -995,7 +995,7 @@ If there are several Dired buffers for a directory, the most recently
 used is chosen.
 
 Dired avoids switching to the current buffer, so that if you have a
-normal and a wildcard buffer for the same directory, @kbd{C-x d @key{RET}}
+normal and a wildcard buffer for the same directory, @kbd{C-x d RET}
 will toggle between those two.
 @end table
 
diff --git a/doc/misc/ebrowse.texi b/doc/misc/ebrowse.texi
index b6f2c1865f..9ac2af1bcf 100644
--- a/doc/misc/ebrowse.texi
+++ b/doc/misc/ebrowse.texi
@@ -482,7 +482,7 @@ you are working on, some classes will only be known to exist but the
 location of their declarations and definitions will not be known.
 
 @item @key{RET}
-Works like @kbd{@key{SPC}}, except that it finds the class
+Works like @kbd{SPC}, except that it finds the class
 declaration rather than viewing it, so that it is ready for
 editing.
 @end table
@@ -886,7 +886,7 @@ the member.
 This command finds the declaration of the member the cursor is on.
 
 @item @key{SPC}
-This is the same command as @kbd{@key{RET}}, but views the member definition
+This is the same command as @kbd{RET}, but views the member definition
 instead of finding the member's source file.
 
 @item v
@@ -1314,7 +1314,7 @@ the next position stored in the position stack.
 
 @item C-c C-m p
 Displays an electric buffer showing all positions saved in the stack.
-You can select a position by pressing @kbd{@key{SPC}} in a line.  You can
+You can select a position by pressing @kbd{SPC} in a line.  You can
 view a position with @kbd{v}.
 @end table
 
diff --git a/doc/misc/ede.texi b/doc/misc/ede.texi
index 42bedb10f6..88dc9e922e 100644
--- a/doc/misc/ede.texi
+++ b/doc/misc/ede.texi
@@ -160,8 +160,8 @@ First, lets create a directory for our project.  For this example,
 we'll start with something in @file{/tmp}.
 
 @example
-C-x C-f /tmp/myproject/README @key{RET}
-M-x make-directory @key{RET} @key{RET}
+C-x C-f /tmp/myproject/README RET
+M-x make-directory RET RET
 @end example
 
 Now put some plain text in your README file to start.
@@ -169,7 +169,7 @@ Now put some plain text in your README file to start.
 Now, lets create the project:
 
 @example
-M-x ede-new @key{RET} Automake @key{RET} myproject @key{RET}
+M-x ede-new RET Automake RET myproject RET
 @end example
 
 
@@ -191,8 +191,8 @@ We'll make a more complex project, so use dired to create some more
 directories using the @kbd{+} key, and typing in new directories:
 
 @example
-+ include @key{RET}
-+ src @key{RET}
++ include RET
++ src RET
 @end example
 
 Now I'll short-cut in this tutorial.  Create the following files:
@@ -252,13 +252,13 @@ now create those projects.
 With @file{main.cpp} as your current buffer, type:
 
 @example
-M-x ede-new @key{RET} Automake @key{RET} src @key{RET}
+M-x ede-new RET Automake RET src RET
 @end example
 
 and in @file{myproj.hh} as your current buffer, type:
 
 @example
-M-x ede-new @key{RET} Automake @key{RET} include @key{RET}
+M-x ede-new RET Automake RET include RET
 @end example
 
 These steps effectively only create the Project.ede file in which you
@@ -272,7 +272,7 @@ Projects.  You can create targets either from a buffer, or from a
 
 Note: If for some reason a directory list buffer, or file does not have the
 @samp{Project} menu item, or if @ede{} keybindings don't work, just
-use @kbd{M-x revert-buffer @key{RET}} to force a refresh.  Sometimes
+use @kbd{M-x revert-buffer RET} to force a refresh.  Sometimes
 creating a new project doesn't restart buffers correctly.
 
 Lets start with the header file.  In @file{include/myproj.hh}, you
@@ -280,7 +280,7 @@ could use the menu, but we will now start using the @ede{} command prefix
 which is @kbd{C-c .}.
 
 @example
-C-c . t includes @key{RET} miscellaneous @key{RET} y
+C-c . t includes RET miscellaneous RET y
 @end example
 
 
@@ -292,7 +292,7 @@ Next, visit the @file{src} directory using dired.  There should be a
 @samp{Project} menu.   You can create a new target with
 
 @example
-. t myprogram @key{RET} program @key{RET}
+. t myprogram RET program RET
 @end example
 
 Note that @kbd{. t} is a command for creating a target.  This command
@@ -304,7 +304,7 @@ Next, place the cursor on @file{main.cpp}, and use @kbd{. a} to add
 that file to your target.
 
 @example
-. a myprogram @key{RET}
+. a myprogram RET
 @end example
 
 Note that these prompts often have completion, so you can just press
@@ -316,8 +316,8 @@ all in your dired buffer, and add them all at the same time.
 Next, do the same for the library by placing the cursor on @file{mylib.cpp}.
 
 @example
-. t mylib @key{RET} sharedobject @key{RET}
-. a mylib @key{RET}
+. t mylib RET sharedobject RET
+. a mylib RET
 @end example
 
 @section Step 5: Compile, and fail
@@ -350,7 +350,7 @@ To fix the failed compile, we need to add
 Visit @file{main.cpp}.
 
 @example
-M-x customize-project @key{RET}
+M-x customize-project RET
 @end example
 
 Select the @samp{[Settings]} subgroup of options.  Under
@@ -407,7 +407,7 @@ project.  This is because variables such as the include path are
 treated globally, whereas dependencies for a target are target specific.
 
 @example
-M-x customize-target @key{RET}
+M-x customize-target RET
 @end example
 
 On the first page, you will see an Ldlibs-local section.  Add mylib to
@@ -437,7 +437,7 @@ C-c . C
 You can run your program directly from @ede{}.
 
 @example
-C-c . R @key{RET} @key{RET}
+C-c . R RET RET
 @end example
 
 If your program takes command line arguments, you can type them in
diff --git a/doc/misc/ediff.texi b/doc/misc/ediff.texi
index 8ffa90fb5b..e488fc07f8 100644
--- a/doc/misc/ediff.texi
+++ b/doc/misc/ediff.texi
@@ -541,12 +541,12 @@ Copies the difference region from buffer C to buffer B@.
 The command @kbd{rb} undoes this.
 
 @item p
-@itemx @key{DEL}
+@itemx DEL
 @kindex p
 @kindex DEL
 Makes the previous difference region current.
 @item n
-@itemx @key{SPC}
+@itemx SPC
 @kindex n
 @kindex SPC
 Makes the next difference region current.
diff --git a/doc/misc/edt.texi b/doc/misc/edt.texi
index ddeacf16b4..20a7034fb2 100644
--- a/doc/misc/edt.texi
+++ b/doc/misc/edt.texi
@@ -192,10 +192,10 @@ EDT Emulation.  (Note: In a few rare circumstances this does not work
 properly.  In particular, it does not work if a subset of the leading
 @acronym{ASCII} characters in a key sequence are recognized by Emacs as
 having an existing binding.  For example, if the keypad 7 (@key{KP7})
-key generates the sequence @samp{@key{ESC}Ow} and @samp{@key{ESC}O} is already
+key generates the sequence @samp{<ESC>Ow} and @samp{<ESC>O} is already
 bound to a function, pressing @key{KP7} when told to do so by
 @file{edt-mapper.el} will result in @file{edt-mapper.el} incorrectly
-mapping @samp{@key{ESC}O} to @key{KP7} and @samp{w} to @key{KP8}.  If
+mapping @samp{<ESC>O} to @key{KP7} and @samp{w} to @key{KP8}.  If
 something like this happens to you, it is probably a bug in the support
 for your keyboard within Emacs @strong{or} a bug in the Unix
 termcap/terminfo support for your terminal @strong{or} a bug in the
diff --git a/doc/misc/efaq-w32.texi b/doc/misc/efaq-w32.texi
index df75002bf2..bf20c2291c 100644
--- a/doc/misc/efaq-w32.texi
+++ b/doc/misc/efaq-w32.texi
@@ -309,7 +309,7 @@ file for build instructions.
 
 You can run Emacs without any extra steps, but if you want icons in your
 Start Menu, or for Emacs to detect the image libraries that are already
-installed on your system as part of GTK+, then you should run the program
+installed on your system as part of GTK, then you should run the program
 @file{addpm.exe}, which is usually installed into the same @file{bin}
 directory with @file{emacs.exe}.
 
@@ -899,7 +899,7 @@ The doc string contains a list of the system sounds you can use.
 @cindex font XLFD name format
 @cindex fontconfig font names in Emacs 23
 @cindex font dialog, using to find font names
-@findex x-select-font
+@findex w32-select-font
 @findex x-list-fonts
 
 Fonts in Emacs 22 and earlier are named using the X Logical Font
@@ -930,7 +930,7 @@ Fontconfig: Courier New-13
 To find the XFLD name for a font, you can execute the following in the
 @file{*scratch*} buffer by pressing C-j at the end of the line:
 @example
-(x-select-font nil t)
+(w32-select-font nil t)
 @end example
 
 To see a complete list of fonts, execute the following in the
@@ -1588,7 +1588,7 @@ non-@code{nil}, you should set it to @code{nil}:
 @cindex movemail, using pop3
 @cindex MAILHOST
 @vindex rmail-primary-inbox-list
-@vindex rmail-remote-password-required
+@vindex rmail-pop-password-required
 
 For incoming mail using the Rmail package and a POP3 server, you will
 need the following configuration:
@@ -1596,7 +1596,7 @@ need the following configuration:
 @example
 (setenv "MAILHOST" "@var{domain.name.of.your.pop3.server}")
 (setq rmail-primary-inbox-list '("po:@var{your logon id}"))
-(setq rmail-remote-password-required t)
+(setq rmail-pop-password-required t)
 @end example
 
 @node Incoming mail with Gnus
@@ -2199,10 +2199,10 @@ outdated.  Tools available here that are useful for Emacs include:
 @item GifLib - library to support GIF images.
 @item Grep - for searching through files with @code{grep}.
 @item Gzip - used by Emacs to automatically decompress .gz files.
-@item Jpeg - library to support JPEG images (also in GTK+).
+@item Jpeg - library to support JPEG images (also in GTK).
 @item Lha - used by @code{archive-mode} to edit .lzh files.
-@item LibPng - library to support PNG images (also in GTK+).
-@item LibTiff - library to support TIFF images (also in GTK+).
+@item LibPng - library to support PNG images (also in GTK).
+@item LibTiff - library to support TIFF images (also in GTK).
 @item Make - used by @code{compile} for building projects (also in MinGW)
 @item OpenSSL - used by @code{gnus} to talk to servers over SSL.
 @item Patch - used by @code{ediff-patch-file} and others to apply patches.
@@ -2211,21 +2211,21 @@ outdated.  Tools available here that are useful for Emacs include:
 @item Unzip - used by @code{archive-mode} for extracting zip files.
 @item Xpm - library to support XPM images (bundled with Emacs binaries)
 @item Zip - used by @code{archive-mode} for editing zip files.
-@item Zlib - required by LibPng (also in GTK+).
+@item Zlib - required by LibPng (also in GTK).
 @end itemize
 
 @node GTK
-@section GTK+
-@cindex GTK+ image libraries
-@cindex image libraries, GTK+
-@cindex addpm, using GTK+ image libraries
+@section GTK
+@cindex GTK image libraries
+@cindex image libraries, GTK
+@cindex addpm, using GTK image libraries
 
-GTK+ is a potential source for some of the image libraries that Emacs
-requires.  GTK+ is installed along with other ports of GUI software,
+GTK is a potential source for some of the image libraries that Emacs
+requires.  GTK is installed along with other ports of GUI software,
 such as the GIMP image editor, and Pidgin instant messenger client.
-If GTK+ is installed when you run @command{addpm}, Emacs will use the
+If GTK is installed when you run @command{addpm}, Emacs will use the
 image libraries that it provides, even if they are not on the
-@env{PATH}.  GTK+ ships with JPEG, PNG and TIFF support.
+@env{PATH}.  GTK ships with JPEG, PNG and TIFF support.
 
 @node Read man pages
 @section How do I read man pages?
diff --git a/doc/misc/efaq.texi b/doc/misc/efaq.texi
index b980e569fc..4d645ec6d4 100644
--- a/doc/misc/efaq.texi
+++ b/doc/misc/efaq.texi
@@ -173,7 +173,7 @@ Key sequences longer than one key (and some single-key sequences) are
 written inside quotes or on lines by themselves, like this:
 
 @display
-  @kbd{M-x frobnicate-while-foo @key{RET}}
+  @kbd{M-x frobnicate-while-foo RET}
 @end display
 
 @noindent
@@ -201,7 +201,7 @@ Also, on very few keyboards does @kbd{C-?} generate @acronym{ASCII} code 127.
 @section What does @file{M-x @var{command}} mean?
 @cindex Extended commands
 @cindex Commands, extended
-@cindex @kbd{M-x}, meaning of
+@cindex M-x, meaning of
 
 @kbd{M-x @var{command}} means type @kbd{M-x}, then type the name of the
 command, then type @key{RET}.  (@xref{Basic keys}, if you're not sure
@@ -3756,9 +3756,9 @@ defines the @kbd{M-@key{TAB}} key sequence.
 
 @node Backspace invokes help
 @section Why does the @key{Backspace} key invoke help?
-@cindex @key{Backspace} key invokes help
-@cindex Help invoked by @key{Backspace}
-@cindex @key{DEL} key does not delete
+@cindex Backspace key invokes help
+@cindex Help invoked by Backspace
+@cindex DEL key does not delete
 
 The @key{Backspace} key (on most keyboards) generates @acronym{ASCII} code 8.
 @kbd{C-h} sends the same code.  In Emacs by default @kbd{C-h} invokes
@@ -4103,7 +4103,7 @@ This will disable the use of the extra keysyms systemwide, which may be
 undesirable if you actually intend to use them.
 
 @node SPC no longer completes file names
-@section Why doesn't @key{SPC} complete file names anymore?
+@section Why doesn't SPC complete file names anymore?
 @cindex @kbd{SPC} file name completion
 
 Starting with Emacs 22.1, @kbd{SPC} no longer completes file names in
@@ -4288,7 +4288,7 @@ fontset, or you can select it by setting the default font in your
 @file{~/.emacs}:
 
 @lisp
-  (set-frame-font "fontset-bdf")
+  (set-default-font "fontset-bdf")
 @end lisp
 
 
diff --git a/doc/misc/eieio.texi b/doc/misc/eieio.texi
index 689ff72b72..16c341b887 100644
--- a/doc/misc/eieio.texi
+++ b/doc/misc/eieio.texi
@@ -1263,13 +1263,13 @@ The @var{parent-instance} slot indicates the instance which is
 considered the parent of the current instance.  Default is @code{nil}.
 @end deftp
 
-@cindex @code{clone}
+@cindex clone
 To use this class, inherit from it with your own class.
 To make a new instance that inherits from and existing instance of your
 class, use the @code{clone} method with additional parameters
 to specify local values.
 
-@cindex @code{slot-unbound}
+@cindex slot-unbound
 The @code{eieio-instance-inheritor} class works by causing cloned
 objects to have all slots unbound.  This class' @code{slot-unbound}
 method will cause references to unbound slots to be redirected to the
@@ -1395,7 +1395,7 @@ with a minimum of effort.
 
 @deftp {Class} eieio-speedbar buttontype buttonface
 Enables base speedbar display for a class.
-@cindex @code{speedbar-make-tag-line}
+@cindex speedbar-make-tag-line
 The slot @var{buttontype} is any of the symbols allowed by the
 function @code{speedbar-make-tag-line} for the @var{exp-button-type}
 argument @xref{Extending,,,speedbar}.
diff --git a/doc/misc/emacs-mime.texi b/doc/misc/emacs-mime.texi
index 2c607cc97c..4fbb3e5673 100644
--- a/doc/misc/emacs-mime.texi
+++ b/doc/misc/emacs-mime.texi
@@ -179,18 +179,18 @@ Emacs source code.  This item works only in the groups matching
 @code{mm-uu-emacs-sources-regexp}.
 
 @item diff
-@findex diff
+@vindex diff
 @vindex mm-uu-diff-groups-regexp
 Patches.  This is intended for groups where diffs of committed files
 are automatically sent to.  It only works in groups matching
 @code{mm-uu-diff-groups-regexp}.
 
 @item verbatim-marks
-@findex verbatim-marks
+@cindex verbatim-marks
 Slrn-style verbatim marks.
 
 @item LaTeX
-@findex LaTeX
+@cindex LaTeX
 LaTeX documents.  It only works in groups matching
 @code{mm-uu-tex-groups-regexp}.
 
@@ -1093,7 +1093,7 @@ If non-@code{nil} a format=flowed article will be displayed flowed.
 @node Interface Functions
 @chapter Interface Functions
 @cindex interface functions
-@cindex @code{mail-parse}
+@cindex mail-parse
 
 The @code{mail-parse} library is an abstraction over the actual
 low-level libraries that are described in the next chapter.
diff --git a/doc/misc/epa.texi b/doc/misc/epa.texi
index d5dfe70760..237617a524 100644
--- a/doc/misc/epa.texi
+++ b/doc/misc/epa.texi
@@ -281,22 +281,22 @@ The following keys are assigned.
 
 @table @kbd
 @item : d
-@kindex : d
+@kindex @kbd{: d}
 @findex epa-dired-do-decrypt
 Decrypt marked files.
 
 @item : v
-@kindex : v
+@kindex @kbd{: v}
 @findex epa-dired-do-verify
 Verify marked files.
 
 @item : s
-@kindex : s
+@kindex @kbd{: s}
 @findex epa-dired-do-sign
 Sign marked files.
 
 @item : e
-@kindex : e
+@kindex @kbd{: e}
 @findex epa-dired-do-encrypt
 Encrypt marked files.
 
@@ -322,26 +322,26 @@ interface.  Try @kbd{M-x customize-variable epa-global-mail-mode}.
 
 @table @kbd
 @item C-c C-e C-d and C-c C-e d
-@kindex C-c C-e C-d
-@kindex C-c C-e d
+@kindex @kbd{C-c C-e C-d}
+@kindex @kbd{C-c C-e d}
 @findex epa-mail-decrypt
 Decrypt OpenPGP armors in the current buffer.
 
 @item C-c C-e C-v and C-c C-e v
-@kindex C-c C-e C-v
-@kindex C-c C-e v
+@kindex @kbd{C-c C-e C-v}
+@kindex @kbd{C-c C-e v}
 @findex epa-mail-verify
 Verify OpenPGP cleartext signed messages in the current buffer.
 
 @item C-c C-e C-s and C-c C-e s
-@kindex C-c C-e C-s
-@kindex C-c C-e s
+@kindex @kbd{C-c C-e C-s}
+@kindex @kbd{C-c C-e s}
 @findex epa-mail-sign
 Compose a signed message from the current buffer.
 
 @item C-c C-e C-e and C-c C-e e
-@kindex C-c C-e C-e
-@kindex C-c C-e e
+@kindex @kbd{C-c C-e C-e}
+@kindex @kbd{C-c C-e e}
 @findex epa-mail-encrypt
 @vindex epa-mail-aliases
 Compose an encrypted message from the current buffer.
diff --git a/doc/misc/erc.texi b/doc/misc/erc.texi
index 55556c5281..466a4fc4b8 100644
--- a/doc/misc/erc.texi
+++ b/doc/misc/erc.texi
@@ -117,11 +117,10 @@ connect to.
 If you want to place ERC settings in their own file, you can place them
 in @file{~/.emacs.d/.ercrc.el}, creating it if necessary.
 
-If you would rather use the Customize interface to change how ERC
-works, do @kbd{M-x customize-group @key{RET} erc @key{RET}}.  In
-particular, ERC comes with lots of modules that may be enabled or
-disabled; to select which ones you want, do @kbd{M-x
-customize-variable @key{RET} erc-modules @key{RET}}.
+If you would rather use the Customize interface to change how ERC works,
+do @kbd{M-x customize-group RET erc RET}.  In particular, ERC comes with
+lots of modules that may be enabled or disabled; to select which ones
+you want, do @kbd{M-x customize-variable RET erc-modules RET}.
 
 @menu
 * Sample Session::              Example of connecting to the #emacs channel
@@ -270,14 +269,14 @@ This is a summary of keystrokes available in every ERC buffer.
 @item C-a or <home> (@code{erc-bol})
 Go to beginning of line or end of prompt.
 
-@item @key{RET} (@code{erc-send-current-line})
+@item RET (@code{erc-send-current-line})
 Send the current line
 
-@item @key{TAB} (@code{erc-complete-word})
+@item TAB (@code{erc-complete-word})
 If at prompt, complete the current word.
 Otherwise, move to the next link or button.
 
-@item M-@key{TAB} (@code{ispell-complete-word})
+@item M-TAB (@code{ispell-complete-word})
 Complete the given word, using ispell.
 
 @item C-c C-a (@code{erc-bol})
@@ -298,7 +297,7 @@ Toggle automatic CTCP replies (like VERSION and PING).
 @item C-c C-f (@code{erc-toggle-flood-control})
 Toggle use of flood control on sent messages.
 
-@item C-c @key{TAB} (@code{erc-invite-only-mode})
+@item C-c TAB (@code{erc-invite-only-mode})
 Turn on the invite only mode (+i) for the current channel.
 
 @item C-c C-j (@code{erc-join-channel})
@@ -350,9 +349,8 @@ One way to add functionality to ERC is to customize which of its many
 modules are loaded.
 
 There is a spiffy customize interface, which may be reached by typing
-@kbd{M-x customize-option @key{RET} erc-modules @key{RET}}.
-Alternatively, set @code{erc-modules} manually and then call
-@code{erc-update-modules}.
+@kbd{M-x customize-option erc-modules RET}.  Alternatively, set
+@code{erc-modules} manually and then call @code{erc-update-modules}.
 
 The following is a list of available modules.
 
@@ -745,7 +743,7 @@ stuff, to the current ERC buffer."
 
 This section is extremely incomplete.  For now, the easiest way to
 check out all the available options for ERC is to do
-@kbd{M-x customize-group @key{RET} erc @key{RET}}.
+@kbd{M-x customize-group erc RET}.
 
 @defopt erc-hide-list
 If non, @code{nil}, this is a list of IRC message types to hide, e.g.:
diff --git a/doc/misc/ert.texi b/doc/misc/ert.texi
index 82e0e27ed1..3553560f49 100644
--- a/doc/misc/ert.texi
+++ b/doc/misc/ert.texi
@@ -203,7 +203,7 @@ different Emacs versions.
 
 @findex ert
 You can run the tests that are currently defined in your Emacs with
-the command @kbd{M-x ert @key{RET} t @key{RET}}.  (For an
+the command @kbd{@kbd{M-x} ert @kbd{RET} t @kbd{RET}}.  (For an
 explanation of the @code{t} argument, @pxref{Test Selectors}.) ERT will pop
 up a new buffer, the ERT results buffer, showing the results of the
 tests run.  It looks like this:
@@ -262,9 +262,9 @@ for more details.
 
 @kindex TAB@r{, in ert results buffer}
 @kindex S-TAB@r{, in ert results buffer}
-In the ERT results buffer, @kbd{@key{TAB}} and @kbd{S-@key{TAB}} cycle between
+In the ERT results buffer, @kbd{TAB} and @kbd{S-TAB} cycle between
 buttons.  Each name of a function or macro in this buffer is a button;
-moving point to it and typing @kbd{@key{RET}} jumps to its definition.
+moving point to it and typing @kbd{RET} jumps to its definition.
 
 @kindex r@r{, in ert results buffer}
 @kindex d@r{, in ert results buffer}
@@ -273,7 +273,7 @@ moving point to it and typing @kbd{@key{RET}} jumps to its definition.
 @cindex backtrace of a failed test
 Pressing @kbd{r} re-runs the test near point on its own.  Pressing
 @kbd{d} re-runs it with the debugger enabled.  @kbd{.} jumps to the
-definition of the test near point (@kbd{@key{RET}} has the same effect if
+definition of the test near point (@kbd{RET} has the same effect if
 point is on the name of the test).  On a failed test, @kbd{b} shows
 the backtrace of the failure.
 
@@ -817,7 +817,7 @@ failed.  This can be useful to figure out how far it got.
 @item
 You can instrument tests for debugging the same way you instrument
 @code{defun}s for debugging: go to the source code of the test and
-type @kbd{C-u C-M-x}.  Then, go back to the ERT buffer and
+type @kbd{@kbd{C-u} @kbd{C-M-x}}.  Then, go back to the ERT buffer and
 re-run the test with @kbd{r} or @kbd{d}.
 
 @cindex discard obsolete test results
diff --git a/doc/misc/eshell.texi b/doc/misc/eshell.texi
index 80077e5ccd..1789767dbe 100644
--- a/doc/misc/eshell.texi
+++ b/doc/misc/eshell.texi
@@ -894,7 +894,7 @@ will happen as it should (albeit slowly).
 
 @item Make sure syntax table is correct in Eshell mode
 
-So that @kbd{M-@key{DEL}} acts in a predictable manner, etc.
+So that @kbd{M-DEL} acts in a predictable manner, etc.
 
 @item Allow all Eshell buffers to share the same history and list-dir
 
@@ -908,19 +908,19 @@ output from all subsequent commands is swallowed.
 Make it similar to the way that @file{esh-arg.el} is structured.
 Then add parsing of @samp{$[?\n]}.
 
-@item After pressing @kbd{M-@key{RET}}, redisplay before running the next command
+@item After pressing @kbd{M-RET}, redisplay before running the next command
 
 @item Argument predicates and modifiers should work anywhere in a path
 
 @example
-/usr/local/src/editors/vim $ vi **/CVS(/)/Root(.)  Invalid regexp:
-"Unmatched ( or \\("
+/usr/local/src/editors/vim $ vi **/CVS(/)/Root(.)
+Invalid regexp: "Unmatched ( or \\("
 @end example
 
 With @command{zsh}, the glob above expands to all files named
 @file{Root} in directories named @file{CVS}.
 
-@item Typing @samp{echo $@{locate locate@}/bin@key{TAB}} results in a Lisp error
+@item Typing @samp{echo $@{locate locate@}/bin<TAB>} results in a Lisp error
 
 Perhaps it should interpolate all permutations, and make that the
 globbing result, since otherwise hitting return here will result in
@@ -960,7 +960,7 @@ At the moment, this is not supported.
 An error should be generated only if @code{eshell-error-if-no-glob} is
 non-@code{nil}.
 
-@item @samp{(+ @key{RET} @key{SPC} @key{TAB}} does not cause @code{indent-according-to-mode} to occur
+@item @samp{(+ RET SPC TAB} does not cause @code{indent-according-to-mode} to occur
 
 @item Create @code{eshell-auto-accumulate-list}
 
@@ -1172,8 +1172,8 @@ only.  That way, it could be listed as a login shell.
 @item Make @kbd{/} electric
 
 So that it automatically expands and corrects pathnames.  Or make
-pathname completion for Pcomplete auto-expand @samp{/u/i/std@key{TAB}} to
-@samp{/usr/include/std@key{TAB}}.
+pathname completion for Pcomplete auto-expand @samp{/u/i/std<TAB>} to
+@samp{/usr/include/std<TAB>}.
 
 @item Write the @command{pushd} stack to disk along with @code{last-dir-ring}
 
@@ -1221,7 +1221,7 @@ If the first thing that I do after entering Emacs is to run
 @code{eshell-command} and invoke @command{ls}, and then use @kbd{M-x
 eshell}, it doesn't display anything.
 
-@item @kbd{M-@key{RET}} during a long command (using smart display) doesn't work
+@item @kbd{M-RET} during a long command (using smart display) doesn't work
 
 Since it keeps the cursor up where the command was invoked.
 
diff --git a/doc/misc/eww.texi b/doc/misc/eww.texi
index 43adc2eda0..258a2f2bff 100644
--- a/doc/misc/eww.texi
+++ b/doc/misc/eww.texi
@@ -99,7 +99,7 @@ web page hit @kbd{g} (@code{eww-reload}).  Pressing @kbd{w}
 
 @findex eww-open-in-new-buffer
 @kindex M-RET
-  The @kbd{M-@key{RET}} command (@code{eww-open-in-new-buffer}) opens the
+  The @kbd{M-RET} command (@code{eww-open-in-new-buffer}) opens the
 URL at point in a new EWW buffer, akin to opening a link in a new
 ``tab'' in other browsers.
 
diff --git a/doc/misc/forms.texi b/doc/misc/forms.texi
index 70463419e8..9857a67745 100644
--- a/doc/misc/forms.texi
+++ b/doc/misc/forms.texi
@@ -263,14 +263,14 @@ prompted for confirmation before the record is deleted unless a numeric
 argument has been provided.
 
 @findex forms-search-forward
-@kindex C-c C-s @var{regexp} RET
+@kindex C-c C-s @var{regexp} @key{RET}
 @item C-c C-s @var{regexp} @key{RET}
 Search forward for @var{regexp} in all records following this one
 (@code{forms-search-forward}).  If found, this record is shown.
 If you give an empty argument, the previous regexp is used again.
 
 @findex forms-search-backward
-@kindex C-c C-r @var{regexp} RET
+@kindex C-c C-r @var{regexp} @key{RET}
 @item C-c C-r @var{regexp} @key{RET}
 Search backward for @var{regexp} in all records following this one
 (@code{forms-search-backward}).  If found, this record is shown.
@@ -334,25 +334,25 @@ The following function key definitions are set up in Forms mode
 (whether read-only or not):
 
 @table @kbd
-@kindex NEXT
-@item @key{NEXT}
+@kindex next
+@item next
 forms-next-record
 
-@kindex PRIOR
-@item @key{PRIOR}
+@kindex prior
+@item prior
 forms-prev-record
 
-@kindex BEGIN
-@item @key{BEGIN}
+@kindex begin
+@item begin
 forms-first-record
 
-@kindex END
-@item @key{END}
+@kindex end
+@item end
 forms-last-record
 
-@kindex S-TAB
+@kindex S-Tab
 @findex forms-prev-field
-@item S-@key{TAB}
+@item S-Tab
 forms-prev-field
 @end table
 
diff --git a/doc/misc/gnus-faq.texi b/doc/misc/gnus-faq.texi
index efef01f697..4175c88754 100644
--- a/doc/misc/gnus-faq.texi
+++ b/doc/misc/gnus-faq.texi
@@ -397,7 +397,7 @@ The ~/ means the home directory where Gnus and Emacs look
 for the configuration files.  However, you don't really
 need to know what this means, it suffices that Emacs knows
 what it means :-) You can type
-@samp{C-x C-f ~/.gnus.el @key{RET}}
+@samp{C-x C-f ~/.gnus.el RET }
 (yes, with the forward slash, even on Windows), and
 Emacs will open the right file for you.  (It will most
 likely be new, and thus empty.)
@@ -422,7 +422,7 @@ possibility to set environment variables.  Create a new one with
 name HOME and value C:\myhome.  Rebooting is not necessary.
 
 Now to create @file{~/.gnus.el}, say
-@samp{C-x C-f ~/.gnus.el @key{RET} C-x C-s}.
+@samp{C-x C-f ~/.gnus.el RET C-x C-s}.
 in Emacs.
 
 @node FAQ 3-3
@@ -459,11 +459,11 @@ subscribe to a group.
 @subsubheading Answer
 
 If you know the name of the group say @samp{U
-name.of.group @key{RET}} in group buffer (use the
+name.of.group RET} in group buffer (use the
 tab-completion Luke). Otherwise hit ^ in group buffer,
 this brings you to the server buffer. Now place point (the
 cursor) over the server which carries the group you want,
-hit @samp{@key{RET}}, move point to the group
+hit @samp{RET}, move point to the group
 you want to subscribe to and say @samp{u}
 to subscribe to it.
 
@@ -753,11 +753,11 @@ When I enter a group, all read messages are gone. How to view them again?
 @subsubheading Answer
 
 If you enter the group by saying
-@samp{@key{RET}}
+@samp{RET}
 in group buffer with point over the group, only unread and ticked messages are loaded. Say
-@samp{C-u @key{RET}}
+@samp{C-u RET}
 instead to load all available messages. If you want only the 300 newest say
-@samp{C-u 300 @key{RET}}
+@samp{C-u 300 RET}
 
 Loading only unread messages can be annoying if you have threaded view enabled, say
 
@@ -1019,7 +1019,7 @@ back ends. Gnus thinks ``highest-article-number @minus{}
 lowest-article-number = total-number-of-articles''. This
 works OK for Usenet groups, but if you delete and move
 many messages in mail groups, this fails. To cure the
-symptom, enter the group via @samp{C-u @key{RET}}
+symptom, enter the group via @samp{C-u RET}
 (this makes Gnus get all messages), then
 hit @samp{M P b} to mark all messages and
 then say @samp{B m name.of.group} to move
@@ -1494,8 +1494,8 @@ place them in ~/.emacs:
 @end example
 @noindent
 
-Now you should be ready to go. Say @samp{M-x bbdb @key{RET}
-@key{RET}} to open a bbdb buffer showing all
+Now you should be ready to go. Say @samp{M-x bbdb RET
+RET} to open a bbdb buffer showing all
 entries. Say @samp{c} to create a new
 entry, @samp{b} to search your BBDB and
 @samp{C-o} to add a new field to an
@@ -1734,15 +1734,15 @@ world, you may find tools at
 
 Now you've got to import this mbox file into Gnus. To do
 this, create a nndoc group based on the mbox file by
-saying @samp{G f /path/file.mbox @key{RET}} in
+saying @samp{G f /path/file.mbox RET} in
 Group buffer. You now have read-only access to your
 mail. If you want to import the messages to your normal
 Gnus mail groups hierarchy, enter the nndoc group you've
-just created by saying @samp{C-u @key{RET}}
+just created by saying @samp{C-u RET}
 (thus making sure all messages are retrieved), mark all
 messages by saying @samp{M P b} and
 either copy them to the desired group by saying
-@samp{B c name.of.group @key{RET}} or send them
+@samp{B c name.of.group RET} or send them
 through nnmail-split-methods (respool them) by saying
 @samp{B r}.
 
@@ -1809,7 +1809,7 @@ a Usenet group the easiest solution is probably to ask
 @uref{http://groups.google.com, groups.google.com},
 if you found the posting there, tell Google to display
 the raw message, look for the message-id, and say
-@samp{M-^ the@@message.id @key{RET}} in a
+@samp{M-^ the@@message.id RET} in a
 summary buffer.
 Since Gnus 5.10 there's also a Gnus interface for
 groups.google.com which you can call with
@@ -1853,7 +1853,7 @@ How to get rid of old unwanted mail?
 
 You can of course just mark the mail you don't need
 anymore by saying @samp{#} with point
-over the mail and then say @samp{B @key{DEL}}
+over the mail and then say @samp{B DEL}
 to get rid of them forever. You could also instead of
 actually deleting them, send them to a junk-group by
 saying @samp{B m nnml:trash-bin} which
@@ -2089,7 +2089,7 @@ How to find information and help inside Emacs?
 @subsubheading Answer
 
 The first stop should be the Gnus manual (Say
-@samp{C-h i d m Gnus @key{RET}} to start the
+@samp{C-h i d m Gnus RET} to start the
 Gnus manual, then walk through the menus or do a
 full-text search with @samp{s}). Then
 there are the general Emacs help commands starting with
@@ -2191,8 +2191,8 @@ The reason for this could be the way Gnus reads its
 active file, see the node "The Active File" in the Gnus
 manual for things you might try to speed the process up.
 An other idea would be to byte compile your @file{~/.gnus.el} (say
-@samp{M-x byte-compile-file @key{RET} ~/.gnus.el
-@key{RET}} to do it). Finally, if you have require
+@samp{M-x byte-compile-file RET ~/.gnus.el
+RET} to do it). Finally, if you have require
 statements in your .gnus, you could replace them with
 @code{with-eval-after-load}, which loads the stuff not at startup
 time, but when it's needed. Say you've got this in your
diff --git a/doc/misc/gnus-news.texi b/doc/misc/gnus-news.texi
index 171f59a3ad..91908584c9 100644
--- a/doc/misc/gnus-news.texi
+++ b/doc/misc/gnus-news.texi
@@ -324,7 +324,7 @@ messages are deleted again).
 @itemize @bullet
 
 @item The tool bar has been updated to use GNOME icons.
-You can also customize the tool bars: @kbd{M-x customize-apropos @key{RET}
+You can also customize the tool bars: @kbd{M-x customize-apropos RET
 -tool-bar$} should get you started.  (Only for Emacs, not in XEmacs.)
 @c FIXME: Document this in the manual
 
diff --git a/doc/misc/gnus.texi b/doc/misc/gnus.texi
index cc4b2342be..17fbe0e3e3 100644
--- a/doc/misc/gnus.texi
+++ b/doc/misc/gnus.texi
@@ -959,6 +959,7 @@ Emacs for Heathens
 If you haven't used Emacs much before using Gnus, read @ref{Emacs for
 Heathens} first.
 
+@kindex M-x gnus
 @findex gnus
 If your system administrator has set things up properly, starting Gnus
 and reading news is extremely easy---you just type @kbd{M-x gnus} in
@@ -968,6 +969,7 @@ minimal setup for posting should also customize the variables
 @code{user-full-name} and @code{user-mail-address}.
 
 @findex gnus-other-frame
+@kindex M-x gnus-other-frame
 If you want to start Gnus in a different frame, you can use the command
 @kbd{M-x gnus-other-frame} instead.
 
@@ -998,7 +1000,7 @@ terminology section (@pxref{Terminology}).
 First of all, you should know that there is a special buffer called
 @file{*Server*} that lists all the servers Gnus knows about.  You can
 press @kbd{^} from the Group buffer to see it.  In the Server buffer,
-you can press @kbd{@key{RET}} on a defined server to see all the groups it
+you can press @kbd{RET} on a defined server to see all the groups it
 serves (subscribed or not!).  You can also add or delete servers, edit
 a foreign server's definition, agentize or de-agentize a server, and
 do many other neat things.  @xref{Server Buffer}.
@@ -1041,7 +1043,7 @@ If that fails as well, Gnus will try to use the machine running Emacs
 as an @acronym{NNTP} server.  That's a long shot, though.
 
 @findex gnus-group-browse-foreign-server
-@kindex B @r{(Group)}
+@kindex B (Group)
 However, if you use one @acronym{NNTP} server regularly and are just
 interested in a couple of groups from a different server, you would be
 better served by using the @kbd{B} command in the group buffer.  It will
@@ -1085,6 +1087,7 @@ groups, you'll find it difficult to actually do anything in the group
 buffer.  But, hey, that's your problem.  Blllrph!
 
 @findex gnus-no-server
+@kindex M-x gnus-no-server
 @c @head
 If you know that the server is definitely down, or you just want to read
 your mail without bothering with the server at all, you can use the
@@ -1351,11 +1354,13 @@ you have read is by keeping track of article numbers.  So when you
 change @code{gnus-select-method}, your @file{.newsrc} file becomes
 worthless.
 
+@kindex M-x gnus-group-clear-data-on-native-groups
 @findex gnus-group-clear-data-on-native-groups
 You can use the @kbd{M-x gnus-group-clear-data-on-native-groups}
 command to clear out all data that you have on your native groups.
 Use with caution.
 
+@kindex M-x gnus-group-clear-data
 @findex gnus-group-clear-data
 Clear the data from the current group only---nix out marks and the
 list of read articles (@code{gnus-group-clear-data}).
@@ -1699,7 +1704,7 @@ long as Gnus is active.
 @end menu
 
 You can customize the Group Mode tool bar, see @kbd{M-x
-customize-apropos @key{RET} gnus-group-tool-bar}.  This feature is only
+customize-apropos RET gnus-group-tool-bar}.  This feature is only
 available in Emacs.
 
 The tool bar icons are now (de)activated correctly depending on the
@@ -1984,37 +1989,37 @@ expected, hopefully.
 @table @kbd
 
 @item n
-@kindex n @r{(Group)}
+@kindex n (Group)
 @findex gnus-group-next-unread-group
 Go to the next group that has unread articles
 (@code{gnus-group-next-unread-group}).
 
 @item p
-@itemx @key{DEL}
-@kindex DEL @r{(Group)}
-@kindex p @r{(Group)}
+@itemx DEL
+@kindex DEL (Group)
+@kindex p (Group)
 @findex gnus-group-prev-unread-group
 Go to the previous group that has unread articles
 (@code{gnus-group-prev-unread-group}).
 
 @item N
-@kindex N @r{(Group)}
+@kindex N (Group)
 @findex gnus-group-next-group
 Go to the next group (@code{gnus-group-next-group}).
 
 @item P
-@kindex P @r{(Group)}
+@kindex P (Group)
 @findex gnus-group-prev-group
 Go to the previous group (@code{gnus-group-prev-group}).
 
 @item M-n
-@kindex M-n @r{(Group)}
+@kindex M-n (Group)
 @findex gnus-group-next-unread-group-same-level
 Go to the next unread group on the same (or lower) level
 (@code{gnus-group-next-unread-group-same-level}).
 
 @item M-p
-@kindex M-p @r{(Group)}
+@kindex M-p (Group)
 @findex gnus-group-prev-unread-group-same-level
 Go to the previous unread group on the same (or lower) level
 (@code{gnus-group-prev-unread-group-same-level}).
@@ -2025,20 +2030,20 @@ Three commands for jumping to groups:
 @table @kbd
 
 @item j
-@kindex j @r{(Group)}
+@kindex j (Group)
 @findex gnus-group-jump-to-group
 Jump to a group (and make it visible if it isn't already)
 (@code{gnus-group-jump-to-group}).  Killed groups can be jumped to, just
 like living groups.
 
 @item ,
-@kindex , @r{(Group)}
+@kindex , (Group)
 @findex gnus-group-best-unread-group
 Jump to the unread group with the lowest level
 (@code{gnus-group-best-unread-group}).
 
 @item .
-@kindex . @r{(Group)}
+@kindex . (Group)
 @findex gnus-group-first-unread-group
 Jump to the first group with unread articles
 (@code{gnus-group-first-unread-group}).
@@ -2062,8 +2067,8 @@ Otherwise, the point is set to the group just exited.  The default is
 
 @table @kbd
 
-@item @key{SPC}
-@kindex SPC @r{(Group)}
+@item SPACE
+@kindex SPACE (Group)
 @findex gnus-group-read-group
 Select the current group, switch to the summary buffer and display the
 first unread article (@code{gnus-group-read-group}).  If there are no
@@ -2074,16 +2079,16 @@ determines the number of articles Gnus will fetch.  If @var{n} is
 positive, Gnus fetches the @var{n} newest articles, if @var{n} is
 negative, Gnus fetches the @code{abs(@var{n})} oldest articles.
 
-Thus, @kbd{@key{SPC}} enters the group normally, @kbd{C-u @key{SPC}}
-offers old articles, @kbd{C-u 4 2 @key{SPC}} fetches the 42 newest
-articles, and @kbd{C-u - 4 2 @key{SPC}} fetches the 42 oldest ones.
+Thus, @kbd{SPC} enters the group normally, @kbd{C-u SPC} offers old
+articles, @kbd{C-u 4 2 SPC} fetches the 42 newest articles, and @kbd{C-u
+- 4 2 SPC} fetches the 42 oldest ones.
 
 When you are in the group (in the Summary buffer), you can type
 @kbd{M-g} to fetch new articles, or @kbd{C-u M-g} to also show the old
 ones.
 
-@item @key{RET}
-@kindex RET @r{(Group)}
+@item RET
+@kindex RET (Group)
 @findex gnus-group-select-group
 Select the current group and switch to the summary buffer
 (@code{gnus-group-select-group}).  Takes the same arguments as
@@ -2091,27 +2096,27 @@ Select the current group and switch to the summary buffer
 does not display the first unread article automatically upon group
 entry.
 
-@item M-@key{RET}
-@kindex M-RET @r{(Group)}
+@item M-RET
+@kindex M-RET (Group)
 @findex gnus-group-quick-select-group
 This does the same as the command above, but tries to do it with the
 minimum amount of fuzz (@code{gnus-group-quick-select-group}).  No
 scoring/killing will be performed, there will be no highlights and no
 expunging.  This might be useful if you're in a real hurry and have to
 enter some humongous group.  If you give a 0 prefix to this command
-(i.e., @kbd{0 M-@key{RET}}), Gnus won't even generate the summary buffer,
+(i.e., @kbd{0 M-RET}), Gnus won't even generate the summary buffer,
 which is useful if you want to toggle threading before generating the
 summary buffer (@pxref{Summary Generation Commands}).
 
-@item M-@key{SPC}
-@kindex M-SPC @r{(Group)}
+@item M-SPACE
+@kindex M-SPACE (Group)
 @findex gnus-group-visible-select-group
-This is yet one more command that does the same as the @kbd{@key{RET}}
+This is yet one more command that does the same as the @kbd{RET}
 command, but this one does it without expunging and hiding dormants
 (@code{gnus-group-visible-select-group}).
 
-@item C-M-@key{RET}
-@kindex C-M-RET @r{(Group)}
+@item C-M-RET
+@kindex C-M-RET (Group)
 @findex gnus-group-select-group-ephemerally
 Finally, this command selects the current group ephemerally without
 doing any processing of its contents
@@ -2159,7 +2164,7 @@ means Gnus never ignores old articles.
 @vindex gnus-auto-select-first
 @vindex gnus-auto-select-subject
 If @code{gnus-auto-select-first} is non-@code{nil}, select an article
-automatically when entering a group with the @kbd{@key{SPC}} command.
+automatically when entering a group with the @kbd{SPACE} command.
 Which article this is controlled by the
 @code{gnus-auto-select-subject} variable.  Valid values for this
 variable are:
@@ -2202,15 +2207,15 @@ selected.
 The following commands allow for managing your subscriptions in the
 Group buffer.  If you want to subscribe to many groups, it's probably
 more convenient to go to the @ref{Server Buffer}, and choose the
-server there using @kbd{@key{RET}} or @kbd{@key{SPC}}.  Then you'll have the
+server there using @kbd{RET} or @kbd{SPC}.  Then you'll have the
 commands listed in @ref{Browse Foreign Server} at hand.
 
 @table @kbd
 
 @item S t
 @itemx u
-@kindex S t @r{(Group)}
-@kindex u @r{(Group)}
+@kindex S t (Group)
+@kindex u (Group)
 @findex gnus-group-unsubscribe-current-group
 @c @icon{gnus-group-unsubscribe}
 Toggle subscription to the current group
@@ -2218,8 +2223,8 @@ Toggle subscription to the current group
 
 @item S s
 @itemx U
-@kindex S s @r{(Group)}
-@kindex U @r{(Group)}
+@kindex S s (Group)
+@kindex U (Group)
 @findex gnus-group-unsubscribe-group
 Prompt for a group to subscribe, and then subscribe it.  If it was
 subscribed already, unsubscribe it instead
@@ -2227,21 +2232,21 @@ subscribed already, unsubscribe it instead
 
 @item S k
 @itemx C-k
-@kindex S k @r{(Group)}
-@kindex C-k @r{(Group)}
+@kindex S k (Group)
+@kindex C-k (Group)
 @findex gnus-group-kill-group
 @c @icon{gnus-group-kill-group}
 Kill the current group (@code{gnus-group-kill-group}).
 
 @item S y
 @itemx C-y
-@kindex S y @r{(Group)}
-@kindex C-y @r{(Group)}
+@kindex S y (Group)
+@kindex C-y (Group)
 @findex gnus-group-yank-group
 Yank the last killed group (@code{gnus-group-yank-group}).
 
 @item C-x C-t
-@kindex C-x C-t @r{(Group)}
+@kindex C-x C-t (Group)
 @findex gnus-group-transpose-groups
 Transpose two groups (@code{gnus-group-transpose-groups}).  This isn't
 really a subscription command, but you can use it instead of a
@@ -2249,18 +2254,18 @@ kill-and-yank sequence sometimes.
 
 @item S w
 @itemx C-w
-@kindex S w @r{(Group)}
-@kindex C-w @r{(Group)}
+@kindex S w (Group)
+@kindex C-w (Group)
 @findex gnus-group-kill-region
 Kill all groups in the region (@code{gnus-group-kill-region}).
 
 @item S z
-@kindex S z @r{(Group)}
+@kindex S z (Group)
 @findex gnus-group-kill-all-zombies
 Kill all zombie groups (@code{gnus-group-kill-all-zombies}).
 
 @item S C-k
-@kindex S C-k @r{(Group)}
+@kindex S C-k (Group)
 @findex gnus-group-kill-level
 Kill all groups on a certain level (@code{gnus-group-kill-level}).
 These groups can't be yanked back after killing, so this command should
@@ -2281,7 +2286,7 @@ Also @pxref{Group Levels}.
 @table @kbd
 
 @item c
-@kindex c @r{(Group)}
+@kindex c (Group)
 @findex gnus-group-catchup-current
 @vindex gnus-group-catchup-group-hook
 @c @icon{gnus-group-catchup-current}
@@ -2291,18 +2296,19 @@ Mark all unticked articles in this group as read
 the group buffer.
 
 @item C
-@kindex C @r{(Group)}
+@kindex C (Group)
 @findex gnus-group-catchup-current-all
 Mark all articles in this group, even the ticked ones, as read
 (@code{gnus-group-catchup-current-all}).
 
 @item M-c
-@kindex M-c @r{(Group)}
+@kindex M-c (Group)
 @findex gnus-group-clear-data
 Clear the data from the current group---nix out marks and the list of
 read articles (@code{gnus-group-clear-data}).
 
 @item M-x gnus-group-clear-data-on-native-groups
+@kindex M-x gnus-group-clear-data-on-native-groups
 @findex gnus-group-clear-data-on-native-groups
 If you have switched from one @acronym{NNTP} server to another, all your marks
 and read ranges have become worthless.  You can use this command to
@@ -2328,7 +2334,7 @@ Remember:  The higher the level of the group, the less important it is.
 @table @kbd
 
 @item S l
-@kindex S l @r{(Group)}
+@kindex S l (Group)
 @findex gnus-group-set-current-level
 Set the level of the current group.  If a numeric prefix is given, the
 next @var{n} groups will have their levels set.  The user will be
@@ -2472,37 +2478,37 @@ with the process mark and then execute the command.
 @table @kbd
 
 @item #
-@kindex # @r{(Group)}
+@kindex # (Group)
 @itemx M m
-@kindex M m @r{(Group)}
+@kindex M m (Group)
 @findex gnus-group-mark-group
 Set the mark on the current group (@code{gnus-group-mark-group}).
 
 @item M-#
-@kindex M-# @r{(Group)}
+@kindex M-# (Group)
 @itemx M u
-@kindex M u @r{(Group)}
+@kindex M u (Group)
 @findex gnus-group-unmark-group
 Remove the mark from the current group
 (@code{gnus-group-unmark-group}).
 
 @item M U
-@kindex M U @r{(Group)}
+@kindex M U (Group)
 @findex gnus-group-unmark-all-groups
 Remove the mark from all groups (@code{gnus-group-unmark-all-groups}).
 
 @item M w
-@kindex M w @r{(Group)}
+@kindex M w (Group)
 @findex gnus-group-mark-region
 Mark all groups between point and mark (@code{gnus-group-mark-region}).
 
 @item M b
-@kindex M b @r{(Group)}
+@kindex M b (Group)
 @findex gnus-group-mark-buffer
 Mark all groups in the buffer (@code{gnus-group-mark-buffer}).
 
 @item M r
-@kindex M r @r{(Group)}
+@kindex M r (Group)
 @findex gnus-group-mark-regexp
 Mark all groups that match some regular expression
 (@code{gnus-group-mark-regexp}).
@@ -2543,7 +2549,7 @@ variable @code{gnus-parameters}, @xref{Group Parameters}.
 @table @kbd
 
 @item G m
-@kindex G m @r{(Group)}
+@kindex G m (Group)
 @findex gnus-group-make-group
 @cindex making groups
 Make a new group (@code{gnus-group-make-group}).  Gnus will prompt you
@@ -2551,13 +2557,13 @@ for a name, a method and possibly an @dfn{address}.  For an easier way
 to subscribe to @acronym{NNTP} groups (@pxref{Browse Foreign Server}).
 
 @item G M
-@kindex G M @r{(Group)}
+@kindex G M (Group)
 @findex gnus-group-read-ephemeral-group
 Make an ephemeral group (@code{gnus-group-read-ephemeral-group}).  Gnus
 will prompt you for a name, a method and an @dfn{address}.
 
 @item G r
-@kindex G r @r{(Group)}
+@kindex G r (Group)
 @findex gnus-group-rename-group
 @cindex renaming groups
 Rename the current group to something else
@@ -2566,45 +2572,45 @@ groups---mail groups mostly.  This command might very well be quite slow
 on some back ends.
 
 @item G c
-@kindex G c @r{(Group)}
+@kindex G c (Group)
 @cindex customizing
 @findex gnus-group-customize
 Customize the group parameters (@code{gnus-group-customize}).
 
 @item G e
-@kindex G e @r{(Group)}
+@kindex G e (Group)
 @findex gnus-group-edit-group-method
 @cindex renaming groups
 Enter a buffer where you can edit the select method of the current
 group (@code{gnus-group-edit-group-method}).
 
 @item G p
-@kindex G p @r{(Group)}
+@kindex G p (Group)
 @findex gnus-group-edit-group-parameters
 Enter a buffer where you can edit the group parameters
 (@code{gnus-group-edit-group-parameters}).
 
 @item G E
-@kindex G E @r{(Group)}
+@kindex G E (Group)
 @findex gnus-group-edit-group
 Enter a buffer where you can edit the group info
 (@code{gnus-group-edit-group}).
 
 @item G d
-@kindex G d @r{(Group)}
+@kindex G d (Group)
 @findex gnus-group-make-directory-group
 @cindex nndir
 Make a directory group (@pxref{Directory Groups}).  You will be prompted
 for the directory's name (@code{gnus-group-make-directory-group}).
 
 @item G h
-@kindex G h @r{(Group)}
+@kindex G h (Group)
 @cindex help group
 @findex gnus-group-make-help-group
 Make the Gnus help group (@code{gnus-group-make-help-group}).
 
 @item G D
-@kindex G D @r{(Group)}
+@kindex G D (Group)
 @findex gnus-group-enter-directory
 @cindex nneething
 Read an arbitrary directory as if it were a newsgroup with the
@@ -2612,7 +2618,7 @@ Read an arbitrary directory as if it were a newsgroup with the
 @xref{Anything Groups}.
 
 @item G f
-@kindex G f @r{(Group)}
+@kindex G f (Group)
 @findex gnus-group-make-doc-group
 @cindex ClariNet Briefs
 @cindex nndoc
@@ -2628,14 +2634,14 @@ you run this command without a prefix, Gnus will guess at the file
 type.  @xref{Document Groups}.
 
 @item G u
-@kindex G u @r{(Group)}
+@kindex G u (Group)
 @vindex gnus-useful-groups
 @findex gnus-group-make-useful-group
 Create one of the groups mentioned in @code{gnus-useful-groups}
 (@code{gnus-group-make-useful-group}).
 
 @item G w
-@kindex G w @r{(Group)}
+@kindex G w (Group)
 @findex gnus-group-make-web-group
 @cindex Google
 @cindex nnweb
@@ -2652,14 +2658,14 @@ to a particular group by using a match string like
 @samp{shaving group:alt.sysadmin.recovery}.
 
 @item G R
-@kindex G R @r{(Group)}
+@kindex G R (Group)
 @findex gnus-group-make-rss-group
 Make a group based on an @acronym{RSS} feed
 (@code{gnus-group-make-rss-group}).  You will be prompted for an URL@.
 @xref{RSS}.
 
-@item G @key{DEL}
-@kindex G DEL @r{(Group)}
+@item G DEL
+@kindex G DEL (Group)
 @findex gnus-group-delete-group
 This function will delete the current group
 (@code{gnus-group-delete-group}).  If given a prefix, this function will
@@ -2669,13 +2675,13 @@ absolutely sure of what you are doing.  This command can't be used on
 read-only groups (like @code{nntp} groups), though.
 
 @item G V
-@kindex G V @r{(Group)}
+@kindex G V (Group)
 @findex gnus-group-make-empty-virtual
 Make a new, fresh, empty @code{nnvirtual} group
 (@code{gnus-group-make-empty-virtual}).  @xref{Virtual Groups}.
 
 @item G v
-@kindex G v @r{(Group)}
+@kindex G v (Group)
 @findex gnus-group-add-to-virtual
 Add the current group to an @code{nnvirtual} group
 (@code{gnus-group-add-to-virtual}).  Uses the process/prefix convention.
@@ -3254,8 +3260,8 @@ These commands all list various slices of the groups available.
 
 @item l
 @itemx A s
-@kindex A s @r{(Group)}
-@kindex l @r{(Group)}
+@kindex A s (Group)
+@kindex l (Group)
 @findex gnus-group-list-groups
 List all groups that have unread articles
 (@code{gnus-group-list-groups}).  If the numeric prefix is used, this
@@ -3266,8 +3272,8 @@ groups).
 
 @item L
 @itemx A u
-@kindex A u @r{(Group)}
-@kindex L @r{(Group)}
+@kindex A u (Group)
+@kindex L (Group)
 @findex gnus-group-list-all-groups
 List all groups, whether they have unread articles or not
 (@code{gnus-group-list-all-groups}).  If the numeric prefix is used,
@@ -3276,14 +3282,14 @@ it lists groups of level seven or lower (i.e., just subscribed and
 unsubscribed groups).
 
 @item A l
-@kindex A l @r{(Group)}
+@kindex A l (Group)
 @findex gnus-group-list-level
 List all unread groups on a specific level
 (@code{gnus-group-list-level}).  If given a prefix, also list the groups
 with no unread articles.
 
 @item A k
-@kindex A k @r{(Group)}
+@kindex A k (Group)
 @findex gnus-group-list-killed
 List all killed groups (@code{gnus-group-list-killed}).  If given a
 prefix argument, really list all groups that are available, but aren't
@@ -3291,23 +3297,23 @@ currently (un)subscribed.  This could entail reading the active file
 from the server.
 
 @item A z
-@kindex A z @r{(Group)}
+@kindex A z (Group)
 @findex gnus-group-list-zombies
 List all zombie groups (@code{gnus-group-list-zombies}).
 
 @item A m
-@kindex A m @r{(Group)}
+@kindex A m (Group)
 @findex gnus-group-list-matching
 List all unread, subscribed groups with names that match a regexp
 (@code{gnus-group-list-matching}).
 
 @item A M
-@kindex A M @r{(Group)}
+@kindex A M (Group)
 @findex gnus-group-list-all-matching
 List groups that match a regexp (@code{gnus-group-list-all-matching}).
 
 @item A A
-@kindex A A @r{(Group)}
+@kindex A A (Group)
 @findex gnus-group-list-active
 List absolutely all groups in the active file(s) of the
 server(s) you are connected to (@code{gnus-group-list-active}).  This
@@ -3318,34 +3324,34 @@ don't exist (yet)---these will be listed as if they were killed groups.
 Take the output with some grains of salt.
 
 @item A a
-@kindex A a @r{(Group)}
+@kindex A a (Group)
 @findex gnus-group-apropos
 List all groups that have names that match a regexp
 (@code{gnus-group-apropos}).
 
 @item A d
-@kindex A d @r{(Group)}
+@kindex A d (Group)
 @findex gnus-group-description-apropos
 List all groups that have names or descriptions that match a regexp
 (@code{gnus-group-description-apropos}).
 
 @item A c
-@kindex A c @r{(Group)}
+@kindex A c (Group)
 @findex gnus-group-list-cached
 List all groups with cached articles (@code{gnus-group-list-cached}).
 
 @item A ?
-@kindex A ? @r{(Group)}
+@kindex A ? (Group)
 @findex gnus-group-list-dormant
 List all groups with dormant articles (@code{gnus-group-list-dormant}).
 
 @item A !
-@kindex A ! @r{(Group)}
+@kindex A ! (Group)
 @findex gnus-group-list-ticked
 List all groups with ticked articles (@code{gnus-group-list-ticked}).
 
 @item A /
-@kindex A / @r{(Group)}
+@kindex A / (Group)
 @findex gnus-group-list-limit
 Further limit groups within the current selection
 (@code{gnus-group-list-limit}).  If you've first limited to groups
@@ -3355,12 +3361,12 @@ giving you the groups that have both dormant articles and cached
 articles.
 
 @item A f
-@kindex A f @r{(Group)}
+@kindex A f (Group)
 @findex gnus-group-list-flush
 Flush groups from the current selection (@code{gnus-group-list-flush}).
 
 @item A p
-@kindex A p @r{(Group)}
+@kindex A p (Group)
 @findex gnus-group-list-plus
 List groups plus the current selection (@code{gnus-group-list-plus}).
 
@@ -3384,7 +3390,7 @@ groups.  It is @code{t} by default.
 @section Sorting Groups
 @cindex sorting groups
 
-@kindex C-c C-s @r{(Group)}
+@kindex C-c C-s (Group)
 @findex gnus-group-sort-groups
 @vindex gnus-group-sort-function
 The @kbd{C-c C-s} (@code{gnus-group-sort-groups}) command sorts the
@@ -3440,43 +3446,43 @@ some sorting criteria:
 
 @table @kbd
 @item G S a
-@kindex G S a @r{(Group)}
+@kindex G S a (Group)
 @findex gnus-group-sort-groups-by-alphabet
 Sort the group buffer alphabetically by group name
 (@code{gnus-group-sort-groups-by-alphabet}).
 
 @item G S u
-@kindex G S u @r{(Group)}
+@kindex G S u (Group)
 @findex gnus-group-sort-groups-by-unread
 Sort the group buffer by the number of unread articles
 (@code{gnus-group-sort-groups-by-unread}).
 
 @item G S l
-@kindex G S l @r{(Group)}
+@kindex G S l (Group)
 @findex gnus-group-sort-groups-by-level
 Sort the group buffer by group level
 (@code{gnus-group-sort-groups-by-level}).
 
 @item G S v
-@kindex G S v @r{(Group)}
+@kindex G S v (Group)
 @findex gnus-group-sort-groups-by-score
 Sort the group buffer by group score
 (@code{gnus-group-sort-groups-by-score}).  @xref{Group Score}.
 
 @item G S r
-@kindex G S r @r{(Group)}
+@kindex G S r (Group)
 @findex gnus-group-sort-groups-by-rank
 Sort the group buffer by group rank
 (@code{gnus-group-sort-groups-by-rank}).  @xref{Group Score}.
 
 @item G S m
-@kindex G S m @r{(Group)}
+@kindex G S m (Group)
 @findex gnus-group-sort-groups-by-method
 Sort the group buffer alphabetically by back end name@*
 (@code{gnus-group-sort-groups-by-method}).
 
 @item G S n
-@kindex G S n @r{(Group)}
+@kindex G S n (Group)
 @findex gnus-group-sort-groups-by-real-name
 Sort the group buffer alphabetically by real (unprefixed) group name
 (@code{gnus-group-sort-groups-by-real-name}).
@@ -3493,49 +3499,49 @@ You can also sort a subset of the groups:
 
 @table @kbd
 @item G P a
-@kindex G P a @r{(Group)}
+@kindex G P a (Group)
 @findex gnus-group-sort-selected-groups-by-alphabet
 Sort the groups alphabetically by group name
 (@code{gnus-group-sort-selected-groups-by-alphabet}).
 
 @item G P u
-@kindex G P u @r{(Group)}
+@kindex G P u (Group)
 @findex gnus-group-sort-selected-groups-by-unread
 Sort the groups by the number of unread articles
 (@code{gnus-group-sort-selected-groups-by-unread}).
 
 @item G P l
-@kindex G P l @r{(Group)}
+@kindex G P l (Group)
 @findex gnus-group-sort-selected-groups-by-level
 Sort the groups by group level
 (@code{gnus-group-sort-selected-groups-by-level}).
 
 @item G P v
-@kindex G P v @r{(Group)}
+@kindex G P v (Group)
 @findex gnus-group-sort-selected-groups-by-score
 Sort the groups by group score
 (@code{gnus-group-sort-selected-groups-by-score}).  @xref{Group Score}.
 
 @item G P r
-@kindex G P r @r{(Group)}
+@kindex G P r (Group)
 @findex gnus-group-sort-selected-groups-by-rank
 Sort the groups by group rank
 (@code{gnus-group-sort-selected-groups-by-rank}).  @xref{Group Score}.
 
 @item G P m
-@kindex G P m @r{(Group)}
+@kindex G P m (Group)
 @findex gnus-group-sort-selected-groups-by-method
 Sort the groups alphabetically by back end name@*
 (@code{gnus-group-sort-selected-groups-by-method}).
 
 @item G P n
-@kindex G P n @r{(Group)}
+@kindex G P n (Group)
 @findex gnus-group-sort-selected-groups-by-real-name
 Sort the groups alphabetically by real (unprefixed) group name
 (@code{gnus-group-sort-selected-groups-by-real-name}).
 
 @item G P s
-@kindex G P s @r{(Group)}
+@kindex G P s (Group)
 @findex gnus-group-sort-selected-groups
 Sort the groups according to @code{gnus-group-sort-function}.
 
@@ -3551,13 +3557,13 @@ move groups around.
 
 @table @kbd
 @item b
-@kindex b @r{(Group)}
+@kindex b (Group)
 @findex gnus-group-check-bogus-groups
 Find bogus groups and delete them
 (@code{gnus-group-check-bogus-groups}).
 
 @item F
-@kindex F @r{(Group)}
+@kindex F (Group)
 @findex gnus-group-find-new-groups
 Find new groups and process them (@code{gnus-group-find-new-groups}).
 With 1 @kbd{C-u}, use the @code{ask-server} method to query the server
@@ -3566,7 +3572,7 @@ to query the server for new groups, and subscribe the new groups as
 zombies.
 
 @item C-c C-x
-@kindex C-c C-x @r{(Group)}
+@kindex C-c C-x (Group)
 @findex gnus-group-expire-articles
 @cindex expiring mail
 Run all expirable articles in the current group through the expiry
@@ -3575,7 +3581,7 @@ all expirable articles in the group that have been around for a while.
 (@pxref{Expiring Mail}).
 
 @item C-c C-M-x
-@kindex C-c C-M-x @r{(Group)}
+@kindex C-c C-M-x (Group)
 @findex gnus-group-expire-all-groups
 @cindex expiring mail
 Run all expirable articles in all groups through the expiry process
@@ -3591,7 +3597,7 @@ Run all expirable articles in all groups through the expiry process
 
 @table @kbd
 @item B
-@kindex B @r{(Group)}
+@kindex B (Group)
 @findex gnus-group-browse-foreign-server
 You will be queried for a select method and a server name.  Gnus will
 then attempt to contact this server and let you browse the groups there
@@ -3607,28 +3613,28 @@ Here's a list of keystrokes available in the browse mode:
 
 @table @kbd
 @item n
-@kindex n @r{(Browse)}
+@kindex n (Browse)
 @findex gnus-group-next-group
 Go to the next group (@code{gnus-group-next-group}).
 
 @item p
-@kindex p @r{(Browse)}
+@kindex p (Browse)
 @findex gnus-group-prev-group
 Go to the previous group (@code{gnus-group-prev-group}).
 
-@item @key{SPC}
-@kindex SPC @r{(Browse)}
+@item SPACE
+@kindex SPACE (Browse)
 @findex gnus-browse-read-group
 Enter the current group and display the first article
 (@code{gnus-browse-read-group}).
 
-@item @key{RET}
-@kindex RET @r{(Browse)}
+@item RET
+@kindex RET (Browse)
 @findex gnus-browse-select-group
 Enter the current group (@code{gnus-browse-select-group}).
 
 @item u
-@kindex u @r{(Browse)}
+@kindex u (Browse)
 @findex gnus-browse-unsubscribe-current-group
 @vindex gnus-browse-subscribe-newsgroup-method
 Unsubscribe to the current group, or, as will be the case here,
@@ -3639,24 +3645,24 @@ using the variable @code{gnus-browse-subscribe-newsgroup-method}.  See
 
 @item l
 @itemx q
-@kindex q @r{(Browse)}
-@kindex l @r{(Browse)}
+@kindex q (Browse)
+@kindex l (Browse)
 @findex gnus-browse-exit
 Exit browse mode (@code{gnus-browse-exit}).
 
 @item d
-@kindex d @r{(Browse)}
+@kindex d (Browse)
 @findex gnus-browse-describe-group
 Describe the current group (@code{gnus-browse-describe-group}).
 
 @item ?
-@kindex ? @r{(Browse)}
+@kindex ? (Browse)
 @findex gnus-browse-describe-briefly
 Describe browse mode briefly (well, there's not much to describe, is
 there) (@code{gnus-browse-describe-briefly}).
 
-@item @key{DEL}
-@kindex DEL @r{(Browse)}
+@item DEL
+@kindex DEL (Browse)
 @findex gnus-browse-delete-group
 This function will delete the current group
 (@code{gnus-browse-delete-group}).  If given a prefix, this function
@@ -3674,20 +3680,20 @@ Yes, Gnus is ex(c)iting.
 
 @table @kbd
 @item z
-@kindex z @r{(Group)}
+@kindex z (Group)
 @findex gnus-group-suspend
 Suspend Gnus (@code{gnus-group-suspend}).  This doesn't really exit Gnus,
 but it kills all buffers except the Group buffer.  I'm not sure why this
 is a gain, but then who am I to judge?
 
 @item q
-@kindex q @r{(Group)}
+@kindex q (Group)
 @findex gnus-group-exit
 @c @icon{gnus-group-exit}
 Quit Gnus (@code{gnus-group-exit}).
 
 @item Q
-@kindex Q @r{(Group)}
+@kindex Q (Group)
 @findex gnus-group-quit
 Quit Gnus without saving the @file{.newsrc} files (@code{gnus-group-quit}).
 The dribble file will be saved, though (@pxref{Auto Save}).
@@ -3746,7 +3752,7 @@ Gnus
 @end example
 
 @findex gnus-topic-mode
-@kindex t @r{(Group)}
+@kindex t (Group)
 To get this @emph{fab} functionality you simply turn on (ooh!) the
 @code{gnus-topic} minor mode---type @kbd{t} in the group buffer.  (This
 is a toggling command.)
@@ -3795,22 +3801,22 @@ the way you like.
 @table @kbd
 
 @item T n
-@kindex T n @r{(Topic)}
+@kindex T n (Topic)
 @findex gnus-topic-create-topic
 Prompt for a new topic name and create it
 (@code{gnus-topic-create-topic}).
 
-@item T @key{TAB}
-@itemx @key{TAB}
-@kindex T TAB @r{(Topic)}
-@kindex TAB @r{(Topic)}
+@item T TAB
+@itemx TAB
+@kindex T TAB (Topic)
+@kindex TAB (Topic)
 @findex gnus-topic-indent
 ``Indent'' the current topic so that it becomes a sub-topic of the
 previous topic (@code{gnus-topic-indent}).  If given a prefix,
 ``un-indent'' the topic instead.
 
-@item M-@key{TAB}
-@kindex M-TAB @r{(Topic)}
+@item M-TAB
+@kindex M-TAB (Topic)
 @findex gnus-topic-unindent
 ``Un-indent'' the current topic so that it becomes a sub-topic of the
 parent of its current parent (@code{gnus-topic-unindent}).
@@ -3825,13 +3831,13 @@ kill and yank rather than cut and paste.
 @table @kbd
 
 @item C-k
-@kindex C-k @r{(Topic)}
+@kindex C-k (Topic)
 @findex gnus-topic-kill-group
 Kill a group or topic (@code{gnus-topic-kill-group}).  All groups in the
 topic will be removed along with the topic.
 
 @item C-y
-@kindex C-y @r{(Topic)}
+@kindex C-y (Topic)
 @findex gnus-topic-yank-group
 Yank the previously killed group or topic
 (@code{gnus-topic-yank-group}).  Note that all topics will be yanked
@@ -3854,10 +3860,10 @@ key.
 
 @table @kbd
 
-@item @key{RET}
-@kindex RET @r{(Topic)}
+@item RET
+@kindex RET (Topic)
 @findex gnus-topic-select-group
-@itemx @key{SPC}
+@itemx SPACE
 Either select a group or fold a topic (@code{gnus-topic-select-group}).
 When you perform this command on a group, you'll enter the group, as
 usual.  When done on a topic line, the topic will be folded (if it was
@@ -3872,38 +3878,38 @@ Now for a list of other commands, in no particular order.
 @table @kbd
 
 @item T m
-@kindex T m @r{(Topic)}
+@kindex T m (Topic)
 @findex gnus-topic-move-group
 Move the current group to some other topic
 (@code{gnus-topic-move-group}).  This command uses the process/prefix
 convention (@pxref{Process/Prefix}).
 
 @item T j
-@kindex T j @r{(Topic)}
+@kindex T j (Topic)
 @findex gnus-topic-jump-to-topic
 Go to a topic (@code{gnus-topic-jump-to-topic}).
 
 @item T c
-@kindex T c @r{(Topic)}
+@kindex T c (Topic)
 @findex gnus-topic-copy-group
 Copy the current group to some other topic
 (@code{gnus-topic-copy-group}).  This command uses the process/prefix
 convention (@pxref{Process/Prefix}).
 
 @item T h
-@kindex T h @r{(Topic)}
+@kindex T h (Topic)
 @findex gnus-topic-hide-topic
 Hide the current topic (@code{gnus-topic-hide-topic}).  If given
 a prefix, hide the topic permanently.
 
 @item T s
-@kindex T s @r{(Topic)}
+@kindex T s (Topic)
 @findex gnus-topic-show-topic
 Show the current topic (@code{gnus-topic-show-topic}).  If given
 a prefix, show the topic permanently.
 
 @item T D
-@kindex T D @r{(Topic)}
+@kindex T D (Topic)
 @findex gnus-topic-remove-group
 Remove a group from the current topic (@code{gnus-topic-remove-group}).
 This command is mainly useful if you have the same group in several
@@ -3917,39 +3923,39 @@ This command uses the process/prefix convention
 (@pxref{Process/Prefix}).
 
 @item T M
-@kindex T M @r{(Topic)}
+@kindex T M (Topic)
 @findex gnus-topic-move-matching
 Move all groups that match some regular expression to a topic
 (@code{gnus-topic-move-matching}).
 
 @item T C
-@kindex T C @r{(Topic)}
+@kindex T C (Topic)
 @findex gnus-topic-copy-matching
 Copy all groups that match some regular expression to a topic
 (@code{gnus-topic-copy-matching}).
 
 @item T H
-@kindex T H @r{(Topic)}
+@kindex T H (Topic)
 @findex gnus-topic-toggle-display-empty-topics
 Toggle hiding empty topics
 (@code{gnus-topic-toggle-display-empty-topics}).
 
 @item T #
-@kindex T # @r{(Topic)}
+@kindex T # (Topic)
 @findex gnus-topic-mark-topic
 Mark all groups in the current topic with the process mark
 (@code{gnus-topic-mark-topic}).  This command works recursively on
 sub-topics unless given a prefix.
 
 @item T M-#
-@kindex T M-# @r{(Topic)}
+@kindex T M-# (Topic)
 @findex gnus-topic-unmark-topic
 Remove the process mark from all groups in the current topic
 (@code{gnus-topic-unmark-topic}).  This command works recursively on
 sub-topics unless given a prefix.
 
 @item C-c C-x
-@kindex C-c C-x @r{(Topic)}
+@kindex C-c C-x (Topic)
 @findex gnus-topic-expire-articles
 @cindex expiring mail
 Run all expirable articles in the current group or topic through the
@@ -3957,33 +3963,33 @@ expiry process (if any)
 (@code{gnus-topic-expire-articles}).  (@pxref{Expiring Mail}).
 
 @item T r
-@kindex T r @r{(Topic)}
+@kindex T r (Topic)
 @findex gnus-topic-rename
 Rename a topic (@code{gnus-topic-rename}).
 
-@item T @key{DEL}
-@kindex T DEL @r{(Topic)}
+@item T DEL
+@kindex T DEL (Topic)
 @findex gnus-topic-delete
 Delete an empty topic (@code{gnus-topic-delete}).
 
 @item A T
-@kindex A T @r{(Topic)}
+@kindex A T (Topic)
 @findex gnus-topic-list-active
 List all groups that Gnus knows about in a topics-ified way
 (@code{gnus-topic-list-active}).
 
 @item T M-n
-@kindex T M-n @r{(Topic)}
+@kindex T M-n (Topic)
 @findex gnus-topic-goto-next-topic
 Go to the next topic (@code{gnus-topic-goto-next-topic}).
 
 @item T M-p
-@kindex T M-p @r{(Topic)}
+@kindex T M-p (Topic)
 @findex gnus-topic-goto-previous-topic
 Go to the previous topic (@code{gnus-topic-goto-previous-topic}).
 
 @item G p
-@kindex G p @r{(Topic)}
+@kindex G p (Topic)
 @findex gnus-topic-edit-parameters
 @cindex group parameters
 @cindex topic parameters
@@ -4046,49 +4052,49 @@ commands:
 
 @table @kbd
 @item T S a
-@kindex T S a @r{(Topic)}
+@kindex T S a (Topic)
 @findex gnus-topic-sort-groups-by-alphabet
 Sort the current topic alphabetically by group name
 (@code{gnus-topic-sort-groups-by-alphabet}).
 
 @item T S u
-@kindex T S u @r{(Topic)}
+@kindex T S u (Topic)
 @findex gnus-topic-sort-groups-by-unread
 Sort the current topic by the number of unread articles
 (@code{gnus-topic-sort-groups-by-unread}).
 
 @item T S l
-@kindex T S l @r{(Topic)}
+@kindex T S l (Topic)
 @findex gnus-topic-sort-groups-by-level
 Sort the current topic by group level
 (@code{gnus-topic-sort-groups-by-level}).
 
 @item T S v
-@kindex T S v @r{(Topic)}
+@kindex T S v (Topic)
 @findex gnus-topic-sort-groups-by-score
 Sort the current topic by group score
 (@code{gnus-topic-sort-groups-by-score}).  @xref{Group Score}.
 
 @item T S r
-@kindex T S r @r{(Topic)}
+@kindex T S r (Topic)
 @findex gnus-topic-sort-groups-by-rank
 Sort the current topic by group rank
 (@code{gnus-topic-sort-groups-by-rank}).  @xref{Group Score}.
 
 @item T S m
-@kindex T S m @r{(Topic)}
+@kindex T S m (Topic)
 @findex gnus-topic-sort-groups-by-method
 Sort the current topic alphabetically by back end name
 (@code{gnus-topic-sort-groups-by-method}).
 
 @item T S e
-@kindex T S e @r{(Topic)}
+@kindex T S e (Topic)
 @findex gnus-topic-sort-groups-by-server
 Sort the current topic alphabetically by server name
 (@code{gnus-topic-sort-groups-by-server}).
 
 @item T S s
-@kindex T S s @r{(Topic)}
+@kindex T S s (Topic)
 @findex gnus-topic-sort-groups
 Sort the current topic according to the function(s) given by the
 @code{gnus-group-sort-function} variable
@@ -4363,7 +4369,7 @@ header will be displayed incorrectly in the article buffer.
 @table @kbd
 
 @item v
-@kindex v @r{(Group)}
+@kindex v (Group)
 @cindex keys, reserved for users (Group)
 The key @kbd{v} is reserved for users.  You can bind it to some
 command or better use it as a prefix key.  For example:
@@ -4379,13 +4385,13 @@ On keys reserved for users in Emacs and on keybindings in general
 @xref{Keymaps, Keymaps, , emacs, The Emacs Editor}.
 
 @item ^
-@kindex ^ @r{(Group)}
+@kindex ^ (Group)
 @findex gnus-group-enter-server-mode
 Enter the server buffer (@code{gnus-group-enter-server-mode}).
 @xref{Server Buffer}.
 
 @item a
-@kindex a @r{(Group)}
+@kindex a (Group)
 @findex gnus-group-post-news
 Start composing a message (a news by default)
 (@code{gnus-group-post-news}).  If given a prefix, post to the group
@@ -4395,7 +4401,7 @@ article might be a mail instead of a news, if a mail group is specified
 with the prefix argument.  @xref{Composing Messages}.
 
 @item m
-@kindex m @r{(Group)}
+@kindex m (Group)
 @findex gnus-group-mail
 Mail a message somewhere (@code{gnus-group-mail}).  If given a prefix,
 use the posting style of the group under the point.  If the prefix is 1,
@@ -4403,7 +4409,7 @@ prompt for a group name to find the posting style.
 @xref{Composing Messages}.
 
 @item i
-@kindex i @r{(Group)}
+@kindex i (Group)
 @findex gnus-group-news
 Start composing a news (@code{gnus-group-news}).  If given a prefix,
 post to the group under the point.  If the prefix is 1, prompt
@@ -4416,7 +4422,7 @@ in question.  The corresponding back end must have a request-post method
 for this to work though.
 
 @item G z
-@kindex G z @r{(Group)}
+@kindex G z (Group)
 @findex gnus-group-compact-group
 
 Compact the group under point (@code{gnus-group-compact-group}).
@@ -4461,7 +4467,7 @@ whether they are empty or not.
 @table @kbd
 
 @item g
-@kindex g @r{(Group)}
+@kindex g (Group)
 @findex gnus-group-get-new-news
 @c @icon{gnus-group-get-new-news}
 Check the server(s) for new articles.  If the numerical prefix is used,
@@ -4471,7 +4477,7 @@ command will force a total re-reading of the active file(s) from the
 back end(s).
 
 @item M-g
-@kindex M-g @r{(Group)}
+@kindex M-g (Group)
 @findex gnus-group-get-new-news-this-group
 @vindex gnus-goto-next-group-when-activating
 @c @icon{gnus-group-get-new-news-this-group}
@@ -4483,11 +4489,11 @@ to move point to the next group or not.  It is @code{t} by default.
 @findex gnus-activate-all-groups
 @cindex activating groups
 @item C-c M-g
-@kindex C-c M-g @r{(Group)}
+@kindex C-c M-g (Group)
 Activate absolutely all groups (@code{gnus-activate-all-groups}).
 
 @item R
-@kindex R @r{(Group)}
+@kindex R (Group)
 @cindex restarting
 @findex gnus-group-restart
 Restart Gnus (@code{gnus-group-restart}).  This saves the @file{.newsrc}
@@ -4515,8 +4521,8 @@ news.
 @item H d
 @itemx C-c C-d
 @c @icon{gnus-group-describe-group}
-@kindex H d @r{(Group)}
-@kindex C-c C-d @r{(Group)}
+@kindex H d (Group)
+@kindex C-c C-d (Group)
 @cindex describing groups
 @cindex group description
 @findex gnus-group-describe-group
@@ -4524,26 +4530,26 @@ Describe the current group (@code{gnus-group-describe-group}).  If given
 a prefix, force Gnus to re-read the description from the server.
 
 @item M-d
-@kindex M-d @r{(Group)}
+@kindex M-d (Group)
 @findex gnus-group-describe-all-groups
 Describe all groups (@code{gnus-group-describe-all-groups}).  If given a
 prefix, force Gnus to re-read the description file from the server.
 
 @item H v
 @itemx V
-@kindex V @r{(Group)}
-@kindex H v @r{(Group)}
+@kindex V (Group)
+@kindex H v (Group)
 @cindex version
 @findex gnus-version
 Display current Gnus version numbers (@code{gnus-version}).
 
 @item ?
-@kindex ? @r{(Group)}
+@kindex ? (Group)
 @findex gnus-group-describe-briefly
 Give a very short help message (@code{gnus-group-describe-briefly}).
 
 @item C-c C-i
-@kindex C-c C-i @r{(Group)}
+@kindex C-c C-i (Group)
 @cindex info
 @cindex manual
 @findex gnus-info-find-node
@@ -4617,7 +4623,7 @@ either.
 @table @kbd
 
 @item r
-@kindex r @r{(Group)}
+@kindex r (Group)
 @findex gnus-group-read-init-file
 @vindex gnus-init-file
 @cindex reading init file
@@ -4625,7 +4631,7 @@ Re-read the init file (@code{gnus-init-file}, which defaults to
 @file{~/.gnus.el}) (@code{gnus-group-read-init-file}).
 
 @item s
-@kindex s @r{(Group)}
+@kindex s (Group)
 @findex gnus-group-save-newsrc
 @cindex saving .newsrc
 Save the @file{.newsrc.eld} file (and @file{.newsrc} if wanted)
@@ -4633,7 +4639,7 @@ Save the @file{.newsrc.eld} file (and @file{.newsrc} if wanted)
 file(s) whether Gnus thinks it is necessary or not.
 
 @c @item Z
-@c @kindex Z @r{(Group)}
+@c @kindex Z (Group)
 @c @findex gnus-group-clear-dribble
 @c Clear the dribble buffer (@code{gnus-group-clear-dribble}).
 
@@ -4683,7 +4689,7 @@ if address "sender" "owner-ding@@hpc.uh.edu" @{
 @table @kbd
 
 @item D g
-@kindex D g @r{(Group)}
+@kindex D g (Group)
 @findex gnus-sieve-generate
 @vindex gnus-sieve-file
 @cindex generating sieve script
@@ -4691,7 +4697,7 @@ Regenerate a Sieve script from the @code{sieve} group parameters and
 put you into the @code{gnus-sieve-file} without saving it.
 
 @item D u
-@kindex D u @r{(Group)}
+@kindex D u (Group)
 @findex gnus-sieve-update
 @vindex gnus-sieve-file
 @cindex updating sieve script
@@ -4715,10 +4721,10 @@ group buffer (@pxref{Selecting a Group}).
 You can have as many summary buffers open as you wish.
 
 You can customize the Summary Mode tool bar, see @kbd{M-x
-customize-apropos @key{RET} gnus-summary-tool-bar}.  This feature is only
+customize-apropos RET gnus-summary-tool-bar}.  This feature is only
 available in Emacs.
 
-@kindex v @r{(Summary)}
+@kindex v (Summary)
 @cindex keys, reserved for users (Summary)
 The key @kbd{v} is reserved for users.  You can bind it to some
 command or better use it as a prefix key.  For example:
@@ -5198,22 +5204,22 @@ None of these commands select articles.
 @table @kbd
 @item G M-n
 @itemx M-n
-@kindex M-n @r{(Summary)}
-@kindex G M-n @r{(Summary)}
+@kindex M-n (Summary)
+@kindex G M-n (Summary)
 @findex gnus-summary-next-unread-subject
 Go to the next summary line of an unread article
 (@code{gnus-summary-next-unread-subject}).
 
 @item G M-p
 @itemx M-p
-@kindex M-p @r{(Summary)}
-@kindex G M-p @r{(Summary)}
+@kindex M-p (Summary)
+@kindex G M-p (Summary)
 @findex gnus-summary-prev-unread-subject
 Go to the previous summary line of an unread article
 (@code{gnus-summary-prev-unread-subject}).
 
 @item G g
-@kindex G g @r{(Summary)}
+@kindex G g (Summary)
 @findex gnus-summary-goto-subject
 Ask for an article number and then go to the summary line of that article
 without displaying the article (@code{gnus-summary-goto-subject}).
@@ -5275,7 +5281,7 @@ the given number of lines from the top.
 @item gnus-summary-stop-at-end-of-message
 @vindex gnus-summary-stop-at-end-of-message
 If non-@code{nil}, don't go to the next article when hitting
-@kbd{@key{SPC}}, and you're at the end of the article.
+@kbd{SPC}, and you're at the end of the article.
 
 @end table
 
@@ -5300,69 +5306,69 @@ If you want to fetch new articles or redisplay the group, see
 @ref{Exiting the Summary Buffer}.
 
 @table @kbd
-@item @key{SPC}
-@kindex SPC @r{(Summary)}
+@item SPACE
+@kindex SPACE (Summary)
 @findex gnus-summary-next-page
 Select the current article, or, if that one's read already, the next
 unread article (@code{gnus-summary-next-page}).
 
-If you have an article window open already and you press @kbd{@key{SPC}}
+If you have an article window open already and you press @kbd{SPACE}
 again, the article will be scrolled.  This lets you conveniently
-@kbd{@key{SPC}} through an entire newsgroup.  @xref{Paging the Article}.
+@kbd{SPACE} through an entire newsgroup.  @xref{Paging the Article}.
 
 @item G n
 @itemx n
-@kindex n @r{(Summary)}
-@kindex G n @r{(Summary)}
+@kindex n (Summary)
+@kindex G n (Summary)
 @findex gnus-summary-next-unread-article
 @c @icon{gnus-summary-next-unread}
 Go to next unread article (@code{gnus-summary-next-unread-article}).
 
 @item G p
 @itemx p
-@kindex p @r{(Summary)}
+@kindex p (Summary)
 @findex gnus-summary-prev-unread-article
 @c @icon{gnus-summary-prev-unread}
 Go to previous unread article (@code{gnus-summary-prev-unread-article}).
 
 @item G N
 @itemx N
-@kindex N @r{(Summary)}
-@kindex G N @r{(Summary)}
+@kindex N (Summary)
+@kindex G N (Summary)
 @findex gnus-summary-next-article
 Go to the next article (@code{gnus-summary-next-article}).
 
 @item G P
 @itemx P
-@kindex P @r{(Summary)}
-@kindex G P @r{(Summary)}
+@kindex P (Summary)
+@kindex G P (Summary)
 @findex gnus-summary-prev-article
 Go to the previous article (@code{gnus-summary-prev-article}).
 
 @item G C-n
-@kindex G C-n @r{(Summary)}
+@kindex G C-n (Summary)
 @findex gnus-summary-next-same-subject
 Go to the next article with the same subject
 (@code{gnus-summary-next-same-subject}).
 
 @item G C-p
-@kindex G C-p @r{(Summary)}
+@kindex G C-p (Summary)
 @findex gnus-summary-prev-same-subject
 Go to the previous article with the same subject
 (@code{gnus-summary-prev-same-subject}).
 
 @item G f
 @itemx .
-@kindex G f  @r{(Summary)}
-@kindex .  @r{(Summary)}
+@kindex G f  (Summary)
+@kindex .  (Summary)
 @findex gnus-summary-first-unread-article
 Go to the first unread article
 (@code{gnus-summary-first-unread-article}).
 
 @item G b
 @itemx ,
-@kindex G b @r{(Summary)}
-@kindex , @r{(Summary)}
+@kindex G b (Summary)
+@kindex , (Summary)
 @findex gnus-summary-best-unread-article
 Go to the unread article with the highest score
 (@code{gnus-summary-best-unread-article}).  If given a prefix argument,
@@ -5370,13 +5376,13 @@ go to the first unread article that has a score over the default score.
 
 @item G l
 @itemx l
-@kindex l @r{(Summary)}
-@kindex G l @r{(Summary)}
+@kindex l (Summary)
+@kindex G l (Summary)
 @findex gnus-summary-goto-last-article
 Go to the previous article read (@code{gnus-summary-goto-last-article}).
 
 @item G o
-@kindex G o @r{(Summary)}
+@kindex G o (Summary)
 @findex gnus-summary-pop-article
 @cindex history
 @cindex article history
@@ -5389,8 +5395,8 @@ For a somewhat related issue (if you use these commands a lot),
 
 @item G j
 @itemx j
-@kindex j @r{(Summary)}
-@kindex G j @r{(Summary)}
+@kindex j (Summary)
+@kindex G j (Summary)
 @findex gnus-summary-goto-article
 Ask for an article number or @code{Message-ID}, and then go to that
 article (@code{gnus-summary-goto-article}).
@@ -5442,10 +5448,10 @@ instead.  It will leave marks like @code{gnus-low-score-mark},
 
 @table @kbd
 
-@item @key{SPC}
-@kindex SPC @r{(Summary)}
+@item SPACE
+@kindex SPACE (Summary)
 @findex gnus-summary-next-page
-Pressing @kbd{@key{SPC}} will scroll the current article forward one page,
+Pressing @kbd{SPACE} will scroll the current article forward one page,
 or, if you have come to the end of the current article, will choose the
 next article (@code{gnus-summary-next-page}).
 
@@ -5458,27 +5464,27 @@ what is considered uninteresting with
 @code{gnus-article-boring-faces}.  You can manually view the article's
 pages, no matter how boring, using @kbd{C-M-v}.
 
-@item @key{DEL}
-@kindex DEL @r{(Summary)}
+@item DEL
+@kindex DEL (Summary)
 @findex gnus-summary-prev-page
 Scroll the current article back one page (@code{gnus-summary-prev-page}).
 
-@item @key{RET}
-@kindex RET @r{(Summary)}
+@item RET
+@kindex RET (Summary)
 @findex gnus-summary-scroll-up
 Scroll the current article one line forward
 (@code{gnus-summary-scroll-up}).
 
-@item M-@key{RET}
-@kindex M-RET @r{(Summary)}
+@item M-RET
+@kindex M-RET (Summary)
 @findex gnus-summary-scroll-down
 Scroll the current article one line backward
 (@code{gnus-summary-scroll-down}).
 
 @item A g
 @itemx g
-@kindex A g @r{(Summary)}
-@kindex g @r{(Summary)}
+@kindex A g (Summary)
+@kindex g (Summary)
 @findex gnus-summary-show-article
 @vindex gnus-summary-show-article-charset-alist
 (Re)fetch the current article (@code{gnus-summary-show-article}).  If
@@ -5489,7 +5495,7 @@ treatment functions.
 
 @cindex charset, view article with different charset
 If given a numerical prefix, you can do semi-manual charset stuff.
-@kbd{C-u 0 g cn-gb-2312 @key{RET}} will decode the message as if it were
+@kbd{C-u 0 g cn-gb-2312 RET} will decode the message as if it were
 encoded in the @code{cn-gb-2312} charset.  If you have
 
 @lisp
@@ -5502,29 +5508,29 @@ then you can say @kbd{C-u 1 g} to get the same effect.
 
 @item A <
 @itemx <
-@kindex < @r{(Summary)}
-@kindex A < @r{(Summary)}
+@kindex < (Summary)
+@kindex A < (Summary)
 @findex gnus-summary-beginning-of-article
 Scroll to the beginning of the article
 (@code{gnus-summary-beginning-of-article}).
 
 @item A >
 @itemx >
-@kindex > @r{(Summary)}
-@kindex A > @r{(Summary)}
+@kindex > (Summary)
+@kindex A > (Summary)
 @findex gnus-summary-end-of-article
 Scroll to the end of the article (@code{gnus-summary-end-of-article}).
 
 @item A s
 @itemx s
-@kindex A s @r{(Summary)}
-@kindex s @r{(Summary)}
+@kindex A s (Summary)
+@kindex s (Summary)
 @findex gnus-summary-isearch-article
 Perform an isearch in the article buffer
 (@code{gnus-summary-isearch-article}).
 
 @item h
-@kindex h @r{(Summary)}
+@kindex h (Summary)
 @findex gnus-summary-select-article-buffer
 Select the article buffer (@code{gnus-summary-select-article-buffer}).
 
@@ -5553,8 +5559,8 @@ Commands for composing a mail message:
 
 @item S r
 @itemx r
-@kindex S r @r{(Summary)}
-@kindex r @r{(Summary)}
+@kindex S r (Summary)
+@kindex r (Summary)
 @findex gnus-summary-reply
 @c @icon{gnus-summary-mail-reply}
 @c @icon{gnus-summary-reply}
@@ -5563,8 +5569,8 @@ Mail a reply to the author of the current article
 
 @item S R
 @itemx R
-@kindex R @r{(Summary)}
-@kindex S R @r{(Summary)}
+@kindex R (Summary)
+@kindex S R (Summary)
 @findex gnus-summary-reply-with-original
 @c @icon{gnus-summary-reply-with-original}
 Mail a reply to the author of the current article and include the
@@ -5572,7 +5578,7 @@ original message (@code{gnus-summary-reply-with-original}).  This
 command uses the process/prefix convention.
 
 @item S w
-@kindex S w @r{(Summary)}
+@kindex S w (Summary)
 @findex gnus-summary-wide-reply
 Mail a wide reply to the author of the current article
 (@code{gnus-summary-wide-reply}).  A @dfn{wide reply} is a reply that
@@ -5581,7 +5587,7 @@ goes out to all people listed in the @code{To}, @code{From} (or
 present, that's used instead.
 
 @item S W
-@kindex S W @r{(Summary)}
+@kindex S W (Summary)
 @findex gnus-summary-wide-reply-with-original
 Mail a wide reply to the current article and include the original
 message (@code{gnus-summary-wide-reply-with-original}).  This command uses
@@ -5589,14 +5595,14 @@ the process/prefix convention, but only uses the headers from the
 first article to determine the recipients.
 
 @item S L
-@kindex S L @r{(Summary)}
+@kindex S L (Summary)
 @findex gnus-summary-reply-to-list-with-original
 When replying to a message from a mailing list, send a reply to that
 message to the mailing list, and include the original message
 (@code{gnus-summary-reply-to-list-with-original}).
 
 @item S v
-@kindex S v @r{(Summary)}
+@kindex S v (Summary)
 @findex gnus-summary-very-wide-reply
 Mail a very wide reply to the author of the current article
 (@code{gnus-summary-wide-reply}).  A @dfn{very wide reply} is a reply
@@ -5605,14 +5611,14 @@ that goes out to all people listed in the @code{To}, @code{From} (or
 articles.  This command uses the process/prefix convention.
 
 @item S V
-@kindex S V @r{(Summary)}
+@kindex S V (Summary)
 @findex gnus-summary-very-wide-reply-with-original
 Mail a very wide reply to the author of the current article and include the
 original message (@code{gnus-summary-very-wide-reply-with-original}).  This
 command uses the process/prefix convention.
 
 @item S B r
-@kindex S B r @r{(Summary)}
+@kindex S B r (Summary)
 @findex gnus-summary-reply-broken-reply-to
 Mail a reply to the author of the current article but ignore the
 @code{Reply-To} field (@code{gnus-summary-reply-broken-reply-to}).
@@ -5622,7 +5628,7 @@ the @code{broken-reply-to} group parameter instead, so things will work
 correctly.  @xref{Group Parameters}.
 
 @item S B R
-@kindex S B R @r{(Summary)}
+@kindex S B R (Summary)
 @findex gnus-summary-reply-broken-reply-to-with-original
 Mail a reply to the author of the current article and include the
 original message but ignore the @code{Reply-To} field
@@ -5630,8 +5636,8 @@ original message but ignore the @code{Reply-To} field
 
 @item S o m
 @itemx C-c C-f
-@kindex S o m @r{(Summary)}
-@kindex C-c C-f @r{(Summary)}
+@kindex S o m (Summary)
+@kindex C-c C-f (Summary)
 @findex gnus-summary-mail-forward
 @c @icon{gnus-summary-mail-forward}
 Forward the current article to some other person
@@ -5648,8 +5654,8 @@ section.
 
 @item S m
 @itemx m
-@kindex m @r{(Summary)}
-@kindex S m @r{(Summary)}
+@kindex m (Summary)
+@kindex S m (Summary)
 @findex gnus-summary-mail-other-window
 @c @icon{gnus-summary-mail-originate}
 Prepare a mail (@code{gnus-summary-mail-other-window}).  By default, use
@@ -5657,7 +5663,7 @@ the posting style of the current group.  If given a prefix, disable that.
 If the prefix is 1, prompt for a group name to find the posting style.
 
 @item S i
-@kindex S i @r{(Summary)}
+@kindex S i (Summary)
 @findex gnus-summary-news-other-window
 Prepare a news (@code{gnus-summary-news-other-window}).  By default,
 post to the current group.  If given a prefix, disable that.  If the
@@ -5670,7 +5676,7 @@ in question.  The corresponding back end must have a request-post method
 for this to work though.
 
 @item S D b
-@kindex S D b @r{(Summary)}
+@kindex S D b (Summary)
 @findex gnus-summary-resend-bounced-mail
 @cindex bouncing mail
 If you have sent a mail, but the mail was bounced back to you for some
@@ -5683,7 +5689,7 @@ that mail and display it for easy perusal of its headers.  This might
 very well fail, though.
 
 @item S D r
-@kindex S D r @r{(Summary)}
+@kindex S D r (Summary)
 @findex gnus-summary-resend-message
 Not to be confused with the previous command,
 @code{gnus-summary-resend-message} will prompt you for an address to
@@ -5704,21 +5710,21 @@ This command understands the process/prefix convention
 (@pxref{Process/Prefix}).
 
 @item S D e
-@kindex S D e @r{(Summary)}
+@kindex S D e (Summary)
 @findex gnus-summary-resend-message-edit
 
 Like the previous command, but will allow you to edit the message as
 if it were a new message before resending.
 
 @item S O m
-@kindex S O m @r{(Summary)}
+@kindex S O m (Summary)
 @findex gnus-uu-digest-mail-forward
 Digest the current series (@pxref{Decoding Articles}) and forward the
 result using mail (@code{gnus-uu-digest-mail-forward}).  This command
 uses the process/prefix convention (@pxref{Process/Prefix}).
 
 @item S M-c
-@kindex S M-c @r{(Summary)}
+@kindex S M-c (Summary)
 @findex gnus-summary-mail-crosspost-complaint
 @cindex crossposting
 @cindex excessive crossposting
@@ -5748,8 +5754,8 @@ Commands for posting a news article:
 @table @kbd
 @item S p
 @itemx a
-@kindex a @r{(Summary)}
-@kindex S p @r{(Summary)}
+@kindex a (Summary)
+@kindex S p (Summary)
 @findex gnus-summary-post-news
 @c @icon{gnus-summary-post-news}
 Prepare for posting an article (@code{gnus-summary-post-news}).  By
@@ -5758,16 +5764,16 @@ If the prefix is 1, prompt for another group instead.
 
 @item S f
 @itemx f
-@kindex f @r{(Summary)}
-@kindex S f @r{(Summary)}
+@kindex f (Summary)
+@kindex S f (Summary)
 @findex gnus-summary-followup
 @c @icon{gnus-summary-followup}
 Post a followup to the current article (@code{gnus-summary-followup}).
 
 @item S F
 @itemx F
-@kindex S F @r{(Summary)}
-@kindex F @r{(Summary)}
+@kindex S F (Summary)
+@kindex F (Summary)
 @c @icon{gnus-summary-followup-with-original}
 @findex gnus-summary-followup-with-original
 Post a followup to the current article and include the original message
@@ -5775,13 +5781,13 @@ Post a followup to the current article and include the original message
 process/prefix convention.
 
 @item S n
-@kindex S n @r{(Summary)}
+@kindex S n (Summary)
 @findex gnus-summary-followup-to-mail
 Post a followup to the current article via news, even if you got the
 message through mail (@code{gnus-summary-followup-to-mail}).
 
 @item S N
-@kindex S N @r{(Summary)}
+@kindex S N (Summary)
 @findex gnus-summary-followup-to-mail-with-original
 Post a followup to the current article via news, even if you got the
 message through mail and include the original message
@@ -5789,7 +5795,7 @@ message through mail and include the original message
 the process/prefix convention.
 
 @item S o p
-@kindex S o p @r{(Summary)}
+@kindex S o p (Summary)
 @findex gnus-summary-post-forward
 Forward the current article to a newsgroup
 (@code{gnus-summary-post-forward}).
@@ -5804,7 +5810,7 @@ but use the flipped value of (@code{message-forward-as-mime}).  By
 default, the message is decoded and forwarded as an rfc822 @acronym{MIME} section.
 
 @item S O p
-@kindex S O p @r{(Summary)}
+@kindex S O p (Summary)
 @findex gnus-uu-digest-post-forward
 @cindex digests
 @cindex making digests
@@ -5813,7 +5819,7 @@ Digest the current series and forward the result to a newsgroup
 process/prefix convention.
 
 @item S u
-@kindex S u @r{(Summary)}
+@kindex S u (Summary)
 @findex gnus-uu-post-news
 @c @icon{gnus-uu-post-news}
 Uuencode a file, split it into parts, and post it as a series
@@ -5829,7 +5835,7 @@ Manual}, for more information.
 
 @table @kbd
 @item S y
-@kindex S y @r{(Summary)}
+@kindex S y (Summary)
 @findex gnus-summary-yank-message
 Yank the current article into an already existing Message composition
 buffer (@code{gnus-summary-yank-message}).  This command prompts for
@@ -5850,7 +5856,7 @@ really, really wish you hadn't posted that?
 Well, you can't cancel mail, but you can cancel posts.
 
 @findex gnus-summary-cancel-article
-@kindex C @r{(Summary)}
+@kindex C (Summary)
 @c @icon{gnus-summary-cancel-article}
 Find the article you wish to cancel (you can only cancel your own
 articles, so don't try any funny stuff).  Then press @kbd{C} or @kbd{S
@@ -5875,7 +5881,7 @@ corrections, you can post a @dfn{superseding} article that will replace
 your original article.
 
 @findex gnus-summary-supersede-article
-@kindex S @r{(Summary)}
+@kindex S (Summary)
 Go to the original article and press @kbd{S s}
 (@code{gnus-summary-supersede-article}).  You will be put in a buffer
 where you can edit the article all you want before sending it off the
@@ -6058,7 +6064,7 @@ followups, you can use the @kbd{/ D} command (@pxref{Limiting}).
 Otherwise (except for the visibility issue), they are just like ticked
 messages.
 
-@item @key{SPC}
+@item SPACE
 @vindex gnus-unread-mark
 Marked as unread (@code{gnus-unread-mark}).
 
@@ -6242,8 +6248,8 @@ All the marking commands understand the numeric prefix.
 @table @kbd
 @item M c
 @itemx M-u
-@kindex M c @r{(Summary)}
-@kindex M-u @r{(Summary)}
+@kindex M c (Summary)
+@kindex M-u (Summary)
 @findex gnus-summary-clear-mark-forward
 @cindex mark as unread
 Clear all readedness-marks from the current article
@@ -6252,38 +6258,38 @@ article as unread.
 
 @item M t
 @itemx !
-@kindex ! @r{(Summary)}
-@kindex M t @r{(Summary)}
+@kindex ! (Summary)
+@kindex M t (Summary)
 @findex gnus-summary-tick-article-forward
 Tick the current article (@code{gnus-summary-tick-article-forward}).
 @xref{Article Caching}.
 
 @item M ?
 @itemx ?
-@kindex ? @r{(Summary)}
-@kindex M ? @r{(Summary)}
+@kindex ? (Summary)
+@kindex M ? (Summary)
 @findex gnus-summary-mark-as-dormant
 Mark the current article as dormant
 (@code{gnus-summary-mark-as-dormant}).  @xref{Article Caching}.
 
 @item M d
 @itemx d
-@kindex M d @r{(Summary)}
-@kindex d @r{(Summary)}
+@kindex M d (Summary)
+@kindex d (Summary)
 @findex gnus-summary-mark-as-read-forward
 Mark the current article as read
 (@code{gnus-summary-mark-as-read-forward}).
 
 @item D
-@kindex D @r{(Summary)}
+@kindex D (Summary)
 @findex gnus-summary-mark-as-read-backward
 Mark the current article as read and move point to the previous line
 (@code{gnus-summary-mark-as-read-backward}).
 
 @item M k
 @itemx k
-@kindex k @r{(Summary)}
-@kindex M k @r{(Summary)}
+@kindex k (Summary)
+@kindex M k (Summary)
 @findex gnus-summary-kill-same-subject-and-select
 Mark all articles that have the same subject as the current one as read,
 and then select the next unread article
@@ -6291,82 +6297,82 @@ and then select the next unread article
 
 @item M K
 @itemx C-k
-@kindex M K @r{(Summary)}
-@kindex C-k @r{(Summary)}
+@kindex M K (Summary)
+@kindex C-k (Summary)
 @findex gnus-summary-kill-same-subject
 Mark all articles that have the same subject as the current one as read
 (@code{gnus-summary-kill-same-subject}).
 
 @item M C
-@kindex M C @r{(Summary)}
+@kindex M C (Summary)
 @findex gnus-summary-catchup
 @c @icon{gnus-summary-catchup}
 Mark all unread articles as read (@code{gnus-summary-catchup}).
 
 @item M C-c
-@kindex M C-c @r{(Summary)}
+@kindex M C-c (Summary)
 @findex gnus-summary-catchup-all
 Mark all articles in the group as read---even the ticked and dormant
 articles (@code{gnus-summary-catchup-all}).
 
 @item M H
-@kindex M H @r{(Summary)}
+@kindex M H (Summary)
 @findex gnus-summary-catchup-to-here
 Catchup the current group to point (before the point)
 (@code{gnus-summary-catchup-to-here}).
 
 @item M h
-@kindex M h @r{(Summary)}
+@kindex M h (Summary)
 @findex gnus-summary-catchup-from-here
 Catchup the current group from point (after the point)
 (@code{gnus-summary-catchup-from-here}).
 
 @item C-w
-@kindex C-w @r{(Summary)}
+@kindex C-w (Summary)
 @findex gnus-summary-mark-region-as-read
 Mark all articles between point and mark as read
 (@code{gnus-summary-mark-region-as-read}).
 
 @item M V k
-@kindex M V k @r{(Summary)}
+@kindex M V k (Summary)
 @findex gnus-summary-kill-below
 Kill all articles with scores below the default score (or below the
 numeric prefix) (@code{gnus-summary-kill-below}).
 
 @item M e
 @itemx E
-@kindex M e @r{(Summary)}
-@kindex E @r{(Summary)}
+@kindex M e (Summary)
+@kindex E (Summary)
 @findex gnus-summary-mark-as-expirable
 Mark the current article as expirable
 (@code{gnus-summary-mark-as-expirable}).
 
 @item M b
-@kindex M b @r{(Summary)}
+@kindex M b (Summary)
 @findex gnus-summary-set-bookmark
 Set a bookmark in the current article
 (@code{gnus-summary-set-bookmark}).
 
 @item M B
-@kindex M B @r{(Summary)}
+@kindex M B (Summary)
 @findex gnus-summary-remove-bookmark
 Remove the bookmark from the current article
 (@code{gnus-summary-remove-bookmark}).
 
 @item M V c
-@kindex M V c @r{(Summary)}
+@kindex M V c (Summary)
 @findex gnus-summary-clear-above
 Clear all marks from articles with scores over the default score (or
 over the numeric prefix) (@code{gnus-summary-clear-above}).
 
 @item M V u
-@kindex M V u @r{(Summary)}
+@kindex M V u (Summary)
 @findex gnus-summary-tick-above
 Tick all articles with scores over the default score (or over the
 numeric prefix) (@code{gnus-summary-tick-above}).
 
 @item M V m
-@kindex M V m @r{(Summary)}
+@kindex M V m (Summary)
 @findex gnus-summary-mark-above
 Prompt for a mark, and mark all articles with scores over the default
 score (or over the numeric prefix) with this mark
@@ -6379,7 +6385,7 @@ be taken after setting a mark.  If non-@code{nil}, point will move to
 the next/previous unread article.  If @code{nil}, point will just move
 one line up or down.  As a special case, if this variable is
 @code{never}, all the marking commands as well as other commands (like
-@kbd{@key{SPC}}) will move to the next article, whether it is unread or not.
+@kbd{SPACE}) will move to the next article, whether it is unread or not.
 The default is @code{t}.
 
 
@@ -6439,8 +6445,8 @@ articles into the cache.  For more information,
 
 @item M P p
 @itemx #
-@kindex # @r{(Summary)}
-@kindex M P p @r{(Summary)}
+@kindex # (Summary)
+@kindex M P p (Summary)
 @findex gnus-summary-mark-as-processable
 Mark the current article with the process mark
 (@code{gnus-summary-mark-as-processable}).
@@ -6448,99 +6454,99 @@ Mark the current article with the process mark
 
 @item M P u
 @itemx M-#
-@kindex M P u @r{(Summary)}
-@kindex M-# @r{(Summary)}
+@kindex M P u (Summary)
+@kindex M-# (Summary)
 Remove the process mark, if any, from the current article
 (@code{gnus-summary-unmark-as-processable}).
 
 @item M P U
-@kindex M P U @r{(Summary)}
+@kindex M P U (Summary)
 @findex gnus-summary-unmark-all-processable
 Remove the process mark from all articles
 (@code{gnus-summary-unmark-all-processable}).
 
 @item M P i
-@kindex M P i @r{(Summary)}
+@kindex M P i (Summary)
 @findex gnus-uu-invert-processable
 Invert the list of process marked articles
 (@code{gnus-uu-invert-processable}).
 
 @item M P R
-@kindex M P R @r{(Summary)}
+@kindex M P R (Summary)
 @findex gnus-uu-mark-by-regexp
 Mark articles that have a @code{Subject} header that matches a regular
 expression (@code{gnus-uu-mark-by-regexp}).
 
 @item M P G
-@kindex M P G @r{(Summary)}
+@kindex M P G (Summary)
 @findex gnus-uu-unmark-by-regexp
 Unmark articles that have a @code{Subject} header that matches a regular
 expression (@code{gnus-uu-unmark-by-regexp}).
 
 @item M P r
-@kindex M P r @r{(Summary)}
+@kindex M P r (Summary)
 @findex gnus-uu-mark-region
 Mark articles in region (@code{gnus-uu-mark-region}).
 
 @item M P g
-@kindex M P g @r{(Summary)}
+@kindex M P g (Summary)
 @findex gnus-uu-unmark-region
 Unmark articles in region (@code{gnus-uu-unmark-region}).
 
 @item M P t
-@kindex M P t @r{(Summary)}
+@kindex M P t (Summary)
 @findex gnus-uu-mark-thread
 Mark all articles in the current (sub)thread
 (@code{gnus-uu-mark-thread}).
 
 @item M P T
-@kindex M P T @r{(Summary)}
+@kindex M P T (Summary)
 @findex gnus-uu-unmark-thread
 Unmark all articles in the current (sub)thread
 (@code{gnus-uu-unmark-thread}).
 
 @item M P v
-@kindex M P v @r{(Summary)}
+@kindex M P v (Summary)
 @findex gnus-uu-mark-over
 Mark all articles that have a score above the prefix argument
 (@code{gnus-uu-mark-over}).
 
 @item M P s
-@kindex M P s @r{(Summary)}
+@kindex M P s (Summary)
 @findex gnus-uu-mark-series
 Mark all articles in the current series (@code{gnus-uu-mark-series}).
 
 @item M P S
-@kindex M P S @r{(Summary)}
+@kindex M P S (Summary)
 @findex gnus-uu-mark-sparse
 Mark all series that have already had some articles marked
 (@code{gnus-uu-mark-sparse}).
 
 @item M P a
-@kindex M P a @r{(Summary)}
+@kindex M P a (Summary)
 @findex gnus-uu-mark-all
 Mark all articles in series order (@code{gnus-uu-mark-all}).
 
 @item M P b
-@kindex M P b @r{(Summary)}
+@kindex M P b (Summary)
 @findex gnus-uu-mark-buffer
 Mark all articles in the buffer in the order they appear
 (@code{gnus-uu-mark-buffer}).
 
 @item M P k
-@kindex M P k @r{(Summary)}
+@kindex M P k (Summary)
 @findex gnus-summary-kill-process-mark
 Push the current process mark set onto the stack and unmark all articles
 (@code{gnus-summary-kill-process-mark}).
 
 @item M P y
-@kindex M P y @r{(Summary)}
+@kindex M P y (Summary)
 @findex gnus-summary-yank-process-mark
 Pop the previous process mark set from the stack and restore it
 (@code{gnus-summary-yank-process-mark}).
 
 @item M P w
-@kindex M P w @r{(Summary)}
+@kindex M P w (Summary)
 @findex gnus-summary-save-process-mark
 Push the current process mark set onto the stack
 (@code{gnus-summary-save-process-mark}).
@@ -6568,42 +6574,42 @@ articles.
 
 @item / /
 @itemx / s
-@kindex / / @r{(Summary)}
+@kindex / / (Summary)
 @findex gnus-summary-limit-to-subject
 Limit the summary buffer to articles that match some subject
 (@code{gnus-summary-limit-to-subject}).  If given a prefix, exclude
 matching articles.
 
 @item / a
-@kindex / a @r{(Summary)}
+@kindex / a (Summary)
 @findex gnus-summary-limit-to-author
 Limit the summary buffer to articles that match some author
 (@code{gnus-summary-limit-to-author}).  If given a prefix, exclude
 matching articles.
 
 @item / R
-@kindex / R @r{(Summary)}
+@kindex / R (Summary)
 @findex gnus-summary-limit-to-recipient
 Limit the summary buffer to articles that match some recipient
 (@code{gnus-summary-limit-to-recipient}).  If given a prefix, exclude
 matching articles.
 
 @item / A
-@kindex / A @r{(Summary)}
+@kindex / A (Summary)
 @findex gnus-summary-limit-to-address
 Limit the summary buffer to articles in which contents of From, To or Cc
 header match a given address (@code{gnus-summary-limit-to-address}).  If
 given a prefix, exclude matching articles.
 
 @item / S
-@kindex / S @r{(Summary)}
+@kindex / S (Summary)
 @findex gnus-summary-limit-to-singletons
 Limit the summary buffer to articles that aren't part of any displayed
 threads (@code{gnus-summary-limit-to-singletons}).  If given a prefix,
 limit to articles that are part of displayed threads.
 
 @item / x
-@kindex / x @r{(Summary)}
+@kindex / x (Summary)
 @findex gnus-summary-limit-to-extra
 Limit the summary buffer to articles that match one of the ``extra''
 headers (@pxref{To From Newsgroups})
@@ -6612,8 +6618,8 @@ matching articles.
 
 @item / u
 @itemx x
-@kindex / u @r{(Summary)}
-@kindex x @r{(Summary)}
+@kindex / u (Summary)
+@kindex x (Summary)
 @findex gnus-summary-limit-to-unread
 Limit the summary buffer to articles not marked as read
 (@code{gnus-summary-limit-to-unread}).  If given a prefix, limit the
@@ -6621,46 +6627,46 @@ buffer to articles strictly unread.  This means that ticked and
 dormant articles will also be excluded.
 
 @item / m
-@kindex / m @r{(Summary)}
+@kindex / m (Summary)
 @findex gnus-summary-limit-to-marks
 Ask for a mark and then limit to all articles that have been marked
 with that mark (@code{gnus-summary-limit-to-marks}).
 
 @item / t
-@kindex / t @r{(Summary)}
+@kindex / t (Summary)
 @findex gnus-summary-limit-to-age
 Ask for a number and then limit the summary buffer to articles older than (or equal to) that number of days
 (@code{gnus-summary-limit-to-age}).  If given a prefix, limit to
 articles younger than that number of days.
 
 @item / n
-@kindex / n @r{(Summary)}
+@kindex / n (Summary)
 @findex gnus-summary-limit-to-articles
 With prefix @samp{n}, limit the summary buffer to the next @samp{n}
 articles.  If not given a prefix, use the process marked articles
 instead.  (@code{gnus-summary-limit-to-articles}).
 
 @item / w
-@kindex / w @r{(Summary)}
+@kindex / w (Summary)
 @findex gnus-summary-pop-limit
 Pop the previous limit off the stack and restore it
 (@code{gnus-summary-pop-limit}).  If given a prefix, pop all limits off
 the stack.
 
 @item / .
-@kindex / . @r{(Summary)}
+@kindex / . (Summary)
 @findex gnus-summary-limit-to-unseen
 Limit the summary buffer to the unseen articles
 (@code{gnus-summary-limit-to-unseen}).
 
 @item / v
-@kindex / v @r{(Summary)}
+@kindex / v (Summary)
 @findex gnus-summary-limit-to-score
 Limit the summary buffer to articles that have a score at or above some
 score (@code{gnus-summary-limit-to-score}).
 
 @item / p
-@kindex / p @r{(Summary)}
+@kindex / p (Summary)
 @findex gnus-summary-limit-to-display-predicate
 Limit the summary buffer to articles that satisfy the @code{display}
 group parameter predicate
@@ -6668,7 +6674,7 @@ group parameter predicate
 Parameters}, for more on this predicate.
 
 @item / r
-@kindex / r @r{(Summary)}
+@kindex / r (Summary)
 @findex gnus-summary-limit-to-replied
 Limit the summary buffer to replied articles
 (@code{gnus-summary-limit-to-replied}).  If given a prefix, exclude
@@ -6676,55 +6682,55 @@ replied articles.
 
 @item / E
 @itemx M S
-@kindex M S @r{(Summary)}
-@kindex / E @r{(Summary)}
+@kindex M S (Summary)
+@kindex / E (Summary)
 @findex gnus-summary-limit-include-expunged
 Include all expunged articles in the limit
 (@code{gnus-summary-limit-include-expunged}).
 
 @item / D
-@kindex / D @r{(Summary)}
+@kindex / D (Summary)
 @findex gnus-summary-limit-include-dormant
 Include all dormant articles in the limit
 (@code{gnus-summary-limit-include-dormant}).
 
 @item / *
-@kindex / * @r{(Summary)}
+@kindex / * (Summary)
 @findex gnus-summary-limit-include-cached
 Include all cached articles in the limit
 (@code{gnus-summary-limit-include-cached}).
 
 @item / d
-@kindex / d @r{(Summary)}
+@kindex / d (Summary)
 @findex gnus-summary-limit-exclude-dormant
 Exclude all dormant articles from the limit
 (@code{gnus-summary-limit-exclude-dormant}).
 
 @item / M
-@kindex / M @r{(Summary)}
+@kindex / M (Summary)
 @findex gnus-summary-limit-exclude-marks
 Exclude all marked articles (@code{gnus-summary-limit-exclude-marks}).
 
 @item / T
-@kindex / T @r{(Summary)}
+@kindex / T (Summary)
 @findex gnus-summary-limit-include-thread
 Include all the articles in the current thread in the limit.
 
 @item / c
-@kindex / c @r{(Summary)}
+@kindex / c (Summary)
 @findex gnus-summary-limit-exclude-childless-dormant
 Exclude all dormant articles that have no children from the limit@*
 (@code{gnus-summary-limit-exclude-childless-dormant}).
 
 @item / C
-@kindex / C @r{(Summary)}
+@kindex / C (Summary)
 @findex gnus-summary-limit-mark-excluded-as-read
 Mark all excluded unread articles as read
 (@code{gnus-summary-limit-mark-excluded-as-read}).  If given a prefix,
 also mark excluded ticked and dormant articles as read.
 
 @item / b
-@kindex / b @r{(Summary)}
+@kindex / b (Summary)
 @findex gnus-summary-limit-to-bodies
 Limit the summary buffer to articles that have bodies that match a
 certain regexp (@code{gnus-summary-limit-to-bodies}).  If given a
@@ -6732,7 +6738,7 @@ prefix, reverse the limit.  This command is quite slow since it
 requires selecting each article to find the matches.
 
 @item / h
-@kindex / h @r{(Summary)}
+@kindex / h (Summary)
 @findex gnus-summary-limit-to-headers
 Like the previous command, only limit to headers instead
 (@code{gnus-summary-limit-to-headers}).
@@ -6745,13 +6751,13 @@ prefix as well.
 
 @table @kbd
 @item / N
-@kindex / N @r{(Summary)}
+@kindex / N (Summary)
 @findex gnus-summary-insert-new-articles
 Insert all new articles in the summary buffer.  It scans for new emails
 if @var{back-end}@code{-get-new-mail} is non-@code{nil}.
 
 @item / o
-@kindex / o @r{(Summary)}
+@kindex / o (Summary)
 @findex gnus-summary-insert-old-articles
 Insert all old articles in the summary buffer.  If given a numbered
 prefix, fetch this number of articles.
@@ -7037,7 +7043,7 @@ visible effects, but is useful if you use the @kbd{A T} command a lot
 
 The server has to support @acronym{NOV} for any of this to work.
 
-@cindex Gmane, @code{gnus-fetch-old-headers}
+@cindex Gmane, gnus-fetch-old-headers
 This feature can seriously impact performance it ignores all locally
 cached header entries.  Setting it to @code{t} for groups for a server
 that doesn't expire articles (such as news.gmane.org), leads to very
@@ -7191,8 +7197,8 @@ meaningful.  Here's one example:
 
 @item T k
 @itemx C-M-k
-@kindex T k @r{(Summary)}
-@kindex C-M-k @r{(Summary)}
+@kindex T k (Summary)
+@kindex C-M-k (Summary)
 @findex gnus-summary-kill-thread
 Mark all articles in the current (sub-)thread as read
 (@code{gnus-summary-kill-thread}).  If the prefix argument is positive,
@@ -7201,71 +7207,71 @@ articles instead.
 
 @item T l
 @itemx C-M-l
-@kindex T l @r{(Summary)}
-@kindex C-M-l @r{(Summary)}
+@kindex T l (Summary)
+@kindex C-M-l (Summary)
 @findex gnus-summary-lower-thread
 Lower the score of the current (sub-)thread
 (@code{gnus-summary-lower-thread}).
 
 @item T i
-@kindex T i @r{(Summary)}
+@kindex T i (Summary)
 @findex gnus-summary-raise-thread
 Increase the score of the current (sub-)thread
 (@code{gnus-summary-raise-thread}).
 
 @item T #
-@kindex T # @r{(Summary)}
+@kindex T # (Summary)
 @findex gnus-uu-mark-thread
 Set the process mark on the current (sub-)thread
 (@code{gnus-uu-mark-thread}).
 
 @item T M-#
-@kindex T M-# @r{(Summary)}
+@kindex T M-# (Summary)
 @findex gnus-uu-unmark-thread
 Remove the process mark from the current (sub-)thread
 (@code{gnus-uu-unmark-thread}).
 
 @item T T
-@kindex T T @r{(Summary)}
+@kindex T T (Summary)
 @findex gnus-summary-toggle-threads
 Toggle threading (@code{gnus-summary-toggle-threads}).
 
 @item T s
-@kindex T s @r{(Summary)}
+@kindex T s (Summary)
 @findex gnus-summary-show-thread
 Expose the (sub-)thread hidden under the current article, if any@*
 (@code{gnus-summary-show-thread}).
 
 @item T h
-@kindex T h @r{(Summary)}
+@kindex T h (Summary)
 @findex gnus-summary-hide-thread
 Hide the current (sub-)thread (@code{gnus-summary-hide-thread}).
 
 @item T S
-@kindex T S @r{(Summary)}
+@kindex T S (Summary)
 @findex gnus-summary-show-all-threads
 Expose all hidden threads (@code{gnus-summary-show-all-threads}).
 
 @item T H
-@kindex T H @r{(Summary)}
+@kindex T H (Summary)
 @findex gnus-summary-hide-all-threads
 Hide all threads (@code{gnus-summary-hide-all-threads}).
 
 @item T t
-@kindex T t @r{(Summary)}
+@kindex T t (Summary)
 @findex gnus-summary-rethread-current
 Re-thread the current article's thread
 (@code{gnus-summary-rethread-current}).  This works even when the
 summary buffer is otherwise unthreaded.
 
 @item T ^
-@kindex T ^ @r{(Summary)}
+@kindex T ^ (Summary)
 @findex gnus-summary-reparent-thread
 Make the current article the child of the marked (or previous) article
 (@code{gnus-summary-reparent-thread}).
 
 @item T M-^
-@kindex T M-^ @r{(Summary)}
+@kindex T M-^ (Summary)
 @findex gnus-summary-reparent-children
 Make the current article the parent of the marked articles
 (@code{gnus-summary-reparent-children}).
@@ -7278,35 +7284,35 @@ understand the numeric prefix.
 @table @kbd
 
 @item T n
-@kindex T n @r{(Summary)}
+@kindex T n (Summary)
 @itemx C-M-f
-@kindex C-M-n @r{(Summary)}
-@itemx M-@key{DOWN}
-@kindex M-DOWN @r{(Summary)}
+@kindex C-M-n (Summary)
+@itemx M-down
+@kindex M-down (Summary)
 @findex gnus-summary-next-thread
 Go to the next thread (@code{gnus-summary-next-thread}).
 
 @item T p
-@kindex T p @r{(Summary)}
+@kindex T p (Summary)
 @itemx C-M-b
-@kindex C-M-p @r{(Summary)}
-@itemx M-@key{UP}
-@kindex M-UP @r{(Summary)}
+@kindex C-M-p (Summary)
+@itemx M-up
+@kindex M-up (Summary)
 @findex gnus-summary-prev-thread
 Go to the previous thread (@code{gnus-summary-prev-thread}).
 
 @item T d
-@kindex T d @r{(Summary)}
+@kindex T d (Summary)
 @findex gnus-summary-down-thread
 Descend the thread (@code{gnus-summary-down-thread}).
 
 @item T u
-@kindex T u @r{(Summary)}
+@kindex T u (Summary)
 @findex gnus-summary-up-thread
 Ascend the thread (@code{gnus-summary-up-thread}).
 
 @item T o
-@kindex T o @r{(Summary)}
+@kindex T o (Summary)
 @findex gnus-summary-top-thread
 Go to the top of the thread (@code{gnus-summary-top-thread}).
 @end table
@@ -7648,12 +7654,12 @@ you use two explicit commands for managing persistent articles:
 @table @kbd
 
 @item *
-@kindex * @r{(Summary)}
+@kindex * (Summary)
 @findex gnus-cache-enter-article
 Make the current article persistent (@code{gnus-cache-enter-article}).
 
 @item M-*
-@kindex M-* @r{(Summary)}
+@kindex M-* (Summary)
 @findex gnus-cache-remove-article
 Remove the current article from the persistent articles
 (@code{gnus-cache-remove-article}).  This will normally delete the
@@ -7691,7 +7697,7 @@ select another article.  You can make an article sticky with:
 
 @table @kbd
 @item A S
-@kindex A S @r{(Summary)}
+@kindex A S (Summary)
 @findex gnus-sticky-article
 Make the current article sticky.  If a prefix arg is given, ask for a
 name for this sticky article buffer.
@@ -7701,12 +7707,12 @@ To close a sticky article buffer you can use these commands:
 
 @table @kbd
 @item q
-@kindex q @r{@r{(Article)}}
+@kindex q (Article)
 @findex bury-buffer
 Puts this sticky article buffer at the end of the list of all buffers.
 
 @item k
-@kindex k @r{(Article)}
+@kindex k (Article)
 @findex gnus-kill-sticky-article-buffer
 Kills this sticky article buffer.
 @end table
@@ -7772,61 +7778,61 @@ deleted before saving.
 
 @item O o
 @itemx o
-@kindex O o @r{(Summary)}
-@kindex o @r{(Summary)}
+@kindex O o (Summary)
+@kindex o (Summary)
 @findex gnus-summary-save-article
 @c @icon{gnus-summary-save-article}
 Save the current article using the default article saver
 (@code{gnus-summary-save-article}).
 
 @item O m
-@kindex O m @r{(Summary)}
+@kindex O m (Summary)
 @findex gnus-summary-save-article-mail
 Save the current article in a Unix mail box (mbox) file
 (@code{gnus-summary-save-article-mail}).
 
 @item O r
-@kindex O r @r{(Summary)}
+@kindex O r (Summary)
 @findex gnus-summary-save-article-rmail
 Save the current article in Rmail format
 (@code{gnus-summary-save-article-rmail}).  This is mbox since Emacs 23,
 Babyl in older versions.
 
 @item O f
-@kindex O f @r{(Summary)}
+@kindex O f (Summary)
 @findex gnus-summary-save-article-file
 @c @icon{gnus-summary-save-article-file}
 Save the current article in plain file format
 (@code{gnus-summary-save-article-file}).
 
 @item O F
-@kindex O F @r{(Summary)}
+@kindex O F (Summary)
 @findex gnus-summary-write-article-file
 Write the current article in plain file format, overwriting any previous
 file contents (@code{gnus-summary-write-article-file}).
 
 @item O b
-@kindex O b @r{(Summary)}
+@kindex O b (Summary)
 @findex gnus-summary-save-article-body-file
 Save the current article body in plain file format
 (@code{gnus-summary-save-article-body-file}).
 
 @item O h
-@kindex O h @r{(Summary)}
+@kindex O h (Summary)
 @findex gnus-summary-save-article-folder
 Save the current article in mh folder format
 (@code{gnus-summary-save-article-folder}).
 
 @item O v
-@kindex O v @r{(Summary)}
+@kindex O v (Summary)
 @findex gnus-summary-save-article-vm
 Save the current article in a VM folder
 (@code{gnus-summary-save-article-vm}).
 
 @item O p
 @itemx |
-@kindex O p @r{(Summary)}
-@kindex | @r{(Summary)}
+@kindex O p (Summary)
+@kindex | (Summary)
 @findex gnus-summary-pipe-output
 @vindex gnus-summary-pipe-output-default-command
 Save the current article in a pipe.  Uhm, like, what I mean is---Pipe
@@ -7839,7 +7845,7 @@ to a string containing the default command and options (default
 @code{nil}).
 
 @item O P
-@kindex O P @r{(Summary)}
+@kindex O P (Summary)
 @findex gnus-summary-muttprint
 @vindex gnus-summary-muttprint-program
 Save the current article into muttprint.  That is, print it using the
@@ -8146,24 +8152,24 @@ commands, and you have to mark the articles manually with @kbd{#}.
 @table @kbd
 
 @item X u
-@kindex X u @r{(Summary)}
+@kindex X u (Summary)
 @findex gnus-uu-decode-uu
 @c @icon{gnus-uu-decode-uu}
 Uudecodes the current series (@code{gnus-uu-decode-uu}).
 
 @item X U
-@kindex X U @r{(Summary)}
+@kindex X U (Summary)
 @findex gnus-uu-decode-uu-and-save
 Uudecodes and saves the current series
 (@code{gnus-uu-decode-uu-and-save}).
 
 @item X v u
-@kindex X v u @r{(Summary)}
+@kindex X v u (Summary)
 @findex gnus-uu-decode-uu-view
 Uudecodes and views the current series (@code{gnus-uu-decode-uu-view}).
 
 @item X v U
-@kindex X v U @r{(Summary)}
+@kindex X v U (Summary)
 @findex gnus-uu-decode-uu-and-save-view
 Uudecodes, views and saves the current series
 (@code{gnus-uu-decode-uu-and-save-view}).
@@ -8204,22 +8210,22 @@ some commands to deal with these:
 @table @kbd
 
 @item X s
-@kindex X s @r{(Summary)}
+@kindex X s (Summary)
 @findex gnus-uu-decode-unshar
 Unshars the current series (@code{gnus-uu-decode-unshar}).
 
 @item X S
-@kindex X S @r{(Summary)}
+@kindex X S (Summary)
 @findex gnus-uu-decode-unshar-and-save
 Unshars and saves the current series (@code{gnus-uu-decode-unshar-and-save}).
 
 @item X v s
-@kindex X v s @r{(Summary)}
+@kindex X v s (Summary)
 @findex gnus-uu-decode-unshar-view
 Unshars and views the current series (@code{gnus-uu-decode-unshar-view}).
 
 @item X v S
-@kindex X v S @r{(Summary)}
+@kindex X v S (Summary)
 @findex gnus-uu-decode-unshar-and-save-view
 Unshars, views and saves the current series
 (@code{gnus-uu-decode-unshar-and-save-view}).
@@ -8233,24 +8239,24 @@ Unshars, views and saves the current series
 @table @kbd
 
 @item X p
-@kindex X p @r{(Summary)}
+@kindex X p (Summary)
 @findex gnus-uu-decode-postscript
 Unpack the current PostScript series (@code{gnus-uu-decode-postscript}).
 
 @item X P
-@kindex X P @r{(Summary)}
+@kindex X P (Summary)
 @findex gnus-uu-decode-postscript-and-save
 Unpack and save the current PostScript series
 (@code{gnus-uu-decode-postscript-and-save}).
 
 @item X v p
-@kindex X v p @r{(Summary)}
+@kindex X v p (Summary)
 @findex gnus-uu-decode-postscript-view
 View the current PostScript series
 (@code{gnus-uu-decode-postscript-view}).
 
 @item X v P
-@kindex X v P @r{(Summary)}
+@kindex X v P (Summary)
 @findex gnus-uu-decode-postscript-and-save-view
 View and save the current PostScript series
 (@code{gnus-uu-decode-postscript-and-save-view}).
@@ -8262,19 +8268,19 @@ View and save the current PostScript series
 
 @table @kbd
 @item X o
-@kindex X o @r{(Summary)}
+@kindex X o (Summary)
 @findex gnus-uu-decode-save
 Save the current series
 (@code{gnus-uu-decode-save}).
 
 @item X b
-@kindex X b @r{(Summary)}
+@kindex X b (Summary)
 @findex gnus-uu-decode-binhex
 Unbinhex the current series (@code{gnus-uu-decode-binhex}).  This
 doesn't really work yet.
 
 @item X Y
-@kindex X Y @r{(Summary)}
+@kindex X Y (Summary)
 @findex gnus-uu-decode-yenc
 yEnc-decode the current series and save it (@code{gnus-uu-decode-yenc}).
 @end table
@@ -8548,7 +8554,7 @@ you want it to look like technicolor fruit salad.
 @table @kbd
 
 @item W H a
-@kindex W H a @r{(Summary)}
+@kindex W H a (Summary)
 @findex gnus-article-highlight
 @findex gnus-article-maybe-highlight
 Do much highlighting of the current article
@@ -8556,7 +8562,7 @@ Do much highlighting of the current article
 text, the signature, and adds buttons to the body and the head.
 
 @item W H h
-@kindex W H h @r{(Summary)}
+@kindex W H h (Summary)
 @findex gnus-article-highlight-headers
 @vindex gnus-header-face-alist
 Highlight the headers (@code{gnus-article-highlight-headers}).  The
@@ -8570,7 +8576,7 @@ the header value.  The first match made will be used.  Note that
 @var{regexp} shouldn't have @samp{^} prepended---Gnus will add one.
 
 @item W H c
-@kindex W H c @r{(Summary)}
+@kindex W H c (Summary)
 @findex gnus-article-highlight-citation
 Highlight cited text (@code{gnus-article-highlight-citation}).
 
@@ -8631,7 +8637,7 @@ is @code{t}.
 
 
 @item W H s
-@kindex W H s @r{(Summary)}
+@kindex W H s (Summary)
 @vindex gnus-signature-separator
 @vindex gnus-signature-face
 @findex gnus-article-highlight-signature
@@ -8652,7 +8658,7 @@ default.
 @cindex article emphasis
 
 @findex gnus-article-emphasize
-@kindex W e @r{(Summary)}
+@kindex W e (Summary)
 People commonly add emphasis to words in news articles by writing things
 like @samp{_this_} or @samp{*this*} or @samp{/this/}.  Gnus can make
 this look nicer by running the article through the @kbd{W e}
@@ -8723,32 +8729,32 @@ too much cruft in most articles.
 @table @kbd
 
 @item W W a
-@kindex W W a @r{(Summary)}
+@kindex W W a (Summary)
 @findex gnus-article-hide
 Do quite a lot of hiding on the article buffer
 (@kbd{gnus-article-hide}).  In particular, this function will hide
 headers, @acronym{PGP}, cited text and the signature.
 
 @item W W h
-@kindex W W h @r{(Summary)}
+@kindex W W h (Summary)
 @findex gnus-article-hide-headers
 Hide headers (@code{gnus-article-hide-headers}).  @xref{Hiding
 Headers}.
 
 @item W W b
-@kindex W W b @r{(Summary)}
+@kindex W W b (Summary)
 @findex gnus-article-hide-boring-headers
 Hide headers that aren't particularly interesting
 (@code{gnus-article-hide-boring-headers}).  @xref{Hiding Headers}.
 
 @item W W s
-@kindex W W s @r{(Summary)}
+@kindex W W s (Summary)
 @findex gnus-article-hide-signature
 Hide signature (@code{gnus-article-hide-signature}).  @xref{Article
 Signature}.
 
 @item W W l
-@kindex W W l @r{(Summary)}
+@kindex W W l (Summary)
 @findex gnus-article-hide-list-identifiers
 @vindex gnus-list-identifiers
 Strip list identifiers specified in @code{gnus-list-identifiers}.  These
@@ -8767,13 +8773,13 @@ subject.  This can also be a list of regular expressions.
 @end table
 
 @item W W P
-@kindex W W P @r{(Summary)}
+@kindex W W P (Summary)
 @findex gnus-article-hide-pem
 Hide @acronym{PEM} (privacy enhanced messages) cruft
 (@code{gnus-article-hide-pem}).
 
 @item W W B
-@kindex W W B @r{(Summary)}
+@kindex W W B (Summary)
 @findex gnus-article-strip-banner
 @vindex gnus-article-banner-alist
 @vindex gnus-article-address-banner-alist
@@ -8827,7 +8833,7 @@ sends, you can use the following element to remove them:
 @end table
 
 @item W W c
-@kindex W W c @r{(Summary)}
+@kindex W W c (Summary)
 @findex gnus-article-hide-citation
 Hide citation (@code{gnus-article-hide-citation}).  Some variables for
 customizing the hiding:
@@ -8863,7 +8869,7 @@ and bottom of the text, respectively, to remain visible.
 @end table
 
 @item W W C-c
-@kindex W W C-c @r{(Summary)}
+@kindex W W C-c (Summary)
 @findex gnus-article-hide-citation-maybe
 
 Hide citation (@code{gnus-article-hide-citation-maybe}) depending on the
@@ -8882,7 +8888,7 @@ is hidden.
 @end table
 
 @item W W C
-@kindex W W C @r{(Summary)}
+@kindex W W C (Summary)
 @findex gnus-article-hide-citation-in-followups
 Hide cited text in articles that aren't roots
 (@code{gnus-article-hide-citation-in-followups}).  This isn't very
@@ -8932,14 +8938,14 @@ interactive Washing functions but with all default treatments
 (@pxref{Customizing Articles}).
 
 @item W l
-@kindex W l @r{(Summary)}
+@kindex W l (Summary)
 @findex gnus-summary-stop-page-breaking
 Remove page breaks from the current article
 (@code{gnus-summary-stop-page-breaking}).  @xref{Misc Article}, for page
 delimiters.
 
 @item W r
-@kindex W r @r{(Summary)}
+@kindex W r (Summary)
 @findex gnus-summary-caesar-message
 @c @icon{gnus-summary-caesar-message}
 Do a Caesar rotate (rot13) on the article buffer
@@ -8953,12 +8959,12 @@ positions in the alphabet, e.g., @samp{B} (letter #2) -> @samp{O} (letter
 is rumored to have employed this form of, uh, somewhat weak encryption.
 
 @item W m
-@kindex W m @r{(Summary)}
+@kindex W m (Summary)
 @findex gnus-summary-morse-message
 Morse decode the article buffer (@code{gnus-summary-morse-message}).
 
 @item W i
-@kindex W i @r{(Summary)}
+@kindex W i (Summary)
 @findex gnus-summary-idna-message
 Decode IDNA encoded domain names in the current articles.  IDNA
 encoded domain names looks like @samp{xn--bar}.  If a string remain
@@ -8969,25 +8975,25 @@ to work.
 
 @item W t
 @item t
-@kindex W t @r{(Summary)}
-@kindex t @r{(Summary)}
+@kindex W t (Summary)
+@kindex t (Summary)
 @findex gnus-summary-toggle-header
 Toggle whether to display all headers in the article buffer
 (@code{gnus-summary-toggle-header}).
 
 @item W v
-@kindex W v @r{(Summary)}
+@kindex W v (Summary)
 @findex gnus-summary-verbose-headers
 Toggle whether to display all headers in the article buffer permanently
 (@code{gnus-summary-verbose-headers}).
 
 @item W o
-@kindex W o @r{(Summary)}
+@kindex W o (Summary)
 @findex gnus-article-treat-overstrike
 Treat overstrike (@code{gnus-article-treat-overstrike}).
 
 @item W d
-@kindex W d @r{(Summary)}
+@kindex W d (Summary)
 @findex gnus-article-treat-dumbquotes
 @vindex gnus-article-dumbquotes-map
 @cindex Smartquotes
@@ -9005,7 +9011,7 @@ like @code{\222} or @code{\264} where you're expecting some kind of
 apostrophe or quotation mark, then try this wash.
 
 @item W U
-@kindex W U @r{(Summary)}
+@kindex W U (Summary)
 @findex gnus-article-treat-non-ascii
 @cindex Unicode
 @cindex Non-@acronym{ASCII}
@@ -9016,7 +9022,7 @@ and doesn't show accented characters, ``advanced'' punctuation, and the
 like.  For instance, @samp{»} is translated into @samp{>>}, and so on.
 
 @item W Y f
-@kindex W Y f @r{(Summary)}
+@kindex W Y f (Summary)
 @findex gnus-article-outlook-deuglify-article
 @cindex Outlook Express
 Full deuglify of broken Outlook (Express) articles: Treat dumbquotes,
@@ -9024,7 +9030,7 @@ unwrap lines, repair attribution and rearrange citation.
 (@code{gnus-article-outlook-deuglify-article}).
 
 @item W Y u
-@kindex W Y u @r{(Summary)}
+@kindex W Y u (Summary)
 @findex gnus-article-outlook-unwrap-lines
 @vindex gnus-outlook-deuglify-unwrap-min
 @vindex gnus-outlook-deuglify-unwrap-max
@@ -9036,19 +9042,19 @@ maximum length of an unwrapped citation line.
 (@code{gnus-article-outlook-unwrap-lines}).
 
 @item W Y a
-@kindex W Y a @r{(Summary)}
+@kindex W Y a (Summary)
 @findex gnus-article-outlook-repair-attribution
 Repair a broken attribution line.@*
 (@code{gnus-article-outlook-repair-attribution}).
 
 @item W Y c
-@kindex W Y c @r{(Summary)}
+@kindex W Y c (Summary)
 @findex gnus-article-outlook-rearrange-citation
 Repair broken citations by rearranging the text.
 (@code{gnus-article-outlook-rearrange-citation}).
 
 @item W w
-@kindex W w @r{(Summary)}
+@kindex W w (Summary)
 @findex gnus-article-fill-cited-article
 Do word wrap (@code{gnus-article-fill-cited-article}).
 
@@ -9056,18 +9062,18 @@ You can give the command a numerical prefix to specify the width to use
 when filling.
 
 @item W Q
-@kindex W Q @r{(Summary)}
+@kindex W Q (Summary)
 @findex gnus-article-fill-long-lines
 Fill long lines (@code{gnus-article-fill-long-lines}).
 
 @item W C
-@kindex W C @r{(Summary)}
+@kindex W C (Summary)
 @findex gnus-article-capitalize-sentences
 Capitalize the first word in each sentence
 (@code{gnus-article-capitalize-sentences}).
 
 @item W c
-@kindex W c @r{(Summary)}
+@kindex W c (Summary)
 @findex gnus-article-remove-cr
 Translate CRLF pairs (i.e., @samp{^M}s on the end of the lines) into LF
 (this takes care of DOS line endings), and then translate any remaining
@@ -9075,7 +9081,7 @@ CRs into LF (this takes care of Mac line endings)
 (@code{gnus-article-remove-cr}).
 
 @item W q
-@kindex W q @r{(Summary)}
+@kindex W q (Summary)
 @findex gnus-article-de-quoted-unreadable
 Treat quoted-printable (@code{gnus-article-de-quoted-unreadable}).
 Quoted-Printable is one common @acronym{MIME} encoding employed when
@@ -9087,7 +9093,7 @@ done automatically by Gnus if the message in question has a
 has been done.  If a prefix is given, a charset will be asked for.
 
 @item W 6
-@kindex W 6 @r{(Summary)}
+@kindex W 6 (Summary)
 @findex gnus-article-de-base64-unreadable
 Treat base64 (@code{gnus-article-de-base64-unreadable}).  Base64 is
 one common @acronym{MIME} encoding employed when sending
@@ -9097,14 +9103,14 @@ usually done automatically by Gnus if the message in question has a
 has been done.  If a prefix is given, a charset will be asked for.
 
 @item W Z
-@kindex W Z @r{(Summary)}
+@kindex W Z (Summary)
 @findex gnus-article-decode-HZ
 Treat HZ or HZP (@code{gnus-article-decode-HZ}).  HZ (or HZP) is one
 common encoding employed when sending Chinese articles.  It typically
 makes strings look like @samp{~@{<:Ky2;S@{#,NpJ)l6HK!#~@}}.
 
 @item W A
-@kindex W A @r{(Summary)}
+@kindex W A (Summary)
 @findex gnus-article-treat-ansi-sequences
 @cindex @acronym{ANSI} control sequences
 Translate @acronym{ANSI} SGR control sequences into overlays or
@@ -9112,7 +9118,7 @@ extents (@code{gnus-article-treat-ansi-sequences}).  @acronym{ANSI}
 sequences are used in some Chinese hierarchies for highlighting.
 
 @item W u
-@kindex W u @r{(Summary)}
+@kindex W u (Summary)
 @findex gnus-article-unsplit-urls
 Remove newlines from within URLs.  Some mailers insert newlines into
 outgoing email messages to keep lines short.  This reformatting can
@@ -9120,7 +9126,7 @@ split long URLs onto multiple lines.  Repair those URLs by removing
 the newlines (@code{gnus-article-unsplit-urls}).
 
 @item W h
-@kindex W h @r{(Summary)}
+@kindex W h (Summary)
 @findex gnus-article-wash-html
 Treat @acronym{HTML} (@code{gnus-article-wash-html}).  Note that this is
 usually done automatically by Gnus if the message in question has a
@@ -9160,19 +9166,19 @@ Use html2text---a simple @acronym{HTML} converter included with Gnus.
 @end table
 
 @item W b
-@kindex W b @r{(Summary)}
+@kindex W b (Summary)
 @findex gnus-article-add-buttons
 Add clickable buttons to the article (@code{gnus-article-add-buttons}).
 @xref{Article Buttons}.
 
 @item W B
-@kindex W B @r{(Summary)}
+@kindex W B (Summary)
 @findex gnus-article-add-buttons-to-head
 Add clickable buttons to the article headers
 (@code{gnus-article-add-buttons-to-head}).
 
 @item W p
-@kindex W p @r{(Summary)}
+@kindex W p (Summary)
 @findex gnus-article-verify-x-pgp-sig
 Verify a signed control message
 (@code{gnus-article-verify-x-pgp-sig}).  Control messages such as
@@ -9183,57 +9189,57 @@ message.@footnote{@acronym{PGP} keys for many hierarchies are
 available at @uref{https://ftp.isc.org/pub/pgpcontrol/README.html}}
 
 @item W s
-@kindex W s @r{(Summary)}
+@kindex W s (Summary)
 @findex gnus-summary-force-verify-and-decrypt
 Verify a signed (@acronym{PGP}, @acronym{PGP/MIME} or
 @acronym{S/MIME}) message
 (@code{gnus-summary-force-verify-and-decrypt}). @xref{Security}.
 
 @item W a
-@kindex W a @r{(Summary)}
+@kindex W a (Summary)
 @findex gnus-article-strip-headers-in-body
 Strip headers like the @code{X-No-Archive} header from the beginning of
 article bodies (@code{gnus-article-strip-headers-in-body}).
 
 @item W E l
-@kindex W E l @r{(Summary)}
+@kindex W E l (Summary)
 @findex gnus-article-strip-leading-blank-lines
 Remove all blank lines from the beginning of the article
 (@code{gnus-article-strip-leading-blank-lines}).
 
 @item W E m
-@kindex W E m @r{(Summary)}
+@kindex W E m (Summary)
 @findex gnus-article-strip-multiple-blank-lines
 Replace all blank lines with empty lines and then all multiple empty
 lines with a single empty line.
 (@code{gnus-article-strip-multiple-blank-lines}).
 
 @item W E t
-@kindex W E t @r{(Summary)}
+@kindex W E t (Summary)
 @findex gnus-article-remove-trailing-blank-lines
 Remove all blank lines at the end of the article
 (@code{gnus-article-remove-trailing-blank-lines}).
 
 @item W E a
-@kindex W E a @r{(Summary)}
+@kindex W E a (Summary)
 @findex gnus-article-strip-blank-lines
 Do all the three commands above
 (@code{gnus-article-strip-blank-lines}).
 
 @item W E A
-@kindex W E A @r{(Summary)}
+@kindex W E A (Summary)
 @findex gnus-article-strip-all-blank-lines
 Remove all blank lines
 (@code{gnus-article-strip-all-blank-lines}).
 
 @item W E s
-@kindex W E s @r{(Summary)}
+@kindex W E s (Summary)
 @findex gnus-article-strip-leading-space
 Remove all white space from the beginning of all lines of the article
 body (@code{gnus-article-strip-leading-space}).
 
 @item W E e
-@kindex W E e @r{(Summary)}
+@kindex W E e (Summary)
 @findex gnus-article-strip-trailing-space
 Remove all white space from the end of all lines of the article
 body (@code{gnus-article-strip-trailing-space}).
@@ -9251,24 +9257,24 @@ These commands perform various transformations of article header.
 @table @kbd
 
 @item W G u
-@kindex W G u @r{(Summary)}
+@kindex W G u (Summary)
 @findex gnus-article-treat-unfold-headers
 Unfold folded header lines (@code{gnus-article-treat-unfold-headers}).
 
 @item W G n
-@kindex W G n @r{(Summary)}
+@kindex W G n (Summary)
 @findex gnus-article-treat-fold-newsgroups
 Fold the @code{Newsgroups} and @code{Followup-To} headers
 (@code{gnus-article-treat-fold-newsgroups}).
 
 @item W G f
-@kindex W G f @r{(Summary)}
+@kindex W G f (Summary)
 @findex gnus-article-treat-fold-headers
 Fold all the message headers
 (@code{gnus-article-treat-fold-headers}).
 
 @item W E w
-@kindex W E w @r{(Summary)}
+@kindex W E w (Summary)
 @findex gnus-article-remove-leading-whitespace
 Remove excessive whitespace from all headers
 (@code{gnus-article-remove-leading-whitespace}).
@@ -9282,7 +9288,7 @@ Remove excessive whitespace from all headers
 
 People often include references to other stuff in articles, and it would
 be nice if Gnus could just fetch whatever it is that people talk about
-with the minimum of fuzz when you hit @kbd{@key{RET}} or use the middle mouse
+with the minimum of fuzz when you hit @kbd{RET} or use the middle mouse
 button on these references.
 
 @vindex gnus-button-man-handler
@@ -9488,31 +9494,31 @@ when the article was sent.
 @table @kbd
 
 @item W T u
-@kindex W T u @r{(Summary)}
+@kindex W T u (Summary)
 @findex gnus-article-date-ut
 Display the date in UT (aka. GMT, aka ZULU)
 (@code{gnus-article-date-ut}).
 
 @item W T i
-@kindex W T i @r{(Summary)}
+@kindex W T i (Summary)
 @findex gnus-article-date-iso8601
 @cindex ISO 8601
 Display the date in international format, aka. ISO 8601
 (@code{gnus-article-date-iso8601}).
 
 @item W T l
-@kindex W T l @r{(Summary)}
+@kindex W T l (Summary)
 @findex gnus-article-date-local
 Display the date in the local timezone (@code{gnus-article-date-local}).
 
 @item W T p
-@kindex W T p @r{(Summary)}
+@kindex W T p (Summary)
 @findex gnus-article-date-english
 Display the date in a format that's easily pronounceable in English
 (@code{gnus-article-date-english}).
 
 @item W T s
-@kindex W T s @r{(Summary)}
+@kindex W T s (Summary)
 @vindex gnus-article-time-format
 @findex gnus-article-date-user
 @findex format-time-string
@@ -9523,7 +9529,7 @@ to @code{format-time-string}.  See the documentation of that variable
 for a list of possible format specs.
 
 @item W T e
-@kindex W T e @r{(Summary)}
+@kindex W T e (Summary)
 @findex gnus-article-date-lapsed
 @findex gnus-start-date-timer
 @findex gnus-stop-date-timer
@@ -9539,7 +9545,7 @@ To make this line updated continually, set the
 seconds (the default is @code{nil}).
 
 @item W T o
-@kindex W T o @r{(Summary)}
+@kindex W T o (Summary)
 @findex gnus-article-date-original
 Display the original date (@code{gnus-article-date-original}).  This can
 be useful if you normally use some other conversion function and are
@@ -9583,58 +9589,58 @@ they'll be removed.
 
 @table @kbd
 @item W D x
-@kindex W D x @r{(Summary)}
+@kindex W D x (Summary)
 @findex gnus-article-display-x-face
 Display an @code{X-Face} in the @code{From} header.
 (@code{gnus-article-display-x-face}).
 
 @item W D d
-@kindex W D d @r{(Summary)}
+@kindex W D d (Summary)
 @findex gnus-article-display-face
 Display a @code{Face} in the @code{From} header.
 (@code{gnus-article-display-face}).
 
 @item W D s
-@kindex W D s @r{(Summary)}
+@kindex W D s (Summary)
 @findex gnus-treat-smiley
 Display smileys (@code{gnus-treat-smiley}).
 
 @item W D f
-@kindex W D f @r{(Summary)}
+@kindex W D f (Summary)
 @findex gnus-treat-from-picon
 Piconify the @code{From} header (@code{gnus-treat-from-picon}).
 
 @item W D m
-@kindex W D m @r{(Summary)}
+@kindex W D m (Summary)
 @findex gnus-treat-mail-picon
 Piconify all mail headers (i.e., @code{Cc}, @code{To})
 (@code{gnus-treat-mail-picon}).
 
 @item W D n
-@kindex W D n @r{(Summary)}
+@kindex W D n (Summary)
 @findex gnus-treat-newsgroups-picon
 Piconify all news headers (i.e., @code{Newsgroups} and
 @code{Followup-To}) (@code{gnus-treat-newsgroups-picon}).
 
 @item W D g
-@kindex W D g @r{(Summary)}
+@kindex W D g (Summary)
 @findex gnus-treat-from-gravatar
 Gravatarify the @code{From} header (@code{gnus-treat-from-gravatar}).
 
 @item W D h
-@kindex W D h @r{(Summary)}
+@kindex W D h (Summary)
 @findex gnus-treat-mail-gravatar
 Gravatarify all mail headers (i.e., @code{Cc}, @code{To})
 (@code{gnus-treat-from-gravatar}).
 
 @item W D D
-@kindex W D D @r{(Summary)}
+@kindex W D D (Summary)
 @findex gnus-article-remove-images
 Remove all images from the article buffer
 (@code{gnus-article-remove-images}).
 
 @item W D W
-@kindex W D W @r{(Summary)}
+@kindex W D W (Summary)
 @findex gnus-html-show-images
 If you're reading an @acronym{HTML} article rendered with
 @code{gnus-article-html}, then you can insert any blocked images in
@@ -9712,7 +9718,7 @@ signature after all.
 
 @table @kbd
 @item A t
-@kindex A t @r{(Summary)}
+@kindex A t (Summary)
 @findex gnus-article-babel
 Translate the article from one language to another
 (@code{gnus-article-babel}).
@@ -9732,43 +9738,43 @@ instance, @kbd{3 K v} means ``view the third @acronym{MIME} part''.
 @table @kbd
 @item b
 @itemx K v
-@kindex b @r{(Summary)}
-@kindex K v @r{(Summary)}
+@kindex b (Summary)
+@kindex K v (Summary)
 View the @acronym{MIME} part.
 
 @item K o
-@kindex K o @r{(Summary)}
+@kindex K o (Summary)
 Save the @acronym{MIME} part.
 
 @item K O
-@kindex K O @r{(Summary)}
+@kindex K O (Summary)
 Prompt for a file name, then save the @acronym{MIME} part and strip it
 from the article.  The stripped @acronym{MIME} object will be referred
 via the message/external-body @acronym{MIME} type.
 
 @item K r
-@kindex K r @r{(Summary)}
+@kindex K r (Summary)
 Replace the @acronym{MIME} part with an external body.
 
 @item K d
-@kindex K d @r{(Summary)}
+@kindex K d (Summary)
 Delete the @acronym{MIME} part and add some information about the
 removed part.
 
 @item K c
-@kindex K c @r{(Summary)}
+@kindex K c (Summary)
 Copy the @acronym{MIME} part.
 
 @item K e
-@kindex K e @r{(Summary)}
+@kindex K e (Summary)
 View the @acronym{MIME} part externally.
 
 @item K i
-@kindex K i @r{(Summary)}
+@kindex K i (Summary)
 View the @acronym{MIME} part internally.
 
 @item K |
-@kindex K | @r{(Summary)}
+@kindex K | (Summary)
 Pipe the @acronym{MIME} part to an external command.
 @end table
 
@@ -9777,7 +9783,7 @@ the same manner:
 
 @table @kbd
 @item K H
-@kindex K H @r{(Summary)}
+@kindex K H (Summary)
 @findex gnus-article-browse-html-article
 View @samp{text/html} parts of the current article with a WWW browser.
 Inline images embedded in a message using the @code{cid} scheme, as they
@@ -9799,13 +9805,13 @@ including images if any to the browser, and deletes them when exiting
 the group (if you want).
 
 @item K b
-@kindex K b @r{(Summary)}
+@kindex K b (Summary)
 Make all the @acronym{MIME} parts have buttons in front of them.  This is
 mostly useful if you wish to save (or perform other actions) on inlined
 parts.
 
 @item W M h
-@kindex W M h @r{(Summary)}
+@kindex W M h (Summary)
 @findex gnus-mime-buttonize-attachments-in-header
 @vindex gnus-mime-display-attachment-buttons-in-header
 Display @acronym{MIME} part buttons in the end of the header of an
@@ -9818,7 +9824,7 @@ The default is @code{t}.  To change the appearance of buttons, customize
 @code{gnus-header-face-alist}.
 
 @item K m
-@kindex K m @r{(Summary)}
+@kindex K m (Summary)
 @findex gnus-summary-repair-multipart
 Some multipart messages are transmitted with missing or faulty headers.
 This command will attempt to ``repair'' these messages so that they can
@@ -9826,26 +9832,26 @@ be viewed in a more pleasant manner
 (@code{gnus-summary-repair-multipart}).
 
 @item X m
-@kindex X m @r{(Summary)}
+@kindex X m (Summary)
 @findex gnus-summary-save-parts
 Save all parts matching a @acronym{MIME} type to a directory
 (@code{gnus-summary-save-parts}).  Understands the process/prefix
 convention (@pxref{Process/Prefix}).
 
 @item M-t
-@kindex M-t @r{(Summary)}
+@kindex M-t (Summary)
 @findex gnus-summary-toggle-display-buttonized
 Toggle the buttonized display of the article buffer
 (@code{gnus-summary-toggle-display-buttonized}).
 
 @item W M w
-@kindex W M w @r{(Summary)}
+@kindex W M w (Summary)
 @findex gnus-article-decode-mime-words
 Decode RFC 2047-encoded words in the article headers
 (@code{gnus-article-decode-mime-words}).
 
 @item W M c
-@kindex W M c @r{(Summary)}
+@kindex W M c (Summary)
 @findex gnus-article-decode-charset
 Decode encoded article bodies as well as charsets
 (@code{gnus-article-decode-charset}).
@@ -9858,7 +9864,7 @@ include @acronym{MIME} headers), you can set the @code{charset} group/topic
 parameter to the required charset (@pxref{Group Parameters}).
 
 @item W M v
-@kindex W M v @r{(Summary)}
+@kindex W M v (Summary)
 @findex gnus-mime-view-all-parts
 View all the @acronym{MIME} parts in the current article
 (@code{gnus-mime-view-all-parts}).
@@ -10117,7 +10123,7 @@ something like
 @item A P
 @cindex PostScript
 @cindex printing
-@kindex A P @r{(Summary)}
+@kindex A P (Summary)
 @vindex gnus-ps-print-hook
 @findex gnus-summary-print-article
 Generate and print a PostScript image of the article buffer
@@ -10148,68 +10154,68 @@ can't really see why you'd want that.
 @table @kbd
 
 @item C-c C-s C-n
-@kindex C-c C-s C-n @r{(Summary)}
+@kindex C-c C-s C-n (Summary)
 @findex gnus-summary-sort-by-number
 Sort by article number (@code{gnus-summary-sort-by-number}).
 
 @item C-c C-s C-m C-n
-@kindex C-c C-s C-n @r{(Summary)}
+@kindex C-c C-s C-n (Summary)
 @findex gnus-summary-sort-by-most-recent-number
 Sort by most recent article number
 (@code{gnus-summary-sort-by-most-recent-number}).
 
 @item C-c C-s C-a
-@kindex C-c C-s C-a @r{(Summary)}
+@kindex C-c C-s C-a (Summary)
 @findex gnus-summary-sort-by-author
 Sort by author (@code{gnus-summary-sort-by-author}).
 
 @item C-c C-s C-t
-@kindex C-c C-s C-t @r{(Summary)}
+@kindex C-c C-s C-t (Summary)
 @findex gnus-summary-sort-by-recipient
 Sort by recipient (@code{gnus-summary-sort-by-recipient}).
 
 @item C-c C-s C-s
-@kindex C-c C-s C-s @r{(Summary)}
+@kindex C-c C-s C-s (Summary)
 @findex gnus-summary-sort-by-subject
 Sort by subject (@code{gnus-summary-sort-by-subject}).
 
 @item C-c C-s C-d
-@kindex C-c C-s C-d @r{(Summary)}
+@kindex C-c C-s C-d (Summary)
 @findex gnus-summary-sort-by-date
 Sort by date (@code{gnus-summary-sort-by-date}).
 
 @item C-c C-s C-m C-d
-@kindex C-c C-s C-m C-d @r{(Summary)}
+@kindex C-c C-s C-m C-d (Summary)
 @findex gnus-summary-sort-by-most-recent-date
 Sort by most recent date (@code{gnus-summary-sort-by-most-recent-date}).
 
 @item C-c C-s C-l
-@kindex C-c C-s C-l @r{(Summary)}
+@kindex C-c C-s C-l (Summary)
 @findex gnus-summary-sort-by-lines
 Sort by lines (@code{gnus-summary-sort-by-lines}).
 
 @item C-c C-s C-c
-@kindex C-c C-s C-c @r{(Summary)}
+@kindex C-c C-s C-c (Summary)
 @findex gnus-summary-sort-by-chars
 Sort by article length (@code{gnus-summary-sort-by-chars}).
 
 @item C-c C-s C-m C-m
-@kindex C-c C-s C-m C-m @r{(Summary)}
+@kindex C-c C-s C-m C-m (Summary)
 @findex gnus-summary-sort-by-marks
 Sort by article ``readedness'' marks (@code{gnus-summary-sort-by-marks}).
 
 @item C-c C-s C-i
-@kindex C-c C-s C-i @r{(Summary)}
+@kindex C-c C-s C-i (Summary)
 @findex gnus-summary-sort-by-score
 Sort by score (@code{gnus-summary-sort-by-score}).
 
 @item C-c C-s C-r
-@kindex C-c C-s C-r @r{(Summary)}
+@kindex C-c C-s C-r (Summary)
 @findex gnus-summary-sort-by-random
 Randomize (@code{gnus-summary-sort-by-random}).
 
 @item C-c C-s C-o
-@kindex C-c C-s C-o @r{(Summary)}
+@kindex C-c C-s C-o (Summary)
 @findex gnus-summary-sort-by-original
 Sort using the default sorting method
 (@code{gnus-summary-sort-by-original}).
@@ -10232,7 +10238,7 @@ If a prefix argument if given, the sort order is reversed.
 
 @table @kbd
 @item ^
-@kindex ^ @r{(Summary)}
+@kindex ^ (Summary)
 @findex gnus-summary-refer-parent-article
 If you'd like to read the parent of the current article, and it is not
 displayed in the summary buffer, you might still be able to.  That is,
@@ -10252,13 +10258,13 @@ article.
 
 @item A R (Summary)
 @findex gnus-summary-refer-references
-@kindex A R @r{(Summary)}
+@kindex A R (Summary)
 Fetch all articles mentioned in the @code{References} header of the
 article (@code{gnus-summary-refer-references}).
 
 @item A T (Summary)
 @findex gnus-summary-refer-thread
-@kindex A T @r{(Summary)}
+@kindex A T (Summary)
 Display the full thread where the current article appears
 (@code{gnus-summary-refer-thread}).  This command has to fetch all the
 headers in the current group to work, so it usually takes a while.  If
@@ -10276,7 +10282,7 @@ by giving the @kbd{A T} command a numerical prefix.
 
 @item M-^ (Summary)
 @findex gnus-summary-refer-article
-@kindex M-^ @r{(Summary)}
+@kindex M-^ (Summary)
 @cindex Message-ID
 @cindex fetching by Message-ID
 You can also ask Gnus for an arbitrary article, no matter what group it
@@ -10346,6 +10352,7 @@ buffer the articles she wants to read.  Then she starts reading the
 articles with just an article buffer displayed.
 
 @findex gnus-pick-mode
+@kindex M-x gnus-pick-mode
 Gnus provides a summary buffer minor mode that allows
 this---@code{gnus-pick-mode}.  This basically means that a few process
 mark commands become one-keystroke commands to allow easy marking, and
@@ -10355,7 +10362,7 @@ Here are the available keystrokes when using pick mode:
 
 @table @kbd
 @item .
-@kindex . @r{(Pick)}
+@kindex . (Pick)
 @findex gnus-pick-article-or-thread
 Pick the article or thread on the current line
 (@code{gnus-pick-article-or-thread}).  If the variable
@@ -10365,14 +10372,14 @@ it selects just the article.  If given a numerical prefix, go to that
 thread or article and pick it.  (The line number is normally displayed
 at the beginning of the summary pick lines.)
 
-@item @key{SPC}
-@kindex SPC @r{(Pick)}
+@item SPACE
+@kindex SPACE (Pick)
 @findex gnus-pick-next-page
 Scroll the summary buffer up one page (@code{gnus-pick-next-page}).  If
 at the end of the buffer, start reading the picked articles.
 
 @item u
-@kindex u @r{(Pick)}
+@kindex u (Pick)
 @findex gnus-pick-unmark-article-or-thread.
 Unpick the thread or article
 (@code{gnus-pick-unmark-article-or-thread}).  If the variable
@@ -10381,8 +10388,8 @@ thread if used at the first article of the thread.  Otherwise it unpicks
 just the article.  You can give this key a numerical prefix to unpick
 the thread or article at that line.
 
-@item @key{RET}
-@kindex RET @r{(Pick)}
+@item RET
+@kindex RET (Pick)
 @findex gnus-pick-start-reading
 @vindex gnus-pick-display-summary
 Start reading the picked articles (@code{gnus-pick-start-reading}).  If
@@ -10424,13 +10431,14 @@ Variables}).  It accepts the same format specs that
 @cindex binary groups
 
 @findex gnus-binary-mode
+@kindex M-x gnus-binary-mode
 If you spend much time in binary groups, you may grow tired of hitting
-@kbd{X u}, @kbd{n}, @kbd{@key{RET}} all the time.  @kbd{M-x gnus-binary-mode}
+@kbd{X u}, @kbd{n}, @kbd{RET} all the time.  @kbd{M-x gnus-binary-mode}
 is a minor mode for summary buffers that makes all ordinary Gnus article
 selection functions uudecode series of articles and display the result
 instead of just displaying the articles the normal way.
 
-@kindex g @r{(Binary)}
+@kindex g (Binary)
 @findex gnus-binary-show-article
 The only way, in fact, to see the actual articles is the @kbd{g}
 command, when you have turned on this mode
@@ -10606,7 +10614,7 @@ process/prefix convention (@pxref{Process/Prefix}).
 @table @kbd
 
 @item B e
-@kindex B e @r{(Summary)}
+@kindex B e (Summary)
 @findex gnus-summary-expire-articles
 @cindex expiring mail
 Run all expirable articles in the current group through the expiry
@@ -10615,7 +10623,7 @@ expirable articles in the group that have been around for a while.
 (@pxref{Expiring Mail}).
 
 @item B C-M-e
-@kindex B C-M-e @r{(Summary)}
+@kindex B C-M-e (Summary)
 @findex gnus-summary-expire-articles-now
 @cindex expiring mail
 Delete all the expirable articles in the group
@@ -10623,8 +10631,8 @@ Delete all the expirable articles in the group
 articles eligible for expiry in the current group will
 disappear forever into that big @file{/dev/null} in the sky.
 
-@item B @key{DEL}
-@kindex B DEL @r{(Summary)}
+@item B DEL
+@kindex B DEL (Summary)
 @cindex deleting mail
 @findex gnus-summary-delete-article
 @c @icon{gnus-summary-mail-delete}
@@ -10633,7 +10641,7 @@ disk forever and ever, never to return again.'' Use with caution.
 (@code{gnus-summary-delete-article}).
 
 @item B m
-@kindex B m @r{(Summary)}
+@kindex B m (Summary)
 @cindex move mail
 @findex gnus-summary-move-article
 @vindex gnus-preserve-marks
@@ -10642,7 +10650,7 @@ Move the article from one mail group to another
 @code{gnus-preserve-marks} is non-@code{nil} (which is the default).
 
 @item B c
-@kindex B c @r{(Summary)}
+@kindex B c (Summary)
 @cindex copy mail
 @findex gnus-summary-copy-article
 @c @icon{gnus-summary-mail-copy}
@@ -10651,7 +10659,7 @@ Copy the article from one group (mail group or not) to a mail group
 @code{gnus-preserve-marks} is non-@code{nil} (which is the default).
 
 @item B B
-@kindex B B @r{(Summary)}
+@kindex B B (Summary)
 @cindex crosspost mail
 @findex gnus-summary-crosspost-article
 Crosspost the current article to some other group
@@ -10660,21 +10668,21 @@ the article in the other group, and the Xref headers of the article will
 be properly updated.
 
 @item B i
-@kindex B i @r{(Summary)}
+@kindex B i (Summary)
 @findex gnus-summary-import-article
 Import an arbitrary file into the current mail newsgroup
 (@code{gnus-summary-import-article}).  You will be prompted for a file
 name, a @code{From} header and a @code{Subject} header.
 
 @item B I
-@kindex B I @r{(Summary)}
+@kindex B I (Summary)
 @findex gnus-summary-create-article
 Create an empty article in the current mail newsgroups
 (@code{gnus-summary-create-article}).  You will be prompted for a
 @code{From} header and a @code{Subject} header.
 
 @item B r
-@kindex B r @r{(Summary)}
+@kindex B r (Summary)
 @findex gnus-summary-respool-article
 @vindex gnus-summary-respool-default-method
 Respool the mail article (@code{gnus-summary-respool-article}).
@@ -10686,10 +10694,10 @@ Marks will be preserved if @code{gnus-preserve-marks} is non-@code{nil}
 
 @item B w
 @itemx e
-@kindex B w @r{(Summary)}
-@kindex e @r{(Summary)}
+@kindex B w (Summary)
+@kindex e (Summary)
 @findex gnus-summary-edit-article
-@kindex C-c C-c @r{(Article)}
+@kindex C-c C-c (Article)
 @findex gnus-summary-edit-article-done
 Edit the current article (@code{gnus-summary-edit-article}).  To finish
 editing and make the changes permanent, type @kbd{C-c C-c}
@@ -10697,20 +10705,20 @@ editing and make the changes permanent, type @kbd{C-c C-c}
 @kbd{C-c C-c} command, Gnus won't re-highlight the article.
 
 @item B q
-@kindex B q @r{(Summary)}
+@kindex B q (Summary)
 @findex gnus-summary-respool-query
 If you want to re-spool an article, you might be curious as to what group
 the article will end up in before you do the re-spooling.  This command
 will tell you (@code{gnus-summary-respool-query}).
 
 @item B t
-@kindex B t @r{(Summary)}
+@kindex B t (Summary)
 @findex gnus-summary-respool-trace
 Similarly, this command will display all fancy splitting patterns used
 when respooling, if any (@code{gnus-summary-respool-trace}).
 
 @item B p
-@kindex B p @r{(Summary)}
+@kindex B p (Summary)
 @findex gnus-summary-article-posted-p
 Some people have a tendency to send you ``courtesy'' copies when they
 follow up to articles you have posted.  These usually have a
@@ -10724,7 +10732,7 @@ propagation is much faster than news propagation, and the news copy may
 just not have arrived yet.
 
 @item K E
-@kindex K E @r{(Summary)}
+@kindex K E (Summary)
 @findex gnus-article-encrypt-body
 @vindex gnus-article-encrypt-protocol
 Encrypt the body of an article (@code{gnus-article-encrypt-body}).
@@ -10859,20 +10867,20 @@ Also @pxref{Group Parameters}.
 @table @kbd
 
 @item H d
-@kindex H d @r{(Summary)}
+@kindex H d (Summary)
 @findex gnus-summary-describe-group
 Give a brief description of the current group
 (@code{gnus-summary-describe-group}).  If given a prefix, force
 rereading the description from the server.
 
 @item H h
-@kindex H h @r{(Summary)}
+@kindex H h (Summary)
 @findex gnus-summary-describe-briefly
 Give an extremely brief description of the most important summary
 keystrokes (@code{gnus-summary-describe-briefly}).
 
 @item H i
-@kindex H i @r{(Summary)}
+@kindex H i (Summary)
 @findex gnus-info-find-node
 Go to the Gnus info node (@code{gnus-info-find-node}).
 @end table
@@ -10884,31 +10892,31 @@ Go to the Gnus info node (@code{gnus-info-find-node}).
 @table @kbd
 
 @item M-s
-@kindex M-s @r{(Summary)}
+@kindex M-s (Summary)
 @findex gnus-summary-search-article-forward
 Search through all subsequent (raw) articles for a regexp
 (@code{gnus-summary-search-article-forward}).
 
 @item M-r
-@kindex M-r @r{(Summary)}
+@kindex M-r (Summary)
 @findex gnus-summary-search-article-backward
 Search through all previous (raw) articles for a regexp
 (@code{gnus-summary-search-article-backward}).
 
 @item M-S
-@kindex M-S @r{(Summary)}
+@kindex M-S (Summary)
 @findex gnus-summary-repeat-search-article-forward
 Repeat the previous search forwards
 (@code{gnus-summary-repeat-search-article-forward}).
 
 @item M-R
-@kindex M-R @r{(Summary)}
+@kindex M-R (Summary)
 @findex gnus-summary-repeat-search-article-backward
 Repeat the previous search backwards
 (@code{gnus-summary-repeat-search-article-backward}).
 
 @item &
-@kindex & @r{(Summary)}
+@kindex & (Summary)
 @findex gnus-summary-execute-command
 This command will prompt you for a header, a regular expression to match
 on this field, and a command to be executed if the match is made
@@ -10916,12 +10924,11 @@ on this field, and a command to be executed if the match is made
 string, the match is done on the entire article.  If given a prefix,
 search backward instead.
 
-For instance, @kbd{& @key{RET} some.*string @key{RET} #} will put the
-process mark on all articles that have heads or bodies that match
-@samp{some.*string}.
+For instance, @kbd{& RET some.*string RET #} will put the process mark on
+all articles that have heads or bodies that match @samp{some.*string}.
 
 @item M-&
-@kindex M-& @r{(Summary)}
+@kindex M-& (Summary)
 @findex gnus-summary-universal-argument
 Perform any operation on all articles that have been marked with
 the process mark (@code{gnus-summary-universal-argument}).
@@ -10933,24 +10940,24 @@ the process mark (@code{gnus-summary-universal-argument}).
 @table @kbd
 
 @item Y g
-@kindex Y g @r{(Summary)}
+@kindex Y g (Summary)
 @findex gnus-summary-prepare
 Regenerate the current summary buffer (@code{gnus-summary-prepare}).
 
 @item Y c
-@kindex Y c @r{(Summary)}
+@kindex Y c (Summary)
 @findex gnus-summary-insert-cached-articles
 Pull all cached articles (for the current group) into the summary buffer
 (@code{gnus-summary-insert-cached-articles}).
 
 @item Y d
-@kindex Y d @r{(Summary)}
+@kindex Y d (Summary)
 @findex gnus-summary-insert-dormant-articles
 Pull all dormant articles (for the current group) into the summary buffer
 (@code{gnus-summary-insert-dormant-articles}).
 
 @item Y t
-@kindex Y t @r{(Summary)}
+@kindex Y t (Summary)
 @findex gnus-summary-insert-ticked-articles
 Pull all ticked articles (for the current group) into the summary buffer
 (@code{gnus-summary-insert-ticked-articles}).
@@ -10965,8 +10972,8 @@ Pull all ticked articles (for the current group) into the summary buffer
 
 @item A D
 @itemx C-d
-@kindex C-d @r{(Summary)}
-@kindex A D @r{(Summary)}
+@kindex C-d (Summary)
+@kindex A D (Summary)
 @findex gnus-summary-enter-digest-group
 If the current article is a collection of other articles (for instance,
 a digest), you might use this command to enter a group based on that
@@ -11000,7 +11007,7 @@ If it has any other value or there is no next (unread) article, the
 article selected before entering to the digest group will appear.
 
 @item C-M-d
-@kindex C-M-d @r{(Summary)}
+@kindex C-M-d (Summary)
 @findex gnus-summary-read-document
 This command is very similar to the one above, but lets you gather
 several documents into one biiig group
@@ -11011,7 +11018,7 @@ command understands the process/prefix convention
 (@pxref{Process/Prefix}).
 
 @item C-t
-@kindex C-t @r{(Summary)}
+@kindex C-t (Summary)
 @findex gnus-summary-toggle-truncation
 Toggle truncation of summary lines
 (@code{gnus-summary-toggle-truncation}).  This will probably confuse the
@@ -11019,19 +11026,19 @@ line centering function in the summary buffer, so it's not a good idea
 to have truncation switched off while reading articles.
 
 @item =
-@kindex = @r{(Summary)}
+@kindex = (Summary)
 @findex gnus-summary-expand-window
 Expand the summary buffer window (@code{gnus-summary-expand-window}).
 If given a prefix, force an @code{article} window configuration.
 
 @item C-M-e
-@kindex C-M-e @r{(Summary)}
+@kindex C-M-e (Summary)
 @findex gnus-summary-edit-parameters
 Edit the group parameters (@pxref{Group Parameters}) of the current
 group (@code{gnus-summary-edit-parameters}).
 
 @item C-M-a
-@kindex C-M-a @r{(Summary)}
+@kindex C-M-a (Summary)
 @findex gnus-summary-customize-parameters
 Customize the group parameters (@pxref{Group Parameters}) of the current
 group (@code{gnus-summary-customize-parameters}).
@@ -11052,9 +11059,9 @@ group and return you to the group buffer.
 @item Z Z
 @itemx Z Q
 @itemx q
-@kindex Z Z @r{(Summary)}
-@kindex Z Q @r{(Summary)}
-@kindex q @r{(Summary)}
+@kindex Z Z (Summary)
+@kindex Z Q (Summary)
+@kindex q (Summary)
 @findex gnus-summary-exit
 @vindex gnus-summary-exit-hook
 @vindex gnus-summary-prepare-exit-hook
@@ -11070,43 +11077,43 @@ group mode having no more (unread) groups.
 
 @item Z E
 @itemx Q
-@kindex Z E @r{(Summary)}
-@kindex Q @r{(Summary)}
+@kindex Z E (Summary)
+@kindex Q (Summary)
 @findex gnus-summary-exit-no-update
 Exit the current group without updating any information on the group
 (@code{gnus-summary-exit-no-update}).
 
 @item Z c
 @itemx c
-@kindex Z c @r{(Summary)}
-@kindex c @r{(Summary)}
+@kindex Z c (Summary)
+@kindex c (Summary)
 @findex gnus-summary-catchup-and-exit
 @c @icon{gnus-summary-catchup-and-exit}
 Mark all unticked articles in the group as read and then exit
 (@code{gnus-summary-catchup-and-exit}).
 
 @item Z C
-@kindex Z C @r{(Summary)}
+@kindex Z C (Summary)
 @findex gnus-summary-catchup-all-and-exit
 Mark all articles, even the ticked ones, as read and then exit
 (@code{gnus-summary-catchup-all-and-exit}).
 
 @item Z n
-@kindex Z n @r{(Summary)}
+@kindex Z n (Summary)
 @findex gnus-summary-catchup-and-goto-next-group
 Mark all articles as read and go to the next group
 (@code{gnus-summary-catchup-and-goto-next-group}).
 
 @item Z p
-@kindex Z p @r{(Summary)}
+@kindex Z p (Summary)
 @findex gnus-summary-catchup-and-goto-prev-group
 Mark all articles as read and go to the previous group
 (@code{gnus-summary-catchup-and-goto-prev-group}).
 
 @item Z R
 @itemx C-x C-s
-@kindex Z R @r{(Summary)}
-@kindex C-x C-s @r{(Summary)}
+@kindex Z R (Summary)
+@kindex C-x C-s (Summary)
 @findex gnus-summary-reselect-current-group
 Exit this group, and then enter it again
 (@code{gnus-summary-reselect-current-group}).  If given a prefix, select
@@ -11114,8 +11121,8 @@ all articles, both read and unread.
 
 @item Z G
 @itemx M-g
-@kindex Z G @r{(Summary)}
-@kindex M-g @r{(Summary)}
+@kindex Z G (Summary)
+@kindex M-g (Summary)
 @findex gnus-summary-rescan-group
 @c @icon{gnus-summary-mail-get}
 Exit the group, check for new articles in the group, and select the
@@ -11123,19 +11130,19 @@ group (@code{gnus-summary-rescan-group}).  If given a prefix, select all
 articles, both read and unread.
 
 @item Z N
-@kindex Z N @r{(Summary)}
+@kindex Z N (Summary)
 @findex gnus-summary-next-group
 Exit the group and go to the next group
 (@code{gnus-summary-next-group}).
 
 @item Z P
-@kindex Z P @r{(Summary)}
+@kindex Z P (Summary)
 @findex gnus-summary-prev-group
 Exit the group and go to the previous group
 (@code{gnus-summary-prev-group}).
 
 @item Z s
-@kindex Z s @r{(Summary)}
+@kindex Z s (Summary)
 @findex gnus-summary-save-newsrc
 Save the current number of read/marked articles in the dribble buffer
 and then save the dribble buffer (@code{gnus-summary-save-newsrc}).  If
@@ -11406,7 +11413,7 @@ encrypted messages up can be found in the message manual
 @cindex mailing list
 @cindex RFC 2396
 
-@kindex A M @r{(Summary)}
+@kindex A M (summary)
 @findex gnus-mailing-list-insinuate
 Gnus understands some mailing list fields of RFC 2369.  To enable it,
 add a @code{to-list} group parameter (@pxref{Group Parameters}),
@@ -11418,33 +11425,33 @@ That enables the following commands to the summary buffer:
 @table @kbd
 
 @item C-c C-n h
-@kindex C-c C-n h @r{(Summary)}
+@kindex C-c C-n h (Summary)
 @findex gnus-mailing-list-help
 Send a message to fetch mailing list help, if List-Help field exists.
 
 @item C-c C-n s
-@kindex C-c C-n s @r{(Summary)}
+@kindex C-c C-n s (Summary)
 @findex gnus-mailing-list-subscribe
 Send a message to subscribe the mailing list, if List-Subscribe field exists.
 
 @item C-c C-n u
-@kindex C-c C-n u @r{(Summary)}
+@kindex C-c C-n u (Summary)
 @findex gnus-mailing-list-unsubscribe
 Send a message to unsubscribe the mailing list, if List-Unsubscribe
 field exists.
 
 @item C-c C-n p
-@kindex C-c C-n p @r{(Summary)}
+@kindex C-c C-n p (Summary)
 @findex gnus-mailing-list-post
 Post to the mailing list, if List-Post field exists.
 
 @item C-c C-n o
-@kindex C-c C-n o @r{(Summary)}
+@kindex C-c C-n o (Summary)
 @findex gnus-mailing-list-owner
 Send a message to the mailing list owner, if List-Owner field exists.
 
 @item C-c C-n a
-@kindex C-c C-n a @r{(Summary)}
+@kindex C-c C-n a (Summary)
 @findex gnus-mailing-list-archive
 Browse the mailing list archive, if List-Archive field exists.
 
@@ -11622,9 +11629,9 @@ The following commands are available when you have placed point over a
 
 @table @kbd
 @findex gnus-article-press-button
-@item @key{RET} (Article)
-@kindex RET @r{(Article)}
-@itemx @key{BUTTON-2} (Article)
+@item RET (Article)
+@kindex RET (Article)
+@itemx BUTTON-2 (Article)
 Toggle displaying of the @acronym{MIME} object
 (@code{gnus-article-press-button}).  If built-in viewers can not display
 the object, Gnus resorts to external viewers in the @file{mailcap}
@@ -11632,33 +11639,33 @@ files.  If a viewer has the @samp{copiousoutput} specification, the
 object is displayed inline.
 
 @findex gnus-mime-view-part
-@item M-@key{RET} (Article)
-@kindex M-RET @r{(Article)}
+@item M-RET (Article)
+@kindex M-RET (Article)
 @itemx v (Article)
 Prompt for a method, and then view the @acronym{MIME} object using this
 method (@code{gnus-mime-view-part}).
 
 @findex gnus-mime-view-part-as-type
 @item t (Article)
-@kindex t @r{(Article)}
+@kindex t (Article)
 View the @acronym{MIME} object as if it were a different @acronym{MIME} media type
 (@code{gnus-mime-view-part-as-type}).
 
 @findex gnus-mime-view-part-as-charset
 @item C (Article)
-@kindex C @r{(Article)}
+@kindex C (Article)
 Prompt for a charset, and then view the @acronym{MIME} object using this
 charset (@code{gnus-mime-view-part-as-charset}).
 
 @findex gnus-mime-save-part
 @item o (Article)
-@kindex o @r{(Article)}
+@kindex o (Article)
 Prompt for a file name, and then save the @acronym{MIME} object
 (@code{gnus-mime-save-part}).
 
 @findex gnus-mime-save-part-and-strip
 @item C-o (Article)
-@kindex C-o @r{(Article)}
+@kindex C-o (Article)
 Prompt for a file name, then save the @acronym{MIME} object and strip it from
 the article.  Then proceed to article editing, where a reasonable
 suggestion is being made on how the altered article should look
@@ -11668,14 +11675,14 @@ message/external-body @acronym{MIME} type.
 
 @findex gnus-mime-replace-part
 @item r (Article)
-@kindex r @r{(Article)}
+@kindex r (Article)
 Prompt for a file name, replace the @acronym{MIME} object with an
 external body referring to the file via the message/external-body
 @acronym{MIME} type.  (@code{gnus-mime-replace-part}).
 
 @findex gnus-mime-delete-part
 @item d (Article)
-@kindex d @r{(Article)}
+@kindex d (Article)
 Delete the @acronym{MIME} object from the article and replace it with some
 information about the removed @acronym{MIME} object
 (@code{gnus-mime-delete-part}).
@@ -11684,7 +11691,7 @@ information about the removed @acronym{MIME} object
 
 @findex gnus-mime-copy-part
 @item c (Article)
-@kindex c @r{(Article)}
+@kindex c (Article)
 Copy the @acronym{MIME} object to a fresh buffer and display this buffer
 (@code{gnus-mime-copy-part}).  If given a prefix, copy the raw contents
 without decoding.  If given a numerical prefix, you can do semi-manual
@@ -11696,14 +11703,14 @@ Accessing Compressed Files, emacs, The Emacs Editor}).
 
 @findex gnus-mime-print-part
 @item p (Article)
-@kindex p @r{(Article)}
+@kindex p (Article)
 Print the @acronym{MIME} object (@code{gnus-mime-print-part}).  This
 command respects the @samp{print=} specifications in the
 @file{.mailcap} file.
 
 @findex gnus-mime-inline-part
 @item i (Article)
-@kindex i @r{(Article)}
+@kindex i (Article)
 Insert the contents of the @acronym{MIME} object into the buffer
 (@code{gnus-mime-inline-part}) as @samp{text/plain}.  If given a prefix, insert
 the raw contents without decoding.  If given a numerical prefix, you can
@@ -11716,25 +11723,25 @@ Compressed Files, emacs, The Emacs Editor}).
 
 @findex gnus-mime-view-part-internally
 @item E (Article)
-@kindex E @r{(Article)}
+@kindex E (Article)
 View the @acronym{MIME} object with an internal viewer.  If no internal
 viewer is available, use an external viewer
 (@code{gnus-mime-view-part-internally}).
 
 @findex gnus-mime-view-part-externally
 @item e (Article)
-@kindex e @r{(Article)}
+@kindex e (Article)
 View the @acronym{MIME} object with an external viewer.
 (@code{gnus-mime-view-part-externally}).
 
 @findex gnus-mime-pipe-part
 @item | (Article)
-@kindex | @r{(Article)}
+@kindex | (Article)
 Output the @acronym{MIME} object to a process (@code{gnus-mime-pipe-part}).
 
 @findex gnus-mime-action-on-part
 @item . (Article)
-@kindex . @r{(Article)}
+@kindex . (Article)
 Interactively run an action on the @acronym{MIME} object
 (@code{gnus-mime-action-on-part}).
 
@@ -11918,7 +11925,7 @@ controlling variable is a predicate list, as described above.
 
 @ifinfo
 @c Avoid sort of redundant entries in the same section for the printed
-@c manual, but add them in info to allow 'i gnus-treat-foo-bar @key{RET}' or
+@c manual, but add them in info to allow 'i gnus-treat-foo-bar RET' or
 @c 'i foo-bar'.
 @vindex gnus-treat-buttonize
 @vindex gnus-treat-buttonize-head
@@ -12123,7 +12130,7 @@ buffer, which means that you don't actually have to have a summary
 buffer displayed while reading.  You can do it all from the article
 buffer.
 
-@kindex v @r{(Article)}
+@kindex v (Article)
 @cindex keys, reserved for users (Article)
 The key @kbd{v} is reserved for users.  You can bind it to some
 command or better use it as a prefix key.
@@ -12132,70 +12139,70 @@ A few additional keystrokes are available:
 
 @table @kbd
 
-@item @key{SPC}
-@kindex SPC @r{(Article)}
+@item SPACE
+@kindex SPACE (Article)
 @findex gnus-article-next-page
 Scroll forwards one page (@code{gnus-article-next-page}).
-This is exactly the same as @kbd{h @key{SPC} h}.
+This is exactly the same as @kbd{h SPACE h}.
 
-@item @key{DEL}
-@kindex DEL @r{(Article)}
+@item DEL
+@kindex DEL (Article)
 @findex gnus-article-prev-page
 Scroll backwards one page (@code{gnus-article-prev-page}).
-This is exactly the same as @kbd{h @key{DEL} h}.
+This is exactly the same as @kbd{h DEL h}.
 
 @item C-c ^
-@kindex C-c ^ @r{(Article)}
+@kindex C-c ^ (Article)
 @findex gnus-article-refer-article
 If point is in the neighborhood of a @code{Message-ID} and you press
 @kbd{C-c ^}, Gnus will try to get that article from the server
 (@code{gnus-article-refer-article}).
 
 @item C-c C-m
-@kindex C-c C-m @r{(Article)}
+@kindex C-c C-m (Article)
 @findex gnus-article-mail
 Send a reply to the address near point (@code{gnus-article-mail}).  If
 given a prefix, include the mail.
 
 @item s
-@kindex s @r{(Article)}
+@kindex s (Article)
 @findex gnus-article-show-summary
 Reconfigure the buffers so that the summary buffer becomes visible
 (@code{gnus-article-show-summary}).
 
 @item ?
-@kindex ? @r{(Article)}
+@kindex ? (Article)
 @findex gnus-article-describe-briefly
 Give a very brief description of the available keystrokes
 (@code{gnus-article-describe-briefly}).
 
-@item @key{TAB}
-@kindex TAB @r{(Article)}
+@item TAB
+@kindex TAB (Article)
 @findex gnus-article-next-button
 Go to the next button, if any (@code{gnus-article-next-button}).  This
 only makes sense if you have buttonizing turned on.
 
-@item M-@key{TAB}
-@kindex M-TAB @r{(Article)}
+@item M-TAB
+@kindex M-TAB (Article)
 @findex gnus-article-prev-button
 Go to the previous button, if any (@code{gnus-article-prev-button}).
 
 @item R
-@kindex R @r{(Article)}
+@kindex R (Article)
 @findex gnus-article-reply-with-original
 Send a reply to the current article and yank the current article
 (@code{gnus-article-reply-with-original}).  If the region is active,
 only yank the text in the region.
 
 @item S W
-@kindex S W @r{(Article)}
+@kindex S W (Article)
 @findex gnus-article-wide-reply-with-original
 Send a wide reply to the current article and yank the current article
 (@code{gnus-article-wide-reply-with-original}).  If the region is
 active, only yank the text in the region.
 
 @item F
-@kindex F @r{(Article)}
+@kindex F (Article)
 @findex gnus-article-followup-with-original
 Send a followup to the current article and yank the current article
 (@code{gnus-article-followup-with-original}).  If the region is active,
@@ -12218,7 +12225,7 @@ If non-@code{nil}, use the same article buffer for all the groups.
 article buffer.
 
 @item gnus-widen-article-window
-@vindex gnus-widen-article-window
+@cindex gnus-widen-article-window
 If non-@code{nil}, selecting the article buffer with the @kbd{h}
 command will ``widen'' the article window to take the entire frame.
 
@@ -12341,7 +12348,7 @@ when @code{mm-text-html-renderer} (@pxref{Display Customization,
 @cindex using s/mime
 @cindex using smime
 
-@kindex C-c C-c @r{(Post)}
+@kindex C-c C-c (Post)
 All commands for posting and mailing will put you in a message buffer
 where you can edit the article all you like, before you send the
 article by pressing @kbd{C-c C-c}.  @xref{Top, , Overview, message,
@@ -12939,10 +12946,10 @@ correct parameters.  The content of the group is not lost.
 
 @c @findex gnus-dissociate-buffer-from-draft
 @c @kindex C-c M-d (Mail)
-@c @kindex C-c M-d @r{(Post)}
+@c @kindex C-c M-d (Post)
 @c @findex gnus-associate-buffer-with-draft
 @c @kindex C-c C-d (Mail)
-@c @kindex C-c C-d @r{(Post)}
+@c @kindex C-c C-d (Post)
 @c If you're writing some super-secret message that you later want to
 @c encode with PGP before sending, you may wish to turn the auto-saving
 @c (and association with the draft group) off.  You never know who might be
@@ -12957,7 +12964,7 @@ correct parameters.  The content of the group is not lost.
 @c @code{gnus-use-draft} to @code{nil}.  It is @code{t} by default.
 
 @findex gnus-draft-edit-message
-@kindex D e @r{(Draft)}
+@kindex D e (Draft)
 When you want to continue editing the article, you simply enter the
 draft group and push @kbd{D e} (@code{gnus-draft-edit-message}) to do
 that.  You will be placed in a buffer where you left off.
@@ -12966,9 +12973,9 @@ Rejected articles will also be put in this draft group (@pxref{Rejected
 Articles}).
 
 @findex gnus-draft-send-all-messages
-@kindex D s @r{(Draft)}
+@kindex D s (Draft)
 @findex gnus-draft-send-message
-@kindex D S @r{(Draft)}
+@kindex D S (Draft)
 If you have lots of rejected messages you want to post (or mail) without
 doing further editing, you can use the @kbd{D s} command
 (@code{gnus-draft-send-message}).  This command understands the
@@ -12977,12 +12984,12 @@ command (@code{gnus-draft-send-all-messages}) will ship off all messages
 in the buffer.
 
 @findex gnus-draft-toggle-sending
-@kindex D t @r{(Draft)}
+@kindex D t (Draft)
 If you have some messages that you wish not to send, you can use the
 @kbd{D t} (@code{gnus-draft-toggle-sending}) command to mark the message
 as unsendable.  This is a toggling command.
 
-Finally, if you want to delete a draft, use the normal @kbd{B @key{DEL}}
+Finally, if you want to delete a draft, use the normal @kbd{B DEL}
 command (@pxref{Mail Group Commands}).
 
 
@@ -13034,43 +13041,43 @@ signing and the @kbd{C-c C-m c} key map for encryption, as follows.
 @table @kbd
 
 @item C-c C-m s s
-@kindex C-c C-m s s @r{(Message)}
+@kindex C-c C-m s s (Message)
 @findex mml-secure-message-sign-smime
 
 Digitally sign current message using @acronym{S/MIME}.
 
 @item C-c C-m s o
-@kindex C-c C-m s o @r{(Message)}
+@kindex C-c C-m s o (Message)
 @findex mml-secure-message-sign-pgp
 
 Digitally sign current message using @acronym{PGP}.
 
 @item C-c C-m s p
-@kindex C-c C-m s p @r{(Message)}
+@kindex C-c C-m s p (Message)
 @findex mml-secure-message-sign-pgp
 
 Digitally sign current message using @acronym{PGP/MIME}.
 
 @item C-c C-m c s
-@kindex C-c C-m c s @r{(Message)}
+@kindex C-c C-m c s (Message)
 @findex mml-secure-message-encrypt-smime
 
 Digitally encrypt current message using @acronym{S/MIME}.
 
 @item C-c C-m c o
-@kindex C-c C-m c o @r{(Message)}
+@kindex C-c C-m c o (Message)
 @findex mml-secure-message-encrypt-pgp
 
 Digitally encrypt current message using @acronym{PGP}.
 
 @item C-c C-m c p
-@kindex C-c C-m c p @r{(Message)}
+@kindex C-c C-m c p (Message)
 @findex mml-secure-message-encrypt-pgpmime
 
 Digitally encrypt current message using @acronym{PGP/MIME}.
 
 @item C-c C-m C-n
-@kindex C-c C-m C-n @r{(Message)}
+@kindex C-c C-m C-n (Message)
 @findex mml-unsecure-message
 Remove security related @acronym{MML} tags from message.
 
@@ -13217,72 +13224,72 @@ in your init files.
 @table @kbd
 
 @item v
-@kindex v @r{(Server)}
+@kindex v (Server)
 @cindex keys, reserved for users (Server)
 The key @kbd{v} is reserved for users.  You can bind it to some
 command or better use it as a prefix key.
 
 @item a
-@kindex a @r{(Server)}
+@kindex a (Server)
 @findex gnus-server-add-server
 Add a new server (@code{gnus-server-add-server}).
 
 @item e
-@kindex e @r{(Server)}
+@kindex e (Server)
 @findex gnus-server-edit-server
 Edit a server (@code{gnus-server-edit-server}).
 
 @item S
-@kindex S @r{(Server)}
+@kindex S (Server)
 @findex gnus-server-show-server
 Show the definition of a server (@code{gnus-server-show-server}).
 
-@item @key{SPC}
-@kindex SPC @r{(Server)}
+@item SPACE
+@kindex SPACE (Server)
 @findex gnus-server-read-server
 Browse the current server (@code{gnus-server-read-server}).
 
 @item q
-@kindex q @r{(Server)}
+@kindex q (Server)
 @findex gnus-server-exit
 Return to the group buffer (@code{gnus-server-exit}).
 
 @item k
-@kindex k @r{(Server)}
+@kindex k (Server)
 @findex gnus-server-kill-server
 Kill the current server (@code{gnus-server-kill-server}).
 
 @item y
-@kindex y @r{(Server)}
+@kindex y (Server)
 @findex gnus-server-yank-server
 Yank the previously killed server (@code{gnus-server-yank-server}).
 
 @item c
-@kindex c @r{(Server)}
+@kindex c (Server)
 @findex gnus-server-copy-server
 Copy the current server (@code{gnus-server-copy-server}).
 
 @item l
-@kindex l @r{(Server)}
+@kindex l (Server)
 @findex gnus-server-list-servers
 List all servers (@code{gnus-server-list-servers}).
 
 @item s
-@kindex s @r{(Server)}
+@kindex s (Server)
 @findex gnus-server-scan-server
 Request that the server scan its sources for new articles
 (@code{gnus-server-scan-server}).  This is mainly sensible with mail
 servers.
 
 @item g
-@kindex g @r{(Server)}
+@kindex g (Server)
 @findex gnus-server-regenerate-server
 Request that the server regenerate all its data structures
 (@code{gnus-server-regenerate-server}).  This can be useful if you have
 a mail back end that has gotten out of sync.
 
 @item z
-@kindex z @r{(Server)}
+@kindex z (Server)
 @findex gnus-server-compact-server
 
 Compact all groups in the server under point
@@ -13414,7 +13421,7 @@ First you need to add a new server.  The @kbd{a} command does that.  It
 would probably be best to use @code{nnml} to read the cache.  You
 could also use @code{nnspool} or @code{nnmh}, though.
 
-Type @kbd{a nnml @key{RET} cache @key{RET}}.
+Type @kbd{a nnml RET cache RET}.
 
 You should now have a brand new @code{nnml} virtual server called
 @samp{cache}.  You now need to edit it to have the right definitions.
@@ -13434,7 +13441,7 @@ Change that to:
 @end lisp
 
 Type @kbd{C-c C-c} to return to the server buffer.  If you now press
-@kbd{@key{RET}} over this virtual server, you should be entered into a browse
+@kbd{RET} over this virtual server, you should be entered into a browse
 buffer, and you should be able to enter any of the groups displayed.
 
 
@@ -13505,44 +13512,44 @@ with the following commands:
 @table @kbd
 
 @item O
-@kindex O @r{(Server)}
+@kindex O (Server)
 @findex gnus-server-open-server
 Try to establish connection to the server on the current line
 (@code{gnus-server-open-server}).
 
 @item C
-@kindex C @r{(Server)}
+@kindex C (Server)
 @findex gnus-server-close-server
 Close the connection (if any) to the server
 (@code{gnus-server-close-server}).
 
 @item D
-@kindex D @r{(Server)}
+@kindex D (Server)
 @findex gnus-server-deny-server
 Mark the current server as unreachable
 (@code{gnus-server-deny-server}).  This will effectively disable the
 server.
 
 @item M-o
-@kindex M-o @r{(Server)}
+@kindex M-o (Server)
 @findex gnus-server-open-all-servers
 Open the connections to all servers in the buffer
 (@code{gnus-server-open-all-servers}).
 
 @item M-c
-@kindex M-c @r{(Server)}
+@kindex M-c (Server)
 @findex gnus-server-close-all-servers
 Close the connections to all servers in the buffer
 (@code{gnus-server-close-all-servers}).
 
 @item R
-@kindex R @r{(Server)}
+@kindex R (Server)
 @findex gnus-server-remove-denials
 Remove all marks to whether Gnus was denied connection from any servers
 (@code{gnus-server-remove-denials}).
 
 @item c
-@kindex c @r{(Server)}
+@kindex c (Server)
 @findex gnus-server-copy-server
 Copy a server and give it a new name
 (@code{gnus-server-copy-server}).  This can be useful if you have a
@@ -13550,7 +13557,7 @@ complex method definition, and want to use the same definition towards
 a different (physical) server.
 
 @item L
-@kindex L @r{(Server)}
+@kindex L (Server)
 @findex gnus-server-offline-server
 Set server status to offline (@code{gnus-server-offline-server}).
 
@@ -14558,7 +14565,7 @@ see @ref{Fancy Mail Splitting}.
 Note that the mail back ends are free to maul the poor, innocent,
 incoming headers all they want to.  They all add @code{Lines} headers;
 some add @code{X-Gnus-Group} headers; most rename the Unix mbox
-@code{From@key{SPC}} line to something else.
+@code{From<SPACE>} line to something else.
 
 @vindex nnmail-crosspost
 The mail back ends all support cross-posting.  If several regexps match,
@@ -14575,6 +14582,7 @@ links.  If that's the case for you, set
 @code{nnmail-crosspost-link-function} to @code{copy-file}.  (This
 variable is @code{add-name-to-file} by default.)
 
+@kindex M-x nnmail-split-history
 @findex nnmail-split-history
 If you wish to see where the previous mail split put the messages, you
 can use the @kbd{M-x nnmail-split-history} command.  If you wish to see
@@ -15713,7 +15721,7 @@ Type @kbd{G f} and give the file name to the mbox file when prompted to create a
 @code{nndoc} group from the mbox file (@pxref{Foreign Groups}).
 
 @item
-Type @kbd{@key{SPC}} to enter the newly created group.
+Type @kbd{SPACE} to enter the newly created group.
 
 @item
 Type @kbd{M P b} to process-mark all articles in this group's buffer
@@ -16028,7 +16036,7 @@ This can also be done non-destructively with
 
 @item nnmail-remove-tabs
 @findex nnmail-remove-tabs
-Translate all @samp{@key{TAB}} characters into @samp{@key{SPC}} characters.
+Translate all @samp{TAB} characters into @samp{SPACE} characters.
 
 @item nnmail-ignore-broken-references
 @findex nnmail-ignore-broken-references
@@ -16705,6 +16713,7 @@ The directory where the @acronym{NOV} files should be stored.  If
 
 
 @findex nnfolder-generate-active-file
+@kindex M-x nnfolder-generate-active-file
 If you have lots of @code{nnfolder}-like files you'd like to read with
 @code{nnfolder}, you can use the @kbd{M-x nnfolder-generate-active-file}
 command to make @code{nnfolder} aware of all likely files in
@@ -17053,14 +17062,14 @@ system because @acronym{RSS} uses UTF-8 for encoding non-@acronym{ASCII}
 text by default.  It is also used by default for non-@acronym{ASCII}
 group names.
 
-@kindex G R @r{(Group)}
+@kindex G R (Group)
 Use @kbd{G R} from the group buffer to subscribe to a feed---you will be
 prompted for the location, the title and the description of the feed.
 The title, which allows any characters, will be used for the group name
 and the name of the group data file.  The description can be omitted.
 
 An easy way to get started with @code{nnrss} is to say something like
-the following in the group buffer: @kbd{B nnrss @key{RET} @key{RET} y}, then
+the following in the group buffer: @kbd{B nnrss RET RET y}, then
 subscribe to groups.
 
 The @code{nnrss} back end saves the group data file in
@@ -18661,51 +18670,51 @@ The following commands are available in this buffer:
 
 @table @kbd
 @item q
-@kindex q @r{(Category)}
+@kindex q (Category)
 @findex gnus-category-exit
 Return to the group buffer (@code{gnus-category-exit}).
 
 @item e
-@kindex e @r{(Category)}
+@kindex e (Category)
 @findex gnus-category-customize-category
 Use a customization buffer to set all of the selected category's
 parameters at one time (@code{gnus-category-customize-category}).
 
 @item k
-@kindex k @r{(Category)}
+@kindex k (Category)
 @findex gnus-category-kill
 Kill the current category (@code{gnus-category-kill}).
 
 @item c
-@kindex c @r{(Category)}
+@kindex c (Category)
 @findex gnus-category-copy
 Copy the current category (@code{gnus-category-copy}).
 
 @item a
-@kindex a @r{(Category)}
+@kindex a (Category)
 @findex gnus-category-add
 Add a new category (@code{gnus-category-add}).
 
 @item p
-@kindex p @r{(Category)}
+@kindex p (Category)
 @findex gnus-category-edit-predicate
 Edit the predicate of the current category
 (@code{gnus-category-edit-predicate}).
 
 @item g
-@kindex g @r{(Category)}
+@kindex g (Category)
 @findex gnus-category-edit-groups
 Edit the list of groups belonging to the current category
 (@code{gnus-category-edit-groups}).
 
 @item s
-@kindex s @r{(Category)}
+@kindex s (Category)
 @findex gnus-category-edit-score
 Edit the download score rule of the current category
 (@code{gnus-category-edit-score}).
 
 @item l
-@kindex l @r{(Category)}
+@kindex l (Category)
 @findex gnus-category-list
 List all the categories (@code{gnus-category-list}).
 @end table
@@ -18779,7 +18788,7 @@ have to enable expiration in selected groups.
 @node Agent Commands
 @subsection Agent Commands
 @findex gnus-agent-toggle-plugged
-@kindex J j @r{(Agent)}
+@kindex J j (Agent)
 
 All the Gnus Agent commands are on the @kbd{J} submap.  The @kbd{J j}
 (@code{gnus-agent-toggle-plugged}) command works in all modes, and
@@ -18800,44 +18809,44 @@ toggles the plugged/unplugged state of the Gnus Agent.
 
 @table @kbd
 @item J u
-@kindex J u @r{(Agent Group)}
+@kindex J u (Agent Group)
 @findex gnus-agent-fetch-groups
 Fetch all eligible articles in the current group
 (@code{gnus-agent-fetch-groups}).
 
 @item J c
-@kindex J c @r{(Agent Group)}
+@kindex J c (Agent Group)
 @findex gnus-enter-category-buffer
 Enter the Agent category buffer (@code{gnus-enter-category-buffer}).
 
 @item J s
-@kindex J s @r{(Agent Group)}
+@kindex J s (Agent Group)
 @findex gnus-agent-fetch-session
 Fetch all eligible articles in all groups
 (@code{gnus-agent-fetch-session}).
 
 @item J S
-@kindex J S @r{(Agent Group)}
+@kindex J S (Agent Group)
 @findex gnus-group-send-queue
 Send all sendable messages in the queue group
 (@code{gnus-group-send-queue}).  @xref{Drafts}.
 
 @item J a
-@kindex J a @r{(Agent Group)}
+@kindex J a (Agent Group)
 @findex gnus-agent-add-group
 Add the current group to an Agent category
 (@code{gnus-agent-add-group}).  This command understands the
 process/prefix convention (@pxref{Process/Prefix}).
 
 @item J r
-@kindex J r @r{(Agent Group)}
+@kindex J r (Agent Group)
 @findex gnus-agent-remove-group
 Remove the current group from its category, if any
 (@code{gnus-agent-remove-group}).  This command understands the
 process/prefix convention (@pxref{Process/Prefix}).
 
 @item J Y
-@kindex J Y @r{(Agent Group)}
+@kindex J Y (Agent Group)
 @findex gnus-agent-synchronize-flags
 Synchronize flags changed while unplugged with remote server, if any.
 
@@ -18850,43 +18859,43 @@ Synchronize flags changed while unplugged with remote server, if any.
 
 @table @kbd
 @item J #
-@kindex J # @r{(Agent Summary)}
+@kindex J # (Agent Summary)
 @findex gnus-agent-mark-article
 Mark the article for downloading (@code{gnus-agent-mark-article}).
 
 @item J M-#
-@kindex J M-# @r{(Agent Summary)}
+@kindex J M-# (Agent Summary)
 @findex gnus-agent-unmark-article
 Remove the downloading mark from the article
 (@code{gnus-agent-unmark-article}).
 
 @cindex %
 @item @@
-@kindex @@ @r{(Agent Summary)}
+@kindex @@ (Agent Summary)
 @findex gnus-agent-toggle-mark
 Toggle whether to download the article
 (@code{gnus-agent-toggle-mark}).  The download mark is @samp{%} by
 default.
 
 @item J c
-@kindex J c @r{(Agent Summary)}
+@kindex J c (Agent Summary)
 @findex gnus-agent-catchup
 Mark all articles as read (@code{gnus-agent-catchup}) that are neither cached, downloaded, nor downloadable.
 
 @item J S
-@kindex J S @r{(Agent Summary)}
+@kindex J S (Agent Summary)
 @findex gnus-agent-fetch-group
 Download all eligible (@pxref{Agent Categories}) articles in this group.
 (@code{gnus-agent-fetch-group}).
 
 @item J s
-@kindex J s @r{(Agent Summary)}
+@kindex J s (Agent Summary)
 @findex gnus-agent-summary-fetch-series
 Download all processable articles in this group.
 (@code{gnus-agent-summary-fetch-series}).
 
 @item J u
-@kindex J u @r{(Agent Summary)}
+@kindex J u (Agent Summary)
 @findex gnus-agent-summary-fetch-group
 Download all downloadable articles in the current group
 (@code{gnus-agent-summary-fetch-group}).
@@ -18899,13 +18908,13 @@ Download all downloadable articles in the current group
 
 @table @kbd
 @item J a
-@kindex J a @r{(Agent Server)}
+@kindex J a (Agent Server)
 @findex gnus-agent-add-server
 Add the current server to the list of servers covered by the Gnus Agent
 (@code{gnus-agent-add-server}).
 
 @item J r
-@kindex J r @r{(Agent Server)}
+@kindex J r (Agent Server)
 @findex gnus-agent-remove-server
 Remove the current server from the list of servers covered by the Gnus
 Agent (@code{gnus-agent-remove-server}).
@@ -19006,6 +19015,8 @@ sense if you are using a nntp or nnimap back end.
 
 @vindex gnus-agent-expire-days
 @findex gnus-agent-expire
+@kindex M-x gnus-agent-expire
+@kindex M-x gnus-agent-expire-group
 @findex gnus-agent-expire-group
 @cindex agent expiry
 @cindex Gnus agent expiry
@@ -19059,12 +19070,14 @@ failure.  Running @code{gnus-agent-regenerate} or
 such that you don't need to download these articles a second time.
 
 @findex gnus-agent-regenerate
+@kindex M-x gnus-agent-regenerate
 The command @code{gnus-agent-regenerate} will perform
 @code{gnus-agent-regenerate-group} on every agentized group.  While
 you can run @code{gnus-agent-regenerate} in any buffer, it is strongly
 recommended that you first close all summary buffers.
 
 @findex gnus-agent-regenerate-group
+@kindex M-x gnus-agent-regenerate-group
 The command @code{gnus-agent-regenerate-group} uses the local copies
 of individual articles to repair the local @acronym{NOV}(header) database.  It
 then updates the internal data structures that document which articles
@@ -19450,18 +19463,18 @@ General score commands that don't actually change the score file:
 @table @kbd
 
 @item V s
-@kindex V s @r{(Summary)}
+@kindex V s (Summary)
 @findex gnus-summary-set-score
 Set the score of the current article (@code{gnus-summary-set-score}).
 
 @item V S
-@kindex V S @r{(Summary)}
+@kindex V S (Summary)
 @findex gnus-summary-current-score
 Display the score of the current article
 (@code{gnus-summary-current-score}).
 
 @item V t
-@kindex V t @r{(Summary)}
+@kindex V t (Summary)
 @findex gnus-score-find-trace
 Display all score rules that have been used on the current article
 (@code{gnus-score-find-trace}).  In the @file{*Score Trace*} buffer, you
@@ -19470,12 +19483,12 @@ current line and @kbd{f} to format (@code{gnus-score-pretty-print}) the
 score file and edit it.
 
 @item V w
-@kindex V w @r{(Summary)}
-@findex gnus-score-find-favorite-words
-List words used in scoring (@code{gnus-score-find-favorite-words}).
+@kindex V w (Summary)
+@findex gnus-score-find-favourite-words
+List words used in scoring (@code{gnus-score-find-favourite-words}).
 
 @item V R
-@kindex V R @r{(Summary)}
+@kindex V R (Summary)
 @findex gnus-summary-rescore
 Run the current summary through the scoring process
 (@code{gnus-summary-rescore}).  This might be useful if you're playing
@@ -19483,32 +19496,32 @@ around with your score files behind Gnus' back and want to see the
 effect you're having.
 
 @item V c
-@kindex V c @r{(Summary)}
+@kindex V c (Summary)
 @findex gnus-score-change-score-file
 Make a different score file the current
 (@code{gnus-score-change-score-file}).
 
 @item V e
-@kindex V e @r{(Summary)}
+@kindex V e (Summary)
 @findex gnus-score-edit-current-scores
 Edit the current score file (@code{gnus-score-edit-current-scores}).
 You will be popped into a @code{gnus-score-mode} buffer (@pxref{Score
 File Editing}).
 
 @item V f
-@kindex V f @r{(Summary)}
+@kindex V f (Summary)
 @findex gnus-score-edit-file
 Edit a score file and make this score file the current one
 (@code{gnus-score-edit-file}).
 
 @item V F
-@kindex V F @r{(Summary)}
+@kindex V F (Summary)
 @findex gnus-score-flush-cache
 Flush the score cache (@code{gnus-score-flush-cache}).  This is useful
 after editing score files.
 
 @item V C
-@kindex V C @r{(Summary)}
+@kindex V C (Summary)
 @findex gnus-score-customize
 Customize a score file in a visually pleasing manner
 (@code{gnus-score-customize}).
@@ -19520,13 +19533,13 @@ The rest of these commands modify the local score file.
 @table @kbd
 
 @item V m
-@kindex V m @r{(Summary)}
+@kindex V m (Summary)
 @findex gnus-score-set-mark-below
 Prompt for a score, and mark all articles with a score below this as
 read (@code{gnus-score-set-mark-below}).
 
 @item V x
-@kindex V x @r{(Summary)}
+@kindex V x (Summary)
 @findex gnus-score-set-expunge-below
 Prompt for a score, and add a score rule to the current score file to
 expunge all articles below this score
@@ -19661,7 +19674,7 @@ Immediately scoring.
 @item
 If you are scoring on @samp{e} (extra) headers, you will then be prompted for
 the header name on which you wish to score.  This must be a header named
-in gnus-extra-headers, and @samp{@key{TAB}} completion is available.
+in gnus-extra-headers, and @samp{TAB} completion is available.
 
 @end enumerate
 
@@ -19696,13 +19709,13 @@ There aren't many of these as yet, I'm afraid.
 @table @kbd
 
 @item W e
-@kindex W e @r{(Group)}
+@kindex W e (Group)
 @findex gnus-score-edit-all-score
 Edit the apply-to-all-groups all.SCORE file.  You will be popped into
 a @code{gnus-score-mode} buffer (@pxref{Score File Editing}).
 
 @item W f
-@kindex W f @r{(Group)}
+@kindex W f (Group)
 @findex gnus-score-flush-cache
 Gnus maintains a cache of score alists to avoid having to reload them
 all the time.  This command will flush the cache
@@ -20186,20 +20199,20 @@ additional commands:
 @table @kbd
 
 @item C-c C-c
-@kindex C-c C-c @r{(Score)}
+@kindex C-c C-c (Score)
 @findex gnus-score-edit-exit
 Save the changes you have made and return to the summary buffer
 (@code{gnus-score-edit-exit}).
 
 @item C-c C-d
-@kindex C-c C-d @r{(Score)}
+@kindex C-c C-d (Score)
 @findex gnus-score-edit-insert-date
 Insert the current date in numerical format
 (@code{gnus-score-edit-insert-date}).  This is really the day number, if
 you were wondering.
 
 @item C-c C-p
-@kindex C-c C-p @r{(Score)}
+@kindex C-c C-p (Score)
 @findex gnus-score-pretty-print
 The adaptive score files are saved in an unformatted fashion.  If you
 intend to read one of these files, you want to @dfn{pretty print} it
@@ -20565,7 +20578,7 @@ Restart Gnus and rebuild your @code{nnml} overview files with the
 time if you have much mail.
 
 Now you can score on @samp{To} and @samp{Cc} as ``extra headers'' like
-so: @kbd{I e s p To @key{RET} <your name> @key{RET}}.
+so: @kbd{I e s p To RET <your name> RET}.
 
 See?  Simple.
 
@@ -20752,12 +20765,12 @@ Two summary functions for editing a @sc{gnus} kill file:
 @table @kbd
 
 @item M-k
-@kindex M-k @r{(Summary)}
+@kindex M-k (Summary)
 @findex gnus-summary-edit-local-kill
 Edit this group's kill file (@code{gnus-summary-edit-local-kill}).
 
 @item M-K
-@kindex M-K @r{(Summary)}
+@kindex M-K (Summary)
 @findex gnus-summary-edit-global-kill
 Edit the general kill file (@code{gnus-summary-edit-global-kill}).
 @end table
@@ -20767,12 +20780,12 @@ Two group mode functions for editing the kill files:
 @table @kbd
 
 @item M-k
-@kindex M-k @r{(Group)}
+@kindex M-k (Group)
 @findex gnus-group-edit-local-kill
 Edit this group's kill file (@code{gnus-group-edit-local-kill}).
 
 @item M-K
-@kindex M-K @r{(Group)}
+@kindex M-K (Group)
 @findex gnus-group-edit-global-kill
 Edit the general kill file (@code{gnus-group-edit-global-kill}).
 @end table
@@ -21712,7 +21725,7 @@ want.
 @item
 The name of the @strong{back end server} where mairix should store its
 searches.  This must be a full server name, like @code{nnml:mymail}.
-Just hit @kbd{@key{TAB}} to see the available servers.  Currently, servers
+Just hit @kbd{TAB} to see the available servers.  Currently, servers
 which are accessed through @code{nnmaildir}, @code{nnimap} and
 @code{nnml} are supported.  As explained above, for locally stored
 mails, this can be an existing server where you store your mails.
@@ -21757,34 +21770,34 @@ In group mode:
 @table @kbd
 
 @item G b c
-@kindex G b c @r{(Group)}
+@kindex G b c (Group)
 @findex nnmairix-create-server-and-default-group
 Creates @code{nnmairix} server and default search group for this server
 (@code{nnmairix-create-server-and-default-group}).  You should have done
 this by now (@pxref{Configuring nnmairix}).
 
 @item G b s
-@kindex G b s @r{(Group)}
+@kindex G b s (Group)
 @findex nnmairix-search
 Prompts for query which is then sent to the mairix binary.  Search
 results are put into the default search group which is automatically
 displayed (@code{nnmairix-search}).
 
 @item G b m
-@kindex G b m @r{(Group)}
+@kindex G b m (Group)
 @findex nnmairix-widget-search
 Allows you to create a mairix search or a permanent group more
 comfortably using graphical widgets, similar to a customization
 group.  Just try it to see how it works (@code{nnmairix-widget-search}).
 
 @item G b i
-@kindex G b i @r{(Group)}
+@kindex G b i (Group)
 @findex nnmairix-search-interactive
 Another command for creating a mairix query more comfortably, but uses
 only the minibuffer (@code{nnmairix-search-interactive}).
 
 @item G b g
-@kindex G b g @r{(Group)}
+@kindex G b g (Group)
 @findex nnmairix-create-search-group
 Creates a permanent group which is associated with a search query
 (@code{nnmairix-create-search-group}).  The @code{nnmairix} back end
@@ -21792,20 +21805,20 @@ automatically calls mairix when you update this group with @kbd{g} or
 @kbd{M-g}.
 
 @item G b q
-@kindex G b q @r{(Group)}
+@kindex G b q (Group)
 @findex nnmairix-group-change-query-this-group
 Changes the search query for the @code{nnmairix} group under cursor
 (@code{nnmairix-group-change-query-this-group}).
 
 @item G b t
-@kindex G b t @r{(Group)}
+@kindex G b t (Group)
 @findex nnmairix-group-toggle-threads-this-group
 Toggles the 'threads' parameter for the @code{nnmairix} group under cursor,
 i.e., if you want see the whole threads of the found messages
 (@code{nnmairix-group-toggle-threads-this-group}).
 
 @item G b u
-@kindex G b u @r{(Group)}
+@kindex G b u (Group)
 @findex nnmairix-update-database
 @vindex nnmairix-mairix-update-options
 Calls mairix binary for updating the database
@@ -21815,20 +21828,20 @@ and @code{-Q} for making this as fast as possible (see variable
 options).
 
 @item G b r
-@kindex G b r @r{(Group)}
+@kindex G b r (Group)
 @findex nnmairix-group-toggle-readmarks-this-group
 Keep articles in this @code{nnmairix} group always read or unread, or leave the
 marks unchanged (@code{nnmairix-group-toggle-readmarks-this-group}).
 
 @item G b d
-@kindex G b d @r{(Group)}
+@kindex G b d (Group)
 @findex nnmairix-group-delete-recreate-this-group
 Recreate @code{nnmairix} group on the ``real'' mail back end
 (@code{nnmairix-group-delete-recreate-this-group}).  You can do this if
 you always get wrong article counts with a @code{nnmairix} group.
 
 @item G b a
-@kindex G b a @r{(Group)}
+@kindex G b a (Group)
 @findex nnmairix-group-toggle-allowfast-this-group
 Toggles the @code{allow-fast} parameters for group under cursor
 (@code{nnmairix-group-toggle-allowfast-this-group}).  The default
@@ -21840,14 +21853,14 @@ lead to dangling symlinks if something changed between updating and
 entering the group which is not yet in the mairix database.
 
 @item G b p
-@kindex G b p @r{(Group)}
+@kindex G b p (Group)
 @findex nnmairix-group-toggle-propmarks-this-group
 Toggle marks propagation for this group
 (@code{nnmairix-group-toggle-propmarks-this-group}).  (@pxref{Propagating
 marks}).
 
 @item G b o
-@kindex G b o @r{(Group)}
+@kindex G b o (Group)
 @findex nnmairix-propagate-marks
 Manually propagate marks (@code{nnmairix-propagate-marks}); needed only when
 @code{nnmairix-propagate-marks-upon-close} is set to @code{nil}.
@@ -21859,21 +21872,21 @@ In summary mode:
 @table @kbd
 
 @item G G m
-@kindex G G m @r{(Summary)}
+@kindex G G m (Summary)
 @findex nnmairix-widget-search-from-this-article
 Allows you to create a mairix query or group based on the current
 message using graphical widgets (same as @code{nnmairix-widget-search})
 (@code{nnmairix-widget-search-from-this-article}).
 
 @item G G g
-@kindex G G g @r{(Summary)}
+@kindex G G g (Summary)
 @findex nnmairix-create-search-group-from-message
 Interactively creates a new search group with query based on the current
 message, but uses the minibuffer instead of graphical widgets
 (@code{nnmairix-create-search-group-from-message}).
 
 @item G G t
-@kindex G G t @r{(Summary)}
+@kindex G G t (Summary)
 @findex nnmairix-search-thread-this-article
 Searches thread for the current article
 (@code{nnmairix-search-thread-this-article}).  This is effectively a
@@ -21881,14 +21894,14 @@ shortcut for calling @code{nnmairix-search} with @samp{m:msgid} of the
 current article and enabled threads.
 
 @item G G f
-@kindex G G f @r{(Summary)}
+@kindex G G f (Summary)
 @findex nnmairix-search-from-this-article
 Searches all messages from sender of the current article
 (@code{nnmairix-search-from-this-article}).  This is a shortcut for
 calling @code{nnmairix-search} with @samp{f:From}.
 
 @item G G o
-@kindex G G o @r{(Summary)}
+@kindex G G o (Summary)
 @findex nnmairix-goto-original-article
 (Only in @code{nnmairix} groups!) Tries determine the group this article
 originally came from and displays the article in this group, so that,
@@ -21898,7 +21911,7 @@ function will use the registry if available, but can also parse the
 article file name as a fallback method.
 
 @item G G u
-@kindex G G u @r{(Summary)}
+@kindex G G u (Summary)
 @findex nnmairix-remove-tick-mark-original-article
 Remove possibly existing tick mark from original article
 (@code{nnmairix-remove-tick-mark-original-article}).  (@pxref{nnmairix
@@ -22321,7 +22334,7 @@ for instance.  But what if you want to save without making a backup
 file, and you want Emacs to flash lights and play a nice tune at the
 same time?  You can't, and you're probably perfectly happy that way.
 
-@kindex M-i @r{(Summary)}
+@kindex M-i (Summary)
 @findex gnus-symbolic-argument
 I'm not, so I've added a second prefix---the @dfn{symbolic prefix}.  The
 prefix key is @kbd{M-i} (@code{gnus-symbolic-argument}), and the next
@@ -22377,6 +22390,7 @@ Currently Gnus uses the following formatting variables:
 All these format variables can also be arbitrary elisp forms.  In that
 case, they will be @code{eval}ed to insert the required lines.
 
+@kindex M-x gnus-update-format
 @findex gnus-update-format
 Gnus includes a command to help you while creating your own format
 specs.  @kbd{M-x gnus-update-format} will @code{eval} the current form,
@@ -24278,10 +24292,10 @@ group:
 @itemx M-d
 @itemx M s x
 @itemx S x
-@kindex $ @r{(Summary)}
-@kindex M-d @r{(Summary)}
-@kindex S x @r{(Summary)}
-@kindex M s x @r{(Summary)}
+@kindex $ (Summary)
+@kindex M-d (Summary)
+@kindex S x (Summary)
+@kindex M s x (Summary)
 @findex gnus-summary-mark-as-spam
 @findex gnus-summary-mark-as-spam
 Mark current article as spam, showing it with the @samp{$} mark
@@ -24553,7 +24567,7 @@ determined by either the @code{ham-process-destination} group
 parameter or a match in the @code{gnus-ham-process-destinations}
 variable, which is a list of regular expressions matched with group
 names (it's easiest to customize this variable with @kbd{M-x
-customize-variable @key{@key{RET}} gnus-ham-process-destinations}).  Each
+customize-variable @key{RET} gnus-ham-process-destinations}).  Each
 group name list is a standard Lisp list, if you prefer to customize
 the variable manually.  If the @code{ham-process-destination}
 parameter is not set, ham articles are left in place.  If the
@@ -24589,7 +24603,7 @@ When you leave a @emph{ham} or @emph{unclassified} group, all
 the @code{spam-process-destination} group parameter or a match in the
 @code{gnus-spam-process-destinations} variable, which is a list of
 regular expressions matched with group names (it's easiest to
-customize this variable with @kbd{M-x customize-variable @key{@key{RET}}
+customize this variable with @kbd{M-x customize-variable @key{RET}
 gnus-spam-process-destinations}).  Each group name list is a standard
 Lisp list, if you prefer to customize the variable manually.  If the
 @code{spam-process-destination} parameter is not set, the spam
@@ -26221,7 +26235,7 @@ you to optionally upload your first CloudSynchronizationDataPack(TM).
 After setting up, you can use these shortcuts from the Group buffer:
 
 @table @kbd
-@item ~ @key{RET}
+@item ~ RET
 @item ~ d
 @findex gnus-cloud-download-all-data
 @cindex cloud, download
@@ -26656,6 +26670,7 @@ to stop doing it the old way.
 
 Gnus understands all @sc{gnus} startup files.
 
+@kindex M-x gnus-bug
 @findex gnus-bug
 @cindex reporting bugs
 @cindex bugs
@@ -27734,7 +27749,7 @@ control over simplification.
 limit.
 
 @item
-@kbd{M-@key{RET}} is a new Message command for breaking cited text.
+@kbd{M-RET} is a new Message command for breaking cited text.
 
 @item
 @samp{\\1}-expressions are now valid in @code{nnmail-split-methods}.
@@ -28289,10 +28304,10 @@ Easy inclusion of X-Faces headers.  @xref{X-Face}.
 @item
 Group Carbon Copy (GCC) quoting
 
-To support groups that contains @key{SPC} and other weird characters, groups
+To support groups that contains SPC and other weird characters, groups
 are quoted before they are placed in the Gcc: header.  This means
 variables such as @code{gnus-message-archive-group} should no longer
-contain quote characters to make groups containing @key{SPC} work.  Also, if
+contain quote characters to make groups containing SPC work.  Also, if
 you are using the string @samp{nnml:foo, nnml:bar} (indicating Gcc
 into two groups) you must change it to return the list
 @code{("nnml:foo" "nnml:bar")}, otherwise the Gcc: line will be quoted
@@ -28381,7 +28396,7 @@ Gnus supports @acronym{PGP} (RFC 1991/2440), @acronym{PGP/MIME} (RFC
 
 It needs an external @acronym{S/MIME} and OpenPGP implementation, but no
 additional Lisp libraries.  This add several menu items to the
-Attachments menu, and @kbd{C-c @key{RET}} key bindings, when composing
+Attachments menu, and @kbd{C-c RET} key bindings, when composing
 messages.  This also obsoletes @code{gnus-article-hide-pgp-hook}.
 
 @item
@@ -28477,7 +28492,7 @@ message, Message Manual}).
 @item
 The tool bars have been updated to use GNOME icons in Group, Summary and
 Message mode.  You can also customize the tool bars: @kbd{M-x
-customize-apropos @key{RET} -tool-bar$} should get you started.  This is a new
+customize-apropos RET -tool-bar$} should get you started.  This is a new
 feature in Gnus 5.10.10.  (Only for Emacs, not in XEmacs.)
 
 @item The tool bar icons are now (de)activated correctly
@@ -28708,7 +28723,7 @@ commonly fetched via the protocol @acronym{NNTP}, whereas mail
 messages could be read from a file on the local disk.  The internal
 architecture of Gnus thus comprises a ``front end'' and a number of
 ``back ends''.  Internally, when you enter a group (by hitting
-@key{@key{RET}}, say), you thereby invoke a function in the front end in
+@key{RET}, say), you thereby invoke a function in the front end in
 Gnus.  The front end then ``talks'' to a back end and says things like
 ``Give me the list of articles in the foo group'' or ``Show me article
 number 4711''.
@@ -29110,12 +29125,12 @@ If all else fails, report the problem as a bug.
 @cindex bugs
 @cindex reporting bugs
 
+@kindex M-x gnus-bug
 @findex gnus-bug
-If you find a bug in Gnus, you can report it with the @kbd{M-x
-gnus-bug} command.  @kbd{M-x set-variable @key{RET} debug-on-error
-@key{RET} t @key{RET}}, and send me the backtrace.  I will fix bugs,
-but I can only fix them if you send me a precise description as to how
-to reproduce the bug.
+If you find a bug in Gnus, you can report it with the @kbd{M-x gnus-bug}
+command.  @kbd{M-x set-variable RET debug-on-error RET t RET}, and send
+me the backtrace.  I will fix bugs, but I can only fix them if you send
+me a precise description as to how to reproduce the bug.
 
 You really can never be too detailed in a bug report.  Always use the
 @kbd{M-x gnus-bug} command when you make bug reports, even if it creates
@@ -29148,9 +29163,9 @@ Lisp Reference Manual}).  To get you started with edebug, consider if
 you discover some weird behavior when pressing @kbd{c}, the first
 step is to do @kbd{C-h k c} and click on the hyperlink (Emacs only) in
 the documentation buffer that leads you to the function definition,
-then press @kbd{M-x edebug-defun @key{RET}} with point inside that function,
+then press @kbd{M-x edebug-defun RET} with point inside that function,
 return to Gnus and press @kbd{c} to invoke the code.  You will be
-placed in the lisp buffer and can single step using @kbd{@key{SPC}} and
+placed in the lisp buffer and can single step using @kbd{SPC} and
 evaluate expressions using @kbd{M-:} or inspect variables using
 @kbd{C-h v}, abort execution with @kbd{q}, and resume execution with
 @kbd{c} or @kbd{g}.
@@ -29168,8 +29183,8 @@ A fancier approach is to use the elisp profiler, ELP@.  The profiler is
 (or should be) fully documented elsewhere, but to get you started
 there are a few steps that need to be followed.  First, instrument the
 part of Gnus you are interested in for profiling, e.g., @kbd{M-x
-elp-instrument-package @key{RET} gnus} or @kbd{M-x elp-instrument-package
-@key{RET} message}.  Then perform the operation that is slow and press
+elp-instrument-package RET gnus} or @kbd{M-x elp-instrument-package
+RET message}.  Then perform the operation that is slow and press
 @kbd{M-x elp-results}.  You will then see which operations that takes
 time, and can debug them further.  If the entire operation takes much
 longer than the time spent in the slowest function in the profiler
diff --git a/doc/misc/htmlfontify.texi b/doc/misc/htmlfontify.texi
index c4cf7dac0a..9f1d1b4ee3 100644
--- a/doc/misc/htmlfontify.texi
+++ b/doc/misc/htmlfontify.texi
@@ -1116,7 +1116,7 @@ Some of the (informal) data structures used in Htmlfontify are detailed here:
 @table @code
 
 @item hfy-style-assoc
-@cindex @code{hfy-style-assoc}
+@cindex hfy-style-assoc
 @anchor{hfy-style-assoc}
 
 An assoc representing/describing an Emacs face.  Properties may be repeated,
@@ -1148,7 +1148,7 @@ Some examples:
 @end lisp
 
 @item hfy-sheet-assoc
-@cindex @code{hfy-sheet-assoc}
+@cindex hfy-sheet-assoc
 @anchor{hfy-sheet-assoc}
 
 An assoc with elements of the form @samp{(face-name style-name . style-string)}.
@@ -1160,7 +1160,7 @@ The actual stylesheet for each page is derived from one of these.
 @end lisp
 
 @item hfy-facemap-assoc
-@cindex @code{hfy-facemap-assoc}
+@cindex hfy-facemap-assoc
 @anchor{hfy-facemap-assoc}
 
 An assoc of @code{(point . @var{face-symbol})} or
@@ -1379,9 +1379,9 @@ For example, I customize this to:
 ((t :background "black" :foreground "white" :family "misc-fixed"))
 @end lisp
 
-@item hfy-init-kludge-hook
-@vindex hfy-init-kludge-hook
-@anchor{hfy-init-kludge-hook}
+@item hfy-init-kludge-hooks
+@vindex hfy-init-kludge-hooks
+@anchor{hfy-init-kludge-hooks}
 
 List of functions to call when starting htmlfontify-buffer to do any
 kludging necessary to get highlighting modes to behave as you want, even
diff --git a/doc/misc/idlwave.texi b/doc/misc/idlwave.texi
index 204a449925..c37ca16b0c 100644
--- a/doc/misc/idlwave.texi
+++ b/doc/misc/idlwave.texi
@@ -172,7 +172,7 @@ Catalogs
 @cindex CORBA (Common Object Request Broker Architecture)
 @cindex Interface Definition Language
 @cindex Interactive Data Language
-@cindex @file{cc-mode.el}
+@cindex cc-mode.el
 @cindex @file{idl.el}
 @cindex @file{idl-shell.el}
 @cindex Feature overview
@@ -935,7 +935,7 @@ IDL code.
 @cindex String splitting
 @cindex Splitting, of lines
 
-@kindex M-RET
+@kindex M-@key{RET}
 In IDL, a newline character terminates a statement unless preceded by a
 @samp{$}.  If you would like to start a continuation line, use
 @kbd{M-@key{RET}}, which calls the command @code{idlwave-split-line}.
@@ -1523,7 +1523,7 @@ The case-insensitive heading word in doclib headers to locate the
 @cindex Function name completion
 @cindex Procedure name completion
 
-@kindex M-TAB
+@kindex M-@key{TAB}
 @kindex C-c C-i
 IDLWAVE offers completion for class names, routine names, keywords,
 system variables, system variable tags, class structure tags, regular
@@ -4064,7 +4064,7 @@ sure you check the following things:
 @itemize @bullet
 @item When you download the IDLWAVE distribution, make sure you save the
 file under the names @file{idlwave.tar.gz}.
-@item M-@key{TAB} switches among running programs---use @key{ESC}-@key{TAB}
+@item M-TAB switches among running programs---use Esc-TAB
 instead.
 @item Other issues as yet unnamed...
 @end itemize
diff --git a/doc/misc/ido.texi b/doc/misc/ido.texi
index 4ff978ee79..6666c53410 100644
--- a/doc/misc/ido.texi
+++ b/doc/misc/ido.texi
@@ -456,14 +456,14 @@ You can toggle display of the hidden buffers and files with @kbd{C-a}
 You can customize the @code{ido} group to change Ido functionality:
 
 @example
-M-x customize-group @key{RET} ido @key{RET}
+M-x customize-group RET ido RET
 @end example
 
 @noindent
 or customize a certain variable:
 
 @example
-M-x customize-variable @key{RET} ido-xxxxx @key{RET}
+M-x customize-variable RET ido-xxxxx
 @end example
 
 To modify the keybindings, use the @code{ido-setup-hook}.  For example:
diff --git a/doc/misc/mairix-el.texi b/doc/misc/mairix-el.texi
index 8d620c720e..906448c102 100644
--- a/doc/misc/mairix-el.texi
+++ b/doc/misc/mairix-el.texi
@@ -169,13 +169,13 @@ the updates incrementally and hence is very fast.
 
 First, put @code{mairix.el} in your Emacs search path and put
 @code{(require 'mairix)} into your @file{.emacs} file.  Then, use
-@kbd{M-x customize-group @key{RET} mairix @key{RET}} to set your
-preferences for mairix.el.  The most important items are @emph{Mairix
-File Path}, @emph{Mairix Search File} and @emph{Mairix Mail Program}.
-The latter specifies which mail program should be used to display the
-mairix search results.  Currently, RMail, Gnus with mbox files, and VM
-are supported.  If you use Gnus with maildir or mh, use the native
-Gnus back end nnmairix instead.
+@kbd{M-x customize-group mairix RET} to set your preferences for
+mairix.el.  The most important items are @emph{Mairix File Path},
+@emph{Mairix Search File} and @emph{Mairix Mail Program}.  The latter
+specifies which mail program should be used to display the mairix search
+results.  Currently, RMail, Gnus with mbox files, and VM are supported.
+If you use Gnus with maildir or mh, use the native Gnus back end
+nnmairix instead.
 
 If you use another Emacs mail program which is not yet supported by
 mairix.el, it is pretty easy to integrate it.  @xref{Extending},
@@ -213,6 +213,7 @@ Here's a description of the available interactive functions:
 @table @code
 
 @item mairix-search
+@kindex M-x mairix-search
 @findex mairix-search
 @vindex mairix-search-file
 @vindex mairix-file-path
@@ -228,6 +229,7 @@ is specified by the variable @code{mairix-command}, together with the options
 for making searching faster.
 
 @item mairix-widget-search
+@kindex M-x mairix-widget-search
 @findex mairix-widget-search
 @vindex mairix-widget-fields-list
 Creates a mairix query using graphical widgets.  Very handy if you're
@@ -239,24 +241,28 @@ might want to include some other fields.  This can be easily done by
 modifying @code{mairix-widget-fields-list}.
 
 @item mairix-widget-search-based-on-article
+@kindex M-x mairix-widget-search-based-on-article
 @findex mairix-widget-search-based-on-article
 Create a mairix query using graphical widgets, but based on the
 currently displayed article, i.e., the available fields will be filled
 with the current header values.
 
 @item mairix-search-from-this-article
+@kindex M-x mairix-search-from-this-article
 @findex mairix-search-from-this-article
 Search messages from sender of the current article.  This is effectively
 a shortcut for calling @code{mairix-search} with @code{f:current_from}.
 If used with a prefix, include whole threads of the found messages.
 
 @item mairix-search-thread-this-article
+@kindex M-x mairix-search-thread-this-article
 @findex mairix-search-thread-this-article
 Search thread for the current article.  This is effectively a shortcut
 for calling @code{mairix-search} with @code{m:msgid} of the current article and
 enabled threads.
 
 @item mairix-save-search
+@kindex M-x mairix-save-search
 @findex mairix-save-search
 Save the last search for future use.  You will have to specify a name
 for the search and will then be asked if you want to save your saved
@@ -266,11 +272,13 @@ your @file{.emacs}.  You can also do this later by using
 @code{mairix-edit-saved-searches}.
 
 @item mairix-use-saved-search
+@kindex M-x mairix-use-saved-search
 @findex mairix-use-saved-search
 Call mairix with a previously saved search.  You will be asked for the
 name of the saved search (use @kbd{TAB} for completion).
 
 @item mairix-edit-saved-searches
+@kindex M-x mairix-edit-saved-searches
 @findex mairix-edit-saved-searches
 Edit your current mairix searches.  This is a simple major mode for
 editing the contents of the variable @code{mairix-saved-searches}.  You
@@ -282,12 +290,14 @@ to open different searches at the same time, or if you want to regularly
 access certain searches without the need to call mairix.
 
 @item mairix-edit-saved-searches-customize
+@kindex M-x mairix-edit-saved-searches-customize
 @findex mairix-edit-saved-searches-customize
 Edit the variable @code{mairix-saved-searches} in a normal customization
 buffer.  This function exists more or less for historic reasons, but
 maybe you like it.
 
 @item mairix-update-database
+@kindex M-x mairix-update-database
 @findex mairix-update-database
 @vindex mairix-update-options
 @vindex mairix-synchronous-update
diff --git a/doc/misc/message.texi b/doc/misc/message.texi
index 0a2a6ce49d..1ef67fe0cb 100644
--- a/doc/misc/message.texi
+++ b/doc/misc/message.texi
@@ -104,7 +104,7 @@ sending it.
 @end menu
 
 You can customize the Message Mode tool bar, see @kbd{M-x
-customize-apropos @key{RET} message-tool-bar}.  This feature is only available
+customize-apropos RET message-tool-bar}.  This feature is only available
 in Emacs.
 
 @node New Mail Message
@@ -707,12 +707,14 @@ This means that if the recipient supports RFC 2298 she might send you a
 notification that she received the message.
 
 @item M-x message-insert-importance-high
+@kindex M-x message-insert-importance-high
 @findex message-insert-importance-high
 @cindex Importance
 Insert an @samp{Importance} header with a value of @samp{high},
 deleting headers if necessary.
 
 @item M-x message-insert-importance-low
+@kindex M-x message-insert-importance-low
 @findex message-insert-importance-low
 @cindex Importance
 Insert an @samp{Importance} header with a value of @samp{low}, deleting
@@ -919,7 +921,7 @@ is fully available) @acronym{IDNA} encoding happens automatically.
 
 @findex message-idna-to-ascii-rhs
 If you want to experiment with the @acronym{IDNA} encoding, you can
-invoke @kbd{M-x message-idna-to-ascii-rhs @key{RET}} in the message buffer
+invoke @kbd{M-x message-idna-to-ascii-rhs RET} in the message buffer
 to have the non-@acronym{ASCII} domain names encoded while you edit
 the message.
 
@@ -1082,7 +1084,7 @@ Since signing and especially encryption often is used when sensitive
 information is sent, you may want to have some way to ensure that your
 mail is actually signed or encrypted.  After invoking the above
 sign/encrypt commands, it is possible to preview the raw article by
-using @kbd{C-u C-c @key{RET} P} (@code{mml-preview}).  Then you can
+using @kbd{C-u C-c RET P} (@code{mml-preview}).  Then you can
 verify that your long rant about what your ex-significant other or
 whomever actually did with that funny looking person at that strange
 party the other night, actually will be sent encrypted.
@@ -1174,7 +1176,7 @@ without some kind of configuration.  Especially, you need to tell it
 where your private key and your certificate is stored.  @acronym{MML}
 uses an Emacs interface to OpenSSL, aptly named @code{smime.el}, and it
 contain a @code{custom} group used for this configuration.  So, try
-@kbd{M-x customize-group @key{RET} smime @key{RET}} and look around.
+@kbd{M-x customize-group RET smime RET} and look around.
 
 Currently there is no support for talking to a CA (or RA) to create
 your own certificate.  None is planned either.  You need to do this
@@ -1220,7 +1222,7 @@ according to two different standards, namely @acronym{PGP} or
 @node Passphrase caching
 @subsection Passphrase caching
 
-@cindex @command{gpg-agent}
+@cindex gpg-agent
 Message with EasyPG internally calls GnuPG (the @command{gpg} or
 @command{gpgsm} command) to perform
 data encryption, and in certain cases (decrypting or signing for
@@ -1377,7 +1379,7 @@ end of the message (@code{message-kill-to-signature}).
 Delete all text in the body of the message that is outside the region
 (@code{message-delete-not-region}).
 
-@item M-@key{RET}
+@item M-RET
 @kindex M-RET
 @findex message-newline-and-reformat
 Insert four newlines, and then reformat if inside quoted text.
@@ -1388,7 +1390,7 @@ Here's an example:
 > This is some quoted text.  And here's more quoted text.
 @end example
 
-If point is before @samp{And} and you press @kbd{M-@key{RET}}, you'll get:
+If point is before @samp{And} and you press @kbd{M-RET}, you'll get:
 
 @example
 > This is some quoted text.
@@ -1406,12 +1408,12 @@ If point is before @samp{And} and you press @kbd{M-@key{RET}}, you'll get:
 Rename the buffer (@code{message-rename-buffer}).  If given a prefix,
 prompt for a new buffer name.
 
-@item @key{TAB}
+@item TAB
 @kindex TAB
 @findex message-tab
 @vindex message-tab-body-function
 If @code{message-tab-body-function} is non-@code{nil}, execute the
-function it specifies.  Otherwise use the function bound to @key{TAB} in
+function it specifies.  Otherwise use the function bound to @kbd{TAB} in
 @code{text-mode-map} or @code{global-map}.
 
 @end table
diff --git a/doc/misc/mh-e.texi b/doc/misc/mh-e.texi
index b44e503996..5f0cc32cc4 100644
--- a/doc/misc/mh-e.texi
+++ b/doc/misc/mh-e.texi
@@ -442,7 +442,7 @@ either @code{customize-option} or @code{add-hook}.
 @cindex point
 @cindex region
 @kindex C-@@
-@kindex C-SPC
+@kindex C-@key{SPC}
 
 There are several other terms that are used in Emacs that you should
 know. The @dfn{point} is where the cursor currently is. You can save
@@ -692,6 +692,7 @@ get the big picture, and then you can read the manual as you wish.
 @cindex modes, MH-Letter
 @cindex sending mail
 @findex mh-smail
+@kindex M-x mh-smail
 
 Let's start our tour by sending ourselves a message which we can later
 read and process. Enter @kbd{M-x mh-smail} to invoke the MH-E program
@@ -761,6 +762,7 @@ message. Type @kbd{C-c C-c} now. That's all there is to it!
 @cindex modes, MH-Folder
 @cindex reading mail
 @findex mh-rmail
+@kindex M-x mh-rmail
 
 To read the mail you've just sent yourself, enter @kbd{M-x mh-rmail}.
 This incorporates the new mail and puts the output from
@@ -775,6 +777,7 @@ major mode is MH-Folder.
 
 @findex mh-rmail
 @kindex F r
+@kindex M-x mh-rmail
 
 @sp 1
 @center @strong{NOTE}
@@ -787,7 +790,7 @@ use @kbd{F r} to pull all your messages into MH-E.
 @end quotation
 @sp 1
 
-@kindex RET
+@kindex @key{RET}
 @kindex n
 @kindex p
 
@@ -817,8 +820,8 @@ This is a test message to get the wheels churning...
 @end cartouche
 @i{After incorporating new messages}
 
-@kindex DEL
-@kindex SPC
+@kindex @key{DEL}
+@kindex @key{SPC}
 
 If you typed a long message, you can view subsequent pages with
 @key{SPC} and previous pages with @key{DEL}.
@@ -827,7 +830,7 @@ If you typed a long message, you can view subsequent pages with
 @section Processing Mail
 
 @cindex processing mail
-@kindex RET
+@kindex @key{RET}
 @kindex r
 
 The first thing we want to do is reply to the message that we sent
@@ -880,7 +883,7 @@ Type C-c C-c to send message, C-c ? for help
 @kindex C-f
 @kindex C-n
 @kindex C-p
-@kindex BS
+@kindex @key{BS}
 
 By default, MH will not add you to the address list of your replies,
 so if you find that the @samp{To:} header field is missing, don't
@@ -895,7 +898,7 @@ editing your message, send it with @kbd{C-c C-c} as before.
 @cindex @command{refile}
 @cindex MH commands, @command{refile}
 @cindex folders
-@kindex SPC
+@kindex @key{SPC}
 @kindex o
 
 You'll often want to save messages that were sent to you in an
@@ -915,7 +918,7 @@ in a moment.
 @cindex modes, MH-Folder
 @kindex d
 @kindex i
-@kindex RET
+@kindex @key{RET}
 @kindex n
 @kindex p
 @kindex x
@@ -932,6 +935,7 @@ command.
 
 @findex mh-smail
 @kindex m
+@kindex M-x mh-smail
 
 If you want to send another message you can use @kbd{m} instead of
 @kbd{M-x mh-smail}. So go ahead, send some mail to your friends!
@@ -966,6 +970,7 @@ perform any refiles and deletes that you did there.
 @findex mh-rmail
 @kindex C-x b
 @kindex C-x k
+@kindex M-x mh-rmail
 @kindex q
 
 If you don't want to leave Emacs, you can type @kbd{q} to bury (hide)
@@ -1223,7 +1228,7 @@ Many commands that operate on individual messages, such as
 @code{mh-forward} or @code{mh-refile-msg} take a @code{RANGE}
 argument. This argument can be used in several ways.
 
-@kindex C-u@r{, with ranges}
+@kindex C-u, with ranges
 
 If you provide the prefix argument @kbd{C-u} to these commands, then
 you will be prompted for the message range. This can be any valid MH
@@ -1547,6 +1552,7 @@ the message numbers from outside of MH-E.
 @findex mh-rmail
 @kindex F r
 @kindex F v
+@kindex M-x mh-rmail
 
 The MH-E entry point for reading mail is @kbd{M-x mh-rmail}. This
 command incorporates your mail and creates a buffer called
@@ -1586,38 +1592,38 @@ Display cheat sheet for the MH-E commands (@code{mh-help}).
 @c -------------------------
 @cindex @samp{Message > Show Message} menu item
 @cindex menu item, @samp{Message > Show Message}
-@kindex RET
+@kindex @key{RET}
 @findex mh-show
 @item @key{RET}
 Display message (@code{mh-show}).
 @c -------------------------
 @cindex @samp{Message > Show Message with Header} menu item
 @cindex menu item, @samp{Message > Show Message with Header}
-@kindex , @r{(comma)}
+@kindex , (comma)
 @findex mh-header-display
 @item , (comma)
 Display message with all header fields (@code{mh-header-display}).
 @c -------------------------
 @cindex @samp{Message > Show Message with Preferred Alternative} menu item
 @cindex menu item, @samp{Message > Show Message with Preferred Alternative}
-@kindex : @r{(colon)}
+@kindex : (colon)
 @findex mh-show-preferred-alternative
 @item : (colon)
 Display message with the default preferred alternative
 (@code{mh-show-preferred-alternative}).
 @c -------------------------
-@kindex ; @r{(semicolon)}
+@kindex ; (semicolon)
 @findex mh-toggle-mh-decode-mime-flag
 @item ; (semicolon)
 Toggle the value of @code{mh-decode-mime-flag}
 (@code{mh-toggle-mh-decode-mime-flag}).
 @c -------------------------
-@kindex SPC
+@kindex @key{SPC}
 @findex mh-page-msg
 @item @key{SPC}
 Display next page in message (@code{mh-page-msg}).
 @c -------------------------
-@kindex BS
+@kindex @key{BS}
 @findex mh-previous-page
 @item @key{BS}
 Display previous page in message (@code{mh-previous-page}).
@@ -1655,12 +1661,12 @@ Delete range (@code{mh-delete-msg}).
 Display cheat sheet for the commands of the current prefix in
 minibuffer (@code{mh-prefix-help}).
 @c -------------------------
-@kindex D SPC
+@kindex D @key{SPC}
 @findex mh-page-digest
 @item D @key{SPC}
 Display next message in digest (@code{mh-page-digest}).
 @c -------------------------
-@kindex D BS
+@kindex D @key{BS}
 @findex mh-page-digest-backwards
 @item D @key{BS}
 Display previous message in digest (@code{mh-page-digest-backwards}).
@@ -1691,12 +1697,12 @@ Delete messages with same subject or thread
 Display cheat sheet for the commands of the current prefix in
 minibuffer (@code{mh-prefix-help}).
 @c -------------------------
-@kindex K TAB
+@kindex K @key{TAB}
 @findex mh-next-button
 @item K @key{TAB}
 Go to the next button (@code{mh-next-button}).
 @c -------------------------
-@kindex K S-TAB
+@kindex K S-@key{TAB}
 @findex mh-prev-button
 @item K S-@key{TAB}
 Go to the previous button (@code{mh-prev-button}).
@@ -1838,7 +1844,7 @@ Move point to mouse event and show message (@code{mh-show-mouse}).
 Within the MH-Show buffer, the following command is defined.
 
 @table @kbd
-@kindex RET
+@kindex @key{RET}
 @kindex mouse-1
 @kindex mouse-2
 @findex mh-press-button
@@ -2011,11 +2017,11 @@ detail in the following sections.
 @findex mh-previous-page
 @findex mh-show
 @findex mh-show-mouse
-@kindex , @r{(comma)}
-@kindex . @r{(period)}
-@kindex BS
-@kindex RET
-@kindex SPC
+@kindex , (comma)
+@kindex . (period)
+@kindex @key{BS}
+@kindex @key{RET}
+@kindex @key{SPC}
 @kindex mouse-2
 
 The command @key{RET} (@code{mh-show}) displays the message that the
@@ -2095,9 +2101,9 @@ Emacs 21 and XEmacs. For more information, see
 @uref{http://quimby.gnus.org/circus/face/}.}.
 
 @cindex @command{uncompface}
-@cindex Emacs, packages, @samp{x-face}
+@cindex Emacs, packages, x-face
 @cindex Unix commands, @command{uncompface}
-@cindex @samp{x-face} package
+@cindex x-face package
 @vindex mh-show-xface
 
 Next is the traditional @samp{X-Face:} header field@footnote{The
@@ -2194,7 +2200,7 @@ highlighting of citations entirely, choose @samp{None}.
 @cindex highlighting email addresses
 @cindex links, following
 @findex goto-address-at-point
-@kindex C-c RET
+@kindex C-c @key{RET}
 @kindex mouse-2
 @vindex goto-address-highlight-p
 
@@ -2300,10 +2306,10 @@ System: type @kbd{M-! xterm -e mhshow @var{message-number}}. You can
 leave out the @samp{xterm -e} if you use @command{mhlist} or
 @command{mhstore}.}.
 
-@cindex Emacs, packages, @samp{mm-decode}
-@cindex @samp{mm-decode} package
+@cindex Emacs, packages, mm-decode
+@cindex mm-decode package
 @findex mh-toggle-mh-decode-mime-flag
-@kindex ; @r{(semicolon)}
+@kindex ; (semicolon)
 @vindex mh-decode-mime-flag
 
 MH-E can handle attachments as well if the Gnus @samp{mm-decode}
@@ -2328,9 +2334,9 @@ Attachments in MH-E are indicated by @dfn{buttons} like this:
 @findex mh-next-button
 @findex mh-press-button
 @findex mh-prev-button
-@kindex RET
-@kindex K TAB
-@kindex K S-TAB
+@kindex @key{RET}
+@kindex K @key{TAB}
+@kindex K S-@key{TAB}
 @kindex mouse-1
 @kindex mouse-2
 
@@ -2484,7 +2490,7 @@ the option @code{mm-discouraged-alternatives}, and add
 @samp{text/html}. The next best alternative, if any, will be shown.
 
 @findex mh-show-preferred-alternative
-@kindex : @r{(colon)}
+@kindex : (colon)
 
 Occasionally, though, you might want to see the preferred alternative.
 The command @kbd{:} (@code{mh-show-preferred-alternative}) displays
@@ -2682,10 +2688,10 @@ buffer, including HTML buffers.
 @cindex digests
 @findex mh-page-digest
 @findex mh-page-digest-backwards
-@kindex D BS
-@kindex D SPC
-@kindex BS
-@kindex SPC
+@kindex D @key{BS}
+@kindex D @key{SPC}
+@kindex @key{BS}
+@kindex @key{SPC}
 
 A digest is a message that contains other messages. Special MH-E
 commands let you read digests conveniently. You can use @key{SPC} and
@@ -2898,8 +2904,8 @@ Another related function is the command @kbd{P F}
 faces and not. When faces are enabled, the printed message will look
 very similar to the message in the MH-Show buffer.
 
-@cindex @samp{ps-print} package
-@cindex Emacs, packages, @samp{ps-print}
+@cindex ps-print package
+@cindex Emacs, packages, ps-print
 
 MH-E uses the @samp{ps-print} package to do the printing, so you can
 customize the printing further by going to the @samp{ps-print}
@@ -2989,7 +2995,7 @@ like to change the initial default directory, customize the option
 directory for storing the content of these messages.
 
 @findex mh-store-buffer
-@kindex RET
+@kindex @key{RET}
 @kindex X s
 
 By the way, @kbd{X s} calls the Emacs Lisp function
@@ -3039,7 +3045,7 @@ message with @kbd{M-<} (@code{mh-first-msg}) and @kbd{M->}
 @findex previous-line
 @kindex C-n
 @kindex C-p
-@kindex RET
+@kindex @key{RET}
 
 You can also use the Emacs commands @kbd{C-p} (@code{previous-line})
 and @kbd{C-n} (@code{next-line}) to move up and down the scan lines in
@@ -3740,7 +3746,7 @@ The command @kbd{F p} runs @code{mh-pack-folder-hook} after
 renumbering the messages. A variable that is useful with this hook
 is @code{mh-current-folder}.
 
-@kindex TAB
+@kindex @key{TAB}
 @vindex mh-recursive-folders-flag
 
 By default, operations on folders work only one level at a time. Set
@@ -3844,15 +3850,16 @@ buffers that you would rather remove, you can use both
 
 You can use dired to manipulate the folders themselves. For example, I
 renamed my @samp{+out} folder to the more common @samp{+outbox} by
-running dired on my mail directory (@kbd{M-x dired @key{RET} ~/Mail
-@key{RET}}), moving my cursor to @samp{out} and using the command
-@kbd{R} (@code{dired-do-rename}).
+running dired on my mail directory (@kbd{M-x dired RET ~/Mail RET}),
+moving my cursor to @samp{out} and using the command @kbd{R}
+(@code{dired-do-rename}).
 
 @node Sending Mail, Editing Drafts, Folders, Top
 @chapter Sending Mail
 
 @cindex sending mail
 @findex mh-smail
+@kindex M-x mh-smail
 
 You can send a mail message in several ways. You can call @kbd{M-x
 mh-smail} directly, or from the command line like this:
@@ -4020,6 +4027,8 @@ more detail in the following sections.
 @cindex sending mail
 @findex mh-smail
 @findex mh-smail-other-window
+@kindex M-x mh-smail
+@kindex M-x mh-smail-other-window
 
 Outside of an MH-Folder buffer, you must call either @kbd{M-x
 mh-smail} or @kbd{M-x mh-smail-other-window} to compose a new message.
@@ -4381,28 +4390,28 @@ commands in addition to the normal Emacs editing commands to help you
 edit your draft. These can also be found in the @samp{Letter} menu.
 
 @table @kbd
-@kindex SPC
+@kindex @key{SPC}
 @findex mh-letter-complete-or-space
 @item @key{SPC}
 Perform completion or insert space (@code{mh-letter-complete-or-space}).
 @c -------------------------
-@kindex M-TAB
+@kindex M-@key{TAB}
 @findex mh-letter-complete
 @item M-@key{TAB}
 Perform completion on header field or word preceding point
 (@code{mh-letter-complete}).
 @c -------------------------
-@kindex , @r{(comma)}
+@kindex , (comma)
 @findex mh-letter-confirm-address
 @item , (comma)
 Flash alias expansion (@code{mh-letter-confirm-address}).
 @c -------------------------
-@kindex TAB
+@kindex @key{TAB}
 @findex mh-letter-next-header-field-or-indent
 @item @key{TAB}
 Cycle to next field (@code{mh-letter-next-header-field-or-indent}).
 @c -------------------------
-@kindex S-TAB
+@kindex S-@key{TAB}
 @findex mh-letter-previous-header-field
 @item S-@key{TAB}
 Cycle to the previous header field
@@ -4807,8 +4816,8 @@ draft. @xref{Folder Selection}.
 @findex indent-relative
 @findex mh-letter-next-header-field-or-indent
 @findex mh-letter-previous-header-field
-@kindex TAB
-@kindex S-TAB
+@kindex @key{TAB}
+@kindex S-@key{TAB}
 @vindex mh-compose-skipped-header-fields
 @vindex mh-letter-header-field
 
@@ -4833,9 +4842,9 @@ take point to the last field from anywhere in the body.
 @findex mh-letter-complete
 @findex mh-letter-complete-or-space
 @findex mh-letter-confirm-address
-@kindex , @r{(comma)}
-@kindex SPC
-@kindex M-TAB
+@kindex , (comma)
+@kindex @key{SPC}
+@kindex M-@key{TAB}
 @vindex mh-alias-flash-on-comma
 @vindex mh-compose-space-does-completion-flag
 @vindex mh-letter-complete-function
@@ -4988,8 +4997,8 @@ You can also turn on the @code{mh-delete-yanked-msg-window-flag}
 option to delete the window containing the original message after
 yanking it to make more room on your screen for your reply.
 
-@cindex Emacs, packages, @samp{supercite}
-@cindex @samp{supercite} package
+@cindex Emacs, packages, supercite
+@cindex supercite package
 @kindex r
 @vindex mail-citation-hook
 @vindex mh-yank-behavior
@@ -5052,8 +5061,8 @@ and it should leave point and mark around the modified citation text
 for the next hook function. The standard prefix
 @code{mh-ins-buf-prefix} is not added if this hook is set.
 
-@cindex Emacs, packages, @samp{trivial-cite}
-@cindex @samp{trivial-cite} package
+@cindex Emacs, packages, trivial-cite
+@cindex trivial-cite package
 @vindex mh-yank-behavior
 
 For example, if you use the hook function
@@ -5490,7 +5499,7 @@ LyogWFBNICovCnN0YXRpYyBjaGFyICogc2V0aWF0aG9tZV94cG1bXSA9IHsKIjQ1IDQ1IDc2N
 @end cartouche
 @i{MH-E @sc{mime} draft ready to send}
 
-@cindex undo effects of @code{mh-mml-to-mime}
+@cindex undo effects of mh-mml-to-mime
 
 This action can be undone by running @kbd{C-_} (@code{undo}).
 
@@ -5498,7 +5507,7 @@ This action can be undone by running @kbd{C-_} (@code{undo}).
 @cindex @command{mhn}
 @cindex MH commands, @command{mhbuild}
 @cindex MH commands, @command{mhn}
-@cindex undo effects of @code{mh-mh-to-mime}
+@cindex undo effects of mh-mh-to-mime
 @findex mh-mh-to-mime
 @findex mh-mh-to-mime-undo
 @kindex C-c C-e
@@ -5714,12 +5723,12 @@ The following commands are available in MH-Letter mode with the
 exception of @code{mh-alias-reload} which can be called from anywhere.
 
 @table @kbd
-@kindex SPC
+@kindex @key{SPC}
 @findex mh-letter-complete-or-space
 @item @key{SPC}
 Perform completion or insert space (@code{mh-letter-complete-or-space}).
 @c -------------------------
-@kindex M-TAB
+@kindex M-@key{TAB}
 @findex mh-letter-complete
 @item M-@key{TAB}
 Perform completion on header field or word preceding point
@@ -5791,7 +5800,7 @@ Hook run by @code{mh-alias-reload} after loading aliases (default:
 You can use aliases when you are adding recipients to a message.
 
 @findex minibuffer-complete
-@kindex TAB
+@kindex @key{TAB}
 @vindex mh-alias-expand-aliases-flag
 @vindex mh-compose-prompt-flag
 
@@ -5805,8 +5814,8 @@ aliases to be expanded to their respective addresses in the draft.
 
 @findex mh-letter-complete
 @findex mh-letter-complete-or-space
-@kindex SPC
-@kindex M-TAB
+@kindex @key{SPC}
+@kindex M-@key{TAB}
 
 Otherwise, you can complete aliases in the header of the draft with
 @kbd{M-@key{TAB}} (@code{mh-letter-complete}) or @key{SPC}
@@ -5925,6 +5934,7 @@ executed to generate the password file. For example, use @samp{ypcat
 passwd} to obtain the NIS password file.
 
 @findex mh-alias-reload
+@kindex M-x mh-alias-reload
 @vindex mh-alias-reloaded-hook
 
 Since aliases are updated frequently, MH-E reloads aliases
@@ -5940,6 +5950,7 @@ listed in your @samp{Aliasfile:} profile component. MH-E provides
 other methods for maintaining your alias file(s).
 
 @findex mh-alias-add-alias
+@kindex M-x mh-alias-add-alias
 
 You can use the @kbd{M-x mh-alias-add-alias} command which will prompt
 you for the alias and address that you would like to add. If the alias
@@ -5974,8 +5985,8 @@ Using prefixes instead of postfixes helps you explore aliases during
 completion. If you forget the name of an old dive buddy, you can enter
 @samp{div} and then @key{SPC} to get a listing of all your dive buddies.
 
-@findex mh-alias-add-address-under-point
-@findex mh-alias-grab-from-field
+@kindex M-x mh-alias-add-address-under-point
+@kindex M-x mh-alias-grab-from-field
 
 An alias for the sender of the current message is added automatically
 by clicking on the @samp{Grab From alias} tool bar button or by running
@@ -6010,6 +6021,7 @@ more appropriate.
 
 @cindex regular expressions, @code{mh-alias-apropos}
 @findex mh-alias-apropos
+@kindex M-x mh-alias-apropos
 
 If you can't quite remember an alias, you can use @kbd{M-x
 mh-alias-apropos} to show all aliases or addresses that match a
@@ -6268,8 +6280,8 @@ containing the value for the field is given.
 @cindex folder navigation
 @cindex speedbar
 @findex mh-visit-folder
-@findex speedbar
 @kindex F v
+@kindex M-x speedbar
 @kindex mouse-2
 
 You can also use the speedbar
@@ -6611,12 +6623,12 @@ Another few commands are available in the MH-Folder buffer resulting
 from a search.
 
 @table @kbd
-@kindex TAB
+@kindex @key{TAB}
 @findex mh-index-next-folder
 @item @key{TAB}
 Jump to the next folder marker (@code{mh-index-next-folder}).
 @c -------------------------
-@kindex S-TAB
+@kindex S-@key{TAB}
 @findex mh-index-previous-folder
 @item S-@key{TAB}
 Jump to the previous folder marker (@code{mh-index-previous-folder}).
@@ -6761,8 +6773,8 @@ method with the pick method by running the command @kbd{C-c C-p}
 @cindex @samp{+mhe-index}
 @findex mh-index-next-folder
 @findex mh-index-previous-folder
-@kindex TAB
-@kindex S-TAB
+@kindex @key{TAB}
+@kindex S-@key{TAB}
 @vindex mh-search-folder
 
 The messages that are found are put in a temporary sub-folder of
@@ -7502,6 +7514,7 @@ Mail}).
 @cindex sequence, @samp{cur}
 @cindex sequence, @samp{tick}
 @findex mh-update-sequences
+@kindex M-x mh-update-sequences
 @kindex q
 @kindex x
 @vindex mh-tick-seq
@@ -7988,7 +8001,7 @@ system.
 @cindex MH-E version
 @cindex @file{*MH-E Info*}
 @cindex version
-@findex mh-version
+@kindex M-x mh-version
 
 One command worth noting is @kbd{M-x mh-version}. You can compare the
 version this command prints to the latest release (@pxref{Getting
@@ -8703,7 +8716,7 @@ I also point out some additional sources of information.
 
 @cindex bugs
 @cindex SourceForge
-@findex mh-version
+@kindex M-x mh-version
 
 Bug reports should be filed at
 @uref{https://sourceforge.net/p/mh-e/bugs/, SourceForge}. You need to
@@ -8779,7 +8792,7 @@ instead.
 @cindex news
 @cindex @samp{MH-E-NEWS}
 @cindex @samp{README}
-@findex mh-version
+@kindex M-x mh-version
 
 After you download and extract the MH-E tarball, read the
 @file{README} file and @file{MH-E-NEWS}. These correspond to the
diff --git a/doc/misc/newsticker.texi b/doc/misc/newsticker.texi
index ac29ced8fb..43d248bc7d 100644
--- a/doc/misc/newsticker.texi
+++ b/doc/misc/newsticker.texi
@@ -239,17 +239,17 @@ The position of groups and feeds within the tree can be changed with these
 commands:
 
 @table @kbd
-@item M-@key{UP}
-@itemx M-@key{DOWN}
-@kindex M-UP
-@kindex M-DOWN
+@item M-up
+@itemx M-down
+@kindex M-up
+@kindex M-down
 @findex newsticker-group-shift-feed-up
 @findex newsticker-group-shift-feed-down
 Shift the currently selected feed up and down within its group.
-@item M-S-@key{UP}
-@itemx M-S-@key{DOWN}
-@kindex M-S-UP
-@kindex M-S-DOWN
+@item M-S-up
+@itemx M-S-down
+@kindex M-S-up
+@kindex M-S-down
 @findex newsticker-group-shift-group-up
 @findex newsticker-group-shift-group-down
 Shift the currently selected group up and down within its parent group.
@@ -397,8 +397,8 @@ Mark current item as immortal.  Immortal items are kept forever.
 @table @kbd
 @cindex Get News
 @item v
-@itemx @key{RET}
-@itemx mouse-1
+@itemx RET
+@itemx <mouse-1>
 @findex newsticker-treeview-browse-url
 Open the link to the full article (as contained in the current
 headline) in your web browser @code{newsticker-treeview-browse-url}).
diff --git a/doc/misc/org.texi b/doc/misc/org.texi
index c727cc3f8d..17931905f1 100644
--- a/doc/misc/org.texi
+++ b/doc/misc/org.texi
@@ -749,7 +749,7 @@ Specific header arguments
 
 Miscellaneous
 
-* Completion::                  M-@key{TAB} guesses completions
+* Completion::                  M-TAB guesses completions
 * Easy templates::              Quick insertion of structural elements
 * Speed keys::                  Electric commands at the beginning of a headline
 * Code evaluation security::    Org mode files evaluate inline code
@@ -884,8 +884,7 @@ We @b{strongly recommend} to stick to a single installation method.
 @subsubheading Using Emacs packaging system
 
 Recent Emacs distributions include a packaging system which lets you install
-Elisp libraries.  You can install Org with @kbd{M-x package-install @key{RET}
-org}.
+Elisp libraries.  You can install Org with @kbd{M-x package-install RET org}.
 
 @noindent @b{Important}: you need to do this in a session where no @code{.org} file has
 been visited, i.e., where no Org built-in function have been loaded.
@@ -1012,10 +1011,10 @@ version of Org available---if you are running an outdated version, it is
 quite possible that the bug has been fixed already.  If the bug persists,
 prepare a report and provide as much information as possible, including the
 version information of Emacs (@kbd{M-x emacs-version @key{RET}}) and Org
-(@kbd{M-x org-version @key{RET}}), as well as the Org related setup in the
-Emacs init file.  The easiest way to do this is to use the command
+(@kbd{M-x org-version RET}), as well as the Org related setup in the Emacs
+init file.  The easiest way to do this is to use the command
 @example
-@kbd{M-x org-submit-bug-report @key{RET}}
+@kbd{M-x org-submit-bug-report RET}
 @end example
 @noindent which will put all this information into an Emacs mail buffer so
 that you only need to add your description.  If you are not sending the Email
@@ -1075,7 +1074,7 @@ Reload uncompiled versions of all Org mode Lisp files.  The backtrace
 contains much more information if it is produced with uncompiled code.
 To do this, use
 @example
-@kbd{C-u M-x org-reload @key{RET}}
+@kbd{C-u M-x org-reload RET}
 @end example
 @noindent
 or select @code{Org -> Refresh/Reload -> Reload Org uncompiled} from the
@@ -1135,7 +1134,7 @@ accessing a functionality.  Org mode often uses the same key for different
 functions, depending on context.  The command that is bound to such keys has
 a generic name, like @code{org-metaright}.  In the manual we will, wherever
 possible, give the function that is internally called by the generic command.
-For example, in the chapter on document structure, @kbd{M-@key{RIGHT}} will
+For example, in the chapter on document structure, @kbd{M-@key{right}} will
 be listed to call @code{org-do-demote}, while in the chapter on tables, it
 will be listed to call @code{org-table-move-column-right}.  If you prefer,
 you can compile the manual without the command names by unsetting the flag
@@ -1341,9 +1340,9 @@ following lines anywhere in the buffer:
 #+STARTUP: showeverything
 @end example
 
-@cindex property, @code{VISIBILITY}
+@cindex property, VISIBILITY
 @noindent
-Furthermore, any entries with a @code{VISIBILITY} property (@pxref{Properties
+Furthermore, any entries with a @samp{VISIBILITY} property (@pxref{Properties
 and columns}) will get their visibility adapted accordingly.  Allowed values
 for this property are @code{folded}, @code{children}, @code{content}, and
 @code{all}.
@@ -1351,7 +1350,7 @@ for this property are @code{folded}, @code{children}, @code{content}, and
 @table @asis
 @orgcmd{C-u C-u @key{TAB},org-set-startup-visibility}
 Switch back to the startup visibility of the buffer, i.e., whatever is
-requested by startup options and @code{VISIBILITY} properties in individual
+requested by startup options and @samp{VISIBILITY} properties in individual
 entries.
 @end table
 
@@ -1391,7 +1390,7 @@ you can use the following keys to find your destination:
 @vindex org-goto-auto-isearch
 @example
 @key{TAB}         @r{Cycle visibility.}
-@key{DOWN} / @key{UP}   @r{Next/previous visible headline.}
+@key{down} / @key{up}   @r{Next/previous visible headline.}
 @key{RET}         @r{Select this location.}
 @kbd{/}           @r{Do a Sparse-tree search}
 @r{The following keys work if you turn off @code{org-goto-auto-isearch}}
@@ -1452,18 +1451,18 @@ In a new entry with no text yet, the first @key{TAB} demotes the entry to
 become a child of the previous one.  The next @key{TAB} makes it a parent,
 and so on, all the way to top level.  Yet another @key{TAB}, and you are back
 to the initial level.
-@orgcmd{M-@key{LEFT},org-do-promote}
+@orgcmd{M-@key{left},org-do-promote}
 Promote current heading by one level.
-@orgcmd{M-@key{RIGHT},org-do-demote}
+@orgcmd{M-@key{right},org-do-demote}
 Demote current heading by one level.
-@orgcmd{M-S-@key{LEFT},org-promote-subtree}
+@orgcmd{M-S-@key{left},org-promote-subtree}
 Promote the current subtree by one level.
-@orgcmd{M-S-@key{RIGHT},org-demote-subtree}
+@orgcmd{M-S-@key{right},org-demote-subtree}
 Demote the current subtree by one level.
-@orgcmd{M-@key{UP},org-move-subtree-up}
+@orgcmd{M-@key{up},org-move-subtree-up}
 Move subtree up (swap with previous subtree of same
 level).
-@orgcmd{M-@key{DOWN},org-move-subtree-down}
+@orgcmd{M-@key{down},org-move-subtree-down}
 Move subtree down (swap with next subtree of same level).
 @orgcmd{M-h,org-mark-element}
 Mark the element at point.  Hitting repeatedly will mark subsequent elements
@@ -1729,10 +1728,10 @@ one.
 @end table
 
 @table @kbd
-@kindex M-S-RET
+@kindex M-S-@key{RET}
 @item M-S-@key{RET}
 Insert a new item with a checkbox (@pxref{Checkboxes}).
-@kindex S-DOWN
+@kindex S-@key{down}
 @item S-up
 @itemx S-down
 @cindex shift-selection-mode
@@ -1742,25 +1741,25 @@ Jump to the previous/next item in the current list@footnote{If you want to
 cycle around items that way, you may customize
 @code{org-list-use-circular-motion}.}, but only if
 @code{org-support-shift-select} is off.  If not, you can still use paragraph
-jumping commands like @kbd{C-@key{UP}} and @kbd{C-@key{DOWN}} to quite
+jumping commands like @kbd{C-@key{up}} and @kbd{C-@key{down}} to quite
 similar effect.
-@kindex M-UP
-@kindex M-DOWN
+@kindex M-@key{up}
+@kindex M-@key{down}
 @item M-up
 @itemx M-down
 Move the item including subitems up/down@footnote{See
 @code{org-list-use-circular-motion} for a cyclic behavior.} (swap with
 previous/next item of same indentation).  If the list is ordered, renumbering
 is automatic.
-@kindex M-LEFT
-@kindex M-RIGHT
+@kindex M-@key{left}
+@kindex M-@key{right}
 @item M-left
 @itemx M-right
 Decrease/increase the indentation of an item, leaving children alone.
-@kindex M-S-LEFT
-@kindex M-S-RIGHT
-@item M-S-@key{LEFT}
-@itemx M-S-@key{RIGHT}
+@kindex M-S-@key{left}
+@kindex M-S-@key{right}
+@item M-S-@key{left}
+@itemx M-S-@key{right}
 Decrease/increase the indentation of the item, including subitems.
 Initially, the item tree is selected based on current indentation.  When
 these commands are executed several times in direct succession, the initially
@@ -1798,9 +1797,9 @@ its location).  @xref{Structure editing}, for a detailed explanation.
 Turn the whole plain list into a subtree of the current heading.  Checkboxes
 (@pxref{Checkboxes}) will become TODO (resp. DONE) keywords when unchecked
 (resp. checked).
-@kindex S-LEFT
-@kindex S-RIGHT
-@item S-@key{LEFT}/@key{RIGHT}
+@kindex S-@key{left}
+@kindex S-@key{right}
+@item S-left/right
 @vindex org-support-shift-select
 This command also cycles bullet styles when the cursor in on the bullet or
 anywhere in an item line, details depending on
@@ -1818,7 +1817,7 @@ or by a custom function.
 @cindex drawers
 @cindex visibility cycling, drawers
 
-@cindex @code{org-insert-drawer}
+@cindex org-insert-drawer
 @kindex C-c C-x d
 Sometimes you want to keep information associated with an entry, but you
 normally don't want to see it.  For this, Org mode has @emph{drawers}.  They
@@ -1874,7 +1873,7 @@ export output.  Property drawers are not affected by this variable: configure
 Org mode uses begin...end blocks for various purposes from including source
 code examples (@pxref{Literal examples}) to capturing time logging
 information (@pxref{Clocking work time}).  These blocks can be folded and
-unfolded by pressing @key{TAB} in the begin line.  You can also get all blocks
+unfolded by pressing TAB in the begin line.  You can also get all blocks
 folded at startup by configuring the option @code{org-hide-block-startup}
 or on a per-file basis by using
 
@@ -1998,7 +1997,7 @@ a separate window.  The window can be closed by pressing @kbd{C-c '}.
 If you like the intuitive way the Org mode structure editing and list
 formatting works, you might want to use these commands in other modes like
 Text mode or Mail mode as well.  The minor mode @code{orgstruct-mode} makes
-this possible.   Toggle the mode with @kbd{M-x orgstruct-mode @key{RET}}, or
+this possible.   Toggle the mode with @kbd{M-x orgstruct-mode RET}, or
 turn it on by default, for example in Message mode, with one of:
 
 @lisp
@@ -2039,7 +2038,7 @@ file falls into one of the categories above.
 To explore the abstract structure of an Org buffer, run this in a buffer:
 
 @lisp
-M-: (org-element-parse-buffer) @key{RET}
+M-: (org-element-parse-buffer) RET
 @end lisp
 
 It will output a list containing the buffer's content represented as an
@@ -2133,10 +2132,10 @@ table.  But it is easier just to start typing, like
 @orgcmd{C-c C-c,org-table-align}
 Re-align the table and don't move to another field.
 @c
-@orgcmd{C-c @key{SPC},org-table-blank-field}
+@orgcmd{C-c SPC,org-table-blank-field}
 Blank the field at point.
 @c
-@orgcmd{@key{TAB},org-table-next-field}
+@orgcmd{TAB,org-table-next-field}
 Re-align the table, move to the next field.  Creates a new row if
 necessary.
 @c
@@ -2154,22 +2153,22 @@ Move to beginning of the current table field, or on to the previous field.
 Move to end of the current table field, or on to the next field.
 
 @tsubheading{Column and row editing}
-@orgcmdkkcc{M-@key{LEFT},M-@key{RIGHT},org-table-move-column-left,org-table-move-column-right}
+@orgcmdkkcc{M-@key{left},M-@key{right},org-table-move-column-left,org-table-move-column-right}
 Move the current column left/right.
 @c
-@orgcmd{M-S-@key{LEFT},org-table-delete-column}
+@orgcmd{M-S-@key{left},org-table-delete-column}
 Kill the current column.
 @c
-@orgcmd{M-S-@key{RIGHT},org-table-insert-column}
+@orgcmd{M-S-@key{right},org-table-insert-column}
 Insert a new column to the left of the cursor position.
 @c
-@orgcmdkkcc{M-@key{UP},M-@key{DOWN},org-table-move-row-up,org-table-move-row-down}
+@orgcmdkkcc{M-@key{up},M-@key{down},org-table-move-row-up,org-table-move-row-down}
 Move the current row up/down.
 @c
-@orgcmd{M-S-@key{UP},org-table-kill-row}
+@orgcmd{M-S-@key{up},org-table-kill-row}
 Kill the current row or horizontal line.
 @c
-@orgcmd{M-S-@key{DOWN},org-table-insert-row}
+@orgcmd{M-S-@key{down},org-table-insert-row}
 Insert a new row above the current row.  With a prefix argument, the line is
 created below the current one.
 @c
@@ -2251,7 +2250,7 @@ window follow the cursor through the table and always show the current
 field.  The follow mode exits automatically when the cursor leaves the table,
 or when you repeat this command with @kbd{C-u C-u C-c `}.
 @c
-@item M-x org-table-import @key{RET}
+@item M-x org-table-import RET
 Import a file as a table.  The table should be TAB or whitespace
 separated.  Use, for example, to import a spreadsheet table or data
 from a database, because these programs generally can write
@@ -2264,7 +2263,7 @@ Tables can also be imported by pasting tabular text into the Org
 buffer, selecting the pasted text with @kbd{C-x C-x} and then using the
 @kbd{C-c |} command (see above under @i{Creation and conversion}).
 @c
-@item M-x org-table-export @key{RET}
+@item M-x org-table-export RET
 @findex org-table-export
 @vindex org-table-export-default-format
 Export the table, by default as a TAB-separated file.  Use for data
@@ -2389,11 +2388,11 @@ every vertical line you would like to have:
 @cindex Orgtbl mode
 @cindex minor mode for tables
 
-If you like the intuitive way the Org table editor works, you might also want
-to use it in other modes like Text mode or Mail mode.  The minor mode Orgtbl
-mode makes this possible.  You can always toggle the mode with @kbd{M-x
-orgtbl-mode @key{RET}}.  To turn it on by default, for example in Message
-mode, use
+If you like the intuitive way the Org table editor works, you
+might also want to use it in other modes like Text mode or Mail mode.
+The minor mode Orgtbl mode makes this possible.  You can always toggle
+the mode with @kbd{M-x orgtbl-mode RET}.  To turn it on by default, for
+example in Message mode, use
 
 @lisp
 (add-hook 'message-mode-hook 'turn-on-orgtbl)
@@ -2566,7 +2565,7 @@ rows/columns.
 @cindex references, named
 @cindex name, of column or field
 @cindex constants, in calculations
-@cindex @code{#+CONSTANTS}
+@cindex #+CONSTANTS
 
 @vindex org-table-formula-constants
 @samp{$name} is interpreted as the name of a column, parameter or
@@ -2603,7 +2602,7 @@ numbers.
 @cindex references, to a different table
 @cindex name, of column or field
 @cindex constants, in calculations
-@cindex @code{#+NAME}, for table
+@cindex #+NAME, for table
 
 You may also reference constants, fields and ranges from a different table,
 either in the current file or even in a different file.  The syntax is
@@ -2825,8 +2824,8 @@ preceded by @samp{:=}, for example @samp{:=vsum(@@II..III)}.  When you press
 the formula will be stored as the formula for this field, evaluated, and the
 current field will be replaced with the result.
 
-@cindex @code{#+TBLFM}
-Formulas are stored in a special line starting with @code{#+TBLFM:} directly
+@cindex #+TBLFM
+Formulas are stored in a special line starting with @samp{#+TBLFM:} directly
 below the table.  If you type the equation in the 4th field of the 3rd data
 line in the table, the formula will look like @samp{@@3$4=$1+$2}.  When
 inserting/deleting/swapping columns and rows with the appropriate commands,
@@ -2844,7 +2843,7 @@ command
 @table @kbd
 @orgcmd{C-u C-c =,org-table-eval-formula}
 Install a new formula for the current field.  The command prompts for a
-formula with default taken from the @code{#+TBLFM:} line, applies
+formula with default taken from the @samp{#+TBLFM:} line, applies
 it to the current field, and stores it.
 @end table
 
@@ -2891,7 +2890,7 @@ the formula will be stored as the formula for the current column, evaluated
 and the current field replaced with the result.  If the field contains only
 @samp{=}, the previously stored formula for this column is used.  For each
 column, Org will only remember the most recently used formula.  In the
-@code{#+TBLFM:} line, column formulas will look like @samp{$4=$1+$2}.  The
+@samp{#+TBLFM:} line, column formulas will look like @samp{$4=$1+$2}.  The
 left-hand side of a column formula cannot be the name of column, it must be
 the numeric column reference or @code{$>}.
 
@@ -2902,7 +2901,7 @@ following command:
 @orgcmd{C-c =,org-table-eval-formula}
 Install a new formula for the current column and replace current field with
 the result of the formula.  The command prompts for a formula, with default
-taken from the @code{#+TBLFM} line, applies it to the current field and
+taken from the @samp{#+TBLFM} line, applies it to the current field and
 stores it.  With a numeric prefix argument(e.g., @kbd{C-5 C-c =}) the command
 will apply it to that many consecutive fields in the current column.
 @end table
@@ -3013,22 +3012,22 @@ formula, @key{TAB} re-indents just like in Emacs Lisp mode.
 Complete Lisp symbols, just like in Emacs Lisp mode.@footnote{Many desktops
 intercept @kbd{M-@key{TAB}} to switch windows.  Use @kbd{C-M-i} or
 @kbd{@key{ESC} @key{TAB}} instead for completion (@pxref{Completion}).}
-@kindex S-UP
-@kindex S-DOWN
-@kindex S-LEFT
-@kindex S-RIGHT
+@kindex S-@key{up}
+@kindex S-@key{down}
+@kindex S-@key{left}
+@kindex S-@key{right}
 @findex org-table-fedit-ref-up
 @findex org-table-fedit-ref-down
 @findex org-table-fedit-ref-left
 @findex org-table-fedit-ref-right
-@item S-@key{UP}/@key{DOWN}/@key{LEFT}/@key{RIGHT}
+@item S-@key{up}/@key{down}/@key{left}/@key{right}
 Shift the reference at point.  For example, if the reference is
-@code{B3} and you press @kbd{S-@key{RIGHT}}, it will become @code{C3}.
+@code{B3} and you press @kbd{S-@key{right}}, it will become @code{C3}.
 This also works for relative references and for hline references.
-@orgcmdkkcc{M-S-@key{UP},M-S-@key{DOWN},org-table-fedit-line-up,org-table-fedit-line-down}
+@orgcmdkkcc{M-S-@key{up},M-S-@key{down},org-table-fedit-line-up,org-table-fedit-line-down}
 Move the test line for column formulas in the Org buffer up and
 down.
-@orgcmdkkcc{M-@key{UP},M-@key{DOWN},org-table-fedit-scroll-down,org-table-fedit-scroll-up}
+@orgcmdkkcc{M-@key{up},M-@key{down},org-table-fedit-scroll-down,org-table-fedit-scroll-up}
 Scroll the window displaying the table.
 @kindex C-c @}
 @findex org-table-toggle-coordinate-overlays
@@ -3038,25 +3037,25 @@ Turn the coordinate grid in the table on and off.
 @end table
 
 Making a table field blank does not remove the formula associated with
-the field, because that is stored in a different line (the @code{#+TBLFM}
+the field, because that is stored in a different line (the @samp{#+TBLFM}
 line)---during the next recalculation the field will be filled again.
 To remove a formula from a field, you have to give an empty reply when
-prompted for the formula, or to edit the @code{#+TBLFM} line.
+prompted for the formula, or to edit the @samp{#+TBLFM} line.
 
 @kindex C-c C-c
-You may edit the @code{#+TBLFM} directly and re-apply the changed
+You may edit the @samp{#+TBLFM} directly and re-apply the changed
 equations with @kbd{C-c C-c} in that line or with the normal
 recalculation commands in the table.
 
 @anchor{Using multiple #+TBLFM lines}
-@subsubheading Using multiple @code{#+TBLFM} lines
-@cindex @code{#+TBLFM} line, multiple
-@cindex @code{#+TBLFM}
-@cindex @code{#+TBLFM}, switching
+@subsubheading Using multiple #+TBLFM lines
+@cindex #+TBLFM line, multiple
+@cindex #+TBLFM
+@cindex #+TBLFM, switching
 @kindex C-c C-c
 
 You may apply the formula temporarily.  This is useful when you
-switch the formula.  Place multiple @code{#+TBLFM} lines right
+switch the formula.  Place multiple @samp{#+TBLFM} lines right
 after the table, and then press @kbd{C-c C-c} on the formula to
 apply.  Here is an example:
 
@@ -3083,7 +3082,7 @@ Pressing @kbd{C-c C-c} in the line of @samp{#+TBLFM: $2=$1*2} yields:
 
 @noindent
 Note: If you recalculate this table (with @kbd{C-u C-c *}, for example), you
-will get the following result of applying only the first @code{#+TBLFM} line.
+will get the following result of applying only the first @samp{#+TBLFM} line.
 
 @example
 | x | y |
@@ -3132,10 +3131,10 @@ hline are left alone, assuming that these are part of the table header.
 Iterate the table by recomputing it until no further changes occur.
 This may be necessary if some computed fields use the value of other
 fields that are computed @i{later} in the calculation sequence.
-@item M-x org-table-recalculate-buffer-tables @key{RET}
+@item M-x org-table-recalculate-buffer-tables RET
 @findex org-table-recalculate-buffer-tables
 Recompute all tables in the current buffer.
-@item M-x org-table-iterate-buffer-tables @key{RET}
+@item M-x org-table-iterate-buffer-tables RET
 @findex org-table-iterate-buffer-tables
 Iterate all tables in the current buffer, in order to converge table-to-table
 dependencies.
@@ -3250,7 +3249,7 @@ functions.
 @section Org-Plot
 @cindex graph, in tables
 @cindex plot tables using Gnuplot
-@cindex @code{#+PLOT}
+@cindex #+PLOT
 
 Org-Plot can produce graphs of information stored in org tables, either
 graphically or in ASCII-art.
@@ -3433,7 +3432,7 @@ internal structure of all links, use the menu entry
 @cindex links, internal
 @cindex targets, for links
 
-@cindex property, @code{CUSTOM_ID}
+@cindex property, CUSTOM_ID
 If the link does not look like a URL, it is considered to be internal in the
 current file.  The most important case is a link like
 @samp{[[#my-custom-id]]} which will link to the entry with the
@@ -3449,7 +3448,7 @@ point to the corresponding headline.  The preferred match for a text link is
 a @i{dedicated target}: the same string in double angular brackets, like
 @samp{<<My Target>>}.
 
-@cindex @code{#+NAME}
+@cindex #+NAME
 If no dedicated target exists, the link will then try to match the exact name
 of an element within the buffer.  Naming is done with the @code{#+NAME}
 keyword, which has to be put in the line before the element it refers to, as
@@ -3641,8 +3640,8 @@ removed from the link and result in a wrong link---you should avoid putting
 timestamp in the headline.}.
 
 @vindex org-id-link-to-org-use-id
-@cindex property, @code{CUSTOM_ID}
-@cindex property, @code{ID}
+@cindex property, CUSTOM_ID
+@cindex property, ID
 If the headline has a @code{CUSTOM_ID} property, a link to this custom ID
 will be stored.  In addition or alternatively (depending on the value of
 @code{org-id-link-to-org-use-id}), a globally unique @code{ID} property will
@@ -3709,7 +3708,7 @@ becomes the default description.
 @b{Inserting stored links}@*
 All links stored during the
 current session are part of the history for this prompt, so you can access
-them with @key{UP} and @key{DOWN} (or @kbd{M-p/n}).
+them with @key{up} and @key{down} (or @kbd{M-p/n}).
 
 @b{Completion support}@* Completion with @key{TAB} will help you to insert
 valid link prefixes like @samp{https:}, including the prefixes
@@ -3884,7 +3883,7 @@ what the Org author is doing besides Emacs hacking with
 If you need special abbreviations just for a single Org buffer, you
 can define them in the file with
 
-@cindex @code{#+LINK}
+@cindex #+LINK
 @example
 #+LINK: bugzilla  http://10.1.2.9/bugzilla/show_bug.cgi?id=
 #+LINK: google    http://www.google.com/search?q=%s
@@ -4042,9 +4041,9 @@ completion; otherwise force cycling through TODO states with no prompt.  When
 @code{org-use-fast-todo-selection} is set to @code{prefix}, use the fast
 selection interface.
 
-@kindex S-RIGHT
-@kindex S-LEFT
-@item S-@key{RIGHT} @ @r{/} @ S-@key{LEFT}
+@kindex S-@key{right}
+@kindex S-@key{left}
+@item S-@key{right} @ @r{/} @ S-@key{left}
 @vindex org-treat-S-cursor-todo-selection-as-state-change
 Select the following/preceding TODO state, similar to cycling.  Useful
 mostly if more than two TODO states are possible (@pxref{TODO
@@ -4125,7 +4124,7 @@ With this setup, the command @kbd{C-c C-t} will cycle an entry from TODO
 to FEEDBACK, then to VERIFY, and finally to DONE and DELEGATED@.  You may
 also use a numeric prefix argument to quickly select a specific state.  For
 example @kbd{C-3 C-c C-t} will change the state immediately to VERIFY@.
-Or you can use @kbd{S-@key{LEFT}} to go backward through the sequence.  If you
+Or you can use @kbd{S-@key{left}} to go backward through the sequence.  If you
 define many keywords, you can use in-buffer completion
 (@pxref{Completion}) or even a special one-key selection scheme
 (@pxref{Fast access to TODO states}) to insert these words into the
@@ -4191,23 +4190,23 @@ select the correct sequence.  Besides the obvious ways like typing a
 keyword or using completion, you may also apply the following commands:
 
 @table @kbd
-@kindex C-S-RIGHT
-@kindex C-S-LEFT
+@kindex C-S-@key{right}
+@kindex C-S-@key{left}
 @kindex C-u C-u C-c C-t
 @item C-u C-u C-c C-t
-@itemx C-S-@key{RIGHT}
-@itemx C-S-@key{LEFT}
+@itemx C-S-@key{right}
+@itemx C-S-@key{left}
 These keys jump from one TODO subset to the next.  In the above example,
-@kbd{C-u C-u C-c C-t} or @kbd{C-S-@key{RIGHT}} would jump from @code{TODO} or
+@kbd{C-u C-u C-c C-t} or @kbd{C-S-@key{right}} would jump from @code{TODO} or
 @code{DONE} to @code{REPORT}, and any of the words in the second row to
 @code{CANCELED}.  Note that the @kbd{C-S-} key binding conflict with
 @code{shift-selection-mode} (@pxref{Conflicts}).
-@kindex S-RIGHT
-@kindex S-LEFT
-@item S-@key{RIGHT}
-@itemx S-@key{LEFT}
-@kbd{S-@key{LEFT}} and @kbd{S-@key{RIGHT}} and walk through @emph{all}
-keywords from all sets, so for example @kbd{S-@key{RIGHT}} would switch
+@kindex S-@key{right}
+@kindex S-@key{left}
+@item S-@key{right}
+@itemx S-@key{left}
+@kbd{S-@key{left}} and @kbd{S-@key{right}} and walk through @emph{all}
+keywords from all sets, so for example @kbd{S-@key{right}} would switch
 from @code{DONE} to @code{REPORT} in the example above.  See also
 @ref{Conflicts}, for a discussion of the interaction with
 @code{shift-selection-mode}.
@@ -4230,8 +4229,8 @@ each keyword, in parentheses@footnote{All characters are allowed except
 @end lisp
 
 @vindex org-fast-tag-selection-include-todo
-If you then press @kbd{C-c C-t} followed by the selection key, the entry will
-be switched to this state.  @kbd{@key{SPC}} can be used to remove any TODO
+If you then press @kbd{C-c C-t} followed by the selection key, the entry
+will be switched to this state.  @kbd{SPC} can be used to remove any TODO
 keyword from an entry.@footnote{Check also the option
 @code{org-fast-tag-selection-include-todo}, it allows you to change the TODO
 state through the tags interface (@pxref{Setting tags}), in case you like to
@@ -4242,9 +4241,9 @@ unique keys across both sets of keywords.}
 @subsection Setting up keywords for individual files
 @cindex keyword options
 @cindex per-file keywords
-@cindex @code{#+TODO}
-@cindex @code{#+TYP_TODO}
-@cindex @code{#+SEQ_TODO}
+@cindex #+TODO
+@cindex #+TYP_TODO
+@cindex #+SEQ_TODO
 
 It can be very useful to use different aspects of the TODO mechanism in
 different files.  For file-local settings, you need to add special lines to
@@ -4270,7 +4269,7 @@ A setup for using several sets in parallel would be:
 @end example
 
 @cindex completion, of option keywords
-@kindex M-TAB
+@kindex M-@key{TAB}
 @noindent To make sure you are using the correct keyword, type
 @samp{#+} into the buffer and then use @kbd{M-@key{TAB}} completion.
 
@@ -4319,7 +4318,7 @@ foreground or a background color.
 @cindex TODO dependencies, NOBLOCKING
 
 @vindex org-enforce-todo-dependencies
-@cindex property, @code{ORDERED}
+@cindex property, ORDERED
 The structure of Org files (hierarchy and lists) makes it easy to define TODO
 dependencies.  Usually, a parent TODO task should not be marked DONE until
 all subtasks (defined as children tasks) are marked as DONE@.  And sometimes
@@ -4358,7 +4357,7 @@ property:
 @table @kbd
 @orgcmd{C-c C-x o,org-toggle-ordered-property}
 @vindex org-track-ordered-property-with-tag
-@cindex property, @code{ORDERED}
+@cindex property, ORDERED
 Toggle the @code{ORDERED} property of the current entry.  A property is used
 for this behavior because this should be local to the current entry, not
 inherited like a tag.  However, if you would like to @i{track} the value of
@@ -4420,7 +4419,7 @@ Then each time you turn an entry from a TODO (not-done) state into any of the
 DONE states, a line @samp{CLOSED: [timestamp]} will be inserted just after
 the headline.  If you turn the entry back into a TODO item through further
 state cycling, that line will be removed again.  If you turn the entry back
-to a non-TODO state (by pressing @key{C-c C-t @key{SPC}} for example), that line
+to a non-TODO state (by pressing @key{C-c C-t SPC} for example), that line
 will also be removed, unless you set @code{org-closed-keep-when-no-todo} to
 non-@code{nil}.  If you want to record a note along with the timestamp,
 use@footnote{The corresponding in-buffer setting is: @code{#+STARTUP:
@@ -4440,7 +4439,7 @@ the entry with a @samp{Closing Note} heading.
 
 @vindex org-log-states-order-reversed
 @vindex org-log-into-drawer
-@cindex property, @code{LOG_INTO_DRAWER}
+@cindex property, LOG_INTO_DRAWER
 When TODO keywords are used as workflow states (@pxref{Workflow states}), you
 might want to keep track of when a state change occurred and maybe take a
 note about this change.  You can either record just a timestamp, or a
@@ -4450,8 +4449,8 @@ headline as an itemized list, newest first@footnote{See the option
 want to get the notes out of the way into a drawer (@pxref{Drawers}).
 Customize @code{org-log-into-drawer} to get this behavior---the recommended
 drawer for this is called @code{LOGBOOK}@footnote{Note that the
-@code{LOGBOOK} drawer is unfolded when pressing @kbd{@key{SPC}} in the agenda to
-show an entry---use @kbd{C-u @key{SPC}} to keep it folded here}.  You can also
+@code{LOGBOOK} drawer is unfolded when pressing @key{SPC} in the agenda to
+show an entry---use @key{C-u SPC} to keep it folded here}.  You can also
 overrule the setting of this variable for a subtree by setting a
 @code{LOG_INTO_DRAWER} property.
 
@@ -4494,12 +4493,12 @@ to a buffer:
 #+TODO: TODO(t) WAIT(w@@/!) | DONE(d!) CANCELED(c@@)
 @end example
 
-@cindex property, @code{LOGGING}
-In order to define logging settings that are local to a subtree or a single
-item, define a @code{LOGGING} property in this entry.  Any non-empty
-@code{LOGGING} property resets all logging settings to @code{nil}.  You may
-then turn on logging for this specific tree using @code{#+STARTUP} keywords
-like @code{lognotedone} or @code{logrepeat}, as well as adding state specific
+@cindex property, LOGGING
+In order to define logging settings that are local to a subtree or a
+single item, define a LOGGING property in this entry.  Any non-empty
+LOGGING property resets all logging settings to @code{nil}.  You may then turn
+on logging for this specific tree using STARTUP keywords like
+@code{lognotedone} or @code{logrepeat}, as well as adding state specific
 settings like @code{TODO(!)}.  For example
 
 @example
@@ -4643,7 +4642,7 @@ items.
 
 @table @kbd
 @item @kbd{C-c ,}
-@kindex C-c ,
+@kindex @kbd{C-c ,}
 @findex org-priority
 Set the priority of the current headline (@command{org-priority}).  The
 command prompts for a priority character @samp{A}, @samp{B} or @samp{C}.
@@ -4651,7 +4650,7 @@ When you press @key{SPC} instead, the priority cookie is removed from the
 headline.  The priorities can also be changed ``remotely'' from the agenda
 buffer with the @kbd{,} command (@pxref{Agenda commands}).
 @c
-@orgcmdkkcc{S-@key{UP},S-@key{DOWN},org-priority-up,org-priority-down}
+@orgcmdkkcc{S-@key{up},S-@key{down},org-priority-up,org-priority-down}
 @vindex org-priority-start-cycle-with-default
 Increase/decrease priority of current headline@footnote{See also the option
 @code{org-priority-start-cycle-with-default}.}.  Note that these keys are
@@ -4670,7 +4669,7 @@ these values (highest, lowest, default) like this (please make sure that
 the highest priority is earlier in the alphabet than the lowest
 priority):
 
-@cindex @code{#+PRIORITIES}
+@cindex #+PRIORITIES
 @example
 #+PRIORITIES: A C B
 @end example
@@ -4699,7 +4698,7 @@ be updated each time the TODO status of a child changes, or when pressing
 ** DONE Talk to neighbor
 @end example
 
-@cindex property, @code{COOKIE_DATA}
+@cindex property, COOKIE_DATA
 If a heading has both checkboxes and TODO children below it, the meaning of
 the statistics cookie become ambiguous.  Set the property
 @code{COOKIE_DATA} to either @samp{checkbox} or @samp{todo} to resolve
@@ -4771,7 +4770,7 @@ checked.
 
 @cindex statistics, for checkboxes
 @cindex checkbox statistics
-@cindex property, @code{COOKIE_DATA}
+@cindex property, COOKIE_DATA
 @vindex org-checkbox-hierarchical-statistics
 The @samp{[2/4]} and @samp{[1/3]} in the first and second line are cookies
 indicating how many checkboxes present in this entry have been checked off,
@@ -4793,7 +4792,7 @@ to either @samp{checkbox} or @samp{todo} to resolve this issue.
 
 @cindex blocking, of checkboxes
 @cindex checkbox blocking
-@cindex property, @code{ORDERED}
+@cindex property, ORDERED
 If the current outline node has an @code{ORDERED} property, checkboxes must
 be checked off in sequence, and an error will be thrown if you try to check
 off a box while there are unchecked boxes above it.
@@ -4830,7 +4829,7 @@ Insert a new item with a checkbox.  This works only if the cursor is already
 in a plain list item (@pxref{Plain lists}).
 @orgcmd{C-c C-x o,org-toggle-ordered-property}
 @vindex org-track-ordered-property-with-tag
-@cindex property, @code{ORDERED}
+@cindex property, ORDERED
 Toggle the @code{ORDERED} property of the entry, to toggle if checkboxes must
 be checked off in sequence.  A property is used for this behavior because
 this should be local to the current entry, not inherited like a tag.
@@ -4898,7 +4897,7 @@ a hypothetical level zero that surrounds the entire file.  Use a line like
 this@footnote{As with all these in-buffer settings, pressing @kbd{C-c C-c}
 activates any changes in the line.}:
 
-@cindex @code{#+FILETAGS}
+@cindex #+FILETAGS
 @example
 #+FILETAGS: :Peter:Boss:Secret:
 @end example
@@ -4932,7 +4931,7 @@ can really speed up agenda generation.
 @cindex setting tags
 @cindex tags, setting
 
-@kindex M-TAB
+@kindex M-@key{TAB}
 Tags can simply be typed into the buffer at the end of a headline.
 After a colon, @kbd{M-@key{TAB}} offers completion on tags.  There is
 also a special command for inserting tags:
@@ -4960,7 +4959,7 @@ currently used in the buffer.  You may also globally specify a hard list
 of tags with the variable @code{org-tag-alist}.  Finally you can set
 the default tags for a given file with lines like
 
-@cindex @code{#+TAGS}
+@cindex #+TAGS
 @example
 #+TAGS: @@work @@home @@tennisclub
 #+TAGS: laptop car pc sailboat
@@ -4979,7 +4978,7 @@ If you have a preferred set of tags that you would like to use in every file,
 in addition to those defined on a per-file basis by TAGS option lines, then
 you may specify a list of tags with the variable
 @code{org-tag-persistent-alist}.  You may turn this off on a per-file basis
-by adding a @code{#+STARTUP} option line to that file:
+by adding a STARTUP option line to that file:
 
 @example
 #+STARTUP: noptag
@@ -5063,17 +5062,17 @@ will turn off any other tags from that group.
 In this interface, you can also use the following special keys:
 
 @table @kbd
-@kindex TAB
+@kindex @key{TAB}
 @item @key{TAB}
 Enter a tag in the minibuffer, even if the tag is not in the predefined
 list.  You will be able to complete on all tags present in the buffer.
 You can also add several tags: just separate them with a comma.
 
-@kindex SPC
+@kindex @key{SPC}
 @item @key{SPC}
 Clear all tags for this line.
 
-@kindex RET
+@kindex @key{RET}
 @item @key{RET}
 Accept the modified set.
 
@@ -5329,8 +5328,8 @@ publishers and the number of disks in a box like this:
 
 If you want to set properties that can be inherited by any entry in a
 file, use a line like
-@cindex property, @code{_ALL}
-@cindex @code{#+PROPERTY}
+@cindex property, _ALL
+@cindex #+PROPERTY
 @example
 #+PROPERTY: NDisks_ALL 1 2 3 4
 @end example
@@ -5341,7 +5340,7 @@ buffer with @kbd{C-c C-c} to activate this change.
 If you want to add to the value of an existing property, append a @code{+} to
 the property name.  The following results in the property @code{var} having
 the value ``foo=1 bar=2''.
-@cindex property, @code{+}
+@cindex property, +
 @example
 #+PROPERTY: var  foo=1
 #+PROPERTY: var+ bar=2
@@ -5350,7 +5349,7 @@ the value ``foo=1 bar=2''.
 It is also possible to add to the values of inherited properties.  The
 following results in the @code{genres} property having the value ``Classic
 Baroque'' under the @code{Goldberg Variations} subtree.
-@cindex property, @code{+}
+@cindex property, +
 @example
 * CD collection
 ** Classic
@@ -5384,8 +5383,8 @@ in the current file will be offered as possible completions.
 @orgcmd{C-c C-x p,org-set-property}
 Set a property.  This prompts for a property name and a value.  If
 necessary, the property drawer is created as well.
-@item C-u M-x org-insert-drawer @key{RET}
-@cindex @code{org-insert-drawer}
+@item C-u M-x org-insert-drawer RET
+@cindex org-insert-drawer
 Insert a property drawer into the current entry.  The drawer will be
 inserted early in the entry, but after the lines with planning
 information like deadlines.
@@ -5394,7 +5393,7 @@ With the cursor in a property drawer, this executes property commands.
 @orgcmd{C-c C-c s,org-set-property}
 Set a property in the current entry.  Both the property and the value
 can be inserted using completion.
-@orgcmdkkcc{S-@key{RIGHT},S-@key{LEFT},org-property-next-allowed-value,org-property-previous-allowed-value}
+@orgcmdkkcc{S-@key{right},S-@key{left},org-property-next-allowed-value,org-property-previous-allowed-value}
 Switch property at point to the next/previous allowed value.
 @orgcmd{C-c C-c d,org-delete-property}
 Remove a property from the current entry.
@@ -5416,20 +5415,20 @@ a column view (@pxref{Column view}), or to use them in queries.  The
 following property names are special and should not be used as keys in the
 properties drawer:
 
-@cindex property, special, @code{ALLTAGS}
-@cindex property, special, @code{BLOCKED}
-@cindex property, special, @code{CLOCKSUM}
-@cindex property, special, @code{CLOCKSUM_T}
-@cindex property, special, @code{CLOSED}
-@cindex property, special, @code{DEADLINE}
-@cindex property, special, @code{FILE}
-@cindex property, special, @code{ITEM}
-@cindex property, special, @code{PRIORITY}
-@cindex property, special, @code{SCHEDULED}
-@cindex property, special, @code{TAGS}
-@cindex property, special, @code{TIMESTAMP}
-@cindex property, special, @code{TIMESTAMP_IA}
-@cindex property, special, @code{TODO}
+@cindex property, special, ALLTAGS
+@cindex property, special, BLOCKED
+@cindex property, special, CLOCKSUM
+@cindex property, special, CLOCKSUM_T
+@cindex property, special, CLOSED
+@cindex property, special, DEADLINE
+@cindex property, special, FILE
+@cindex property, special, ITEM
+@cindex property, special, PRIORITY
+@cindex property, special, SCHEDULED
+@cindex property, special, TAGS
+@cindex property, special, TIMESTAMP
+@cindex property, special, TIMESTAMP_IA
+@cindex property, special, TODO
 @example
 ALLTAGS      @r{All tags, including inherited ones.}
 BLOCKED      @r{"t" if task is currently blocked by children or siblings.}
@@ -5509,7 +5508,7 @@ search will stop at this value and return @code{nil}.
 Org mode has a few properties for which inheritance is hard-coded, at
 least for the special applications for which they are used:
 
-@cindex property, @code{COLUMNS}
+@cindex property, COLUMNS
 @table @code
 @item COLUMNS
 The @code{:COLUMNS:} property defines the format of column view
@@ -5518,16 +5517,16 @@ where a @code{:COLUMNS:} property is defined is used as the starting
 point for a column view table, independently of the location in the
 subtree from where columns view is turned on.
 @item CATEGORY
-@cindex property, @code{CATEGORY}
+@cindex property, CATEGORY
 For agenda view, a category set through a @code{:CATEGORY:} property
 applies to the entire subtree.
 @item ARCHIVE
-@cindex property, @code{ARCHIVE}
+@cindex property, ARCHIVE
 For archiving, the @code{:ARCHIVE:} property may define the archive
 location for the entire subtree (@pxref{Moving subtrees}).
 @item LOGGING
-@cindex property, @code{LOGGING}
-The @code{LOGGING} property may define logging settings for an entry or a
+@cindex property, LOGGING
+The LOGGING property may define logging settings for an entry or a
 subtree (@pxref{Tracking TODO state changes}).
 @end table
 
@@ -5572,7 +5571,7 @@ done by defining a column format line.
 
 To define a column format for an entire file, use a line like
 
-@cindex @code{#+COLUMNS}
+@cindex #+COLUMNS
 @example
 #+COLUMNS: %25ITEM %TAGS %PRIORITY %TODO
 @end example
@@ -5724,17 +5723,17 @@ Same as @kbd{r}.
 @orgcmd{q,org-columns-quit}
 Exit column view.
 @tsubheading{Editing values}
-@item @key{LEFT} @key{RIGHT} @key{UP} @key{DOWN}
+@item @key{left} @key{right} @key{up} @key{down}
 Move through the column view from field to field.
-@kindex S-LEFT
-@kindex S-RIGHT
-@item  S-@key{LEFT}/@key{RIGHT}
+@kindex S-@key{left}
+@kindex S-@key{right}
+@item  S-@key{left}/@key{right}
 Switch to the next/previous allowed value of the field.  For this, you
 have to have specified allowed values for a property.
 @item 1..9,0
 Directly select the Nth allowed value, @kbd{0} selects the 10th value.
 @orgcmdkkcc{n,p,org-columns-next-allowed-value,org-columns-previous-allowed-value}
-Same as @kbd{S-@key{LEFT}/@key{RIGHT}}
+Same as @kbd{S-@key{left}/@key{right}}
 @orgcmd{e,org-columns-edit-value}
 Edit the property at point.  For the special properties, this will
 invoke the same interface that you normally use to change that
@@ -5753,9 +5752,9 @@ current column view.
 @tsubheading{Modifying the table structure}
 @orgcmdkkcc{<,>,org-columns-narrow,org-columns-widen}
 Make the column narrower/wider by one character.
-@orgcmd{S-M-@key{RIGHT},org-columns-new}
+@orgcmd{S-M-@key{right},org-columns-new}
 Insert a new column, to the left of the current column.
-@orgcmd{S-M-@key{LEFT},org-columns-delete}
+@orgcmd{S-M-@key{left},org-columns-delete}
 Delete the current column.
 @end table
 
@@ -5767,7 +5766,7 @@ exported or printed directly.  If you want to capture a column view, use
 a @code{columnview} dynamic block (@pxref{Dynamic blocks}).  The frame
 of this block looks like this:
 
-@cindex @code{#+BEGIN}, columnview
+@cindex #+BEGIN, columnview
 @example
 * The column view
 #+BEGIN: columnview :hlines 1 :id "label"
@@ -5783,7 +5782,7 @@ This is the most important parameter.  Column view is a feature that is
 often localized to a certain (sub)tree, and the capture block might be
 at a different location in the file.  To identify the tree whose view to
 capture, you can use 4 values:
-@cindex property, @code{ID}
+@cindex property, ID
 @example
 local     @r{use the tree in which the capture block is located}
 global    @r{make a global view, including all headings in the file}
@@ -5791,7 +5790,7 @@ global    @r{make a global view, including all headings in the file}
           @r{run column view at the top of this file}
 "@var{ID}"      @r{call column view in the tree that has an @code{:ID:}}
           @r{property with the value @i{label}.  You can use}
-          @r{@kbd{M-x org-id-copy @key{RET}} to create a globally unique @code{ID} for}
+          @r{@kbd{M-x org-id-copy RET} to create a globally unique ID for}
           @r{the current entry and copy it to the kill-ring.}
 @end example
 @item :hlines
@@ -5815,7 +5814,7 @@ The following commands insert or update the dynamic block:
 @table @kbd
 @orgcmd{C-c C-x i,org-insert-columns-dblock}
 Insert a dynamic block capturing a column view.  You will be prompted
-for the scope or @code{ID} of the view.
+for the scope or ID of the view.
 @orgcmdkkc{C-c C-c,C-c C-x C-u,org-dblock-update}
 Update dynamic block at point.
 @orgcmd{C-u C-c C-x C-u,org-update-all-dblocks}
@@ -6009,11 +6008,11 @@ instead.
 Access the agenda for the date given by the timestamp or -range at
 point (@pxref{Weekly/daily agenda}).
 @c
-@orgcmdkkcc{S-@key{LEFT},S-@key{RIGHT},org-timestamp-down-day,org-timestamp-up-day}
+@orgcmdkkcc{S-@key{left},S-@key{right},org-timestamp-down-day,org-timestamp-up-day}
 Change date at cursor by one day.  These key bindings conflict with
 shift-selection and related modes (@pxref{Conflicts}).
 @c
-@orgcmdkkcc{S-@key{UP},S-@key{DOWN},org-timestamp-up,org-timestamp-down-down}
+@orgcmdkkcc{S-@key{up},S-@key{down},org-timestamp-up,org-timestamp-down-down}
 Change the item under the cursor in a timestamp.  The cursor can be on a
 year, month, day, hour or minute.  When the timestamp contains a time range
 like @samp{15:30-16:30}, modifying the first time will also shift the second,
@@ -6137,25 +6136,25 @@ from the minibuffer:
 @kindex M-v
 @kindex C-v
 @kindex mouse-1
-@kindex S-RIGHT
-@kindex S-LEFT
-@kindex S-DOWN
-@kindex S-UP
-@kindex M-S-RIGHT
-@kindex M-S-LEFT
-@kindex RET
-@kindex M-S-DOWN
-@kindex M-S-UP
+@kindex S-@key{right}
+@kindex S-@key{left}
+@kindex S-@key{down}
+@kindex S-@key{up}
+@kindex M-S-@key{right}
+@kindex M-S-@key{left}
+@kindex @key{RET}
+@kindex M-S-@key{down}
+@kindex M-S-@key{up}
 
 @example
 @key{RET}              @r{Choose date at cursor in calendar.}
 mouse-1            @r{Select date by clicking on it.}
-S-@key{RIGHT}/@key{LEFT}   @r{One day forward/backward.}
-S-@key{DOWN}/@key{UP}      @r{One week forward/backward.}
-M-S-@key{RIGHT}/@key{LEFT} @r{One month forward/backward.}
+S-@key{right}/@key{left}   @r{One day forward/backward.}
+S-@key{down}/@key{up}      @r{One week forward/backward.}
+M-S-@key{right}/@key{left} @r{One month forward/backward.}
 > / <              @r{Scroll calendar forward/backward by one month.}
 M-v / C-v          @r{Scroll calendar forward/backward by 3 months.}
-M-S-@key{DOWN}/@key{UP}    @r{Scroll calendar forward/backward by one year.}
+M-S-@key{down}/@key{up}    @r{Scroll calendar forward/backward by one year.}
 @end example
 
 @vindex org-read-date-display-live
@@ -6195,10 +6194,10 @@ following consequences:
 You cannot place the cursor onto a timestamp anymore, only before or
 after.
 @item
-The @kbd{S-@key{UP}/@key{DOWN}} keys can no longer be used to adjust
+The @kbd{S-@key{up}/@key{down}} keys can no longer be used to adjust
 each component of a timestamp.  If the cursor is at the beginning of
-the stamp, @kbd{S-@key{UP}/@key{DOWN}} will change the stamp by one day,
-just like @kbd{S-@key{LEFT}/@key{RIGHT}}.  At the end of the stamp, the
+the stamp, @kbd{S-@key{up}/@key{down}} will change the stamp by one day,
+just like @kbd{S-@key{left}/@key{right}}.  At the end of the stamp, the
 time will be changed by one minute.
 @item
 If the timestamp contains a range of clock times or a repeater, these
@@ -6223,7 +6222,7 @@ they refer to.
 
 @table @var
 @item DEADLINE
-@cindex @code{DEADLINE} keyword
+@cindex DEADLINE keyword
 
 Meaning: the task (most likely a TODO item, though not necessarily) is supposed
 to be finished on that date.
@@ -6249,7 +6248,7 @@ deactivated if the task gets scheduled and you set
 @code{org-agenda-skip-deadline-prewarning-if-scheduled} to @code{t}.
 
 @item SCHEDULED
-@cindex @code{SCHEDULED} keyword
+@cindex SCHEDULED keyword
 
 Meaning: you are planning to start working on that task on the given
 date.
@@ -6314,7 +6313,7 @@ an item:
 @table @kbd
 @c
 @orgcmd{C-c C-d,org-deadline}
-Insert @code{DEADLINE} keyword along with a stamp.  Any CLOSED timestamp will
+Insert @samp{DEADLINE} keyword along with a stamp.  Any CLOSED timestamp will
 be removed.  When called with a prefix arg, an existing deadline will be
 removed from the entry.  Depending on the variable
 @code{org-log-redeadline}@footnote{with corresponding @code{#+STARTUP}
@@ -6323,7 +6322,7 @@ keywords @code{logredeadline}, @code{lognoteredeadline}, and
 deadline.
 
 @orgcmd{C-c C-s,org-schedule}
-Insert @code{SCHEDULED} keyword along with a stamp.  Any CLOSED timestamp
+Insert @samp{SCHEDULED} keyword along with a stamp.  Any CLOSED timestamp
 will be removed.  When called with a prefix argument, remove the scheduling
 date from the entry.  Depending on the variable
 @code{org-log-reschedule}@footnote{with corresponding @code{#+STARTUP}
@@ -6357,8 +6356,8 @@ to the previous week before any current timestamp.
 @cindex tasks, repeated
 @cindex repeated tasks
 
-Some tasks need to be repeated again and again.  Org mode helps to organize
-such tasks using a so-called repeater in a @code{DEADLINE}, @code{SCHEDULED},
+Some tasks need to be repeated again and again.  Org mode helps to
+organize such tasks using a so-called repeater in a DEADLINE, SCHEDULED,
 or plain timestamp.  In the following example
 @example
 ** TODO Pay the rent
@@ -6375,18 +6374,18 @@ first and the warning period last: @code{DEADLINE: <2005-10-01 Sat +1m -3d>}.
 @vindex org-todo-repeat-to-state
 Deadlines and scheduled items produce entries in the agenda when they are
 over-due, so it is important to be able to mark such an entry as completed
-once you have done so.  When you mark a @code{DEADLINE} or a @code{SCHEDULED}
-with the TODO keyword DONE, it will no longer produce entries in the agenda.
-The problem with this is, however, that then also the @emph{next} instance of
-the repeated entry will not be active.  Org mode deals with this in the
-following way: When you try to mark such an entry DONE (using @kbd{C-c C-t}),
-it will shift the base date of the repeating timestamp by the repeater
-interval, and immediately set the entry state back to TODO@footnote{In fact,
-the target state is taken from, in this sequence, the @code{REPEAT_TO_STATE}
-property or the variable @code{org-todo-repeat-to-state}.  If neither of
-these is specified, the target state defaults to the first state of the TODO
-state sequence.}.  In the example above, setting the state to DONE would
-actually switch the date like this:
+once you have done so.  When you mark a DEADLINE or a SCHEDULE with the TODO
+keyword DONE, it will no longer produce entries in the agenda.  The problem
+with this is, however, that then also the @emph{next} instance of the
+repeated entry will not be active.  Org mode deals with this in the following
+way: When you try to mark such an entry DONE (using @kbd{C-c C-t}), it will
+shift the base date of the repeating timestamp by the repeater interval, and
+immediately set the entry state back to TODO@footnote{In fact, the target
+state is taken from, in this sequence, the @code{REPEAT_TO_STATE} property or
+the variable @code{org-todo-repeat-to-state}.  If neither of these is
+specified, the target state defaults to the first state of the TODO state
+sequence.}.  In the example above, setting the state to DONE would actually
+switch the date like this:
 
 @example
 ** TODO Pay the rent
@@ -6492,21 +6491,22 @@ what to do with it.
 @orgcmd{C-c C-x C-i,org-clock-in}
 @vindex org-clock-into-drawer
 @vindex org-clock-continuously
-@cindex property, @code{LOG_INTO_DRAWER}
-!Start the clock on the current item (clock-in).  This inserts the
-@code{CLOCK} keyword together with a timestamp.  If this is not the first
-clocking of this item, the multiple @code{CLOCK} lines will be wrapped into a
-@code{:LOGBOOK:} drawer (see also the variable @code{org-clock-into-drawer}).
-You can also overrule the setting of this variable for a subtree by setting a
-@code{CLOCK_INTO_DRAWER} or @code{LOG_INTO_DRAWER} property.  When called
-with a @kbd{C-u} prefix argument, select the task from a list of recently
-clocked tasks.  With two @kbd{C-u C-u} prefixes, clock into the task at point
-and mark it as the default task; the default task will then always be
-available with letter @kbd{d} when selecting a clocking task.  With three
-@kbd{C-u C-u C-u} prefixes, force continuous clocking by starting the clock
-when the last clock stopped.@*
-@cindex property, @code{CLOCK_MODELINE_TOTAL}
-@cindex property, @code{LAST_REPEAT}
+@cindex property, LOG_INTO_DRAWER
+Start the clock on the current item (clock-in).  This inserts the CLOCK
+keyword together with a timestamp.  If this is not the first clocking of
+this item, the multiple CLOCK lines will be wrapped into a
+@code{:LOGBOOK:} drawer (see also the variable
+@code{org-clock-into-drawer}).  You can also overrule
+the setting of this variable for a subtree by setting a
+@code{CLOCK_INTO_DRAWER} or @code{LOG_INTO_DRAWER} property.
+When called with a @kbd{C-u} prefix argument,
+select the task from a list of recently clocked tasks.  With two @kbd{C-u
+C-u} prefixes, clock into the task at point and mark it as the default task;
+the default task will then always be available with letter @kbd{d} when
+selecting a clocking task.  With three @kbd{C-u C-u C-u} prefixes, force
+continuous clocking by starting the clock when the last clock stopped.@*
+@cindex property: CLOCK_MODELINE_TOTAL
+@cindex property: LAST_REPEAT
 @vindex org-clock-modeline-total
 While the clock is running, the current clocking time is shown in the mode
 line, along with the title of the task.  The clock time shown will be all
@@ -6554,7 +6554,7 @@ clock duration keeps the same.
 @orgcmd{S-M-@key{up/down},org-timestamp-up/down}
 On @code{CLOCK} log lines, increase/decrease the timestamp at point and
 the one of the previous (or the next clock) timestamp by the same duration.
-For example, if you hit @kbd{S-M-@key{UP}} to increase a clocked-out timestamp
+For example, if you hit @kbd{S-M-@key{up}} to increase a clocked-out timestamp
 by five minutes, then the clocked-in timestamp of the next clock will be
 increased by five minutes.
 @orgcmd{C-c C-t,org-todo}
@@ -6605,7 +6605,7 @@ Update dynamic block at point.
 @orgkey{C-u C-c C-x C-u}
 Update all dynamic blocks (@pxref{Dynamic blocks}).  This is useful if
 you have several clock table blocks in a buffer.
-@orgcmdkxkc{S-@key{LEFT},S-@key{RIGHT},org-clocktable-try-shift}
+@orgcmdkxkc{S-@key{left},S-@key{right},org-clocktable-try-shift}
 Shift the current @code{:block} interval and update the table.  The cursor
 needs to be in the @code{#+BEGIN: clocktable} line for this command.  If
 @code{:block} is @code{today}, it will be shifted to @code{today-1} etc.
@@ -6615,7 +6615,7 @@ needs to be in the @code{#+BEGIN: clocktable} line for this command.  If
 Here is an example of the frame for a clock table as it is inserted into the
 buffer with the @kbd{C-c C-x C-r} command:
 
-@cindex @code{#+BEGIN}, clocktable
+@cindex #+BEGIN, clocktable
 @example
 #+BEGIN: clocktable :maxlevel 2 :emphasize nil :scope file
 #+END: clocktable
@@ -6655,7 +6655,7 @@ be selected:
              thismonth, lastmonth, thismonth-@var{N}  @r{a relative month}
              thisyear, lastyear, thisyear-@var{N}     @r{a relative year}
              untilnow
-             @r{Use @kbd{S-@key{LEFT}/@key{RIGHT}} keys to shift the time interval.}
+             @r{Use @kbd{S-@key{left}/@key{right}} keys to shift the time interval.}
 :tstart      @r{A time string specifying when to start considering times.}
              @r{Relative times like @code{"<-2w>"} can also be used.  See}
              @r{@ref{Matching tags and properties} for relative time syntax.}
@@ -6691,8 +6691,8 @@ but you can specify your own function using the @code{:formatter} parameter.
              @r{E.g., @code{:sort (1 . ?a)} sorts the first column alphabetically.}
 :compact     @r{Abbreviation for @code{:level nil :indent t :narrow 40! :tcolumns 1}}
              @r{All are overwritten except if there is an explicit @code{:narrow}}
-:timestamp   @r{A timestamp for the entry, when available.  Look for @code{SCHEDULED},}
-             @r{@code{DEADLINE}, @code{TIMESTAMP} and @code{TIMESTAMP_IA}, in this order.}
+:timestamp   @r{A timestamp for the entry, when available.  Look for SCHEDULED,}
+             @r{DEADLINE, TIMESTAMP and TIMESTAMP_IA, in this order.}
 :properties  @r{List of properties that should be shown in the table.  Each}
              @r{property will get its own column.}
 :inherit-props @r{When this flag is @code{t}, the values for @code{:properties} will be inherited.}
@@ -6805,8 +6805,7 @@ identical to dealing with away time due to idleness; it is just happening due
 to a recovery event rather than a set amount of idle time.
 
 You can also check all the files visited by your Org agenda for dangling
-clocks at any time using @kbd{M-x org-resolve-clocks @key{RET}} (or @kbd{C-c
-C-x C-z}).
+clocks at any time using @kbd{M-x org-resolve-clocks RET} (or @kbd{C-c C-x C-z}).
 
 @subsubheading Continuous clocking
 @cindex continuous clocking
@@ -6824,7 +6823,7 @@ with @code{org-clock-in} and two @kbd{C-u C-u} with @code{org-clock-in-last}.
 @section Effort estimates
 @cindex effort estimates
 
-@cindex property, @code{EFFORT}
+@cindex property, Effort
 If you want to plan your work in a very detailed way, or if you need to
 produce offers with quotations of the estimated work effort, you may want to
 assign effort estimates to entries.  If you are also clocking your work, you
@@ -6862,7 +6861,7 @@ In particular if you want to use this setup also in the agenda, a global
 setup may be advised.
 
 The way to assign estimates to individual items is then to switch to column
-mode, and to use @kbd{S-@key{RIGHT}} and @kbd{S-@key{LEFT}} to change the
+mode, and to use @kbd{S-@key{right}} and @kbd{S-@key{left}} to change the
 value.  The values you enter will immediately be summed up in the hierarchy.
 In the column next to it, any clocked time will be displayed.
 
@@ -6966,7 +6965,7 @@ If your configuration depends on @file{org-remember.el}, you need to update
 it and use the setup described below.  To convert your
 @code{org-remember-templates}, run the command
 @example
-@kbd{M-x org-capture-import-remember-templates @key{RET}}
+@kbd{M-x org-capture-import-remember-templates RET}
 @end example
 @noindent and then customize the new variable with @kbd{M-x
 customize-variable org-capture-templates}, check the result, and save the
@@ -7042,7 +7041,7 @@ Visit the last stored capture item in its buffer.
 @end table
 
 @vindex org-capture-bookmark
-@cindex @code{org-capture-last-stored}
+@cindex org-capture-last-stored
 You can also jump to the bookmark @code{org-capture-last-stored}, which will
 automatically be created unless you set @code{org-capture-bookmark} to
 @code{nil}.
@@ -7463,12 +7462,12 @@ Delete all of a task's attachments.  A safer way is to open the directory in
 @command{dired} and delete from there.
 
 @orgcmdtkc{s,C-c C-a s,org-attach-set-directory}
-@cindex property, @code{ATTACH_DIR}
+@cindex property, ATTACH_DIR
 Set a specific directory as the entry's attachment directory.  This works by
 putting the directory path into the @code{ATTACH_DIR} property.
 
 @orgcmdtkc{i,C-c C-a i,org-attach-set-inherit}
-@cindex property, @code{ATTACH_DIR_INHERIT}
+@cindex property, ATTACH_DIR_INHERIT
 Set the @code{ATTACH_DIR_INHERIT} property, so that children will use the
 same directory for attachments as the parent does.
 @end table
@@ -7642,14 +7641,14 @@ javascript:location.href='org-protocol://open-source?&url='+
       encodeURIComponent(location.href)
 @end example
 
-@cindex protocol, open-source, @code{:base-url} property
-@cindex @code{:base-url} property in open-source protocol
-@cindex protocol, open-source, @code{:working-directory} property
-@cindex @code{:working-directory} property in open-source protocol
-@cindex protocol, open-source, @code{:online-suffix} property
-@cindex @code{:online-suffix} property in open-source protocol
-@cindex protocol, open-source, @code{:working-suffix} property
-@cindex @code{:working-suffix} property in open-source protocol
+@cindex protocol, open-source, :base-url property
+@cindex :base-url property in open-source protocol
+@cindex protocol, open-source, :working-directory property
+@cindex :working-directory property in open-source protocol
+@cindex protocol, open-source, :online-suffix property
+@cindex :online-suffix property in open-source protocol
+@cindex protocol, open-source, :working-suffix property
+@cindex :working-suffix property in open-source protocol
 @vindex org-protocol-project-alist
 The variable @code{org-protocol-project-alist} maps URLs to local file names,
 by stripping URL parameters from the end and replacing the @code{:base-url}
@@ -7686,8 +7685,8 @@ to something like
 @code{open-source} handler probably cannot find a file named
 @file{/home/user/example/print/posters.html.php} and fails.
 
-@cindex protocol, open-source, @code{:rewrites} property
-@cindex @code{:rewrites property} in open-source protocol
+@cindex protocol, open-source, :rewrites property
+@cindex :rewrites property in open-source protocol
 Such an entry in @code{org-protocol-project-alist} may hold an additional
 property @code{:rewrites}.  This property is a list of cons cells, each of
 which maps a regular expression to a path relative to the
@@ -7838,12 +7837,12 @@ see the documentation string of the variable
 
 There is also an in-buffer option for setting this variable, for example:
 
-@cindex @code{#+ARCHIVE}
+@cindex #+ARCHIVE
 @example
 #+ARCHIVE: %s_done::
 @end example
 
-@cindex property, @code{ARCHIVE}
+@cindex property, ARCHIVE
 @noindent
 If you would like to have a special ARCHIVE location for a single entry
 or a (sub)tree, give the entry an @code{:ARCHIVE:} property with the
@@ -7910,7 +7909,7 @@ To do this, each subtree is checked for open TODO entries.  If none are
 found, the command offers to set the ARCHIVE tag for the child.  If the
 cursor is @emph{not} on a headline when this command is invoked, the
 level 1 trees will be checked.
-@orgcmd{C-@key{TAB},org-force-cycle-archived}
+@orgcmd{C-@kbd{TAB},org-force-cycle-archived}
 Cycle a tree even if it is tagged with ARCHIVE.
 @orgcmd{C-c C-x A,org-archive-to-archive-sibling}
 Move the current entry to the @emph{Archive Sibling}.  This is a sibling of
@@ -8022,7 +8021,8 @@ Remove current file from the list of agenda files.
 @orgcmd{C-',org-cycle-agenda-files}
 @itemx C-,
 Cycle through agenda file list, visiting one file after the other.
-@item M-x org-iswitchb @key{RET}
+@kindex M-x org-iswitchb
+@item M-x org-iswitchb RET
 Command to use an @code{iswitchb}-like interface to switch to and between Org
 buffers.
 @end table
@@ -8150,7 +8150,7 @@ The purpose of the weekly/daily @emph{agenda} is to act like a page of a
 paper agenda, showing all the tasks for the current week or day.
 
 @table @kbd
-@cindex @code{org-agenda}, command
+@cindex org-agenda, command
 @orgcmd{C-c a a,org-agenda-list}
 Compile an agenda for the current week from a list of Org files.  The agenda
 shows the entries for each day.  With a numeric prefix@footnote{For backward
@@ -8637,7 +8637,7 @@ associated with the item.
 @subsection Categories
 
 @cindex category
-@cindex @code{#+CATEGORY}
+@cindex #+CATEGORY
 The category is a broad label assigned to each agenda item.  By default, the
 category is simply derived from the file name, but you can also specify it
 with a special line in the buffer, like this:
@@ -8647,8 +8647,8 @@ with a special line in the buffer, like this:
 @end example
 
 @noindent
-@cindex property, @code{CATEGORY}
-If you would like to have a special @code{CATEGORY} for a single entry or a
+@cindex property, CATEGORY
+If you would like to have a special CATEGORY for a single entry or a
 (sub)tree, give the entry a @code{:CATEGORY:} property with the
 special category you want to apply as the value.
 
@@ -8788,13 +8788,12 @@ excluding the next tag.
 Org also supports automatic, context-aware tag filtering.  If the variable
 @code{org-agenda-auto-exclude-function} is set to a user-defined function,
 that function can decide which tags should be excluded from the agenda
-automatically.  Once this is set, the @kbd{/} command then accepts
-@kbd{@key{RET}} as a sub-option key and runs the auto exclusion logic.  For
-example, let's say you use a @code{Net} tag to identify tasks which need
-network access, an @code{Errand} tag for errands in town, and a @code{Call}
-tag for making phone calls.  You could auto-exclude these tags based on the
-availability of the Internet, and outside of business hours, with something
-like this:
+automatically.  Once this is set, the @kbd{/} command then accepts @kbd{RET}
+as a sub-option key and runs the auto exclusion logic.  For example, let's
+say you use a @code{Net} tag to identify tasks which need network access, an
+@code{Errand} tag for errands in town, and a @code{Call} tag for making phone
+calls.  You could auto-exclude these tags based on the availability of the
+Internet, and outside of business hours, with something like this:
 
 @smalllisp
 @group
@@ -8950,9 +8949,9 @@ the other commands, the cursor needs to be in the desired line.
 @tsubheading{Motion}
 @cindex motion commands in agenda
 @orgcmd{n,org-agenda-next-line}
-Next line (same as @key{DOWN} and @kbd{C-n}).
+Next line (same as @key{down} and @kbd{C-n}).
 @orgcmd{p,org-agenda-previous-line}
-Previous line (same as @key{UP} and @kbd{C-p}).
+Previous line (same as @key{up} and @kbd{C-p}).
 @orgcmd{N,org-agenda-next-item}
 Next item: same as next line, but only consider items.
 @orgcmd{P,org-agenda-previous-item}
@@ -9005,7 +9004,7 @@ Delete other windows.
 @xorgcmd{v t,org-agenda-fortnight-view}
 @xorgcmd{v m,org-agenda-month-view}
 @xorgcmd{v y,org-agenda-year-view}
-@xorgcmd{v @key{SPC},org-agenda-reset-view}
+@xorgcmd{v SPC,org-agenda-reset-view}
 @vindex org-agenda-span
 Switch to day/week/month/year view.  When switching to day or week view, this
 setting becomes the default for subsequent agenda refreshes.  Since month and
@@ -9103,8 +9102,8 @@ Toggle the time grid on and off.  See also the variables
 @c
 @orgcmd{r,org-agenda-redo}
 Recreate the agenda buffer, for example to reflect the changes after
-modification of the timestamps of items with @kbd{S-@key{LEFT}} and
-@kbd{S-@key{RIGHT}}.  When the buffer is the global TODO list, a prefix
+modification of the timestamps of items with @kbd{S-@key{left}} and
+@kbd{S-@key{right}}.  When the buffer is the global TODO list, a prefix
 argument is interpreted to create a selective list for a specific TODO
 keyword.
 @orgcmd{g,org-agenda-redo}
@@ -9168,8 +9167,8 @@ both in the agenda buffer and in the remote buffer.
 Change the TODO state of the item, both in the agenda and in the
 original org file.
 @c
-@orgcmd{C-S-@key{RIGHT},org-agenda-todo-nextset}
-@orgcmd{C-S-@key{LEFT},org-agenda-todo-previousset}
+@orgcmd{C-S-@key{right},org-agenda-todo-nextset}
+@orgcmd{C-S-@key{left},org-agenda-todo-previousset}
 Switch to the next/previous set of TODO keywords.
 @c
 @orgcmd{C-k,org-agenda-kill}
@@ -9219,12 +9218,12 @@ the priority cookie is removed from the entry.
 @orgcmd{P,org-agenda-show-priority}
 Display weighted priority of current item.
 @c
-@orgcmdkkc{+,S-@key{UP},org-agenda-priority-up}
+@orgcmdkkc{+,S-@key{up},org-agenda-priority-up}
 Increase the priority of the current item.  The priority is changed in
 the original buffer, but the agenda is not resorted.  Use the @kbd{r}
 key for this.
 @c
-@orgcmdkkc{-,S-@key{DOWN},org-agenda-priority-down}
+@orgcmdkkc{-,S-@key{down},org-agenda-priority-down}
 Decrease the priority of the current item.
 @c
 @orgcmdkkc{z,C-c C-z,org-agenda-add-note}
@@ -9242,19 +9241,19 @@ Schedule this item.  With prefix arg remove the scheduling timestamp
 @orgcmd{C-c C-d,org-agenda-deadline}
 Set a deadline for this item.  With prefix arg remove the deadline.
 @c
-@orgcmd{S-@key{RIGHT},org-agenda-do-date-later}
+@orgcmd{S-@key{right},org-agenda-do-date-later}
 Change the timestamp associated with the current line by one day into the
 future.  If the date is in the past, the first call to this command will move
 it to today.@*
 With a numeric prefix argument, change it by that many days.  For example,
-@kbd{3 6 5 S-@key{RIGHT}} will change it by a year.  With a @kbd{C-u} prefix,
+@kbd{3 6 5 S-@key{right}} will change it by a year.  With a @kbd{C-u} prefix,
 change the time by one hour.  If you immediately repeat the command, it will
 continue to change hours even without the prefix arg.  With a double @kbd{C-u
 C-u} prefix, do the same for changing minutes.@*
 The stamp is changed in the original Org file, but the change is not directly
 reflected in the agenda buffer.  Use @kbd{r} or @kbd{g} to update the buffer.
 @c
-@orgcmd{S-@key{LEFT},org-agenda-do-date-earlier}
+@orgcmd{S-@key{left},org-agenda-do-date-earlier}
 Change the timestamp associated with the current line by one day
 into the past.
 @c
@@ -9424,7 +9423,7 @@ calendars.
 @orgcmd{H,org-agenda-holidays}
 Show holidays for three months around the cursor date.
 
-@item M-x org-icalendar-combine-agenda-files @key{RET}
+@item M-x org-icalendar-combine-agenda-files RET
 Export a single iCalendar file containing entries from all agenda files.
 This is a globally available command, and also available in the agenda menu.
 
@@ -9861,7 +9860,7 @@ does not have a specific format---defined in a property, or in its file---it
 uses @code{org-columns-default-format}.
 
 @item
-@cindex property, special, @code{CLOCKSUM}
+@cindex property, special, CLOCKSUM
 If any of the columns has a summary type defined (@pxref{Column attributes}),
 turning on column view in the agenda will visit all relevant agenda files and
 make sure that the computations of this property are up to date.  This is
@@ -9885,7 +9884,7 @@ clocked time in the displayed period use clock table mode (press @kbd{R} in
 the agenda).
 
 @item
-@cindex property, special, @code{CLOCKSUM_T}
+@cindex property, special, CLOCKSUM_T
 When the column view in the agenda shows the @code{CLOCKSUM_T}, that is
 always today's clocked time for this item.  So even in the weekly agenda, the
 clocksum listed in column view only originates from today.  This lets you
@@ -9925,7 +9924,7 @@ To preserve the line breaks, indentation and blank lines in a region, but
 otherwise use normal formatting, you can use this construct, which can also
 be used to format poetry.
 
-@cindex @code{#+BEGIN_VERSE}
+@cindex #+BEGIN_VERSE
 @cindex verse blocks
 @example
 #+BEGIN_VERSE
@@ -9941,7 +9940,7 @@ When quoting a passage from another document, it is customary to format this
 as a paragraph that is indented on both the left and the right margin.  You
 can include quotations in Org mode documents like this:
 
-@cindex @code{#+BEGIN_QUOTE}
+@cindex #+BEGIN_QUOTE
 @cindex quote blocks
 @example
 #+BEGIN_QUOTE
@@ -9951,7 +9950,7 @@ but not any simpler -- Albert Einstein
 @end example
 
 If you would like to center some text, do it like this:
-@cindex @code{#+BEGIN_CENTER}
+@cindex #+BEGIN_CENTER
 @cindex center blocks
 @example
 #+BEGIN_CENTER
@@ -9995,8 +9994,8 @@ a horizontal line.
 @section Images and Tables
 
 @cindex tables, markup rules
-@cindex @code{#+CAPTION}
-@cindex @code{#+NAME}
+@cindex #+CAPTION
+@cindex #+NAME
 Both the native Org mode tables (@pxref{Tables}) and tables formatted with
 the @file{table.el} package will be exported properly.  For Org mode tables,
 the lines before the first horizontal separator line will become table header
@@ -10047,7 +10046,7 @@ or may not be handled.
 You can include literal examples that should not be subjected to
 markup.  Such examples will be typeset in monospace, so this is well suited
 for source code and similar examples.
-@cindex @code{#+BEGIN_EXAMPLE}
+@cindex #+BEGIN_EXAMPLE
 
 @example
 #+BEGIN_EXAMPLE
@@ -10086,7 +10085,7 @@ example@footnote{Code in @samp{src} blocks may also be evaluated either
 interactively or on export.  @xref{Working with source code}, for more
 information on evaluating code blocks.}, see @ref{Easy templates} for
 shortcuts to easily insert code blocks.
-@cindex @code{#+BEGIN_SRC}
+@cindex #+BEGIN_SRC
 
 @example
 #+BEGIN_SRC emacs-lisp
@@ -10235,7 +10234,7 @@ for display purposes only.
 @cindex dash, special symbol
 @cindex ellipsis, special symbol
 In addition to regular entities defined above, Org exports in a special
-way@footnote{This behavior can be disabled with @code{-} export setting
+way@footnote{This behaviour can be disabled with @code{-} export setting
 (@pxref{Export settings}).} the following commonly used character
 combinations: @samp{\-} is treated as a shy hyphen, @samp{--} and @samp{---}
 are converted into dashes, and @samp{...} becomes a compact set of dots.
@@ -10408,14 +10407,14 @@ To disable it, simply use
 
 CD@LaTeX{} mode is a minor mode that is normally used in combination with a
 major @LaTeX{} mode like AUC@TeX{} in order to speed-up insertion of
-environments and math templates.  Inside Org mode, you can make use of some
-of the features of CD@LaTeX{} mode.  You need to install @file{cdlatex.el}
-and @file{texmathp.el} (the latter comes also with AUC@TeX{}) from
-@url{https://staff.fnwi.uva.nl/c.dominik/Tools/cdlatex}.  Don't use
-CD@LaTeX{} mode itself under Org mode, but use the light version
-@code{org-cdlatex-mode} that comes as part of Org mode.  Turn it on for the
-current buffer with @kbd{M-x org-cdlatex-mode @key{RET}}, or for all Org
-files with
+environments and math templates.  Inside Org mode, you can make use of
+some of the features of CD@LaTeX{} mode.  You need to install
+@file{cdlatex.el} and @file{texmathp.el} (the latter comes also with
+AUC@TeX{}) from @url{https://staff.fnwi.uva.nl/c.dominik/Tools/cdlatex}.
+Don't use CD@LaTeX{} mode itself under Org mode, but use the light
+version @code{org-cdlatex-mode} that comes as part of Org mode.  Turn it
+on for the current buffer with @kbd{M-x org-cdlatex-mode RET}, or for all
+Org files with
 
 @lisp
 (add-hook 'org-mode-hook 'turn-on-org-cdlatex)
@@ -10428,7 +10427,7 @@ details see the documentation of CD@LaTeX{} mode):
 @item
 Environment templates can be inserted with @kbd{C-c @{}.
 @item
-@kindex TAB
+@kindex @key{TAB}
 The @key{TAB} key will do template expansion if the cursor is inside a
 @LaTeX{} fragment@footnote{Org mode has a method to test if the cursor is
 inside such a fragment, see the documentation of the function
@@ -10439,8 +10438,7 @@ the second brace.  Even outside fragments, @key{TAB} will expand
 environment abbreviations at the beginning of a line.  For example, if
 you write @samp{equ} at the beginning of a line and press @key{TAB},
 this abbreviation will be expanded to an @code{equation} environment.
-To get a list of all abbreviations, type @kbd{M-x cdlatex-command-help
-@key{RET}}.
+To get a list of all abbreviations, type @kbd{M-x cdlatex-command-help RET}.
 @item
 @kindex _
 @kindex ^
@@ -10602,7 +10600,7 @@ Org document by adjusting outline visibility settings.
 @section Export settings
 @cindex Export, settings
 
-@cindex @code{#+OPTIONS}
+@cindex #+OPTIONS
 Export options can be set: globally with variables; for an individual file by
 making variables buffer-local with in-buffer settings (@pxref{In-buffer
 settings}), by setting individual keywords, or by specifying them in a
@@ -10610,7 +10608,7 @@ compact form with the @code{#+OPTIONS} keyword; or for a tree by setting
 properties (@pxref{Properties and columns}).  Options set at a specific level
 override options set at a more general level.
 
-@cindex @code{#+SETUPFILE}
+@cindex #+SETUPFILE
 In-buffer settings may appear anywhere in the file, either directly or
 indirectly through a file included using @samp{#+SETUPFILE: filename or URL}
 syntax.  Option keyword sets tailored to a particular back-end can be
@@ -10618,37 +10616,37 @@ inserted from the export dispatcher (@pxref{The export dispatcher}) using the
 @code{Insert template} command by pressing @key{#}.  To insert keywords
 individually, a good way to make sure the keyword is correct is to type
 @code{#+} and then to use @kbd{M-@key{TAB}}@footnote{Many desktops intercept
-@kbd{M-@key{TAB}} to switch windows.  Use @kbd{C-M-i} or @kbd{@key{ESC}
-@key{TAB}} instead.} for completion.
+@kbd{M-TAB} to switch windows.  Use @kbd{C-M-i} or @kbd{@key{ESC} @key{TAB}}
+instead.} for completion.
 
 The export keywords available for every back-end, and their equivalent global
 variables, include:
 
 @table @samp
 @item AUTHOR
-@cindex @code{#+AUTHOR}
+@cindex #+AUTHOR
 @vindex user-full-name
 The document author (@code{user-full-name}).
 
 @item CREATOR
-@cindex @code{#+CREATOR}
+@cindex #+CREATOR
 @vindex org-export-creator-string
 Entity responsible for output generation (@code{org-export-creator-string}).
 
 @item DATE
-@cindex @code{#+DATE}
+@cindex #+DATE
 @vindex org-export-date-timestamp-format
 A date or a time-stamp@footnote{The variable
 @code{org-export-date-timestamp-format} defines how this time-stamp will be
 exported.}.
 
 @item EMAIL
-@cindex @code{#+EMAIL}
+@cindex #+EMAIL
 @vindex user-mail-address
 The email address (@code{user-mail-address}).
 
 @item LANGUAGE
-@cindex @code{#+LANGUAGE}
+@cindex #+LANGUAGE
 @vindex org-export-default-language
 Language to use for translating certain strings
 (@code{org-export-default-language}).  With @samp{#+LANGUAGE: fr}, for
@@ -10656,7 +10654,7 @@ example, Org translates @emph{Table of contents} to the French @emph{Table
 des matières}.
 
 @item SELECT_TAGS
-@cindex @code{#+SELECT_TAGS}
+@cindex #+SELECT_TAGS
 @vindex org-export-select-tags
 The default value is @code{:export:}.  When a tree is tagged with
 @code{:export:} (@code{org-export-select-tags}), Org selects that tree and
@@ -10665,7 +10663,7 @@ see below.  When selectively exporting files with @code{:export:} tags set,
 Org does not export any text that appears before the first headline.
 
 @item EXCLUDE_TAGS
-@cindex @code{#+EXCLUDE_TAGS}
+@cindex #+EXCLUDE_TAGS
 @vindex org-export-exclude-tags
 The default value is @code{:noexport:}.  When a tree is tagged with
 @code{:noexport:} (@code{org-export-exclude-tags}), Org excludes that tree
@@ -10675,12 +10673,12 @@ unconditionally excluded from the export, even if they have an
 code blocks contained in them.
 
 @item TITLE
-@cindex @code{#+TITLE}
+@cindex #+TITLE
 @cindex document title
 Org displays this title.  For long titles, use multiple @code{#+TITLE} lines.
 
 @item EXPORT_FILE_NAME
-@cindex @code{#+EXPORT_FILE_NAME}
+@cindex #+EXPORT_FILE_NAME
 The name of the output file to be generated.  Otherwise, Org generates the
 file name based on the buffer name and the extension based on the back-end
 format.
@@ -10786,7 +10784,7 @@ Toggle inclusion of inlinetasks (@code{org-export-with-inlinetasks}).
 
 @item num:
 @vindex org-export-with-section-numbers
-@cindex property, @code{UNNUMBERED}
+@cindex property, UNNUMBERED
 Toggle section-numbers (@code{org-export-with-section-numbers}).  When set to
 number @samp{n}, Org numbers only those headlines at level @samp{n} or above.
 Setting @code{UNNUMBERED} property to non-@code{nil} disables numbering of
@@ -10862,7 +10860,7 @@ respectively, @samp{EXPORT_DATE} and @samp{EXPORT_FILE_NAME}.  Except for
 @samp{SETUPFILE}, all other keywords listed above have an @samp{EXPORT_}
 equivalent.
 
-@cindex @code{#+BIND}
+@cindex #+BIND
 @vindex org-export-allow-bind-keywords
 If @code{org-export-allow-bind-keywords} is non-@code{nil}, Emacs variables
 can become buffer-local during export by using the BIND keyword.  Its syntax
@@ -10875,7 +10873,7 @@ settings that cannot be changed using keywords.
 @cindex list of tables
 @cindex list of listings
 
-@cindex @code{#+TOC}
+@cindex #+TOC
 @vindex org-export-with-toc
 Org normally inserts the table of contents directly before the first headline
 of the file.  Org sets the TOC depth the same as the headline levels in the
@@ -10921,7 +10919,7 @@ with captions.
 #+TOC: tables             @r{build a list of tables}
 @end example
 
-@cindex property, @code{ALT_TITLE}
+@cindex property, ALT_TITLE
 Normally Org uses the headline for its entry in the table of contents.  But
 with @code{ALT_TITLE} property, a different entry can be specified for the
 table of contents.
@@ -10931,7 +10929,7 @@ table of contents.
 @cindex include files, during export
 Include other files during export.  For example, to include your @file{.emacs}
 file, you could use:
-@cindex @code{#+INCLUDE}
+@cindex #+INCLUDE
 
 @example
 #+INCLUDE: "~/.emacs" src emacs-lisp
@@ -11003,7 +11001,7 @@ Visit the include file at point.
 @node Macro replacement
 @section Macro replacement
 @cindex macro replacement, during export
-@cindex @code{#+MACRO}
+@cindex #+MACRO
 
 @vindex org-export-global-macros
 Macros replace text snippets during export.  Macros are defined globally in
@@ -11095,9 +11093,9 @@ Lines starting with zero or more whitespace characters followed by one
 @samp{#} and a whitespace are treated as comments and, as such, are not
 exported.
 
-@cindex @code{#+BEGIN_COMMENT}
-Likewise, regions surrounded by @code{#+BEGIN_COMMENT}
-... @code{#+END_COMMENT} are not exported.
+@cindex #+BEGIN_COMMENT
+Likewise, regions surrounded by @samp{#+BEGIN_COMMENT}
+... @samp{#+END_COMMENT} are not exported.
 
 @cindex comment trees
 Finally, a @samp{COMMENT} keyword at the beginning of an entry, but after any
@@ -11153,7 +11151,7 @@ settings}).
 
 @table @samp
 @item SUBTITLE
-@cindex @code{#+SUBTITLE} (ASCII)
+@cindex #+SUBTITLE (ASCII)
 The document subtitle.  For long subtitles, use multiple @code{#+SUBTITLE}
 lines in the Org file.  Org prints them on one continuous line, wrapping into
 multiple lines if necessary.
@@ -11170,8 +11168,8 @@ where levels become lists, @pxref{Export settings}.
 To insert text within the Org file by the ASCII back-end, use one the
 following constructs, inline, keyword, or export block:
 
-@cindex @code{#+ASCII}
-@cindex @code{#+BEGIN_EXPORT ascii}
+@cindex #+ASCII
+@cindex #+BEGIN_EXPORT ascii
 @example
 Inline text @@@@ascii:and additional text@@@@ within a paragraph.
 
@@ -11183,7 +11181,7 @@ Org exports text in this block only when using ASCII back-end.
 @end example
 
 @subheading ASCII specific attributes
-@cindex @code{#+ATTR_ASCII}
+@cindex #+ATTR_ASCII
 @cindex horizontal rules, in ASCII export
 
 ASCII back-end recognizes only one attribute, @code{:width}, which specifies
@@ -11197,8 +11195,8 @@ syntax for specifying widths is:
 
 @subheading ASCII special blocks
 @cindex special blocks, in ASCII export
-@cindex @code{#+BEGIN_JUSTIFYLEFT}
-@cindex @code{#+BEGIN_JUSTIFYRIGHT}
+@cindex #+BEGIN_JUSTIFYLEFT
+@cindex #+BEGIN_JUSTIFYRIGHT
 
 Besides @code{#+BEGIN_CENTER} blocks (@pxref{Paragraphs}), ASCII back-end has
 these two left and right justification blocks:
@@ -11256,7 +11254,7 @@ output.  These keywords work similar to the general options settings
 
 @table @samp
 @item BEAMER_THEME
-@cindex @code{#+BEAMER_THEME}
+@cindex #+BEAMER_THEME
 @vindex org-beamer-theme
 The Beamer layout theme (@code{org-beamer-theme}).  Use square brackets for
 options.  For example:
@@ -11265,24 +11263,24 @@ options.  For example:
 @end smallexample
 
 @item BEAMER_FONT_THEME
-@cindex @code{#+BEAMER_FONT_THEME}
+@cindex #+BEAMER_FONT_THEME
 The Beamer font theme.
 
 @item BEAMER_INNER_THEME
-@cindex @code{#+BEAMER_INNER_THEME}
+@cindex #+BEAMER_INNER_THEME
 The Beamer inner theme.
 
 @item BEAMER_OUTER_THEME
-@cindex @code{#+BEAMER_OUTER_THEME}
+@cindex #+BEAMER_OUTER_THEME
 The Beamer outer theme.
 
 @item BEAMER_HEADER
-@cindex @code{#+BEAMER_HEADER}
+@cindex #+BEAMER_HEADER
 Arbitrary lines inserted in the preamble, just before the @samp{hyperref}
 settings.
 
 @item DESCRIPTION
-@cindex @code{#+DESCRIPTION} (Beamer)
+@cindex #+DESCRIPTION (Beamer)
 The document description.  For long descriptions, use multiple
 @code{#+DESCRIPTION} keywords.  By default, @samp{hyperref} inserts
 @code{#+DESCRIPTION} as metadata.  Use @code{org-latex-hyperref-template} to
@@ -11290,7 +11288,7 @@ configure document metadata.  Use @code{org-latex-title-command} to configure
 typesetting of description as part of front matter.
 
 @item KEYWORDS
-@cindex @code{#+KEYWORDS} (Beamer)
+@cindex #+KEYWORDS (Beamer)
 The keywords for defining the contents of the document.  Use multiple
 @code{#+KEYWORDS} lines if necessary.  By default, @samp{hyperref} inserts
 @code{#+KEYWORDS} as metadata.  Use @code{org-latex-hyperref-template} to
@@ -11298,7 +11296,7 @@ configure document metadata.  Use @code{org-latex-title-command} to configure
 typesetting of keywords as part of front matter.
 
 @item SUBTITLE
-@cindex @code{#+SUBTITLE} (Beamer)
+@cindex #+SUBTITLE (Beamer)
 @vindex org-beamer-subtitle-format
 Document's subtitle.  For typesetting, use @code{org-beamer-subtitle-format}
 string.  Use @code{org-latex-hyperref-template} to configure document
@@ -11320,7 +11318,7 @@ Org headlines become Beamer frames when the heading level in Org is equal to
 @code{org-beamer-frame-level} or @code{H} value in an @code{OPTIONS} line
 (@pxref{Export settings}).
 
-@cindex property, @code{BEAMER_ENV}
+@cindex property, BEAMER_ENV
 Org overrides headlines to frames conversion for the current tree of an Org
 file if it encounters the @code{BEAMER_ENV} property set to @code{frame} or
 @code{fullframe}.  Org ignores whatever @code{org-beamer-frame-level} happens
@@ -11339,7 +11337,7 @@ aid and has no semantic relevance.}.  For valid values see
 @code{org-beamer-environments-extra}.
 
 @item
-@cindex property, @code{BEAMER_REF}
+@cindex property, BEAMER_REF
 If @code{BEAMER_ENV} is set to @code{appendix}, Org exports the entry as an
 appendix.  When set to @code{note}, Org exports the entry as a note within
 the frame or between frames, depending on the entry's heading level.  When
@@ -11353,8 +11351,8 @@ not its content.  This is useful for inserting content between frames.  It is
 also useful for properly closing a @code{column} environment.
 @end itemize
 
-@cindex property, @code{BEAMER_ACT}
-@cindex property, @code{BEAMER_OPT}
+@cindex property, BEAMER_ACT
+@cindex property, BEAMER_OPT
 When @code{BEAMER_ACT} is set for a headline, Org export translates that
 headline as an overlay or action specification.  When enclosed in square
 brackets, Org export makes the overlay specification a default.  Use
@@ -11363,7 +11361,7 @@ or block.  The Beamer export back-end wraps with appropriate angular or
 square brackets.  It also adds the @code{fragile} option for any code that may
 require a verbatim block.
 
-@cindex property, @code{BEAMER_COL}
+@cindex property, BEAMER_COL
 To create a column on the Beamer slide, use the @code{BEAMER_COL} property
 for its headline in the Org file.  Set the value of @code{BEAMER_COL} to a
 decimal number representing the fraction of the total text width.  Beamer
@@ -11378,8 +11376,8 @@ needs, use the @code{BEAMER_ENV} property.
 @node Beamer specific syntax
 @subsection Beamer specific syntax
 Since Org's Beamer export back-end is an extension of the @LaTeX{} back-end,
-it recognizes other @LaTeX{} specific syntax---for example, @code{#+LATEX:}
-or @code{#+ATTR_LATEX:}.  @xref{@LaTeX{} export}, for details.
+it recognizes other @LaTeX{} specific syntax---for example, @samp{#+LATEX:}
+or @samp{#+ATTR_LATEX:}.  @xref{@LaTeX{} export}, for details.
 
 Beamer export wraps the table of contents generated with @code{toc:t}
 @code{OPTION} keyword in a @code{frame} environment.  Beamer export does not
@@ -11392,8 +11390,8 @@ contents}).  Use square brackets for specifying options.
 
 Insert Beamer-specific code using the following constructs:
 
-@cindex @code{#+BEAMER}
-@cindex @code{#+BEGIN_EXPORT beamer}
+@cindex #+BEAMER
+@cindex #+BEGIN_EXPORT beamer
 @example
 #+BEAMER: \pause
 
@@ -11414,7 +11412,7 @@ this example:
 A *@@@@beamer:<2->@@@@useful* feature
 @end example
 
-@cindex @code{#+ATTR_BEAMER}
+@cindex #+ATTR_BEAMER
 Beamer export recognizes the @code{ATTR_BEAMER} keyword with the following
 attributes from Beamer configurations: @code{:environment} for changing local
 Beamer environment, @code{:overlay} for specifying Beamer overlays in angular
@@ -11538,66 +11536,66 @@ described in @ref{Export settings}.
 
 @table @samp
 @item DESCRIPTION
-@cindex @code{#+DESCRIPTION} (HTML)
+@cindex #+DESCRIPTION (HTML)
 This is the document's description, which the HTML exporter inserts it as a
 HTML meta tag in the HTML file.  For long descriptions, use multiple
 @code{#+DESCRIPTION} lines.  The exporter takes care of wrapping the lines
 properly.
 
 @item HTML_DOCTYPE
-@cindex @code{#+HTML_DOCTYPE}
+@cindex #+HTML_DOCTYPE
 @vindex org-html-doctype
 Specify the document type, for example: HTML5 (@code{org-html-doctype}).
 
 @item HTML_CONTAINER
-@cindex @code{#+HTML_CONTAINER}
+@cindex #+HTML_CONTAINER
 @vindex org-html-container-element
 Specify the HTML container, such as @samp{div}, for wrapping sections and
 elements (@code{org-html-container-element}).
 
 @item HTML_LINK_HOME
-@cindex @code{#+HTML_LINK_HOME}
+@cindex #+HTML_LINK_HOME
 @vindex org-html-link-home
 The URL for home link (@code{org-html-link-home}).
 
 @item HTML_LINK_UP
-@cindex @code{#+HTML_LINK_UP}
+@cindex #+HTML_LINK_UP
 @vindex org-html-link-up
 The URL for the up link of exported HTML pages (@code{org-html-link-up}).
 
 @item HTML_MATHJAX
-@cindex @code{#+HTML_MATHJAX}
+@cindex #+HTML_MATHJAX
 @vindex org-html-mathjax-options
 Options for MathJax (@code{org-html-mathjax-options}).  MathJax is used to
 typeset @LaTeX{} math in HTML documents.  @xref{Math formatting in HTML
 export}, for an example.
 
 @item HTML_HEAD
-@cindex @code{#+HTML_HEAD}
+@cindex #+HTML_HEAD
 @vindex org-html-head
 Arbitrary lines for appending to the HTML document's head
 (@code{org-html-head}).
 
 @item HTML_HEAD_EXTRA
-@cindex @code{#+HTML_HEAD_EXTRA}
+@cindex #+HTML_HEAD_EXTRA
 @vindex org-html-head-extra
 More arbitrary lines for appending to the HTML document's head
 (@code{org-html-head-extra}).
 
 @item KEYWORDS
-@cindex @code{#+KEYWORDS} (HTML)
+@cindex #+KEYWORDS (HTML)
 Keywords to describe the document's content.  HTML exporter inserts these
 keywords as HTML meta tags.  For long keywords, use multiple
 @code{#+KEYWORDS} lines.
 
 @item LATEX_HEADER
-@cindex @code{#+LATEX_HEADER} (HTML)
+@cindex #+LATEX_HEADER (HTML)
 Arbitrary lines for appending to the preamble; HTML exporter appends when
 transcoding @LaTeX{} fragments to images (@pxref{Math formatting in HTML
 export}).
 
 @item SUBTITLE
-@cindex @code{#+SUBTITLE} (HTML)
+@cindex #+SUBTITLE (HTML)
 The document's subtitle.  HTML exporter formats subtitle if document type is
 @samp{HTML5} and the CSS has a @samp{subtitle} class.
 @end table
@@ -11731,13 +11729,14 @@ back-end can insert that HTML code in the output, use this inline syntax:
 text@@@@html:</b>@@@@}.  For larger raw HTML code blocks, use these HTML
 export code blocks:
 
-@cindex @code{#+HTML}
+@cindex #+HTML
+@cindex #+BEGIN_EXPORT html
 @example
 #+HTML: Literal HTML code for export
 @end example
 
 @noindent or
-@cindex @code{#+BEGIN_EXPORT html}
+@cindex #+BEGIN_EXPORT html
 
 @example
 #+BEGIN_EXPORT html
@@ -11774,7 +11773,7 @@ example, by using @code{#+ATTR_HTML} lines to specify new format attributes
 to @code{<a>} or @code{<img>} tags.  This example shows changing the link's
 @code{title} and @code{style}:
 
-@cindex @code{#+ATTR_HTML}
+@cindex #+ATTR_HTML
 @example
 #+ATTR_HTML: :title The Org mode homepage :style color:red;
 [[http://orgmode.org]]
@@ -11790,8 +11789,8 @@ exporting Org tables to HTML.  By default, the exporter does not draw frames
 and cell borders.  To change for this for a table, use the following lines
 before the table in the Org file:
 
-@cindex @code{#+CAPTION}
-@cindex @code{#+ATTR_HTML}
+@cindex #+CAPTION
+@cindex #+ATTR_HTML
 @example
 #+CAPTION: This is a table with lines around and between cells
 #+ATTR_HTML: :border 2 :rules all :frame border
@@ -11864,8 +11863,8 @@ Org file.  This example shows realignment to right, and adds @code{alt} and
 @code{title} attributes in support of text viewers and modern web accessibility
 standards.
 
-@cindex @code{#+CAPTION}
-@cindex @code{#+ATTR_HTML}
+@cindex #+CAPTION
+@cindex #+ATTR_HTML
 @example
 #+CAPTION: A black cat stalking a spider
 #+ATTR_HTML: :alt cat/spider image :title Action! :align right
@@ -11974,7 +11973,7 @@ p.creator           @r{creator info, about org mode version}
 .done               @r{the DONE keywords, all states that count as done}
 .WAITING            @r{each TODO keyword also uses a class named after itself}
 .timestamp          @r{timestamp}
-.timestamp-kwd      @r{keyword associated with a timestamp, like @code{SCHEDULED}}
+.timestamp-kwd      @r{keyword associated with a timestamp, like SCHEDULED}
 .timestamp-wrapper  @r{span around keyword plus timestamp}
 .tag                @r{tag in a headline}
 ._HOME              @r{each tag uses itself as a class, "@@" replaced by "_"}
@@ -12002,14 +12001,14 @@ p.footnote          @r{footnote definition paragraph, containing a footnote}
 @vindex org-html-head-include-default-style
 @vindex org-html-head
 @vindex org-html-head-extra
-@cindex @code{#+HTML_INCLUDE_STYLE}
+@cindex #+HTML_INCLUDE_STYLE
 The HTML export back-end includes a compact default style in each exported
 HTML file.  To override the default style with another style, use these
 keywords in the Org file.  They will replace the global defaults the HTML
 exporter uses.
 
-@cindex @code{#+HTML_HEAD}
-@cindex @code{#+HTML_HEAD_EXTRA}
+@cindex #+HTML_HEAD
+@cindex #+HTML_HEAD_EXTRA
 @example
 #+HTML_HEAD: <link rel="stylesheet" type="text/css" href="style1.css" />
 #+HTML_HEAD_EXTRA: <link rel="alternate stylesheet" type="text/css" href="style2.css" />
@@ -12059,7 +12058,7 @@ it on your own web server.
 
 To use this program, just add this line to the Org file:
 
-@cindex @code{#+INFOJS_OPT}
+@cindex #+INFOJS_OPT
 @example
 #+INFOJS_OPT: view:info toc:nil
 @end example
@@ -12180,7 +12179,7 @@ The @LaTeX{} export back-end has several additional keywords for customizing
 
 @table @samp
 @item DESCRIPTION
-@cindex @code{#+DESCRIPTION} (@LaTeX{})
+@cindex #+DESCRIPTION (@LaTeX{})
 The document's description.  The description along with author name,
 keywords, and related file metadata are inserted in the output file by the
 @samp{hyperref} package.  See @code{org-latex-hyperref-template} for
@@ -12189,7 +12188,7 @@ typesetting description into the document's front matter.  Use multiple
 @code{#+DESCRIPTION} lines for long descriptions.
 
 @item LATEX_CLASS
-@cindex @code{#+LATEX_CLASS}
+@cindex #+LATEX_CLASS
 @vindex org-latex-default-class
 @vindex org-latex-classes
 This is @LaTeX{} document class, such as @code{article}, @code{report},
@@ -12200,32 +12199,32 @@ default class name from the @code{org-latex-default-class} variable.  Org has
 element of @code{org-latex-classes}.
 
 @item LATEX_CLASS_OPTIONS
-@cindex @code{#+LATEX_CLASS_OPTIONS}
+@cindex #+LATEX_CLASS_OPTIONS
 Options the @LaTeX{} export back-end uses when calling the @LaTeX{} document
 class.
 
 @item LATEX_COMPILER
-@cindex @code{#+LATEX_COMPILER}
+@cindex #+LATEX_COMPILER
 @vindex org-latex-compiler
 The compiler, such as @samp{pdflatex}, @samp{xelatex}, @samp{lualatex}, for
 producing the PDF (@code{org-latex-compiler}).
 
 @item LATEX_HEADER
-@cindex @code{#+LATEX_HEADER}
+@cindex #+LATEX_HEADER
 @vindex org-latex-classes
 Arbitrary lines to add to the document's preamble, before the @samp{hyperref}
 settings.  See @code{org-latex-classes} for adjusting the structure and order
 of the @LaTeX{} headers.
 
 @item LATEX_HEADER_EXTRA
-@cindex @code{#+LATEX_HEADER_EXTRA}
+@cindex #+LATEX_HEADER_EXTRA
 @vindex org-latex-classes
 Arbitrary lines to add to the document's preamble, before the @samp{hyperref}
 settings.  See @code{org-latex-classes} for adjusting the structure and order
 of the @LaTeX{} headers.
 
 @item KEYWORDS
-@cindex @code{#+KEYWORDS} (@LaTeX{})
+@cindex #+KEYWORDS (@LaTeX{})
 The keywords for the document.  The description along with author name,
 keywords, and related file metadata are inserted in the output file by the
 @samp{hyperref} package.  See @code{org-latex-hyperref-template} for
@@ -12234,7 +12233,7 @@ typesetting description into the document's front matter.  Use multiple
 @code{#+KEYWORDS} lines if necessary.
 
 @item SUBTITLE
-@cindex @code{#+SUBTITLE} (@LaTeX{})
+@cindex #+SUBTITLE (@LaTeX{})
 @vindex org-latex-subtitle-separate
 @vindex org-latex-subtitle-format
 The document's subtitle.  It is typeset as per
@@ -12276,10 +12275,10 @@ exporter splices the values of @code{org-latex-default-packages-alist} and
 @code{org-latex-packages-alist}.  Use the same three variables to define
 custom sectioning or custom classes.
 
-@cindex @code{#+LATEX_CLASS}
-@cindex @code{#+LATEX_CLASS_OPTIONS}
-@cindex property, @code{EXPORT_LATEX_CLASS}
-@cindex property, @code{EXPORT_LATEX_CLASS_OPTIONS}
+@cindex #+LATEX_CLASS
+@cindex #+LATEX_CLASS_OPTIONS
+@cindex property, EXPORT_LATEX_CLASS
+@cindex property, EXPORT_LATEX_CLASS_OPTIONS
 The @LaTeX{} export back-end sends the @code{LATEX_CLASS_OPTIONS} keyword and
 @code{EXPORT_LATEX_CLASS_OPTIONS} property as options to the @LaTeX{}
 @code{\documentclass} macro.  The options and the syntax for specifying them,
@@ -12289,8 +12288,8 @@ including enclosing them in square brackets, follow @LaTeX{} conventions.
 #+LATEX_CLASS_OPTIONS: [a4paper,11pt,twoside,twocolumn]
 @end example
 
-@cindex @code{#+LATEX_HEADER}
-@cindex @code{#+LATEX_HEADER_EXTRA}
+@cindex #+LATEX_HEADER
+@cindex #+LATEX_HEADER_EXTRA
 The @LaTeX{} export back-end appends values from @code{LATEX_HEADER} and
 @code{LATEX_HEADER_EXTRA} keywords to the @LaTeX{} header.  The docstring for
 @code{org-latex-classes} explains in more detail.  Also note that @LaTeX{}
@@ -12324,14 +12323,14 @@ Code embedded in-line @@@@latex:any arbitrary LaTeX code@@@@ in a paragraph.
 @end example
 
 Inserting as one or more keyword lines in the Org file:
-@cindex @code{#+LATEX}
+@cindex #+LATEX
 @example
 #+LATEX: any arbitrary LaTeX code
 @end example
 
 Inserting as an export block in the Org file, where the back-end exports any
 code between begin and end markers:
-@cindex @code{#+BEGIN_EXPORT latex}
+@cindex #+BEGIN_EXPORT latex
 @example
 #+BEGIN_EXPORT latex
 any arbitrary LaTeX code
@@ -12341,7 +12340,7 @@ any arbitrary LaTeX code
 @node Tables in @LaTeX{} export
 @subsection Tables in @LaTeX{} export
 @cindex tables, in @LaTeX{} export
-@cindex @code{#+ATTR_LATEX}, in tables
+@cindex #+ATTR_LATEX, in tables
 
 The @LaTeX{} export back-end can pass several @LaTeX{} attributes for table
 contents and layout.  Besides specifying label and caption (@pxref{Images and
@@ -12445,7 +12444,7 @@ Set the caption with the @LaTeX{} command
 @subsection Images in @LaTeX{} export
 @cindex images, inline in @LaTeX{}
 @cindex inlining images in @LaTeX{}
-@cindex @code{#+ATTR_LATEX}, in images
+@cindex #+ATTR_LATEX, in images
 
 The @LaTeX{} export back-end processes image links in Org files that do not
 have descriptions, such as these links @samp{[[file:img.jpg]]} or
@@ -12515,7 +12514,7 @@ Set the @code{:comment-include} attribute to non-@code{nil} value for the
 @node Plain lists in @LaTeX{} export
 @subsection Plain lists in @LaTeX{} export
 @cindex plain lists, in @LaTeX{} export
-@cindex @code{#+ATTR_LATEX}, in plain lists
+@cindex #+ATTR_LATEX, in plain lists
 
 The @LaTeX{} export back-end accepts the @code{:environment} and
 @code{:options} attributes for plain lists.  Both attributes work together
@@ -12549,7 +12548,7 @@ four:
 @node Source blocks in @LaTeX{} export
 @subsection Source blocks in @LaTeX{} export
 @cindex source blocks, in @LaTeX{} export
-@cindex @code{#+ATTR_LATEX}, in source blocks
+@cindex #+ATTR_LATEX, in source blocks
 
 The @LaTeX{} export back-end can make source code blocks into floating
 objects through the attributes @code{:float} and @code{:options}.  For
@@ -12596,7 +12595,7 @@ variables.
 @subsection Example blocks in @LaTeX{} export
 @cindex example blocks, in @LaTeX{} export
 @cindex verbatim blocks, in @LaTeX{} export
-@cindex @code{#+ATTR_LATEX}, in example blocks
+@cindex #+ATTR_LATEX, in example blocks
 
 The @LaTeX{} export back-end wraps the contents of example blocks in a
 @samp{verbatim} environment.  To change this behavior to use another
@@ -12616,7 +12615,7 @@ This sentence is false.
 @cindex special blocks, in @LaTeX{} export
 @cindex abstract, in @LaTeX{} export
 @cindex proof, in @LaTeX{} export
-@cindex @code{#+ATTR_LATEX}, in special blocks
+@cindex #+ATTR_LATEX, in special blocks
 
 
 For other special blocks in the Org file, the @LaTeX{} export back-end makes
@@ -12664,7 +12663,7 @@ example:
 @node Horizontal rules in @LaTeX{} export
 @subsection Horizontal rules in @LaTeX{} export
 @cindex horizontal rules, in @LaTeX{} export
-@cindex @code{#+ATTR_LATEX}, in horizontal rules
+@cindex #+ATTR_LATEX, in horizontal rules
 
 The @LaTeX{} export back-end converts horizontal rules by the specified
 @code{:width} and @code{:thickness} attributes.  For example:
@@ -12748,10 +12747,10 @@ executable.  Without @file{zip}, export cannot finish.
 @anchor{x-export-to-odt}
 @cindex region, active
 @cindex active region
-@cindex @code{transient-mark-mode}
+@cindex transient-mark-mode
 @table @kbd
 @orgcmd{C-c C-e o o,org-odt-export-to-odt}
-@cindex property, @code{EXPORT_FILE_NAME}
+@cindex property EXPORT_FILE_NAME
 
 Export as OpenDocument Text file.
 
@@ -12788,13 +12787,13 @@ output.  Setting these keywords works similar to the general options
 
 @table @samp
 @item DESCRIPTION
-@cindex @code{#+DESCRIPTION} (ODT)
+@cindex #+DESCRIPTION (ODT)
 This is the document's description, which the ODT export back-end inserts as
 document metadata.  For long descriptions, use multiple @code{#+DESCRIPTION}
 lines.
 
 @item KEYWORDS
-@cindex @code{#+KEYWORDS} (ODT)
+@cindex #+KEYWORDS (ODT)
 The keywords for the document.  The ODT export back-end inserts the
 description along with author name, keywords, and related file metadata as
 metadata in the output file.  Use multiple @code{#+KEYWORDS} lines if
@@ -12849,7 +12848,7 @@ generic commands:
 @vindex org-odt-convert
 @table @kbd
 
-@item M-x org-odt-convert @key{RET}
+@item M-x org-odt-convert RET
 Convert an existing document from one format to another.  With a prefix
 argument, opens the newly produced file.
 @end table
@@ -12883,7 +12882,7 @@ Open one, modify, and save as either OpenDocument Text (@file{.odt}) or
 OpenDocument Template (@file{.ott}) file.
 
 @item
-@cindex @code{#+ODT_STYLES_FILE}
+@cindex #+ODT_STYLES_FILE
 @vindex org-odt-styles-file
 Customize the variable @code{org-odt-styles-file} and point it to the
 newly created file.  For additional configuration options
@@ -12942,7 +12941,7 @@ back-end honors any table alignments and relative widths for columns
 Note that the ODT export back-end interprets column widths as weighted
 ratios, the default weight being 1.
 
-@cindex @code{#+ATTR_ODT}
+@cindex #+ATTR_ODT
 
 Specifying @code{:rel-width} property on an @code{#+ATTR_ODT} line controls
 the width of the table.  For example:
@@ -12999,7 +12998,7 @@ when clicked jumps to @uref{http://Orgmode.org} website, do the following
 
 @subsubheading Sizing and scaling of embedded images
 
-@cindex @code{#+ATTR_ODT}
+@cindex #+ATTR_ODT
 Control the size and scale of the embedded images with the @code{#+ATTR_ODT}
 attribute.
 
@@ -13055,7 +13054,7 @@ height:width ratio, do the following
 
 @subsubheading Anchoring of images
 
-@cindex @code{#+ATTR_ODT}
+@cindex #+ATTR_ODT
 The ODT export back-end can anchor images to @samp{"as-char"},
 @samp{"paragraph"}, or @samp{"page"}.  Set the preferred anchor using the
 @code{:anchor} property of the @code{#+ATTR_ODT} line.
@@ -13124,10 +13123,10 @@ To quickly verify the reliability of the @LaTeX{}-to-MathML converter, use
 the following commands:
 
 @table @kbd
-@item M-x org-odt-export-as-odf @key{RET}
+@item M-x org-odt-export-as-odf RET
 Convert a @LaTeX{} math snippet to an OpenDocument formula (@file{.odf}) file.
 
-@item M-x org-odt-export-as-odf-and-open @key{RET}
+@item M-x org-odt-export-as-odf-and-open RET
 Convert a @LaTeX{} math snippet to an OpenDocument formula (@file{.odf}) file
 and open the formula file with the system-registered application.
 @end table
@@ -13453,7 +13452,7 @@ This paragraph is specially formatted and uses bold text.
 @subsubheading Customizing tables in ODT export
 @cindex tables, in ODT export
 
-@cindex @code{#+ATTR_ODT}
+@cindex #+ATTR_ODT
 Override the default table format by specifying a custom table style with the
 @code{#+ATTR_ODT} line.  For a discussion on default formatting of tables
 @pxref{Tables in ODT export}.
@@ -13697,52 +13696,52 @@ Texinfo output.  Setting these keywords works similar to the general options
 @table @samp
 
 @item SUBTITLE
-@cindex @code{#+SUBTITLE} (Texinfo)
+@cindex #+SUBTITLE (Texinfo)
 The document subtitle.
 
 @item SUBAUTHOR
-@cindex @code{#+SUBAUTHOR}
+@cindex #+SUBAUTHOR
 The document subauthor.
 
 @item TEXINFO_FILENAME
-@cindex @code{#+TEXINFO_FILENAME}
+@cindex #+TEXINFO_FILENAME
 The Texinfo filename.
 
 @item TEXINFO_CLASS
-@cindex @code{#+TEXINFO_CLASS}
+@cindex #+TEXINFO_CLASS
 @vindex org-texinfo-default-class
 The default document class (@code{org-texinfo-default-class}), which must be
 a member of @code{org-texinfo-classes}.
 
 @item TEXINFO_HEADER
-@cindex @code{#+TEXINFO_HEADER}
+@cindex #+TEXINFO_HEADER
 Arbitrary lines inserted at the end of the header.
 
 @item TEXINFO_POST_HEADER
-@cindex @code{#+TEXINFO_POST_HEADER}
+@cindex #+TEXINFO_POST_HEADER
 Arbitrary lines inserted after the end of the header.
 
 @item TEXINFO_DIR_CATEGORY
-@cindex @code{#+TEXINFO_DIR_CATEGORY}
+@cindex #+TEXINFO_DIR_CATEGORY
 The directory category of the document.
 
 @item TEXINFO_DIR_TITLE
-@cindex @code{#+TEXINFO_DIR_TITLE}
+@cindex #+TEXINFO_DIR_TITLE
 The directory title of the document.
 
 @item TEXINFO_DIR_DESC
-@cindex @code{#+TEXINFO_DIR_DESC}
+@cindex #+TEXINFO_DIR_DESC
 The directory description of the document.
 
 @item TEXINFO_PRINTED_TITLE
-@cindex @code{#+TEXINFO_PRINTED_TITLE}
+@cindex #+TEXINFO_PRINTED_TITLE
 The printed title of the document.
 @end table
 
 @node Texinfo file header
 @subsection Texinfo file header
 
-@cindex @code{#+TEXINFO_FILENAME}
+@cindex #+TEXINFO_FILENAME
 After creating the header for a Texinfo file, the Texinfo back-end
 automatically generates a name and destination path for the Info file.  To
 override this default with a more sensible path and name, specify the
@@ -13750,8 +13749,8 @@ override this default with a more sensible path and name, specify the
 
 @vindex org-texinfo-coding-system
 @vindex org-texinfo-classes
-@cindex @code{#+TEXINFO_HEADER}
-@cindex @code{#+TEXINFO_CLASS}
+@cindex #+TEXINFO_HEADER
+@cindex #+TEXINFO_CLASS
 Along with the output's file name, the Texinfo header also contains language
 details (@pxref{Export settings}) and encoding system as set in the
 @code{org-texinfo-coding-system} variable.  Insert @code{#+TEXINFO_HEADER}
@@ -13765,14 +13764,14 @@ setting the @code{#+TEXINFO_CLASS} keyword to that class.
 @node Texinfo title and copyright page
 @subsection Texinfo title and copyright page
 
-@cindex @code{#+TEXINFO_PRINTED_TITLE}
+@cindex #+TEXINFO_PRINTED_TITLE
 The default template for hard copy output has a title page with
 @code{#+TITLE} and @code{#+AUTHOR} (@pxref{Export settings}).  To replace the
 regular @code{#+TITLE} with something different for the printed version, use
 the @code{#+TEXINFO_PRINTED_TITLE} and @code{#+SUBTITLE} keywords.  Both
 expect raw Texinfo code for setting their values.
 
-@cindex @code{#+SUBAUTHOR}
+@cindex #+SUBAUTHOR
 If one @code{#+AUTHOR} is not sufficient, add multiple @code{#+SUBAUTHOR}
 keywords.  They have to be set in raw Texinfo code.
 
@@ -13782,7 +13781,7 @@ keywords.  They have to be set in raw Texinfo code.
 #+TEXINFO_PRINTED_TITLE: This Long Title@@inlinefmt@{tex,@@*@} Is Broken in @@TeX@{@}
 @end example
 
-@cindex property, @code{COPYING}
+@cindex property, COPYING
 Copying material is defined in a dedicated headline with a non-@code{nil}
 @code{:COPYING:} property.  The back-end inserts the contents within a
 @code{@@copying} command at the beginning of the document.  The heading
@@ -13810,9 +13809,9 @@ Copyright information is printed on the back of the title page.
 @cindex @code{install-info} parameters, in Texinfo export
 @cindex Texinfo export, @code{install-info} parameters
 
-@cindex @code{#+TEXINFO_DIR_CATEGORY}
-@cindex @code{#+TEXINFO_DIR_TITLE}
-@cindex @code{#+TEXINFO_DIR_DESC}
+@cindex #+TEXINFO_DIR_CATEGORY
+@cindex #+TEXINFO_DIR_TITLE
+@cindex #+TEXINFO_DIR_DESC
 The end result of the Texinfo export process is the creation of an Info file.
 This Info file's metadata has variables for category, title, and description:
 @code{#+TEXINFO_DIR_CATEGORY}, @code{#+TEXINFO_DIR_TITLE}, and
@@ -13832,7 +13831,7 @@ Here is an example that writes to the Info directory file:
 
 @vindex org-texinfo-classes
 @vindex org-texinfo-default-class
-@cindex @code{#+TEXINFO_CLASS}
+@cindex #+TEXINFO_CLASS
 The Texinfo export back-end uses a pre-defined scheme to convert Org
 headlines to an equivalent Texinfo structuring commands.  A scheme like this
 maps top-level headlines to numbered chapters tagged as @code{@@chapter} and
@@ -13847,12 +13846,12 @@ If an Org headline's level has no associated Texinfo structuring command, or
 is below a certain threshold (@pxref{Export settings}), then the Texinfo
 export back-end makes it into a list item.
 
-@cindex property, @code{APPENDIX}
+@cindex property, APPENDIX
 The Texinfo export back-end makes any headline with a non-@code{nil}
 @code{:APPENDIX:} property into an appendix.  This happens independent of the
 Org headline level or the @code{#+TEXINFO_CLASS}.
 
-@cindex property, @code{DESCRIPTION}
+@cindex property, DESCRIPTION
 The Texinfo export back-end creates a menu entry after the Org headline for
 each regular sectioning structure.  To override this with a shorter menu
 entry, use the @code{:ALT_TITLE:} property (@pxref{Table of contents}).
@@ -13878,22 +13877,22 @@ Top Node,,texinfo}, for more information.
 @node Indices
 @subsection Indices
 
-@cindex @code{#+CINDEX}
+@cindex #+CINDEX
 @cindex concept index, in Texinfo export
 @cindex Texinfo export, index, concept
-@cindex @code{#+FINDEX}
+@cindex #+FINDEX
 @cindex function index, in Texinfo export
 @cindex Texinfo export, index, function
-@cindex @code{#+KINDEX}
+@cindex #+KINDEX
 @cindex keystroke index, in Texinfo export
 @cindex Texinfo export, keystroke index
-@cindex @code{#+PINDEX}
+@cindex #+PINDEX
 @cindex program index, in Texinfo export
 @cindex Texinfo export, program index
-@cindex @code{#+TINDEX}
+@cindex #+TINDEX
 @cindex data type index, in Texinfo export
 @cindex Texinfo export, data type index
-@cindex @code{#+VINDEX}
+@cindex #+VINDEX
 @cindex variable index, in Texinfo export
 @cindex Texinfo export, variable index
 The Texinfo export back-end recognizes these indexing keywords if used in the
@@ -13906,7 +13905,7 @@ escaped with @samp{@@} if they not belong to a Texinfo command.
 #+CINDEX: Defining indexing entries
 @end example
 
-@cindex property, @code{INDEX}
+@cindex property, INDEX
 For the back-end to generate an index entry for a headline, set the
 @code{:INDEX:} property to @samp{cp} or @samp{vr}.  These abbreviations come
 from Texinfo that stand for concept index and variable index.  The Texinfo
@@ -13926,8 +13925,8 @@ inserts the index after its contents.
 
 Use any of the following three methods to insert or escape raw Texinfo code:
 
-@cindex @code{#+TEXINFO}
-@cindex @code{#+BEGIN_EXPORT texinfo}
+@cindex #+TEXINFO
+@cindex #+BEGIN_EXPORT texinfo
 @example
 Richard @@@@texinfo:@@sc@{@@@@Stallman@@@@texinfo:@}@@@@ commence' GNU.
 
@@ -13942,10 +13941,10 @@ This paragraph is preceded by...
 
 @node Plain lists in Texinfo export
 @subsection Plain lists in Texinfo export
-@cindex @code{#+ATTR_TEXINFO}, in plain lists
+@cindex #+ATTR_TEXINFO, in plain lists
 @cindex Two-column tables, in Texinfo export
 
-@cindex @code{:table-type} attribute, in Texinfo export
+@cindex :table-type attribute, in Texinfo export
 The Texinfo export back-end by default converts description lists in the Org
 file using the default command @code{@@table}, which results in a table with
 two columns.  To change this behavior, specify @code{:table-type} with
@@ -13953,14 +13952,14 @@ two columns.  To change this behavior, specify @code{:table-type} with
 @inforef{Two-column Tables,,texinfo}.
 
 @vindex org-texinfo-table-default-markup
-@cindex @code{:indic} attribute, in Texinfo export
+@cindex :indic attribute, in Texinfo export
 The Texinfo export back-end by default also applies a text highlight based on
 the defaults stored in @code{org-texinfo-table-default-markup}.  To override
 the default highlight command, specify another one with the @code{:indic}
 attribute.
 
 @cindex Multiple entries in two-column tables, in Texinfo export
-@cindex @code{:sep} attribute, in Texinfo export
+@cindex :sep attribute, in Texinfo export
 Org syntax is limited to one entry per list item.  Nevertheless, the Texinfo
 export back-end can split that entry according to any text provided through
 the @code{:sep} attribute.  Each part then becomes a new entry in the first
@@ -13986,7 +13985,7 @@ This is the common text for variables foo and bar.
 
 @node Tables in Texinfo export
 @subsection Tables in Texinfo export
-@cindex @code{#+ATTR_TEXINFO}, in tables
+@cindex #+ATTR_TEXINFO, in tables
 
 When exporting tables, the Texinfo export back-end uses the widest cell width
 in each column.  To override this and instead specify as fractions of line
@@ -13999,7 +13998,7 @@ length, use the @code{:columns} attribute.  See example below.
 
 @node Images in Texinfo export
 @subsection Images in Texinfo export
-@cindex @code{#+ATTR_TEXINFO}, in images
+@cindex #+ATTR_TEXINFO, in images
 
 Insert a file link to the image in the Org file, and the Texinfo export
 back-end inserts the image.  These links must have the usual supported image
@@ -14014,7 +14013,7 @@ the text using Texinfo code, as shown in the example:
 
 @node Special blocks in Texinfo export
 @subsection Special blocks
-@cindex @code{#+ATTR_TEXINFO}, in special blocks
+@cindex #+ATTR_TEXINFO, in special blocks
 
 The Texinfo export back-end converts special blocks to commands with the same
 name.  It also adds any @code{:options} attributes to the end of the command,
@@ -14137,7 +14136,7 @@ configure the variable @code{org-icalendar-categories}.  To assign clock
 alarms based on time, configure the @code{org-icalendar-alarm-time} variable.
 
 @vindex org-icalendar-store-UID
-@cindex property, @code{ID}
+@cindex property, ID
 The iCalendar format standard requires globally unique identifier---UID---for
 each entry.  The iCalendar export back-end creates UIDs during export.  To
 save a copy of the UID in the Org file set the variable
@@ -14166,27 +14165,26 @@ and write it to @code{org-icalendar-combined-agenda-file} file name.
 
 @vindex org-use-property-inheritance
 @vindex org-icalendar-include-body
-@cindex property, @code{SUMMARY}
-@cindex property, @code{DESCRIPTION}
-@cindex property, @code{LOCATION}
-@cindex property, @code{TIMEZONE}
-The iCalendar export back-end includes @code{SUMMARY}, @code{DESCRIPTION},
-@code{LOCATION} and @code{TIMEZONE} properties from the Org entries when
-exporting.  To force the back-end to inherit the @code{LOCATION} and
-@code{TIMEZONE} properties, configure the @code{org-use-property-inheritance}
-variable.
-
-When Org entries do not have @code{SUMMARY}, @code{DESCRIPTION} and
-@code{LOCATION} properties, the iCalendar export back-end derives the summary
-from the headline, and derives the description from the body of the Org item.
-The @code{org-icalendar-include-body} variable limits the maximum number of
+@cindex property, SUMMARY
+@cindex property, DESCRIPTION
+@cindex property, LOCATION
+@cindex property, TIMEZONE
+The iCalendar export back-end includes SUMMARY, DESCRIPTION, LOCATION and
+TIMEZONE properties from the Org entries when exporting.  To force the
+back-end to inherit the LOCATION and TIMEZONE properties, configure the
+@code{org-use-property-inheritance} variable.
+
+When Org entries do not have SUMMARY, DESCRIPTION and LOCATION properties,
+the iCalendar export back-end derives the summary from the headline, and
+derives the description from the body of the Org item.  The
+@code{org-icalendar-include-body} variable limits the maximum number of
 characters of the content are turned into its description.
 
-The @code{TIMEZONE} property can be used to specify a per-entry time zone,
-and will be applied to any entry with timestamp information.  Time zones
-should be specified as per the IANA time zone database format, e.g.@:
-``Asia/Almaty''.  Alternately, the property value can be ``UTC'', to force
-UTC time for this entry only.
+The TIMEZONE property can be used to specify a per-entry time zone, and will
+be applied to any entry with timestamp information.  Time zones should be
+specified as per the IANA time zone database format, e.g.@: ``Asia/Almaty''.
+Alternately, the property value can be ``UTC'', to force UTC time for this
+entry only.
 
 Exporting to iCalendar format depends in large part on the capabilities of
 the destination application.  Some are more lenient than others.  Consult the
@@ -14431,7 +14429,7 @@ In-place conversions are particularly handy for quick conversion of tables
 and lists in foreign buffers.  For example, turn on the minor mode @code{M-x
 orgstruct-mode} in an HTML buffer, then use the convenient Org keyboard
 commands to create a list, select it, and covert it to HTML with @code{M-x
-org-html-convert-region-to-html @key{RET}}.
+org-html-convert-region-to-html RET}.
 
 
 @node Publishing
@@ -14475,7 +14473,7 @@ and many other properties of a project.
 
 @node Project alist
 @subsection The variable @code{org-publish-project-alist}
-@cindex @code{org-publish-project-alist}
+@cindex org-publish-project-alist
 @cindex projects, for publishing
 
 @vindex org-publish-project-alist
@@ -14931,7 +14929,7 @@ The file will be created when first publishing a project with the
 "theindex.inc"}.  You can then build around this include statement by adding
 a title, style information, etc.
 
-@cindex @code{#+INDEX}
+@cindex #+INDEX
 Index entries are specified with @code{#+INDEX} keyword.  An entry that
 contains an exclamation mark will create a sub item.
 
@@ -15102,8 +15100,8 @@ such as not inside comments and fixed width areas.  Here's a sample
 #+END_SRC
 @end example
 
-Org can take the code in the block between the @code{#+BEGIN_SRC} and
-@code{#+END_SRC} tags, and format, compile, execute, and show the results.
+Org can take the code in the block between the @samp{#+BEGIN_SRC} and
+@samp{#+END_SRC} tags, and format, compile, execute, and show the results.
 Org can simplify many housekeeping tasks essential to modern code
 maintenance.  That's why these blocks in Org mode literature are sometimes
 referred to as @samp{live code} blocks (as compared to the static text and
@@ -15112,7 +15110,7 @@ block by tweaking the headers for compiling, execution, extraction.
 
 Org's @samp{src} code block type is one of many block types, such as quote,
 export, verse, latex, example, and verbatim.  This section pertains to
-@code{src} code blocks between @code{#+BEGIN_SRC} and @code{#+END_SRC}
+@samp{src} code blocks between @samp{#+BEGIN_SRC} and @samp{#+END_SRC}
 
 For editing @samp{src} code blocks, Org provides native Emacs major-modes.
 That leverages the latest Emacs features for that source code language mode.
@@ -15174,8 +15172,8 @@ Details of Org's facilities for working with source code are shown next.
 @section Structure of code blocks
 @cindex code block, structure
 @cindex source code, block structure
-@cindex @code{#+NAME}
-@cindex @code{#+BEGIN_SRC}
+@cindex #+NAME
+@cindex #+BEGIN_SRC
 
 Org offers two ways to structure source code in Org documents: in a
 @samp{src} block, and directly inline.  Both specifications are shown below.
@@ -15217,7 +15215,7 @@ results.  Code from other blocks, other files, and from table formulas
 (@pxref{The spreadsheet}) can use the name to reference a @samp{src} block.
 This naming serves the same purpose as naming Org tables.  Org mode requires
 unique names.  For duplicate names, Org mode's behavior is undefined.
-@cindex @code{#+NAME}
+@cindex #+NAME
 @item #+BEGIN_SRC
 @item #+END_SRC
 Mandatory.  They mark the start and end of a block that Org requires.  The
@@ -15428,7 +15426,7 @@ block header arguments: One, set @code{padline} (@pxref{padline}) to true
 @section Evaluating code blocks
 @cindex code block, evaluating
 @cindex source code, evaluating
-@cindex @code{#+RESULTS}
+@cindex #+RESULTS
 
 A note about security: With code evaluation comes the risk of harm.  Org
 safeguards by prompting for user's permission before executing any code in
@@ -15451,7 +15449,7 @@ evaluation from the @kbd{C-c C-c} key binding.} calls the
 @code{org-babel-execute-src-block} function, which executes the code in the
 block, collects the results, and inserts them in the buffer.
 
-@cindex @code{#+CALL}
+@cindex #+CALL
 By calling a named code block@footnote{Actually, the constructs call_<name>()
 and src_<lang>@{@} are not evaluated when they appear in a keyword line
 (i.e. lines starting with @code{#+KEYWORD:}, @pxref{In-buffer settings}).}
@@ -15734,7 +15732,7 @@ each line.  Note that Org currently accepts the plural spelling of
 @code{#+HEADER:} only as a convenience for backward-compatibility.  It may be
 removed at some point.
 
-@cindex @code{#+HEADER:}
+@cindex #+HEADER:
 
 Multi-line header arguments on an unnamed @samp{src} code block:
 
@@ -16148,7 +16146,7 @@ Interpreted as raw Org mode.  Inserted directly into the buffer.  Aligned if
 it is a table.  Usage example: @code{:results value raw}.
 @item @code{org}
 Results enclosed in a @code{BEGIN_SRC org} block.  For comma-escape, either
-@key{TAB} in the block, or export the file.  Usage example: @code{:results
+@kbd{TAB} in the block, or export the file.  Usage example: @code{:results
 value org}.
 @item @code{html}
 Results enclosed in a @code{BEGIN_EXPORT html} block.  Usage example:
@@ -16235,7 +16233,7 @@ output file, @code{:dir} specifies the default directory during @samp{src}
 code block execution.  If it is absent, then the directory associated with
 the current buffer is used.  In other words, supplying @code{:dir path}
 temporarily has the same effect as changing the current directory with
-@kbd{M-x cd path @key{RET}}, and then not supplying @code{:dir}.  Under the
+@kbd{M-x cd path RET}, and then not supplying @code{:dir}.  Under the
 surface, @code{:dir} simply sets the value of the Emacs variable
 @code{default-directory}.
 
@@ -17129,10 +17127,10 @@ Active key bindings in code blocks:
 @item @kbd{C-c C-c} @tab @code{org-babel-execute-src-block}
 @kindex C-c C-o
 @item @kbd{C-c C-o} @tab @code{org-babel-open-src-block-result}
-@kindex M-UP
-@item @kbd{M-@key{UP}}    @tab @code{org-babel-load-in-session}
-@kindex M-DOWN
-@item @kbd{M-@key{DOWN}}  @tab @code{org-babel-switch-to-session}
+@kindex M-up
+@item @kbd{M-@key{up}}    @tab @code{org-babel-load-in-session}
+@kindex M-down
+@item @kbd{M-@key{down}}  @tab @code{org-babel-switch-to-session}
 @end multitable
 
 Active key bindings in Org mode buffer:
@@ -17249,12 +17247,12 @@ emacs -Q --batch --eval "
 @chapter Miscellaneous
 
 @menu
-* Completion::                  M-@key{TAB} guesses completions
+* Completion::                  M-TAB guesses completions
 * Easy templates::              Quick insertion of structural elements
 * Speed keys::                  Electric commands at the beginning of a headline
 * Code evaluation security::    Org mode files evaluate inline code
 * Customization::               Adapting Org to changing tastes
-* In-buffer settings::          Overview of the @code{#+KEYWORDS}
+* In-buffer settings::          Overview of the #+KEYWORDS
 * The very busy C-c C-c key::   When in doubt, press C-c C-c
 * Clean view::                  Getting rid of leading stars in the outline
 * TTY keys::                    Using Org on a tty
@@ -17288,7 +17286,7 @@ is involved.  Such mode-specific hot keys have become an integral part of
 Emacs and Org provides several shortcuts.
 
 @table @kbd
-@kindex M-TAB
+@kindex M-@key{TAB}
 @item M-@key{TAB}
 Complete word at point
 @itemize @bullet
@@ -17302,7 +17300,7 @@ can be used in search links like @samp{[[*find this headline]]}.
 @item
 After @samp{:} in a headline, complete tags.  The list of tags is taken
 from the variable @code{org-tag-alist} (possibly set through the
-@code{#+TAGS} in-buffer option, @pxref{Setting tags}), or it is created
+@samp{#+TAGS} in-buffer option, @pxref{Setting tags}), or it is created
 dynamically from all tags used in the current buffer.
 @item
 After @samp{:} and not in a headline, complete property keys.  The list
@@ -17315,7 +17313,7 @@ After @samp{#+}, complete the special keywords like @samp{TYP_TODO} or
 file-specific @samp{OPTIONS}.  After option keyword is complete, pressing
 @kbd{M-@key{TAB}} again will insert example settings for that option.
 @item
-After @code{#+STARTUP:}, complete startup keywords.
+After @samp{#+STARTUP: }, complete startup keywords.
 @item
 When the point is anywhere else, complete dictionary words using Ispell.
 @end itemize
@@ -17459,8 +17457,8 @@ Org executes formulas in tables (@pxref{The spreadsheet}) either through the
 @cindex variables, for customization
 
 Org has more than 500 variables for customization.  They can be accessed
-through the usual @kbd{M-x org-customize @key{RET}} command.  Or through the
-Org menu, @code{Org->Customization->Browse Org Group}.  Org also has per-file
+through the usual @kbd{M-x org-customize RET} command.  Or through the Org
+menu, @code{Org->Customization->Browse Org Group}.  Org also has per-file
 settings for some variables (@pxref{In-buffer settings}).
 
 @node In-buffer settings
@@ -17479,13 +17477,13 @@ reopening the Org file in Emacs also activates the changes.
 @table @kbd
 @item #+ARCHIVE: %s_done::
 Sets the archive location of the agenda file.  This location applies to the
-lines until the next @code{#+ARCHIVE} line, if any, in the Org file.  The
+lines until the next @samp{#+ARCHIVE} line, if any, in the Org file.  The
 first archive location in the Org file also applies to any entries before it.
 The corresponding variable is @code{org-archive-location}.
 @item #+CATEGORY:
 Sets the category of the agenda file, which applies to the entire document.
 @item #+COLUMNS: %25ITEM ...
-@cindex property, @code{COLUMNS}
+@cindex property, COLUMNS
 Sets the default format for columns view.  Org uses this format for column
 views where there is no @code{COLUMNS} property.
 @item #+CONSTANTS: name1=value1 ...
@@ -17512,7 +17510,7 @@ have a lower ASCII number than the lowest priority.
 @item #+PROPERTY: Property_Name Value
 This line sets a default inheritance value for entries in the current
 buffer, most useful for specifying the allowed values of a property.
-@cindex @code{#+SETUPFILE}
+@cindex #+SETUPFILE
 @item #+SETUPFILE: file or URL
 The setup file or a URL pointing to such file is for additional in-buffer
 settings.  Org loads this file and parses it for any settings in it only when
@@ -17524,7 +17522,7 @@ parses the contents of this document as if it was included in the buffer.  It
 can be another Org file.  To visit the file (not a URL), @kbd{C-c '} while
 the cursor is on the line with the file name.
 @item #+STARTUP:
-@cindex @code{#+STARTUP}
+@cindex #+STARTUP
 Startup options Org uses when first visiting a file.
 
 The first set of options deals with the initial visibility of the outline
@@ -17705,7 +17703,7 @@ fnadjust    @r{automatically renumber and sort footnotes}
 nofnadjust  @r{do not renumber and sort automatically}
 @end example
 
-@cindex @code{org-hide-block-startup}
+@cindex org-hide-block-startup
 To hide blocks on startup, use these keywords.  The corresponding variable is
 @code{org-hide-block-startup}.
 @cindex @code{hideblocks}, STARTUP keyword
@@ -17715,7 +17713,7 @@ hideblocks   @r{Hide all begin/end blocks on startup}
 nohideblocks @r{Do not hide blocks on startup}
 @end example
 
-@cindex @code{org-pretty-entities}
+@cindex org-pretty-entities
 The display of entities as UTF-8 characters is governed by the variable
 @code{org-pretty-entities} and the keywords
 @cindex @code{entitiespretty}, STARTUP keyword
@@ -17730,11 +17728,11 @@ entitiesplain   @r{Leave entities plain}
 These lines specify valid tags for this file.  Org accepts multiple tags
 lines.  Tags could correspond to the @emph{fast tag selection} keys.  The
 corresponding variable is @code{org-tag-alist}.
-@cindex @code{#+TBLFM}
+@cindex #+TBLFM
 @item #+TBLFM:
 This line is for formulas for the table directly above.  A table can have
-multiple @code{#+TBLFM:} lines.  On table recalculation, Org applies only the
-first @code{#+TBLFM:} line.  For details see @ref{Using multiple #+TBLFM
+multiple @samp{#+TBLFM:} lines.  On table recalculation, Org applies only the
+first @samp{#+TBLFM:} line.  For details see @ref{Using multiple #+TBLFM
 lines} in @ref{Editing and debugging formulas}.
 @item #+TITLE:, #+AUTHOR:, #+EMAIL:, #+LANGUAGE:, #+DATE:,
 @itemx #+OPTIONS:, #+BIND:,
@@ -17750,7 +17748,7 @@ The corresponding variable is @code{org-todo-keywords}.
 @node The very busy C-c C-c key
 @section The very busy C-c C-c key
 @kindex C-c C-c
-@cindex @kbd{C-c C-c}, overview
+@cindex C-c C-c, overview
 
 The @kbd{C-c C-c} key in Org serves many purposes depending on the context.
 It is probably the most over-worked, multi-purpose key combination in Org.
@@ -17914,8 +17912,7 @@ one of the following lines:
 @end example
 
 To switch between single and double stars layouts, use @kbd{M-x
-org-convert-to-odd-levels @key{RET}} and @kbd{M-x
-org-convert-to-oddeven-levels @key{RET}}.
+org-convert-to-odd-levels RET} and @kbd{M-x org-convert-to-oddeven-levels}.
 @end enumerate
 
 @node TTY keys
@@ -17932,23 +17929,23 @@ normal @kbd{S-@key{cursor}} for editing timestamp might be better with
 @multitable @columnfractions 0.15 0.2 0.1 0.2
 @item @b{Default} @tab @b{Alternative 1} @tab @b{Speed key} @tab @b{Alternative 2}
 @item @kbd{S-@key{TAB}}     @tab @kbd{C-u @key{TAB}}       @tab @kbd{C} @tab
-@item @kbd{M-@key{LEFT}}    @tab @kbd{C-c C-x l}           @tab @kbd{l} @tab @kbd{@key{Esc} @key{LEFT}}
-@item @kbd{M-S-@key{LEFT}}  @tab @kbd{C-c C-x L}           @tab @kbd{L} @tab
-@item @kbd{M-@key{RIGHT}}   @tab @kbd{C-c C-x r}           @tab @kbd{r} @tab @kbd{@key{Esc} @key{RIGHT}}
-@item @kbd{M-S-@key{RIGHT}} @tab @kbd{C-c C-x R}           @tab @kbd{R} @tab
-@item @kbd{M-@key{UP}}      @tab @kbd{C-c C-x u}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{UP}}
-@item @kbd{M-S-@key{UP}}    @tab @kbd{C-c C-x U}           @tab @kbd{U} @tab
-@item @kbd{M-@key{DOWN}}    @tab @kbd{C-c C-x d}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{DOWN}}
-@item @kbd{M-S-@key{DOWN}}  @tab @kbd{C-c C-x D}           @tab @kbd{D} @tab
+@item @kbd{M-@key{left}}    @tab @kbd{C-c C-x l}           @tab @kbd{l} @tab @kbd{@key{Esc} @key{left}}
+@item @kbd{M-S-@key{left}}  @tab @kbd{C-c C-x L}           @tab @kbd{L} @tab
+@item @kbd{M-@key{right}}   @tab @kbd{C-c C-x r}           @tab @kbd{r} @tab @kbd{@key{Esc} @key{right}}
+@item @kbd{M-S-@key{right}} @tab @kbd{C-c C-x R}           @tab @kbd{R} @tab
+@item @kbd{M-@key{up}}      @tab @kbd{C-c C-x u}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{up}}
+@item @kbd{M-S-@key{up}}    @tab @kbd{C-c C-x U}           @tab @kbd{U} @tab
+@item @kbd{M-@key{down}}    @tab @kbd{C-c C-x d}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{down}}
+@item @kbd{M-S-@key{down}}  @tab @kbd{C-c C-x D}           @tab @kbd{D} @tab
 @item @kbd{S-@key{RET}}     @tab @kbd{C-c C-x c}           @tab @kbd{ } @tab
 @item @kbd{M-@key{RET}}     @tab @kbd{C-c C-x m}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{RET}}
 @item @kbd{M-S-@key{RET}}   @tab @kbd{C-c C-x M}           @tab @kbd{ } @tab
-@item @kbd{S-@key{LEFT}}    @tab @kbd{C-c @key{LEFT}}      @tab @kbd{ } @tab
-@item @kbd{S-@key{RIGHT}}   @tab @kbd{C-c @key{RIGHT}}     @tab @kbd{ } @tab
-@item @kbd{S-@key{UP}}      @tab @kbd{C-c @key{UP}}        @tab @kbd{ } @tab
-@item @kbd{S-@key{DOWN}}    @tab @kbd{C-c @key{DOWN}}      @tab @kbd{ } @tab
-@item @kbd{C-S-@key{LEFT}}  @tab @kbd{C-c C-x @key{LEFT}}  @tab @kbd{ } @tab
-@item @kbd{C-S-@key{RIGHT}} @tab @kbd{C-c C-x @key{RIGHT}} @tab @kbd{ } @tab
+@item @kbd{S-@key{left}}    @tab @kbd{C-c @key{left}}      @tab @kbd{ } @tab
+@item @kbd{S-@key{right}}   @tab @kbd{C-c @key{right}}     @tab @kbd{ } @tab
+@item @kbd{S-@key{up}}      @tab @kbd{C-c @key{up}}        @tab @kbd{ } @tab
+@item @kbd{S-@key{down}}    @tab @kbd{C-c @key{down}}      @tab @kbd{ } @tab
+@item @kbd{C-S-@key{left}}  @tab @kbd{C-c C-x @key{left}}  @tab @kbd{ } @tab
+@item @kbd{C-S-@key{right}} @tab @kbd{C-c C-x @key{right}} @tab @kbd{ } @tab
 @end multitable
 
 
@@ -18061,9 +18058,9 @@ bindings in Org files, and in the agenda buffer (but not during date
 selection).
 
 @example
-S-@key{UP}      @result{}  M-p             S-@key{DOWN}     @result{}  M-n
-S-@key{LEFT}    @result{}  M--             S-@key{RIGHT}    @result{}  M-+
-C-S-@key{LEFT}  @result{}  M-S--           C-S-@key{RIGHT}  @result{}  M-S-+
+S-UP      @result{}  M-p             S-DOWN     @result{}  M-n
+S-LEFT    @result{}  M--             S-RIGHT    @result{}  M-+
+C-S-LEFT  @result{}  M-S--           C-S-RIGHT  @result{}  M-S-+
 @end example
 
 @vindex org-disputed-keys
@@ -18430,7 +18427,7 @@ the mode is C, then:
 At the location of source, Org needs a special line to direct Orgtbl to
 translate and to find the target for inserting the translated table.  For
 example:
-@cindex @code{#+ORGTBL}
+@cindex #+ORGTBL
 @example
 #+ORGTBL: SEND table_name translation_function arguments...
 @end example
@@ -18468,7 +18465,7 @@ Put the table after an @samp{END} statement.  For example @samp{\bye} in
 @TeX{} and @samp{\end@{document@}} in @LaTeX{}.
 @item
 Comment and uncomment each line of the table during edits.  The @kbd{M-x
-orgtbl-toggle-comment @key{RET}} command makes toggling easy.
+orgtbl-toggle-comment RET} command makes toggling easy.
 @end itemize
 
 @node A @LaTeX{} example
@@ -18481,10 +18478,10 @@ provided by @file{comment.sty}.  To activate it, put
 radio table skeleton@footnote{By default this works only for @LaTeX{}, HTML,
 and Texinfo.  Configure the variable @code{orgtbl-radio-table-templates} to
 install templates for other export formats.}  with the command @kbd{M-x
-orgtbl-insert-radio-table @key{RET}}, which prompts for a table name.  For
-example, if @samp{salesfigures} is the name, the template inserts:
+orgtbl-insert-radio-table RET}, which prompts for a table name.  For example,
+if @samp{salesfigures} is the name, the template inserts:
 
-@cindex @code{#+ORGTBL}, @samp{SEND}
+@cindex #+ORGTBL, SEND
 @example
 % BEGIN RECEIVE ORGTBL salesfigures
 % END RECEIVE ORGTBL salesfigures
@@ -18500,7 +18497,7 @@ The line @code{#+ORGTBL: SEND} tells Orgtbl mode to use the function
 @code{orgtbl-to-latex} to convert the table to @LaTeX{} format, then insert
 the table at the target (receive) location named @code{salesfigures}.  Now
 the table is ready for data entry.  It can even use spreadsheet
-features@footnote{If the @code{#+TBLFM} line contains an odd number of dollar
+features@footnote{If the @samp{#+TBLFM} line contains an odd number of dollar
 characters, this may cause problems with font-lock in @LaTeX{} mode.  As
 shown in the example you can fix this by adding an extra line inside the
 @code{comment} environment that is used to balance the dollar expressions.
@@ -18631,14 +18628,14 @@ translator functions by posting them to the Org users mailing list,
 @node Radio lists
 @subsection Radio lists
 @cindex radio lists
-@cindex @code{org-list-insert-radio-list}
+@cindex org-list-insert-radio-list
 
 Call the @code{org-list-insert-radio-list} function to insert a radio list
 template in HTML, @LaTeX{}, and Texinfo mode documents.  Sending and
 receiving radio lists works is the same as for radio tables (@pxref{Radio
 tables}) except for these differences:
 
-@cindex @code{#+ORGLST}
+@cindex #+ORGLST
 @itemize @minus
 @item
 Orgstruct mode must be active.
@@ -18682,7 +18679,7 @@ time}).
 Dynamic blocks can have names and function parameters.  The syntax is similar
 to @samp{src} code block specifications:
 
-@cindex @code{#+BEGIN}, dynamic block
+@cindex #+BEGIN:dynamic block
 @example
 #+BEGIN: myblock :parameter1 value1 :parameter2 value2 ...
 
@@ -18944,7 +18941,7 @@ priority-n   @r{The computed numerical priority}
 
 @noindent
 If the selection of the agenda item was based on a timestamp, including those
-items with @code{DEADLINE} and @code{SCHEDULED} keywords, then Org includes
+items with @samp{DEADLINE} and @samp{SCHEDULED} keywords, then Org includes
 date and time in the output.
 
 If the selection of the agenda item was based on a timestamp  (or
diff --git a/doc/misc/pcl-cvs.texi b/doc/misc/pcl-cvs.texi
index 4c61aed5b3..1163530e7a 100644
--- a/doc/misc/pcl-cvs.texi
+++ b/doc/misc/pcl-cvs.texi
@@ -63,11 +63,10 @@ modify this GNU manual.''
 @node Top
 @top PCL-CVS
 
-This manual describes PCL-CVS, the GNU Emacs front-end to CVS@.  It is
-nowhere near complete, so you are advised to use @kbd{M-x
-customize-group @key{RET} pcl-cvs @key{RET}} and to look at the
-documentation strings of the various commands and major modes for
-further information.
+This manual describes PCL-CVS, the GNU Emacs front-end to CVS@.  It
+is nowhere near complete, so you are advised to use @kbd{M-x
+customize-group RET pcl-cvs @key{RET}} and to look at the documentation strings
+of the various commands and major modes for further information.
 @c This manual is updated to release 2.5 of PCL-CVS.
 
 @insertcopying
@@ -1110,7 +1109,7 @@ Tag all selected files by running @samp{cvs tag} on
 them (@code{cvs-mode-tag}).  It's usually preferable to tag a directory
 at a time.  Rather than selecting all files (which too often doesn't
 select all files but only the few that are displayed), clear the
-selection with @kbd{M-@key{DEL}} (@code{cvs-mode-unmark-all-files}), position
+selection with @kbd{M-DEL} (@code{cvs-mode-unmark-all-files}), position
 the cursor on the directory you want to tag and hit @kbd{t}.
 @end table
 
diff --git a/doc/misc/reftex.texi b/doc/misc/reftex.texi
index 3803cb0eb7..55060d09b8 100644
--- a/doc/misc/reftex.texi
+++ b/doc/misc/reftex.texi
@@ -3335,7 +3335,7 @@ have to rescan the buffer in order to see it.
 @findex reftex-arg-index
 @findex TeX-arg-index@r{, AUCTeX function}
 @findex TeX-insert-macro@r{, AUCTeX function}
-@kindex C-c RET
+@kindex C-c @key{RET}
 @b{@RefTeX{} supplies macro arguments}@* When you insert a macro
 interactively with @kbd{C-c @key{RET}}, @AUCTeX{} normally prompts for
 macro arguments.  Internally, it uses the functions
diff --git a/doc/misc/sem-user.texi b/doc/misc/sem-user.texi
index 8484a7bfe2..e82162621b 100644
--- a/doc/misc/sem-user.texi
+++ b/doc/misc/sem-user.texi
@@ -1145,7 +1145,7 @@ Typing @kbd{RET} on a reference line jumps to that reference.
 
 @node MRU Bookmarks
 @section MRU Bookmarks mode
-@cindex @code{semantic-mru-bookmark-mode}
+@cindex semantic-mru-bookmark-mode
 
 Semantic MRU Bookmarks mode is a minor mode that keeps track of the
 tags you have edited, allowing you to quickly return to them later
@@ -1193,7 +1193,7 @@ declarations.  Other possible tag classes are @code{variable},
 
 @node Highlight Func Mode
 @section Highlight Func Mode
-@cindex @code{semantic-highlight-func-mode}
+@cindex semantic-highlight-func-mode
 
 Semantic Highlight Function minor mode highlights the declaration line
 of the current function or tag (that is to say, the first line that
@@ -1220,7 +1220,7 @@ Func mode.
 
 @node Tag Decoration Mode
 @section Tag Decoration Mode
-@cindex @code{semantic-decoration-mode}
+@cindex semantic-decoration-mode
 
 Semantic Tag Decoration mode ``decorates'' each tag based on certain
 arbitrary features of that tag.  Decorations are specified using the
diff --git a/doc/misc/ses.texi b/doc/misc/ses.texi
index aa4fe81ba5..60963adcb2 100644
--- a/doc/misc/ses.texi
+++ b/doc/misc/ses.texi
@@ -209,7 +209,7 @@ remove blank cells from the returned list, which allows to use
 @findex keyboard-quit
 
 To create a new spreadsheet, visit a nonexistent file whose name ends
-with ".ses".  For example, @kbd{C-x C-f test.ses @key{RET}}.
+  with ".ses".  For example, @kbd{C-x C-f test.ses RET}.
 
 
 A @dfn{cell identifier} is a symbol with a column letter and a row
@@ -310,7 +310,7 @@ To enter something else (e.g., a vector), begin with a digit, then
 erase the digit and type whatever you want.
 
 @table @kbd
-@item @key{RET}
+@item RET
 Edit the existing formula in the current cell (@code{ses-edit-cell}).
 
 @item C-c C-c
@@ -357,7 +357,7 @@ Basic commands:
 @item w
 (@code{ses-set-column-width})
 
-@item @key{TAB}
+@item TAB
 Moves point to the next rightward cell, or inserts a new column if
 already at last cell on line, or inserts a new row if at endline
 (@code{ses-forward-or-insert}).
@@ -639,7 +639,7 @@ or a non-string is displayed as an error by using @code{#} filling.
 These commands set both formula and printer to @code{nil}:
 
 @table @kbd
-@item @key{DEL}
+@item DEL
 Clear cell and move left (@code{ses-clear-cell-backward}).
 
 @item C-d
@@ -1282,10 +1282,10 @@ avoid virus warnings, each function used in a formula needs
 
 @node Uses of defadvice in @acronym{SES}
 @section Uses of defadvice in @acronym{SES}
-@findex defadvice
-@findex undo-more
-@findex copy-region-as-kill
-@findex yank
+@cindex defadvice
+@cindex undo-more
+@cindex copy-region-as-kill
+@cindex yank
 
 @table @code
 @item undo-more
diff --git a/doc/misc/sieve.texi b/doc/misc/sieve.texi
index 2d290b3688..37bb707f63 100644
--- a/doc/misc/sieve.texi
+++ b/doc/misc/sieve.texi
@@ -123,7 +123,7 @@ bindings to manage Sieve scripts remotely. @xref{Managing Sieve}.
 
 @table @kbd
 
-@item C-c @key{RET}
+@item C-c RET
 @kindex C-c RET
 @findex sieve-manage
 @cindex manage remote sieve script
@@ -160,8 +160,8 @@ press RET on <new script> to create a new script.
 @end example
 
 One of the scripts are highlighted, and standard point navigation
-commands (@kbd{@key{UP}}, @kbd{@key{DOWN}} etc.)@: can be used to
-navigate the list.
+commands (@kbd{<up>}, @kbd{<down>} etc.)@: can be used to navigate the
+list.
 
 The following commands are available in the Manage Sieve buffer:
 
@@ -187,7 +187,7 @@ Deactivates all scripts.
 @findex sieve-remove
 Remove currently highlighted script.
 
-@item @key{RET}
+@item RET
 @item mouse-2
 @item f
 @kindex RET
@@ -272,7 +272,7 @@ The @file{sieve-manage.el} library contains low-level functionality
 for talking to a server with the @sc{managesieve} protocol.
 
 A number of user-visible variables exist, which all can be customized
-in the @code{sieve} group (@kbd{M-x customize-group @key{RET} sieve @key{RET}}):
+in the @code{sieve} group (@kbd{M-x customize-group RET sieve RET}):
 
 @table @code
 
diff --git a/doc/misc/smtpmail.texi b/doc/misc/smtpmail.texi
index c3387054ba..6da51f798d 100644
--- a/doc/misc/smtpmail.texi
+++ b/doc/misc/smtpmail.texi
@@ -354,7 +354,7 @@ directory to hold queued messages.  It defaults to
   The function @code{smtpmail-send-queued-mail} can be used to send
 any queued mail when @code{smtpmail-queue-mail} is enabled.  It is
 typically invoked interactively with @kbd{M-x
-smtpmail-send-queued-mail @key{RET}} when you are connected to the internet.
+smtpmail-send-queued-mail RET} when you are connected to the internet.
 
 @node Server workarounds
 @chapter Server workarounds
diff --git a/doc/misc/speedbar.texi b/doc/misc/speedbar.texi
index d67c4e6145..6286ac12a9 100644
--- a/doc/misc/speedbar.texi
+++ b/doc/misc/speedbar.texi
@@ -87,7 +87,7 @@ on.  @xref{Basic Navigation}.
 @chapter Introduction
 @cindex introduction
 
-To start using speedbar use the command @kbd{M-x speedbar @key{RET}} or
+To start using speedbar use the command @kbd{M-x speedbar RET} or
 select it from the @samp{Options->Show/Hide} sub-menu.  This command
 will open a new frame to summarize the local files.  On X Window
 systems or on MS-Windows, speedbar's frame is twenty characters wide,
@@ -188,7 +188,7 @@ these are available, some additional common bindings are available.
 
 @cindex common keys
 @table @kbd
-@item @key{RET}
+@item RET
 @itemx e
 Edit/Open the current group or tag.  This behavior is dependent on the
 mode.  In general, files or buffers are opened in the attached frame,
@@ -979,8 +979,8 @@ With a numeric argument (@kbd{C-u}), flush cached data before expanding.
 Contract the item under the cursor.
 @end table
 
-@cindex @code{speedbar-line-directory}
-These functions require that the function @code{speedbar-line-directory} be
+@cindex @code{speedbar-line-path}
+These function require that function @code{speedbar-line-path} be
 correctly overloaded to work.
 
 Next, register your extension like this;
@@ -1013,14 +1013,14 @@ like this:
 (speedbar-add-mode-functions-list
  '("MYEXTENSION"
    (speedbar-item-info . MyExtension-speedbar-item-info)
-   (speedbar-line-directory . MyExtension-speedbar-line-directory)))
+   (speedbar-line-path . MyExtension-speedbar-line-path)))
 @end example
 
 The first element in the list is the name of you extension.  The second
 is an alist of functions to overload.  The function to overload is
 first, followed by what you want called instead.
 
-For @code{speedbar-line-directory} your function should take an optional DEPTH
+For @code{speedbar-line-path} your function should take an optional DEPTH
 parameter.  This is the starting depth for heavily indented lines.  If
 it is not provided, you can derive it like this:
 
diff --git a/doc/misc/srecode.texi b/doc/misc/srecode.texi
index 2987f62974..afa3af1035 100644
--- a/doc/misc/srecode.texi
+++ b/doc/misc/srecode.texi
@@ -105,11 +105,11 @@ item should appear.
 To toggle @srecode{} minor mode on and off use:
 
 @example
-M-x srecode-minor-mode @key{RET}
+M-x srecode-minor-mode RET
 @end example
 or
 @example
-M-x global-srecode-minor-mode @key{RET}
+M-x global-srecode-minor-mode RET
 @end example
 
 or add
@@ -276,8 +276,7 @@ If the variable @code{srecode-insert-ask-variable-method} is set to
 instead create ``fields'' in the buffer.  A field-editing layer
 provides simple interaction through the fields.  Typing in a field
 will cause all variable locations that are the same to edit at the
-same time.  Pressing @kbd{@key{TAB}} on a field will move you to the
-next field.
+same time.  Pressing TAB on a field will move you to the next field.
 
 @node SRecode Minor Mode
 @chapter SRecode Minor Mode
@@ -285,17 +284,17 @@ next field.
 The Semantic Recode minor mode enables a keymap and menu that provides
 simple access to different templates or template applications.
 
-The key prefix is @kbd{C-c /}.
+The key prefix is @key{C-c /}.
 
 If the variable @code{srecode-takeover-INS-key} is set, then the key
-@kbd{@key{INSERT}} can also be used.
+@key{<insert>} can also be used.
 
 The most important key is bound to @code{srecode-insert} which is
-@kbd{C-c / /}, or @kbd{@key{INSERT} @key{INSERT}}.  @ref{Quick Start}.
+@key{C-c / /}, or @key{insert insert}.  @ref{Quick Start}.
 
 Major keybindings are:
 
-@table @kbd
+@table @key
 @item C-c / /
 Insert a template whose name is typed into the minibuffer.
 @item C-c / <lower case letter>
@@ -339,7 +338,7 @@ will not be prompted to fill in values while the template is
 inserted.  Instead, short regions will be highlighted, and the cursor
 placed in a field.  Typing in the field will then fill in the value.
 Several fields might be linked together.  In that case, typing in one
-area will modify the other linked areas.  Pressing @key{TAB} will move
+area will modify the other linked areas.  Pressing TAB will move
 between editable fields in the template.
 
 Once the cursor moves out of the are inserted by the template, all the
diff --git a/doc/misc/texinfo.tex b/doc/misc/texinfo.tex
index 1d78131e6b..0af2f09b52 100644
--- a/doc/misc/texinfo.tex
+++ b/doc/misc/texinfo.tex
@@ -3,7 +3,7 @@
 % Load plain if necessary, i.e., if running under initex.
 \expandafter\ifx\csname fmtname\endcsname\relax\input plain\fi
 %
-\def\texinfoversion{2019-01-06.22}
+\def\texinfoversion{2018-02-24.16}
 %
 % Copyright 1985, 1986, 1988, 1990, 1991, 1992, 1993, 1994, 1995,
 % 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006,
@@ -182,7 +182,7 @@
 % Hyphenation fixes.
 \hyphenation{
   Flor-i-da Ghost-script Ghost-view Mac-OS Post-Script
-  auto-ma-ti-cal-ly ap-pen-dix bit-map bit-maps
+  ap-pen-dix bit-map bit-maps
   data-base data-bases eshell fall-ing half-way long-est man-u-script
   man-u-scripts mini-buf-fer mini-buf-fers over-view par-a-digm
   par-a-digms rath-er rec-tan-gu-lar ro-bot-ics se-vere-ly set-up spa-ces
diff --git a/doc/misc/tramp.texi b/doc/misc/tramp.texi
index 3143904343..f2530cd6ea 100644
--- a/doc/misc/tramp.texi
+++ b/doc/misc/tramp.texi
@@ -3059,22 +3059,6 @@ BSD mtree format
 @cindex @file{mtree} file archive suffix
 @cindex file archive suffix @file{mtree}
 
-@item @samp{.odb}, @samp{.odf}, @samp{.odg}, @samp{.odp}, @samp{.ods},
-@samp{.odt} ---
-OpenDocument formats
-@cindex @file{odb} file archive suffix
-@cindex @file{odf} file archive suffix
-@cindex @file{odg} file archive suffix
-@cindex @file{odp} file archive suffix
-@cindex @file{ods} file archive suffix
-@cindex @file{odt} file archive suffix
-@cindex file archive suffix @file{odb}
-@cindex file archive suffix @file{odf}
-@cindex file archive suffix @file{odg}
-@cindex file archive suffix @file{odp}
-@cindex file archive suffix @file{ods}
-@cindex file archive suffix @file{odt}
-
 @item @samp{.pax} ---
 Posix archives
 @cindex @file{pax} file archive suffix
@@ -3579,7 +3563,7 @@ Why is @file{~/.sh_history} file on the remote host growing?
 @vindex tramp-histfile-override
 Due to the remote shell saving tilde expansions triggered by
 @value{tramp}, the history file is probably growing rapidly.
-@value{tramp} can suppress this behavior with the user option
+@value{tramp} can suppress this behaviour with the user option
 @option{tramp-histfile-override}.  When set to @code{t}, environment
 variable @env{HISTFILE} is unset, and environment variables
 @env{HISTFILESIZE} @env{HISTSIZE} are set to 0.
diff --git a/doc/misc/url.texi b/doc/misc/url.texi
index 1acf5f2319..ed39aab2a3 100644
--- a/doc/misc/url.texi
+++ b/doc/misc/url.texi
@@ -1263,6 +1263,19 @@ You can use this function to do completion of URLs from the history.
 @node Customization
 @chapter Customization
 
+@cindex environment variables
+  The following environment variables affect the @code{url} library's
+operation at startup.
+
+@table @code
+@item TMPDIR
+@vindex TMPDIR
+@vindex url-temporary-directory
+If this is defined, @code{url-temporary-directory} is initialized from
+it.  This variable was obsoleted in 23.1, please use
+@code{temporary-file-directory} instead.
+@end table
+
   The following user options affect the general operation of
 @code{url} library.
 
diff --git a/doc/misc/vhdl-mode.texi b/doc/misc/vhdl-mode.texi
index 8fc75106d5..e94fba6fc6 100644
--- a/doc/misc/vhdl-mode.texi
+++ b/doc/misc/vhdl-mode.texi
@@ -100,7 +100,7 @@ How to customize the indentation engine.
 The major version number was incremented to 3 with the addition of
 many new features for editing VHDL code to the new indentation engine,
 which was introduced in major version 2. To find the minor revision
-number of this release, use @kbd{M-x vhdl-version @key{RET}}.
+number of this release, use @kbd{M-x vhdl-version RET}.
 
 A special word of thanks goes to Rod Whitby, who wrote the
 VHDL Mode indentation engine, and to Barry Warsaw, who wrote
@@ -119,7 +119,7 @@ makes everything highly self-explaining.
 @cindex   Getting Connected
 
 To get started, simply visit a @file{.vhd} file in Emacs; or type
-@kbd{M-x vhdl-mode @key{RET}}.
+@kbd{M-x vhdl-mode RET}.
 
 @node     New Indentation Engine
 @chapter  New Indentation Engine
@@ -302,11 +302,11 @@ being used.
 
 @vindex vhdl-echo-syntactic-information-p
 @vindex echo-syntactic-information-p @r{(vhdl-)}
-@cindex @key{TAB}
+@cindex TAB
 To help you configure VHDL Mode, you can set the variable
 @code{vhdl-echo-syntactic-information-p} to non-@code{nil} so that the
 syntactic component list and calculated offset will always be echoed in
-the minibuffer when you hit @kbd{@key{TAB}}.
+the minibuffer when you hit @kbd{TAB}.
 
 
 @ignore
@@ -322,7 +322,7 @@ the minibuffer when you hit @kbd{@key{TAB}}.
 @chapter  Customizing Indentation
 @cindex   Customizing Indentation
 
-@cindex @code{vhdl-set-offset}
+@cindex vhdl-set-offset
 @cindex set-offset (vhdl-)
 The @code{vhdl-offsets-alist} variable is where you customize all your
 indentations.  You simply need to decide what additional offset you want
@@ -334,7 +334,7 @@ pre-defined styles will suit your needs, but if not, this section will
 describe how to set up basic editing configurations.  @xref{Styles}, for
 an explanation of how to set up named styles.
 
-@cindex @code{vhdl-basic-offset}
+@cindex vhdl-basic-offset
 @cindex basic-offset (vhdl-)
 As mentioned previously, the variable @code{vhdl-offsets-alist} is an
 association list between syntactic symbols and the offsets to be applied
@@ -548,7 +548,7 @@ already built-in.  These include:
 @findex vhdl-set-style
 @findex set-style @r{(vhdl-)}
 If you'd like to experiment with these built-in styles you can simply
-type @kbd{M-x vhdl-set-style @key{RET}} in a VHDL Mode buffer.
+type @kbd{M-x vhdl-set-style RET} in a VHDL Mode buffer.
 
 You will be prompted for one of the above styles (with completion).
 Enter one of the styles and hit @kbd{RET}.  Note however that setting a
diff --git a/doc/misc/vip.texi b/doc/misc/vip.texi
index 59df749231..af4c05d8e4 100644
--- a/doc/misc/vip.texi
+++ b/doc/misc/vip.texi
@@ -186,8 +186,8 @@ M-x vip-mode
 @node Modes in VIP
 @section Modes in VIP
 
-@kindex 032 C-z @r{(}@code{vip-change-mode-to-vi}@r{)}
-@kindex 0301 C-x C-z @r{(}@code{suspend-emacs}@r{)}
+@kindex 032 @kbd{C-z} (@code{vip-change-mode-to-vi})
+@kindex 0301 @kbd{C-x C-z} (@code{suspend-emacs})
 
 Loading VIP has the effect of globally binding @kbd{C-z} (@kbd{Control-z})
 to the function @code{vip-change-mode-to-vi}. The default binding of @kbd{C-z}
@@ -266,7 +266,7 @@ emacs mode             vi mode                 insert mode
 @node Emacs Mode
 @subsection Emacs Mode
 
-@kindex 032 C-z @r{(}@code{vip-change-mode-to-vi}@r{)}
+@kindex 032 @kbd{C-z} (@code{vip-change-mode-to-vi})
 
 You will be in this mode just after you loaded VIP@.  You can do all
 normal Emacs editing in this mode.  Note that the key @kbd{C-z} is globally
@@ -289,16 +289,16 @@ its content while you are in insert mode.
 
 @table @kbd
 @item @key{ESC}
-@kindex 033 ESC @r{(}@code{vip-change-mode-to-vi}@r{) (insert mode)}
+@kindex 033 @kbd{ESC} (@code{vip-change-mode-to-vi}) (insert mode)
 This key will take you back to vi mode.
 @item C-h
-@kindex 010 C-h @r{(}@code{vip-delete-backward-char}@r{) (insert mode)}
+@kindex 010 @kbd{C-h} (@code{vip-delete-backward-char}) (insert mode)
 Delete previous character.
 @item C-w
-@kindex 027 C-w @r{(}@code{vip-delete-backward-word}@r{) (insert mode)}
+@kindex 027 @kbd{C-w} (@code{vip-delete-backward-word}) (insert mode)
 Delete previous word.
 @item C-z
-@kindex 032 C-z @r{(}@code{vip-ESC}@r{) (insert mode)}
+@kindex 032 @kbd{C-z} (@code{vip-ESC}) (insert mode)
 Typing this key has the same effect as typing @key{ESC} in emacs mode.
 Thus typing @kbd{C-z x} in insert mode will have the same effect as typing
 @kbd{ESC x} in emacs mode.
@@ -332,8 +332,8 @@ The major differences from Vi are explained below.
 @node Undoing
 @subsection Undoing
 
-@kindex 165 u @r{(}@code{vip-undo}@r{)}
-@kindex 056 . @r{(}@code{vip-repeat}@r{)}
+@kindex 165 @kbd{u} (@code{vip-undo})
+@kindex 056 @kbd{.} (@code{vip-repeat})
 
 You can repeat undoing by the @kbd{.} key.  So, @kbd{u} will undo
 a single change, while @kbd{u .@: .@: .@:}, for instance, will undo 4 previous
@@ -350,14 +350,14 @@ then VIP will prompt you for a new word in the minibuffer by the prompt
 @samp{foo => }.  You can then enter @samp{bar} followed by @key{RET} or
 @key{ESC} to complete the command.  Before you enter @key{RET} or
 @key{ESC} you can abort the command by typing @kbd{C-g}.  In general,
-@kindex 007 C-g @r{(}@code{vip-keyboard-quit})
+@kindex 007 @kbd{C-g} (@code{vip-keyboard-quit})
 you can abort a partially formed command by typing @kbd{C-g}.
 
 @node Searching
 @subsection Searching
 
-@kindex 057 / @r{(}@code{vip-search-forward}@r{)}
-@kindex 077 ? @r{(}@code{vip-search-backward}@r{)}
+@kindex 057 @kbd{/} (@code{vip-search-forward})
+@kindex 077 @kbd{?} (@code{vip-search-backward})
 
 As in Vi, searching is done by @kbd{/} and @kbd{?}.  The string will be
 searched literally by default.  To invoke a regular expression search,
@@ -372,12 +372,12 @@ the buffer as in Vi.  You can change this by rebinding the variable
 @node z Command
 @subsection z Command
 
-@kindex 1723 z H @r{(}@code{vip-line-to-top}@r{)}
-@kindex 1721 z RET @r{(}@code{vip-line-to-top}@r{)}
-@kindex 1723 z M @r{(}@code{vip-line-to-middle}@r{)}
-@kindex 1722 z . @r{(}@code{vip-line-to-middle}@r{)}
-@kindex 1723 z L @r{(}@code{vip-line-to-bottom}@r{)}
-@kindex 1722 z - @r{(}@code{vip-line-to-bottom}@r{)}
+@kindex 1723 @kbd{z H} (@code{vip-line-to-top})
+@kindex 1721 @kbd{z RET} (@code{vip-line-to-top})
+@kindex 1723 @kbd{z M} (@code{vip-line-to-middle})
+@kindex 1722 @kbd{z .} (@code{vip-line-to-middle})
+@kindex 1723 @kbd{z L} (@code{vip-line-to-bottom})
+@kindex 1722 @kbd{z -} (@code{vip-line-to-bottom})
 
 For those of you who cannot remember which of @kbd{z} followed by @key{RET},
 @kbd{.}@: and @kbd{-} do what.  You can also use @kbd{z} followed by @kbd{H},
@@ -392,21 +392,21 @@ Some Vi commands which do not accept a count now accept one
 @table @kbd
 @item p
 @itemx P
-@kindex 160 p @r{(}@code{vip-put-back}@r{)}
-@kindex 120 P @r{(}@code{vip-Put-back}@r{)}
+@kindex 160 @kbd{p} (@code{vip-put-back})
+@kindex 120 @kbd{P} (@code{vip-Put-back})
 Given counts, text will be yanked (in Vi's sense) that many times.  Thus
 @kbd{3 p} is the same as @kbd{p p p}.
 @item o
 @itemx O
-@kindex 157 o @r{(}@code{vip-open-line}@r{)}
-@kindex 117 O @r{(}@code{vip-Open-line}@r{)}
+@kindex 157 @kbd{o} (@code{vip-open-line})
+@kindex 117 @kbd{O} (@code{vip-Open-line})
 Given counts, that many copies of text will be inserted. Thus
 @kbd{o a b c @key{ESC}} will insert 3 lines of @samp{abc} below the current
 line.
 @item /
 @itemx ?
-@kindex 057 / @r{(}@code{vip-search-forward}@r{)}
-@kindex 077 ? @r{(}@code{vip-search-backward}@r{)}
+@kindex 057 @kbd{/} (@code{vip-search-forward})
+@kindex 077 @kbd{?} (@code{vip-search-backward})
 Given a count @var{n}, @var{n}-th occurrence will be searched.
 @end table
 
@@ -417,7 +417,7 @@ Typing an @kbd{m} followed by a lower-case character @var{ch} marks the
 point to the register named @var{ch} as in Vi.  In addition to these, we
 have following key bindings for marking.
 
-@kindex 155 m @r{(}@code{vip-mark-point}@r{)}
+@kindex 155 @kbd{m} (@code{vip-mark-point})
 
 @table @kbd
 @item m <
@@ -451,34 +451,34 @@ Note that the keys below (except for @kbd{R}) are not used in Vi.
 
 @table @kbd
 @item C-a
-@kindex 001 C-a @r{(}@code{vip-beginning-of-line}@r{)}
+@kindex 001 @kbd{C-a} (@code{vip-beginning-of-line})
 Move point to the beginning of line.
 @item C-n
-@kindex 016 C-n @r{(}@code{vip-next-window}@r{)}
+@kindex 016 @kbd{C-n} (@code{vip-next-window})
 If you have two or more windows in the screen, this key will move point to
 the next window.
 @item C-o
-@kindex 017 C-o @r{(}@code{vip-open-line-at-point}@r{)}
+@kindex 017 @kbd{C-o} (@code{vip-open-line-at-point})
 Insert a newline and leave point before it, and then enter insert mode.
 @item C-r
-@kindex 022 C-r @r{(}@code{isearch-backward}@r{)}
+@kindex 022 @kbd{C-r} (@code{isearch-backward})
 Backward incremental search.
 @item C-s
-@kindex 023 C-s @r{(}@code{isearch-forward}@r{)}
+@kindex 023 @kbd{C-s} (@code{isearch-forward})
 Forward incremental search.
 @item C-c
 @itemx C-x
 @itemx @key{ESC}
-@kindex 003 C-c @r{(}@code{vip-ctl-c}@r{)}
-@kindex 0300 C-x @r{(}@code{vip-ctl-x}@r{)}
-@kindex 033 ESC @r{(}@code{vip-ESC}@r{)}
+@kindex 003 @kbd{C-c} (@code{vip-ctl-c})
+@kindex 0300 @kbd{C-x} (@code{vip-ctl-x})
+@kindex 033 @kbd{ESC} (@code{vip-ESC})
 These keys will exit from vi mode and return to emacs mode temporarily.  If
 you hit one of these keys, Emacs will be in emacs mode and will believe
 that you hit that key in emacs mode. For example, if you hit @kbd{C-x}
 followed by @kbd{2}, then the current window will be split into 2 and you
 will be in vi mode again.
 @item \
-@kindex 134 \ @r{(}@code{vip-escape-to-emacs}@r{)}
+@kindex 134 @kbd{\} (@code{vip-escape-to-emacs})
 Escape to emacs mode.  Hitting @kbd{\} will take you to emacs mode, and you
 can execute a single Emacs command.  After executing the Emacs command you
 will be in vi mode again.  You can give a count before typing @kbd{\}.
@@ -486,13 +486,13 @@ Thus @kbd{5 \ *}, as well as @kbd{\ C-u 5 *}, will insert @samp{*****}
 before point.  Similarly @kbd{1 0 \ C-p} will move the point 10 lines above
 the current line.
 @item K
-@kindex 113 K @r{(}@code{vip-kill-buffer}@r{)}
+@kindex 113 @kbd{K} (@code{vip-kill-buffer})
 Kill current buffer if it is not modified.  Useful when you selected a
 buffer which you did not want.
 @item Q
 @itemx R
-@kindex 121 Q @r{(}@code{vip-query-replace}@r{)}
-@kindex 122 R @r{(}@code{vip-replace-string}@r{)}
+@kindex 121 @kbd{Q} (@code{vip-query-replace})
+@kindex 122 @kbd{R} (@code{vip-replace-string})
 @kbd{Q} is for query replace and @kbd{R} is for replace.  By default,
 string to be replaced are treated literally.  If you wish to do a regular
 expression replace, first do replace with empty string as the string to be
@@ -500,39 +500,39 @@ replaced.  In this way, you can toggle between vanilla and regular
 expression replacement.
 @item v
 @itemx V
-@kindex 166 v @r{(}@code{vip-find-file}@r{)}
-@kindex 126 V @r{(}@code{vip-find-file-other-window}@r{)}
+@kindex 166 @kbd{v} (@code{vip-find-file})
+@kindex 126 @kbd{V} (@code{vip-find-file-other-window})
 These keys are used to Visit files.  @kbd{v} will switch to a buffer
 visiting file whose name can be entered in the minibuffer. @kbd{V} is
 similar, but will use window different from the current window.
 @item #
-@kindex 0430 # @r{(}@code{vip-command-argument}@r{)}
+@kindex 0430 @kbd{#} (@code{vip-command-argument})
 If followed by a certain character @var{ch}, it becomes an operator whose
 argument is the region determined by the motion command that follows.
 Currently, @var{ch} can be one of @kbd{c}, @kbd{C}, @kbd{g}, @kbd{q} and
 @kbd{s}.
 @item # c
-@kindex 0432 # c @r{(}@code{downcase-region}@r{)}
+@kindex 0432 @kbd{# c} (@code{downcase-region})
 Change upper-case characters in the region to lower case
 (@code{downcase-region}).
 @item # C
-@kindex 0431 # C @r{(}@code{upcase-region}@r{)}
+@kindex 0431 @kbd{# C} (@code{upcase-region})
 Change lower-case characters in the region to upper case. For instance,
 @kbd{# C 3 w} will capitalize 3 words from the current point
 (@code{upcase-region}).
 @item # g
-@kindex 0432 # g @r{(}@code{vip-global-execute}@r{)}
+@kindex 0432 @kbd{# g} (@code{vip-global-execute})
 Execute last keyboard macro for each line in the region
 (@code{vip-global-execute}).
 @item # q
-@kindex 0432 # q @r{(}@code{vip-quote-region}@r{)}
+@kindex 0432 @kbd{# q} (@code{vip-quote-region})
 Insert specified string at the beginning of each line in the region
 (@code{vip-quote-region}).
 @item # s
-@kindex 0432 # s @r{(}@code{spell-region}@r{)}
+@kindex 0432 @kbd{# s} (@code{spell-region})
 Check spelling of words in the region (@code{spell-region}).
 @item *
-@kindex 052 * @r{(}@code{vip-call-last-kbd-macro}@r{)}
+@kindex 052 @kbd{*} (@code{vip-call-last-kbd-macro})
 Call last keyboard macro.
 @end table
 
@@ -548,21 +548,21 @@ details.
 @table @kbd
 @item C-g
 @itemx g
-@kindex 007 C-g @r{(}@code{vip-keyboard-quit}@r{)}
-@kindex 147 g @r{(}@code{vip-info-on-file}@r{)}
+@kindex 007 @kbd{C-g} (@code{vip-keyboard-quit})
+@kindex 147 @kbd{g} (@code{vip-info-on-file})
 In Vi, @kbd{C-g} is used to get information about the file associated to
 the current buffer.  Here, @kbd{g} will do that, and @kbd{C-g} is
 used to abort a command (this is for compatibility with emacs mode.)
-@item @key{SPC}
+@item SPC
 @itemx @key{RET}
-@kindex 040 SPC @r{(}@code{vip-scroll}@r{)}
-@kindex 015 RET @r{(}@code{vip-scroll-back}@r{)}
+@kindex 040 @kbd{SPC} (@code{vip-scroll})
+@kindex 015 @kbd{RET} (@code{vip-scroll-back})
 Now these keys will scroll up and down the text of current window.
 Convenient for viewing the text.
 @item s
 @itemx S
-@kindex 163 s @r{(}@code{vip-switch-to-buffer}@r{)}
-@kindex 123 S @r{(}@code{vip-switch-to-buffer-other-window}@r{)}
+@kindex 163 @kbd{s} (@code{vip-switch-to-buffer})
+@kindex 123 @kbd{S} (@code{vip-switch-to-buffer-other-window})
 They are used to switch to a specified buffer.  Useful for switching to
 already existing buffer since buffer name completion is provided.  Also
 a default buffer will be given as part of the prompt, to which you can
@@ -570,8 +570,8 @@ switch by just typing @key{RET} key.  @kbd{s} is used to select buffer
 in the current window, while @kbd{S} selects buffer in another window.
 @item C
 @itemx X
-@kindex 103 C @r{(}@code{vip-ctl-c-equivalent}@r{)}
-@kindex 1300 X @r{(}@code{vip-ctl-x-equivalent}@r{)}
+@kindex 103 @kbd{C} (@code{vip-ctl-c-equivalent})
+@kindex 1300 @kbd{X} (@code{vip-ctl-x-equivalent})
 These keys will exit from vi mode and return to emacs mode temporarily.
 If you type @kbd{C} (@kbd{X}), Emacs will be in emacs mode and will believe
 that you have typed @kbd{C-c} (@kbd{C-x}) in emacs mode. Moreover,
@@ -588,7 +588,7 @@ vi mode again.
 
 In addition to these, @code{ctl-x-map} is slightly modified:
 
-@kindex 1301 X 3 @r{(}@code{vip-buffer-in-two-windows}@r{)}
+@kindex 1301 @kbd{X 3} (@code{vip-buffer-in-two-windows})
 
 @table @kbd
 @item X 3
@@ -604,19 +604,19 @@ basic functions related to windows, buffers and files.
 
 @table @kbd
 @item C-n
-@kindex 016 C-n @r{(}@code{vip-next-window}@r{)}
+@kindex 016 @kbd{C-n} (@code{vip-next-window})
 Switch to next window.
 @item X 1
 @itemx C-x 1
-@kindex 1301 X 1 @r{(}@code{delete-other-windows}@r{)}
+@kindex 1301 @kbd{X 1} (@code{delete-other-windows})
 Delete other windows.
 @item X 2
 @itemx C-x 2
-@kindex 1301 X 2 @r{(}@code{split-window-vertically}@r{)}
+@kindex 1301 @kbd{X 2} (@code{split-window-vertically})
 Split current window into two windows.
 @item X 3
 @itemx C-x 3
-@kindex 1301 X 3 @r{(}@code{vip-buffer-in-two-windows}@r{)}
+@kindex 1301 @kbd{X 3} (@code{vip-buffer-in-two-windows})
 Show current buffer in two windows.
 @end table
 
@@ -625,19 +625,19 @@ Show current buffer in two windows.
 
 @table @kbd
 @item s
-@kindex 163 s @r{(}@code{vip-switch-to-buffer}@r{)}
+@kindex 163 @kbd{s} (@code{vip-switch-to-buffer})
 Switch to the specified buffer in the current window
 (@code{vip-switch-to-buffer}).
 @item S
-@kindex 123 S @r{(}@code{vip-switch-to-buffer-other-window}@r{)}
+@kindex 123 @kbd{S} (@code{vip-switch-to-buffer-other-window})
 Switch to the specified buffer in another window
 (@code{vip-switch-to-buffer-other-window}).
 @item K
-@kindex 113 K @r{(}@code{vip-kill-buffer}@r{)}
+@kindex 113 @kbd{K} (@code{vip-kill-buffer})
 Kill the current buffer if it is not modified.
 @item X S
 @itemx C-x C-s
-@kindex 1302 X S @r{(}@code{save-buffer}@r{)}
+@kindex 1302 @kbd{X S} (@code{save-buffer})
 Save the current buffer in the file associated to the buffer.
 @end table
 
@@ -646,18 +646,18 @@ Save the current buffer in the file associated to the buffer.
 
 @table @kbd
 @item v
-@kindex 166 v @r{(}@code{vip-find-file}@r{)}
+@kindex 166 @kbd{v} (@code{vip-find-file})
 Visit specified file in the current window.
 @item V
-@kindex 126 V @r{(}@code{vip-find-file-other-window}@r{)}
+@kindex 126 @kbd{V} (@code{vip-find-file-other-window})
 Visit specified file in another window.
 @item X W
 @itemx C-x C-w
-@kindex 1302 X W @r{(}@code{write-file}@r{)}
+@kindex 1302 @kbd{X W} (@code{write-file})
 Write current buffer into the specified file.
 @item X I
 @itemx C-x C-i
-@kindex 1302 X I @r{(}@code{insert-file}@r{)}
+@kindex 1302 @kbd{X I} (@code{insert-file})
 
 Insert specified file at point.
 @end table
@@ -668,18 +668,18 @@ Insert specified file at point.
 @table @kbd
 @item X (
 @itemx C-x (
-@kindex 1301 X ( @r{(}@code{start-kbd-macro}@r{)}
+@kindex 1301 @kbd{X (} (@code{start-kbd-macro})
 Start remembering keyboard macro.
 @item X )
 @itemx C-x )
-@kindex 1301 X ) @r{(}@code{end-kbd-macro}@r{)}
+@kindex 1301 @kbd{X )} (@code{end-kbd-macro})
 Finish remembering keyboard macro.
 @item *
-@kindex 052 * @r{(}@code{vip-call-last-kbd-macro}@r{)}
+@kindex 052 @kbd{*} (@code{vip-call-last-kbd-macro})
 Call last remembered keyboard macro.
 @item X Z
 @itemx C-x C-z
-@kindex 1302 X Z @r{(}@code{suspend-emacs}@r{)}
+@kindex 1302 @kbd{X Z} (@code{suspend-emacs})
 Suspend Emacs.
 @item Z Z
 Exit Emacs.
@@ -715,15 +715,15 @@ commands described in this chapter are to be used in vi mode.
 
 @cindex numeric arguments
 @cindex count
-@kindex 061 1 @r{(numeric argument)}
-@kindex 062 2 @r{(numeric argument)}
-@kindex 063 3 @r{(numeric argument)}
-@kindex 064 4 @r{(numeric argument)}
-@kindex 065 5 @r{(numeric argument)}
-@kindex 066 6 @r{(numeric argument)}
-@kindex 067 7 @r{(numeric argument)}
-@kindex 068 8 @r{(numeric argument)}
-@kindex 069 9 @r{(numeric argument)}
+@kindex 061 @kbd{1} (numeric argument)
+@kindex 062 @kbd{2} (numeric argument)
+@kindex 063 @kbd{3} (numeric argument)
+@kindex 064 @kbd{4} (numeric argument)
+@kindex 065 @kbd{5} (numeric argument)
+@kindex 066 @kbd{6} (numeric argument)
+@kindex 067 @kbd{7} (numeric argument)
+@kindex 068 @kbd{8} (numeric argument)
+@kindex 069 @kbd{9} (numeric argument)
 
 Most Vi commands accept a @dfn{numeric argument} which can be supplied as
 a prefix to the commands.  A numeric argument is also called a @dfn{count}.
@@ -739,10 +739,10 @@ functions are the same in any of emacs, vi and insert mode.
 
 @table @kbd
 @item C-g
-@kindex 007 C-g (@code{vip-keyboard-quit}@r{)}
+@kindex 007 @kbd{C-g} (@code{vip-keyboard-quit})
 Quit.  Cancel running or partially typed command (@code{keyboard-quit}).
 @item C-l
-@kindex 014 C-l @r{(}@code{recenter}@r{)}
+@kindex 014 @kbd{C-l} (@code{recenter})
 Clear the screen and reprint everything (@code{recenter}).
 @end table
 
@@ -754,9 +754,9 @@ accessed from vi mode as easily as from emacs mode.
 @item C-x
 @itemx C-c
 @itemx @key{ESC}
-@kindex 003 C-c @r{(}@code{vip-ctl-c}@r{)}
-@kindex 0300 C-x @r{(}@code{vip-ctl-x}@r{)}
-@kindex 033 ESC @r{(}@code{vip-ESC}@r{)}
+@kindex 003 @kbd{C-c} (@code{vip-ctl-c})
+@kindex 0300 @kbd{C-x} (@code{vip-ctl-x})
+@kindex 033 @kbd{ESC} (@code{vip-ESC})
 Typing one of these keys have the same effect as typing it in emacs mode.
 Appropriate command will be executed according as the keys you type after
 it.  You will be in vi mode again after the execution of the command.
@@ -764,8 +764,8 @@ For instance, if you type @kbd{@key{ESC} <} (in vi mode) then the cursor will
 move to the beginning of the buffer and you will still be in vi mode.
 @item C
 @itemx X
-@kindex 103 C @r{(}@code{vip-ctl-c-equivalent}@r{)}
-@kindex 1300 X @r{(}@code{vip-ctl-x-equivalent}@r{)}
+@kindex 103 @kbd{C} (@code{vip-ctl-c-equivalent})
+@kindex 1300 @kbd{X} (@code{vip-ctl-x-equivalent})
 Typing one of these keys have the effect of typing the corresponding
 control character in emacs mode.  Moreover, if you type an upper-case
 character following it, that character will also be translated to the
@@ -773,7 +773,7 @@ corresponding control character.  Thus typing @kbd{X W} in vi mode is the
 same as typing @kbd{C-x C-w} in emacs mode.  You will be in vi mode again
 after the execution of a command.
 @item \
-@kindex 134 \ @r{(}@code{vip-escape-to-emacs}@r{)}
+@kindex 134 @kbd{\} (@code{vip-escape-to-emacs})
 Escape to emacs mode.  Hitting the @kbd{\} key will take you to emacs mode,
 and you can execute a single Emacs command.  After executing the
 Emacs command you will be in vi mode again.  You can give a count before
@@ -810,31 +810,31 @@ We have the following commands related to windows and buffers.
 
 @table @kbd
 @item C-n
-@kindex 016 C-n @r{(}@code{vip-next-window}@r{)}
+@kindex 016 @kbd{C-n} (@code{vip-next-window})
 Move cursor to the next-window (@code{vip-next-window}).
 @item X 1
-@kindex 1301 X 1 @r{(}@code{delete-other-windows}@r{)}
+@kindex 1301 @kbd{X 1} (@code{delete-other-windows})
 Delete other windows and make the selected window fill the screen
 @*(@code{delete-other-windows}).
 @item X 2
-@kindex 1301 X 2 @r{(}@code{split-window-vertically}@r{)}
+@kindex 1301 @kbd{X 2} (@code{split-window-vertically})
 Split current window into two windows (@code{split-window-vertically}).
 @item X 3
-@kindex 1301 X 3 @r{(}@code{vip-buffer-in-two-windows}@r{)}
+@kindex 1301 @kbd{X 3} (@code{vip-buffer-in-two-windows})
 Show current buffer in two windows.
 @item s @var{buffer} @key{RET}
-@kindex 163 s @r{(}@code{vip-switch-to-buffer}@r{)}
+@kindex 163 @kbd{s} (@code{vip-switch-to-buffer})
 Select or create a buffer named @var{buffer} (@code{vip-switch-to-buffer}).
 @item S @var{buffer} @key{RET}
-@kindex 123 S @r{(}@code{vip-switch-to-buffer-other-window}@r{)}
+@kindex 123 @kbd{S} (@code{vip-switch-to-buffer-other-window})
 Similar but select a buffer named @var{buffer} in another window
 @*(@code{vip-switch-to-buffer-other-window}).
 @item K
-@kindex 113 K @r{(}@code{vip-kill-buffer}@r{)}
+@kindex 113 @kbd{K} (@code{vip-kill-buffer})
 Kill the current buffer if it is not modified or if it is not associated
 with a file @*(@code{vip-kill-buffer}).
 @item X B
-@kindex 1302 X B @r{(}@code{list-buffers}@r{)}
+@kindex 1302 @kbd{X B} (@code{list-buffers})
 List the existing buffers (@code{list-buffers}).
 @end table
 
@@ -856,24 +856,24 @@ save and insert files.
 
 @table @kbd
 @item v @var{file} @key{RET}
-@kindex 166 v @r{(}@code{vip-find-file}@r{)}
+@kindex 166 @kbd{v} (@code{vip-find-file})
 Visit specified file in the current window (@code{vip-find-file}).
 @item V @var{file} @key{RET}
-@kindex 126 V @r{(}@code{vip-find-file-other-window}@r{)}
+@kindex 126 @kbd{V} (@code{vip-find-file-other-window})
 Visit specified file in another window (@code{vip-find-file-other-window}).
 @item X S
-@kindex 1302 X S @r{(}@code{save-buffer}@r{)}
+@kindex 1302 @kbd{X S} (@code{save-buffer})
 Save current buffer to the file associated with the buffer.  If no file is
 associated with the buffer, the name of the file to write out the content
 of the buffer will be asked in the minibuffer.
 @item X W @var{file} @key{RET}
-@kindex 1302 X W @r{(}@code{write-file}@r{)}
+@kindex 1302 @kbd{X W} (@code{write-file})
 Write current buffer into a specified file.
 @item X I @var{file} @key{RET}
-@kindex 1302 X I @r{(}@code{insert-file}@r{)}
+@kindex 1302 @kbd{X I} (@code{insert-file})
 Insert a specified file at point.
 @item g
-@kindex 147 g @r{(}@code{vip-info-on-file}@r{)}
+@kindex 147 @kbd{g} (@code{vip-info-on-file})
 Give information on the file associated with the current buffer.  Tell you
 the name of the file associated with the buffer, the line number of the
 current point and total line numbers in the buffer.  If no file is
@@ -940,29 +940,29 @@ buffer.
 @table @kbd
 @item @key{SPC}
 @itemx C-f
-@kindex 040 SPC @r{(}@code{vip-scroll}@r{)}
-@kindex 006 C-f @r{(}@code{vip-scroll-back}@r{)}
+@kindex 040 @kbd{SPC} (@code{vip-scroll})
+@kindex 006 @kbd{C-f} (@code{vip-scroll-back})
 Scroll text of current window upward almost full screen.  You can go
 @i{forward} in the buffer by this command (@code{vip-scroll}).
 @item @key{RET}
 @itemx C-b
-@kindex 015 RET @r{(}@code{vip-scroll-back}@r{)}
-@kindex 002 C-b @r{(}@code{vip-scroll-back}@r{)}
+@kindex 015 @kbd{RET} (@code{vip-scroll-back})
+@kindex 002 @kbd{C-b} (@code{vip-scroll-back})
 Scroll text of current window downward almost full screen.  You can go
 @i{backward} in the buffer by this command (@code{vip-scroll-back}).
 @item C-d
-@kindex 004 C-d @r{(}@code{vip-scroll-up}@r{)}
+@kindex 004 @kbd{C-d} (@code{vip-scroll-up})
 Scroll text of current window upward half screen.  You can go
 @i{down} in the buffer by this command (@code{vip-scroll-down}).
 @item C-u
-@kindex 025 C-u @r{(}@code{vip-scroll-down}@r{)}
+@kindex 025 @kbd{C-u} (@code{vip-scroll-down})
 Scroll text of current window downward half screen.  You can go
 @i{up} in the buffer by this command (@code{vip-scroll-up}).
 @item C-y
-@kindex 031 C-y @r{(}@code{vip-scroll-down-one}@r{)}
+@kindex 031 @kbd{C-y} (@code{vip-scroll-down-one})
 Scroll text of current window upward by one line (@code{vip-scroll-down-one}).
 @item C-e
-@kindex 005 C-e @r{(}@code{vip-scroll-up-one}@r{)}
+@kindex 005 @kbd{C-e} (@code{vip-scroll-up-one})
 Scroll text of current window downward by one line (@code{vip-scroll-up-one}).
 @end table
 @noindent
@@ -974,22 +974,22 @@ The following commands reposition point in the window.
 @table @kbd
 @item z H
 @itemx z @key{RET}
-@kindex 1723 z H @r{(}@code{vip-line-to-top}@r{)}
-@kindex 1721 z RET @r{(}@code{vip-line-to-top}@r{)}
+@kindex 1723 @kbd{z H} (@code{vip-line-to-top})
+@kindex 1721 @kbd{z RET} (@code{vip-line-to-top})
 Put point on the top (@i{home}) line in the window.  So the current line
 becomes the top line in the window.  Given a count @var{n}, point will be
 placed in the @var{n}-th line from top (@code{vip-line-to-top}).
 @item z M
 @itemx z .
-@kindex 1723 z M @r{(}@code{vip-line-to-middle}@r{)}
-@kindex 1722 z . @r{(}@code{vip-line-to-middle}@r{)}
+@kindex 1723 @kbd{z M} (@code{vip-line-to-middle})
+@kindex 1722 @kbd{z .} (@code{vip-line-to-middle})
 Put point on the @i{middle} line in the window.  Given a count @var{n},
 point will be placed in the @var{n}-th line from the middle line
 (@code{vip-line-to-middle}).
 @item z L
 @itemx z -
-@kindex 1723 z L @r{(}@code{vip-line-to-bottom}@r{)}
-@kindex 1722 z - @r{(}@code{vip-line-to-bottom}@r{)}
+@kindex 1723 @kbd{z L} (@code{vip-line-to-bottom})
+@kindex 1722 @kbd{z -} (@code{vip-line-to-bottom})
 Put point on the @i{bottom} line in the window.  Given a count @var{n},
 point will be placed in the @var{n}-th line from bottom
 (@code{vip-line-to-bottom}).
@@ -1004,7 +1004,7 @@ The following commands are used to mark positions in the buffer.
 
 @table @kbd
 @item m @var{ch}
-@kindex 155 m @r{(}@code{vip-mark-point}@r{)}
+@kindex 155 @kbd{m} (@code{vip-mark-point})
 Store current point in the register @var{ch}.  @var{ch} must be a
 lower-case @acronym{ASCII} letter.
 @item m <
@@ -1034,31 +1034,31 @@ to be described in the next section.
 
 @table @kbd
 @item h
-@kindex 150 h @r{(}@code{vip-backward-char}@r{)}
+@kindex 150 @kbd{h} (@code{vip-backward-char})
 Move point backward by one character.  Signal error if point is at the
 beginning of buffer, but (unlike Vi) do not complain otherwise
 (@code{vip-backward-char}).
 @item l
-@kindex 154 l @r{(}@code{vip-forward-char}@r{)}
+@kindex 154 @kbd{l} (@code{vip-forward-char})
 Move point backward by one character.  Signal error if point is at the
 end of buffer, but (unlike Vi) do not complain otherwise
 (@code{vip-forward-char}).
 @item j
-@kindex 152 j @r{(}@code{vip-next-line}@r{)}
+@kindex 152 @kbd{j} (@code{vip-next-line})
 Move point to the next line keeping the current column.  If point is on the
 last line of the buffer, a new line will be created and point will move to
 that line (@code{vip-next-line}).
 @item k
-@kindex 153 k @r{(}@code{vip-previous-line}@r{)}
+@kindex 153 @kbd{k} (@code{vip-previous-line})
 Move point to the previous line keeping the current column
 (@code{vip-next-line}).
 @item +
-@kindex 053 + @r{(}@code{vip-next-line-at-bol}@r{)}
+@kindex 053 @kbd{+} (@code{vip-next-line-at-bol})
 Move point to the next line at the first non-white character.  If point is
 on the last line of the buffer, a new line will be created and point will
 move to the beginning of that line (@code{vip-next-line-at-bol}).
 @item -
-@kindex 055 - @r{(}@code{vip-previous-line-at-bol}@r{)}
+@kindex 055 @kbd{-} (@code{vip-previous-line-at-bol})
 Move point to the previous line at the first non-white character
 (@code{vip-previous-line-at-bol}).
 @end table
@@ -1068,17 +1068,17 @@ many times.
 
 @table @kbd
 @item 0
-@kindex 060 0 @r{(}@code{vip-beginning-of-line}@r{)}
+@kindex 060 @kbd{0} (@code{vip-beginning-of-line})
 Move point to the beginning of line (@code{vip-beginning-of-line}).
 @item ^
-@kindex 136 ^ @r{(}@code{vip-bol-and-skip-white}@r{)}
+@kindex 136 @kbd{^} (@code{vip-bol-and-skip-white})
 Move point to the first non-white character on the line
 (@code{vip-bol-and-skip-white}).
 @item $
-@kindex 044 $ @r{(}@code{vip-goto-eol}@r{)}
+@kindex 044 @kbd{$} (@code{vip-goto-eol})
 Move point to the end of line (@code{vip-goto-eol}).
 @item @var{n} |
-@kindex 174 | @r{(}@code{vip-goto-col}@r{)}
+@kindex 174 @kbd{|} (@code{vip-goto-col})
 Move point to the @var{n}-th column on the line (@code{vip-goto-col}).
 @end table
 @noindent
@@ -1088,25 +1088,25 @@ Except for the @kbd{|} command, these commands neglect a count.
 
 @table @kbd
 @item w
-@kindex 167 w @r{(}@code{vip-forward-word}@r{)}
+@kindex 167 @kbd{w} (@code{vip-forward-word})
 Move point forward to the beginning of the next word
 (@code{vip-forward-word}).
 @item W
-@kindex 127 W @r{(}@code{vip-forward-Word}@r{)}
+@kindex 127 @kbd{W} (@code{vip-forward-Word})
 Move point forward to the beginning of the next word, where a @dfn{word} is
 considered as a sequence of non-white characters (@code{vip-forward-Word}).
 @item b
-@kindex 142 b @r{(}@code{vip-backward-word}@r{)}
+@kindex 142 @kbd{b} (@code{vip-backward-word})
 Move point backward to the beginning of a word (@code{vip-backward-word}).
 @item B
-@kindex 102 B @r{(}@code{vip-backward-Word}@r{)}
+@kindex 102 @kbd{B} (@code{vip-backward-Word})
 Move point backward to the beginning of a word, where a @i{word} is
 considered as a sequence of non-white characters (@code{vip-forward-Word}).
 @item e
-@kindex 145 e @r{(}@code{vip-end-of-word}@r{)}
+@kindex 145 @kbd{e} (@code{vip-end-of-word})
 Move point forward to the end of a word (@code{vip-end-of-word}).
 @item E
-@kindex 105 E @r{(}@code{vip-end-of-Word}@r{)}
+@kindex 105 @kbd{E} (@code{vip-end-of-Word})
 Move point forward to the end of a word, where a @i{word} is
 considered as a sequence of non-white characters (@code{vip-end-of-Word}).
 @end table
@@ -1120,17 +1120,17 @@ details of syntax table.
 
 @table @kbd
 @item H
-@kindex 110 H @r{(}@code{vip-window-top}@r{)}
+@kindex 110 @kbd{H} (@code{vip-window-top})
 Move point to the beginning of the @i{home} (top) line of the window.
 Given a count @var{n}, go to the @var{n}-th line from top
 (@code{vip-window-top}).
 @item M
-@kindex 115 M @r{(}@code{vip-window-middle}@r{)}
+@kindex 115 @kbd{M} (@code{vip-window-middle})
 Move point to the beginning of the @i{middle} line of the window.  Given
 a count @var{n}, go to the @var{n}-th line from the middle line
 (@code{vip-window-middle}).
 @item L
-@kindex 114 L @r{(}@code{vip-window-bottom}@r{)}
+@kindex 114 @kbd{L} (@code{vip-window-bottom})
 Move point to the beginning of the @i{lowest} (bottom) line of the
 window.  Given count, go to the @var{n}-th line from bottom
 (@code{vip-window-bottom}).
@@ -1140,19 +1140,19 @@ These commands can be used to go to the desired line visible on the screen.
 
 @table @kbd
 @item (
-@kindex 050 ( @r{(}@code{vip-backward-sentence}@r{)}
+@kindex 050 @kbd{(} (@code{vip-backward-sentence})
 Move point backward to the beginning of the sentence
 (@code{vip-backward-sentence}).
 @item )
-@kindex 051 ) @r{(}@code{vip-forward-sentence}@r{)}
+@kindex 051 @kbd{)} (@code{vip-forward-sentence})
 Move point forward to the end of the sentence
 (@code{vip-forward-sentence}).
 @item @{
-@kindex 173 @{ @r{(}@code{vip-backward-paragraph}@r{)}
+@kindex 173 @kbd{@{} (@code{vip-backward-paragraph})
 Move point backward to the beginning of the paragraph
 (@code{vip-backward-paragraph}).
 @item @}
-@kindex 175 @} @r{(}@code{vip-forward-paragraph}@r{)}
+@kindex 175 @kbd{@}} (@code{vip-forward-paragraph})
 Move point forward to the end of the paragraph
 (@code{vip-forward-paragraph}).
 @end table
@@ -1161,25 +1161,25 @@ A count repeats the effect for these commands.
 
 @table @kbd
 @item G
-@kindex 107 G @r{(}@code{vip-goto-line}@r{)}
+@kindex 107 @kbd{G} (@code{vip-goto-line})
 Given a count @var{n}, move point to the @var{n}-th line in the buffer on
 the first non-white character.  Without a count, go to the end of the buffer
 (@code{vip-goto-line}).
 @item ` `
-@kindex 140 ` @r{(}@code{vip-goto-mark}@r{)}
+@kindex 140 @kbd{`} (@code{vip-goto-mark})
 Exchange point and mark (@code{vip-goto-mark}).
 @item ` @var{ch}
 Move point to the position stored in the register @var{ch}.  @var{ch} must
 be a lower-case letter.
 @item ' '
-@kindex 047 ' @r{(}@code{vip-goto-mark-and-skip-white}@r{)}
+@kindex 047 @kbd{'} (@code{vip-goto-mark-and-skip-white})
 Exchange point and mark, and then move point to the first non-white
 character on the line (@code{vip-goto-mark-and-skip-white}).
 @item ' @var{ch}
 Move point to the position stored in the register @var{ch} and skip to the
 first non-white character on the line.  @var{ch} must be a lower-case letter.
 @item %
-@kindex 045 % @r{(}@code{vip-paren-match}@r{)}
+@kindex 045 @kbd{%} (@code{vip-paren-match})
 Move point to the matching parenthesis if point is looking at @kbd{(},
 @kbd{)}, @kbd{@{}, @kbd{@}}, @kbd{[} or @kbd{]}
 @*(@code{vip-paren-match}).
@@ -1194,27 +1194,27 @@ will repeat the effect.
 
 @table @kbd
 @item f @var{ch}
-@kindex 146 f @r{(}@code{vip-find-char-forward}@r{)}
+@kindex 146 @kbd{f} (@code{vip-find-char-forward})
 Move point forward to the character @var{ch} on the line.  Signal error if
 @var{ch} could not be found (@code{vip-find-char-forward}).
 @item F @var{ch}
-@kindex 106 F @r{(}@code{vip-find-char-backward}@r{)}
+@kindex 106 @kbd{F} (@code{vip-find-char-backward})
 Move point backward to the character @var{ch} on the line.  Signal error if
 @var{ch} could not be found (@code{vip-find-char-backward}).
 @item t @var{ch}
-@kindex 164 t @r{(}@code{vip-goto-char-forward}@r{)}
+@kindex 164 @kbd{t} (@code{vip-goto-char-forward})
 Move point forward upto the character @var{ch} on the line.  Signal error if
 @var{ch} could not be found (@code{vip-goto-char-forward}).
 @item T @var{ch}
-@kindex 124 T @r{(}@code{vip-goto-char-backward}@r{)}
+@kindex 124 @kbd{T} (@code{vip-goto-char-backward})
 Move point backward upto the character @var{ch} on the line.  Signal error if
 @var{ch} could not be found (@code{vip-goto-char-backward}).
 @item ;
-@kindex 073 ; @r{(}@code{vip-repeat-find}@r{)}
+@kindex 073 @kbd{;} (@code{vip-repeat-find})
 Repeat previous @kbd{f}, @kbd{t}, @kbd{F} or @kbd{T} command
 (@code{vip-repeat-find}).
 @item ,
-@kindex 054 , @r{(}@code{vip-repeat-find-opposite}@r{)}
+@kindex 054 @kbd{,} (@code{vip-repeat-find-opposite})
 Repeat previous @kbd{f}, @kbd{t}, @kbd{F} or @kbd{T} command, in the
 opposite direction (@code{vip-repeat-find-opposite}).
 @end table
@@ -1228,7 +1228,7 @@ Following commands are available for searching and replacing.
 
 @table @kbd
 @item / @var{string} @key{RET}
-@kindex 057 / @r{(}@code{vip-search-forward}@r{)}
+@kindex 057 @kbd{/} (@code{vip-search-forward})
 Search the first occurrence of the string @var{string} forward starting
 from point.  Given a count @var{n}, the @var{n}-th occurrence of
 @var{string} will be searched.  If the variable @code{vip-re-search} has value
@@ -1238,28 +1238,28 @@ empty string as @var{string} then the search mode will change from vanilla
 search to regular expression search and vice versa
 (@code{vip-search-forward}).
 @item ? @var{string} @key{RET}
-@kindex 077 ? @r{(}@code{vip-search-backward}@r{)}
+@kindex 077 @kbd{?} (@code{vip-search-backward})
 Same as @kbd{/}, except that search is done backward
 (@code{vip-search-backward}).
 @item n
-@kindex 156 n @r{(}@code{vip-search-next}@r{)}
+@kindex 156 @kbd{n} (@code{vip-search-next})
 Search the previous search pattern in the same direction as before
 (@code{vip-search-next}).
 @item N
-@kindex 116 N @r{(}@code{vip-search-Next}@r{)}
+@kindex 116 @kbd{N} (@code{vip-search-Next})
 Search the previous search pattern in the opposite direction
 (@code{vip-search-Next}).
 @item C-s
-@kindex 023 C-s @r{(}@code{isearch-forward}@r{)}
+@kindex 023 @kbd{C-s} (@code{isearch-forward})
 Search forward incrementally.  See GNU Emacs Manual for details
 (@code{isearch-forward}).
 @item C-r
-@kindex 022 C-r @r{(}@code{isearch-backward}@r{)}
+@kindex 022 @kbd{C-r} (@code{isearch-backward})
 Search backward incrementally (@code{isearch-backward}).
 @cindex vanilla (replacement)
 @cindex regular expression (replacement)
-@item R @var{string} @key{RET} @var{newstring}
-@kindex 122 R @r{(}@code{vip-replace-string}@r{)}
+@item R @var{string} RET @var{newstring}
+@kindex 122 @kbd{R} (@code{vip-replace-string})
 There are two modes of replacement, @dfn{vanilla} and @dfn{regular expression}.
 If the mode is @i{vanilla} you will get a prompt @samp{Replace string:},
 and if the mode is @i{regular expression} you will ge a prompt
@@ -1269,13 +1269,13 @@ vanilla, this command replaces every occurrence of @var{string} with
 @var{newstring}.  If the mode is regular expression, @var{string} is
 treated as a regular expression and every string matching the regular
 expression is replaced with @var{newstring} (@code{vip-replace-string}).
-@item Q @var{string} @key{RET} @var{newstring}
-@kindex 121 Q @r{(}@code{vip-query-replace}@r{)}
+@item Q @var{string} RET @var{newstring}
+@kindex 121 @kbd{Q} (@code{vip-query-replace})
 Same as @kbd{R} except that you will be asked form confirmation before each
 replacement
 @*(@code{vip-query-replace}).
 @item r @var{ch}
-@kindex 162 r @r{(}@code{vip-replace-char}@r{)}
+@kindex 162 @kbd{r} (@code{vip-replace-char})
 Replace the character point is looking at by the character @var{ch}.  Give
 count, replace that many characters by @var{ch} (@code{vip-replace-char}).
 @end table
@@ -1326,7 +1326,7 @@ command.
 
 @table @kbd
 @item d @var{motion-command}
-@kindex 1440 d @r{(}@code{vip-command-argument}@r{)}
+@kindex 1440 @kbd{d} (@code{vip-command-argument})
 Delete the region determined by the motion command @var{motion-command}.
 @end table
 @noindent
@@ -1337,7 +1337,7 @@ end of the buffer, since @kbd{G} is a line command.  A count given to the
 command above will become the count for the associated motion command.
 Thus, @kbd{3 d w} will delete three words.
 
-@kindex 042 " @r{(}@code{vip-command-argument}@r{)}
+@kindex 042 @kbd{"} (@code{vip-command-argument})
 It is also possible to save the deleted text into a register you specify.
 For example, you can say @kbd{" t 3 d w} to delete three words and save it
 to register @kbd{t}.  The name of a register is a lower-case letter between
@@ -1352,23 +1352,23 @@ We have more delete commands as below.
 
 @table @kbd
 @item d d
-@kindex 1442 d d
+@kindex 1442 @kbd{d d}
 Delete a line.  Given a count @var{n}, delete @var{n} lines.
 @item d r
-@kindex 1442 d r
+@kindex 1442 @kbd{d r}
 Delete current region.
 @item d R
-@kindex 1441 d R
+@kindex 1441 @kbd{d R}
 Expand current region and delete it.
 @item D
-@kindex 104 D @r{(}@code{vip-kill-line}@r{)}
+@kindex 104 @kbd{D} (@code{vip-kill-line})
 Delete to the end of a line (@code{vip-kill-line}).
 @item x
-@kindex 170 x @r{(}@code{vip-delete-char}@r{)}
+@kindex 170 @kbd{x} (@code{vip-delete-char})
 Delete a character after point.  Given @var{n}, delete @var{n} characters
 (@code{vip-delete-char}).
 @item @key{DEL}
-@kindex 177 DEL @r{(}@code{vip-delete-backward-char}@r{)}
+@kindex 177 @kbd{DEL} (@code{vip-delete-backward-char})
 Delete a character before point.  Given @var{n}, delete @var{n} characters
 (@code{vip-delete-backward-char}).
 @end table
@@ -1385,7 +1385,7 @@ commands that put back the yanked text into the buffer.
 
 @table @kbd
 @item y @var{motion-command}
-@kindex 1710 y @r{(}@code{vip-command-argument}@r{)}
+@kindex 1710 @kbd{y} (@code{vip-command-argument})
 Yank the region determined by the motion command @var{motion-command}.
 @end table
 @noindent
@@ -1398,14 +1398,14 @@ Use the following command to yank consecutive lines of text.
 @table @kbd
 @item y y
 @itemx Y
-@kindex 131 Y @r{(}@code{vip-yank-line}@r{)}
-@kindex 1712 y y @r{(}@code{vip-yank-line}@r{)}
+@kindex 131 @kbd{Y} (@code{vip-yank-line})
+@kindex 1712 @kbd{y y} (@code{vip-yank-line})
 Yank a line.  Given @var{n}, yank @var{n} lines (@code{vip-yank-line}).
 @item y r
-@kindex 1712 y r
+@kindex 1712 @kbd{y r}
 Yank current region.
 @item y R
-@kindex 1711 y R
+@kindex 1711 @kbd{y R}
 Expand current region and yank it.
 @end table
 
@@ -1416,7 +1416,7 @@ below.
 
 @table @kbd
 @item p
-@kindex 160 p @r{(}@code{vip-put-back}@r{)}
+@kindex 160 @kbd{p} (@code{vip-put-back})
 Insert, after the character point is looking at, most recently
 deleted/yanked text from anonymous register. Given a register name
 argument, the content of the named register will be put back.  Given a
@@ -1424,7 +1424,7 @@ count, the command will be repeated that many times. This command also
 checks if the text to put back ends with a new line character, and if so
 the text will be put below the current line (@code{vip-put-back}).
 @item P
-@kindex 120 P @r{(}@code{vip-Put-back}@r{)}
+@kindex 120 @kbd{P} (@code{vip-Put-back})
 Insert at point most recently deleted/yanked text from anonymous register.
 Given a register name argument, the content of the named register will
 be put back.  Given a count, the command will be repeated that many times.
@@ -1447,7 +1447,7 @@ Most commonly used change command takes the following form.
 
 @table @kbd
 @item c @var{motion-command}
-@kindex 1430 c @r{(}@code{vip-command-argument}@r{)}
+@kindex 1430 @kbd{c} (@code{vip-command-argument})
 Replace the content of the region determined by the motion command
 @var{motion-command} by the text you type.  If the motion command is a
 point command then you will type the text into minibuffer, and if the
@@ -1463,13 +1463,13 @@ command.
 
 @table @kbd
 @item c c
-@kindex 1432 c c
+@kindex 1432 @kbd{c c}
 Change a line.  Given a count, that many lines are changed.
 @item c r
-@kindex 1432 c r
+@kindex 1432 @kbd{c r}
 Change current region.
 @item c R
-@kindex 1431 c R
+@kindex 1431 @kbd{c R}
 Expand current region and change it.
 @end table
 
@@ -1481,13 +1481,13 @@ it.  It is also very easy to undo changes made by modifying commands.
 
 @table @kbd
 @item u
-@kindex 165 u @r{(}@code{vip-undo}@r{)}
+@kindex 165 @kbd{u} (@code{vip-undo})
 Undo the last change.  You can undo more by repeating undo by the repeat
 command @samp{.}.  For example, you can undo 5 previous changes by typing
 @samp{u....}.  If you type @samp{uu}, then the second @samp{u} undoes the
 first undo command (@code{vip-undo}).
 @item .
-@kindex 056 . @r{(}@code{vip-repeat}@r{)}
+@kindex 056 @kbd{.} (@code{vip-repeat})
 Repeat the last modifying command.  Given count @var{n} it becomes the new
 count for the repeated command.  Otherwise, the count for the last
 modifying command is used again (@code{vip-repeat}).
@@ -1500,12 +1500,12 @@ Miscellaneous Vi commands are collected here.
 
 @table @kbd
 @item Z Z
-@kindex 132 Z Z @r{(}@code{save-buffers-kill-emacs}@r{)}
+@kindex 132 @kbd{Z Z} (@code{save-buffers-kill-emacs})
 Exit Emacs.  If modified buffers exist, you will be asked whether you wish
 to save them or not (@code{save-buffers-kill-emacs}).
 @item !@: @var{motion-command} @var{format-command}
 @itemx @var{n} !@: !@: @var{format-command}
-@kindex 041 ! @r{(}@code{vip-command-argument}@r{)}
+@kindex 041 @kbd{!} (@code{vip-command-argument})
 The region determined by the motion command @var{motion-command} will be
 given to the shell command @var{format-command} and the region will be
 replaced by its output.  If a count is given, it will be passed to
@@ -1514,30 +1514,30 @@ between point and the 3rd line.  If @kbd{!} is used instead of
 @var{motion-command} then @var{n} lines will be processed by
 @var{format-command} (@code{vip-command-argument}).
 @item J
-@kindex 112 J @r{(}@code{vip-join-lines}@r{)}
+@kindex 112 @kbd{J} (@code{vip-join-lines})
 Join two lines.  Given count, join that many lines.  A space will be
 inserted at each junction (@code{vip-join-lines}).
 @item < @var{motion-command}
 @itemx @var{n} < <
-@kindex 074 < @r{(}@code{vip-command-argument}@r{)}
+@kindex 074 @kbd{<} (@code{vip-command-argument})
 Shift region determined by the motion command @var{motion-command} to
 left by @var{shift-width} (default is 8).  If @kbd{<} is used instead of
 @var{motion-command} then shift @var{n} lines
 @*(@code{vip-command-argument}).
 @item > @var{motion-command}
 @itemx @var{n} > >
-@kindex 076 > @r{(}@code{vip-command-argument}@r{)}
+@kindex 076 @kbd{>} (@code{vip-command-argument})
 Shift region determined by the motion command @var{motion-command} to
 right by @var{shift-width} (default is 8).  If @kbd{<} is used instead of
 @var{motion-command} then shift @var{n} lines
 @*(@code{vip-command-argument}).
 @item = @var{motion-command}
-@kindex 075 = @r{(}@code{vip-command-argument}@r{)}
+@kindex 075 @kbd{=} (@code{vip-command-argument})
 Indent region determined by the motion command @var{motion-command}.  If
 @kbd{=} is used instead of @var{motion-command} then indent @var{n} lines
 (@code{vip-command-argument}).
 @item *
-@kindex 052 * @r{(}@code{vip-call-last-kbd-macro}@r{)}
+@kindex 052 @kbd{*} (@code{vip-call-last-kbd-macro})
 Call last remembered keyboard macro.
 @item #
 A new vi operator. @xref{New Commands}, for more details.
@@ -1546,14 +1546,14 @@ A new vi operator. @xref{New Commands}, for more details.
 The following keys are reserved for future extensions, and currently
 assigned to a function that just beeps (@code{vip-nil}).
 
-@kindex 046 & @r{(}@code{vip-nil}@r{)}
-@kindex 100 @@ @r{(}@code{vip-nil}@r{)}
-@kindex 125 U @r{(}@code{vip-nil}@r{)}
-@kindex 133 [ @r{(}@code{vip-nil}@r{)}
-@kindex 135 ] @r{(}@code{vip-nil}@r{)}
-@kindex 137 _ @r{(}@code{vip-nil}@r{)}
-@kindex 161 q @r{(}@code{vip-nil}@r{)}
-@kindex 176 ~ @r{(}@code{vip-nil}@r{)}
+@kindex 046 @kbd{&} (@code{vip-nil})
+@kindex 100 @kbd{@@} (@code{vip-nil})
+@kindex 125 @kbd{U} (@code{vip-nil})
+@kindex 133 @kbd{[} (@code{vip-nil})
+@kindex 135 @kbd{]} (@code{vip-nil})
+@kindex 137 @kbd{_} (@code{vip-nil})
+@kindex 161 @kbd{q} (@code{vip-nil})
+@kindex 176 @kbd{~} (@code{vip-nil})
 
 @example
 &, @@, U, [, ], _, q, ~
@@ -1567,48 +1567,48 @@ keymap.  See GNU Emacs Manual for details.
 
 @table @kbd
 @item C-@@
-@kindex 000 C-@@ @r{(}@code{set-mark-command}@r{)}
+@kindex 000 @kbd{C-@@} (@code{set-mark-command})
 Set mark and push previous mark on mark ring (@code{set-mark-command}).
-@item @key{TAB}
-@kindex 011 TAB @r{(}@code{indent-for-tab-command}@r{)}
+@item TAB
+@kindex 011 TAB (@code{indent-for-tab-command})
 Indent line for current major mode (@code{indent-for-tab-command}).
 @item C-j
-@kindex 012 C-j @r{(}@code{electric-newline-and-maybe-indent}@r{)}
+@kindex 012 @kbd{C-j} (@code{electric-newline-and-maybe-indent})
 Insert a newline, and maybe indent according to mode.
 @item C-k
-@kindex 013 C-k @r{(}@code{kill-line}@r{)}
+@kindex 013 @kbd{C-k} (@code{kill-line})
 Kill the rest of the current line; before a newline, kill the newline.
 With a numeric argument, kill that many lines from point.  Negative arguments
 kill lines backward (@code{kill-line}).
 @item C-l
-@kindex 014 C-l @r{(}@code{recenter}@r{)}
+@kindex 014 @kbd{C-l} (@code{recenter})
 Clear the screen and reprint everything (@code{recenter}).
 @item @var{n} C-p
-@kindex 020 C-p @r{(}@code{previous-line}@r{)}
+@kindex 020 @kbd{C-p} (@code{previous-line})
 Move cursor vertically up @var{n} lines (@code{previous-line}).
 @item C-q
-@kindex 021 C-q @r{(}@code{quoted-insert}@r{)}
+@kindex 021 @kbd{C-q} (@code{quoted-insert})
 Read next input character and insert it.  Useful for inserting control
 characters
 @*(@code{quoted-insert}).
 @item C-r
-@kindex 022 C-r @r{(}@code{isearch-backward}@r{)}
+@kindex 022 @kbd{C-r} (@code{isearch-backward})
 Search backward incrementally (@code{isearch-backward}).
 @item C-s
-@kindex 023 C-s @r{(}@code{isearch-forward}@r{)}
+@kindex 023 @kbd{C-s} (@code{isearch-forward})
 Search forward incrementally (@code{isearch-forward}).
 @item @var{n} C-t
-@kindex 024 C-t @r{(}@code{transpose-chars}@r{)}
+@kindex 024 @kbd{C-t} (@code{transpose-chars})
 Interchange characters around point, moving forward one character.  With
 count @var{n}, take character before point and drag it forward past @var{n}
 other characters.  If no argument and at end of line, the previous two
 characters are exchanged (@code{transpose-chars}).
 @item @var{n} C-v
-@kindex 026 C-v @r{(}@code{scroll-up}@r{)}
+@kindex 026 @kbd{C-v} (@code{scroll-up})
 Scroll text upward @var{n} lines.  If @var{n} is not given, scroll near
 full screen (@code{scroll-up}).
 @item C-w
-@kindex 027 C-w @r{(}@code{kill-region}@r{)}
+@kindex 027 @kbd{C-w} (@code{kill-region})
 Kill between point and mark.  The text is save in the kill ring.  The
 command @kbd{P} or @kbd{p} can retrieve it from kill ring
 (@code{kill-region}).
@@ -1624,29 +1624,29 @@ and you can repeat them by the repeat command @kbd{.} (@code{vip-repeat}).
 
 @table @kbd
 @item i
-@kindex 151 i @r{(}@code{vip-insert}@r{)}
+@kindex 151 @kbd{i} (@code{vip-insert})
 Enter insert mode at point (@code{vip-insert}).
 @item I
-@kindex 111 I @r{(}@code{vip-Insert}@r{)}
+@kindex 111 @kbd{I} (@code{vip-Insert})
 Enter insert mode at the first non white character on the line
 (@code{vip-Insert}).
 @item a
-@kindex 141 a @r{(}@code{vip-append}@r{)}
+@kindex 141 @kbd{a} (@code{vip-append})
 Move point forward by one character and then enter insert mode
 (@code{vip-append}).
 @item A
-@kindex 101 A @r{(}@code{vip-Append}@r{)}
+@kindex 101 @kbd{A} (@code{vip-Append})
 Enter insert mode at end of line (@code{vip-Append}).
 @item o
-@kindex 157 o @r{(}@code{vip-open-line}@r{)}
+@kindex 157 @kbd{o} (@code{vip-open-line})
 Open a new line below the current line and enter insert mode
 (@code{vip-open-line}).
 @item O
-@kindex 117 O @r{(}@code{vip-Open-line}@r{)}
+@kindex 117 @kbd{O} (@code{vip-Open-line})
 Open a new line above the current line and enter insert mode
 (@code{vip-Open-line}).
 @item C-o
-@kindex 017 C-o @r{(}@code{vip-open-line-at-point}@r{)}
+@kindex 017 @kbd{C-o} (@code{vip-open-line-at-point})
 Insert a newline and leave point before it, and then enter insert mode
 @*(@code{vip-open-line-at-point}).
 @end table
@@ -1656,16 +1656,16 @@ differently from emacs mode.
 
 @table @kbd
 @item @key{ESC}
-@kindex 033 ESC @r{(}@code{vip-change-mode-to-vi}@r{) (insert mode)}
+@kindex 033 @kbd{ESC} (@code{vip-change-mode-to-vi}) (insert mode)
 This key will take you back to vi mode (@code{vip-change-mode-to-vi}).
 @item C-h
-@kindex 010 C-h @r{(}@code{delete-backward-char}@r{) (insert mode)}
+@kindex 010 @kbd{C-h} (@code{delete-backward-char}) (insert mode)
 Delete previous character (@code{delete-backward-char}).
 @item C-w
-@kindex 027 C-w @r{(}@code{vip-delete-backward-word}@r{) (insert mode)}
+@kindex 027 @kbd{C-w} (@code{vip-delete-backward-word}) (insert mode)
 Delete previous word (@code{vip-delete-backward-word}).
 @item C-z
-@kindex 032 C-z @r{(}@code{vip-ESC}@r{) (insert mode)}
+@kindex 032 @kbd{C-z} (@code{vip-ESC}) (insert mode)
 This key simulates @key{ESC} key in emacs mode.  For instance, typing
 @kbd{C-z x} in insert mode is the same as typing @kbd{ESC x} in emacs mode
 (@code{vip-ESC}).
@@ -1685,7 +1685,7 @@ commands while in insert mode.
 @node Ex Commands
 @chapter Ex Commands
 
-@kindex 072 : @r{(}@code{vip-ex}@r{)}
+@kindex 072 @kbd{:} (@code{vip-ex})
 
 In vi mode, you can execute an Ex command @var{ex-command} by typing:
 @example
diff --git a/doc/misc/viper.texi b/doc/misc/viper.texi
index 2b300f6493..8948437632 100644
--- a/doc/misc/viper.texi
+++ b/doc/misc/viper.texi
@@ -368,9 +368,9 @@ toggles Viperization of Emacs on and off.
 @node States in Viper
 @section States in Viper
 
-@kindex C-z
-@kindex ESC
-@kindex i
+@kindex @kbd{C-z}
+@kindex @key{ESC}
+@kindex @kbd{i}
 @cindex Emacs state
 @cindex Vi state
 @cindex Insert state
@@ -474,7 +474,7 @@ to allow Emacs keys in Insert state.
 @node Emacs State
 @subsection Emacs State
 
-@kindex C-z
+@kindex @kbd{C-z}
 @cindex Emacs state
 
 
@@ -514,7 +514,7 @@ exceptions are:
 
 @table @kbd
 @item C-x
-@kindex C-x
+@kindex @kbd{C-x}
 @kbd{C-x} is used to invoke Emacs commands, mainly those that do window
 management.  @kbd{C-x 2} will split a window, @kbd{C-x 0} will close a
 window.  @kbd{C-x 1} will close all other windows.  @kbd{C-xb} is used to
@@ -523,14 +523,14 @@ These are about the only necessary keystrokes.
 For the rest, see the GNU Emacs Manual.
 
 @item C-c
-@kindex C-c
+@kindex @kbd{C-c}
 For user levels 2 and higher, this key serves as a prefix key for the key
 sequences used by various major modes.  For users at Viper level 1, @kbd{C-c}
 simply beeps.
 
 @item C-g and C-]
-@kindex C-g
-@kindex C-]
+@kindex @kbd{C-g}
+@kindex @kbd{C-]}
 
 These are the Emacs @samp{quit} keys.
 There will be cases where you will have to
@@ -543,7 +543,7 @@ Edit,Recursive Edit,emacs,The GNU Emacs Manual}.
 At user level 1, @kbd{C-g} is bound to @code{viper-info-on-file}
 function instead.
 @item C-\
-@kindex C-\
+@kindex @kbd{C-\}
 @cindex Meta key
 
 Viper uses @key{ESC} as a switch between Insert and Vi states.  Emacs uses
@@ -569,7 +569,7 @@ about are:
 
 @table @samp
 @item Undo
-@kindex u
+@kindex @kbd{u}
 @kbd{u} will undo.  Undo can be repeated by the @kbd{.} key.  Undo itself
 can be undone.  Another @kbd{u} will change the direction.  The presence
 of repeatable undo means that @kbd{U}, undoing lines, is not very
@@ -599,7 +599,7 @@ to case-insensitive and back.
 @cindex vanilla search
 @cindex case-sensitive search
 @cindex case-insensitive search
-@kindex C-c /
+@kindex @kbd{C-c /}
 
 @item Ex commands
 @cindex Ex commands
@@ -1083,7 +1083,7 @@ remembered (This is called ``learn mode'' in some editors.)
 where @samp{register} is any character from @samp{a} through @samp{z}.  Then
 you can execute this macro using @kbd{@@register}.  It is, of course,
 possible to yank some text into a register and execute it using
-@kbd{@@register}.  Typing @kbd{@@@@}, @kbd{@@@key{RET}}, or @kbd{@@C-j} will
+@kbd{@@register}.  Typing @kbd{@@@@}, @kbd{@@RET}, or @kbd{@@C-j} will
 execute the last macro that was executed using @kbd{@@register}.
 
 Viper will automatically lowercase the register, so that pressing the
@@ -1302,8 +1302,8 @@ These commands have no Vi analogs.
 
 @table @kbd
 @item C-x, C-c
-@kindex C-x
-@kindex C-c
+@kindex @kbd{C-x}
+@kindex @kbd{C-c}
 These two keys invoke many important Emacs functions.  For example, if you
 hit @kbd{C-x} followed by @kbd{2}, then the current window will be split
 into 2.  Except for novice users, @kbd{C-c} is also set to execute an Emacs
@@ -1313,11 +1313,11 @@ configure @key{ESC} as Meta by setting @code{viper-no-multiple-ESC} to
 @kbd{C-\} in Insert, Replace, or Vi states will make Emacs think
 @kbd{Meta} has been hit.
 @item \
-@kindex \
+@kindex @kbd{\}
 Escape to Emacs to execute a single Emacs command.  For instance,
 @kbd{\ @key{ESC}} will act like a Meta key.
 @item Q
-@kindex Q
+@kindex @kbd{Q}
 @cindex query replace
 @kbd{Q} is for query replace.  By default,
 each string to be replaced is treated as a regular expression.  You can use
@@ -1327,16 +1327,16 @@ that @kbd{:se nomagic} turns Regexps off completely, unlike Vi).
 @item v
 @itemx V
 @itemx C-v
-@kindex v
-@kindex V
-@kindex C-v
+@kindex @kbd{v}
+@kindex @kbd{V}
+@kindex @kbd{C-v}
 These keys are used to visit files.  @kbd{v} will switch to a buffer
 visiting file whose name can be entered in the minibuffer.  @kbd{V} is
 similar, but will use a window different from the current window.
 @kbd{C-v} is like @kbd{V}, except that a new frame (X window) will be used
 instead of a new Emacs window.
 @item #
-@kindex #
+@kindex @kbd{#}
 If followed by a certain character @var{ch}, it becomes an operator whose
 argument is the region determined by the motion command that follows
 (indicated as <move>).
@@ -1344,34 +1344,34 @@ Currently, @var{ch} can be one of @kbd{c}, @kbd{C}, @kbd{g}, @kbd{q}, and
 @kbd{s}.  For instance, @kbd{#qr} will prompt you for a string and then
 prepend this string to each line in the buffer.
 @item # c
-@kindex #c<move>
+@kindex @kbd{#c<move>}
 @cindex changing case
 Change upper-case characters in the region to lower-case
 (@code{downcase-region}).
 Emacs command @kbd{M-l} does the same for words.
 @item # C
-@kindex #C<move>
+@kindex @kbd{#C<move>}
 Change lower-case characters in the region to upper-case.  For instance,
 @kbd{# C 3 w} will capitalize 3 words from the current point
 (@code{upcase-region}).
 Emacs command @kbd{M-u} does the same for words.
 @item # g
-@kindex #g<move>
+@kindex @kbd{#g<move>}
 Execute last keyboard macro for each line in the region
 (@code{viper-global-execute}).
 @item # q
-@kindex #q<move>
+@kindex @kbd{#q<move>}
 Insert specified string at the beginning of each line in the region
 (@code{viper-quote-region}).  The default string is composed of the comment
 character(s) appropriate for the current major mode.
 @item # s
-@kindex #s<move>
+@kindex @kbd{#s<move>}
 Check spelling of words in the region (@code{spell-region}).
 The function used for spelling is determined from the variable
 @code{viper-spell-function}.
 @vindex viper-spell-function
 @item *
-@kindex *
+@kindex @kbd{*}
 Call last keyboard macro.
 @item m .
 Set mark at point and push old mark off the ring
@@ -1382,41 +1382,41 @@ Set mark at beginning and end of buffer, respectively.
 Jump to mark and pop mark off the ring.  @xref{Mark,,Mark,emacs,The GNU
 Emacs Manual}, for more info.
 @item ] register
-@kindex ]<a-z>
+@kindex @kbd{]<a-z>}
 View contents of register
 @item [ textmarker
-@kindex [<a-z>
+@kindex @kbd{[<a-z>}
 View filename and position of textmarker
 @item @@#
 @item @@register
 @item @@!
-@kindex @@#
-@kindex @@<a-z>
-@kindex @@!
+@kindex @kbd{@@#}
+@kindex @kbd{@@<a-z>}
+@kindex @kbd{@@!}
 @cindex keyboard macros
 @cindex register execution
 
 Begin/end keyboard macro.  @@register has a different meaning when used after
 a @kbd{@@#}.  @xref{Macros and Registers}, for details
 @item []
-@kindex []
+@kindex @kbd{[]}
 Go to end of heading.
 @item g <@emph{movement command}>
 Search buffer for text delimited by movement command.  The canonical
 example is @kbd{gw} to search for the word under the cursor.
 @xref{Improved Search}, for details.
 @item C-g and C-]
-@kindex C-g
-@kindex C-]
+@kindex @kbd{C-g}
+@kindex @kbd{C-]}
 Quit and Abort Recursive edit.  These may be necessary on occasion.
 @xref{Vi State}, for a reason.
 @item C-c C-g
-@kindex C-c C-g
+@kindex @kbd{C-c C-g}
 Hitting @kbd{C-c} followed by @kbd{C-g} will display the information on the
 current buffer.  This is the same as hitting @kbd{C-g} in Vi, but, as
 explained above, @kbd{C-g} is needed for other purposes in Emacs.
 @item C-c /
-@kindex C-c /
+@kindex @kbd{C-c /}
 Without a prefix argument, this command toggles
 case-sensitive/case-insensitive search modes and plain vanilla/regular
 expression search.  With the prefix argument 1, i.e.,
@@ -1429,21 +1429,21 @@ this function.
 @cindex case-insensitive search
 
 @item M-p and M-n
-@kindex M-p
-@kindex M-n
+@kindex @kbd{M-p}
+@kindex @kbd{M-n}
 In the minibuffer, these commands navigate through the minibuffer
 histories, such as the history of search strings, Ex commands, etc.
 
 @item C-s
-@kindex C-s
+@kindex @kbd{C-s}
 If the minibuffer is entered via a Viper search commands @kbd{/} or @kbd{?},
 then typing this key inserts the last search string used by the
 Emacs incremental search command (that is bound to @kbd{C-s} everywhere
 except in this case).
 
 @item C-c M-p and C-c M-n
-@kindex C-c M-p
-@kindex C-c M-n
+@kindex @kbd{C-c M-p}
+@kindex @kbd{C-c M-n}
 @cindex Insertion history
 @cindex Insertion ring
 @cindex Command history
@@ -2669,10 +2669,10 @@ purpose of mouse search and mouse insert.  By default, this is set to
 @code{double-click-time} in Emacs and to
 @code{mouse-track-multi-click-time} milliseconds in XEmacs.
 @end table
-@kindex S-mouse-1
-@kindex S-mouse-2
-@kindex META SHIFT button1up
-@kindex META SHIFT button2up
+@kindex @kbd{S-mouse-1}
+@kindex @kbd{S-mouse-2}
+@kindex @kbd{meta shift button1up}
+@kindex @kbd{meta shift button2up}
 @vindex viper-multiclick-timeout
 @findex viper-mouse-click-insert-word
 @findex viper-mouse-click-search-word
@@ -3383,60 +3383,60 @@ don't want this macro, put
 in your Viper customization file.
 
 @end table
-@kindex %
-@kindex C-c /
-@kindex N
-@kindex n
-@kindex ?<cr>
-@kindex /<cr>
-@kindex ?<string>
-@kindex /<string>
-@kindex ''
-@kindex ``
-@kindex ]<a-z>
-@kindex [<a-z>
-@kindex '<a-z>
-@kindex `<a-z>
-@kindex m<a-z>
-@kindex []
-@kindex [[
-@kindex ]]
-@kindex @{
-@kindex @}
-@kindex (
-@kindex )
-@kindex M
-@kindex L
-@kindex H
-@kindex G
-@kindex E
-@kindex e
-@kindex B
-@kindex b
-@kindex W
-@kindex w
-@kindex ,
-@kindex ;
-@kindex T<char>
-@kindex F<char>
-@kindex t<char>
-@kindex f<char>
-@kindex |
-@kindex 0
-@kindex CR
-@kindex +
-@kindex -
-@kindex ^
-@kindex $
-@kindex C-p
-@kindex LF
-@kindex SPC
-@kindex C-n
-@kindex C-h
-@kindex h
-@kindex j
-@kindex k
-@kindex l
+@kindex @kbd{%}
+@kindex @kbd{C-c /}
+@kindex @kbd{N}
+@kindex @kbd{n}
+@kindex @kbd{?<cr>}
+@kindex @kbd{/<cr>}
+@kindex @kbd{?<string>}
+@kindex @kbd{/<string>}
+@kindex @kbd{''}
+@kindex @kbd{``}
+@kindex @kbd{]<a-z>}
+@kindex @kbd{[<a-z>}
+@kindex @kbd{'<a-z>}
+@kindex @kbd{`<a-z>}
+@kindex @kbd{m<a-z>}
+@kindex @kbd{[]}
+@kindex @kbd{[[}
+@kindex @kbd{]]}
+@kindex @kbd{@{}
+@kindex @kbd{@}}
+@kindex @kbd{(}
+@kindex @kbd{)}
+@kindex @kbd{M}
+@kindex @kbd{L}
+@kindex @kbd{H}
+@kindex @kbd{G}
+@kindex @kbd{E}
+@kindex @kbd{e}
+@kindex @kbd{B}
+@kindex @kbd{b}
+@kindex @kbd{W}
+@kindex @kbd{w}
+@kindex @kbd{,}
+@kindex @kbd{;}
+@kindex @kbd{T<char>}
+@kindex @kbd{F<char>}
+@kindex @kbd{t<char>}
+@kindex @kbd{f<char>}
+@kindex @kbd{|}
+@kindex @kbd{0}
+@kindex @kbd{<cr>}
+@kindex @kbd{+}
+@kindex @kbd{-}
+@kindex @kbd{^}
+@kindex @kbd{$}
+@kindex @kbd{C-p}
+@kindex @kbd{<lf>}
+@kindex @kbd{<sp>}
+@kindex @kbd{C-n}
+@kindex @kbd{C-h}
+@kindex @kbd{h}
+@kindex @kbd{j}
+@kindex @kbd{k}
+@kindex @kbd{l}
 @vindex viper-parse-sexp-ignore-comments
 
 @node Marking
@@ -3478,18 +3478,18 @@ Go to specified Viper mark.
 @item `<a-z>
 Go to specified Viper mark and go to the first CHAR on line.
 @end table
-@kindex m<a-z>
-@kindex m.
-@kindex m>
-@kindex m<
-@kindex m,
-@kindex m^
+@kindex @kbd{m<a-z>}
+@kindex @kbd{m.}
+@kindex @kbd{m>}
+@kindex @kbd{m<}
+@kindex @kbd{m,}
+@kindex @kbd{m^}
 @findex @kbd{Ex mark}
 @findex @kbd{Ex k}
-@kindex ''
-@kindex ``
-@kindex `<a-z>
-@kindex '<a-z>
+@kindex @kbd{''}
+@kindex @kbd{``}
+@kindex @kbd{`<a-z>}
+@kindex @kbd{'<a-z>}
 
 @node  Appending Text
 @subsection Appending Text
@@ -3556,22 +3556,22 @@ Since typing the above sequences of keys may be tedious, the
 functions doing the perusing can be bound to unused keyboard keys in the
 Viper customization file.  @xref{Viper Specials}, for details.
 @end table
-@kindex C-c M-p
-@kindex C-c M-n
-@kindex .
-@kindex ]<a-z>
-@kindex [<a-z>
-@kindex P
-@kindex p
-@kindex "<a-z1-9>p
-@kindex "<a-z1-9>P
-@kindex >>
-@kindex ><move>
-@kindex O
-@kindex o
-@kindex i
-@kindex A
-@kindex a
+@kindex @kbd{C-c M-p}
+@kindex @kbd{C-c M-n}
+@kindex @kbd{.}
+@kindex @kbd{]<a-z>}
+@kindex @kbd{[<a-z>}
+@kindex @kbd{P}
+@kindex @kbd{p}
+@kindex @kbd{"<a-z1-9>p}
+@kindex @kbd{"<a-z1-9>P}
+@kindex @kbd{>>}
+@kindex @kbd{><move>}
+@kindex @kbd{O}
+@kindex @kbd{o}
+@kindex @kbd{i}
+@kindex @kbd{A}
+@kindex @kbd{a}
 
 @node Editing in Insert State
 @subsection Editing in Insert State
@@ -3595,9 +3595,9 @@ Back to the begin of the change on the
 current line.
 
 @end table
-@kindex C-u
-@kindex C-w
-@kindex C-v
+@kindex @kbd{C-u}
+@kindex @kbd{C-w}
+@kindex @kbd{C-v}
 
 @node Deleting Text
 @subsection Deleting Text
@@ -3634,13 +3634,13 @@ shiftwidth to the left (layout!).
 @item <count>  <<
 Shift <count> lines one shiftwidth to the left.
 @end table
-@kindex <<
-@kindex <<move>
-@kindex D
-@kindex dd
-@kindex d<move>
-@kindex X
-@kindex x
+@kindex @kbd{<<}
+@kindex @kbd{<<move>}
+@kindex @kbd{D}
+@kindex @kbd{dd}
+@kindex @kbd{d<move>}
+@kindex @kbd{X}
+@kindex @kbd{x}
 
 @node Changing Text
 @subsection Changing Text
@@ -3727,28 +3727,28 @@ In Vi state, these keys are bound to functions that peruse the history of
 destructive Vi commands.
 @xref{Viper Specials}, for details.
 @end table
-@kindex C-c M-p
-@kindex C-c M-n
-@kindex #q<move>
-@kindex #C<move>
-@kindex #c<move>
-@kindex &
-@kindex \&
+@kindex @kbd{C-c M-p}
+@kindex @kbd{C-c M-n}
+@kindex @kbd{#q<move> }
+@kindex @kbd{#C<move>}
+@kindex @kbd{#c<move>}
+@kindex @kbd{&}
+@kindex @kbd{\&}
 @findex @kbd{Ex substitute/<pat>/<repl>/<f>}
 @findex @kbd{Ex s/<pat>/<repl>/<f>}
 @findex @kbd{Ex copy [z]}
 @findex @kbd{Ex t [z]}
 @findex @kbd{Ex move [z]}
-@kindex J
-@kindex ~
-@kindex =<move>
-@kindex C
-@kindex cc
-@kindex c<move>
-@kindex S
-@kindex s
-@kindex R
-@kindex r<char>
+@kindex @kbd{J}
+@kindex @kbd{~}
+@kindex @kbd{=<move>}
+@kindex @kbd{C}
+@kindex @kbd{cc}
+@kindex @kbd{c<move>}
+@kindex @kbd{S}
+@kindex @kbd{s}
+@kindex @kbd{R}
+@kindex @kbd{r<char>}
 
 @node Search and Replace
 @subsection Search and Replace
@@ -3817,21 +3817,21 @@ Execute <ex-command> on all lines that match <pattern>.
 @itemx :v /<pattern>/<ex-command>
 Execute <ex-command> on all lines that do not match <pattern>.
 @end table
-@kindex &
+@kindex @kbd{&}
 @findex @kbd{Ex substitute/<pat>/<repl>/<f>}
-@kindex Q
-@kindex #g<move>
+@kindex @kbd{Q}
+@kindex @kbd{#g<move>}
 @findex @kbd{Ex v}
 @findex @kbd{Ex g}
 @findex @kbd{Ex global}
 @findex @kbd{Ex vglobal}
 @findex @kbd{Ex tag <name>}
-@kindex %
-@kindex N
-@kindex n
-@kindex g<move>
-@kindex ?<string>
-@kindex /<string>
+@kindex @kbd{%}
+@kindex @kbd{N}
+@kindex @kbd{n}
+@kindex @kbd{g<move>}
+@kindex @kbd{?<string>}
+@kindex @kbd{/<string>}
 
 @node Yanking
 @subsection Yanking
@@ -3865,19 +3865,19 @@ be automatically down-cased.
 Put the contents of the (default undo) buffer
 <count> times before the cursor.  The register will
 @end table
-@kindex P
-@kindex p
-@kindex "<a-z1-9>p
-@kindex "<a-z1-9>P
-@kindex ]<a-z>
-@kindex [<a-z>
-@kindex m<a-z>
-@kindex Y
-@kindex yy
-@kindex "<A-Z>y<move>
-@kindex "<a-z>y<move>
-@kindex y<move>
-@kindex yank
+@kindex @kbd{P}
+@kindex @kbd{p}
+@kindex @kbd{"<a-z1-9>p}
+@kindex @kbd{"<a-z1-9>P}
+@kindex @kbd{]<a-z>}
+@kindex @kbd{[<a-z>}
+@kindex @kbd{m<a-z>}
+@kindex @kbd{Y}
+@kindex @kbd{yy}
+@kindex @kbd{"<A-Z>y<move>}
+@kindex @kbd{"<a-z>y<move>}
+@kindex @kbd{y<move>}
+@kindex @kbd{yank}
 @findex @kbd{Ex yank}
 
 @node Undoing
@@ -3902,9 +3902,9 @@ that have a @samp{~} appended to them.
 @findex @kbd{Ex rec}
 @findex @kbd{Ex e!}
 @findex @kbd{Ex q!}
-@kindex .
-@kindex U
-@kindex u
+@kindex @kbd{.}
+@kindex @kbd{U}
+@kindex @kbd{u}
 
 @node Display
 @section Display
@@ -3948,21 +3948,21 @@ Put line <count> at the bottom of the window
 Put line <count> in the center of the window
 (default the current line).
 @end table
-@kindex zM
-@kindex zL
-@kindex zH
-@kindex z<cr>
-@kindex z.
-@kindex z-
-@kindex z<cr>
-@kindex C-b
-@kindex C-f
-@kindex C-u
-@kindex C-d
-@kindex C-y
-@kindex C-e
-@kindex C-l
-@kindex C-g
+@kindex @kbd{zM}
+@kindex @kbd{zL}
+@kindex @kbd{zH}
+@kindex @kbd{z<cr>}
+@kindex @kbd{z.}
+@kindex @kbd{z-}
+@kindex @kbd{z<cr>}
+@kindex @kbd{C-b}
+@kindex @kbd{C-f}
+@kindex @kbd{C-u}
+@kindex @kbd{C-d}
+@kindex @kbd{C-y}
+@kindex @kbd{C-e}
+@kindex @kbd{C-l}
+@kindex @kbd{C-g}
 
 
 @node File and Buffer Handling
@@ -4078,11 +4078,11 @@ Read the file <name> into the buffer after the line <address>.
 Edit a file in current or another window, or in another frame.  File name
 is typed in minibuffer.  File completion and history are supported.
 @end table
-@kindex v
-@kindex V
+@kindex @kbd{v}
+@kindex @kbd{V}
 @findex @kbd{Ex args}
 @findex @kbd{Ex rew}
-@kindex C-^
+@kindex @kbd{C-^}
 @findex @kbd{Ex e!@: [<files>]}
 @findex @kbd{Ex e [<files>]}
 @findex @kbd{Ex edit [<files>]}
@@ -4096,7 +4096,7 @@ is typed in minibuffer.  File completion and history are supported.
 @findex @kbd{Ex r}
 @findex @kbd{Ex read}
 @findex @kbd{Ex pre}
-@kindex ZZ
+@kindex @kbd{ZZ}
 @findex @kbd{Ex wq}
 @findex @kbd{Ex w <file>}
 @findex @kbd{Ex w!@: <file>}
@@ -4171,14 +4171,14 @@ Show contents of textmarker.
 @item ]<a-z>
 Show contents of register.
 @end table
-@kindex ]<a-z>
-@kindex [<a-z>
-@kindex #g<move>
-@kindex *
-@kindex @@!<a-z>
-@kindex @@#
-@kindex @@@@
-@kindex @@<a-z>
+@kindex @kbd{]<a-z>}
+@kindex @kbd{[<a-z>}
+@kindex @kbd{#g<move>}
+@kindex @kbd{*}
+@kindex @kbd{@@!<a-z>}
+@kindex @kbd{@@#}
+@kindex @kbd{@@@@}
+@kindex @kbd{@@<a-z>}
 @findex @kbd{Ex unmap <char>}
 @findex @kbd{Ex map <char> <seq>}
 @findex @kbd{Ex unmap!@: <char>}
@@ -4410,16 +4410,16 @@ Undoes the last @kbd{C-y} and puts another kill from the kill ring.
 Using this command, you can try may different kills until you find the one
 you need.
 @end table
-@kindex M-y
-@kindex C-y
-@kindex C-x C-f
-@kindex C-x o
-@kindex C-x 2
-@kindex C-x 1
-@kindex C-x 0
-@kindex C-z
-@kindex C-\
-@kindex C-c\
+@kindex @kbd{M-y}
+@kindex @kbd{C-y}
+@kindex @kbd{C-xC-f}
+@kindex @kbd{C-xo}
+@kindex @kbd{C-x2}
+@kindex @kbd{C-x1}
+@kindex @kbd{C-x0}
+@kindex @kbd{C-z}
+@kindex @kbd{C-\}
+@kindex @kbd{C-c\}
 
 @node Mouse-bound Commands
 @section Mouse-bound Commands
@@ -4445,10 +4445,10 @@ Note: Viper sets this binding only if this mouse action is not
 already bound to something else.
 @xref{Viper Specials}, for more details.
 @end table
-@kindex S-mouse-1
-@kindex S-mouse-2
-@kindex META button1up
-@kindex META button2up
+@kindex @kbd{S-mouse-1}
+@kindex @kbd{S-mouse-2}
+@kindex @kbd{meta button1up}
+@kindex @kbd{meta button2up}
 
 @node GNU Free Documentation License
 @appendix GNU Free Documentation License
diff --git a/etc/NEWS b/etc/NEWS
index 9661bc0913..0eb589f45d 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -83,15 +83,6 @@ Customize the option 'mode-line-default-help-echo' to restore the old
 behavior where the tooltip text is also shown when the corresponding
 action does not apply.
 
-+++
-** New hook 'server-after-make-frame-hook'.
-This hook is a convenient place to perform initializations in daemon
-mode which require GUI features to be available.  One example is
-restoration of the previous session using the desktop.el package: put
-the call to 'desktop-read' in this hook, if you want the GUI settings
-to be restored, or if desktop.el needs to interact with you during
-restoration of the session.
-
 +++
 ** New function 'logcount' calculates an integer's Hamming weight.
 
@@ -151,16 +142,6 @@ This can be controlled by the new `ecomplete-sort-predicate' variable.
 *** The 'ecompleterc' file is now placed in ~/.emacs.d/ecompleterc by default
 Of course it will still find it if you have it in ~/.ecompleterc
 
-** Gnus
-*** The function 'gnus-score-find-favorite-words' has been renamed
-from 'gnus-score-find-favourite-words'.
-
-** Htmlfontify
-*** The functions 'hfy-color', 'hfy-color-vals' and
-'hfy-fallback-color-values' and the variables 'hfy-fallback-color-map'
-and 'hfy-rgb-txt-color-map' have been renamed from names that used
-'colour' instead of 'color'.
-
 ** Smtpmail
 Authentication mechanisms can be added via external packages, by
 defining new cl-defmethod of smtpmail-try-auth-method.
@@ -199,14 +180,6 @@ created by 'edit-last-kbd-macro', and to save the macro by 'C-c C-c'.
 ---
 *** New filter ibuffer-filter-by-process; bound to '/E'.
 
-** Search and Replace
-
-*** 'search-exit-option' provides new options 'move' and 'shift-move'
-to extend the search string by yanking text that ends at the new
-position after moving point in the current buffer.  'shift-move'
-extends the search string by motion commands while holding down
-the shift key.
-
 ** Edebug
 
 +++
@@ -228,10 +201,8 @@ by default.
 
 *** rgrep, lgrep and zrgrep now hide part of the command line
 that contains a list of ignored directories and files.
-Clicking on the button with ellipsis unhides it.
-The abbreviation can be disabled by the new option
-'grep-find-abbreviate'.  The new command
-'grep-find-toggle-abbreviation' toggles it interactively.
+Clicking on the button with ellipsis unhides the truncated part.
+This truncation can be disabled by the new option 'grep-find-hide'.
 
 ** ERT
 
@@ -270,23 +241,12 @@ To restore the old behavior, use
     (add-hook 'eshell-expand-input-functions
               #'eshell-expand-history-references)
 
-*** The function 'shell-uniquify-list' has been renamed from
-'eshell-uniqify-list'.
-
-** Pcomplete
-*** The function 'pcomplete-uniquify-list' has been renamed from
-'pcomplete-uniqify-list'.
-
 ** Tramp
 
 +++
 *** New connection method "owncloud", which allows to access OwnCloud
 or NextCloud hosted files and directories.
 
----
-** The options.el library has been removed.
-It was obsolete since Emacs 22.1, replaced by customize.
-
 
 * New Modes and Packages in Emacs 27.1
 
@@ -317,46 +277,6 @@ as new-style, bind the new variable 'force-new-style-backquotes' to t.
 'cl-struct-define' whose name clashes with a builtin type (e.g.,
 'integer' or 'hash-table') now signals an error.
 
-** When formatting a floating-point number as an octal or hexadecimal
-integer, Emacs now signals an error if the number is too large for the
-implementation to format (Bug#30408).
-
----
-** Some functions and variables obsolete since Emacs 22 have been removed:
-archive-mouse-extract, assoc-ignore-case, assoc-ignore-representation,
-backward-text-line, blink-cursor, bookmark-exit-hooks,
-comint-use-prompt-regexp-instead-of-fields, compilation-finish-function,
-count-text-lines, cperl-vc-header-alist, custom-face-save-command,
-cvs-display-full-path, cvs-fileinfo->full-path, delete-frame-hook,
-derived-mode-class, describe-char-after, describe-project,
-desktop-basefilename, desktop-buffer-handlers,
-desktop-buffer-misc-functions, desktop-buffer-modes-to-save,
-desktop-enable, desktop-load-default, dired-omit-files-p,
-disabled-command-hook, dungeon-mode-map, electric-nroff-mode,
-electric-nroff-newline, electric-perl-terminator, focus-frame,
-forward-text-line, generic-define-mswindows-modes, generic-define-unix-modes,
-generic-font-lock-defaults, goto-address-at-mouse,
-highlight-changes-colours, ibuffer-elide-long-columns, ibuffer-hooks,
-ibuffer-mode-hooks, icalendar-convert-diary-to-ical,
-icalendar-extract-ical-from-buffer, imenu-always-use-completion-buffer-p,
-ipconfig-program, ipconfig-program-options, isearch-lazy-highlight-cleanup,
-isearch-lazy-highlight-cleanup, isearch-lazy-highlight-initial-delay,
-isearch-lazy-highlight-interval, isearch-lazy-highlight-max-at-a-time,
-iswitchb-use-fonts, latin1-char-displayable-p, mouse-wheel-click-button,
-mouse-wheel-down-button, mouse-wheel-up-button, new-frame, pascal-outline,
-process-kill-without-query, recentf-menu-append-commands-p,
-rmail-pop-password, rmail-pop-password-required, savehist-load,
-set-default-font, spam-list-of-processors,
-speedbar-add-ignored-path-regexp, speedbar-buffers-line-path,
-speedbar-buffers-line-path, speedbar-ignored-path-expressions,
-speedbar-ignored-path-regexp, speedbar-line-path, speedbar-path-line,
-timer-set-time-with-usecs, tooltip-gud-display, tooltip-gud-modes,
-tooltip-gud-toggle-dereference, unfocus-frame, unload-hook-features-list,
-update-autoloads-from-directories, vc-comment-ring, vc-comment-ring-index,
-vc-comment-search-forward, vc-comment-search-reverse, vc-comment-to-change-log,
-vc-diff-switches-list, vc-next-comment, vc-previous-comment, view-todo,
-x-lost-selection-hooks, x-sent-selection-hooks
-
 
 * Lisp Changes in Emacs 27.1
 
@@ -398,9 +318,6 @@ remote systems, which support this check.
 If the optional third argument is non-nil, 'make-string' will produce
 a multibyte string even if its second argument is an ASCII character.
 
-** (format "%d" X) no longer mishandles a floating-point number X that
-does not fit in a machine integer (Bug#30408).
-
 ** New JSON parsing and serialization functions 'json-serialize',
 'json-insert', 'json-parse-string', and 'json-parse-buffer'.  These
 are implemented in C using the Jansson library.
diff --git a/etc/NEWS.26 b/etc/NEWS.26
index eded00e655..a8880d0f32 100644
--- a/etc/NEWS.26
+++ b/etc/NEWS.26
@@ -431,9 +431,9 @@ always restricting the margin to a quarter of the window.
 
 +++
 ** Emacs can scroll horizontally using mouse, touchpad, and trackbar.
-You can enable this by customizing 'mouse-wheel-tilt-scroll'.  If you
+You can enable this by customizing 'mwheel-tilt-scroll-p'.  If you
 want to reverse the direction of the scroll, customize
-'mouse-wheel-flip-direction'.
+'mwheel-flip-direction'.
 
 +++
 ** The default GnuTLS priority string now includes %DUMBFW.
@@ -1219,7 +1219,7 @@ backend", which has been updated to benefit from the new UI features.
 ** Term
 
 ---
-*** 'term-char-mode' now makes its buffer read-only.
+*** `term-char-mode' now makes its buffer read-only.
 
 The buffer is made read-only to prevent changes from being made by
 anything other than the process filter; and movements of point away
@@ -1228,8 +1228,8 @@ correct position after each command.  This is needed to avoid states
 which are inconsistent with the state of the terminal understood by
 the inferior process.
 
-New user options 'term-char-mode-buffer-read-only' and
-'term-char-mode-point-at-process-mark' control these behaviors, and
+New user options `term-char-mode-buffer-read-only' and
+`term-char-mode-point-at-process-mark' control these behaviors, and
 are non-nil by default.  Customize these options to nil if you want
 the previous behavior.
 
@@ -1746,10 +1746,6 @@ instead of 0.8, to avoid rounding glitches.
 when a symbol's value is changed.  This is used to implement the new
 debugger command 'debug-on-variable-change'.
 
-+++
-** New variable 'print-escape-control-characters' causes 'prin1' and
-'print' to output control characters as backslash sequences.
-
 +++
 ** Time conversion functions that accept a time zone rule argument now
 allow it to be OFFSET or a list (OFFSET ABBR), where the integer
diff --git a/etc/ORG-NEWS b/etc/ORG-NEWS
index b9f3b0cdbe..12eab44f0f 100644
--- a/etc/ORG-NEWS
+++ b/etc/ORG-NEWS
@@ -1358,7 +1358,7 @@ don't have to be distinct on a heading.
 
 Grouptags had to previously be defined with { }.  This syntax is
 already used for exclusive tags and Grouptags need their own,
-non-exclusive syntax.  This behavior is achieved with [ ].  Note: { }
+non-exclusive syntax.  This behaviour is achieved with [ ].  Note: { }
 can still be used also for Grouptags but then only one of the given
 tags can be used on the headline at the same time.  Example:
 
@@ -1422,9 +1422,9 @@ Check the documentation for more details.
 
 Thanks to Jarmo Hurri for this feature.
 
-*** New behavior for ~org-toggle-latex-fragment~
+*** New behaviour for ~org-toggle-latex-fragment~
 
-The new behavior is the following:
+The new behaviour is the following:
 
 - With a double prefix argument or with a single prefix argument when
   point is before the first headline, toggle overlays in the whole
@@ -1623,10 +1623,10 @@ leading spaces within table cells.
 Org uses the MathJax CDN by default.  See the manual and the docstring
 of ~org-html-mathjax-options~ for details.
 
-*** New behavior in `org-export-options-alist'
+*** New behaviour in `org-export-options-alist'
 
 When defining a back-end, it is now possible to specify to give
-`parse' behavior on a keyword.  It is equivalent to call
+`parse' behaviour on a keyword.  It is equivalent to call
 `org-element-parse-secondary-string' on the value.
 
 However, parsed =KEYWORD= is automatically associated to an
@@ -1745,7 +1745,7 @@ everywhere in the buffer, possibly corrupting URLs.
 *** Removed option =org-babel-sh-command=
 
 This undocumented option defaulted to the value of =shell-file-name= at
-the time of loading =ob-shell=.  The new behavior is to use the value
+the time of loading =ob-shell=.  The new behaviour is to use the value
 of =shell-file-name= directly when the shell langage is =shell=.  To chose
 a different shell, either customize =shell-file-name= or bind this
 variable locally.
diff --git a/etc/TODO b/etc/TODO
index de579746ac..a6ab8787f7 100644
--- a/etc/TODO
+++ b/etc/TODO
@@ -216,6 +216,7 @@ Change them to use report-emacs-bug.
 **** lm-report-bug
 **** tramp-bug
 **** c-submit-bug-report
+**** ffap-bug and ffap-submit-bug (obsoleted)
 [Do all of them need changing?]
 
 ** Allow fringe indicators to display a tooltip (provide a help-echo property?)
diff --git a/lib-src/make-docfile.c b/lib-src/make-docfile.c
index a3c2801cad..f115748f30 100644
--- a/lib-src/make-docfile.c
+++ b/lib-src/make-docfile.c
@@ -43,7 +43,6 @@ along with GNU Emacs.  If not, see <https://www.gnu.org/licenses/>.  */
 #include <string.h>
 
 #include <binary-io.h>
-#include <c-ctype.h>
 #include <intprops.h>
 #include <min-max.h>
 #include <unlocked-io.h>
@@ -348,7 +347,7 @@ scan_keyword_or_put_char (char ch, struct rcsoc_state *state)
 	  state->pending_newlines = 2;
 	  state->pending_spaces = 0;
 
-	  /* Skip any spaces and newlines between the keyword and the
+	  /* Skip any whitespace between the keyword and the
 	     usage string.  */
 	  int c;
 	  do
@@ -368,7 +367,6 @@ scan_keyword_or_put_char (char ch, struct rcsoc_state *state)
 		fatal ("Unexpected EOF after keyword");
 	    }
 	  while (c != ' ' && c != ')');
-
 	  put_char ('f', state);
 	  put_char ('n', state);
 
@@ -423,7 +421,7 @@ read_c_string_or_comment (FILE *infile, int printflag, bool comment,
 
   c = getc (infile);
   if (comment)
-    while (c_isspace (c))
+    while (c == '\n' || c == '\r' || c == '\t' || c == ' ')
       c = getc (infile);
 
   while (c != EOF)
@@ -433,14 +431,15 @@ read_c_string_or_comment (FILE *infile, int printflag, bool comment,
 	  if (c == '\\')
 	    {
 	      c = getc (infile);
-	      switch (c)
+	      if (c == '\n' || c == '\r')
 		{
-		case '\n': case '\r':
 		  c = getc (infile);
 		  continue;
-		case 'n': c = '\n'; break;
-		case 't': c = '\t'; break;
 		}
+	      if (c == 'n')
+		c = '\n';
+	      if (c == 't')
+		c = '\t';
 	    }
 
 	  if (c == ' ')
@@ -511,7 +510,10 @@ write_c_args (char *func, char *buf, int minargs, int maxargs)
       char c = *p;
 
       /* Notice when a new identifier starts.  */
-      if ((c_isalnum (c) || c == '_')
+      if ((('A' <= c && c <= 'Z')
+	   || ('a' <= c && c <= 'z')
+	   || ('0' <= c && c <= '9')
+	   || c == '_')
 	  != in_ident)
 	{
 	  if (!in_ident)
@@ -554,8 +556,11 @@ write_c_args (char *func, char *buf, int minargs, int maxargs)
 	  else
 	    while (ident_length-- > 0)
 	      {
-		c = c_toupper (*ident_start++);
-		if (c == '_')
+		c = *ident_start++;
+		if (c >= 'a' && c <= 'z')
+		  /* Upcase the letter.  */
+		  c += 'A' - 'a';
+		else if (c == '_')
 		  /* Print underscore as hyphen.  */
 		  c = '-';
 		putchar (c);
@@ -960,7 +965,7 @@ scan_c_stream (FILE *infile)
 	    {
 	      c = getc (infile);
 	    }
-	  while (c == ',' || c_isspace (c));
+	  while (c == ',' || c == ' ' || c == '\t' || c == '\n' || c == '\r');
 
 	  /* Read in the identifier.  */
 	  do
@@ -972,8 +977,8 @@ scan_c_stream (FILE *infile)
 		fatal ("identifier too long");
 	      c = getc (infile);
 	    }
-	  while (! (c == ',' || c_isspace (c)));
-
+	  while (! (c == ',' || c == ' ' || c == '\t'
+		    || c == '\n' || c == '\r'));
 	  input_buffer[i] = '\0';
 	  memcpy (name, input_buffer, i + 1);
 
@@ -981,8 +986,7 @@ scan_c_stream (FILE *infile)
 	    {
 	      do
 		c = getc (infile);
-	      while (c_isspace (c));
-
+	      while (c == ' ' || c == '\t' || c == '\n' || c == '\r');
 	      if (c != '"')
 		continue;
 	      c = read_c_string_or_comment (infile, -1, false, 0);
@@ -1023,8 +1027,7 @@ scan_c_stream (FILE *infile)
 		  int scanned = 0;
 		  do
 		    c = getc (infile);
-		  while (c_isspace (c));
-
+		  while (c == ' ' || c == '\n' || c == '\r' || c == '\t');
 		  if (c < 0)
 		    goto eof;
 		  ungetc (c, infile);
@@ -1074,7 +1077,7 @@ scan_c_stream (FILE *infile)
 	  int d = getc (infile);
 	  if (d == EOF)
 	    goto eof;
-	  while (true)
+	  while (1)
 	    {
 	      if (c == '*' && d == '/')
 		break;
@@ -1089,14 +1092,13 @@ scan_c_stream (FILE *infile)
 	      if (c == EOF)
 		goto eof;
 	    }
-	  while (c_isspace (c));
-
+	  while (c == ' ' || c == '\n' || c == '\r' || c == '\t');
 	  /* Check for 'attributes:' token.  */
 	  if (c == 'a' && stream_match (infile, "ttributes:"))
 	    {
 	      char *p = input_buffer;
 	      /* Collect attributes up to ')'.  */
-	      while (true)
+	      while (1)
 		{
 		  c = getc (infile);
 		  if (c == EOF)
@@ -1118,7 +1120,7 @@ scan_c_stream (FILE *infile)
 	  continue;
 	}
 
-      while (c_isspace (c))
+      while (c == ' ' || c == '\n' || c == '\r' || c == '\t')
 	c = getc (infile);
 
       if (c == '"')
@@ -1128,18 +1130,17 @@ scan_c_stream (FILE *infile)
 	c = getc (infile);
       if (c == ',')
 	{
-	  do
+	  c = getc (infile);
+	  while (c == ' ' || c == '\n' || c == '\r' || c == '\t')
 	    c = getc (infile);
-	  while (c_isspace (c));
-
-	  while (c_isalpha (c))
+	  while ((c >= 'a' && c <= 'z') || (c >= 'Z' && c <= 'Z'))
 	    c = getc (infile);
 	  if (c == ':')
 	    {
 	      doc_keyword = true;
-	      do
+	      c = getc (infile);
+	      while (c == ' ' || c == '\n' || c == '\r' || c == '\t')
 		c = getc (infile);
-	      while (c_isspace (c));
 	    }
 	}
 
@@ -1190,14 +1191,8 @@ scan_c_stream (FILE *infile)
 	      /* Copy arguments into ARGBUF.  */
 	      *p++ = c;
 	      do
-		{
-		  c = getc (infile);
-		  if (c < 0)
-		    goto eof;
-		  *p++ = c;
-		}
+		*p++ = c = getc (infile);
 	      while (c != ')');
-
 	      *p = '\0';
 	      /* Output them.  */
 	      fputs ("\n\n", stdout);
@@ -1253,32 +1248,25 @@ scan_c_stream (FILE *infile)
 static void
 skip_white (FILE *infile)
 {
-  int c;
-  do
+  char c = ' ';
+  while (c == ' ' || c == '\t' || c == '\n' || c == '\r')
     c = getc (infile);
-  while (c_isspace (c));
-
   ungetc (c, infile);
 }
 
 static void
 read_lisp_symbol (FILE *infile, char *buffer)
 {
-  int c;
+  char c;
   char *fillp = buffer;
 
   skip_white (infile);
-  while (true)
+  while (1)
     {
       c = getc (infile);
       if (c == '\\')
-	{
-	  c = getc (infile);
-	  if (c < 0)
-	    return;
-	  *fillp++ = c;
-	}
-      else if (c_isspace (c) || c == '(' || c == ')' || c < 0)
+	*(++fillp) = getc (infile);
+      else if (c == ' ' || c == '\t' || c == '\n' || c == '\r' || c == '(' || c == ')')
 	{
 	  ungetc (c, infile);
 	  *fillp = 0;
@@ -1398,7 +1386,7 @@ scan_lisp_file (const char *filename, const char *mode)
 
 	      /* Read the length.  */
 	      while ((c = getc (infile),
-		      c_isdigit (c)))
+		      c >= '0' && c <= '9'))
 		{
 		  if (INT_MULTIPLY_WRAPV (length, 10, &length)
 		      || INT_ADD_WRAPV (length, c - '0', &length)
@@ -1430,7 +1418,7 @@ scan_lisp_file (const char *filename, const char *mode)
 	      while (c == '\n' || c == '\r')
 		c = getc (infile);
 	      /* Skip the following line.  */
-	      while (! (c == '\n' || c == '\r' || c < 0))
+	      while (c != '\n' && c != '\r')
 		c = getc (infile);
 	    }
 	  continue;
@@ -1468,7 +1456,7 @@ scan_lisp_file (const char *filename, const char *mode)
 	      continue;
 	    }
 	  else
-	    while (! (c == ')' || c < 0))
+	    while (c != ')')
 	      c = getc (infile);
 	  skip_white (infile);
 
@@ -1612,8 +1600,7 @@ scan_lisp_file (const char *filename, const char *mode)
 		}
 	    }
 	  skip_white (infile);
-	  c = getc (infile);
-	  if (c != '\"')
+	  if ((c = getc (infile)) != '\"')
 	    {
 	      fprintf (stderr, "## autoload of %s unparsable (%s)\n",
 		       buffer, filename);
diff --git a/lib/binary-io.h b/lib/binary-io.h
index 96880ddb5b..8a63204c25 100644
--- a/lib/binary-io.h
+++ b/lib/binary-io.h
@@ -47,8 +47,10 @@ _GL_INLINE_HEADER_BEGIN
   /* Use a function rather than a macro, to avoid gcc warnings
      "warning: statement with no effect".  */
 BINARY_IO_INLINE int
-__gl_setmode (int fd _GL_UNUSED, int mode _GL_UNUSED)
+__gl_setmode (int fd, int mode)
 {
+  (void) fd;
+  (void) mode;
   return O_BINARY;
 }
 #endif
@@ -57,7 +59,7 @@ __gl_setmode (int fd _GL_UNUSED, int mode _GL_UNUSED)
 extern int __gl_setmode_check (int);
 #else
 BINARY_IO_INLINE int
-__gl_setmode_check (int fd _GL_UNUSED) { return 0; }
+__gl_setmode_check (int fd) { return 0; }
 #endif
 
 /* Set FD's mode to MODE, which should be either O_TEXT or O_BINARY.
diff --git a/lib/fpending.c b/lib/fpending.c
index 7bc235deda..c84e3a5b4e 100644
--- a/lib/fpending.c
+++ b/lib/fpending.c
@@ -32,8 +32,7 @@ __fpending (FILE *fp)
   /* Most systems provide FILE as a struct and the necessary bitmask in
      <stdio.h>, because they need it for implementing getc() and putc() as
      fast macros.  */
-#if defined _IO_EOF_SEEN || defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1
-  /* GNU libc, BeOS, Haiku, Linux libc5 */
+#if defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
   return fp->_IO_write_ptr - fp->_IO_write_base;
 #elif defined __sferror || defined __DragonFly__ || defined __ANDROID__
   /* FreeBSD, NetBSD, OpenBSD, DragonFly, Mac OS X, Cygwin, Minix 3, Android */
diff --git a/lib/stdio-impl.h b/lib/stdio-impl.h
index 05c5752a24..78d896e9f5 100644
--- a/lib/stdio-impl.h
+++ b/lib/stdio-impl.h
@@ -18,12 +18,6 @@
    the same implementation of stdio extension API, except that some fields
    have different naming conventions, or their access requires some casts.  */
 
-/* Glibc 2.28 made _IO_IN_BACKUP private.  For now, work around this
-   problem by defining it ourselves.  FIXME: Do not rely on glibc
-   internals.  */
-#if !defined _IO_IN_BACKUP && defined _IO_EOF_SEEN
-# define _IO_IN_BACKUP 0x100
-#endif
 
 /* BSD stdio derived implementations.  */
 
diff --git a/lisp/allout.el b/lisp/allout.el
index af71ea75ce..a0456d5bd2 100644
--- a/lisp/allout.el
+++ b/lisp/allout.el
@@ -1522,7 +1522,7 @@ the Emacs buffer state, if file variable adjustments are enabled.  See
 `allout-enable-file-variable-adjustment' for details about that.")
 (make-variable-buffer-local 'allout-passphrase-verifier-string)
 (make-obsolete-variable 'allout-passphrase-verifier-string
-			"it is no longer used." "23.3")
+			'allout-passphrase-verifier-string "23.3")
 ;;;###autoload
 (put 'allout-passphrase-verifier-string 'safe-local-variable 'stringp)
 ;;;_   = allout-passphrase-hint-string
@@ -1538,7 +1538,7 @@ state, if file variable adjustments are enabled.  See
 (make-variable-buffer-local 'allout-passphrase-hint-string)
 (setq-default allout-passphrase-hint-string "")
 (make-obsolete-variable 'allout-passphrase-hint-string
-			"it is no longer used." "23.3")
+			'allout-passphrase-hint-string "23.3")
 ;;;###autoload
 (put 'allout-passphrase-hint-string 'safe-local-variable 'stringp)
 ;;;_   = allout-after-save-decrypt
diff --git a/lisp/arc-mode.el b/lisp/arc-mode.el
index 4ddb29dcbb..ce3ec09e28 100644
--- a/lisp/arc-mode.el
+++ b/lisp/arc-mode.el
@@ -1010,6 +1010,8 @@ using `make-temp-file', and the generated name is returned."
       (kill-local-variable 'buffer-file-coding-system)
       (after-insert-file-set-coding (- (point-max) (point-min))))))
 
+(define-obsolete-function-alias 'archive-mouse-extract 'archive-extract "22.1")
+
 (defun archive-extract (&optional other-window-p event)
   "In archive mode, extract this entry of the archive into its own buffer."
   (interactive (list nil last-input-event))
diff --git a/lisp/auth-source.el b/lisp/auth-source.el
index 66e1897b87..8ef5f7140a 100644
--- a/lisp/auth-source.el
+++ b/lisp/auth-source.el
@@ -1315,7 +1315,9 @@ See `auth-source-search' for details on SPEC."
                                                    (string-match (car item) file))
                                            (setq ret (cdr item))
                                            (setq check nil)))
-                                       ret))
+                                       ;; FIXME: `ret' unused.
+                                       ;; Should we return it here?
+                                       ))
                                     (t 'never)))
                                   (plain (or (eval default) (read-passwd prompt))))
                              ;; ask if we don't know what to do (in which case
diff --git a/lisp/autoinsert.el b/lisp/autoinsert.el
index 7858041440..53586c5418 100644
--- a/lisp/autoinsert.el
+++ b/lisp/autoinsert.el
@@ -386,7 +386,7 @@ Matches the visited file name against the elements of `auto-insert-alist'."
 	      (not (eq this-command 'auto-insert))
 	      (set-buffer-modified-p (eq auto-insert t)))))
   ;; Return nil so that it could be used in
-  ;; `find-file-not-found-functions', though that's probably inadvisable.
+  ;; `find-file-not-found-hooks', though that's probably inadvisable.
   nil)
 
 
diff --git a/lisp/bookmark.el b/lisp/bookmark.el
index a454ccb3ae..70b63a22b8 100644
--- a/lisp/bookmark.el
+++ b/lisp/bookmark.el
@@ -2251,6 +2251,8 @@ strings returned are not."
   "Hook run at the end of loading library `bookmark.el'.")
 
 ;; Exit Hook, called from kill-emacs-hook
+(define-obsolete-variable-alias 'bookmark-exit-hooks
+  'bookmark-exit-hook "22.1")
 (defvar bookmark-exit-hook nil
   "Hook run when Emacs exits.")
 
diff --git a/lisp/calendar/icalendar.el b/lisp/calendar/icalendar.el
index c1a3e0a421..ca3adfaeeb 100644
--- a/lisp/calendar/icalendar.el
+++ b/lisp/calendar/icalendar.el
@@ -43,13 +43,13 @@
 
 ;;  0.06:  (2004-10-06)
 ;;  - Bugfixes regarding icalendar-import-format-*.
-;;  - Fix in icalendar-export-file -- thanks to Philipp Grau.
+;;  - Fix in icalendar-convert-diary-to-ical -- thanks to Philipp Grau.
 
 ;;  0.05: (2003-06-19)
 ;;  - New import format scheme: Replaced icalendar-import-prefix-*,
 ;;    icalendar-import-ignored-properties, and
 ;;    icalendar-import-separator with icalendar-import-format(-*).
-;;  - icalendar-import-file and icalendar-export-file
+;;  - icalendar-import-file and icalendar-convert-diary-to-ical
 ;;    have an extra parameter which should prevent them from
 ;;    erasing their target files (untested!).
 ;;  - Tested with Emacs 21.3.2
@@ -996,6 +996,9 @@ Finto iCalendar file: ")
     (set-buffer (find-file diary-filename))
     (icalendar-export-region (point-min) (point-max) ical-filename)))
 
+(define-obsolete-function-alias 'icalendar-convert-diary-to-ical
+  'icalendar-export-file "22.1")
+
 (defvar icalendar--uid-count 0
   "Auxiliary counter for creating unique ids.")
 
@@ -2024,6 +2027,9 @@ buffer `*icalendar-errors*'."
       ;; return nil, i.e. import did not work
       nil)))
 
+(define-obsolete-function-alias 'icalendar-extract-ical-from-buffer
+  'icalendar-import-buffer "22.1")
+
 (defun icalendar--format-ical-event (event)
   "Create a string representation of an iCalendar EVENT."
   (if (functionp icalendar-import-format)
diff --git a/lisp/cedet/ede.el b/lisp/cedet/ede.el
index 5bbc2d0f85..76acf8a941 100644
--- a/lisp/cedet/ede.el
+++ b/lisp/cedet/ede.el
@@ -1095,7 +1095,6 @@ Flush the dead projects from the project cache."
     ))
 
 (defvar ede--disable-inode)             ;Defined in ede/files.el.
-(declare-function ede--project-inode "ede/files" (proj))
 
 (defun ede-global-list-sanity-check ()
   "Perform a sanity check to make sure there are no duplicate projects."
diff --git a/lisp/cedet/semantic/bovine/grammar.el b/lisp/cedet/semantic/bovine/grammar.el
index 1746f3e6ff..0eab01b58b 100644
--- a/lisp/cedet/semantic/bovine/grammar.el
+++ b/lisp/cedet/semantic/bovine/grammar.el
@@ -475,7 +475,6 @@ Menu items are appended to the common grammar menu.")
 	 ;; This is with-demoted-errors.
 	 (condition-case err
 	     (with-current-buffer (find-file-noselect infile)
-	       (setq infile buffer-file-name)
 	       (if outdir (setq default-directory outdir))
 	       (semantic-grammar-create-package nil t))
 	   (error (message "%s" (error-message-string err)) nil)))
@@ -510,12 +509,8 @@ Menu items are appended to the common grammar menu.")
 
 ;;; Commentary:
 ;;
-;; This file was generated from "
-		(if (string-match "\\(admin/grammars/.*\\.by\\)\\'" infile)
-		    (match-string 1 infile)
-		  (concat "admin/grammars/"
-			  (if (string-equal lang "scm") "scheme" lang) ".by"))
-".
+;; This file was generated from admin/grammars/"
+		lang ".by.
 
 ;;; Code:
 ")
diff --git a/lisp/cedet/semantic/sb.el b/lisp/cedet/semantic/sb.el
index 443c3839bb..739f674214 100644
--- a/lisp/cedet/semantic/sb.el
+++ b/lisp/cedet/semantic/sb.el
@@ -298,7 +298,11 @@ TEXT TOKEN and INDENT are the details."
   "Jump to the location specified in token.
 TEXT TOKEN and INDENT are the details."
   (let ((file
-	 (or (speedbar-line-directory indent)
+	 (or
+	  (cond ((fboundp 'speedbar-line-path)
+		 (speedbar-line-directory indent))
+		((fboundp 'speedbar-line-directory)
+		 (speedbar-line-directory indent)))
 	  ;; If speedbar cannot figure this out, extract the filename from
 	  ;; the token.  True for Analysis mode.
 	  (semantic-tag-file-name token)))
diff --git a/lisp/cedet/semantic/texi.el b/lisp/cedet/semantic/texi.el
index 7fe1932479..9769ae8928 100644
--- a/lisp/cedet/semantic/texi.el
+++ b/lisp/cedet/semantic/texi.el
@@ -365,8 +365,6 @@ Optional argument POINT is where to look for the environment."
 (eval-when-compile
   (require 'semantic/analyze))
 
-(declare-function semantic-analyze-context "semantic/analyze")
-
 (define-mode-local-override semantic-analyze-current-context
   texinfo-mode (point)
   "Analysis context makes no sense for texinfo.  Return nil."
diff --git a/lisp/comint.el b/lisp/comint.el
index 3182cba866..3163afeff4 100644
--- a/lisp/comint.el
+++ b/lisp/comint.el
@@ -429,6 +429,9 @@ See `comint-send-input'."
   :type 'boolean
   :group 'comint)
 
+(define-obsolete-variable-alias 'comint-use-prompt-regexp-instead-of-fields
+  'comint-use-prompt-regexp "22.1")
+
 ;; Note: If it is decided to purge comint-prompt-regexp from the source
 ;; entirely, searching for uses of this variable will help to identify
 ;; places that need attention.
@@ -451,8 +454,8 @@ This is run before the process is cranked up."
   "Hook run each time a process is exec'd by `comint-exec'.
 This is called after the process is cranked up.  It is useful for things that
 must be done each time a process is executed in a Comint mode buffer (e.g.,
-`set-process-query-on-exit-flag').  In contrast, `comint-mode-hook' is only
-executed once, when the buffer is created."
+`(process-kill-without-query)').  In contrast, the `comint-mode-hook' is only
+executed once when the buffer is created."
   :type 'hook
   :group 'comint)
 
diff --git a/lisp/cus-edit.el b/lisp/cus-edit.el
index a12897e799..816c7f7881 100644
--- a/lisp/cus-edit.el
+++ b/lisp/cus-edit.el
@@ -3790,6 +3790,10 @@ Optional EVENT is the location for the menu."
   (custom-save-all)
   (custom-face-state-set-and-redraw widget))
 
+;; For backward compatibility.
+(define-obsolete-function-alias 'custom-face-save-command 'custom-face-save
+  "22.1")
+
 (defun custom-face-reset-saved (widget)
   "Restore WIDGET to the face's default attributes.
 If there is a saved face, restore it; otherwise reset to the
diff --git a/lisp/descr-text.el b/lisp/descr-text.el
index d8f8188eb1..ddd7d801d2 100644
--- a/lisp/descr-text.el
+++ b/lisp/descr-text.el
@@ -835,6 +835,8 @@ relevant to POS."
           (if text-props-desc (insert text-props-desc))
           (setq buffer-read-only t))))))
 
+(define-obsolete-function-alias 'describe-char-after 'describe-char "22.1")
+
 ;;; Describe-Char-ElDoc
 
 (defun describe-char-eldoc--truncate (name width)
diff --git a/lisp/desktop.el b/lisp/desktop.el
index 55ec71c1b9..8bd44658d8 100644
--- a/lisp/desktop.el
+++ b/lisp/desktop.el
@@ -158,6 +158,8 @@ Used at desktop read to provide backward compatibility.")
   "Save status of Emacs when you exit."
   :group 'frames)
 
+;; Maintained for backward compatibility
+(define-obsolete-variable-alias 'desktop-enable 'desktop-save-mode "22.1")
 ;;;###autoload
 (define-minor-mode desktop-save-mode
   "Toggle desktop saving (Desktop Save mode).
@@ -246,6 +248,9 @@ the normal hook `desktop-not-loaded-hook' is run."
   :group 'desktop
   :version "22.2")
 
+(define-obsolete-variable-alias 'desktop-basefilename
+                                'desktop-base-file-name "22.1")
+
 (defcustom desktop-base-file-name
   (convert-standard-filename ".emacs.desktop")
   "Name of file for Emacs desktop, excluding the directory part."
@@ -387,7 +392,7 @@ or `desktop-modes-not-to-save'."
 
 ;; Skip tramp and ange-ftp files
 (defcustom desktop-files-not-to-save
-  "\\(\\`/[^/:]*:\\|(ftp)\\'\\)"
+  "\\(^/[^/:]*:\\|(ftp)$\\)"
   "Regexp identifying files whose buffers are to be excluded from saving.
 The default value excludes buffers visiting remote files."
   :type '(choice (const :tag "None" nil)
@@ -489,6 +494,10 @@ When file names are returned, they should be formatted using the call
 Later, when `desktop-read' evaluates the desktop file, auxiliary information
 is passed as the argument DESKTOP-BUFFER-MISC to functions in
 `desktop-buffer-mode-handlers'.")
+(make-obsolete-variable 'desktop-buffer-modes-to-save
+                        'desktop-save-buffer "22.1")
+(make-obsolete-variable 'desktop-buffer-misc-functions
+                        'desktop-save-buffer "22.1")
 
 ;;;###autoload
 (defvar desktop-buffer-mode-handlers nil
@@ -532,9 +541,12 @@ can guess how to load the mode's definition.")
 
 ;;;###autoload
 (put 'desktop-buffer-mode-handlers 'risky-local-variable t)
+(make-obsolete-variable 'desktop-buffer-handlers
+                        'desktop-buffer-mode-handlers "22.1")
 
 (defcustom desktop-minor-mode-table
-  '((defining-kbd-macro nil)
+  '((auto-fill-function auto-fill-mode)
+    (defining-kbd-macro nil)
     (isearch-mode nil)
     (vc-mode nil)
     (vc-dired-mode nil)
@@ -701,12 +713,12 @@ if different)."
     (if (symbolp var)
 	(set-default var nil)
       (set-default var (eval (cdr var)))))
-  (let ((preserve-regexp (concat "\\`\\("
+  (let ((preserve-regexp (concat "^\\("
                                  (mapconcat (lambda (regexp)
                                               (concat "\\(" regexp "\\)"))
                                             desktop-clear-preserve-buffers
                                             "\\|")
-                                 "\\)\\'")))
+                                 "\\)$")))
     (dolist (buffer (buffer-list))
       (let ((bufname (buffer-name buffer)))
 	(unless (or (eq (aref bufname 0) ?\s) ;; Don't kill internal buffers
@@ -734,7 +746,7 @@ if different)."
 
 ;; ----------------------------------------------------------------------------
 (unless noninteractive
-  (add-hook 'kill-emacs-hook #'desktop-kill))
+  (add-hook 'kill-emacs-hook 'desktop-kill))
 
 (defun desktop-kill ()
   "If `desktop-save-mode' is non-nil, do what `desktop-save' says to do.
@@ -803,7 +815,6 @@ buffer, which is (in order):
               (symbol-value minor-mode)
               (let* ((special (assq minor-mode desktop-minor-mode-table))
                      (value (cond (special (cadr special))
-                                  ((get minor-mode :minor-mode-function))
                                   ((functionp minor-mode) minor-mode))))
                 (when value (cl-pushnew value ret))))))
     ;; point and mark, and read-only status
@@ -889,8 +900,8 @@ QUOTE may be `may' (value may be quoted),
        (cons nil
              `(let ((mk (make-marker)))
                 (add-hook 'desktop-delay-hook
-                          (lambda ()
-                            (set-marker mk ,pos (get-buffer ,buf))))
+                          `(lambda ()
+                             (set-marker ,mk ,,pos (get-buffer ,,buf))))
                 mk))))
     (t                                  ; Save as text.
      (cons 'may "Unprintable entity"))))
@@ -1074,7 +1085,7 @@ without further confirmation."
 
 	(with-temp-buffer
 	  (insert
-	   ";; -*- mode: emacs-lisp; lexical-binding:t; coding: utf-8-emacs; -*-\n"
+	   ";; -*- mode: emacs-lisp; coding: emacs-mule; -*-\n"
 	   desktop-header
 	   ";; Created " (current-time-string) "\n"
 	   ";; Desktop file format version " (format "%d" desktop-io-file-version) "\n"
@@ -1087,7 +1098,7 @@ without further confirmation."
 	  (desktop-save-frameset)
 	  (unless (memq 'desktop-saved-frameset desktop-globals-to-save)
 	    (desktop-outvar 'desktop-saved-frameset))
-	  (mapc #'desktop-outvar desktop-globals-to-save)
+	  (mapc (function desktop-outvar) desktop-globals-to-save)
 	  (setq desktop-saved-frameset nil) ; after saving desktop-globals-to-save
 	  (when (memq 'kill-ring desktop-globals-to-save)
 	    (insert
@@ -1096,9 +1107,9 @@ without further confirmation."
 	     " kill-ring))\n"))
 
 	  (insert "\n;; Buffer section -- buffers listed in same order as in buffer list:\n")
-	  (dolist (l (mapcar #'desktop-buffer-info (buffer-list)))
+	  (dolist (l (mapcar 'desktop-buffer-info (buffer-list)))
 	    (let ((base (pop l)))
-	      (when (apply #'desktop-save-buffer-p l)
+	      (when (apply 'desktop-save-buffer-p l)
 		(insert "("
 			(if (or (not (integerp eager))
 				(if (zerop eager)
@@ -1129,9 +1140,9 @@ without further confirmation."
 				  ;; This is saved after the timestamp
 				  (search-forward (format "%S" desktop--app-id) nil t))
 			     (point))))
-		 (checksum (and beg (md5 (current-buffer) beg (point-max) 'utf-8-emacs))))
+		 (checksum (and beg (md5 (current-buffer) beg (point-max) 'emacs-mule))))
 	    (unless (and checksum (equal checksum desktop-file-checksum))
-	      (let ((coding-system-for-write 'utf-8-emacs))
+	      (let ((coding-system-for-write 'emacs-mule))
 		(write-region (point-min) (point-max) (desktop-full-file-name) nil 'nomessage))
 	      (setq desktop-file-checksum checksum)
 	      ;; We remember when it was modified (which is presumably just now).
@@ -1230,12 +1241,12 @@ Using it may cause conflicts.  Use it anyway? " owner)))))
 	    ;; disabled when loading the desktop fails with errors,
 	    ;; thus not overwriting the desktop with broken contents.
 	    (setq desktop-autosave-was-enabled
-		  (memq #'desktop-auto-save-set-timer
-                        ;; Use the global value of the hook, in case some
+		  (memq 'desktop-auto-save-set-timer
+                        ;; Use the toplevel value of the hook, in case some
                         ;; feature makes window-configuration-change-hook
                         ;; buffer-local, and puts there stuff which
                         ;; doesn't include our timer.
-                        (default-value
+                        (default-toplevel-value
                           'window-configuration-change-hook)))
 	    (desktop-auto-save-disable)
 	    ;; Evaluate desktop buffer and remember when it was modified.
@@ -1254,7 +1265,7 @@ Using it may cause conflicts.  Use it anyway? " owner)))))
 	      ;; We want buffers existing prior to evaluating the desktop (and
 	      ;; not reused) to be placed at the end of the buffer list, so we
 	      ;; move them here.
-	      (mapc #'bury-buffer
+	      (mapc 'bury-buffer
 		    (nreverse (cdr (memq desktop-first-buffer (nreverse (buffer-list))))))
 	      (switch-to-buffer (car (buffer-list))))
 	    (run-hooks 'desktop-delay-hook)
@@ -1298,6 +1309,17 @@ Using it may cause conflicts.  Use it anyway? " owner)))))
       (message "No desktop file.")
       nil)))
 
+;; ----------------------------------------------------------------------------
+;; Maintained for backward compatibility
+;;;###autoload
+(defun desktop-load-default ()
+  "Load the `default' start-up library manually.
+Also inhibit further loading of it."
+  (declare (obsolete desktop-save-mode "22.1"))
+  (unless inhibit-default-init	        ; safety check
+    (load "default" t t)
+    (setq inhibit-default-init t)))
+
 ;; ----------------------------------------------------------------------------
 ;;;###autoload
 (defun desktop-change-dir (dirname)
@@ -1328,10 +1350,10 @@ directory DIRNAME."
 (defun desktop-auto-save-enable (&optional timeout)
   (when (and (integerp (or timeout desktop-auto-save-timeout))
 	     (> (or timeout desktop-auto-save-timeout) 0))
-    (add-hook 'window-configuration-change-hook #'desktop-auto-save-set-timer)))
+    (add-hook 'window-configuration-change-hook 'desktop-auto-save-set-timer)))
 
 (defun desktop-auto-save-disable ()
-  (remove-hook 'window-configuration-change-hook #'desktop-auto-save-set-timer)
+  (remove-hook 'window-configuration-change-hook 'desktop-auto-save-set-timer)
   (desktop-auto-save-cancel-timer))
 
 (defun desktop-auto-save ()
@@ -1586,7 +1608,7 @@ ARGS must be an argument list for `desktop-create-buffer'."
       (let ((desktop-first-buffer nil)
             (desktop-buffer-ok-count 0)
             (desktop-buffer-fail-count 0))
-        (apply #'desktop-create-buffer args)
+        (apply 'desktop-create-buffer args)
         (run-hooks 'desktop-delay-hook)
         (setq desktop-delay-hook nil)
         (bury-buffer (get-buffer buffer-name))
diff --git a/lisp/dired-aux.el b/lisp/dired-aux.el
index e8b5e6755e..b837fb4e5e 100644
--- a/lisp/dired-aux.el
+++ b/lisp/dired-aux.el
@@ -1842,8 +1842,7 @@ Optional arg HOW-TO determines how to treat the target.
       rfn-list  - list of the relative names for the marked files.
       fn-list   - list of the absolute names for the marked files.
       target    - the name of the target itself.
-    The rest of elements of the list returned by HOW-TO are optional
-    arguments for the function that is the first element of the list.
+      The rest of into-dir are optional arguments.
    For any other return value, TARGET is treated as a directory."
   (or op1 (setq op1 operation))
   (let* ((fn-list (dired-get-marked-files nil arg nil nil t))
diff --git a/lisp/dired-x.el b/lisp/dired-x.el
index a1c2f4484c..fa36083e14 100644
--- a/lisp/dired-x.el
+++ b/lisp/dired-x.el
@@ -137,6 +137,8 @@ folding to be used on case-insensitive filesystems only."
       (file-name-case-insensitive-p dir)
     dired-omit-case-fold))
 
+;; For backward compatibility
+(define-obsolete-variable-alias 'dired-omit-files-p 'dired-omit-mode "22.1")
 (define-minor-mode dired-omit-mode
   "Toggle omission of uninteresting files in Dired (Dired-Omit mode).
 With a prefix argument ARG, enable Dired-Omit mode if ARG is
diff --git a/lisp/emacs-lisp/autoload.el b/lisp/emacs-lisp/autoload.el
index 5274ec880c..92ad6155b5 100644
--- a/lisp/emacs-lisp/autoload.el
+++ b/lisp/emacs-lisp/autoload.el
@@ -324,7 +324,6 @@ put the output in."
 	    (setcdr p nil)
 	    (princ "\n(" outbuf)
 	    (let ((print-escape-newlines t)
-		  (print-escape-control-characters t)
                   (print-quoted t)
 		  (print-escape-nonascii t))
 	      (dolist (elt form)
@@ -349,7 +348,6 @@ put the output in."
 		       outbuf))
 	      (terpri outbuf)))
 	(let ((print-escape-newlines t)
-	      (print-escape-control-characters t)
               (print-quoted t)
 	      (print-escape-nonascii t))
 	  (print form outbuf)))))))
@@ -1145,6 +1143,9 @@ write its autoloads into the specified file instead."
       ;; file-local autoload-generated-file settings.
       (autoload-save-buffers))))
 
+(define-obsolete-function-alias 'update-autoloads-from-directories
+    'update-directory-autoloads "22.1")
+
 ;;;###autoload
 (defun batch-update-autoloads ()
   "Update loaddefs.el autoloads in batch mode.
diff --git a/lisp/emacs-lisp/bytecomp.el b/lisp/emacs-lisp/bytecomp.el
index b3ea9300b0..1bf6d04b63 100644
--- a/lisp/emacs-lisp/bytecomp.el
+++ b/lisp/emacs-lisp/bytecomp.el
@@ -3119,13 +3119,7 @@ for symbols generated by the byte compiler itself."
              (when (assq var byte-compile-lexical-variables)
                (byte-compile-report-error
                 (format-message "%s cannot use lexical var `%s'" fn var))))))
-        ;; Warn about using obsolete hooks.
-        (if (memq fn '(add-hook remove-hook))
-            (let ((hook (car-safe (cdr form))))
-              (if (eq (car-safe hook) 'quote)
-                  (byte-compile-check-variable (cadr hook) nil))))
-        (when (and (byte-compile-warning-enabled-p 'suspicious)
-                   (macroexp--const-symbol-p fn))
+        (when (macroexp--const-symbol-p fn)
           (byte-compile-warn "`%s' called as a function" fn))
 	(when (and (byte-compile-warning-enabled-p 'interactive-only)
 		   interactive-only)
diff --git a/lisp/emacs-lisp/cl-macs.el b/lisp/emacs-lisp/cl-macs.el
index 9600230c07..4d4640cbe0 100644
--- a/lisp/emacs-lisp/cl-macs.el
+++ b/lisp/emacs-lisp/cl-macs.el
@@ -771,15 +771,13 @@ The result of the body appears to the compiler as a quoted constant."
 ;;;###autoload
 (defmacro cl-case (expr &rest clauses)
   "Eval EXPR and choose among clauses on that value.
-Each clause looks like (KEYLIST BODY...).  EXPR is evaluated and
-compared against each key in each KEYLIST; the corresponding BODY
-is evaluated.  If no clause succeeds, cl-case returns nil.  A
-single non-nil atom may be used in place of a KEYLIST of one
-atom.  A KEYLIST of t or `otherwise' is allowed only in the final
-clause, and matches if no other keys match.  Key values are
-compared by `eql'.
-
-\(fn EXPR (KEYLIST BODY...)...)"
+Each clause looks like (KEYLIST BODY...).  EXPR is evaluated and compared
+against each key in each KEYLIST; the corresponding BODY is evaluated.
+If no clause succeeds, cl-case returns nil.  A single atom may be used in
+place of a KEYLIST of one atom.  A KEYLIST of t or `otherwise' is
+allowed only in the final clause, and matches if no other keys match.
+Key values are compared by `eql'.
+\n(fn EXPR (KEYLIST BODY...)...)"
   (declare (indent 1) (debug (form &rest (sexp body))))
   (macroexp-let2 macroexp-copyable-p temp expr
     (let* ((head-list nil))
diff --git a/lisp/emacs-lisp/derived.el b/lisp/emacs-lisp/derived.el
index 6b47ffea07..547f5cd805 100644
--- a/lisp/emacs-lisp/derived.el
+++ b/lisp/emacs-lisp/derived.el
@@ -286,6 +286,19 @@ No problems result if this variable is not bound.
 	 ;; Run the hooks (and delayed-after-hook-functions), if any.
 	 (run-mode-hooks ',hook)))))
 
+;; PUBLIC: find the ultimate class of a derived mode.
+
+(defun derived-mode-class (mode)
+  "Find the class of a major MODE.
+A mode's class is the first ancestor which is NOT a derived mode.
+Use the `derived-mode-parent' property of the symbol to trace backwards.
+Since major-modes might all derive from `fundamental-mode', this function
+is not very useful."
+  (declare (obsolete derived-mode-p "22.1"))
+  (while (get mode 'derived-mode-parent)
+    (setq mode (get mode 'derived-mode-parent)))
+  mode)
+
 
 ;;; PRIVATE
 
diff --git a/lisp/emacs-lisp/eieio.el b/lisp/emacs-lisp/eieio.el
index 1e1419f6eb..de08e37286 100644
--- a/lisp/emacs-lisp/eieio.el
+++ b/lisp/emacs-lisp/eieio.el
@@ -403,7 +403,7 @@ If EXTRA, include that in the string returned to represent the symbol."
 
 (cl-defgeneric eieio-object-set-name-string (obj name)
   "Set the string which is OBJ's NAME."
-  (declare (obsolete "inherit from `eieio-named' and use (setf (slot-value OBJ \\='object-name) NAME) instead" "25.1"))
+  (declare (obsolete "inherit from `eieio-named' and use (setf (slot-value OBJ 'object-name) NAME) instead" "25.1"))
   (cl-check-type name string)
   (setf (gethash obj eieio--object-names) name))
 (define-obsolete-function-alias
diff --git a/lisp/emacs-lisp/ert.el b/lisp/emacs-lisp/ert.el
index 3beb8a070f..a47108545d 100644
--- a/lisp/emacs-lisp/ert.el
+++ b/lisp/emacs-lisp/ert.el
@@ -676,7 +676,6 @@ and is displayed in front of the value of MESSAGE-FORM."
 (cl-defstruct ert-test-result
   (messages nil)
   (should-forms nil)
-  (duration 0)
   )
 (cl-defstruct (ert-test-passed (:include ert-test-result)))
 (cl-defstruct (ert-test-result-with-condition (:include ert-test-result))
@@ -1231,11 +1230,6 @@ SELECTOR is the selector that was used to select TESTS."
         (ert-run-test test)
       (setf (aref (ert--stats-test-end-times stats) pos) (current-time))
       (let ((result (ert-test-most-recent-result test)))
-        (setf (ert-test-result-duration result)
-              (float-time
-               (time-subtract
-                (aref (ert--stats-test-end-times stats) pos)
-                (aref (ert--stats-test-start-times stats) pos))))
         (ert--stats-set-test-and-result stats pos test result)
         (funcall listener 'test-ended stats test result))
       (setf (ert--stats-current-test stats) nil))))
@@ -1342,9 +1336,6 @@ RESULT must be an `ert-test-result-with-condition'."
 (defvar ert-quiet nil
   "Non-nil makes ERT only print important information in batch mode.")
 
-(defvar ert-batch-print-duration nil
-  "Non-nil makes ERT print duration time of single tests in batch mode.")
-
 ;;;###autoload
 (defun ert-run-tests-batch (&optional selector)
   "Run the tests specified by SELECTOR, printing results to the terminal.
@@ -1455,17 +1446,13 @@ Returns the stats object."
             (let* ((max (prin1-to-string (length (ert--stats-tests stats))))
                    (format-string (concat "%9s  %"
                                           (prin1-to-string (length max))
-                                          "s/" max "  %S"
-                                          (if ert-batch-print-duration
-                                              " (%f sec)"))))
+                                          "s/" max "  %S")))
               (message format-string
                        (ert-string-for-test-result result
                                                    (ert-test-result-expected-p
                                                     test result))
                        (1+ (ert--stats-test-pos stats test))
-                       (ert-test-name test)
-                       (if ert-batch-print-duration
-                           (ert-test-result-duration result)))))))))
+                       (ert-test-name test))))))))
    nil))
 
 ;;;###autoload
@@ -1548,14 +1535,7 @@ Ran \\([0-9]+\\) tests, \\([0-9]+\\) results as expected\
       (mapc (lambda (l) (message "  %s" l)) notests))
     (when badtests
       (message "%d files did not finish:" (length badtests))
-      (mapc (lambda (l) (message "  %s" l)) badtests)
-      (if (getenv "EMACS_HYDRA_CI")
-          (with-temp-buffer
-            (dolist (f badtests)
-              (erase-buffer)
-              (insert-file-contents f)
-              (message "Contents of unfinished file %s:" f)
-              (message "-----\n%s\n-----" (buffer-string))))))
+      (mapc (lambda (l) (message "  %s" l)) badtests))
     (when unexpected
       (message "%d files contained unexpected results:" (length unexpected))
       (mapc (lambda (l) (message "  %s" l)) unexpected))
diff --git a/lisp/emacs-lisp/ewoc.el b/lisp/emacs-lisp/ewoc.el
index 52d8451f4b..262d4d8594 100644
--- a/lisp/emacs-lisp/ewoc.el
+++ b/lisp/emacs-lisp/ewoc.el
@@ -500,7 +500,7 @@ Return the node (or nil if we just passed the last node)."
 
 (defun ewoc-goto-node (ewoc node)
   "Move point to NODE in EWOC."
-  (with-current-buffer (ewoc--buffer ewoc)
+  (ewoc--set-buffer-bind-dll ewoc
     (goto-char (ewoc--node-start-marker node))
     (if goal-column (move-to-column goal-column))
     (setf (ewoc--last-node ewoc) node)))
diff --git a/lisp/emacs-lisp/generic.el b/lisp/emacs-lisp/generic.el
index 194fa1e1c2..e2009bf4c2 100644
--- a/lisp/emacs-lisp/generic.el
+++ b/lisp/emacs-lisp/generic.el
@@ -96,6 +96,8 @@
 ;; Internal Variables
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
+(define-obsolete-variable-alias 'generic-font-lock-defaults
+  'generic-font-lock-keywords "22.1")
 (defvar generic-font-lock-keywords nil
   "Keywords for `font-lock-defaults' in a generic mode.")
 (make-variable-buffer-local 'generic-font-lock-keywords)
diff --git a/lisp/emacs-lisp/syntax.el b/lisp/emacs-lisp/syntax.el
index ad1a9665ff..6106720f7a 100644
--- a/lisp/emacs-lisp/syntax.el
+++ b/lisp/emacs-lisp/syntax.el
@@ -363,6 +363,12 @@ An \"outermost position\" means one that it is outside of any syntactic entity:
 outside of any parentheses, comments, or strings encountered in the scan.
 If no such position is recorded in PPSS (because the end of the scan was
 itself at the outermost level), return nil."
+  ;; BEWARE! We rely on the undocumented 9th field.  The 9th field currently
+  ;; contains the list of positions of the enclosing open-parens.
+  ;; I.e. those positions are outside of any string/comment and the first of
+  ;; those is outside of any paren (i.e. corresponds to a nil ppss).
+  ;; If this list is empty but we are in a string or comment, then the 8th
+  ;; field contains a similar "toplevel" position.
   (or (car (nth 9 ppss))
       (nth 8 ppss)))
 
diff --git a/lisp/emacs-lisp/timer.el b/lisp/emacs-lisp/timer.el
index 795554fec5..b1e12b1fd5 100644
--- a/lisp/emacs-lisp/timer.el
+++ b/lisp/emacs-lisp/timer.el
@@ -141,6 +141,20 @@ omitted, they are treated as zero."
   (setf (timer--time timer)
         (timer-relative-time (timer--time timer) secs usecs psecs)))
 
+(defun timer-set-time-with-usecs (timer time usecs &optional delta)
+  "Set the trigger time of TIMER to TIME plus USECS.
+TIME must be in the internal format returned by, e.g., `current-time'.
+The microsecond count from TIME is ignored, and USECS is used instead.
+If optional fourth argument DELTA is a positive number, make the timer
+fire repeatedly that many seconds apart."
+  (declare (obsolete "use `timer-set-time' and `timer-inc-time' instead."
+		     "22.1"))
+  (setf (timer--time timer) time)
+  (setf (timer--usecs timer) usecs)
+  (setf (timer--psecs timer) 0)
+  (setf (timer--repeat-delay timer) (and (numberp delta) (> delta 0) delta))
+  timer)
+
 (defun timer-set-function (timer function &optional args)
   "Make TIMER call FUNCTION with optional ARGS when triggering."
   (timer--check timer)
diff --git a/lisp/emacs-lisp/unsafep.el b/lisp/emacs-lisp/unsafep.el
index 03f22ebf1a..f6b569bc7f 100644
--- a/lisp/emacs-lisp/unsafep.el
+++ b/lisp/emacs-lisp/unsafep.el
@@ -93,7 +93,7 @@ in the parse.")
 (put 'unsafep-vars 'risky-local-variable t)
 
 ;;Side-effect-free functions from subr.el
-(dolist (x '(assoc-default butlast last match-string
+(dolist (x '(assoc-default assoc-ignore-case butlast last match-string
 	     match-string-no-properties member-ignore-case remove remq))
   (put x 'side-effect-free t))
 
diff --git a/lisp/emulation/cua-base.el b/lisp/emulation/cua-base.el
index ff23484dd0..a737bb6c11 100644
--- a/lisp/emulation/cua-base.el
+++ b/lisp/emulation/cua-base.el
@@ -852,6 +852,8 @@ With numeric prefix arg, copy to register 0-9 instead."
   (if (fboundp 'cua--cancel-rectangle)
       (cua--cancel-rectangle)))
 
+(declare-function x-clipboard-yank "../term/x-win" ())
+
 (put 'cua-paste 'delete-selection 'yank)
 (defun cua-paste (arg)
   "Paste last cut or copied region or rectangle.
@@ -882,8 +884,10 @@ If global mark is active, copy from register or one character."
 	 ((consp regtxt) (cua--insert-rectangle regtxt))
 	 ((stringp regtxt) (insert-for-yank regtxt))
 	 (t (message "Unknown data in register %c" cua--register))))
-       ((memq this-original-command '(clipboard-yank x-clipboard-yank))
-        (funcall this-original-command))
+       ((eq this-original-command 'clipboard-yank)
+	(clipboard-yank))
+       ((eq this-original-command 'x-clipboard-yank)
+	(x-clipboard-yank))
        (t (yank arg)))))))
 
 
diff --git a/lisp/emulation/viper-ex.el b/lisp/emulation/viper-ex.el
index d95a828614..347e66f8ff 100644
--- a/lisp/emulation/viper-ex.el
+++ b/lisp/emulation/viper-ex.el
@@ -548,13 +548,9 @@ reversed."
       (setq viper-ex-work-buf (get-buffer-create viper-ex-work-buf-name))
       (set-buffer viper-ex-work-buf)
       (goto-char (point-max)))
-    (cond ((looking-back quit-regex1 (line-beginning-position))
-	   (exit-minibuffer))
-	  ;; Almost certainly point-min should be line-beginning-position,
-	  ;; but probably the two are identical anyway, and who really cares?
-	  ((looking-back stay-regex (point-min)) (insert " "))
-	  ((looking-back quit-regex2 (line-beginning-position))
-	   (exit-minibuffer))
+    (cond ((looking-back quit-regex1) (exit-minibuffer))
+	  ((looking-back stay-regex)  (insert " "))
+	  ((looking-back quit-regex2) (exit-minibuffer))
 	  (t (insert " ")))))
 
 (declare-function viper-tmp-insert-at-eob "viper-cmd" (msg))
diff --git a/lisp/emulation/viper.el b/lisp/emulation/viper.el
index c8eca30e88..7292fd58c1 100644
--- a/lisp/emulation/viper.el
+++ b/lisp/emulation/viper.el
@@ -300,8 +300,6 @@
 
 ;;; Code:
 
-(require 'cl-lib)
-
 ;; compiler pacifier
 (defvar mark-even-if-inactive)
 (defvar quail-mode)
@@ -902,7 +900,7 @@ Two differences:
   (viper-setup-ESC-to-escape t)
 
   (add-hook 'change-major-mode-hook #'viper-major-mode-change-sentinel)
-  (add-hook 'find-file-hook #'set-viper-state-in-major-mode)
+  (add-hook 'find-file-hooks #'set-viper-state-in-major-mode)
 
   ;; keep this because many modes we don't know about use this hook
   (defvar text-mode-hook)
diff --git a/lisp/epa-hook.el b/lisp/epa-hook.el
index 135c956c3f..d99a3ef51a 100644
--- a/lisp/epa-hook.el
+++ b/lisp/epa-hook.el
@@ -95,7 +95,7 @@ the mode if ARG is omitted or nil."
   :initialize 'custom-initialize-delay
   (setq file-name-handler-alist
 	(delq epa-file-handler file-name-handler-alist))
-  (remove-hook 'find-file-hook 'epa-file-find-file-hook)
+  (remove-hook 'find-file-hooks 'epa-file-find-file-hook)
   (setq auto-mode-alist (delq epa-file-auto-mode-alist-entry
 			      auto-mode-alist))
   (when auto-encryption-mode
diff --git a/lisp/epa-mail.el b/lisp/epa-mail.el
index c819f6734c..077666ac89 100644
--- a/lisp/epa-mail.el
+++ b/lisp/epa-mail.el
@@ -111,7 +111,7 @@ If no one is selected, default secret key is used.  "
 
 (defun epa-mail-default-recipients ()
   "Return the default list of encryption recipients for a mail buffer."
-  (let ((config (epg-find-configuration 'OpenPGP))
+  (let ((config (epg-configuration))
 	recipients-string real-recipients)
     (save-excursion
       (goto-char (point-min))
diff --git a/lisp/erc/erc-dcc.el b/lisp/erc/erc-dcc.el
index 5bc8c2f38b..764c6cc617 100644
--- a/lisp/erc/erc-dcc.el
+++ b/lisp/erc/erc-dcc.el
@@ -54,9 +54,7 @@
 ;;; Code:
 
 (require 'erc)
-;; Strictly speaking, should only be needed at compile time.
-;; Require at run-time too to silence compiler.
-(require 'pcomplete)
+(eval-when-compile (require 'pcomplete))
 
 ;;;###autoload(autoload 'erc-dcc-mode "erc-dcc")
 (define-erc-module dcc nil
diff --git a/lisp/eshell/em-cmpl.el b/lisp/eshell/em-cmpl.el
index a9b29aef4c..1f44007746 100644
--- a/lisp/eshell/em-cmpl.el
+++ b/lisp/eshell/em-cmpl.el
@@ -167,9 +167,6 @@ to writing a completion function."
   (eshell-cmpl--custom-variable-docstring 'pcomplete-suffix-list)
   :type (get 'pcomplete-suffix-list 'custom-type)
   :group 'pcomplete)
-;; Only labelled obsolete in 26.1, but all it does it set
-;; pcomplete-suffix-list, which is itself obsolete since 24.1.
-(make-obsolete-variable 'eshell-cmpl-suffix-list nil "24.1")
 
 (defcustom eshell-cmpl-recexact nil
   (eshell-cmpl--custom-variable-docstring 'pcomplete-recexact)
@@ -262,9 +259,8 @@ to writing a completion function."
        eshell-cmpl-ignore-case)
   (set (make-local-variable 'pcomplete-autolist)
        eshell-cmpl-autolist)
-  (if (boundp 'pcomplete-suffix-list)
-      (set (make-local-variable 'pcomplete-suffix-list)
-           eshell-cmpl-suffix-list))
+  (set (make-local-variable 'pcomplete-suffix-list)
+       eshell-cmpl-suffix-list)
   (set (make-local-variable 'pcomplete-recexact)
        eshell-cmpl-recexact)
   (set (make-local-variable 'pcomplete-man-function)
@@ -438,7 +434,7 @@ to writing a completion function."
 	    (setq comps-in-path (cdr comps-in-path)))
 	  (setq paths (cdr paths)))
 	;; Add aliases which are currently visible, and Lisp functions.
-	(pcomplete-uniquify-list
+	(pcomplete-uniqify-list
 	 (if glob-name
 	     completions
 	   (setq completions
diff --git a/lisp/eshell/em-dirs.el b/lisp/eshell/em-dirs.el
index ec380e6701..37cb6b169a 100644
--- a/lisp/eshell/em-dirs.el
+++ b/lisp/eshell/em-dirs.el
@@ -207,7 +207,7 @@ Thus, this does not include the current directory.")
   (when eshell-cd-on-directory
     (make-local-variable 'eshell-interpreter-alist)
     (setq eshell-interpreter-alist
-	  (cons (cons #'(lambda (file _args)
+	  (cons (cons #'(lambda (file args)
                           (eshell-lone-directory-p file))
 		      'eshell-dirs-substitute-cd)
 		eshell-interpreter-alist)))
@@ -282,7 +282,7 @@ Thus, this does not include the current directory.")
 (defvar pcomplete-stub)
 (defvar pcomplete-last-completion-raw)
 (declare-function pcomplete-actual-arg "pcomplete")
-(declare-function pcomplete-uniquify-list "pcomplete")
+(declare-function pcomplete-uniqify-list "pcomplete")
 
 (defun eshell-complete-user-reference ()
   "If there is a user reference, complete it."
@@ -293,14 +293,14 @@ Thus, this does not include the current directory.")
       (throw 'pcomplete-completions
 	     (progn
 	       (eshell-read-user-names)
-	       (pcomplete-uniquify-list
+	       (pcomplete-uniqify-list
 		(mapcar
 		 (function
 		  (lambda (user)
 		    (file-name-as-directory (cdr user))))
 		 eshell-user-names)))))))
 
-(defun eshell/pwd (&rest _args)
+(defun eshell/pwd (&rest args)
   "Change output from `pwd' to be cleaner."
   (let* ((path default-directory)
 	 (len (length path)))
diff --git a/lisp/eshell/em-pred.el b/lisp/eshell/em-pred.el
index b3b16d909b..61af4048d5 100644
--- a/lisp/eshell/em-pred.el
+++ b/lisp/eshell/em-pred.el
@@ -131,7 +131,7 @@ The format of each entry is
     (?e . #'(lambda (lst) (mapcar 'file-name-extension lst)))
     (?t . #'(lambda (lst) (mapcar 'file-name-nondirectory lst)))
     (?q . #'(lambda (lst) (mapcar 'eshell-escape-arg lst)))
-    (?u . #'(lambda (lst) (eshell-uniquify-list lst)))
+    (?u . #'(lambda (lst) (eshell-uniqify-list lst)))
     (?o . #'(lambda (lst) (sort lst 'string-lessp)))
     (?O . #'(lambda (lst) (nreverse (sort lst 'string-lessp))))
     (?j . (eshell-join-members))
diff --git a/lisp/eshell/em-script.el b/lisp/eshell/em-script.el
index a5d8e96ba8..1b0b220d5b 100644
--- a/lisp/eshell/em-script.el
+++ b/lisp/eshell/em-script.el
@@ -61,7 +61,7 @@ This includes when running `eshell-command'."
   "Initialize the script parsing code."
   (make-local-variable 'eshell-interpreter-alist)
   (setq eshell-interpreter-alist
-	(cons (cons #'(lambda (file _args)
+	(cons (cons #'(lambda (file args)
                         (string= (file-name-nondirectory file)
                                  "eshell"))
                     'eshell/source)
diff --git a/lisp/eshell/em-tramp.el b/lisp/eshell/em-tramp.el
index 004c495490..c45453bf28 100644
--- a/lisp/eshell/em-tramp.el
+++ b/lisp/eshell/em-tramp.el
@@ -26,7 +26,6 @@
 ;;; Code:
 
 (require 'esh-util)
-(require 'esh-cmd)
 
 (eval-when-compile
   (require 'esh-mode)
diff --git a/lisp/eshell/em-unix.el b/lisp/eshell/em-unix.el
index a18fb85507..c3448de407 100644
--- a/lisp/eshell/em-unix.el
+++ b/lisp/eshell/em-unix.el
@@ -965,7 +965,7 @@ Show wall-clock time elapsed during execution of COMMAND.")
 				  (eshell-stringify-list
 				   (eshell-flatten-list (cdr time-args))))))))
 
-(defun eshell/whoami (&rest _args)
+(defun eshell/whoami (&rest args)
   "Make \"whoami\" Tramp aware."
   (or (file-remote-p default-directory 'user) (user-login-name)))
 
diff --git a/lisp/eshell/em-xtra.el b/lisp/eshell/em-xtra.el
index cc84d19854..ce73474fb7 100644
--- a/lisp/eshell/em-xtra.el
+++ b/lisp/eshell/em-xtra.el
@@ -25,10 +25,8 @@
 
 (require 'esh-util)
 (eval-when-compile
-  (require 'eshell))
-;; Strictly speaking, should only be needed at compile time.
-;; Require at run-time too to silence compiler.
-(require 'pcomplete)
+  (require 'eshell)
+  (require 'pcomplete))
 (require 'compile)
 
 ;; There are no items in this custom group, but eshell modules (ab)use
diff --git a/lisp/eshell/esh-ext.el b/lisp/eshell/esh-ext.el
index ba5182deb4..1bfab23c22 100644
--- a/lisp/eshell/esh-ext.el
+++ b/lisp/eshell/esh-ext.el
@@ -37,8 +37,8 @@
 
 (eval-when-compile
   (require 'cl-lib)
+  (require 'esh-io)
   (require 'esh-cmd))
-(require 'esh-io)
 (require 'esh-arg)
 (require 'esh-opt)
 (require 'esh-proc)
diff --git a/lisp/eshell/esh-opt.el b/lisp/eshell/esh-opt.el
index b802696306..3af8fd7cac 100644
--- a/lisp/eshell/esh-opt.el
+++ b/lisp/eshell/esh-opt.el
@@ -95,8 +95,8 @@ BODY-FORMS.  If instead an external command is run (because of
 an unknown option), the tag `eshell-external' will be thrown with
 the new process for its value.
 
-Lastly, any remaining arguments will be available in the locally
-let-bound variable `args'."
+Lastly, any remaining arguments will be available in a locally
+interned variable `args' (created using a `let' form)."
   (declare (debug (form form sexp body)))
   `(let* ((temp-args
            ,(if (memq ':preserve-args (cadr options))
@@ -111,8 +111,6 @@ let-bound variable `args'."
                                ;; `options' is of the form (quote OPTS).
                                (cadr options))))
           (args processed-args))
-     ;; Silence unused lexical variable warning if body does not use `args'.
-     (ignore args)
      ,@body-forms))
 
 ;;; Internal Functions:
diff --git a/lisp/eshell/esh-proc.el b/lisp/eshell/esh-proc.el
index b3bd7a7245..59fb9b926d 100644
--- a/lisp/eshell/esh-proc.el
+++ b/lisp/eshell/esh-proc.el
@@ -87,8 +87,8 @@ variable's value to take effect."
   "Called each time a process is exec'd by `eshell-gather-process-output'.
 It is passed one argument, which is the process that was just started.
 It is useful for things that must be done each time a process is
-executed in an eshell mode buffer (e.g., `set-process-query-on-exit-flag').
-In contrast, `eshell-mode-hook' is only executed once, when the buffer
+executed in an eshell mode buffer (e.g., `process-kill-without-query').
+In contrast, `eshell-mode-hook' is only executed once when the buffer
 is created."
   :type 'hook
   :group 'eshell-proc)
@@ -158,7 +158,7 @@ The signals which will cause this to happen are matched by
 
 (defalias 'eshell/wait 'eshell-wait-for-process)
 
-(defun eshell/jobs (&rest _args)
+(defun eshell/jobs (&rest args)
   "List processes, if there are any."
   (and (fboundp 'process-list)
        (process-list)
diff --git a/lisp/eshell/esh-util.el b/lisp/eshell/esh-util.el
index 5ef1ae4129..5d38c27eb1 100644
--- a/lisp/eshell/esh-util.el
+++ b/lisp/eshell/esh-util.el
@@ -295,7 +295,7 @@ Prepend remote identification of `default-directory', if any."
 	(nconc new-list (list a))))
     (cdr new-list)))
 
-(defun eshell-uniquify-list (l)
+(defun eshell-uniqify-list (l)
   "Remove occurring multiples in L.  You probably want to sort first."
   (let ((m l))
     (while m
@@ -305,9 +305,6 @@ Prepend remote identification of `default-directory', if any."
 	(setcdr m (cddr m)))
       (setq m (cdr m))))
   l)
-(define-obsolete-function-alias
-  'eshell-uniqify-list
-  'eshell-uniquify-list "27.1")
 
 (defun eshell-stringify (object)
   "Convert OBJECT into a string value."
diff --git a/lisp/eshell/esh-var.el b/lisp/eshell/esh-var.el
index b5dce80de8..1af03d367c 100644
--- a/lisp/eshell/esh-var.el
+++ b/lisp/eshell/esh-var.el
@@ -343,8 +343,6 @@ This function is explicit for adding to `eshell-parse-argument-hook'."
 					       obarray 'boundp))
 	      (pcomplete-here))))
 
-;; FIXME the real "env" command does more than this, it runs a program
-;; in a modified environment.
 (defun eshell/env (&rest args)
   "Implementation of `env' in Lisp."
   (eshell-init-print-buffer)
diff --git a/lisp/ffap.el b/lisp/ffap.el
index 22be2f8536..4e479d1b82 100644
--- a/lisp/ffap.el
+++ b/lisp/ffap.el
@@ -248,7 +248,7 @@ it passes it on to `dired'."
 
 (defcustom ffap-newfile-prompt nil
   ;; Suggestion from RHOGEE, 11 Jul 1994.  Disabled, I think this is
-  ;; better handled by `find-file-not-found-functions'.
+  ;; better handled by `find-file-not-found-hooks'.
   "Whether `find-file-at-point' prompts about a nonexistent file."
   :type 'boolean
   :group 'ffap)
diff --git a/lisp/filenotify.el b/lisp/filenotify.el
index 59a8c0e88a..5d37f39a70 100644
--- a/lisp/filenotify.el
+++ b/lisp/filenotify.el
@@ -423,7 +423,7 @@ DESCRIPTOR should be an object returned by `file-notify-add-watch'."
 
 ;; TODO:
 ;; * Watching a /dir/file may receive events for dir.
-;;   (This may be the desired behavior.)
+;;   (This may be the desired behaviour.)
 ;; * Watching a file in an already watched directory
 ;;   If the file is created and *then* a watch is added to that file, the
 ;;   watch might receive events which occurred prior to it being created,
diff --git a/lisp/files.el b/lisp/files.el
index 8ec2bde588..4b67b02c38 100644
--- a/lisp/files.el
+++ b/lisp/files.el
@@ -473,7 +473,7 @@ location of point in the current buffer."
   :group 'find-file)
 
 ;;;It is not useful to make this a local variable.
-;;;(put 'find-file-not-found-functions 'permanent-local t)
+;;;(put 'find-file-not-found-hooks 'permanent-local t)
 (define-obsolete-variable-alias 'find-file-not-found-hooks
     'find-file-not-found-functions "22.1")
 (defvar find-file-not-found-functions nil
@@ -483,8 +483,7 @@ Variable `buffer-file-name' is already set up.
 The functions are called in the order given until one of them returns non-nil.")
 
 ;;;It is not useful to make this a local variable.
-;;;(put 'find-file-hook 'permanent-local t)
-;; I found some external files still using the obsolete form in 2018.
+;;;(put 'find-file-hooks 'permanent-local t)
 (define-obsolete-variable-alias 'find-file-hooks 'find-file-hook "22.1")
 (defcustom find-file-hook nil
   "List of functions to be called after a buffer is loaded from a file.
@@ -495,7 +494,6 @@ functions are called."
   :options '(auto-insert)
   :version "22.1")
 
-;; I found some external files still using the obsolete form in 2018.
 (define-obsolete-variable-alias 'write-file-hooks 'write-file-functions "22.1")
 (defvar write-file-functions nil
   "List of functions to be called before saving a buffer to a file.
@@ -515,13 +513,11 @@ node `(elisp)Saving Buffers'.)  To perform various checks or
 updates before the buffer is saved, use `before-save-hook'.")
 (put 'write-file-functions 'permanent-local t)
 
-;; I found some files still using the obsolete form in 2018.
 (defvar local-write-file-hooks nil)
 (make-variable-buffer-local 'local-write-file-hooks)
 (put 'local-write-file-hooks 'permanent-local t)
 (make-obsolete-variable 'local-write-file-hooks 'write-file-functions "22.1")
 
-;; I found some files still using the obsolete form in 2018.
 (define-obsolete-variable-alias 'write-contents-hooks
     'write-contents-functions "22.1")
 (defvar write-contents-functions nil
@@ -5210,14 +5206,9 @@ about certain files that you'd usually rather not save."
 
 (defun save-some-buffers (&optional arg pred)
   "Save some modified file-visiting buffers.  Asks user about each one.
-You can answer `y' or SPC to save, `n' or DEL not to save, `C-r'
-to look at the buffer in question with `view-buffer' before
-deciding, `d' to view the differences using
-`diff-buffer-with-file', `!' to save the buffer and all remaining
-buffers without any further querying, `.' to save only the
-current buffer and skip the remaining ones and `q' or RET to exit
-the function without saving any more buffers.  `C-h' displays a
-help message describing these options.
+You can answer `y' to save, `n' not to save, `C-r' to look at the
+buffer in question with `view-buffer' before deciding or `d' to
+view the differences using `diff-buffer-with-file'.
 
 This command first saves any buffers where `buffer-save-without-query' is
 non-nil, without asking.
diff --git a/lisp/frame.el b/lisp/frame.el
index fbf2f6e773..0ed7d6a64f 100644
--- a/lisp/frame.el
+++ b/lisp/frame.el
@@ -614,6 +614,9 @@ frame.")
 (defvar after-setting-font-hook nil
   "Functions to run after a frame's font has been changed.")
 
+;; Alias, kept temporarily.
+(define-obsolete-function-alias 'new-frame 'make-frame "22.1")
+
 (defvar frame-inherited-parameters '()
   "Parameters `make-frame' copies from the selected to the new frame.")
 
@@ -1144,6 +1147,8 @@ FRAME defaults to the selected frame."
 (declare-function x-list-fonts "xfaces.c"
                   (pattern &optional face frame maximum width))
 
+(define-obsolete-function-alias 'set-default-font 'set-frame-font "23.1")
+
 (defun set-frame-font (font &optional keep-size frames)
   "Set the default font to FONT.
 When called interactively, prompt for the name of a font, and use
@@ -2108,6 +2113,10 @@ a live frame and defaults to the selected one."
         (delete-frame this))
       (setq this next))))
 
+;; miscellaneous obsolescence declarations
+(define-obsolete-variable-alias 'delete-frame-hook
+    'delete-frame-functions "22.1")
+
 
 ;;; Window dividers.
 (defgroup window-divider nil
@@ -2343,6 +2352,8 @@ This is done when a frame gets focus.  Blink timers may be stopped by
     (remove-hook 'post-command-hook 'blink-cursor-check)
     (blink-cursor--start-idle-timer)))
 
+(define-obsolete-variable-alias 'blink-cursor 'blink-cursor-mode "22.1")
+
 (define-minor-mode blink-cursor-mode
   "Toggle cursor blinking (Blink Cursor mode).
 With a prefix argument ARG, enable Blink Cursor mode if ARG is
@@ -2428,7 +2439,7 @@ See also `toggle-frame-maximized'."
        frame `((fullscreen . fullboth) (fullscreen-restore . ,fullscreen))))
     ;; Manipulating a frame without waiting for the fullscreen
     ;; animation to complete can cause a crash, or other unexpected
-    ;; behavior, on macOS (bug#28496).
+    ;; behaviour, on macOS (bug#28496).
     (when (featurep 'cocoa) (sleep-for 0.5))))
 
 
diff --git a/lisp/generic-x.el b/lisp/generic-x.el
index d8a7fe3a73..3e3ddc5ceb 100644
--- a/lisp/generic-x.el
+++ b/lisp/generic-x.el
@@ -241,11 +241,30 @@ This hook will be installed if the variable
     spice-generic-mode)
   "List of generic modes that are not defined by default.")
 
+(defcustom generic-define-mswindows-modes
+  (memq system-type '(windows-nt ms-dos))
+  "Non-nil means the modes in `generic-mswindows-modes' will be defined.
+This is a list of MS-Windows specific generic modes.  This variable
+only affects the default value of `generic-extras-enable-list'."
+  :group 'generic-x
+  :type 'boolean
+  :version "22.1")
+(make-obsolete-variable 'generic-define-mswindows-modes 'generic-extras-enable-list "22.1")
+
+(defcustom generic-define-unix-modes
+  (not (memq system-type '(windows-nt ms-dos)))
+  "Non-nil means the modes in `generic-unix-modes' will be defined.
+This is a list of Unix specific generic modes.  This variable only
+affects the default value of `generic-extras-enable-list'."
+  :group 'generic-x
+  :type 'boolean
+  :version "22.1")
+(make-obsolete-variable 'generic-define-unix-modes 'generic-extras-enable-list "22.1")
+
 (defcustom generic-extras-enable-list
   (append generic-default-modes
-          (if (memq system-type '(windows-nt ms-dos))
-              generic-mswindows-modes
-            generic-unix-modes)
+	  (if generic-define-mswindows-modes generic-mswindows-modes)
+	  (if generic-define-unix-modes generic-unix-modes)
 	  nil)
   "List of generic modes to define.
 Each entry in the list should be a symbol.  If you set this variable
diff --git a/lisp/gnus/gnus-score.el b/lisp/gnus/gnus-score.el
index ad11ff4a5c..ec07d1ab15 100644
--- a/lisp/gnus/gnus-score.el
+++ b/lisp/gnus/gnus-score.el
@@ -514,7 +514,7 @@ of the last successful match.")
   "f" gnus-score-edit-file
   "F" gnus-score-flush-cache
   "t" gnus-score-find-trace
-  "w" gnus-score-find-favorite-words)
+  "w" gnus-score-find-favourite-words)
 
 ;; Summary score file commands
 
@@ -2517,7 +2517,7 @@ the score file and its full name, including the directory.")
     (set-buffer gnus-summary-buffer)
     (setq gnus-newsgroup-scored old-scored)))
 
-(defun gnus-score-find-favorite-words ()
+(defun gnus-score-find-favourite-words ()
   "List words used in scoring."
   (interactive)
   (let ((alists (gnus-score-load-files (gnus-all-score-files)))
@@ -2553,9 +2553,6 @@ the score file and its full name, including the directory.")
 	(pop rules))
       (goto-char (point-min))
       (gnus-configure-windows 'score-words))))
-(define-obsolete-function-alias
-  'gnus-score-find-favourite-words
-  'gnus-score-find-favorite-words "27.1")
 
 (defun gnus-summary-rescore ()
   "Redo the entire scoring process in the current summary."
diff --git a/lisp/gnus/gnus-sum.el b/lisp/gnus/gnus-sum.el
index 468f2b195e..a28c00be94 100644
--- a/lisp/gnus/gnus-sum.el
+++ b/lisp/gnus/gnus-sum.el
@@ -2370,7 +2370,7 @@ increase the score of each group you read."
 	  ["Edit current score file" gnus-score-edit-current-scores t]
 	  ["Edit score file..." gnus-score-edit-file t]
 	  ["Trace score" gnus-score-find-trace t]
-	  ["Find words" gnus-score-find-favorite-words t]
+	  ["Find words" gnus-score-find-favourite-words t]
 	  ["Rescore buffer" gnus-summary-rescore t]
 	  ["Increase score..." gnus-summary-increase-score t]
 	  ["Lower score..." gnus-summary-lower-score t]))))
diff --git a/lisp/gnus/gnus.el b/lisp/gnus/gnus.el
index fb2ae192f1..123b64ac6c 100644
--- a/lisp/gnus/gnus.el
+++ b/lisp/gnus/gnus.el
@@ -752,7 +752,6 @@ be set in `.emacs' instead."
   (cdr (assq gnus-logo-color-style gnus-logo-color-alist))
   "Colors used for the Gnus logo.")
 
-(defvar image-load-path)
 (declare-function image-size "image.c" (spec &optional pixels frame))
 
 (defun gnus-group-startup-message (&optional x y)
diff --git a/lisp/gnus/mm-decode.el b/lisp/gnus/mm-decode.el
index 372b6da44b..e1a0435b55 100644
--- a/lisp/gnus/mm-decode.el
+++ b/lisp/gnus/mm-decode.el
@@ -1,4 +1,4 @@
-;;; mm-decode.el --- Functions for decoding MIME things  -*- lexical-binding:t -*-
+;;; mm-decode.el --- Functions for decoding MIME things
 
 ;; Copyright (C) 1998-2018 Free Software Foundation, Inc.
 
@@ -773,16 +773,15 @@ MIME-Version header before proceeding."
       (insert-buffer-substring obuf beg)
       (current-buffer))))
 
-(defun mm-display-parts (handle)
-  (cond
-   ((stringp (car handle)) (mapcar #'mm-display-parts (cdr handle)))
-   ((bufferp (car handle))
-    (save-restriction
-      (narrow-to-region (point) (point))
-      (mm-display-part handle)
-      (goto-char (point-max))))
-   (t
-    (mapcar #'mm-display-parts handle))))
+(defun mm-display-parts (handle &optional no-default)
+  (if (stringp (car handle))
+      (mapcar 'mm-display-parts (cdr handle))
+    (if (bufferp (car handle))
+	(save-restriction
+	  (narrow-to-region (point) (point))
+	  (mm-display-part handle)
+	  (goto-char (point-max)))
+      (mapcar 'mm-display-parts handle))))
 
 (autoload 'mailcap-parse-mailcaps "mailcap")
 (autoload 'mailcap-mime-info "mailcap")
@@ -962,15 +961,15 @@ external if displayed external."
 				      mm-external-terminal-program
 				      "-e" shell-file-name
 				      shell-command-switch command)
-		       (lambda (process _state)
-			 (if (eq 'exit (process-status process))
-			     (run-at-time
-			      60.0 nil
-			      (lambda ()
-				(ignore-errors (delete-file file))
-				(ignore-errors (delete-directory
-						(file-name-directory
-						 file))))))))
+		       `(lambda (process state)
+			  (if (eq 'exit (process-status process))
+			      (run-at-time
+			       60.0 nil
+			       (lambda ()
+				 (ignore-errors (delete-file ,file))
+				 (ignore-errors (delete-directory
+						 ,(file-name-directory
+						   file))))))))
 		    (require 'term)
 		    (require 'gnus-win)
 		    (set-buffer
@@ -983,13 +982,13 @@ external if displayed external."
 		    (term-char-mode)
 		    (set-process-sentinel
 		     (get-buffer-process buffer)
-                     (let ((wc gnus-current-window-configuration))
-		       (lambda (process _state)
-			 (when (eq 'exit (process-status process))
-			   (ignore-errors (delete-file file))
-			   (ignore-errors
-			     (delete-directory (file-name-directory file)))
-			   (gnus-configure-windows wc)))))
+		     `(lambda (process state)
+			(when (eq 'exit (process-status process))
+			  (ignore-errors (delete-file ,file))
+			  (ignore-errors
+			    (delete-directory ,(file-name-directory file)))
+			  (gnus-configure-windows
+			   ',gnus-current-window-configuration))))
 		    (gnus-configure-windows 'display-term))
 		(mm-handle-set-external-undisplayer handle (cons file buffer))
 		(add-to-list 'mm-temp-files-to-be-deleted file t))
@@ -1033,29 +1032,34 @@ external if displayed external."
 				   shell-command-switch command)
 		    (set-process-sentinel
 		     (get-buffer-process buffer)
-		     (lambda (process _state)
-		       (when (eq (process-status process) 'exit)
-			 (run-at-time
-			  60.0 nil
-			  (lambda ()
-			    (ignore-errors (delete-file file))
-			    (ignore-errors (delete-directory
-					    (file-name-directory file)))))
-			 (when (buffer-live-p outbuf)
-			   (with-current-buffer outbuf
-			     (let ((buffer-read-only nil)
-				   (point (point)))
-			       (forward-line 2)
-			       (let ((start (point)))
-				 (mm-insert-inline
-				  handle (with-current-buffer buffer
-					   (buffer-string)))
-				 (put-text-property start (point)
-						    'face 'mm-command-output))
-			       (goto-char point))))
-			 (when (buffer-live-p buffer)
-			   (kill-buffer buffer)))
-		       (message "Displaying %s...done" command))))
+		     (lexical-let ((outbuf outbuf)
+				   (file file)
+				   (buffer buffer)
+				   (command command)
+				   (handle handle))
+		       (lambda (process state)
+			 (when (eq (process-status process) 'exit)
+			   (run-at-time
+			    60.0 nil
+			    (lambda ()
+			      (ignore-errors (delete-file file))
+			      (ignore-errors (delete-directory
+					      (file-name-directory file)))))
+			   (when (buffer-live-p outbuf)
+			     (with-current-buffer outbuf
+			       (let ((buffer-read-only nil)
+				     (point (point)))
+				 (forward-line 2)
+				 (let ((start (point)))
+				   (mm-insert-inline
+				    handle (with-current-buffer buffer
+					     (buffer-string)))
+				   (put-text-property start (point)
+						      'face 'mm-command-output))
+				 (goto-char point))))
+			   (when (buffer-live-p buffer)
+			     (kill-buffer buffer)))
+			 (message "Displaying %s...done" command)))))
 		(mm-handle-set-external-undisplayer
 		 handle (cons file buffer))
 		(add-to-list 'mm-temp-files-to-be-deleted file t))
@@ -1166,9 +1170,9 @@ external if displayed external."
     (goto-char (point-min))))
 
 (defun mm-assoc-string-match (alist type)
-  (cl-dolist (elem alist)
+  (dolist (elem alist)
     (when (string-match (car elem) type)
-      (cl-return elem))))
+      (return elem))))
 
 (defun mm-automatic-display-p (handle)
   "Say whether the user wants HANDLE to be displayed automatically."
@@ -1298,6 +1302,8 @@ are ignored."
 			 'gnus-decoded)
 		     (with-current-buffer (mm-handle-buffer handle)
 		       (buffer-string)))
+		    ((mm-multibyte-p)
+		     (string-to-multibyte (mm-get-part handle no-cache)))
 		    (t
 		     (mm-get-part handle no-cache)))))
     (save-restriction
@@ -1442,7 +1448,8 @@ text/html\\(?:;\\s-*charset=\\([^\t\n\r \"'>]+\\)\\)?[^>]*>" nil t)
 (defun mm-pipe-part (handle &optional cmd)
   "Pipe HANDLE to a process.
 Use CMD as the process."
-  (let ((command (or cmd
+  (let ((name (mail-content-type-get (mm-handle-type handle) 'name))
+	(command (or cmd
 		     (read-shell-command
 		      "Shell command on MIME part: " mm-last-shell-command))))
     (mm-with-unibyte-buffer
@@ -1777,9 +1784,6 @@ If RECURSIVE, search recursively."
 (declare-function shr-insert-document "shr" (dom))
 (defvar shr-blocked-images)
 (defvar shr-use-fonts)
-(defvar shr-width)
-(defvar shr-content-function)
-(defvar shr-inhibit-images)
 
 (defun mm-shr (handle)
   ;; Require since we bind its variables.
@@ -1836,11 +1840,10 @@ text/html;\\s-*charset=\\([^\t\n\r \"'>]+\\)[^>]*>" nil t)
       (mm-convert-shr-links)
       (mm-handle-set-undisplayer
        handle
-       (let ((min (point-min-marker))
-             (max (point-max-marker)))
-         (lambda ()
-	   (let ((inhibit-read-only t))
-	     (delete-region min max))))))))
+       `(lambda ()
+	  (let ((inhibit-read-only t))
+	    (delete-region ,(point-min-marker)
+			   ,(point-max-marker))))))))
 
 (defvar shr-image-map)
 
diff --git a/lisp/gnus/mm-extern.el b/lisp/gnus/mm-extern.el
index fbae669ce9..e2f8bd4af3 100644
--- a/lisp/gnus/mm-extern.el
+++ b/lisp/gnus/mm-extern.el
@@ -1,4 +1,4 @@
-;;; mm-extern.el --- showing message/external-body  -*- lexical-binding:t -*-
+;;; mm-extern.el --- showing message/external-body
 
 ;; Copyright (C) 2000-2018 Free Software Foundation, Inc.
 
@@ -24,6 +24,8 @@
 
 ;;; Code:
 
+(eval-when-compile (require 'cl))
+
 (require 'mm-util)
 (require 'mm-decode)
 (require 'mm-url)
@@ -31,13 +33,13 @@
 (defvar gnus-article-mime-handles)
 
 (defvar mm-extern-function-alist
-  `((local-file . ,#'mm-extern-local-file)
-    (url . ,#'mm-extern-url)
-    (anon-ftp . ,#'mm-extern-anon-ftp)
-    (ftp . ,#'mm-extern-ftp)
-    ;; (tftp . ,#'mm-extern-tftp)
-    (mail-server . ,#'mm-extern-mail-server)
-    ;; (afs . ,#'mm-extern-afs))
+  '((local-file . mm-extern-local-file)
+    (url . mm-extern-url)
+    (anon-ftp . mm-extern-anon-ftp)
+    (ftp . mm-extern-ftp)
+;;;     (tftp . mm-extern-tftp)
+    (mail-server . mm-extern-mail-server)
+;;;     (afs . mm-extern-afs))
     ))
 
 (defvar mm-extern-anonymous "anonymous")
@@ -70,6 +72,7 @@
 	 (name (cdr (assq 'name params)))
 	 (site (cdr (assq 'site params)))
 	 (directory (cdr (assq 'directory params)))
+	 (mode (cdr (assq 'mode params)))
 	 (path (concat "/" (or mm-extern-anonymous
 			       (read-string (format "ID for %s: " site)))
 		       "@" site ":" directory "/" name))
diff --git a/lisp/gnus/mml-sec.el b/lisp/gnus/mml-sec.el
index dc10763da8..099e5372b4 100644
--- a/lisp/gnus/mml-sec.el
+++ b/lisp/gnus/mml-sec.el
@@ -647,7 +647,6 @@ The passphrase is read and cached."
       (when passphrase
 	(let ((password-cache-expiry (mml-secure-cache-expiry-interval
 				      (epg-context-protocol context))))
-	  ;; FIXME test passphrase works before caching it.
 	  (password-cache-add password-cache-key-id passphrase))
 	(mml-secure-add-secret-key-id password-cache-key-id)
 	(copy-sequence passphrase)))))
@@ -904,7 +903,7 @@ If no one is selected, symmetric encryption will be performed.  "
 (defun mml-secure-epg-encrypt (protocol cont &optional sign)
   ;; Based on code appearing inside mml2015-epg-encrypt.
   (let* ((context (epg-make-context protocol))
-	 (config (epg-find-configuration 'OpenPGP))
+	 (config (epg-configuration))
 	 (sender (message-options-get 'message-sender))
 	 (recipients (mml-secure-recipients protocol context config sender))
 	 (signer-names (mml-secure-signer-names protocol sender))
diff --git a/lisp/gnus/nnheader.el b/lisp/gnus/nnheader.el
index 77afb09a2a..14bd14924f 100644
--- a/lisp/gnus/nnheader.el
+++ b/lisp/gnus/nnheader.el
@@ -945,7 +945,7 @@ first.  Otherwise, find the newest one, though it may take a time."
   "Like `insert-file-contents', q.v., but only reads in the file.
 A buffer may be modified in several ways after reading into the buffer due
 to advanced Emacs features, such as file-name-handlers, format decoding,
-find-file-hook, etc.
+find-file-hooks, etc.
   This function ensures that none of these modifications will take place."
   (let ((coding-system-for-read nnheader-file-coding-system))
     (mm-insert-file-contents filename visit beg end replace)))
diff --git a/lisp/gnus/nnir.el b/lisp/gnus/nnir.el
index 0a7d829614..55e00a0b69 100644
--- a/lisp/gnus/nnir.el
+++ b/lisp/gnus/nnir.el
@@ -644,7 +644,7 @@ skips all prompting."
       (add-hook 'gnus-summary-mode-hook 'nnir-mode)
       (nnoo-change-server 'nnir server definitions))))
 
-(deffoo nnir-request-group (group &optional server dont-check _info)
+(deffoo nnir-request-group (group &optional server dont-check info)
   (nnir-possibly-change-group group server)
   (let ((pgroup (gnus-group-guess-full-name-from-command-method group))
 	length)
@@ -669,9 +669,7 @@ skips all prompting."
                          group)))) ; group name
   nnir-artlist)
 
-(defvar gnus-inhibit-demon)
-
-(deffoo nnir-retrieve-headers (articles &optional _group _server _fetch-old)
+(deffoo nnir-retrieve-headers (articles &optional group server fetch-old)
   (with-current-buffer nntp-server-buffer
     (let ((gnus-inhibit-demon t)
 	  (articles-by-group (nnir-categorize
@@ -718,8 +716,6 @@ skips all prompting."
       (mapc 'nnheader-insert-nov headers)
       'nov)))
 
-(defvar gnus-article-decode-hook)
-
 (deffoo nnir-request-article (article &optional group server to-buffer)
   (nnir-possibly-change-group group server)
   (if (and (stringp article)
@@ -757,7 +753,7 @@ skips all prompting."
             (cons artfullgroup artno)))))))
 
 (deffoo nnir-request-move-article (article group server accept-form
-					   &optional last _internal-move-group)
+					   &optional last internal-move-group)
   (nnir-possibly-change-group group server)
   (let* ((artfullgroup (nnir-article-group article))
 	 (artno (nnir-article-number article))
@@ -807,8 +803,7 @@ skips all prompting."
 		(error "Can't warp to a pseudo-article")))
 	 (backend-article-group (nnir-article-group cur))
          (backend-article-number (nnir-article-number cur))
-;	 (quit-config (gnus-ephemeral-group-p gnus-newsgroup-name))
-	 )
+	 (quit-config (gnus-ephemeral-group-p gnus-newsgroup-name)))
 
     ;; what should we do here? we could leave all the buffers around
     ;; and assume that we have to exit from them one by one. or we can
@@ -823,7 +818,7 @@ skips all prompting."
     (gnus-summary-read-group-1 backend-article-group t t  nil
                                nil (list backend-article-number))))
 
-(deffoo nnir-request-update-mark (_group article mark)
+(deffoo nnir-request-update-mark (group article mark)
   (let ((artgroup (nnir-article-group article))
 	(artnumber (nnir-article-number article)))
     (or (and artgroup
@@ -961,7 +956,7 @@ details on the language and supported extensions."
   (save-excursion
     (let ((qstring (cdr (assq 'query query)))
           (server (cadr (gnus-server-to-method srv)))
-;;          (defs (nth 2 (gnus-server-to-method srv)))
+          (defs (nth 2 (gnus-server-to-method srv)))
           (criteria (or (cdr (assq 'criteria query))
                         (cdr (assoc nnir-imap-default-search-key
                                     nnir-imap-search-arguments))))
@@ -1182,7 +1177,7 @@ returning the one at the supplied position."
 ;; - article number
 ;; - file size
 ;; - group
-(defun nnir-run-swish++ (query server &optional _group)
+(defun nnir-run-swish++ (query server &optional group)
   "Run QUERY against swish++.
 Returns a vector of (group name, file name) pairs (also vectors,
 actually).
@@ -1272,7 +1267,7 @@ Windows NT 4.0."
                                   (nnir-artitem-rsv y)))))))))
 
 ;; Swish-E interface.
-(defun nnir-run-swish-e (query server &optional _group)
+(defun nnir-run-swish-e (query server &optional group)
   "Run given query against swish-e.
 Returns a vector of (group name, file name) pairs (also vectors,
 actually).
@@ -1438,7 +1433,7 @@ Tested with swish-e-2.0.1 on Windows NT 4.0."
       )))
 
 ;; Namazu interface
-(defun nnir-run-namazu (query server &optional _group)
+(defun nnir-run-namazu (query server &optional group)
   "Run given query against Namazu.  Returns a vector of (group name, file name)
 pairs (also vectors, actually).
 
@@ -1507,7 +1502,7 @@ Tested with Namazu 2.0.6 on a GNU/Linux system."
                                (> (nnir-artitem-rsv x)
                                   (nnir-artitem-rsv y)))))))))
 
-(defun nnir-run-notmuch (query server &optional _group)
+(defun nnir-run-notmuch (query server &optional group)
   "Run QUERY against notmuch.
 Returns a vector of (group name, file name) pairs (also vectors,
 actually)."
@@ -1672,7 +1667,7 @@ actually)."
   "Run a search against a gmane back-end server."
       (let* ((case-fold-search t)
 	     (qstring (cdr (assq 'query query)))
-;;	     (server (cadr (gnus-server-to-method srv)))
+	     (server (cadr (gnus-server-to-method srv)))
 	     (groupspec (mapconcat
 			 (lambda (x)
 			   (if (string-match-p "gmane" x)
@@ -1814,7 +1809,8 @@ article came from is also searched."
 	groups)
     (gnus-request-list method)
     (with-current-buffer nntp-server-buffer
-      (let ((cur (current-buffer)))
+      (let ((cur (current-buffer))
+	    name)
 	(goto-char (point-min))
 	(unless (or (null nnir-ignored-newsgroups)
 		    (string= nnir-ignored-newsgroups ""))
@@ -1855,7 +1851,7 @@ article came from is also searched."
 (declare-function gnus-registry-action "gnus-registry"
                   (action data-header from &optional to method))
 
-(defun nnir-registry-action (action data-header _from &optional to method)
+(defun nnir-registry-action (action data-header from &optional to method)
   "Call `gnus-registry-action' with the original article group."
   (gnus-registry-action
    action
@@ -1890,7 +1886,7 @@ article came from is also searched."
        (gnus-group-find-parameter pgroup)))))
 
 
-(deffoo nnir-request-create-group (group &optional _server args)
+(deffoo nnir-request-create-group (group &optional server args)
   (message "Creating nnir group %s" group)
   (let* ((group (gnus-group-prefixed-name  group '(nnir "nnir")))
          (specs (assq 'nnir-specs args))
@@ -1911,13 +1907,13 @@ article came from is also searched."
     (nnir-request-update-info group (gnus-get-info group)))
   t)
 
-(deffoo nnir-request-delete-group (_group &optional _force _server)
+(deffoo nnir-request-delete-group (group &optional force server)
   t)
 
-(deffoo nnir-request-list (&optional _server)
+(deffoo nnir-request-list (&optional server)
   t)
 
-(deffoo nnir-request-scan (_group _method)
+(deffoo nnir-request-scan (group method)
   t)
 
 (deffoo nnir-request-close ()
diff --git a/lisp/gnus/nnmaildir.el b/lisp/gnus/nnmaildir.el
index dc97b32f0b..3e4a87cee7 100644
--- a/lisp/gnus/nnmaildir.el
+++ b/lisp/gnus/nnmaildir.el
@@ -1779,11 +1779,14 @@ This variable is set by `nnmaildir-request-article'.")
       t)))
 
 (defun nnmaildir-close-server (&optional server)
-  (nnmaildir--prepare server nil)
-  (when nnmaildir--cur-server
-    (setq server nnmaildir--cur-server
-	  nnmaildir--cur-server nil)
-    (unintern (nnmaildir--srv-address server) nnmaildir--servers))
+  (defvar flist) (defvar ls) (defvar dirs) (defvar dir)
+  (defvar files) (defvar file) (defvar x)
+  (let (flist ls dirs dir files file x)
+    (nnmaildir--prepare server nil)
+    (when nnmaildir--cur-server
+      (setq server nnmaildir--cur-server
+	    nnmaildir--cur-server nil)
+      (unintern (nnmaildir--srv-address server) nnmaildir--servers)))
   t)
 
 (defun nnmaildir-request-close ()
diff --git a/lisp/gnus/smime.el b/lisp/gnus/smime.el
index ab2a5b0f81..3e722d2d82 100644
--- a/lisp/gnus/smime.el
+++ b/lisp/gnus/smime.el
@@ -234,12 +234,10 @@ must be set in `ldap-host-parameters-alist'."
 If `cache-key' and `password-cache' is non-nil then cache the
 password under `cache-key'."
   (let ((passphrase
-	 (password-read
+	 (password-read-and-add
 	  "Passphrase for secret key (RET for no passphrase): " cache-key)))
     (if (string= passphrase "")
 	nil
-      ;; FIXME test passphrase works before caching it.
-      (and passphrase cache-key (password-cache-add cache-key passphrase))
       passphrase)))
 
 ;; OpenSSL wrappers.
diff --git a/lisp/gnus/spam.el b/lisp/gnus/spam.el
index 97e63404c4..de8aa77efc 100644
--- a/lisp/gnus/spam.el
+++ b/lisp/gnus/spam.el
@@ -408,12 +408,16 @@ Only meaningful if you enable `spam-use-regex-body'."
   "Spam ifile configuration."
   :group 'spam)
 
+(make-obsolete-variable 'spam-ifile-path 'spam-ifile-program
+                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-ifile-program (executable-find "ifile")
   "Name of the ifile program."
   :type '(choice (file :tag "Location of ifile")
                  (const :tag "ifile is not installed"))
   :group 'spam-ifile)
 
+(make-obsolete-variable 'spam-ifile-database-path 'spam-ifile-database
+                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-ifile-database nil
   "File name of the ifile database."
   :type '(choice (file :tag "Location of the ifile database")
@@ -443,6 +447,8 @@ your main source of newsgroup names."
   "Spam bogofilter configuration."
   :group 'spam)
 
+(make-obsolete-variable 'spam-bogofilter-path 'spam-bogofilter-program
+                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-bogofilter-program (executable-find "bogofilter")
   "Name of the Bogofilter program."
   :type '(choice (file :tag "Location of bogofilter")
@@ -493,6 +499,8 @@ When nil, use the default location."
   "Spam bsfilter configuration."
   :group 'spam)
 
+(make-obsolete-variable 'spam-bsfilter-path 'spam-bsfilter-program
+                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-bsfilter-program (executable-find "bsfilter")
   "Name of the Bsfilter program."
   :type '(choice (file :tag "Location of bsfilter")
@@ -557,6 +565,8 @@ When nil, use the default spamoracle database."
   "Spam SpamAssassin configuration."
   :group 'spam)
 
+(make-obsolete-variable 'spam-spamassassin-path
+  'spam-spamassassin-program "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-assassin-program (executable-find "spamassassin")
   "Name of the spamassassin program.
 Hint: set this to \"spamc\" if you have spamd running.  See the spamc and
@@ -587,6 +597,8 @@ identification"
   :type 'string
   :group 'spam-spamassassin)
 
+(make-obsolete-variable 'spam-sa-learn-path 'spam-sa-learn-program
+                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-sa-learn-program (executable-find "sa-learn")
   "Name of the sa-learn program."
   :type '(choice (file :tag "Location of spamassassin")
@@ -1244,40 +1256,73 @@ Will not return a nil score."
         (setq found backend)))
     found))
 
+(defvar spam-list-of-processors
+  ;; note the nil processors are not defined in gnus.el
+  '((gnus-group-spam-exit-processor-bogofilter   spam spam-use-bogofilter)
+    (gnus-group-spam-exit-processor-bsfilter     spam spam-use-bsfilter)
+    (gnus-group-spam-exit-processor-blacklist    spam spam-use-blacklist)
+    (gnus-group-spam-exit-processor-ifile        spam spam-use-ifile)
+    (gnus-group-spam-exit-processor-stat         spam spam-use-stat)
+    (gnus-group-spam-exit-processor-spamoracle   spam spam-use-spamoracle)
+    (gnus-group-spam-exit-processor-spamassassin spam spam-use-spamassassin)
+    (gnus-group-spam-exit-processor-report-gmane spam spam-use-gmane) ;; Buggy?
+    (gnus-group-ham-exit-processor-ifile         ham spam-use-ifile)
+    (gnus-group-ham-exit-processor-bogofilter    ham spam-use-bogofilter)
+    (gnus-group-ham-exit-processor-bsfilter      ham spam-use-bsfilter)
+    (gnus-group-ham-exit-processor-stat          ham spam-use-stat)
+    (gnus-group-ham-exit-processor-whitelist     ham spam-use-whitelist)
+    (gnus-group-ham-exit-processor-BBDB          ham spam-use-BBDB)
+    (gnus-group-ham-exit-processor-copy          ham spam-use-ham-copy)
+    (gnus-group-ham-exit-processor-spamassassin  ham spam-use-spamassassin)
+    (gnus-group-ham-exit-processor-spamoracle    ham spam-use-spamoracle))
+  "The OBSOLETE `spam-list-of-processors' list.
+This list contains pairs associating the obsolete ham/spam exit
+processor variables with a classification and a spam-use-*
+variable.  When the processor variable is nil, just the
+classification and spam-use-* check variable are used.  This is
+superseded by the new spam backend code, so it's only consulted
+for backwards compatibility.")
+(make-obsolete-variable 'spam-list-of-processors nil "22.1")
+
 (defun spam-group-processor-p (group backend &optional classification)
   "Checks if GROUP has a BACKEND with CLASSIFICATION registered.
-In the case of mover backends, checks the setting of
-`spam-summary-exit-behavior' in addition to the set values for the group."
+Also accepts the obsolete processors, which can be found in
+gnus.el and in spam-list-of-processors.  In the case of mover
+backends, checks the setting of `spam-summary-exit-behavior' in
+addition to the set values for the group."
   (if (and (stringp group)
            (symbolp backend))
-      (let ((parameters (nth 0 (gnus-parameter-spam-process group)))
+      (let ((old-style (assq backend spam-list-of-processors))
+            (parameters (nth 0 (gnus-parameter-spam-process group)))
             found)
-        ;; now search for the parameter
-        (dolist (parameter parameters)
-          (when (and (null found)
-                     (listp parameter)
-                     (eq classification (nth 0 parameter))
-                     (eq backend (nth 1 parameter)))
-            (setq found t)))
-
-        ;; now, if the parameter was not found, do the
-        ;; spam-summary-exit-behavior-logic for mover backends
-        (unless found
-          (when (spam-backend-mover-p backend)
-            (setq
-             found
-             (cond
-              ((eq spam-summary-exit-behavior 'move-all) t)
-              ((eq spam-summary-exit-behavior 'move-none) nil)
-              ((eq spam-summary-exit-behavior 'default)
-               (or (eq classification 'spam) ;move spam out of all groups
-                   ;; move ham out of spam groups
-                   (and (eq classification 'ham)
-                        (spam-group-spam-contents-p group))))
-              (t (gnus-error 5 "Unknown spam-summary-exit-behavior: %s"
-                             spam-summary-exit-behavior))))))
-
-        found)
+        (if old-style  ; old-style processor
+            (spam-group-processor-p group (nth 2 old-style) (nth 1 old-style))
+          ;; now search for the parameter
+          (dolist (parameter parameters)
+            (when (and (null found)
+                       (listp parameter)
+                       (eq classification (nth 0 parameter))
+                       (eq backend (nth 1 parameter)))
+              (setq found t)))
+
+          ;; now, if the parameter was not found, do the
+          ;; spam-summary-exit-behavior-logic for mover backends
+          (unless found
+            (when (spam-backend-mover-p backend)
+              (setq
+               found
+               (cond
+                ((eq spam-summary-exit-behavior 'move-all) t)
+                ((eq spam-summary-exit-behavior 'move-none) nil)
+                ((eq spam-summary-exit-behavior 'default)
+                 (or (eq classification 'spam) ;move spam out of all groups
+                     ;; move ham out of spam groups
+                     (and (eq classification 'ham)
+                          (spam-group-spam-contents-p group))))
+                (t (gnus-error 5 "Unknown spam-summary-exit-behavior: %s"
+                               spam-summary-exit-behavior))))))
+
+          found))
     nil))
 
 ;;}}}
diff --git a/lisp/help.el b/lisp/help.el
index 0830dc5d3c..e923546032 100644
--- a/lisp/help.el
+++ b/lisp/help.el
@@ -308,6 +308,8 @@ If that doesn't give a function, return nil."
   (interactive)
   (browse-url "https://www.gnu.org/gnu/thegnuproject.html"))
 
+(define-obsolete-function-alias 'describe-project 'describe-gnu-project "22.2")
+
 (defun describe-no-warranty ()
   "Display info on all the kinds of warranty Emacs does NOT have."
   (interactive)
@@ -411,6 +413,9 @@ With argument, display info only for the selected version."
   (interactive "P")
   (view-help-file "TODO"))
 
+(define-obsolete-function-alias 'view-todo 'view-emacs-todo "22.2")
+
+
 (defun view-echo-area-messages ()
   "View the log of recent echo-area messages: the `*Messages*' buffer.
 The number of messages retained in that buffer
diff --git a/lisp/hfy-cmap.el b/lisp/hfy-cmap.el
index 4ec24cea70..6dea345f28 100644
--- a/lisp/hfy-cmap.el
+++ b/lisp/hfy-cmap.el
@@ -1,15 +1,15 @@
-;;; hfy-cmap.el --- Fallback color name -> rgb mapping for `htmlfontify'
+;;; hfy-cmap.el --- Fallback colour name -> rgb mapping for `htmlfontify'
 
 ;; Copyright (C) 2002-2003, 2009-2018 Free Software Foundation, Inc.
 
 ;; Emacs Lisp Archive Entry
 ;; Package: htmlfontify
 ;; Filename: hfy-cmap.el
-;; Keywords: color, rgb
+;; Keywords: colour, rgb
 ;; Author: Vivek Dasmohapatra <vivek@etla.org>
 ;; Maintainer: Vivek Dasmohapatra <vivek@etla.org>
 ;; Created: 2002-01-20
-;; Description: fallback code for color name -> rgb mapping
+;; Description: fallback code for colour name -> rgb mapping
 ;; URL: http://rtfm.etla.org/emacs/htmlfontify/
 ;; Last-Updated: Sat 2003-02-15 03:49:32 +0000
 
@@ -32,7 +32,7 @@
 
 ;;; Code:
 
-(defconst hfy-fallback-color-map
+(defconst hfy-fallback-colour-map
   '(("snow"                    65535 64250 64250)
     ("ghost white"             63736 63736 65535)
     ("GhostWhite"              63736 63736 65535)
@@ -785,14 +785,8 @@
     ("DarkRed"                 35723     0     0)
     ("light green"             37008 61166 37008)
     ("LightGreen"              37008 61166 37008)) )
-(define-obsolete-variable-alias
-  'hfy-fallback-colour-map
-  'hfy-fallback-color-map "27.1")
 
-(defvar hfy-rgb-txt-color-map nil)
-(define-obsolete-variable-alias
-  'hfy-rgb-txt-colour-map
-  'hfy-rgb-txt-color-map "27.1")
+(defvar hfy-rgb-txt-colour-map nil)
 
 (defvar hfy-rgb-load-path
   (list "/etc/X11"
@@ -812,8 +806,8 @@
 (defun htmlfontify-load-rgb-file (&optional file)
   "Load an X11 style rgb.txt FILE.
 Search `hfy-rgb-load-path' if FILE is not specified.
-Loads the variable `hfy-rgb-txt-color-map', which is used by
-`hfy-fallback-color-values'."
+Loads the variable `hfy-rgb-txt-colour-map', which is used by
+`hfy-fallback-colour-values'."
   (interactive
    (list
     (read-file-name "rgb.txt (equivalent) file: " "" nil t (hfy-rgb-file))))
@@ -828,28 +822,25 @@ Loads the variable `hfy-rgb-txt-color-map', which is used by
 	  (htmlfontify-unload-rgb-file)
 	  (while (/= end-of-rgb 1)
 	    (if (looking-at hfy-rgb-regex)
-		(setq hfy-rgb-txt-color-map
+		(setq hfy-rgb-txt-colour-map
 		      (cons (list (match-string 4)
 				  (string-to-number (match-string 1))
 				  (string-to-number (match-string 2))
 				  (string-to-number (match-string 3)))
-			    hfy-rgb-txt-color-map)) )
+			    hfy-rgb-txt-colour-map)) )
 	    (setq end-of-rgb (forward-line)))
 	  (kill-buffer rgb-buffer)))))
 
 (defun htmlfontify-unload-rgb-file ()
   "Unload the current color name -> rgb translation map."
   (interactive)
-  (setq hfy-rgb-txt-color-map nil))
+  (setq hfy-rgb-txt-colour-map nil))
 
 ;;;###autoload
-(defun hfy-fallback-color-values (color-string)
+(defun hfy-fallback-colour-values (colour-string)
   "Use a fallback method for obtaining the rgb values for a color."
-  (cdr (assoc-string color-string (or hfy-rgb-txt-color-map
-				      hfy-fallback-color-map))) )
-(define-obsolete-function-alias
-  'hfy-fallback-colour-values
-  'hfy-fallback-color-values "27.1")
+  (cdr (assoc-string colour-string (or hfy-rgb-txt-colour-map
+                                       hfy-fallback-colour-map))) )
 
 (provide 'hfy-cmap)
 
diff --git a/lisp/hilit-chg.el b/lisp/hilit-chg.el
index 9d4d2d8b38..de1ae0d457 100644
--- a/lisp/hilit-chg.el
+++ b/lisp/hilit-chg.el
@@ -204,6 +204,9 @@
   :group 'highlight-changes)
 
 ;; A (not very good) default list of colors to rotate through.
+(define-obsolete-variable-alias 'highlight-changes-colours
+                                'highlight-changes-colors "22.1")
+
 (defcustom highlight-changes-colors
   (if (eq (frame-parameter nil 'background-mode) 'light)
       ;; defaults for light background:
@@ -297,9 +300,9 @@ modes only."
 
 (defcustom highlight-changes-global-changes-existing-buffers nil
   "If non-nil, toggling global Highlight Changes mode affects existing buffers.
-Normally, `global-highlight-changes-mode' affects only new buffers (to be
+Normally, `global-highlight-changes' affects only new buffers (to be
 created).  However, if `highlight-changes-global-changes-existing-buffers'
-is non-nil, then turning on `global-highlight-changes-mode' will turn on
+is non-nil, then turning on `global-highlight-changes' will turn on
 Highlight Changes mode in suitable buffers, and turning the mode off will
 remove it from existing buffers."
   :type 'boolean
diff --git a/lisp/htmlfontify.el b/lisp/htmlfontify.el
index 23efcd1298..dfa6bde297 100644
--- a/lisp/htmlfontify.el
+++ b/lisp/htmlfontify.el
@@ -584,23 +584,22 @@ therefore no longer care about) will be invalid at any time.\n
       (if (memq elt set-b) (setq interq (cons elt interq))))
     interq))
 
-(defun hfy-color-vals (color)
-  "Where COLOR is a color name or #XXXXXX style triplet, return a
+(defun hfy-colour-vals (colour)
+  "Where COLOUR is a color name or #XXXXXX style triplet, return a
 list of three (16 bit) rgb values for said color.\n
-If a window system is unavailable, calls `hfy-fallback-color-values'."
-  (if (string-match hfy-triplet-regex color)
+If a window system is unavailable, calls `hfy-fallback-colour-values'."
+  (if (string-match hfy-triplet-regex colour)
       (mapcar
-       (lambda (x) (* (string-to-number (match-string x color) 16) 257))
+       (lambda (x) (* (string-to-number (match-string x colour) 16) 257))
        '(1 2 3))
-    ;;(message ">> %s" color)
+    ;;(message ">> %s" colour)
     (if window-system
         (if (fboundp 'color-values)
-            (color-values color)
+            (color-values colour)
           ;;(message "[%S]" window-system)
-          (x-color-values color))
+          (x-color-values colour))
       ;; blarg - tty colors are no good - go fetch some X colors:
-      (hfy-fallback-color-values color))))
-(define-obsolete-function-alias 'hfy-colour-vals 'hfy-color-vals "27.1")
+      (hfy-fallback-colour-values colour))))
 
 (defvar hfy-cperl-mode-kludged-p nil)
 
@@ -739,7 +738,7 @@ FILE is the name of the file being rendered, in case it is needed."
   "Replace the end of a CSS style declaration STYLE-STRING with the contents
 of the variable `hfy-src-doc-link-style', removing text matching the regex
 `hfy-src-doc-link-unstyle' first, if necessary."
-  ;;(message "hfy-color-vals");;DBUG
+  ;;(message "hfy-colour-vals");;DBUG
   (if (string-match hfy-src-doc-link-unstyle style-string)
       (setq style-string (replace-match "" 'fixed-case 'literal style-string)))
   (if (and (not (string-match hfy-src-doc-link-style style-string))
@@ -752,19 +751,19 @@ of the variable `hfy-src-doc-link-style', removing text matching the regex
 
 ;; utility functions - cast emacs style specification values into their
 ;; css2 equivalents:
-(defun hfy-triplet (color)
-  "Takes a COLOR name (string) and return a CSS rgb(R, G, B) triplet string.
+(defun hfy-triplet (colour)
+  "Takes a COLOUR name (string) and return a CSS rgb(R, G, B) triplet string.
 Uses the definition of \"white\" to map the numbers to the 0-255 range, so
 if you've redefined white, (esp. if you've redefined it to have a triplet
 member lower than that of the color you are processing) strange things
 may happen."
-  ;;(message "hfy-color-vals");;DBUG
+  ;;(message "hfy-colour-vals");;DBUG
   ;; TODO?  Can we do somehow do better than this?
   (cond
-   ((equal color "unspecified-fg") (setq color "black"))
-   ((equal color "unspecified-bg") (setq color "white")))
-  (let ((white (mapcar (lambda (I) (float (1+ I))) (hfy-color-vals "white")))
-        (rgb16 (mapcar (lambda (I) (float (1+ I))) (hfy-color-vals  color))))
+   ((equal colour "unspecified-fg") (setq colour "black"))
+   ((equal colour "unspecified-bg") (setq colour "white")))
+  (let ((white (mapcar (lambda (I) (float (1+ I))) (hfy-colour-vals "white")))
+        (rgb16 (mapcar (lambda (I) (float (1+ I))) (hfy-colour-vals  colour))))
     (if rgb16
         ;;(apply 'format "rgb(%d, %d, %d)"
         ;; Use #rrggbb instead, it is smaller
@@ -775,9 +774,8 @@ may happen."
                        '(0 1 2))))))
 
 (defun hfy-family (family) (list (cons "font-family"  family)))
-(defun hfy-bgcol  (color) (list (cons "background"   (hfy-triplet color))))
-(defun hfy-color (color) (list (cons "color"        (hfy-triplet color))))
-(define-obsolete-function-alias 'hfy-colour 'hfy-color "27.1")
+(defun hfy-bgcol  (colour) (list (cons "background"   (hfy-triplet colour))))
+(defun hfy-colour (colour) (list (cons "color"        (hfy-triplet colour))))
 (defun hfy-width  (width)  (list (cons "font-stretch" (symbol-name  width))))
 
 (defcustom hfy-font-zoom 1.05
@@ -827,17 +825,17 @@ regular specifiers."
       (let ((tag (car  spec))
             (val (cadr spec)))
         (cons (cl-case tag
-                (:color (cons "color" val))
+                (:color (cons "colour" val))
                 (:width (cons "width"  val))
                 (:style (cons "style"  val)))
               (hfy-box-to-border-assoc (cddr spec))))))
 
 (defun hfy-box-to-style (spec)
   (let* ((css (hfy-box-to-border-assoc  spec))
-         (col (cdr      (assoc "color" css)))
+         (col (cdr      (assoc "colour" css)))
          (s   (cdr      (assoc "style"  css))))
     (list
-     (if col (cons "border-color" (cdr (assoc "color" css))))
+     (if col (cons "border-color" (cdr (assoc "colour" css))))
      (cons "border-width" (format "%dpx" (or (cdr (assoc "width" css)) 1)))
      (cons "border-style" (cl-case s
                             (released-button "outset")
@@ -1016,7 +1014,7 @@ merged by the user - `hfy-flatten-style' should do this."
                        (:width          (hfy-width     val))
                        (:weight         (hfy-weight    val))
                        (:slant          (hfy-slant     val))
-                       (:foreground     (hfy-color     val))
+                       (:foreground     (hfy-colour    val))
                        (:background     (hfy-bgcol     val))
                        (:box            (hfy-box       val))
                        (:height         (hfy-size      val))
@@ -1830,11 +1828,10 @@ fontified.  This is a simple convenience wrapper around
    (noninteractive
     (message "hfy batch mode (%s:%S)"
              (or (buffer-file-name) (buffer-name)) major-mode)
-    (if (fboundp 'font-lock-ensure)     ; Emacs >= 25.1
+    (if (fboundp 'font-lock-ensure)
         (font-lock-ensure)
       (when font-lock-defaults
-        ; Silence "interactive use only" warning on Emacs >= 25.1.
-        (with-no-warnings (font-lock-fontify-buffer)))))
+        (font-lock-fontify-buffer))))
    ((fboundp #'jit-lock-fontify-now)
     (message "hfy jit-lock mode (%S %S)" window-system major-mode)
     (jit-lock-fontify-now))
diff --git a/lisp/ibuffer.el b/lisp/ibuffer.el
index 0fd2971934..38fffcb976 100644
--- a/lisp/ibuffer.el
+++ b/lisp/ibuffer.el
@@ -224,6 +224,14 @@ view of the buffers."
   :group 'ibuffer)
 (defvar ibuffer-sorting-reversep nil)
 
+(defcustom ibuffer-elide-long-columns nil
+  "If non-nil, then elide column entries which exceed their max length."
+  :type 'boolean
+  :group 'ibuffer)
+(make-obsolete-variable 'ibuffer-elide-long-columns
+                        "use the :elide argument of `ibuffer-formats'."
+                        "22.1")
+
 (defcustom ibuffer-eliding-string "..."
   "The string to use for eliding long columns."
   :type 'string
@@ -341,11 +349,15 @@ directory, like `default-directory'."
   :type 'regexp
   :group 'ibuffer)
 
+(define-obsolete-variable-alias 'ibuffer-hooks 'ibuffer-hook "22.1")
+
 (defcustom ibuffer-hook nil
   "Hook run when `ibuffer' is called."
   :type 'hook
   :group 'ibuffer)
 
+(define-obsolete-variable-alias 'ibuffer-mode-hooks 'ibuffer-mode-hook "22.1")
+
 (defcustom ibuffer-mode-hook nil
   "Hook run upon entry into `ibuffer-mode'."
   :type 'hook
@@ -940,6 +952,7 @@ directory, like `default-directory'."
 (defvar ibuffer-compiled-formats nil)
 (defvar ibuffer-cached-formats nil)
 (defvar ibuffer-cached-eliding-string nil)
+(defvar ibuffer-cached-elide-long-columns 0)
 
 (defvar ibuffer-sorting-functions-alist nil
   "An alist of functions which describe how to sort buffers.
@@ -1576,7 +1589,7 @@ If point is on a group name, this function operates on that group."
 
 (defun ibuffer-compile-make-eliding-form (strvar elide from-end-p)
   (let ((ellipsis (propertize ibuffer-eliding-string 'font-lock-face 'bold)))
-    (if elide
+    (if (or elide (with-no-warnings ibuffer-elide-long-columns))
 	`(if (> strlen 5)
 	     ,(if from-end-p
                   ;; FIXME: this should probably also be using
@@ -1776,6 +1789,9 @@ If point is on a group name, this function operates on that group."
 	      (not (eq ibuffer-cached-formats ibuffer-formats))
 	      (null ibuffer-cached-eliding-string)
 	      (not (equal ibuffer-cached-eliding-string ibuffer-eliding-string))
+	      (eql 0 ibuffer-cached-elide-long-columns)
+	      (not (eql ibuffer-cached-elide-long-columns
+			(with-no-warnings ibuffer-elide-long-columns)))
 	      (and ext-loaded
 		   (not (eq ibuffer-cached-filter-formats
 			    ibuffer-filter-format-alist))
@@ -1784,7 +1800,8 @@ If point is on a group name, this function operates on that group."
       (message "Formats have changed, recompiling...")
       (ibuffer-recompile-formats)
       (setq ibuffer-cached-formats ibuffer-formats
-	    ibuffer-cached-eliding-string ibuffer-eliding-string)
+	    ibuffer-cached-eliding-string ibuffer-eliding-string
+	    ibuffer-cached-elide-long-columns (with-no-warnings ibuffer-elide-long-columns))
       (when ext-loaded
 	(setq ibuffer-cached-filter-formats ibuffer-filter-format-alist))
       (message "Formats have changed, recompiling...done"))))
@@ -2729,6 +2746,7 @@ will be inserted before the group at point."
   (set (make-local-variable 'ibuffer-compiled-formats) nil)
   (set (make-local-variable 'ibuffer-cached-formats) nil)
   (set (make-local-variable 'ibuffer-cached-eliding-string) nil)
+  (set (make-local-variable 'ibuffer-cached-elide-long-columns) nil)
   (set (make-local-variable 'ibuffer-current-format) nil)
   (set (make-local-variable 'ibuffer-did-modification) nil)
   (set (make-local-variable 'ibuffer-tmp-hide-regexps) nil)
diff --git a/lisp/ido.el b/lisp/ido.el
index 7ff3d6820b..da0c9d463d 100644
--- a/lisp/ido.el
+++ b/lisp/ido.el
@@ -1135,9 +1135,6 @@ selected.")
 (defvar ido-current-directory nil
   "Current directory for `ido-find-file'.")
 
-(defvar ido-predicate nil
-  "Current completion predicate.")
-
 (defvar ido-auto-merge-timer nil
   "Delay timer for auto merge.")
 
@@ -3483,11 +3480,6 @@ it is put to the start of the list."
     (if ido-temp-list
 	(nconc ido-temp-list ido-current-buffers)
       (setq ido-temp-list ido-current-buffers))
-    (if ido-predicate
-        (setq ido-temp-list (seq-filter
-                             (lambda (name)
-                               (funcall ido-predicate (cons name (get-buffer name))))
-                             ido-temp-list)))
     (if default
 	(setq ido-temp-list
 	      (cons default (delete default ido-temp-list))))
@@ -4853,13 +4845,10 @@ Modified from `icomplete-completions'."
 Return the name of a buffer selected.
 PROMPT is the prompt to give to the user.  DEFAULT if given is the default
 buffer to be selected, which will go to the front of the list.
-If REQUIRE-MATCH is non-nil, an existing buffer must be selected.
-Optional arg PREDICATE if non-nil is a function limiting the
-buffers that can be considered."
+If REQUIRE-MATCH is non-nil, an existing buffer must be selected."
   (let* ((ido-current-directory nil)
 	 (ido-directory-nonreadable nil)
 	 (ido-directory-too-big nil)
-         (ido-predicate predicate)
 	 (ido-context-switch-command 'ignore)
 	 (buf (ido-read-internal 'buffer prompt 'ido-buffer-history default require-match)))
     (if (eq ido-exit 'fallback)
diff --git a/lisp/image.el b/lisp/image.el
index ab868f7db3..b69bf93054 100644
--- a/lisp/image.el
+++ b/lisp/image.el
@@ -971,8 +971,7 @@ default is 20%."
                         0.8)))
 
 (defun image--get-image ()
-  "Return the image at point."
-  (let ((image (get-char-property (point) 'display)))
+  (let ((image (get-text-property (point) 'display)))
     (unless (eq (car-safe image) 'image)
       (error "No image under point"))
     image))
@@ -1027,7 +1026,10 @@ default is 20%."
 (defun image-save ()
   "Save the image under point."
   (interactive)
-  (let ((image (image--get-image)))
+  (let ((image (get-text-property (point) 'display)))
+    (when (or (not (consp image))
+              (not (eq (car image) 'image)))
+      (error "No image under point"))
     (with-temp-buffer
       (let ((file (plist-get (cdr image) :file)))
         (if file
diff --git a/lisp/imenu.el b/lisp/imenu.el
index b4d7d90359..f56e7b5039 100644
--- a/lisp/imenu.el
+++ b/lisp/imenu.el
@@ -102,7 +102,14 @@ This variable is buffer-local."
   :type 'integer
   :group 'imenu)
 
-(defcustom imenu-use-popup-menu 'on-mouse
+(defvar imenu-always-use-completion-buffer-p nil)
+(make-obsolete-variable 'imenu-always-use-completion-buffer-p
+			'imenu-use-popup-menu "22.1")
+
+(defcustom imenu-use-popup-menu
+  (if imenu-always-use-completion-buffer-p
+      (not (eq imenu-always-use-completion-buffer-p 'never))
+    'on-mouse)
   "Use a popup menu rather than a minibuffer prompt.
 If nil, always use a minibuffer prompt.
 If t, always use a popup menu,
@@ -112,7 +119,8 @@ If `on-mouse' use a popup menu when `imenu' was invoked with the mouse."
 		 (other :tag "Always" t))
   :group 'imenu)
 
-(defcustom imenu-eager-completion-buffer t
+(defcustom imenu-eager-completion-buffer
+  (not (eq imenu-always-use-completion-buffer-p 'never))
   "If non-nil, eagerly popup the completion buffer."
   :type 'boolean
   :group 'imenu
diff --git a/lisp/international/latin1-disp.el b/lisp/international/latin1-disp.el
index df2c1dc9a8..657f79097c 100644
--- a/lisp/international/latin1-disp.el
+++ b/lisp/international/latin1-disp.el
@@ -201,6 +201,10 @@ character set: `latin-2', `hebrew' etc."
 	 (char (and info (decode-char (car (remq 'ascii info)) ?\ ))))
     (and char (char-displayable-p char))))
 
+;; Backwards compatibility.
+(define-obsolete-function-alias 'latin1-char-displayable-p
+  'char-displayable-p "22.1")
+
 (defun latin1-display-setup (set &optional force)
   "Set up Latin-1 display for characters in the given SET.
 SET must be a member of `latin1-display-sets'.  Normally, check
diff --git a/lisp/isearch.el b/lisp/isearch.el
index 84b121af9e..a41adf0c2c 100644
--- a/lisp/isearch.el
+++ b/lisp/isearch.el
@@ -67,26 +67,8 @@
 
 
 (defcustom search-exit-option t
-  "Defines what control characters do in incremental search.
-If t, random control and meta characters terminate the search
-and are then executed normally.
-If `edit', edit the search string instead of exiting.
-If `move', extend the search string by motion commands
-that have the `isearch-move' property on their symbols.
-If `shift-move', extend the search string by motion commands
-while holding down the shift key.
-Both `move' and `shift-move' extend the search string by yanking text
-that ends at the new position after moving point in the current buffer.
-If `append', the characters which you type that are not interpreted by
-the incremental search are simply appended to the search string.
-If nil, run the command without exiting Isearch."
-  :type '(choice (const :tag "Terminate incremental search" t)
-                 (const :tag "Edit the search string" edit)
-                 (const :tag "Extend the search string by motion commands" move)
-                 (const :tag "Extend the search string by shifted motion keys" shift-move)
-                 (const :tag "Append control characters to the search string" append)
-                 (const :tag "Don't terminate incremental search" nil))
-  :version "27.1")
+  "Non-nil means random control characters terminate incremental search."
+  :type 'boolean)
 
 (defcustom search-slow-window-lines 1
   "Number of lines in slow search display windows.
@@ -323,6 +305,10 @@ this variable is set to the symbol `all-windows'."
   :group 'isearch
   :group 'matching)
 
+(define-obsolete-variable-alias 'isearch-lazy-highlight-cleanup
+                                'lazy-highlight-cleanup
+                                "22.1")
+
 (defcustom lazy-highlight-cleanup t
   "Controls whether to remove extra highlighting after a search.
 If this is nil, extra highlighting can be \"manually\" removed with
@@ -330,16 +316,28 @@ If this is nil, extra highlighting can be \"manually\" removed with
   :type 'boolean
   :group 'lazy-highlight)
 
+(define-obsolete-variable-alias 'isearch-lazy-highlight-initial-delay
+                                'lazy-highlight-initial-delay
+                                "22.1")
+
 (defcustom lazy-highlight-initial-delay 0.25
   "Seconds to wait before beginning to lazily highlight all matches."
   :type 'number
   :group 'lazy-highlight)
 
+(define-obsolete-variable-alias 'isearch-lazy-highlight-interval
+                                'lazy-highlight-interval
+                                "22.1")
+
 (defcustom lazy-highlight-interval 0 ; 0.0625
   "Seconds between lazily highlighting successive matches."
   :type 'number
   :group 'lazy-highlight)
 
+(define-obsolete-variable-alias 'isearch-lazy-highlight-max-at-a-time
+                                'lazy-highlight-max-at-a-time
+                                "22.1")
+
 (defcustom lazy-highlight-max-at-a-time nil ; 20 (bug#25751)
   "Maximum matches to highlight at a time (for `lazy-highlight').
 Larger values may reduce Isearch's responsiveness to user input;
@@ -2393,7 +2391,6 @@ the bottom."
   (goto-char isearch-point))
 
 (defvar isearch-pre-scroll-point nil)
-(defvar isearch-pre-move-point nil)
 
 (defun isearch-pre-command-hook ()
   "Decide whether to exit Isearch mode before executing the command.
@@ -2401,9 +2398,8 @@ Don't exit Isearch if the key sequence that invoked this command
 is bound in `isearch-mode-map', or if the invoked command is
 a prefix argument command (when `isearch-allow-prefix' is non-nil),
 or it is a scrolling command (when `isearch-allow-scroll' is non-nil).
-Otherwise, exit Isearch (when `search-exit-option' is t)
-before the command is executed globally with terminated Isearch.
-See more for options in `search-exit-option'."
+Otherwise, exit Isearch (when `search-exit-option' is non-nil)
+before the command is executed globally with terminated Isearch."
   (let* ((key (this-single-command-keys))
 	 (main-event (aref key 0)))
     (cond
@@ -2431,47 +2427,22 @@ See more for options in `search-exit-option'."
       ;; Swallow the up-event.
       (read-event)
       (setq this-command 'isearch-edit-string))
-     ;; Don't terminate the search for motion commands.
-     ((or (and (eq search-exit-option 'move)
-               (symbolp this-command)
-               (eq (get this-command 'isearch-move) t))
-          (and (eq search-exit-option 'shift-move)
-               this-command-keys-shift-translated))
-      (setq this-command-keys-shift-translated nil)
-      (setq isearch-pre-move-point (point)))
-     ;; Append control characters to the search string
-     ((eq search-exit-option 'append)
-      (when (cl-every #'characterp key)
-        (isearch-process-search-string key key))
-      (setq this-command 'ignore))
      ;; Other characters terminate the search and are then executed normally.
      (search-exit-option
       (isearch-done)
-      (isearch-clean-overlays)))))
+      (isearch-clean-overlays))
+     ;; If search-exit-option is nil, run the command without exiting Isearch.
+     (t
+      (isearch-process-search-string key key)))))
 
 (defun isearch-post-command-hook ()
-  (cond
-   (isearch-pre-scroll-point
+  (when isearch-pre-scroll-point
     (let ((ab-bel (isearch-string-out-of-window isearch-pre-scroll-point)))
       (if ab-bel
 	  (isearch-back-into-window (eq ab-bel 'above) isearch-pre-scroll-point)
 	(goto-char isearch-pre-scroll-point)))
     (setq isearch-pre-scroll-point nil)
-    (isearch-update))
-   ((memq search-exit-option '(move shift-move))
-    (when (and isearch-pre-move-point
-               (not (eq isearch-pre-move-point (point))))
-      (let ((string (buffer-substring-no-properties
-                     (or isearch-other-end isearch-opoint) (point))))
-        (if isearch-regexp (setq string (regexp-quote string)))
-        (setq isearch-string string)
-        (setq isearch-message (mapconcat 'isearch-text-char-description
-                                         string ""))
-        (setq isearch-yank-flag t)
-        (setq isearch-forward (<= (or isearch-other-end isearch-opoint) (point)))
-        (goto-char isearch-pre-move-point)
-        (isearch-search-and-update)))
-    (setq isearch-pre-move-point nil))))
+    (isearch-update)))
 
 (defun isearch-quote-char (&optional count)
   "Quote special characters for incremental search.
@@ -3186,6 +3157,10 @@ This function is called when exiting an incremental search if
     (cancel-timer isearch-lazy-highlight-timer)
     (setq isearch-lazy-highlight-timer nil)))
 
+(define-obsolete-function-alias 'isearch-lazy-highlight-cleanup
+                                'lazy-highlight-cleanup
+                                "22.1")
+
 (defun isearch-lazy-highlight-new-loop (&optional beg end)
   "Cleanup any previous `lazy-highlight' loop and begin a new one.
 BEG and END specify the bounds within which highlighting should occur.
diff --git a/lisp/ldefs-boot.el b/lisp/ldefs-boot.el
index 650122e1c5..9dfdab43dc 100644
--- a/lisp/ldefs-boot.el
+++ b/lisp/ldefs-boot.el
@@ -1969,8 +1969,7 @@ result.  The overhead of the `lambda's is accounted for.
 
 (autoload 'benchmark "benchmark" "\
 Print the time taken for REPETITIONS executions of FORM.
-Interactively, REPETITIONS is taken from the prefix arg, and
-the command prompts for the form to benchmark.
+Interactively, REPETITIONS is taken from the prefix arg.
 For non-interactive use see also `benchmark-run' and
 `benchmark-run-compiled'.
 
@@ -2928,7 +2927,6 @@ Like `bug-reference-mode', but only buttonize in comments and strings.
 (put 'byte-compile-dynamic 'safe-local-variable 'booleanp)
 (put 'byte-compile-disable-print-circle 'safe-local-variable 'booleanp)
 (put 'byte-compile-dynamic-docstrings 'safe-local-variable 'booleanp)
-(put 'byte-compile-error-on-warn 'safe-local-variable 'booleanp)
 
 (put 'byte-compile-warnings 'safe-local-variable (lambda (v) (or (symbolp v) (null (delq nil (mapcar (lambda (x) (not (symbolp x))) v))))))
 
@@ -6194,7 +6192,7 @@ For example, the MH-E package updates this alist as follows:
 
 The value of PACKAGE needs to be unique and it needs to match the
 PACKAGE value appearing in the :package-version keyword.  Since
-the user might see the value in an error message, a good choice is
+the user might see the value in a error message, a good choice is
 the official name of the package, such as MH-E or Gnus.")
 
 (defalias 'customize-changed 'customize-changed-options)
@@ -9815,11 +9813,8 @@ the mode if ARG is omitted or nil.
 
 Electric Pair mode is a global minor mode.  When enabled, typing
 an open parenthesis automatically inserts the corresponding
-closing parenthesis, and vice versa.  (Likewise for brackets, etc.).
-If the region is active, the parentheses (brackets, etc.) are
-inserted around the region instead.
-
-To toggle the mode in a single buffer, use `electric-pair-local-mode'.
+closing parenthesis.  (Likewise for brackets, etc.). To toggle
+the mode in a single buffer, use `electric-pair-local-mode'.
 
 \(fn &optional ARG)" t nil)
 
@@ -9898,8 +9893,7 @@ FUNSYM must be a symbol of a defined function.
 (autoload 'elp-instrument-list "elp" "\
 Instrument, for profiling, all functions in `elp-function-list'.
 Use optional LIST if provided instead.
-If called interactively, prompt for LIST in the minibuffer;
-type \"nil\" to use `elp-function-list'.
+If called interactively, read LIST using the minibuffer.
 
 \(fn &optional LIST)" t nil)
 
@@ -15149,7 +15143,7 @@ file name to `*.gz', and sets `grep-highlight-matches' to `always'.
 
 (defalias 'rzgrep 'zrgrep)
 
-(if (fboundp 'register-definition-prefixes) (register-definition-prefixes "grep" '("grep-" "rgrep-" "kill-grep")))
+(if (fboundp 'register-definition-prefixes) (register-definition-prefixes "grep" '("rgrep-" "grep-" "kill-grep")))
 
 ;;;***
 
@@ -16531,7 +16525,7 @@ See the documentation for `calendar-holidays' for details.")
 (autoload 'holidays "holidays" "\
 Display the holidays for last month, this month, and next month.
 If called with an optional prefix argument ARG, prompts for month and year.
-This function is suitable for execution in an init file.
+This function is suitable for execution in a init file.
 
 \(fn &optional ARG)" t nil)
 
@@ -16802,7 +16796,7 @@ Extract iCalendar events from current buffer.
 
 This function searches the current buffer for the first iCalendar
 object, reads it and adds all VEVENT elements to the diary
-DIARY-FILENAME.
+DIARY-FILE.
 
 It will ask for each appointment whether to add it to the diary
 unless DO-NOT-ASK is non-nil.  When called interactively,
@@ -16815,7 +16809,7 @@ Return code t means that importing worked well, return code nil
 means that an error has occurred.  Error messages will be in the
 buffer `*icalendar-errors*'.
 
-\(fn &optional DIARY-FILENAME DO-NOT-ASK NON-MARKING)" t nil)
+\(fn &optional DIARY-FILE DO-NOT-ASK NON-MARKING)" t nil)
 
 (if (fboundp 'register-definition-prefixes) (register-definition-prefixes "icalendar" '("icalendar-")))
 
@@ -17341,8 +17335,6 @@ Return the name of a buffer selected.
 PROMPT is the prompt to give to the user.  DEFAULT if given is the default
 buffer to be selected, which will go to the front of the list.
 If REQUIRE-MATCH is non-nil, an existing buffer must be selected.
-Optional arg PREDICATE if non-nil is a function limiting the
-buffers that can be considered.
 
 \(fn PROMPT &optional DEFAULT REQUIRE-MATCH PREDICATE)" nil nil)
 
@@ -17921,8 +17913,8 @@ If non-nil this pattern is passed to `imenu--generic-function' to
 create a buffer index.
 
 For example, see the value of `fortran-imenu-generic-expression'
-used by `fortran-mode' with `imenu-syntax-alist' set locally so that
-characters which normally have \"symbol\" syntax are considered to have
+used by `fortran-mode' with `imenu-syntax-alist' set locally to
+give the characters which normally have \"symbol\" syntax
 \"word\" syntax during matching.")
 (put 'imenu-generic-expression 'risky-local-variable t)
 
@@ -22020,7 +22012,7 @@ QUALITY can be:
 ;;;### (autoloads nil "mwheel" "mwheel.el" (0 0 0 0))
 ;;; Generated autoloads from mwheel.el
 
-(if (fboundp 'register-definition-prefixes) (register-definition-prefixes "mwheel" '("mouse-wheel-" "mwheel-")))
+(if (fboundp 'register-definition-prefixes) (register-definition-prefixes "mwheel" '("mwheel-" "mouse-wheel-")))
 
 ;;;***
 
@@ -23254,7 +23246,6 @@ Coloring:
 
 ;;;### (autoloads nil "org" "org/org.el" (0 0 0 0))
 ;;; Generated autoloads from org/org.el
-(push (purecopy '(org 9 1 6)) package--builtin-versions)
 
 (autoload 'org-babel-do-load-languages "org" "\
 Load the languages defined in `org-babel-load-languages'.
@@ -24417,6 +24408,8 @@ activate the package system at any time.")
 Load Emacs Lisp packages, and activate them.
 The variable `package-load-list' controls which packages to load.
 If optional arg NO-ACTIVATE is non-nil, don't activate packages.
+If `user-init-file' does not mention `(package-initialize)', add
+it to the file.
 If called as part of loading `user-init-file', set
 `package-enable-at-startup' to nil, to prevent accidentally
 loading packages twice.
@@ -26428,7 +26421,7 @@ Optional argument FACE specifies the face to do the highlighting.
 
 ;;;### (autoloads nil "python" "progmodes/python.el" (0 0 0 0))
 ;;; Generated autoloads from progmodes/python.el
-(push (purecopy '(python 0 26 1)) package--builtin-versions)
+(push (purecopy '(python 0 25 2)) package--builtin-versions)
 
 (add-to-list 'auto-mode-alist (cons (purecopy "\\.py[iw]?\\'") 'python-mode))
 
@@ -29850,6 +29843,13 @@ Like `mail' command, but display mail buffer in another frame.
 
 (put 'server-auth-dir 'risky-local-variable t)
 
+(defvar server-name "server" "\
+The name of the Emacs server, if this Emacs process creates one.
+The command `server-start' makes use of this.  It should not be
+changed while a server is running.")
+
+(custom-autoload 'server-name "server" t)
+
 (autoload 'server-start "server" "\
 Allow this Emacs process to be a server for client processes.
 This starts a server communications subprocess through which client
@@ -31725,7 +31725,7 @@ Args are NAME BUFFER HOST PORT.
 NAME is name for process.  It is modified if necessary to make it unique.
 BUFFER is the buffer (or `buffer-name') to associate with the process.
  Process output goes at end of that buffer, unless you specify
- a filter function to handle the output.
+ an output stream or filter function to handle the output.
  BUFFER may be also nil, meaning that this process is not associated
  with any buffer
 Third arg is name of the host to connect to, or its IP address.
@@ -34063,7 +34063,7 @@ Todo mode revisit this file or, with option
 file was last visited.
 
 If you call this command before you have created any todo file in
-the current format, and you have a todo file in old format, it
+the current format, and you have an todo file in old format, it
 will ask you whether to convert that file and show it.
 Otherwise, calling this command before any todo file exists
 prompts for a file name and an initial category (defaulting to
@@ -34313,27 +34313,6 @@ Discard Tramp from loading remote files.
 ;;;;;;  0 0))
 ;;; Generated autoloads from net/tramp-archive.el
 
-(defvar tramp-archive-enabled (featurep 'dbusbind) "\
-Non-nil when file archive support is available.")
-
-(defconst tramp-archive-suffixes '("7z" "apk" "ar" "cab" "CAB" "cpio" "deb" "depot" "exe" "iso" "jar" "lzh" "LZH" "msu" "MSU" "mtree" "pax" "rar" "rpm" "shar" "tar" "tbz" "tgz" "tlz" "txz" "warc" "xar" "xpi" "xps" "zip" "ZIP") "\
-List of suffixes which indicate a file archive.
-It must be supported by libarchive(3).")
-
-(defconst tramp-archive-compression-suffixes '("bz2" "gz" "lrz" "lz" "lz4" "lzma" "lzo" "uu" "xz" "Z") "\
-List of suffixes which indicate a compressed file.
-It must be supported by libarchive(3).")
-
-(defmacro tramp-archive-autoload-file-name-regexp nil "\
-Regular expression matching archive file names." `(concat "\\`" "\\(" ".+" "\\." (regexp-opt tramp-archive-suffixes) "\\(?:" "\\." (regexp-opt tramp-archive-compression-suffixes) "\\)*" "\\)" "\\(" "/" ".*" "\\)" "\\'"))
-
-(defun tramp-register-archive-file-name-handler nil "\
-Add archive file name handler to `file-name-handler-alist'." (when tramp-archive-enabled (add-to-list 'file-name-handler-alist (cons (tramp-archive-autoload-file-name-regexp) 'tramp-autoload-file-name-handler)) (put 'tramp-archive-file-name-handler 'safe-magic t)))
-
-(add-hook 'after-init-hook 'tramp-register-archive-file-name-handler)
-
-(add-hook 'tramp-archive-unload-hook (lambda nil (remove-hook 'after-init-hook 'tramp-register-archive-file-name-handler)))
-
 (if (fboundp 'register-definition-prefixes) (register-definition-prefixes "tramp-archive" '("tramp-" "with-parsed-tramp-archive-file-name")))
 
 ;;;***
@@ -35888,10 +35867,7 @@ When called interactively with a prefix argument, prompt for REMOTE-LOCATION.
 \(fn &optional REMOTE-LOCATION)" t nil)
 
 (autoload 'vc-region-history "vc" "\
-Show the history of the region between FROM and TO.
-
-If called interactively, show the history between point and
-mark.
+Show the history of the region FROM..TO.
 
 \(fn FROM TO)" t nil)
 
diff --git a/lisp/loadhist.el b/lisp/loadhist.el
index b8d9e2de0d..e2b2ccd510 100644
--- a/lisp/loadhist.el
+++ b/lisp/loadhist.el
@@ -141,6 +141,8 @@ These are symbols with hooklike values whose names don't end in
 `-hook' or `-hooks', from which `unload-feature' should try to remove
 pertinent symbols.")
 
+(define-obsolete-variable-alias 'unload-hook-features-list
+    'unload-function-defs-list "22.2")
 (defvar unload-function-defs-list nil
   "List of definitions in the Lisp library being unloaded.
 
diff --git a/lisp/mail/rmail.el b/lisp/mail/rmail.el
index f2fdcb6367..4e5873c06e 100644
--- a/lisp/mail/rmail.el
+++ b/lisp/mail/rmail.el
@@ -191,6 +191,9 @@ Its name should end with a slash."
   :group 'rmail-retrieve
   :type '(choice (const nil) string))
 
+(define-obsolete-variable-alias 'rmail-pop-password
+  'rmail-remote-password "22.1")
+
 (defcustom rmail-remote-password nil
   "Password to use when reading mail from a remote server.
 This setting is ignored for mailboxes whose URL already contains a password."
@@ -199,6 +202,9 @@ This setting is ignored for mailboxes whose URL already contains a password."
   :group 'rmail-retrieve
   :version "22.1")
 
+(define-obsolete-variable-alias 'rmail-pop-password-required
+  'rmail-remote-password-required "22.1")
+
 (defcustom rmail-remote-password-required nil
   "Non-nil if a password is required when reading mail from a remote server."
   :type 'boolean
diff --git a/lisp/mh-e/mh-acros.el b/lisp/mh-e/mh-acros.el
index fb8a16bd81..ac31127ce6 100644
--- a/lisp/mh-e/mh-acros.el
+++ b/lisp/mh-e/mh-acros.el
@@ -90,10 +90,9 @@ loads \"cl\" appropriately."
   "Create function NAME.
 If FUNCTION exists, then NAME becomes an alias for FUNCTION.
 Otherwise, create function NAME with ARG-LIST and BODY."
-  `(defalias ',name
-     (if (fboundp ',function)
-         ',function
-       (lambda ,arg-list ,@body))))
+  `(if (fboundp ',function)
+       (defalias ',name ',function)
+     (defun ,name ,arg-list ,@body)))
 (put 'defun-mh 'lisp-indent-function 'defun)
 (put 'defun-mh 'doc-string-elt 4)
 
diff --git a/lisp/mh-e/mh-comp.el b/lisp/mh-e/mh-comp.el
index 941529330e..a9f809cfa1 100644
--- a/lisp/mh-e/mh-comp.el
+++ b/lisp/mh-e/mh-comp.el
@@ -305,19 +305,17 @@ message and scan line."
         (file-name buffer-file-name)
         (config mh-previous-window-config)
         (coding-system-for-write
-         (if (fboundp 'select-message-coding-system)
-             (select-message-coding-system) ; Emacs has this since at least 21.1
-           (if (and (local-variable-p 'buffer-file-coding-system
-                                      (current-buffer)) ;XEmacs needs two args
-                    ;; We're not sure why, but buffer-file-coding-system
-                    ;; tends to get set to undecided-unix.
-                    (not (memq buffer-file-coding-system
-                               '(undecided undecided-unix undecided-dos))))
-               buffer-file-coding-system
-             (or (and (boundp 'sendmail-coding-system) sendmail-coding-system)
-                 (and (default-boundp 'buffer-file-coding-system)
-                      (default-value 'buffer-file-coding-system))
-                 'iso-latin-1)))))
+         (if (and (local-variable-p 'buffer-file-coding-system
+                                    (current-buffer)) ;XEmacs needs two args
+                  ;; We're not sure why, but buffer-file-coding-system
+                  ;; tends to get set to undecided-unix.
+                  (not (memq buffer-file-coding-system
+                             '(undecided undecided-unix undecided-dos))))
+             buffer-file-coding-system
+           (or (and (boundp 'sendmail-coding-system) sendmail-coding-system)
+               (and (default-boundp 'buffer-file-coding-system)
+                    (default-value 'buffer-file-coding-system))
+               'iso-latin-1))))
     ;; Older versions of spost do not support -msgid and -mime.
     (unless mh-send-uses-spost-flag
       ;; Adding a Message-ID field looks good, makes it easier to search for
@@ -1056,7 +1054,6 @@ letter."
 (defun mh-insert-x-mailer ()
   "Append an X-Mailer field to the header.
 The versions of MH-E, Emacs, and MH are shown."
-  (or mh-variant-in-use (mh-variant-set mh-variant))
   ;; Lazily initialize mh-x-mailer-string.
   (when (and mh-insert-x-mailer-flag (null mh-x-mailer-string))
     (setq mh-x-mailer-string
diff --git a/lisp/mh-e/mh-compat.el b/lisp/mh-e/mh-compat.el
index ffeb6937f7..2307812736 100644
--- a/lisp/mh-e/mh-compat.el
+++ b/lisp/mh-e/mh-compat.el
@@ -65,8 +65,7 @@ Simulate NOERROR argument in XEmacs which lacks it."
 Case is ignored if CASE-FOLD is non-nil.
 This function is used by Emacs versions that lack `assoc-string',
 introduced in Emacs 22."
-  ;; Test for fboundp is solely to silence compiler for Emacs >= 22.1.
-  (if (and case-fold (fboundp 'assoc-ignore-case))
+  (if case-fold
       (assoc-ignore-case key list)
     (assoc key list)))
 
@@ -308,8 +307,7 @@ This function is used by XEmacs that lacks `replace-regexp-in-string'.
 The function `replace-in-string' is used instead.
 The arguments FIXEDCASE, SUBEXP, and START, used by
 `replace-in-string' are ignored."
-  (if (featurep 'xemacs)                ; silence Emacs compiler
-      (replace-in-string string regexp rep literal)))
+  (replace-in-string string regexp rep literal))
 
 (defun-mh mh-test-completion
   test-completion (string collection &optional predicate)
diff --git a/lisp/mh-e/mh-e.el b/lisp/mh-e/mh-e.el
index 4515144d14..05ff672da5 100644
--- a/lisp/mh-e/mh-e.el
+++ b/lisp/mh-e/mh-e.el
@@ -410,8 +410,6 @@ gnus-version)
   (require 'gnus)
   gnus-version)
 
-(defvar mh-variant)
-
 ;;;###autoload
 (defun mh-version ()
   "Display version information about MH-E and the MH mail handling system."
@@ -432,7 +430,6 @@ gnus-version)
   ;; Emacs version.
   (insert (emacs-version) "\n\n")
   ;; MH version.
-  (or mh-variant-in-use (mh-variant-set mh-variant))
   (if mh-variant-in-use
       (insert mh-variant-in-use "\n"
               " mh-progs:\t" mh-progs "\n"
@@ -879,7 +876,6 @@ variant."
 (defun mh-variant-p (&rest variants)
   "Return t if variant is any of VARIANTS.
 Currently known variants are `MH', `nmh', and `gnu-mh'."
-  (or mh-variant-in-use (mh-variant-set mh-variant))
   (let ((variant-in-use
          (cadr (assoc 'variant (assoc mh-variant-in-use (mh-variants))))))
     (not (null (member variant-in-use variants)))))
@@ -945,8 +941,6 @@ finally GNU mailutils MH."
       (when (not (mh-variant-set-variant variant))
         (message "Warning: %s variant not found. Autodetecting..." variant)
         (mh-variant-set 'autodetect)))
-     ((null valid-list)
-      (message "Unknown variant %s; can't find MH anywhere" variant))
      (t
       (message "Unknown variant %s; use %s"
                variant
@@ -978,7 +972,6 @@ necessary and can actually cause problems."
   :set (lambda (symbol value)
          (set-default symbol value)     ;Done in mh-variant-set-variant!
          (mh-variant-set value))
-  :initialize 'custom-initialize-default
   :group 'mh-e
   :package-version '(MH-E . "8.0"))
 
diff --git a/lisp/mh-e/mh-folder.el b/lisp/mh-e/mh-folder.el
index 82e28e8741..23cc2baab7 100644
--- a/lisp/mh-e/mh-folder.el
+++ b/lisp/mh-e/mh-folder.el
@@ -88,7 +88,7 @@ the MH mail system."
 When desktop creates a buffer, DESKTOP-BUFFER-FILE-NAME holds the
 file name to visit, DESKTOP-BUFFER-NAME holds the desired buffer
 name, and DESKTOP-BUFFER-MISC holds a list of miscellaneous info
-used by the `desktop-buffer-mode-handlers' functions."
+used by the `desktop-buffer-handlers' functions."
   (mh-find-path)
   (mh-visit-folder desktop-buffer-name)
   (current-buffer))
diff --git a/lisp/mh-e/mh-thread.el b/lisp/mh-e/mh-thread.el
index ff8e6602e5..41a79b6f0b 100644
--- a/lisp/mh-e/mh-thread.el
+++ b/lisp/mh-e/mh-thread.el
@@ -647,17 +647,20 @@ Only information about messages in MSG-LIST are added to the tree."
 
 (defun mh-thread-set-tables (folder)
   "Use the tables of FOLDER in current buffer."
-  (dolist (v '(mh-thread-id-hash
-               mh-thread-subject-hash
-               mh-thread-id-table
-               mh-thread-id-index-map
-               mh-thread-index-id-map
-               mh-thread-scan-line-map
-               mh-thread-subject-container-hash
-               mh-thread-duplicates
-               mh-thread-history))
-    ;; Emacs >= 22.1: (buffer-local-value v folder).
-    (set v (with-current-buffer folder (symbol-value v)))))
+  (mh-flet
+   ((mh-get-table (symbol)
+                  (with-current-buffer folder
+                    (symbol-value symbol))))
+   (setq mh-thread-id-hash (mh-get-table 'mh-thread-id-hash))
+   (setq mh-thread-subject-hash (mh-get-table 'mh-thread-subject-hash))
+   (setq mh-thread-id-table (mh-get-table 'mh-thread-id-table))
+   (setq mh-thread-id-index-map (mh-get-table 'mh-thread-id-index-map))
+   (setq mh-thread-index-id-map (mh-get-table 'mh-thread-index-id-map))
+   (setq mh-thread-scan-line-map (mh-get-table 'mh-thread-scan-line-map))
+   (setq mh-thread-subject-container-hash
+         (mh-get-table 'mh-thread-subject-container-hash))
+   (setq mh-thread-duplicates (mh-get-table 'mh-thread-duplicates))
+   (setq mh-thread-history (mh-get-table 'mh-thread-history))))
 
 (defun mh-thread-process-in-reply-to (reply-to-header)
   "Extract message id's from REPLY-TO-HEADER.
diff --git a/lisp/mh-e/mh-utils.el b/lisp/mh-e/mh-utils.el
index 7bda0a6847..66d87262bc 100644
--- a/lisp/mh-e/mh-utils.el
+++ b/lisp/mh-e/mh-utils.el
@@ -177,7 +177,6 @@ been set. This hook can be used the change the value of these
 variables if you need to run with different values between MH and
 MH-E."
   (unless mh-find-path-run
-    (or mh-variant-in-use (mh-variant-set mh-variant))
     ;; Sanity checks.
     (if (and (getenv "MH")
              (not (file-readable-p (getenv "MH"))))
diff --git a/lisp/minibuffer.el b/lisp/minibuffer.el
index 3227917494..e3ae2912a8 100644
--- a/lisp/minibuffer.el
+++ b/lisp/minibuffer.el
@@ -987,8 +987,7 @@ Moves point to the end of the new text."
 (defcustom completion-cycle-threshold nil
   "Number of completion candidates below which cycling is used.
 Depending on this setting `completion-in-region' may use cycling,
-whereby invoking a completion command several times in a row
-completes to each of the candidates in turn, in a cyclic manner.
+like `minibuffer-force-complete'.
 If nil, cycling is never used.
 If t, cycling is always used.
 If an integer, cycling is used so long as there are not more
@@ -2952,8 +2951,6 @@ or a symbol, see `completion-pcm--merge-completions'."
         (`(,(and s1 (pred stringp)) ,(and s2 (pred stringp)) . ,rest)
          (setq p (cons (concat s1 s2) rest)))
         (`(,(and p1 (pred symbolp)) ,(and p2 (guard (eq p1 p2))) . ,_)
-         ;; Unused lexical variable warning due to body not using p1, p2.
-         ;; https://debbugs.gnu.org/16771
          (setq p (cdr p)))
         (`(star ,(pred symbolp) . ,rest) (setq p `(star . ,rest)))
         (`(,(pred symbolp) star . ,rest) (setq p `(star . ,rest)))
diff --git a/lisp/mwheel.el b/lisp/mwheel.el
index f055df9ee8..cbd7813762 100644
--- a/lisp/mwheel.el
+++ b/lisp/mwheel.el
@@ -52,25 +52,38 @@
   ;; Sync the bindings.
   (when (bound-and-true-p mouse-wheel-mode) (mouse-wheel-mode 1)))
 
+(defvar mouse-wheel-down-button 4)
+(make-obsolete-variable 'mouse-wheel-down-button
+                        'mouse-wheel-down-event
+			"22.1")
 (defcustom mouse-wheel-down-event
   (if (or (featurep 'w32-win) (featurep 'ns-win))
       'wheel-up
-    'mouse-4)
+    (intern (format "mouse-%s" mouse-wheel-down-button)))
   "Event used for scrolling down."
   :group 'mouse
   :type 'symbol
   :set 'mouse-wheel-change-button)
 
+(defvar mouse-wheel-up-button 5)
+(make-obsolete-variable 'mouse-wheel-up-button
+                        'mouse-wheel-up-event
+			"22.1")
 (defcustom mouse-wheel-up-event
   (if (or (featurep 'w32-win) (featurep 'ns-win))
       'wheel-down
-    'mouse-5)
+    (intern (format "mouse-%s" mouse-wheel-up-button)))
   "Event used for scrolling up."
   :group 'mouse
   :type 'symbol
   :set 'mouse-wheel-change-button)
 
-(defcustom mouse-wheel-click-event 'mouse-2
+(defvar mouse-wheel-click-button 2)
+(make-obsolete-variable 'mouse-wheel-click-button
+                        'mouse-wheel-click-event
+			"22.1")
+(defcustom mouse-wheel-click-event
+  (intern (format "mouse-%s" mouse-wheel-click-button))
   "Event that should be temporarily inhibited after mouse scrolling.
 The mouse wheel is typically on the mouse-2 button, so it may easily
 happen that text is accidentally yanked into the buffer when
@@ -137,18 +150,30 @@ This can be slightly disconcerting, but some people prefer it."
 
 ;;; For tilt-scroll
 ;;;
-(defcustom mouse-wheel-tilt-scroll nil
+(defcustom mwheel-tilt-scroll-p nil
   "Enable scroll using tilting mouse wheel."
   :group 'mouse
   :type 'boolean
   :version "26.1")
 
-(defcustom mouse-wheel-flip-direction nil
+(defcustom mwheel-flip-direction nil
   "Swap direction of 'wheel-right and 'wheel-left."
   :group 'mouse
   :type 'boolean
   :version "26.1")
 
+(defcustom mwheel-scroll-left-function 'scroll-left
+  "Function that does the job of scrolling left."
+  :group 'mouse
+  :type 'function
+  :version "26.1")
+
+(defcustom mwheel-scroll-right-function 'scroll-right
+  "Function that does the job of scrolling right."
+  :group 'mouse
+  :type 'function
+  :version "26.1")
+
 (eval-and-compile
   (if (fboundp 'event-button)
       (fset 'mwheel-event-button 'event-button)
@@ -186,12 +211,6 @@ This can be slightly disconcerting, but some people prefer it."
 (defvar mwheel-scroll-down-function 'scroll-down
   "Function that does the job of scrolling downward.")
 
-(defvar mwheel-scroll-left-function 'scroll-left
-  "Function that does the job of scrolling left.")
-
-(defvar mwheel-scroll-right-function 'scroll-right
-  "Function that does the job of scrolling right.")
-
 (defvar mouse-wheel-left-event
   (if (or (featurep 'w32-win) (featurep 'ns-win))
       'wheel-left
@@ -274,13 +293,13 @@ non-Windows systems."
                    ;; Make sure we do indeed scroll to the end of the buffer.
                    (end-of-buffer (while t (funcall mwheel-scroll-up-function)))))
                 ((eq button mouse-wheel-left-event) ; for tilt scroll
-                 (when mouse-wheel-tilt-scroll
-                   (funcall (if mouse-wheel-flip-direction
+                 (when mwheel-tilt-scroll-p
+                   (funcall (if mwheel-flip-direction
                                 mwheel-scroll-right-function
                               mwheel-scroll-left-function) amt)))
                 ((eq button mouse-wheel-right-event) ; for tilt scroll
-                 (when mouse-wheel-tilt-scroll
-                   (funcall (if mouse-wheel-flip-direction
+                 (when mwheel-tilt-scroll-p
+                   (funcall (if mwheel-flip-direction
                                 mwheel-scroll-left-function
                               mwheel-scroll-right-function) amt)))
 		(t (error "Bad binding in mwheel-scroll"))))
diff --git a/lisp/net/ange-ftp.el b/lisp/net/ange-ftp.el
index c3650afa9a..b1e0bf24aa 100644
--- a/lisp/net/ange-ftp.el
+++ b/lisp/net/ange-ftp.el
@@ -3633,7 +3633,7 @@ so return the size on the remote host exactly. See RFC 3659."
 ;; 			     newname))
 ;; 	res)
 ;;     (set-process-sentinel proc 'ange-ftp-copy-file-locally-sentinel)
-;;     (set-process-query-on-exit-flag proc nil)
+;;     (process-kill-without-query proc)
 ;;     (with-current-buffer (process-buffer proc)
 ;;       (set (make-local-variable 'copy-cont) cont))))
 ;;
diff --git a/lisp/net/eudc-bob.el b/lisp/net/eudc-bob.el
index 584d1a9d0d..57b748b150 100644
--- a/lisp/net/eudc-bob.el
+++ b/lisp/net/eudc-bob.el
@@ -312,7 +312,7 @@ display a button."
 	(define-key map [return] 'goto-address-at-point)
 	(define-key map (if (featurep 'xemacs)
 			    [button2]
-			  [down-mouse-2]) 'goto-address-at-point)
+			  [down-mouse-2]) 'goto-address-at-mouse)
 	map))
 
 (set-keymap-parent eudc-bob-image-keymap eudc-bob-generic-keymap)
diff --git a/lisp/net/eww.el b/lisp/net/eww.el
index 66b1767b56..caac96a485 100644
--- a/lisp/net/eww.el
+++ b/lisp/net/eww.el
@@ -1532,8 +1532,7 @@ Differences in #targets are ignored."
                   eww-download-directory)))
       (goto-char (point-min))
       (re-search-forward "\r?\n\r?\n")
-      (let ((coding-system-for-write 'no-conversion))
-        (write-region (point) (point-max) file))
+      (write-region (point) (point-max) file)
       (message "Saved %s" file))))
 
 (defun eww-decode-url-file-name (string)
diff --git a/lisp/net/goto-addr.el b/lisp/net/goto-addr.el
index cc1cdd1518..ed615d10eb 100644
--- a/lisp/net/goto-addr.el
+++ b/lisp/net/goto-addr.el
@@ -220,6 +220,10 @@ and `goto-address-fontify-p'."
 ;; code to find and goto addresses; much of this has been blatantly
 ;; snarfed from browse-url.el
 
+;;;###autoload
+(define-obsolete-function-alias
+  'goto-address-at-mouse 'goto-address-at-point "22.1")
+
 ;;;###autoload
 (defun goto-address-at-point (&optional event)
   "Send to the e-mail address or load the URL at point.
diff --git a/lisp/net/net-utils.el b/lisp/net/net-utils.el
index c9e80804bd..9edd42b857 100644
--- a/lisp/net/net-utils.el
+++ b/lisp/net/net-utils.el
@@ -86,6 +86,8 @@ These options can be used to limit how many ICMP packets are emitted."
   :group 'net-utils
   :type  '(repeat string))
 
+(define-obsolete-variable-alias 'ipconfig-program 'ifconfig-program "22.2")
+
 (defcustom ifconfig-program
   (cond ((eq system-type 'windows-nt) "ipconfig")
         ((executable-find "ifconfig") "ifconfig")
@@ -97,6 +99,9 @@ These options can be used to limit how many ICMP packets are emitted."
   :group 'net-utils
   :type  'string)
 
+(define-obsolete-variable-alias 'ipconfig-program-options
+  'ifconfig-program-options "22.2")
+
 (defcustom ifconfig-program-options
   (cond ((string-match "ipconfig\\'" ifconfig-program) '("/all"))
         ((string-match "ifconfig\\'" ifconfig-program) '("-a"))
diff --git a/lisp/net/quickurl.el b/lisp/net/quickurl.el
index a5ba26bcdc..5321807cd6 100644
--- a/lisp/net/quickurl.el
+++ b/lisp/net/quickurl.el
@@ -116,13 +116,8 @@
   :type  'function
   :group 'quickurl)
 
-(defun quickurl--assoc-function (key alist)
-  "Default function for `quickurl-assoc-function'."
-  (assoc-string key alist t))
-
-(defcustom quickurl-assoc-function #'quickurl--assoc-function
+(defcustom quickurl-assoc-function #'assoc-ignore-case
   "Function to use for alist lookup into `quickurl-urls'."
-  :version "26.1"                 ; was the obsolete assoc-ignore-case
   :type  'function
   :group 'quickurl)
 
@@ -155,7 +150,7 @@ could be used here."
 (defconst quickurl-reread-hook-postfix
     "
 ;; Local Variables:
-;; eval: (progn (require 'quickurl) (add-hook 'write-file-functions (lambda () (quickurl-read) nil) nil t))
+;; eval: (progn (require 'quickurl) (add-hook 'local-write-file-hooks (lambda () (quickurl-read) nil)))
 ;; End:
 "
   "Example `quickurl-postfix' text that adds a local variable to the
diff --git a/lisp/net/tramp-adb.el b/lisp/net/tramp-adb.el
index 7a0ea71aee..cb80506786 100644
--- a/lisp/net/tramp-adb.el
+++ b/lisp/net/tramp-adb.el
@@ -458,13 +458,13 @@ pass to the OPERATION."
 			   result)))))))))
 
 (defun tramp-adb-get-ls-command (vec)
-  "Determine `ls' command and its arguments."
+  "Determine `ls' command at its arguments."
   (with-tramp-connection-property vec "ls"
     (tramp-message vec 5 "Finding a suitable `ls' command")
     (cond
      ;; Support Android derived systems where "ls" command is provided
      ;; by GNU Coreutils. Force "ls" to print one column and set
-     ;; time-style to imitate other "ls" flavors.
+     ;; time-style to imitate other "ls" flavours.
      ((tramp-adb-send-command-and-check
        vec "ls --time-style=long-iso /dev/null")
       "ls -1 --time-style=long-iso")
diff --git a/lisp/net/tramp-archive.el b/lisp/net/tramp-archive.el
index 0b5a351dea..87b69767f0 100644
--- a/lisp/net/tramp-archive.el
+++ b/lisp/net/tramp-archive.el
@@ -62,7 +62,6 @@
 ;; * ".lzh", ".LZH" - Microsoft Windows compressed LHA archives
 ;; * ".msu", ".MSU" - Microsoft Windows Update packages
 ;; * ".mtree" - BSD mtree format
-;; * ".odb" ".odf" ".odg" ".odp" ".ods" ".odt" - OpenDocument formats
 ;; * ".pax" - Posix archives
 ;; * ".rar" - RAR archives
 ;; * ".rpm" - Red Hat packages
@@ -127,9 +126,9 @@
 ;; <https://github.com/libarchive/libarchive/wiki/LibarchiveFormats>
 ;;;###autoload
 (defconst tramp-archive-suffixes
-  ;; "cab", "lzh", "msu" and "zip" are included with lower and upper
-  ;; letters, because Microsoft Windows provides them often with
-  ;; capital letters.
+  ;; "cab", "lzh" and "zip" are included with lower and upper letters,
+  ;; because Microsoft Windows provides them often with capital
+  ;; letters.
   '("7z" ;; 7-Zip archives.
     "apk" ;; Android package kits.  Not in libarchive testsuite.
     "ar" ;; UNIX archiver formats.
@@ -143,7 +142,6 @@
     "lzh" "LZH" ;; Microsoft Windows compressed LHA archives.
     "msu" "MSU" ;; Microsoft Windows Update packages.  Not in testsuite.
     "mtree" ;; BSD mtree format.
-    "odb" "odf" "odg" "odp" "ods" "odt" ;; OpenDocument formats.  Not in testsuite.
     "pax" ;; Posix archives.
     "rar" ;; RAR archives.
     "rpm" ;; Red Hat packages.
diff --git a/lisp/net/tramp-sh.el b/lisp/net/tramp-sh.el
index 0cdf42de68..ff5d404aaa 100644
--- a/lisp/net/tramp-sh.el
+++ b/lisp/net/tramp-sh.el
@@ -962,16 +962,15 @@ busybox awk '{}' </dev/null"
 (defconst tramp-vc-registered-read-file-names
   "echo \"(\"
 while read file; do
-    quoted=`echo \"$file\" | sed -e \"s/\\\"/\\\\\\\\\\\\\\\\\\\"/\"`
     if %s \"$file\"; then
-	echo \"(\\\"$quoted\\\" \\\"file-exists-p\\\" t)\"
+	echo \"(\\\"$file\\\" \\\"file-exists-p\\\" t)\"
     else
-	echo \"(\\\"$quoted\\\" \\\"file-exists-p\\\" nil)\"
+	echo \"(\\\"$file\\\" \\\"file-exists-p\\\" nil)\"
     fi
     if %s \"$file\"; then
-	echo \"(\\\"$quoted\\\" \\\"file-readable-p\\\" t)\"
+	echo \"(\\\"$file\\\" \\\"file-readable-p\\\" t)\"
     else
-	echo \"(\\\"$quoted\\\" \\\"file-readable-p\\\" nil)\"
+	echo \"(\\\"$file\\\" \\\"file-readable-p\\\" nil)\"
     fi
 done
 echo \")\""
@@ -2055,7 +2054,6 @@ file names."
 	  (t2 (tramp-tramp-file-p newname))
 	  (length (tramp-compat-file-attribute-size
 		   (file-attributes (file-truename filename))))
-	  ;; `file-extended-attributes' exists since Emacs 24.4.
 	  (attributes (and preserve-extended-attributes
 			   (apply 'file-extended-attributes (list filename)))))
 
@@ -4175,7 +4173,7 @@ process to set up.  VEC specifies the connection."
 	      cs-encode
 	      (coding-system-change-eol-conversion
 	       cs-encode (if (string-match "^Darwin" uname) 'mac 'unix)))
-	(tramp-send-command vec "(echo foo ; echo bar)" t)
+	(tramp-send-command vec "echo foo ; echo bar" t)
 	(goto-char (point-min))
 	(when (search-forward "\r" nil t)
 	  (setq cs-decode (coding-system-change-eol-conversion cs-decode 'dos)))
diff --git a/lisp/net/tramp.el b/lisp/net/tramp.el
index fe9f197694..bae039dba1 100644
--- a/lisp/net/tramp.el
+++ b/lisp/net/tramp.el
@@ -3564,7 +3564,7 @@ support symbolic links."
 		  (concat (file-remote-p filename)
 			  (substitute-in-file-name localname))))))
       ;; "/m:h:~" does not work for completion.  We use "/m:h:~/".
-      (if (and (stringp localname) (string-equal "~" localname))
+      (if (string-match "^~$" localname)
 	  (concat filename "/")
 	filename))))
 
@@ -4459,7 +4459,6 @@ Invokes `password-read' if available, `read-passwd' else."
 					  auth-passwd))))
 	       ;; Try the password cache.
 	       (let ((password (password-read pw-prompt key)))
-		 ;; FIXME test password works before caching it.
 		 (password-cache-add key password)
 		 password)
 	       ;; Else, get the password interactively.
diff --git a/lisp/novice.el b/lisp/novice.el
index aaad4fabfe..b9cd568ace 100644
--- a/lisp/novice.el
+++ b/lisp/novice.el
@@ -34,6 +34,9 @@
 ;; The command is found in this-command
 ;; and the keys are returned by (this-command-keys).
 
+;;;###autoload
+(define-obsolete-variable-alias 'disabled-command-hook
+  'disabled-command-function "22.1")
 ;;;###autoload
 (defvar disabled-command-function 'disabled-command-function
   "Function to call to handle disabled commands.
diff --git a/lisp/obsolete/iswitchb.el b/lisp/obsolete/iswitchb.el
index d03621df3c..55e81d08d1 100644
--- a/lisp/obsolete/iswitchb.el
+++ b/lisp/obsolete/iswitchb.el
@@ -353,6 +353,8 @@ See also `iswitchb-newbuffer'."
   :type 'boolean
   :group 'iswitchb)
 
+(define-obsolete-variable-alias 'iswitchb-use-fonts 'iswitchb-use-faces "22.1")
+
 (defcustom iswitchb-use-faces t
   "Non-nil means use font-lock faces for showing first match."
   :type 'boolean
diff --git a/lisp/obsolete/options.el b/lisp/obsolete/options.el
new file mode 100644
index 0000000000..41637a6ecf
--- /dev/null
+++ b/lisp/obsolete/options.el
@@ -0,0 +1,140 @@
+;;; options.el --- edit Options command for Emacs
+
+;; Copyright (C) 1985, 2001-2018 Free Software Foundation, Inc.
+
+;; Maintainer: emacs-devel@gnu.org
+;; Obsolete-since: 22.1
+
+;; This file is part of GNU Emacs.
+
+;; GNU Emacs is free software: you can redistribute it and/or modify
+;; it under the terms of the GNU General Public License as published by
+;; the Free Software Foundation, either version 3 of the License, or
+;; (at your option) any later version.
+
+;; GNU Emacs is distributed in the hope that it will be useful,
+;; but WITHOUT ANY WARRANTY; without even the implied warranty of
+;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+;; GNU General Public License for more details.
+
+;; You should have received a copy of the GNU General Public License
+;; along with GNU Emacs.  If not, see <https://www.gnu.org/licenses/>.
+
+;;; Commentary:
+
+;; This code provides functions to list and edit the values of all global
+;; option variables known to loaded Emacs Lisp code.  There are two entry
+;; points, `list-options' and `edit' options'.  The latter enters a major
+;; mode specifically for editing option values.  Do `M-x describe-mode' in
+;; that context for more details.
+
+;; The customization buffer feature is intended to make this obsolete.
+
+;;; Code:
+
+;;;###autoload
+(defun list-options ()
+  "Display a list of Emacs user options, with values and documentation.
+It is now better to use Customize instead."
+  (interactive)
+  (with-output-to-temp-buffer "*List Options*"
+    (let (vars)
+      (princ "This facility is obsolete; we recommend using M-x customize instead.")
+
+      (mapatoms (function (lambda (sym)
+			    (if (custom-variable-p sym)
+				(setq vars (cons sym vars))))))
+      (setq vars (sort vars 'string-lessp))
+      (while vars
+	(let ((sym (car vars)))
+	  (when (boundp sym)
+	    (princ ";; ")
+	    (prin1 sym)
+	    (princ ":\n\t")
+	    (prin1 (symbol-value sym))
+	    (terpri)
+	    (princ (substitute-command-keys
+		    (documentation-property sym 'variable-documentation)))
+	    (princ "\n;;\n"))
+	  (setq vars (cdr vars))))
+      (with-current-buffer "*List Options*"
+	(Edit-options-mode)
+	(setq buffer-read-only t)))))
+
+;;;###autoload
+(defun edit-options ()
+  "Edit a list of Emacs user option values.
+Selects a buffer containing such a list,
+in which there are commands to set the option values.
+Type \\[describe-mode] in that buffer for a list of commands.
+
+The Custom feature is intended to make this obsolete."
+  (interactive)
+  (list-options)
+  (pop-to-buffer "*List Options*"))
+
+(defvar Edit-options-mode-map
+  (let ((map (make-keymap)))
+    (define-key map "s" 'Edit-options-set)
+    (define-key map "x" 'Edit-options-toggle)
+    (define-key map "1" 'Edit-options-t)
+    (define-key map "0" 'Edit-options-nil)
+    (define-key map "p" 'backward-paragraph)
+    (define-key map " " 'forward-paragraph)
+    (define-key map "n" 'forward-paragraph)
+    map)
+  "")
+
+;; Edit Options mode is suitable only for specially formatted data.
+(put 'Edit-options-mode 'mode-class 'special)
+
+(define-derived-mode Edit-options-mode emacs-lisp-mode "Options"
+  "\\<Edit-options-mode-map>\
+Major mode for editing Emacs user option settings.
+Special commands are:
+\\[Edit-options-set] -- set variable point points at.  New value read using minibuffer.
+\\[Edit-options-toggle] -- toggle variable, t -> nil, nil -> t.
+\\[Edit-options-t] -- set variable to t.
+\\[Edit-options-nil] -- set variable to nil.
+Changed values made by these commands take effect immediately.
+
+Each variable description is a paragraph.
+For convenience, the characters \\[backward-paragraph] and \\[forward-paragraph] move back and forward by paragraphs."
+  (setq-local paragraph-separate "[^\^@-\^?]")
+  (setq-local paragraph-start "\t")
+  (setq-local truncate-lines t))
+
+(defun Edit-options-set () (interactive)
+  (Edit-options-modify
+   (lambda (var) (eval-minibuffer (concat "New " (symbol-name var) ": ")))))
+
+(defun Edit-options-toggle () (interactive)
+  (Edit-options-modify (lambda (var) (not (symbol-value var)))))
+
+(defun Edit-options-t () (interactive)
+  (Edit-options-modify (lambda (var) t)))
+
+(defun Edit-options-nil () (interactive)
+  (Edit-options-modify (lambda (var) nil)))
+
+(defun Edit-options-modify (modfun)
+  (save-excursion
+   (let ((buffer-read-only nil) var pos)
+     (re-search-backward "^;; \\|\\`")
+     (forward-char 3)
+     (setq pos (point))
+     (save-restriction
+       (narrow-to-region pos (progn (end-of-line) (1- (point))))
+       (goto-char pos)
+       (setq var (read (current-buffer))))
+     (goto-char pos)
+     (forward-line 1)
+     (forward-char 1)
+     (save-excursion
+       (set var (funcall modfun var)))
+     (kill-sexp 1)
+     (prin1 (symbol-value var) (current-buffer)))))
+
+(provide 'options)
+
+;;; options.el ends here
diff --git a/lisp/obsolete/tpu-mapper.el b/lisp/obsolete/tpu-mapper.el
index 4cc2404e4e..6a5a83c888 100644
--- a/lisp/obsolete/tpu-mapper.el
+++ b/lisp/obsolete/tpu-mapper.el
@@ -56,7 +56,7 @@
           (set-buffer "Keys")
           (insert (format"(global-set-key %s %s)\n" tpu-key func))
           (set-buffer "Gold-Keys")
-          (insert (format "(define-key tpu-gold-map %s %s)\n" tpu-key gold-func))))
+          (insert (format "(define-key GOLD-map %s %s)\n" tpu-key gold-func))))
     (message "Press %s%s: " ident descrip)
     (setq tpu-key-seq (read-event)
           tpu-key (format "[%s]" tpu-key-seq))
@@ -203,7 +203,7 @@ your local X guru can try to figure out why the key is being ignored."
 ")
   (set-buffer "Directions")
 
-  (tpu-map-key "PF1"  " - The GOLD key"               "tpu-gold-map"              "'keyboard-quit")
+  (tpu-map-key "PF1"  " - The GOLD key"               "GOLD-map"                 "'keyboard-quit")
   (tpu-map-key "PF2"  " - The Keypad Help key"        "'tpu-help"                 "'help-for-help")
   (tpu-map-key "PF3"  " - The Find/Find-Next key"     "'tpu-search-again"         "'tpu-search")
   (tpu-map-key "PF4"  " - The Del/Undelete Line key"  "'tpu-delete-current-line"  "'tpu-undelete-lines")
diff --git a/lisp/org/org-agenda.el b/lisp/org/org-agenda.el
index 3d4379b022..9aaec33070 100644
--- a/lisp/org/org-agenda.el
+++ b/lisp/org/org-agenda.el
@@ -2201,14 +2201,10 @@ The following commands are available:
   (add-hook 'post-command-hook 'org-agenda-update-agenda-type nil 'local)
   (add-hook 'pre-command-hook 'org-unhighlight nil 'local)
   ;; Make sure properties are removed when copying text
-  (if (boundp 'filter-buffer-substring-functions)
-      (add-hook 'filter-buffer-substring-functions
-                (lambda (fun start end delete)
-                  (substring-no-properties (funcall fun start end delete)))
-                nil t)
-    ;; Emacs >= 24.4.
-    (add-function :filter-return (local 'filter-buffer-substring-function)
-                  #'substring-no-properties))
+  (add-hook 'filter-buffer-substring-functions
+	    (lambda (fun start end delete)
+	      (substring-no-properties (funcall fun start end delete)))
+	    nil t)
   (unless org-agenda-keep-modes
     (setq org-agenda-follow-mode org-agenda-start-with-follow-mode
 	  org-agenda-entry-text-mode org-agenda-start-with-entry-text-mode))
diff --git a/lisp/org/org-element.el b/lisp/org/org-element.el
index a63aae5329..844349c2fc 100644
--- a/lisp/org/org-element.el
+++ b/lisp/org/org-element.el
@@ -4721,7 +4721,7 @@ indentation removed from its contents."
 ;; Cache is enabled by default, but can be disabled globally with
 ;; `org-element-use-cache'.  `org-element-cache-sync-idle-time',
 ;; org-element-cache-sync-duration' and `org-element-cache-sync-break'
-;; can be tweaked to control caching behavior.
+;; can be tweaked to control caching behaviour.
 ;;
 ;; Internally, parsed elements are stored in an AVL tree,
 ;; `org-element--cache'.  This tree is updated lazily: whenever
diff --git a/lisp/org/org-indent.el b/lisp/org/org-indent.el
index f2cd6a66fb..ef68c3c4fa 100644
--- a/lisp/org/org-indent.el
+++ b/lisp/org/org-indent.el
@@ -183,15 +183,11 @@ during idle time."
 		  org-hide-leading-stars)
       (setq-local org-hide-leading-stars t))
     (org-indent--compute-prefixes)
-    (if (boundp 'filter-buffer-substring-functions)
-	(add-hook 'filter-buffer-substring-functions
-		  (lambda (fun start end delete)
-		    (org-indent-remove-properties-from-string
-		     (funcall fun start end delete)))
-		  nil t)
-      ;; Emacs >= 24.4.
-      (add-function :filter-return (local 'filter-buffer-substring-function)
-		    #'org-indent-remove-properties-from-string))
+    (add-hook 'filter-buffer-substring-functions
+	      (lambda (fun start end delete)
+		(org-indent-remove-properties-from-string
+		 (funcall fun start end delete)))
+	      nil t)
     (add-hook 'after-change-functions 'org-indent-refresh-maybe nil 'local)
     (add-hook 'before-change-functions
 	      'org-indent-notify-modified-headline nil 'local)
@@ -215,13 +211,10 @@ during idle time."
     (when (boundp 'org-hide-leading-stars-before-indent-mode)
       (setq-local org-hide-leading-stars
 		  org-hide-leading-stars-before-indent-mode))
-    (if (boundp 'filter-buffer-substring-functions)
-	(remove-hook 'filter-buffer-substring-functions
-		     (lambda (fun start end delete)
-		       (org-indent-remove-properties-from-string
-			(funcall fun start end delete))))
-      (remove-function (local 'filter-buffer-substring-function)
-		       #'org-indent-remove-properties-from-string))
+    (remove-hook 'filter-buffer-substring-functions
+		 (lambda (fun start end delete)
+		   (org-indent-remove-properties-from-string
+		    (funcall fun start end delete))))
     (remove-hook 'after-change-functions 'org-indent-refresh-maybe 'local)
     (remove-hook 'before-change-functions
 		 'org-indent-notify-modified-headline 'local)
diff --git a/lisp/org/org-pcomplete.el b/lisp/org/org-pcomplete.el
index 1acb61590f..a7cc09def4 100644
--- a/lisp/org/org-pcomplete.el
+++ b/lisp/org/org-pcomplete.el
@@ -194,7 +194,7 @@ When completing for #+STARTUP, for example, this function returns
   "Complete arguments for the #+LANGUAGE file option."
   (require 'ox)
   (pcomplete-here
-   (pcomplete-uniquify-list
+   (pcomplete-uniqify-list
     (list org-export-default-language "en"))))
 
 (defvar org-default-priority)
@@ -219,7 +219,7 @@ When completing for #+STARTUP, for example, this function returns
 (defun pcomplete/org-mode/file-option/startup ()
   "Complete arguments for the #+STARTUP file option."
   (while (pcomplete-here
-	  (let ((opts (pcomplete-uniquify-list
+	  (let ((opts (pcomplete-uniqify-list
 		       (mapcar 'car org-startup-options))))
 	    ;; Some options are mutually exclusive, and shouldn't be completed
 	    ;; against if certain other options have already been seen.
@@ -248,7 +248,7 @@ When completing for #+STARTUP, for example, this function returns
 (defun pcomplete/org-mode/file-option/options ()
   "Complete arguments for the #+OPTIONS file option."
   (while (pcomplete-here
-	  (pcomplete-uniquify-list
+	  (pcomplete-uniqify-list
 	   (append
 	    ;; Hard-coded OPTION items always available.
 	    '("H:" "\\n:" "num:" "timestamp:" "arch:" "author:" "c:"
@@ -267,7 +267,7 @@ When completing for #+STARTUP, for example, this function returns
 (defun pcomplete/org-mode/file-option/infojs_opt ()
   "Complete arguments for the #+INFOJS_OPT file option."
   (while (pcomplete-here
-	  (pcomplete-uniquify-list
+	  (pcomplete-uniqify-list
 	   (mapcar (lambda (item) (format "%s:" (car item)))
 		   (bound-and-true-p org-html-infojs-opts-table))))))
 
@@ -283,7 +283,7 @@ When completing for #+STARTUP, for example, this function returns
 (defun pcomplete/org-mode/link ()
   "Complete against defined #+LINK patterns."
   (pcomplete-here
-   (pcomplete-uniquify-list
+   (pcomplete-uniqify-list
     (copy-sequence
      (append (mapcar 'car org-link-abbrev-alist-local)
 	     (mapcar 'car org-link-abbrev-alist))))))
@@ -293,13 +293,13 @@ When completing for #+STARTUP, for example, this function returns
   "Complete against TeX-style HTML entity names."
   (require 'org-entities)
   (while (pcomplete-here
-	  (pcomplete-uniquify-list (remove nil (mapcar 'car-safe org-entities)))
+	  (pcomplete-uniqify-list (remove nil (mapcar 'car-safe org-entities)))
 	  (substring pcomplete-stub 1))))
 
 (defvar org-todo-keywords-1)
 (defun pcomplete/org-mode/todo ()
   "Complete against known TODO keywords."
-  (pcomplete-here (pcomplete-uniquify-list (copy-sequence org-todo-keywords-1))))
+  (pcomplete-here (pcomplete-uniqify-list (copy-sequence org-todo-keywords-1))))
 
 (defvar org-todo-line-regexp)
 (defun pcomplete/org-mode/searchhead ()
@@ -315,14 +315,14 @@ This needs more work, to handle headings with lots of spaces in them."
 	       (push (org-make-org-heading-search-string
 		      (match-string-no-properties 3))
 		     tbl)))
-	   (pcomplete-uniquify-list tbl)))
+	   (pcomplete-uniqify-list tbl)))
        (substring pcomplete-stub 1))))
 
 (defun pcomplete/org-mode/tag ()
   "Complete a tag name.  Omit tags already set."
   (while (pcomplete-here
 	  (mapcar (lambda (x) (concat x ":"))
-		  (let ((lst (pcomplete-uniquify-list
+		  (let ((lst (pcomplete-uniqify-list
 			      (or (remq
 				   nil
 				   (mapcar (lambda (x) (org-string-nw-p (car x)))
@@ -339,7 +339,7 @@ This needs more work, to handle headings with lots of spaces in them."
   (pcomplete-here
    (mapcar (lambda (x)
 	     (concat x ": "))
-	   (let ((lst (pcomplete-uniquify-list
+	   (let ((lst (pcomplete-uniqify-list
 		       (copy-sequence
 			(org-buffer-property-keys nil t t t)))))
 	     (dolist (prop (org-entry-properties))
diff --git a/lisp/org/org-table.el b/lisp/org/org-table.el
index 4bb5c91ce8..3932671e8b 100644
--- a/lisp/org/org-table.el
+++ b/lisp/org/org-table.el
@@ -5428,7 +5428,7 @@ which will prompt for the width."
 ;; - orgtbl-uc-draw-cont (smooth unicode)
 
 ;; This is best viewed with the "DejaVu Sans Mono" font
-;; (use M-x set-frame-font).
+;; (use M-x set-default-font).
 
 (defun orgtbl-uc-draw-grid (value min max &optional width)
   "Draw a bar in a table using block unicode characters.
diff --git a/lisp/org/org.el b/lisp/org/org.el
index 3ec6b4eabe..4e4620549c 100644
--- a/lisp/org/org.el
+++ b/lisp/org/org.el
@@ -10641,7 +10641,7 @@ a timestamp or a link."
 		   (save-excursion
 		     ;; Do not validate action when point is on the
 		     ;; spaces right after the footnote label, in
-		     ;; order to be on par with behavior on links.
+		     ;; order to be on par with behaviour on links.
 		     (skip-chars-forward " \t")
 		     (let ((begin
 			    (org-element-property :contents-begin context)))
@@ -10794,7 +10794,7 @@ there is one, return it."
        (cons link end)))))
 
 ;; TODO: These functions are deprecated since `org-open-at-point'
-;; hard-codes behavior for "file+emacs" and "file+sys" types.
+;; hard-codes behaviour for "file+emacs" and "file+sys" types.
 (defun org-open-file-with-system (path)
   "Open file at PATH using the system way of opening it."
   (org-open-file path 'system))
@@ -19316,9 +19316,6 @@ INCLUDE-LINKED is passed to `org-display-inline-images'."
     (org-toggle-inline-images)
     (org-toggle-inline-images)))
 
-;; For without-x builds.
-(declare-function image-refresh "image" (spec &optional frame))
-
 (defun org-display-inline-images (&optional include-linked refresh beg end)
   "Display inline images.
 
@@ -22908,7 +22905,7 @@ matches in paragraphs or comments, use it."
 		      (match-string 0)
 		    "")))))))))))
 
-(declare-function message-goto-body "message" (&optional interactive))
+(declare-function message-goto-body "message" ())
 (defvar message-cite-prefix-regexp)	; From message.el
 
 (defun org-fill-element (&optional justify)
diff --git a/lisp/org/ox-odt.el b/lisp/org/ox-odt.el
index 1fc697a6a8..cdee568fc8 100644
--- a/lisp/org/ox-odt.el
+++ b/lisp/org/ox-odt.el
@@ -2192,10 +2192,6 @@ SHORT-CAPTION are strings."
     (org-odt-create-manifest-file-entry media-type target-file)
     target-file))
 
-;; For --without-x builds.
-(declare-function clear-image-cache "image.c" (&optional filter))
-(declare-function image-size "image.c" (spec &optional pixels frame))
-
 (defun org-odt--image-size
   (file info &optional user-width user-height scale dpi embed-as)
   (let* ((--pixels-to-cms
diff --git a/lisp/outline.el b/lisp/outline.el
index 669935bbc1..7cf56abd23 100644
--- a/lisp/outline.el
+++ b/lisp/outline.el
@@ -1100,26 +1100,28 @@ convenient way to make a table of contents of the buffer."
     (save-restriction
       (narrow-to-region beg end)
       (goto-char (point-min))
-      (let ((buffer (current-buffer)) start end)
-        (with-temp-buffer
-          (let ((temp-buffer (current-buffer)))
-            (with-current-buffer buffer
-              ;; Boundary condition: starting on heading:
-              (when (outline-on-heading-p)
-                (outline-back-to-heading)
-                (setq start (point)
-                      end (progn (outline-end-of-heading) (point)))
-                (with-current-buffer temp-buffer
-                  (insert-buffer-substring buffer start end)
-                  (insert "\n\n")))
-              (while (outline-next-heading)
-                (unless (outline-invisible-p)
-                  (setq start (point)
-                        end (progn (outline-end-of-heading) (point)))
-                  (with-current-buffer temp-buffer
-                    (insert-buffer-substring buffer start end)
-                    (insert "\n\n"))))))
-          (kill-new (buffer-string)))))))
+      (let ((buffer (current-buffer))
+	    start end)
+	(with-temp-buffer
+	  (with-current-buffer buffer
+	    ;; Boundary condition: starting on heading:
+	    (when (outline-on-heading-p)
+	      (outline-back-to-heading)
+	      (setq start (point)
+		    end (progn (outline-end-of-heading)
+			       (point)))
+	      (insert-buffer-substring buffer start end)
+	      (insert "\n\n")))
+	  (let ((temp-buffer (current-buffer)))
+	    (with-current-buffer buffer
+	      (while (outline-next-heading)
+		(unless (outline-invisible-p)
+		  (setq start (point)
+			end (progn (outline-end-of-heading) (point)))
+		  (with-current-buffer temp-buffer
+		    (insert-buffer-substring buffer start end)
+		    (insert "\n\n"))))))
+	  (kill-new (buffer-string)))))))
 
 (provide 'outline)
 (provide 'noutline)
diff --git a/lisp/pcmpl-cvs.el b/lisp/pcmpl-cvs.el
index dedc007223..a3e2b2f5b3 100644
--- a/lisp/pcmpl-cvs.el
+++ b/lisp/pcmpl-cvs.el
@@ -122,7 +122,7 @@
     (let (cmds)
       (while (re-search-forward "^\\s-+\\([a-z]+\\)" nil t)
 	(setq cmds (cons (match-string 1) cmds)))
-      (pcomplete-uniquify-list cmds))))
+      (pcomplete-uniqify-list cmds))))
 
 (defun pcmpl-cvs-modules ()
   "Return a list of available modules under CVS."
@@ -132,7 +132,7 @@
     (let (entries)
       (while (re-search-forward "\\(\\S-+\\)$" nil t)
 	(setq entries (cons (match-string 1) entries)))
-      (pcomplete-uniquify-list entries))))
+      (pcomplete-uniqify-list entries))))
 
 (defun pcmpl-cvs-tags (&optional opers)
   "Return all the tags which could apply to the files related to OPERS."
@@ -149,7 +149,7 @@
 	    (error "Error in output from `cvs status -v'"))
 	  (setq tags (cons (match-string 1) tags))
 	  (forward-line))))
-    (pcomplete-uniquify-list tags)))
+    (pcomplete-uniqify-list tags)))
 
 (defun pcmpl-cvs-entries (&optional opers)
   "Return the Entries for the current directory.
@@ -187,6 +187,6 @@ operation character applies, as displayed by `cvs -n update'."
                 (setq entries (cons text entries))))
             (forward-line)))))
     (setq pcomplete-stub nondir)
-    (pcomplete-uniquify-list entries)))
+    (pcomplete-uniqify-list entries)))
 
 ;;; pcmpl-cvs.el ends here
diff --git a/lisp/pcmpl-gnu.el b/lisp/pcmpl-gnu.el
index 16c992662d..505d10c164 100644
--- a/lisp/pcmpl-gnu.el
+++ b/lisp/pcmpl-gnu.el
@@ -125,7 +125,7 @@
 	(while (re-search-forward
 		(concat "^\\s-*\\([^\n#%.$][^:=\n]*\\)\\s-*:[^=]") nil t)
 	  (setq rules (append (split-string (match-string 1)) rules))))
-      (pcomplete-uniquify-list rules))))
+      (pcomplete-uniqify-list rules))))
 
 (defcustom pcmpl-gnu-tarfile-regexp
   "\\.t\\(ar\\(\\.\\(gz\\|bz2\\|Z\\|xz\\)\\)?\\|gz\\|a[zZ]\\|z2\\)\\'"
diff --git a/lisp/pcmpl-linux.el b/lisp/pcmpl-linux.el
index 18cc647aac..ce42486fda 100644
--- a/lisp/pcmpl-linux.el
+++ b/lisp/pcmpl-linux.el
@@ -43,7 +43,7 @@
   "Completion for GNU/Linux `kill', using /proc filesystem."
   (if (pcomplete-match "^-\\(.*\\)" 0)
       (pcomplete-here
-       (pcomplete-uniquify-list
+       (pcomplete-uniqify-list
 	(split-string
 	 (pcomplete-process-result "kill" "-l")))
        (pcomplete-match-string 1 0)))
@@ -82,7 +82,7 @@
 		 (args (split-string line " ")))
 	    (setq points (cons (nth 1 args) points)))
 	  (forward-line)))
-      (pcomplete-uniquify-list points))))
+      (pcomplete-uniqify-list points))))
 
 (defun pcomplete-pare-list (l r)
   "Destructively remove from list L all elements matching any in list R.
@@ -109,7 +109,7 @@ Test is done using `equal'."
 	    (setq points (cons (nth 1 args) points)))
 	  (forward-line)))
       (pcomplete-pare-list
-       (pcomplete-uniquify-list points)
+       (pcomplete-uniqify-list points)
        (cons "swap" (pcmpl-linux-mounted-directories))))))
 
 ;;; pcmpl-linux.el ends here
diff --git a/lisp/pcmpl-rpm.el b/lisp/pcmpl-rpm.el
index 74ddb8b9d7..d3250babe6 100644
--- a/lisp/pcmpl-rpm.el
+++ b/lisp/pcmpl-rpm.el
@@ -96,7 +96,7 @@
 		    (pcomplete-process-result
 		     "rpm" "-q" (car pkgs) flag)))
       (setq pkgs (cdr pkgs)))
-    (pcomplete-uniquify-list (cdr provs))))
+    (pcomplete-uniqify-list (cdr provs))))
 
 (defsubst pcmpl-rpm-files ()
   (pcomplete-dirs-or-entries "\\.rpm\\'"))
diff --git a/lisp/pcmpl-unix.el b/lisp/pcmpl-unix.el
index 1b11afd36b..90dde26599 100644
--- a/lisp/pcmpl-unix.el
+++ b/lisp/pcmpl-unix.el
@@ -111,7 +111,7 @@ documentation), this function returns nil."
 						(point))) ":")))
 	    (setq names (cons (nth 0 fields) names)))
 	  (forward-line))))
-    (pcomplete-uniquify-list names)))
+    (pcomplete-uniqify-list names)))
 
 (defsubst pcmpl-unix-group-names ()
   "Read the contents of /etc/group for group names."
diff --git a/lisp/pcomplete.el b/lisp/pcomplete.el
index 6bdea68c0b..6078dfd744 100644
--- a/lisp/pcomplete.el
+++ b/lisp/pcomplete.el
@@ -272,39 +272,6 @@ to all arguments, such as variable names after a $."
   "Complete amongst a list of directories and executables."
   (pcomplete-entries regexp 'file-executable-p))
 
-(defmacro pcomplete-here (&optional form stub paring form-only)
-  "Complete against the current argument, if at the end.
-If completion is to be done here, evaluate FORM to generate the completion
-table which will be used for completion purposes.  If STUB is a
-string, use it as the completion stub instead of the default (which is
-the entire text of the current argument).
-
-For an example of when you might want to use STUB: if the current
-argument text is `long-path-name/', you don't want the completions
-list display to be cluttered by `long-path-name/' appearing at the
-beginning of every alternative.  Not only does this make things less
-intelligible, but it is also inefficient.  Yet, if the completion list
-does not begin with this string for every entry, the current argument
-won't complete correctly.
-
-The solution is to specify a relative stub.  It allows you to
-substitute a different argument from the current argument, almost
-always for the sake of efficiency.
-
-If PARING is nil, this argument will be pared against previous
-arguments using the function `file-truename' to normalize them.
-PARING may be a function, in which case that function is used for
-normalization.  If PARING is t, the argument dealt with by this
-call will not participate in argument paring.  If it is the
-integer 0, all previous arguments that have been seen will be
-cleared.
-
-If FORM-ONLY is non-nil, only the result of FORM will be used to
-generate the completions list.  This means that the hook
-`pcomplete-try-first-hook' will not be run."
-  (declare (debug t))
-  `(pcomplete--here (lambda () ,form) ,stub ,paring ,form-only))
-
 (defcustom pcomplete-command-completion-function
   (function
    (lambda ()
@@ -983,7 +950,7 @@ Arguments NO-GANGING and ARGS-FOLLOW are currently ignored."
 		(function
 		 (lambda (opt)
 		   (concat "-" opt)))
-		(pcomplete-uniquify-list choices))))
+		(pcomplete-uniqify-list choices))))
     (let ((arg (pcomplete-arg)))
       (when (and (> (length arg) 1)
 		 (stringp arg)
@@ -1047,6 +1014,39 @@ See the documentation for `pcomplete-here'."
              ;; byte-compiled with the older code.
              (eval form)))))
 
+(defmacro pcomplete-here (&optional form stub paring form-only)
+  "Complete against the current argument, if at the end.
+If completion is to be done here, evaluate FORM to generate the completion
+table which will be used for completion purposes.  If STUB is a
+string, use it as the completion stub instead of the default (which is
+the entire text of the current argument).
+
+For an example of when you might want to use STUB: if the current
+argument text is `long-path-name/', you don't want the completions
+list display to be cluttered by `long-path-name/' appearing at the
+beginning of every alternative.  Not only does this make things less
+intelligible, but it is also inefficient.  Yet, if the completion list
+does not begin with this string for every entry, the current argument
+won't complete correctly.
+
+The solution is to specify a relative stub.  It allows you to
+substitute a different argument from the current argument, almost
+always for the sake of efficiency.
+
+If PARING is nil, this argument will be pared against previous
+arguments using the function `file-truename' to normalize them.
+PARING may be a function, in which case that function is used for
+normalization.  If PARING is t, the argument dealt with by this
+call will not participate in argument paring.  If it is the
+integer 0, all previous arguments that have been seen will be
+cleared.
+
+If FORM-ONLY is non-nil, only the result of FORM will be used to
+generate the completions list.  This means that the hook
+`pcomplete-try-first-hook' will not be run."
+  (declare (debug t))
+  `(pcomplete--here (lambda () ,form) ,stub ,paring ,form-only))
+
 
 (defmacro pcomplete-here* (&optional form stub form-only)
   "An alternate form which does not participate in argument paring."
@@ -1269,7 +1269,7 @@ If specific documentation can't be given, be generic."
 
 ;; general utilities
 
-(defun pcomplete-uniquify-list (l)
+(defun pcomplete-uniqify-list (l)
   "Sort and remove multiples in L."
   (setq l (sort l 'string-lessp))
   (let ((m l))
@@ -1280,9 +1280,6 @@ If specific documentation can't be given, be generic."
 	(setcdr m (cddr m)))
       (setq m (cdr m))))
   l)
-(define-obsolete-function-alias
-  'pcomplete-uniqify-list
-  'pcomplete-uniquify-list "27.1")
 
 (defun pcomplete-process-result (cmd &rest args)
   "Call CMD using `call-process' and return the simplest result."
diff --git a/lisp/play/dunnet.el b/lisp/play/dunnet.el
index 2b8bd9d6b8..f22cc240c0 100644
--- a/lisp/play/dunnet.el
+++ b/lisp/play/dunnet.el
@@ -2349,6 +2349,7 @@ for a moment, then straighten yourself up.\n")
 ;;;; This section sets up the keymaps for interactive and batch dunnet.
 ;;;;
 
+(define-obsolete-variable-alias 'dungeon-mode-map 'dun-mode-map "22.1")
 (define-key dun-mode-map "\r" 'dun-parse)
 (defvar dungeon-batch-map (make-keymap))
 (if (string= (substring emacs-version 0 2) "18")
diff --git a/lisp/play/gametree.el b/lisp/play/gametree.el
index 5b05ae13e2..de8abd7abe 100644
--- a/lisp/play/gametree.el
+++ b/lisp/play/gametree.el
@@ -586,7 +586,8 @@ shogi, etc.) players, it is a slightly modified version of Outline mode.
 
 \\{gametree-mode-map}"
   (auto-fill-mode 0)
-  (add-hook 'write-contents-functions 'gametree-save-and-hack-layout nil t))
+  (make-local-variable 'write-contents-hooks)
+  (add-hook 'write-contents-hooks 'gametree-save-and-hack-layout))
 
 ;;;; Goodies for mousing users
 (defun gametree-mouse-break-line-here (event)
diff --git a/lisp/progmodes/ada-mode.el b/lisp/progmodes/ada-mode.el
index 76c9be93d0..2d3f6e22a6 100644
--- a/lisp/progmodes/ada-mode.el
+++ b/lisp/progmodes/ada-mode.el
@@ -231,7 +231,7 @@ It may be `downcase-word', `upcase-word', `ada-loose-case-word' or
   "Non-nil means remove trailing spaces and untabify the buffer before saving."
   :type 'boolean :group 'ada)
 (make-obsolete-variable 'ada-clean-buffer-before-saving
-			"it has no effect - use `write-file-functions' hook."
+			"use the `write-file-functions' hook."
 			"23.2")
 
 
diff --git a/lisp/progmodes/bat-mode.el b/lisp/progmodes/bat-mode.el
index 51acc6a949..2910a7a104 100644
--- a/lisp/progmodes/bat-mode.el
+++ b/lisp/progmodes/bat-mode.el
@@ -84,8 +84,6 @@
          . 'bat-label-face)
         ("\\_<\\(defined\\|set\\)\\_>[ \t]*\\(\\(\\sw\\|\\s_\\)+\\)"
          (2 font-lock-variable-name-face))
-        ("%~\\([0-9]\\)"
-         (1 font-lock-variable-name-face))
         ("%\\([^%~ \n]+\\)%?"
          (1 font-lock-variable-name-face))
         ("!\\([^!%~ \n]+\\)!?"  ; delayed-expansion !variable!
diff --git a/lisp/progmodes/compile.el b/lisp/progmodes/compile.el
index 15503ee0b2..422974379b 100644
--- a/lisp/progmodes/compile.el
+++ b/lisp/progmodes/compile.el
@@ -99,6 +99,16 @@ The function receives one argument, the name of the major mode of the
 compilation buffer.  It should return a string.
 If nil, compute the name with `(concat \"*\" (downcase major-mode) \"*\")'.")
 
+;;;###autoload
+(defvar compilation-finish-function nil
+  "Function to call when a compilation process finishes.
+It is called with two arguments: the compilation buffer, and a string
+describing how the process finished.")
+
+(make-obsolete-variable 'compilation-finish-function
+  "use `compilation-finish-functions', but it works a little differently."
+  "22.1")
+
 ;;;###autoload
 (defvar compilation-finish-functions nil
   "Functions to call when a compilation process finishes.
@@ -2091,6 +2101,7 @@ by replacing the first word, e.g., `compilation-scroll-output' from
 		   compilation-error-regexp-alist
 		   compilation-error-regexp-alist-alist
 		   compilation-error-screen-columns
+		   compilation-finish-function
 		   compilation-finish-functions
 		   compilation-first-column
 		   compilation-mode-font-lock-keywords
@@ -2234,6 +2245,9 @@ commands of Compilation major mode are available.  See
     (force-mode-line-update)
     (if (and opoint (< opoint omax))
 	(goto-char opoint))
+    (with-no-warnings
+      (if compilation-finish-function
+	  (funcall compilation-finish-function cur-buffer msg)))
     (run-hook-with-args 'compilation-finish-functions cur-buffer msg)))
 
 ;; Called when compilation process changes state.
diff --git a/lisp/progmodes/cperl-mode.el b/lisp/progmodes/cperl-mode.el
index 09a26ddbe0..8c0682ac1c 100644
--- a/lisp/progmodes/cperl-mode.el
+++ b/lisp/progmodes/cperl-mode.el
@@ -390,6 +390,13 @@ Affects: `cperl-font-lock', `cperl-electric-lbrace-space',
   :type '(repeat string)
      :group 'cperl)
 
+;; This became obsolete...
+(defvar cperl-vc-header-alist nil)
+(make-obsolete-variable
+ 'cperl-vc-header-alist
+ "use cperl-vc-rcs-header or cperl-vc-sccs-header instead."
+ "22.1")
+
 ;; (defcustom cperl-clobber-mode-lists
 ;;   (not
 ;;    (and
@@ -1720,8 +1727,9 @@ or as help on variables `cperl-tips', `cperl-problems',
   (when (featurep 'xemacs)
     ;; This one is obsolete...
     (set (make-local-variable 'vc-header-alist)
-	 `((SCCS ,(car cperl-vc-sccs-header))
-	   (RCS ,(car cperl-vc-rcs-header)))))
+         (or cperl-vc-header-alist      ; Avoid warning
+	     `((SCCS ,(car cperl-vc-sccs-header))
+	       (RCS ,(car cperl-vc-rcs-header))))))
   (cond ((boundp 'compilation-error-regexp-alist-alist);; xemacs 20.x
 	 (set (make-local-variable 'compilation-error-regexp-alist-alist)
 	      (cons (cons 'cperl (car cperl-compilation-error-regexp-alist))
diff --git a/lisp/progmodes/ebrowse.el b/lisp/progmodes/ebrowse.el
index 08b1acd4da..ca64af5c91 100644
--- a/lisp/progmodes/ebrowse.el
+++ b/lisp/progmodes/ebrowse.el
@@ -1107,7 +1107,7 @@ Tree mode key bindings:
          (and tree (ebrowse-build-tree-obarray tree)))
     (set (make-local-variable 'ebrowse--frozen-flag) nil)
 
-    (add-hook 'write-file-functions 'ebrowse-write-file-hook-fn nil t)
+    (add-hook 'local-write-file-hooks 'ebrowse-write-file-hook-fn nil t)
     (modify-syntax-entry ?_ (char-to-string (char-syntax ?a)))
     (when tree
       (ebrowse-redraw-tree)
@@ -4023,7 +4023,7 @@ If VIEW is non-nil, view else find source files."
 
 (defun ebrowse-write-file-hook-fn ()
   "Write current buffer as a class tree.
-Added to `write-file-functions'."
+Installed on `local-write-file-hooks'."
   (ebrowse-save-tree)
   t)
 
diff --git a/lisp/progmodes/flymake.el b/lisp/progmodes/flymake.el
index 56f43e4bb3..a47f13fea3 100644
--- a/lisp/progmodes/flymake.el
+++ b/lisp/progmodes/flymake.el
@@ -48,10 +48,6 @@
 (require 'thingatpt) ; end-of-thing
 (require 'warnings) ; warning-numeric-level, display-warning
 (require 'compile) ; for some faces
-;; We need the next require to avoid compiler warnings and run-time
-;; errors about mouse-wheel-up/down-event in builds --without-x, where
-;; mwheel is not preloaded.
-(require 'mwheel)
 ;; when-let*, if-let*, hash-table-keys, hash-table-values:
 (eval-when-compile (require 'subr-x))
 
diff --git a/lisp/progmodes/gdb-mi.el b/lisp/progmodes/gdb-mi.el
index 88e34d8df9..c664799ab0 100644
--- a/lisp/progmodes/gdb-mi.el
+++ b/lisp/progmodes/gdb-mi.el
@@ -792,7 +792,7 @@ detailed description of this mode.
   (gud-def gud-tbreak "tbreak %f:%l" "\C-t"
 	   "Set temporary breakpoint at current line.")
   (gud-def gud-jump
-	   (progn (gud-call "tbreak %f:%l" arg) (gud-call "jump %f:%l"))
+	   (progn (gud-call "tbreak %f:%l") (gud-call "jump %f:%l"))
 	   "\C-j" "Set execution address to current line.")
 
   (gud-def gud-up     "up %p"     "<" "Up N stack frames (numeric arg).")
diff --git a/lisp/progmodes/glasses.el b/lisp/progmodes/glasses.el
index c3e8ac35f3..de176019a5 100644
--- a/lisp/progmodes/glasses.el
+++ b/lisp/progmodes/glasses.el
@@ -326,10 +326,10 @@ add virtual separators (like underscores) at places they belong to."
       (if glasses-mode
 	  (progn
 	    (jit-lock-register 'glasses-change)
-	    (add-hook 'write-file-functions
+	    (add-hook 'local-write-file-hooks
 		      'glasses-convert-to-unreadable nil t))
 	(jit-lock-unregister 'glasses-change)
-	(remove-hook 'write-file-functions
+	(remove-hook 'local-write-file-hooks
 		     'glasses-convert-to-unreadable t)))))
 
 
diff --git a/lisp/progmodes/grep.el b/lisp/progmodes/grep.el
index 8c0e46f35a..9b2c6f112c 100644
--- a/lisp/progmodes/grep.el
+++ b/lisp/progmodes/grep.el
@@ -286,11 +286,6 @@ See `compilation-error-screen-columns'"
     (define-key map [menu-bar grep]
       (cons "Grep" (make-sparse-keymap "Grep")))
 
-    (define-key map [menu-bar grep grep-find-toggle-abbreviation]
-      '(menu-item "Toggle command abbreviation"
-                  grep-find-toggle-abbreviation
-                  :help "Toggle showing verbose command options"))
-    (define-key map [menu-bar grep compilation-separator3] '("----"))
     (define-key map [menu-bar grep compilation-kill-compilation]
       '(menu-item "Kill Grep" kill-compilation
 		  :help "Kill the currently running grep process"))
@@ -313,7 +308,7 @@ See `compilation-error-screen-columns'"
     (define-key map [menu-bar grep compilation-recompile]
       '(menu-item "Repeat grep" recompile
 		  :help "Run grep again"))
-    (define-key map [menu-bar grep compilation-separator1] '("----"))
+    (define-key map [menu-bar grep compilation-separator2] '("----"))
     (define-key map [menu-bar grep compilation-first-error]
       '(menu-item "First Match" first-error
 		  :help "Restart at the first match, visit corresponding location"))
@@ -438,26 +433,24 @@ See `compilation-error-regexp-alist' for format details.")
                       help-echo "Number of matches so far")
     "]"))
 
-(defcustom grep-find-abbreviate t
+(defcustom grep-find-hide t
   "If non-nil, hide part of rgrep/lgrep/zrgrep command line.
 The hidden part contains a list of ignored directories and files.
 Clicking on the button-like ellipsis unhides the abbreviated part
-and reveals the entire command line.  The visibility of the
-abbreviated part can also be toggled with
-`grep-find-toggle-abbreviation'."
+and reveals the entire command line."
   :type 'boolean
   :version "27.1"
   :group 'grep)
 
-(defvar grep-find-abbreviate-properties
+(defvar grep-find-hide-properties
   (let ((ellipsis (if (char-displayable-p ?…) "[…]" "[...]"))
         (map (make-sparse-keymap)))
     (define-key map [down-mouse-2] 'mouse-set-point)
-    (define-key map [mouse-2] 'grep-find-toggle-abbreviation)
-    (define-key map "\C-m" 'grep-find-toggle-abbreviation)
+    (define-key map [mouse-2] 'grep-find-show)
+    (define-key map "\C-m" 'grep-find-show)
     `(face nil display ,ellipsis mouse-face highlight
       help-echo "RET, mouse-2: show unabbreviated command"
-      keymap ,map abbreviated-command t))
+      keymap ,map))
   "Properties of button-like ellipsis on part of rgrep command line.")
 
 (defvar grep-mode-font-lock-keywords
@@ -483,12 +476,10 @@ abbreviated part can also be toggled with
              `(face nil display ,(match-string 2)))))
      ;; Hide excessive part of rgrep command
      ("^find \\(\\. -type d .*\\\\)\\)"
-      (1 (if grep-find-abbreviate grep-find-abbreviate-properties
-           '(face nil abbreviated-command t))))
+      (1 (when grep-find-hide grep-find-hide-properties)))
      ;; Hide excessive part of lgrep command
      ("^grep \\( *--exclude.*--exclude[^ ]+\\)"
-      (1 (if grep-find-abbreviate grep-find-abbreviate-properties
-           '(face nil abbreviated-command t)))))
+      (1 (when grep-find-hide grep-find-hide-properties))))
    "Additional things to highlight in grep output.
 This gets tacked on the end of the generated expressions.")
 
@@ -1204,19 +1195,23 @@ to specify a command to run."
                  (shell-quote-argument ")")
                  " -prune -o ")))))
 
-(defun grep-find-toggle-abbreviation ()
-  "Toggle showing the hidden part of rgrep/lgrep/zrgrep command line."
+(defun grep-find-show ()
+  "Show the hidden part of rgrep/lgrep/zrgrep command line."
   (interactive)
-  (with-silent-modifications
-    (let* ((beg (next-single-property-change (point-min) 'abbreviated-command))
-           (end (when beg
-                  (next-single-property-change beg 'abbreviated-command))))
-      (if end
-          (if (get-text-property beg 'display)
-              (remove-list-of-text-properties
-               beg end '(display help-echo mouse-face help-echo keymap))
-            (add-text-properties beg end grep-find-abbreviate-properties))
-        (user-error "No abbreviated part to hide/show")))))
+  (when (get-text-property (point) 'display)
+    (let ((beg (or (previous-single-property-change
+                    (min (point-max) (1+ (point))) 'display)
+                   (point)))
+          (end (or (next-single-property-change
+                    (point) 'display)
+                   (point)))
+          (inhibit-modification-hooks t)
+          (inhibit-read-only t)
+	  (buffer-undo-list t)
+	  (modified (buffer-modified-p)))
+      (remove-list-of-text-properties
+       beg end '(display help-echo mouse-face help-echo keymap))
+      (set-buffer-modified-p modified))))
 
 ;;;###autoload
 (defun zrgrep (regexp &optional files dir confirm template)
@@ -1235,8 +1230,6 @@ file name to `*.gz', and sets `grep-highlight-matches' to `always'."
 	   (grep-find-template nil)
 	   (grep-find-command nil)
 	   (grep-host-defaults-alist nil)
-           ;; `zgrep' doesn't support the `--null' option.
-	   (grep-use-null-filename-separator nil)
 	   ;; Use for `grep-read-files'
 	   (grep-files-aliases '(("all" . "* .*")
 				 ("gz"  . "*.gz"))))
diff --git a/lisp/progmodes/gud.el b/lisp/progmodes/gud.el
index 2664d03e72..72f5769558 100644
--- a/lisp/progmodes/gud.el
+++ b/lisp/progmodes/gud.el
@@ -378,7 +378,6 @@ we're in the GUD buffer)."
        (if (not gud-running)
 	 ,(if (stringp cmd)
 	      `(gud-call ,cmd arg)
-	    ;; Unused lexical warning if cmd does not use "arg".
 	    cmd))))
      ,(if key `(local-set-key ,(concat "\C-c" key) ',func))
      ,(if key `(global-set-key (vconcat gud-key-prefix ,key) ',func))))
@@ -772,7 +771,7 @@ the buffer in which this command was invoked."
   (gud-def gud-cont   "cont"     "\C-r" "Continue with display.")
   (gud-def gud-finish "finish"   "\C-f" "Finish executing current function.")
   (gud-def gud-jump
-	   (progn (gud-call "tbreak %f:%l" arg) (gud-call "jump %f:%l"))
+	   (progn (gud-call "tbreak %f:%l") (gud-call "jump %f:%l"))
 	   "\C-j" "Set execution address to current line.")
 
   (gud-def gud-up     "up %p"     "<" "Up N stack frames (numeric arg).")
@@ -3397,6 +3396,9 @@ it if ARG is omitted or nil."
 	(kill-local-variable 'gdb-define-alist)
 	(remove-hook 'after-save-hook 'gdb-create-define-alist t))))
 
+(define-obsolete-variable-alias 'tooltip-gud-modes
+                                'gud-tooltip-modes "22.1")
+
 (defcustom gud-tooltip-modes '(gud-mode c-mode c++-mode fortran-mode
 					python-mode)
   "List of modes for which to enable GUD tooltips."
@@ -3404,6 +3406,9 @@ it if ARG is omitted or nil."
   :group 'gud
   :group 'tooltip)
 
+(define-obsolete-variable-alias 'tooltip-gud-display
+                                'gud-tooltip-display "22.1")
+
 (defcustom gud-tooltip-display
   '((eq (tooltip-event-buffer gud-tooltip-event)
 	(marker-buffer gud-overlay-arrow-position)))
@@ -3495,6 +3500,8 @@ With arg, dereference expr if ARG is positive, otherwise do not dereference."
   (message "Dereferencing is now %s."
 	   (if gud-tooltip-dereference "on" "off")))
 
+(define-obsolete-function-alias 'tooltip-gud-toggle-dereference
+                                'gud-tooltip-dereference "22.1")
 (defvar tooltip-use-echo-area)
 (declare-function tooltip-show "tooltip" (text &optional use-echo-area))
 (declare-function tooltip-strip-prompt "tooltip" (process output))
diff --git a/lisp/progmodes/idlw-help.el b/lisp/progmodes/idlw-help.el
index 54e740be11..cbdca015e9 100644
--- a/lisp/progmodes/idlw-help.el
+++ b/lisp/progmodes/idlw-help.el
@@ -1181,10 +1181,9 @@ Useful when source code is displayed as help.  See the option
 	(with-syntax-table idlwave-mode-syntax-table
           (set (make-local-variable 'font-lock-defaults)
                idlwave-font-lock-defaults)
-          (if (fboundp 'font-lock-ensure) ; Emacs >= 25.1
+          (if (fboundp 'font-lock-ensure)
               (font-lock-ensure)
-            ;; Silence "interactive use only" warning on Emacs >= 25.1.
-            (with-no-warnings (font-lock-fontify-buffer)))))))
+            (font-lock-fontify-buffer))))))
 
 
 (defun idlwave-help-error (name type class keyword)
diff --git a/lisp/progmodes/meta-mode.el b/lisp/progmodes/meta-mode.el
index e207d22ff4..7d20e02d80 100644
--- a/lisp/progmodes/meta-mode.el
+++ b/lisp/progmodes/meta-mode.el
@@ -47,8 +47,8 @@
 ;; `metafont-mode-hook' and `metapost-mode-hook' which apply to the
 ;; individual modes.  In addition, there are several variables and
 ;; regexps controlling e.g. the behavior of the indentation function,
-;; which may be customized.  Please refer to the docstrings in the code
-;; below for details.
+;; which may be customized via `edit-options'.  Please refer to the
+;; docstrings in the code below for details.
 
 ;; Availability:
 ;;
diff --git a/lisp/progmodes/octave.el b/lisp/progmodes/octave.el
index f5d764e16c..c768d8d6f4 100644
--- a/lisp/progmodes/octave.el
+++ b/lisp/progmodes/octave.el
@@ -1165,8 +1165,6 @@ q: Don't fix\n" func file))
   "Face used to highlight function comment block.")
 
 (eval-when-compile (require 'texinfo))
-;; Undo the effects of texinfo loading tex-mode loading compile.
-(declare-function compilation-forget-errors "compile" ())
 
 (defun octave-font-lock-texinfo-comment ()
   (let ((kws
diff --git a/lisp/progmodes/pascal.el b/lisp/progmodes/pascal.el
index 58dc213d8a..83f15d495b 100644
--- a/lisp/progmodes/pascal.el
+++ b/lisp/progmodes/pascal.el
@@ -1403,6 +1403,7 @@ The default is a name found in the buffer around point."
     map)
   "Keymap used in Pascal Outline mode.")
 
+(define-obsolete-function-alias 'pascal-outline 'pascal-outline-mode "22.1")
 (define-minor-mode pascal-outline-mode
   "Outline-line minor mode for Pascal mode.
 With a prefix argument ARG, enable the mode if ARG is positive,
@@ -1424,7 +1425,7 @@ Pascal Outline mode provides some additional commands.
 \\[pascal-show-all]\t- Show the whole buffer.
 \\[pascal-hide-other-defuns]\
 \t- Hide everything but the current function (function under the cursor).
-\\[pascal-outline-mode]\t- Leave Pascal Outline mode."
+\\[pascal-outline]\t- Leave Pascal Outline mode."
   :init-value nil :lighter " Outl" :keymap pascal-outline-map
   (add-to-invisibility-spec '(pascal . t))
   (unless pascal-outline-mode
diff --git a/lisp/progmodes/perl-mode.el b/lisp/progmodes/perl-mode.el
index e667a97015..99480788f5 100644
--- a/lisp/progmodes/perl-mode.el
+++ b/lisp/progmodes/perl-mode.el
@@ -165,7 +165,7 @@
     ;; Fontify function and package names in declarations.
     ("\\<\\(package\\|sub\\)\\>[ \t]*\\(\\sw+\\)?"
      (1 font-lock-keyword-face) (2 font-lock-function-name-face nil t))
-    ("\\(^\\|[^$@%&\\]\\)\\<\\(import\\|no\\|require\\|use\\)\\>[ \t]*\\(\\sw+\\)?"
+    ("\\<\\(import\\|no\\|require\\|use\\)\\>[ \t]*\\(\\sw+\\)?"
      (1 font-lock-keyword-face) (2 font-lock-constant-face nil t)))
   "Subdued level highlighting for Perl mode.")
 
@@ -745,6 +745,8 @@ Turning on Perl mode runs the normal hook `perl-mode-hook'."
       0					;Existing comment at bol stays there.
     comment-column))
 
+(define-obsolete-function-alias 'electric-perl-terminator
+  'perl-electric-terminator "22.1")
 (defun perl-electric-noindent-p (_char)
   ;; To reproduce the old behavior, ;, {, }, and : are made electric, but
   ;; we only want them to be electric at EOL.
diff --git a/lisp/progmodes/python.el b/lisp/progmodes/python.el
index afafd1b42c..142e6eb3f3 100644
--- a/lisp/progmodes/python.el
+++ b/lisp/progmodes/python.el
@@ -647,15 +647,15 @@ The type returned can be `comment', `string' or `paren'."
    ((python-rx string-delimiter)
     (0 (ignore (python-syntax-stringify))))))
 
-(define-obsolete-variable-alias 'python--prettify-symbols-alist
-  'python-prettify-symbols-alist "26.1")
-
 (defvar python-prettify-symbols-alist
   '(("lambda"  . ?λ)
     ("and" . ?∧)
     ("or" . ?∨))
   "Value for `prettify-symbols-alist' in `python-mode'.")
 
+(define-obsolete-variable-alias 'python--prettify-symbols-alist
+  'python-prettify-symbols-alist "26.1")
+
 (defsubst python-syntax-count-quotes (quote-char &optional point limit)
   "Count number of quotes around point (max is 3).
 QUOTE-CHAR is the quote char to count.  Optional argument POINT is
@@ -1520,7 +1520,7 @@ of the statement."
                        ;; narrowing.
                        (cl-assert (> string-start last-string-end)
                                   :show-args
-                                  "\
+                                  "
 Overlapping strings detected (start=%d, last-end=%d)")
                        (goto-char string-start)
                        (if (python-syntax-context 'paren)
@@ -3196,10 +3196,10 @@ t when called interactively."
                      (insert-file-contents
                       (or temp-file-name file-name))
                      (python-info-encoding)))
-         (file-name (file-local-name (expand-file-name file-name)))
+         (file-name (expand-file-name (file-local-name file-name)))
          (temp-file-name (when temp-file-name
-                           (file-local-name (expand-file-name
-                                             temp-file-name)))))
+                           (expand-file-name
+                            (file-local-name temp-file-name)))))
     (python-shell-send-string
      (format
       (concat
@@ -5299,7 +5299,6 @@ REPORT-FN is Flymake's callback function."
     (save-excursion (insert (make-string 2 last-command-event)))))
 
 (defvar electric-indent-inhibit)
-(defvar prettify-symbols-alist)
 
 ;;;###autoload
 (define-derived-mode python-mode prog-mode "Python"
@@ -5394,8 +5393,10 @@ REPORT-FN is Flymake's callback function."
            "`outline-level' function for Python mode."
            (1+ (/ (current-indentation) python-indent-offset))))
 
-  (set (make-local-variable 'prettify-symbols-alist)
-       python-prettify-symbols-alist)
+  (when (and (boundp 'prettify-symbols-alist)
+             (boundp 'python--prettify-symbols-alist))
+    (set (make-local-variable 'prettify-symbols-alist)
+         python--prettify-symbols-alist))
 
   (python-skeleton-add-menu-items)
 
diff --git a/lisp/progmodes/sql.el b/lisp/progmodes/sql.el
index 9bb2cf4bdf..d20c579f66 100644
--- a/lisp/progmodes/sql.el
+++ b/lisp/progmodes/sql.el
@@ -4406,8 +4406,7 @@ The default comes from `process-coding-system-alist' and
                            (or coding 'utf-8))
                     (when (string-match (format "\\.%s\\'" (car cs)) nlslang)
                       (setq coding (cdr cs)))))
-    (set-process-coding-system (get-buffer-process (current-buffer))
-                               coding coding)))
+    (set-buffer-process-coding-system coding coding)))
 
 (defun sql-oracle-save-settings (sqlbuf)
   "Save most SQL*Plus settings so they may be reset by \\[sql-redirect]."
diff --git a/lisp/progmodes/verilog-mode.el b/lisp/progmodes/verilog-mode.el
index 6657761902..48dee4bef3 100644
--- a/lisp/progmodes/verilog-mode.el
+++ b/lisp/progmodes/verilog-mode.el
@@ -3966,9 +3966,7 @@ Key bindings specific to `verilog-mode-map' are:
             #'verilog-completion-at-point nil 'local)
 
   ;; Stuff for autos
-  (add-hook (if (boundp 'write-contents-hooks) 'write-contents-hooks
-	      'write-contents-functions) ; Emacs >= 22.1
-	    'verilog-auto-save-check nil 'local)
+  (add-hook 'write-contents-hooks 'verilog-auto-save-check nil 'local)
   ;; verilog-mode-hook call added by define-derived-mode
   )
 
diff --git a/lisp/progmodes/vhdl-mode.el b/lisp/progmodes/vhdl-mode.el
index f6cb2419de..a841f87f3c 100644
--- a/lisp/progmodes/vhdl-mode.el
+++ b/lisp/progmodes/vhdl-mode.el
@@ -4953,8 +4953,8 @@ Key bindings:
 (defun vhdl-write-file-hooks-init ()
   "Add/remove hooks when buffer is saved."
   (if vhdl-modify-date-on-saving
-      (add-hook 'write-file-functions 'vhdl-template-modify-noerror nil t)
-    (remove-hook 'write-file-functions 'vhdl-template-modify-noerror t))
+      (add-hook 'local-write-file-hooks 'vhdl-template-modify-noerror nil t)
+    (remove-hook 'local-write-file-hooks 'vhdl-template-modify-noerror t))
   (if (featurep 'xemacs) (make-local-hook 'after-save-hook))
   (add-hook 'after-save-hook 'vhdl-add-modified-file nil t))
 
diff --git a/lisp/progmodes/xref.el b/lisp/progmodes/xref.el
index 5a9a7a925a..e0f5b2d367 100644
--- a/lisp/progmodes/xref.el
+++ b/lisp/progmodes/xref.el
@@ -501,9 +501,8 @@ SELECT is `quit', also quit the *xref* window."
              (xref-buffer (current-buffer)))
         (cond (select
                (if (eq select 'quit) (quit-window nil nil))
-               (select-window
-                (with-current-buffer xref-buffer
-                  (xref--show-pos-in-buf marker buf))))
+               (with-current-buffer xref-buffer
+                 (select-window (xref--show-pos-in-buf marker buf))))
               (t
                (save-selected-window
                  (xref--with-dedicated-window
@@ -693,10 +692,6 @@ references displayed in the current *xref* buffer."
     (dotimes (_ n)
       (setq xref (xref--search-property 'xref-item backward)))
     (cond (xref
-           ;; Save the current position (when the buffer is visible,
-           ;; it gets reset to that window's point from time to time).
-           (let ((win (get-buffer-window (current-buffer))))
-             (and win (set-window-point win (point))))
            (xref--show-location (xref-item-location xref) t))
           (t
            (error "No %s xref" (if backward "previous" "next"))))))
diff --git a/lisp/recentf.el b/lisp/recentf.el
index c3c4e45922..b33f22d959 100644
--- a/lisp/recentf.el
+++ b/lisp/recentf.el
@@ -228,6 +228,10 @@ This item will replace the \"More...\" item."
   :group 'recentf
   :type 'boolean)
 
+(define-obsolete-variable-alias 'recentf-menu-append-commands-p
+                                'recentf-menu-append-commands-flag
+                                "22.1")
+
 (defcustom recentf-menu-append-commands-flag t
   "Non-nil means to append command items to the menu."
   :group 'recentf
diff --git a/lisp/savehist.el b/lisp/savehist.el
index 0a261b0b0c..fbb5f53390 100644
--- a/lisp/savehist.el
+++ b/lisp/savehist.el
@@ -204,6 +204,29 @@ histories, which is probably undesirable."
 	 (signal (car errvar) (cdr errvar)))))
     (savehist-install)))
 
+(defun savehist-load ()
+  "Load the variables stored in `savehist-file' and turn on Savehist mode.
+If `savehist-file' is in the old format that doesn't record
+the value of `savehist-minibuffer-history-variables', that
+value is deducted from the contents of the file."
+  (declare (obsolete savehist-mode "22.1"))
+  (savehist-mode 1)
+  ;; Old versions of savehist distributed with XEmacs didn't save
+  ;; savehist-minibuffer-history-variables.  If that variable is nil
+  ;; after loading the file, try to intuit the intended value.
+  (when (null savehist-minibuffer-history-variables)
+    (setq savehist-minibuffer-history-variables
+          (with-temp-buffer
+	    (ignore-errors
+	      (insert-file-contents savehist-file))
+            (let ((vars ()) form)
+              (while (setq form (condition-case nil
+				    (read (current-buffer)) (error nil)))
+		;; Each form read is of the form (setq VAR VALUE).
+		;; Collect VAR, i.e. (nth form 1).
+                (push (nth 1 form) vars))
+              vars)))))
+
 (defun savehist-install ()
   "Hook Savehist into Emacs.
 Normally invoked by calling `savehist-mode' to set the minor mode.
diff --git a/lisp/server.el b/lisp/server.el
index ff03cbe622..a892203c24 100644
--- a/lisp/server.el
+++ b/lisp/server.el
@@ -188,13 +188,6 @@ space (this means characters from ! to ~; or from code 33 to
   :group 'server
   :type 'hook)
 
-(defcustom server-after-make-frame-hook nil
-  "Hook run when the Emacs server creates a client frame.
-The created frame is selected when the hook is called."
-  :group 'server
-  :type 'hook
-  :version "27.1")
-
 (defcustom server-done-hook nil
   "Hook run when done editing a buffer for the Emacs server."
   :group 'server
@@ -1343,11 +1336,9 @@ The following commands are accepted by the client:
            ((or isearch-mode (minibufferp))
             nil)
            ((and frame (null buffers))
-            (run-hooks 'server-after-make-frame-hook)
             (message "%s" (substitute-command-keys
                            "When done with this frame, type \\[delete-frame]")))
            ((not (null buffers))
-            (run-hooks 'server-after-make-frame-hook)
             (server-switch-buffer (car buffers) nil (cdr (car files)))
             (run-hooks 'server-switch-hook)
             (unless nowait
diff --git a/lisp/ses.el b/lisp/ses.el
index bcf8bdb636..9097bf5d81 100644
--- a/lisp/ses.el
+++ b/lisp/ses.el
@@ -2495,7 +2495,7 @@ to are recalculated first."
          prefix-length)
     (when (and prefix (null (string= prefix "")))
       (setq prefix-length (length prefix))
-      (maphash (lambda (key _val)
+      (maphash (lambda (key val)
                  (let ((key-name (symbol-name key)))
                    (when (and (>= (length key-name) prefix-length)
                               (string= prefix (substring key-name 0 prefix-length)))
@@ -2648,7 +2648,7 @@ cells."
          prefix-length)
     (when prefix
       (setq prefix-length (length prefix))
-      (maphash (lambda (key _val)
+      (maphash (lambda (key val)
                  (let ((key-name (symbol-name key)))
                    (when (and (>= (length key-name) prefix-length)
                               (string= prefix (substring key-name 0 prefix-length)))
diff --git a/lisp/simple.el b/lisp/simple.el
index 65108250ea..edcb73ce2e 100644
--- a/lisp/simple.el
+++ b/lisp/simple.el
@@ -123,12 +123,6 @@ similar mode is started, or when it is used with \\[next-error]
 or \\[compile-goto-error].")
 (make-variable-buffer-local 'next-error-last-buffer)
 
-;; next-error-last-buffer is made buffer-local to keep the reference
-;; to the parent buffer used to navigate to the current buffer, so the
-;; next call of next-buffer will use the same parent buffer to
-;; continue navigation from it.
-(make-variable-buffer-local 'next-error-last-buffer)
-
 (defvar next-error-function nil
   "Function to use to find the next error in the current buffer.
 The function is called with 2 parameters:
@@ -1131,7 +1125,6 @@ the actual saved text might be different from what was killed."
 
 (defun mark-whole-buffer ()
   "Put point at beginning and mark at end of buffer.
-Also push mark at point before pushing mark at end of buffer.
 If narrowing is in effect, only uses the accessible part of the buffer.
 You probably should not use this function in Lisp programs;
 it is usually a mistake for a Lisp function to use any subroutine
diff --git a/lisp/speedbar.el b/lisp/speedbar.el
index a231163715..7915a52df3 100644
--- a/lisp/speedbar.el
+++ b/lisp/speedbar.el
@@ -637,6 +637,9 @@ Created from `speedbar-ignored-directory-expressions' with the function
 Use the function `speedbar-add-ignored-directory-regexp', or customize the
 variable `speedbar-ignored-directory-expressions' to modify this variable.")
 
+(define-obsolete-variable-alias 'speedbar-ignored-path-expressions
+  'speedbar-ignored-directory-expressions "22.1")
+
 (defcustom speedbar-ignored-directory-expressions
   '("[/\\]logs?[/\\]\\'")
   "List of regular expressions matching directories speedbar will ignore.
@@ -4074,6 +4077,26 @@ TEXT is the buffer's name, TOKEN and INDENT are unused."
 	 (setq font-lock-global-modes (delq 'speedbar-mode
 					    font-lock-global-modes)))))
 
+;;; Obsolete variables and functions
+
+(define-obsolete-variable-alias
+  'speedbar-ignored-path-regexp 'speedbar-ignored-directory-regexp "22.1")
+
+(define-obsolete-function-alias 'speedbar-add-ignored-path-regexp
+  'speedbar-add-ignored-directory-regexp "22.1")
+
+(define-obsolete-function-alias 'speedbar-line-path
+  'speedbar-line-directory "22.1")
+
+(define-obsolete-function-alias 'speedbar-buffers-line-path
+  'speedbar-buffers-line-directory "22.1")
+
+(define-obsolete-function-alias 'speedbar-path-line
+  'speedbar-directory-line "22.1")
+
+(define-obsolete-function-alias 'speedbar-buffers-line-path
+  'speedbar-buffers-line-directory "22.1")
+
 (provide 'speedbar)
 
 ;; run load-time hooks
diff --git a/lisp/subr.el b/lisp/subr.el
index 113bd978b6..056392a926 100644
--- a/lisp/subr.el
+++ b/lisp/subr.el
@@ -680,6 +680,20 @@ If TEST is omitted or nil, `equal' is used."
       (setq tail (cdr tail)))
     value))
 
+(defun assoc-ignore-case (key alist)
+  "Like `assoc', but ignores differences in case and text representation.
+KEY must be a string.  Upper-case and lower-case letters are treated as equal.
+Unibyte strings are converted to multibyte for comparison."
+  (declare (obsolete assoc-string "22.1"))
+  (assoc-string key alist t))
+
+(defun assoc-ignore-representation (key alist)
+  "Like `assoc', but ignores differences in text representation.
+KEY must be a string.
+Unibyte strings are converted to multibyte for comparison."
+  (declare (obsolete assoc-string "22.1"))
+  (assoc-string key alist nil))
+
 (defun member-ignore-case (elt list)
   "Like `member', but ignore differences in case and text representation.
 ELT must be a string.  Upper-case and lower-case letters are treated as equal.
@@ -1449,6 +1463,12 @@ be a list of the form returned by `event-start' and `event-end'."
   (declare (obsolete log "24.4"))
   (log x 10))
 
+;; These are used by VM and some old programs
+(defalias 'focus-frame 'ignore "")
+(make-obsolete 'focus-frame "it does nothing." "22.1")
+(defalias 'unfocus-frame 'ignore "")
+(make-obsolete 'unfocus-frame "it does nothing." "22.1")
+
 (set-advertised-calling-convention
  'all-completions '(string collection &optional predicate) "23.1")
 (set-advertised-calling-convention 'unintern '(name obarray) "23.3")
@@ -1471,6 +1491,11 @@ be a list of the form returned by `event-start' and `event-end'."
 (make-obsolete-variable 'command-debug-status
                         "expect it to be removed in a future version." "25.2")
 
+(define-obsolete-variable-alias 'x-lost-selection-hooks
+  'x-lost-selection-functions "22.1")
+(define-obsolete-variable-alias 'x-sent-selection-hooks
+  'x-sent-selection-functions "22.1")
+
 ;; This was introduced in 21.4 for pre-unicode unification.  That
 ;; usage was rendered obsolete in 23.1 which uses Unicode internally.
 ;; Other uses are possible, so this variable is not _really_ obsolete,
@@ -2148,6 +2173,19 @@ process."
        (memq (process-status process)
 	     '(run open listen connect stop))))
 
+;; compatibility
+
+(defun process-kill-without-query (process &optional _flag)
+  "Say no query needed if PROCESS is running when Emacs is exited.
+Optional second argument if non-nil says to require a query.
+Value is t if a query was formerly required."
+  (declare (obsolete
+            "use `process-query-on-exit-flag' or `set-process-query-on-exit-flag'."
+            "22.1"))
+  (let ((old (process-query-on-exit-flag process)))
+    (set-process-query-on-exit-flag process nil)
+    old))
+
 (defun process-kill-buffer-query-function ()
   "Ask before killing a buffer that has a running process."
   (let ((process (get-buffer-process (current-buffer))))
diff --git a/lisp/term.el b/lisp/term.el
index 91eab771cf..a0313d88da 100644
--- a/lisp/term.el
+++ b/lisp/term.el
@@ -487,7 +487,7 @@ inconsistent with the state of the terminal understood by the
 inferior process.  Only the process filter is allowed to make
 changes to the buffer.
 
-Customize this option to nil if you want the previous behavior."
+Customize this option to nil if you want the previous behaviour."
   :version "26.1"
   :type 'boolean
   :group 'term)
@@ -508,7 +508,7 @@ commands can be invoked on the mouse-selected point or region,
 until the process filter (or user) moves point to the process
 mark once again.
 
-Customize this option to nil if you want the previous behavior."
+Customize this option to nil if you want the previous behaviour."
   :version "26.1"
   :type 'boolean
   :group 'term)
@@ -598,8 +598,8 @@ This is run before the process is cranked up."
   "Called each time a process is exec'd by `term-exec'.
 This is called after the process is cranked up.  It is useful for things that
 must be done each time a process is executed in a term mode buffer (e.g.,
-`set-process-query-on-exit-flag').  In contrast, `term-mode-hook' is only
-executed once, when the buffer is created."
+`process-kill-without-query').  In contrast, `term-mode-hook' is only
+executed once when the buffer is created."
   :type 'hook
   :group 'term)
 
@@ -2891,11 +2891,9 @@ See `term-prompt-regexp'."
                 ;; If the last char was written in last column,
                 ;; back up one column, but remember we did so.
                 ;; Thus we emulate xterm/vt100-style line-wrapping.
-                (when (eq (term-current-column) term-width)
-                  (term-move-columns -1)
-                  ;; We check after ctrl sequence handling if point
-                  ;; was moved (and leave line-wrapping state if so).
-                  (setq term-do-line-wrapping (point)))
+                (cond ((eq (term-current-column) term-width)
+                       (term-move-columns -1)
+                       (setq term-do-line-wrapping t)))
                 (setq term-current-column nil)
                 (setq i funny))
               (pcase-exhaustive (and (<= ctl-end str-length) (aref str i))
@@ -2995,9 +2993,6 @@ See `term-prompt-regexp'."
                      (substring str i ctl-end)))))
                 ;; Ignore NUL, Shift Out, Shift In.
                 ((or ?\0 #xE #xF 'nil) nil))
-              ;; Leave line-wrapping state if point was moved.
-              (unless (eq term-do-line-wrapping (point))
-                (setq term-do-line-wrapping nil))
               (if (term-handling-pager)
                   (progn
                     ;; Finish stuff to get ready to handle PAGER.
diff --git a/lisp/term/pc-win.el b/lisp/term/pc-win.el
index e0e412e162..9c1b471d48 100644
--- a/lisp/term/pc-win.el
+++ b/lisp/term/pc-win.el
@@ -272,7 +272,7 @@ Consult the selection.  Treat empty strings as if they were unset."
 (fset 'iconify-or-deiconify-frame 'ignore)
 
 ;; From lisp/frame.el
-(fset 'set-frame-font 'ignore)
+(fset 'set-default-font 'ignore)
 (fset 'set-mouse-color 'ignore)		; We cannot, I think.
 (fset 'set-cursor-color 'ignore)	; Hardware determined by char under.
 (fset 'set-border-color 'ignore)	; Not useful.
diff --git a/lisp/textmodes/flyspell.el b/lisp/textmodes/flyspell.el
index e462669626..d87cb5e72e 100644
--- a/lisp/textmodes/flyspell.el
+++ b/lisp/textmodes/flyspell.el
@@ -1944,10 +1944,6 @@ spell-check."
       (call-interactively flyspell--prev-meta-tab-binding)
     (let ((pos     (point))
           (old-max (point-max)))
-      ;; Flush a possibly stale cache from previous invocations of
-      ;; flyspell-auto-correct-word.
-      (if (not (eq last-command 'flyspell-auto-correct-word))
-          (setq flyspell-auto-correct-region nil))
       ;; Use the correct dictionary.
       (flyspell-accept-buffer-local-defs)
       (if (and (eq flyspell-auto-correct-pos pos)
diff --git a/lisp/textmodes/nroff-mode.el b/lisp/textmodes/nroff-mode.el
index 6955ed25e1..9c846292f1 100644
--- a/lisp/textmodes/nroff-mode.el
+++ b/lisp/textmodes/nroff-mode.el
@@ -328,6 +328,13 @@ otherwise off."
 	(kill-buffer viewbuf))
     (Man-getpage-in-background file)))
 
+;; Old names that were not namespace clean.
+(define-obsolete-function-alias 'count-text-lines 'nroff-count-text-lines "22.1")
+(define-obsolete-function-alias 'forward-text-line 'nroff-forward-text-line "22.1")
+(define-obsolete-function-alias 'backward-text-line 'nroff-backward-text-line "22.1")
+(define-obsolete-function-alias 'electric-nroff-newline 'nroff-electric-newline "22.1")
+(define-obsolete-function-alias 'electric-nroff-mode 'nroff-electric-mode "22.1")
+
 (provide 'nroff-mode)
 
 ;;; nroff-mode.el ends here
diff --git a/lisp/textmodes/reftex-toc.el b/lisp/textmodes/reftex-toc.el
index 9c158a5f56..6637da4b14 100644
--- a/lisp/textmodes/reftex-toc.el
+++ b/lisp/textmodes/reftex-toc.el
@@ -1096,7 +1096,7 @@ always show the current section in connection with the option
       (when (eq reftex-auto-recenter-toc 'frame)
         (unless reftex-toc-auto-recenter-timer
           (reftex-toggle-auto-toc-recenter))
-        (add-hook 'delete-frame-functions 'reftex-toc-delete-frame-hook)))))
+        (add-hook 'delete-frame-hook 'reftex-toc-delete-frame-hook)))))
 
 (defun reftex-toc-delete-frame-hook (frame)
   (if (and reftex-toc-auto-recenter-timer
diff --git a/lisp/url/url-auth.el b/lisp/url/url-auth.el
index 67e701ecb1..4f7b544674 100644
--- a/lisp/url/url-auth.el
+++ b/lisp/url/url-auth.el
@@ -194,7 +194,7 @@ key cache `url-digest-auth-storage'."
   (base64-encode-string
    (apply 'format "%016x%04x%04x%05x%05x" (random) (current-time)) t))
 
-(defun url-digest-auth-nonce-count (_nonce)
+(defun url-digest-auth-nonce-count (nonce)
   "The number requests sent to server with the given NONCE.
 This count includes the request we're preparing here.
 
diff --git a/lisp/url/url-handlers.el b/lisp/url/url-handlers.el
index 7d0320cb5b..1fe0af65ff 100644
--- a/lisp/url/url-handlers.el
+++ b/lisp/url/url-handlers.el
@@ -41,9 +41,6 @@
 (declare-function mm-decode-string "mm-bodies" (string charset))
 ;; mm-decode loads mail-parse.
 (declare-function mail-content-type-get "mail-parse" (ct attribute))
-;; mm-decode loads mm-bodies, which loads mm-util.
-(declare-function mm-charset-to-coding-system "mm-util"
-                 (charset &optional lbt allow-override silent))
 
 ;; Implementation status
 ;; ---------------------
diff --git a/lisp/vc/add-log.el b/lisp/vc/add-log.el
index 175c82f8c0..bc2be4aadb 100644
--- a/lisp/vc/add-log.el
+++ b/lisp/vc/add-log.el
@@ -898,7 +898,7 @@ non-nil, otherwise in local time."
              (insert (if use-hard-newlines hard-newline "\n")
                      (if use-hard-newlines hard-newline "\n"))
              (forward-line -2)
-             (indent-relative-first-indent-point))
+             (indent-relative-maybe))
             (t
              ;; Make a new item.
              (while (looking-at "\\sW")
diff --git a/lisp/vc/ediff-merg.el b/lisp/vc/ediff-merg.el
index b67f520ca0..ad72d7570c 100644
--- a/lisp/vc/ediff-merg.el
+++ b/lisp/vc/ediff-merg.el
@@ -194,7 +194,7 @@ Buffer B."
 
 (defun ediff-set-merge-mode ()
   (normal-mode t)
-  (remove-hook 'write-file-functions 'ediff-set-merge-mode t))
+  (remove-hook 'local-write-file-hooks 'ediff-set-merge-mode))
 
 
 ;; Go over all diffs starting with DIFF-NUM and copy regions into buffer C
diff --git a/lisp/vc/ediff-util.el b/lisp/vc/ediff-util.el
index 1158b7146e..8670ba4603 100644
--- a/lisp/vc/ediff-util.el
+++ b/lisp/vc/ediff-util.el
@@ -347,7 +347,7 @@ to invocation.")
 	      (goto-char (point-min))
 	      (funcall (ediff-with-current-buffer buf major-mode))
 	      (widen) ; merge buffer is always widened
-	      (add-hook 'write-file-functions 'ediff-set-merge-mode nil t)
+	      (add-hook 'local-write-file-hooks 'ediff-set-merge-mode nil t)
 	      )))
       (setq buffer-read-only nil
 	    ediff-buffer-A buffer-A
@@ -778,8 +778,8 @@ Reestablish the default window display."
 	  (select-frame-set-input-focus ediff-control-frame)
 	(raise-frame ediff-control-frame)
 	(select-frame ediff-control-frame)
-	(and (featurep 'xemacs) (fboundp 'focus-frame)
-	     (focus-frame ediff-control-frame))))
+	(if (fboundp 'focus-frame)
+	    (focus-frame ediff-control-frame))))
 
   ;; Redisplay whatever buffers are showing, if there is a selected difference
   (let ((control-frame ediff-control-frame)
diff --git a/lisp/vc/log-edit.el b/lisp/vc/log-edit.el
index 6ff782a606..89b6201bab 100644
--- a/lisp/vc/log-edit.el
+++ b/lisp/vc/log-edit.el
@@ -203,7 +203,10 @@ when this variable is set to nil.")
 
 (defconst log-edit-maximum-comment-ring-size 32
   "Maximum number of saved comments in the comment ring.")
+(define-obsolete-variable-alias 'vc-comment-ring 'log-edit-comment-ring "22.1")
 (defvar log-edit-comment-ring (make-ring log-edit-maximum-comment-ring-size))
+(define-obsolete-variable-alias 'vc-comment-ring-index
+  'log-edit-comment-ring-index "22.1")
 (defvar log-edit-comment-ring-index nil)
 (defvar log-edit-last-comment-match "")
 
@@ -308,6 +311,13 @@ automatically."
     (or (eobp) (looking-at "\n\n")
 	(insert "\n"))))
 
+;; Compatibility with old names.
+(define-obsolete-function-alias 'vc-previous-comment 'log-edit-previous-comment "22.1")
+(define-obsolete-function-alias 'vc-next-comment 'log-edit-next-comment "22.1")
+(define-obsolete-function-alias 'vc-comment-search-reverse 'log-edit-comment-search-backward "22.1")
+(define-obsolete-function-alias 'vc-comment-search-forward 'log-edit-comment-search-forward "22.1")
+(define-obsolete-function-alias 'vc-comment-to-change-log 'log-edit-comment-to-change-log "22.1")
+
 ;;;
 ;;; Actual code
 ;;;
diff --git a/lisp/vc/pcvs-info.el b/lisp/vc/pcvs-info.el
index edcfc6e6c4..7e72767055 100644
--- a/lisp/vc/pcvs-info.el
+++ b/lisp/vc/pcvs-info.el
@@ -39,6 +39,9 @@
 ;;;; config variables
 ;;;;
 
+(define-obsolete-variable-alias 'cvs-display-full-path
+    'cvs-display-full-name "22.1")
+
 (defcustom cvs-display-full-name t
   "Specifies how the filenames should be displayed in the listing.
 If non-nil, their full filename name will be displayed, else only the
@@ -208,6 +211,8 @@ to confuse some users sometimes."
       ;; Here, I use `concat' rather than `expand-file-name' because I want
       ;; the resulting path to stay relative if `dir' is relative.
       (concat dir (cvs-fileinfo->file fileinfo)))))
+(define-obsolete-function-alias 'cvs-fileinfo->full-path
+    'cvs-fileinfo->full-name "22.1")
 
 (defun cvs-fileinfo->pp-name (fi)
   "Return the filename of FI as it should be displayed."
diff --git a/lisp/vc/vc-dir.el b/lisp/vc/vc-dir.el
index 18da6e3357..db595331bb 100644
--- a/lisp/vc/vc-dir.el
+++ b/lisp/vc/vc-dir.el
@@ -697,7 +697,7 @@ share the same state."
 (defun vc-dir-unmark ()
   "Unmark the current file or all files in the region.
 If the region is active, unmark all the files in the region.
-Otherwise unmark the file on the current line and move to the next
+Otherwise mark the file on the current line and move to the next
 line."
   (interactive)
   (vc-dir-mark-unmark 'vc-dir-unmark-file))
diff --git a/lisp/vc/vc.el b/lisp/vc/vc.el
index 7646af075f..01dc47e808 100644
--- a/lisp/vc/vc.el
+++ b/lisp/vc/vc.el
@@ -1649,6 +1649,11 @@ to override the value of `vc-diff-switches' and `diff-switches'."
       ;; any switches in diff-switches.
       (when (listp switches) switches))))
 
+;; Old def for compatibility with Emacs-21.[123].
+(defmacro vc-diff-switches-list (backend)
+  (declare (obsolete vc-switches "22.1"))
+  `(vc-switches ',backend 'diff))
+
 (defun vc-diff-finish (buffer messages)
   ;; The empty sync output case has already been handled, so the only
   ;; possibility of an empty output is for an async process.
diff --git a/lisp/w32-fns.el b/lisp/w32-fns.el
index 825420c426..b400c8d4a6 100644
--- a/lisp/w32-fns.el
+++ b/lisp/w32-fns.el
@@ -256,7 +256,7 @@ bit output with no translation."
 
 (when (boundp 'w32-charset-info-alist)
   ;; The last charset we add becomes the "preferred" charset for the return
-  ;; value from x-select-font etc, so list the most important charsets last.
+  ;; value from w32-select-font etc, so list the most important charsets last.
   (w32-add-charset-info "iso8859-14" 'w32-charset-ansi  28604)
   (w32-add-charset-info "iso8859-15" 'w32-charset-ansi  28605)
   ;; The following two are included for pattern matching.
diff --git a/lisp/woman.el b/lisp/woman.el
index c83a04874a..1a603dba2f 100644
--- a/lisp/woman.el
+++ b/lisp/woman.el
@@ -1759,8 +1759,8 @@ Leave point at end of new text.  Return length of inserted text."
 	   (condition-case ()
 	       (insert-file-contents filename nil)
 	     (file-error
-	      ;; Run find-file-not-found-functions until one returns non-nil.
-	      ;; (run-hook-with-args-until-success 'find-file-not-found-functions)
+	      ;; Run find-file-not-found-hooks until one returns non-nil.
+	      ;; (run-hook-with-args-until-success 'find-file-not-found-hooks)
 	      (insert "\n***** File " filename " not found! *****\n\n")))))))
 
 
diff --git a/src/alloc.c b/src/alloc.c
index cc52d66b32..a50bb81409 100644
--- a/src/alloc.c
+++ b/src/alloc.c
@@ -3596,7 +3596,7 @@ struct marker_block
 static struct marker_block *marker_block;
 static int marker_block_index = MARKER_BLOCK_SIZE;
 
-static union Lisp_Misc *misc_free_list;
+static union Lisp_Misc *marker_free_list;
 
 /* Return a newly allocated Lisp_Misc object of specified TYPE.  */
 
@@ -3607,10 +3607,10 @@ allocate_misc (enum Lisp_Misc_Type type)
 
   MALLOC_BLOCK_INPUT;
 
-  if (misc_free_list)
+  if (marker_free_list)
     {
-      XSETMISC (val, misc_free_list);
-      misc_free_list = misc_free_list->u_free.chain;
+      XSETMISC (val, marker_free_list);
+      marker_free_list = marker_free_list->u_free.chain;
     }
   else
     {
@@ -3642,8 +3642,8 @@ void
 free_misc (Lisp_Object misc)
 {
   XMISCANY (misc)->type = Lisp_Misc_Free;
-  XMISC (misc)->u_free.chain = misc_free_list;
-  misc_free_list = XMISC (misc);
+  XMISC (misc)->u_free.chain = marker_free_list;
+  marker_free_list = XMISC (misc);
   consing_since_gc -= sizeof (union Lisp_Misc);
   total_free_markers++;
 }
@@ -6974,7 +6974,7 @@ sweep_misc (void)
   /* Put all unmarked misc's on free list.  For a marker, first
      unchain it from the buffer it points into.  */
 
-  misc_free_list = 0;
+  marker_free_list = 0;
 
   for (mblk = marker_block; mblk; mblk = *mprev)
     {
@@ -7001,8 +7001,8 @@ sweep_misc (void)
                  We could leave the type alone, since nobody checks it,
                  but this might catch bugs faster.  */
               mblk->markers[i].m.u_marker.type = Lisp_Misc_Free;
-              mblk->markers[i].m.u_free.chain = misc_free_list;
-              misc_free_list = &mblk->markers[i].m;
+              mblk->markers[i].m.u_free.chain = marker_free_list;
+              marker_free_list = &mblk->markers[i].m;
               this_free++;
             }
           else
@@ -7019,7 +7019,7 @@ sweep_misc (void)
         {
           *mprev = mblk->next;
           /* Unhook from the free list.  */
-          misc_free_list = mblk->markers[0].m.u_free.chain;
+          marker_free_list = mblk->markers[0].m.u_free.chain;
           lisp_free (mblk);
         }
       else
diff --git a/src/data.c b/src/data.c
index 06604faaae..1bb48722fa 100644
--- a/src/data.c
+++ b/src/data.c
@@ -1290,7 +1290,7 @@ If the base used is not 10, STRING is always parsed as an integer.  */)
   while (*p == ' ' || *p == '\t')
     p++;
 
-  val = string_to_number (p, b, true);
+  val = string_to_number (p, b, 1);
   return NILP (val) ? make_number (0) : val;
 }
 
diff --git a/src/dispextern.h b/src/dispextern.h
index e26947554d..1fea9dc833 100644
--- a/src/dispextern.h
+++ b/src/dispextern.h
@@ -2426,10 +2426,6 @@ struct it
      descent/ascent (line-height property).  Reset after this glyph.  */
   bool_bf constrain_row_ascent_descent_p : 1;
 
-  /* If true, glyphs for line number display were already produced for
-     the current row.  */
-  bool_bf line_number_produced_p : 1;
-
   enum line_wrap_method line_wrap;
 
   /* The ID of the default face to use.  One of DEFAULT_FACE_ID,
@@ -2609,12 +2605,6 @@ struct it
   /* The line number of point's line, or zero if not computed yet.  */
   ptrdiff_t pt_lnum;
 
-  /* Number of pixels to offset tab stops due to width fixup of the
-     first glyph that crosses first_visible_x.  This is only needed on
-     GUI frames, only when display-line-numbers is in effect, and only
-     in hscrolled windows.  */
-  int tab_offset;
-
   /* Left fringe bitmap number (enum fringe_bitmap_type).  */
   unsigned left_user_fringe_bitmap : FRINGE_ID_BITS;
 
diff --git a/src/editfns.c b/src/editfns.c
index 041af87acd..21b8f6104f 100644
--- a/src/editfns.c
+++ b/src/editfns.c
@@ -118,10 +118,14 @@ emacs_mktime_z (timezone_t tz, struct tm *tm)
   return t;
 }
 
-static _Noreturn void
-invalid_time_zone_specification (Lisp_Object zone)
+/* Allocate a timezone, signaling on failure.  */
+static timezone_t
+xtzalloc (char const *name)
 {
-  xsignal2 (Qerror, build_string ("Invalid time zone specification"), zone);
+  timezone_t tz = tzalloc (name);
+  if (!tz)
+    memory_full (SIZE_MAX);
+  return tz;
 }
 
 /* Free a timezone, except do not free the time zone for local time.
@@ -202,27 +206,9 @@ tzlookup (Lisp_Object zone, bool settz)
 	    }
 	}
       else
-	invalid_time_zone_specification (zone);
-
-      new_tz = tzalloc (zone_string);
-
-#if defined __NetBSD_Version__ && __NetBSD_Version__ < 700000000
-      /* NetBSD 6 tzalloc mishandles POSIX TZ strings (Bug#30738).
-	 If possible, fall back on tzdb.  */
-      if (!new_tz && errno != ENOMEM && plain_integer
-	  && XINT (zone) % (60 * 60) == 0)
-	{
-	  sprintf (tzbuf, "Etc/GMT%+"pI"d", - (XINT (zone) / (60 * 60)));
-	  new_tz = tzalloc (zone_string);
-	}
-#endif
-
-      if (!new_tz)
-	{
-	  if (errno == ENOMEM)
-	    memory_full (SIZE_MAX);
-	  invalid_time_zone_specification (zone);
-	}
+	xsignal2 (Qerror, build_string ("Invalid time zone specification"),
+		  zone);
+      new_tz = xtzalloc (zone_string);
     }
 
   if (settz)
@@ -2881,30 +2867,32 @@ styled_format (ptrdiff_t nargs, Lisp_Object *args, bool message)
 		 and with pM inserted for integer formats.
 		 At most two flags F can be specified at once.  */
 	      char convspec[sizeof "%FF.*d" + max (INT_AS_LDBL, pMlen)];
-	      char *f = convspec;
-	      *f++ = '%';
-	      /* MINUS_FLAG and ZERO_FLAG are dealt with later.  */
-	      *f = '+'; f +=  plus_flag;
-	      *f = ' '; f += space_flag;
-	      *f = '#'; f += sharp_flag;
-	      *f++ = '.';
-	      *f++ = '*';
-	      if (float_conversion)
-		{
-		  if (INT_AS_LDBL)
-		    {
-		      *f = 'L';
-		      f += INTEGERP (arg);
-		    }
-		}
-	      else if (conversion != 'c')
-		{
-		  memcpy (f, pMd, pMlen);
-		  f += pMlen;
-		  zero_flag &= ! precision_given;
-		}
-	      *f++ = conversion;
-	      *f = '\0';
+	      {
+		char *f = convspec;
+		*f++ = '%';
+		/* MINUS_FLAG and ZERO_FLAG are dealt with later.  */
+		*f = '+'; f +=  plus_flag;
+		*f = ' '; f += space_flag;
+		*f = '#'; f += sharp_flag;
+                *f++ = '.';
+                *f++ = '*';
+		if (float_conversion)
+		  {
+		    if (INT_AS_LDBL)
+		      {
+			*f = 'L';
+			f += INTEGERP (arg);
+		      }
+		  }
+		else if (conversion != 'c')
+		  {
+		    memcpy (f, pMd, pMlen);
+		    f += pMlen;
+		    zero_flag &= ! precision_given;
+		  }
+		*f++ = conversion;
+		*f = '\0';
+	      }
 
 	      int prec = -1;
 	      if (precision_given)
@@ -2946,20 +2934,29 @@ styled_format (ptrdiff_t nargs, Lisp_Object *args, bool message)
 		}
 	      else if (conversion == 'd' || conversion == 'i')
 		{
+		  /* For float, maybe we should use "%1.0f"
+		     instead so it also works for values outside
+		     the integer range.  */
+		  printmax_t x;
 		  if (INTEGERP (arg))
-		    {
-		      printmax_t x = XINT (arg);
-		      sprintf_bytes = sprintf (sprintf_buf, convspec, prec, x);
-		    }
+		    x = XINT (arg);
 		  else
 		    {
-		      strcpy (f - pMlen - 1, "f");
-		      double x = XFLOAT_DATA (arg);
-		      sprintf_bytes = sprintf (sprintf_buf, convspec, 0, x);
-		      char c0 = sprintf_buf[0];
-		      bool signedp = ! ('0' <= c0 && c0 <= '9');
-		      prec = min (precision, sprintf_bytes - signedp);
+		      double d = XFLOAT_DATA (arg);
+		      if (d < 0)
+			{
+			  x = TYPE_MINIMUM (printmax_t);
+			  if (x < d)
+			    x = d;
+			}
+		      else
+			{
+			  x = TYPE_MAXIMUM (printmax_t);
+			  if (d < x)
+			    x = d;
+			}
 		    }
+		  sprintf_bytes = sprintf (sprintf_buf, convspec, prec, x);
 		}
 	      else
 		{
@@ -2970,19 +2967,22 @@ styled_format (ptrdiff_t nargs, Lisp_Object *args, bool message)
 		  else
 		    {
 		      double d = XFLOAT_DATA (arg);
-		      double uprintmax = TYPE_MAXIMUM (uprintmax_t);
-		      if (! (0 <= d && d < uprintmax + 1))
-			xsignal1 (Qoverflow_error, arg);
-		      x = d;
+		      if (d < 0)
+			x = 0;
+		      else
+			{
+			  x = TYPE_MAXIMUM (uprintmax_t);
+			  if (d < x)
+			    x = d;
+			}
 		    }
 		  sprintf_bytes = sprintf (sprintf_buf, convspec, prec, x);
 		}
 
 	      /* Now the length of the formatted item is known, except it omits
 		 padding and excess precision.  Deal with excess precision
-		 first.  This happens when the format specifies ridiculously
-		 large precision, or when %d or %i formats a float that would
-		 ordinarily need fewer digits than a specified precision.  */
+		 first.  This happens only when the format specifies
+		 ridiculously large precision.  */
 	      ptrdiff_t excess_precision
 		= precision_given ? precision - prec : 0;
 	      ptrdiff_t leading_zeros = 0, trailing_zeros = 0;
@@ -3379,16 +3379,7 @@ transpose_markers (ptrdiff_t start1, ptrdiff_t end1,
     }
 }
 
-DEFUN ("transpose-regions", Ftranspose_regions, Stranspose_regions, 4, 5,
-       "(if (< (length mark-ring) 2)\
-	    (error \"Other region must be marked before transposing two regions\")\
-	  (let* ((num (if current-prefix-arg\
-			 (prefix-numeric-value current-prefix-arg)\
-			0))\
-		 (ring-length (length mark-ring))\
-		 (eltnum (mod num ring-length))\
-		 (eltnum2 (mod (1+ num) ring-length)))\
-	    (list (point) (mark) (elt mark-ring eltnum) (elt mark-ring eltnum2))))",
+DEFUN ("transpose-regions", Ftranspose_regions, Stranspose_regions, 4, 5, 0,
        doc: /* Transpose region STARTR1 to ENDR1 with STARTR2 to ENDR2.
 The regions should not be overlapping, because the size of the buffer is
 never changed in a transposition.
@@ -3396,14 +3387,7 @@ never changed in a transposition.
 Optional fifth arg LEAVE-MARKERS, if non-nil, means don't update
 any markers that happen to be located in the regions.
 
-Transposing beyond buffer boundaries is an error.
-
-Interactively, STARTR1 and ENDR1 are point and mark; STARTR2 and ENDR2
-are the last two marks pushed to the mark ring; LEAVE-MARKERS is nil.
-If a prefix argument N is given, STARTR2 and ENDR2 are the two
-successive marks N entries back in the mark ring.  A negative prefix
-argument instead counts forward from the oldest mark in the mark
-ring.  */)
+Transposing beyond buffer boundaries is an error.  */)
   (Lisp_Object startr1, Lisp_Object endr1, Lisp_Object startr2, Lisp_Object endr2, Lisp_Object leave_markers)
 {
   register ptrdiff_t start1, end1, start2, end2;
diff --git a/src/fns.c b/src/fns.c
index b9854768a2..b45de7d7a2 100644
--- a/src/fns.c
+++ b/src/fns.c
@@ -2923,6 +2923,8 @@ extract_data_from_object (Lisp_Object spec,
 
       record_unwind_current_buffer ();
 
+      CHECK_BUFFER (object);
+
       struct buffer *bp = XBUFFER (object);
       set_buffer_internal (bp);
 
@@ -3044,9 +3046,6 @@ extract_data_from_object (Lisp_Object spec,
 #endif
     }
 
-  if (!STRINGP (object))
-    signal_error ("Invalid object argument",
-		  NILP (object) ? build_string ("nil") : object);
   return SSDATA (object);
 }
 
diff --git a/src/frame.c b/src/frame.c
index 2f0e962a30..33df48cf9d 100644
--- a/src/frame.c
+++ b/src/frame.c
@@ -1318,7 +1318,7 @@ do_switch_frame (Lisp_Object frame, int track, int for_deletion, Lisp_Object nor
   /* We want to make sure that the next event generates a frame-switch
      event to the appropriate frame.  This seems kludgy to me, but
      before you take it out, make sure that evaluating something like
-     (select-window (frame-root-window (make-frame))) doesn't end up
+     (select-window (frame-root-window (new-frame))) doesn't end up
      with your typing being interpreted in the new frame instead of
      the one you're actually typing in.  */
 #ifdef HAVE_WINDOW_SYSTEM
diff --git a/src/lread.c b/src/lread.c
index 49a1bfe54d..1f91947422 100644
--- a/src/lread.c
+++ b/src/lread.c
@@ -2603,7 +2603,7 @@ read_integer (Lisp_Object readcharfun, EMACS_INT radix)
       invalid_syntax (buf);
     }
 
-  return string_to_number (buf, radix, false);
+  return string_to_number (buf, radix, 0);
 }
 
 
@@ -3412,7 +3412,7 @@ read1 (Lisp_Object readcharfun, int *pch, bool first_in_list)
 
 	if (!quoted && !uninterned_symbol)
 	  {
-	    Lisp_Object result = string_to_number (read_buffer, 10, false);
+	    Lisp_Object result = string_to_number (read_buffer, 10, 0);
 	    if (! NILP (result))
 	      return unbind_to (count, result);
 	  }
diff --git a/src/nsterm.m b/src/nsterm.m
index b171a37567..c6e11eca6d 100644
--- a/src/nsterm.m
+++ b/src/nsterm.m
@@ -3487,38 +3487,23 @@ Note that CURSOR_WIDTH is meaningful only for (h)bar cursors.
             {
 	      struct font *font = font_for_underline_metrics (s);
               unsigned long descent = s->y + s->height - s->ybase;
-              unsigned long minimum_offset;
-              BOOL underline_at_descent_line, use_underline_position_properties;
-              Lisp_Object val = buffer_local_value (Qunderline_minimum_offset,
-                                                    s->w->contents);
-              if (INTEGERP (val))
-                minimum_offset = XFASTINT (val);
-              else
-                minimum_offset = 1;
-              val = buffer_local_value (Qx_underline_at_descent_line,
-                                        s->w->contents);
-              underline_at_descent_line = !(NILP (val) || EQ (val, Qunbound));
-              val = buffer_local_value (Qx_use_underline_position_properties,
-                                        s->w->contents);
-              use_underline_position_properties =
-		!(NILP (val) || EQ (val, Qunbound));
 
               /* Use underline thickness of font, defaulting to 1. */
               thickness = (font && font->underline_thickness > 0)
                 ? font->underline_thickness : 1;
 
               /* Determine the offset of underlining from the baseline. */
-              if (underline_at_descent_line)
+              if (x_underline_at_descent_line)
                 position = descent - thickness;
-              else if (use_underline_position_properties
+              else if (x_use_underline_position_properties
                        && font && font->underline_position >= 0)
                 position = font->underline_position;
               else if (font)
                 position = lround (font->descent / 2);
               else
-                position = minimum_offset;
+                position = underline_minimum_offset;
 
-              position = max (position, minimum_offset);
+              position = max (position, underline_minimum_offset);
 
               /* Ensure underlining is not cropped. */
               if (descent <= position)
@@ -9480,8 +9465,6 @@ Nil means use fullscreen the old (< 10.7) way.  The old way works better with
 	       x_use_underline_position_properties,
      doc: /* SKIP: real doc in xterm.c.  */);
   x_use_underline_position_properties = 0;
-  DEFSYM (Qx_use_underline_position_properties,
-	  "x-use-underline-position-properties");
 
   DEFVAR_BOOL ("x-underline-at-descent-line",
 	       x_underline_at_descent_line,
@@ -9492,7 +9475,6 @@ Nil means use fullscreen the old (< 10.7) way.  The old way works better with
 variable `x-use-underline-position-properties', which is usually at the
 baseline level.  The default value is nil.  */);
   x_underline_at_descent_line = 0;
-  DEFSYM (Qx_underline_at_descent_line, "x-underline-at-descent-line");
 
   /* Tell Emacs about this window system.  */
   Fprovide (Qns, Qnil);
diff --git a/src/print.c b/src/print.c
index a8bbb9d37a..b3c0f6f38f 100644
--- a/src/print.c
+++ b/src/print.c
@@ -313,25 +313,6 @@ printchar (unsigned int ch, Lisp_Object fun)
     }
 }
 
-/* Output an octal escape for C.  If C is less than '\100' consult the
-   following character (if any) to see whether to use three octal
-   digits to avoid misinterpretation of the next character.  The next
-   character after C will be taken from DATA, starting at byte
-   location I, if I is less than SIZE.  Use PRINTCHARFUN to output
-   each character.  */
-
-static void
-octalout (unsigned char c, unsigned char *data, ptrdiff_t i, ptrdiff_t size,
-	  Lisp_Object printcharfun)
-{
-  int digits = (c > '\77' || (i < size && '0' <= data[i] && data[i] <= '7')
-		? 3
-		: c > '\7' ? 2 : 1);
-  printchar ('\\', printcharfun);
-  do
-    printchar ('0' + ((c >> (3 * --digits)) & 7), printcharfun);
-  while (digits != 0);
-}
 
 /* Output SIZE characters, SIZE_BYTE bytes from string PTR using
    method PRINTCHARFUN.  PRINTCHARFUN nil means output to
@@ -1386,33 +1367,32 @@ print_vectorlike (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag,
     case PVEC_BOOL_VECTOR:
       {
 	EMACS_INT size = bool_vector_size (obj);
-	ptrdiff_t size_in_bytes = bool_vector_bytes (size);
-	ptrdiff_t real_size_in_bytes = size_in_bytes;
-	unsigned char *data = bool_vector_uchar_data (obj);
+	ptrdiff_t size_in_chars = bool_vector_bytes (size);
+	ptrdiff_t real_size_in_chars = size_in_chars;
 
 	int len = sprintf (buf, "#&%"pI"d\"", size);
 	strout (buf, len, len, printcharfun);
 
-	/* Don't print more bytes than the specified maximum.
+	/* Don't print more characters than the specified maximum.
 	   Negative values of print-length are invalid.  Treat them
 	   like a print-length of nil.  */
 	if (NATNUMP (Vprint_length)
-	    && XFASTINT (Vprint_length) < size_in_bytes)
-	  size_in_bytes = XFASTINT (Vprint_length);
+	    && XFASTINT (Vprint_length) < size_in_chars)
+	  size_in_chars = XFASTINT (Vprint_length);
 
-	for (ptrdiff_t i = 0; i < size_in_bytes; i++)
+	for (ptrdiff_t i = 0; i < size_in_chars; i++)
 	  {
 	    maybe_quit ();
-	    unsigned char c = data[i];
+	    unsigned char c = bool_vector_uchar_data (obj)[i];
 	    if (c == '\n' && print_escape_newlines)
 	      print_c_string ("\\n", printcharfun);
 	    else if (c == '\f' && print_escape_newlines)
 	      print_c_string ("\\f", printcharfun);
-	    else if (c > '\177'
-		     || (print_escape_control_characters && c_iscntrl (c)))
+	    else if (c > '\177')
 	      {
 		/* Use octal escapes to avoid encoding issues.  */
-		octalout (c, data, i + 1, size_in_bytes, printcharfun);
+		int len = sprintf (buf, "\\%o", c);
+		strout (buf, len, len, printcharfun);
 	      }
 	    else
 	      {
@@ -1422,7 +1402,7 @@ print_vectorlike (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag,
 	      }
 	  }
 
-	if (size_in_bytes < real_size_in_bytes)
+	if (size_in_chars < real_size_in_chars)
 	  print_c_string (" ...", printcharfun);
 	printchar ('\"', printcharfun);
       }
@@ -1874,7 +1854,9 @@ print_object (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag)
 		     (when requested) a non-ASCII character in a unibyte buffer,
 		     print single-byte non-ASCII string chars
 		     using octal escapes.  */
-		  octalout (c, SDATA (obj), i_byte, size_byte, printcharfun);
+		  char outbuf[5];
+		  int len = sprintf (outbuf, "\\%03o", c + 0u);
+		  strout (outbuf, len, len, printcharfun);
 		  need_nonhex = false;
 		}
 	      else if (multibyte
@@ -1888,6 +1870,7 @@ print_object (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag)
 		}
 	      else
 		{
+                  bool still_need_nonhex = false;
 		  /* If we just had a hex escape, and this character
 		     could be taken as part of it,
 		     output `\ ' to prevent that.  */
@@ -1901,16 +1884,22 @@ print_object (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag)
                            ? (c = 'n', true)
                            : c == '\f' && print_escape_newlines
                            ? (c = 'f', true)
+                           : c == '\0' && print_escape_control_characters
+                           ? (c = '0', still_need_nonhex = true)
                            : c == '\"' || c == '\\')
                     {
                       printchar ('\\', printcharfun);
                       printchar (c, printcharfun);
                     }
                   else if (print_escape_control_characters && c_iscntrl (c))
-		    octalout (c, SDATA (obj), i_byte, size_byte, printcharfun);
+                    {
+                      char outbuf[1 + 3 + 1];
+                      int len = sprintf (outbuf, "\\%03o", c + 0u);
+                      strout (outbuf, len, len, printcharfun);
+                    }
                   else
                     printchar (c, printcharfun);
-		  need_nonhex = false;
+		  need_nonhex = still_need_nonhex;
 		}
 	    }
 	  printchar ('\"', printcharfun);
diff --git a/src/process.c b/src/process.c
index 1f0565ef65..17a46d3ed3 100644
--- a/src/process.c
+++ b/src/process.c
@@ -1734,9 +1734,9 @@ create_process (Lisp_Object process, char **new_argv, Lisp_Object current_dir)
     {
       /* Make the pty be the controlling terminal of the process.  */
 #ifdef HAVE_PTYS
-      /* First, disconnect its current controlling terminal.
-	 Do this even if !PTY_FLAG; see Bug#30762.  */
-      setsid ();
+      /* First, disconnect its current controlling terminal.  */
+      if (pty_flag)
+	setsid ();
       /* Make the pty's terminal the controlling terminal.  */
       if (pty_flag && forkin >= 0)
 	{
@@ -6434,7 +6434,7 @@ SIGCODE may be an integer, or a symbol whose name is a signal name.  */)
       if (NILP (tem))
 	{
 	  Lisp_Object process_number
-	    = string_to_number (SSDATA (process), 10, true);
+	    = string_to_number (SSDATA (process), 10, 1);
 	  if (NUMBERP (process_number))
 	    tem = process_number;
 	}
diff --git a/src/term.c b/src/term.c
index cf8484ee7c..03310d2c81 100644
--- a/src/term.c
+++ b/src/term.c
@@ -1593,13 +1593,13 @@ produce_glyphs (struct it *it)
 			+ it->continuation_lines_width);
       int x0 = absolute_x;
       /* Adjust for line numbers.  */
-      if (!NILP (Vdisplay_line_numbers) && it->line_number_produced_p)
+      if (!NILP (Vdisplay_line_numbers))
 	absolute_x -= it->lnum_pixel_width;
       int next_tab_x
 	= (((1 + absolute_x + it->tab_width - 1)
 	    / it->tab_width)
 	   * it->tab_width);
-      if (!NILP (Vdisplay_line_numbers) && it->line_number_produced_p)
+      if (!NILP (Vdisplay_line_numbers))
 	next_tab_x += it->lnum_pixel_width;
       int nspaces;
 
diff --git a/src/w32term.c b/src/w32term.c
index acbcbac220..23220d6027 100644
--- a/src/w32term.c
+++ b/src/w32term.c
@@ -2475,52 +2475,31 @@ x_draw_glyph_string (struct glyph_string *s)
               else
                 {
 		  struct font *font = font_for_underline_metrics (s);
-		  unsigned long minimum_offset;
-		  BOOL underline_at_descent_line;
-		  BOOL use_underline_position_properties;
-		  Lisp_Object val
-		    = buffer_local_value (Qunderline_minimum_offset,
-					s->w->contents);
-		  if (INTEGERP (val))
-		    minimum_offset = XFASTINT (val);
-		  else
-		    minimum_offset = 1;
-		  val = buffer_local_value (Qx_underline_at_descent_line,
-					    s->w->contents);
-		  underline_at_descent_line
-		    = !(NILP (val) || EQ (val, Qunbound));
-		  val
-		    = buffer_local_value (Qx_use_underline_position_properties,
-					  s->w->contents);
-		  use_underline_position_properties
-		    = !(NILP (val) || EQ (val, Qunbound));
 
                   /* Get the underline thickness.  Default is 1 pixel.  */
                   if (font && font->underline_thickness > 0)
                     thickness = font->underline_thickness;
                   else
                     thickness = 1;
-                  if (underline_at_descent_line
-                      || !font)
+                  if (x_underline_at_descent_line || !font)
                     position = (s->height - thickness) - (s->ybase - s->y);
                   else
                     {
-                      /* Get the underline position.  This is the
-                         recommended vertical offset in pixels from
-                         the baseline to the top of the underline.
-                         This is a signed value according to the
+                      /* Get the underline position.  This is the recommended
+                         vertical offset in pixels from the baseline to the top of
+                         the underline.  This is a signed value according to the
                          specs, and its default is
 
                          ROUND ((maximum_descent) / 2), with
                          ROUND (x) = floor (x + 0.5)  */
 
-                      if (use_underline_position_properties
+                      if (x_use_underline_position_properties
                           && font->underline_position >= 0)
                         position = font->underline_position;
                       else
                         position = (font->descent + 1) / 2;
                     }
-                  position = max (position, minimum_offset);
+                  position = max (position, underline_minimum_offset);
                 }
               /* Check the sanity of thickness and position.  We should
                  avoid drawing underline out of the current line area.  */
@@ -7406,8 +7385,6 @@ the cursor have no effect.  */);
 	       x_use_underline_position_properties,
      doc: /* SKIP: real doc in xterm.c.  */);
   x_use_underline_position_properties = 0;
-  DEFSYM (Qx_use_underline_position_properties,
-	  "x-use-underline-position-properties");
 
   DEFVAR_BOOL ("x-underline-at-descent-line",
 	       x_underline_at_descent_line,
@@ -7418,7 +7395,6 @@ A value of nil means to draw the underline according to the value of the
 variable `x-use-underline-position-properties', which is usually at the
 baseline level.  The default value is nil.  */);
   x_underline_at_descent_line = 0;
-  DEFSYM (Qx_underline_at_descent_line, "x-underline-at-descent-line");
 
   DEFVAR_LISP ("x-toolkit-scroll-bars", Vx_toolkit_scroll_bars,
 	       doc: /* SKIP: real doc in xterm.c.  */);
diff --git a/src/window.c b/src/window.c
index aef079b9d5..678d4d0703 100644
--- a/src/window.c
+++ b/src/window.c
@@ -5008,9 +5008,6 @@ and redisplay normally--don't erase and redraw the frame.  */)
   EMACS_INT iarg UNINIT;
   int this_scroll_margin;
 
-  /* For reasons why we signal an error here, see
-     http://lists.gnu.org/archive/html/emacs-devel/2014-06/msg00053.html,
-     http://lists.gnu.org/archive/html/emacs-devel/2014-06/msg00094.html.  */
   if (buf != current_buffer)
     error ("`recenter'ing a window that does not display current-buffer.");
 
diff --git a/src/xdisp.c b/src/xdisp.c
index 4e7ee0b8fb..747545d7ef 100644
--- a/src/xdisp.c
+++ b/src/xdisp.c
@@ -8716,12 +8716,8 @@ move_it_in_display_line_to (struct it *it,
 
   if (it->hpos == 0)
     {
-      /* If line numbers are being displayed, produce a line number.
-	 But don't do that if we are to reach first_visible_x, because
-	 line numbers are not relevant to stuff that is not visible on
-	 display.  */
-      if (!((op && MOVE_TO_X) && to_x == it->first_visible_x)
-	  && should_produce_line_number (it))
+      /* If line numbers are being displayed, produce a line number.  */
+      if (should_produce_line_number (it))
 	{
 	  if (it->current_x == it->first_visible_x)
 	    maybe_produce_line_number (it);
@@ -9598,7 +9594,6 @@ move_it_to (struct it *it, ptrdiff_t to_charpos, int to_x, int to_y, int to_vpos
       it->current_x = line_start_x;
       line_start_x = 0;
       it->hpos = 0;
-      it->line_number_produced_p = false;
       it->current_y += it->max_ascent + it->max_descent;
       ++it->vpos;
       last_height = it->max_ascent + it->max_descent;
@@ -10137,48 +10132,17 @@ include the height of both, if present, in the return value.  */)
   itdata = bidi_shelve_cache ();
   SET_TEXT_POS (startp, start, CHAR_TO_BYTE (start));
   start_display (&it, w, startp);
-  /* It makes no sense to measure dimensions of region of text that
-     crosses the point where bidi reordering changes scan direction.
-     By using unidirectional movement here we at least support the use
-     case of measuring regions of text that have a uniformly R2L
-     directionality, and regions that begin and end in text of the
-     same directionality.  */
-  it.bidi_p = false;
-
-  int move_op = MOVE_TO_POS | MOVE_TO_Y;
-  int to_x = -1;
-  if (!NILP (x_limit))
+
+  if (NILP (x_limit))
+    x = move_it_to (&it, end, -1, max_y, -1, MOVE_TO_POS | MOVE_TO_Y);
+  else
     {
       it.last_visible_x = max_x;
       /* Actually, we never want move_it_to stop at to_x.  But to make
 	 sure that move_it_in_display_line_to always moves far enough,
-	 we set to_x to INT_MAX and specify MOVE_TO_X.  */
-      move_op |= MOVE_TO_X;
-      to_x = INT_MAX;
-    }
-
-  void *it2data = NULL;
-  struct it it2;
-  SAVE_IT (it2, it, it2data);
-
-  x = move_it_to (&it, end, to_x, max_y, -1, move_op);
-
-  /* We could have a display property at END, in which case asking
-     move_it_to to stop at END will overshoot and stop at position
-     after END.  So we try again, stopping before END, and account for
-     the width of the last buffer position manually.  */
-  if (IT_CHARPOS (it) > end)
-    {
-      end--;
-      RESTORE_IT (&it, &it2, it2data);
-      x = move_it_to (&it, end, to_x, max_y, -1, move_op);
-      /* Add the width of the thing at TO, but only if we didn't
-	 overshoot it; if we did, it is already accounted for.  */
-      if (IT_CHARPOS (it) == end)
-	x += it.pixel_width;
-    }
-  if (!NILP (x_limit))
-    {
+	 we set it to INT_MAX and specify MOVE_TO_X.  */
+      x = move_it_to (&it, end, INT_MAX, max_y, -1,
+		      MOVE_TO_POS | MOVE_TO_X | MOVE_TO_Y);
       /* Don't return more than X-LIMIT.  */
       if (x > max_x)
         x = max_x;
@@ -21209,8 +21173,6 @@ maybe_produce_line_number (struct it *it)
       it->max_phys_descent = max (it->max_phys_descent, tem_it.max_phys_descent);
     }
 
-  it->line_number_produced_p = true;
-
   bidi_unshelve_cache (itdata, false);
 }
 
@@ -21328,8 +21290,6 @@ display_line (struct it *it, int cursor_vpos)
   row->displays_text_p = true;
   row->starts_in_middle_of_char_p = it->starts_in_middle_of_char_p;
   it->starts_in_middle_of_char_p = false;
-  it->tab_offset = 0;
-  it->line_number_produced_p = false;
 
   /* Arrange the overlays nicely for our purposes.  Usually, we call
      display_line on only one line at a time, in which case this
@@ -21374,10 +21334,6 @@ display_line (struct it *it, int cursor_vpos)
 	      || move_result == MOVE_POS_MATCH_OR_ZV))
 	it->current_x = it->first_visible_x;
 
-      /* In case move_it_in_display_line_to above "produced" the line
-	 number.  */
-      it->line_number_produced_p = false;
-
       /* Record the smallest positions seen while we moved over
 	 display elements that are not visible.  This is needed by
 	 redisplay_internal for optimizing the case where the cursor
@@ -21597,10 +21553,6 @@ display_line (struct it *it, int cursor_vpos)
 	  row->extra_line_spacing = max (row->extra_line_spacing,
 					 it->max_extra_line_spacing);
 	  if (it->current_x - it->pixel_width < it->first_visible_x
-	      /* When line numbers are displayed, row->x should not be
-		 offset, as the first glyph after the line number can
-		 never be partially visible.  */
-	      && !line_number_needed
 	      /* In R2L rows, we arrange in extend_face_to_end_of_line
 		 to add a right offset to the line, by a suitable
 		 change to the stretch glyph that is the leftmost
@@ -21842,8 +21794,7 @@ display_line (struct it *it, int cursor_vpos)
 		  if (it->bidi_p)
 		    RECORD_MAX_MIN_POS (it);
 
-		  if (x < it->first_visible_x && !row->reversed_p
-		      && !line_number_needed)
+		  if (x < it->first_visible_x && !row->reversed_p)
 		    /* Glyph is partially visible, i.e. row starts at
 		       negative X position.  Don't do that in R2L
 		       rows, where we arrange to add a right offset to
@@ -21859,7 +21810,6 @@ display_line (struct it *it, int cursor_vpos)
 		     be taken care of in produce_special_glyphs.  */
 		  if (row->reversed_p
 		      && new_x > it->last_visible_x
-		      && !line_number_needed
 		      && !(it->line_wrap == TRUNCATE
 			   && WINDOW_LEFT_FRINGE_WIDTH (it->w) == 0))
 		    {
@@ -22489,11 +22439,6 @@ Value is the new character position of point.  */)
 		    new_pos += (row->reversed_p ? -dir : dir);
 		  else
 		    new_pos -= (row->reversed_p ? -dir : dir);
-		  new_pos = clip_to_bounds (BEGV, new_pos, ZV);
-		  /* If we didn't move, we've hit BEGV or ZV, so we
-		     need to signal a suitable error.  */
-		  if (new_pos == PT)
-		    break;
 		}
 	      else if (BUFFERP (g->object))
 		new_pos = g->charpos;
@@ -28325,14 +28270,8 @@ x_produce_glyphs (struct it *it)
 	      int x = it->current_x + it->continuation_lines_width;
 	      int x0 = x;
 	      /* Adjust for line numbers, if needed.   */
-	      if (!NILP (Vdisplay_line_numbers) && it->line_number_produced_p)
-		{
-		  x -= it->lnum_pixel_width;
-		  /* Restore the original TAB width, if required.  */
-		  if (x + it->tab_offset >= it->first_visible_x)
-		    x += it->tab_offset;
-		}
-
+	      if (!NILP (Vdisplay_line_numbers) && x0 >= it->lnum_pixel_width)
+		x -= it->lnum_pixel_width;
 	      int next_tab_x = ((1 + x + tab_width - 1) / tab_width) * tab_width;
 
 	      /* If the distance from the current position to the next tab
@@ -28340,19 +28279,10 @@ x_produce_glyphs (struct it *it)
 		 tab stop after that.  */
 	      if (next_tab_x - x < font->space_width)
 		next_tab_x += tab_width;
-	      if (!NILP (Vdisplay_line_numbers) && it->line_number_produced_p)
-		{
-		  next_tab_x += it->lnum_pixel_width;
-		  /* If the line is hscrolled, and the TAB starts before
-		     the first visible pixel, simulate negative row->x.  */
-		  if (x < it->first_visible_x)
-		    {
-		      next_tab_x -= it->first_visible_x - x;
-		      it->tab_offset = it->first_visible_x - x;
-		    }
-		  else
-		    next_tab_x -= it->tab_offset;
-		}
+	      if (!NILP (Vdisplay_line_numbers) && x0 >= it->lnum_pixel_width)
+		next_tab_x += (it->lnum_pixel_width
+			       - ((it->w->hscroll * font->space_width)
+				  % tab_width));
 
 	      it->pixel_width = next_tab_x - x0;
 	      it->nglyphs = 1;
@@ -33041,7 +32971,6 @@ particularly when using variable `x-use-underline-position-properties'
 with fonts that specify an UNDERLINE_POSITION relatively close to the
 baseline.  The default value is 1.  */);
   underline_minimum_offset = 1;
-  DEFSYM (Qunderline_minimum_offset, "underline-minimum-offset");
 
   DEFVAR_BOOL ("display-hourglass", display_hourglass_p,
 	       doc: /* Non-nil means show an hourglass pointer, when Emacs is busy.
diff --git a/src/xfaces.c b/src/xfaces.c
index 9b527bddc4..f538f2da9e 100644
--- a/src/xfaces.c
+++ b/src/xfaces.c
@@ -3346,8 +3346,8 @@ DEFUN ("internal-set-lisp-face-attribute-from-resource",
     value = Qunspecified;
   else if (EQ (attr, QCheight))
     {
-      value = Fstring_to_number (value, Qnil);
-      if (!INTEGERP (value) || XINT (value) <= 0)
+      value = Fstring_to_number (value, make_number (10));
+      if (XINT (value) <= 0)
 	signal_error ("Invalid face height from X resource", value);
     }
   else if (EQ (attr, QCbold) || EQ (attr, QCitalic))
diff --git a/src/xterm.c b/src/xterm.c
index 91ec742770..a1ea60ec58 100644
--- a/src/xterm.c
+++ b/src/xterm.c
@@ -3397,53 +3397,33 @@ x_draw_glyph_string (struct glyph_string *s)
               else
                 {
 		  struct font *font = font_for_underline_metrics (s);
-		  unsigned long minimum_offset;
-		  bool underline_at_descent_line;
-		  bool use_underline_position_properties;
-		  Lisp_Object val
-		    = buffer_local_value (Qunderline_minimum_offset,
-					  s->w->contents);
-		  if (INTEGERP (val))
-		    minimum_offset = XFASTINT (val);
-		  else
-		    minimum_offset = 1;
-		  val = buffer_local_value (Qx_underline_at_descent_line,
-					    s->w->contents);
-		  underline_at_descent_line
-		    = !(NILP (val) || EQ (val, Qunbound));
-		  val
-		    = buffer_local_value (Qx_use_underline_position_properties,
-					  s->w->contents);
-		  use_underline_position_properties
-		    = !(NILP (val) || EQ (val, Qunbound));
 
                   /* Get the underline thickness.  Default is 1 pixel.  */
                   if (font && font->underline_thickness > 0)
                     thickness = font->underline_thickness;
                   else
                     thickness = 1;
-                  if (underline_at_descent_line)
+                  if (x_underline_at_descent_line)
                     position = (s->height - thickness) - (s->ybase - s->y);
                   else
                     {
-                      /* Get the underline position.  This is the
-                         recommended vertical offset in pixels from
-                         the baseline to the top of the underline.
-                         This is a signed value according to the
+                      /* Get the underline position.  This is the recommended
+                         vertical offset in pixels from the baseline to the top of
+                         the underline.  This is a signed value according to the
                          specs, and its default is
 
                          ROUND ((maximum descent) / 2), with
                          ROUND(x) = floor (x + 0.5)  */
 
-                      if (use_underline_position_properties
+                      if (x_use_underline_position_properties
                           && font && font->underline_position >= 0)
                         position = font->underline_position;
                       else if (font)
                         position = (font->descent + 1) / 2;
                       else
-                        position = minimum_offset;
+                        position = underline_minimum_offset;
                     }
-                  position = max (position, minimum_offset);
+                  position = max (position, underline_minimum_offset);
                 }
               /* Check the sanity of thickness and position.  We should
                  avoid drawing underline out of the current line area.  */
@@ -10786,8 +10766,6 @@ UNDERLINE_POSITION font properties, set this to nil.  You can also use
 `underline-minimum-offset' to override the font's UNDERLINE_POSITION for
 small font display sizes.  */);
   x_use_underline_position_properties = true;
-  DEFSYM (Qx_use_underline_position_properties,
-	  "x-use-underline-position-properties");
 
   DEFVAR_BOOL ("x-underline-at-descent-line",
 	       x_underline_at_descent_line,
@@ -10798,7 +10776,6 @@ A value of nil means to draw the underline according to the value of the
 variable `x-use-underline-position-properties', which is usually at the
 baseline level.  The default value is nil.  */);
   x_underline_at_descent_line = false;
-  DEFSYM (Qx_underline_at_descent_line, "x-underline-at-descent-line");
 
   DEFVAR_BOOL ("x-mouse-click-focus-ignore-position",
 	       x_mouse_click_focus_ignore_position,
diff --git a/test/Makefile.in b/test/Makefile.in
index dd9e519c42..a9650fdd39 100644
--- a/test/Makefile.in
+++ b/test/Makefile.in
@@ -99,20 +99,14 @@ TEST_LOCALE = C
 # If you just want a pass/fail, setting this to no is much faster.
 TEST_LOAD_EL ?= yes
 
-# Additional settings for ert.
-ert_opts =
-
 # Maximum length of lines in ert backtraces; nil for no limit.
 # (if empty, use the default ert-batch-backtrace-right-margin).
 TEST_BACKTRACE_LINE_LENGTH =
 
-ifneq (${TEST_BACKTRACE_LINE_LENGTH},)
-ert_opts += --eval '(setq ert-batch-backtrace-right-margin ${TEST_BACKTRACE_LINE_LENGTH})'
-endif
-
-# Whether the tests shall also report their duration.
-ifdef TEST_PRINT_TEST_DURATION
-ert_opts += --eval '(setq ert-batch-print-duration t)'
+ifeq (${TEST_BACKTRACE_LINE_LENGTH},)
+ert_opts =
+else
+ert_opts = --eval '(setq ert-batch-backtrace-right-margin ${TEST_BACKTRACE_LINE_LENGTH})'
 endif
 
 ifeq (@HAVE_MODULES@, yes)
@@ -158,6 +152,7 @@ endif
 WRITE_LOG = > $@ 2>&1 || { STAT=$$?; cat $@; exit $$STAT; }
 ifdef EMACS_HYDRA_CI
 ## On Hydra, always show logs for certain problematic tests.
+lisp/emacs-lisp/eieio-tests/eieio-tests.log \
 lisp/net/tramp-tests.log \
 : WRITE_LOG = 2>&1 | tee $@
 endif
@@ -305,9 +300,3 @@ distclean: clean
 	rm -f Makefile
 
 maintainer-clean: distclean bootstrap-clean
-
-.PHONY: check-declare
-
-check-declare:
-	$(emacs) -l check-declare \
-	  --eval '(check-declare-directory "$(srcdir)")'
diff --git a/test/README b/test/README
index 17135a0274..1cd9db3bb8 100644
--- a/test/README
+++ b/test/README
@@ -50,11 +50,6 @@ nicer backtraces.  To run the compiled version of a test use
 
     make TEST_LOAD_EL=no ...
 
-Sometimes, it is necessary to trace the duration time for single tests.
-This is controlled by the environment variable TEST_PRINT_TEST_DURATION
-
-    make TEST_PRINT_TEST_DURATION=1 ...
-
 
 (Also, see etc/compilation.txt for compilation mode font lock tests.)
 
diff --git a/test/lisp/dired-tests.el b/test/lisp/dired-tests.el
index 78c09c8e69..0284b9f0a4 100644
--- a/test/lisp/dired-tests.el
+++ b/test/lisp/dired-tests.el
@@ -211,12 +211,12 @@
                          (concat (file-name-as-directory test-dir)
                                  (file-name-as-directory "test-subdir"))))
           (push (dired-find-file) buffers)
-          ;; Point is on test-file.
-          (switch-to-buffer buf)
-          ;; Sanity check: point should now be back on the subdirectory.
-          (should (eq (point) pt1))
-          (push (dired test-dir) buffers)
-          (should (eq (point) pt1)))
+          (let ((pt2 (point)))          ; Point is on test-file.
+            (switch-to-buffer buf)
+            ;; Sanity check: point should now be back on the subdirectory.
+            (should (eq (point) pt1))
+            (push (dired test-dir) buffers)
+            (should (eq (point) pt1))))
       (dolist (buf buffers)
         (when (buffer-live-p buf) (kill-buffer buf)))
       (delete-directory test-dir t))))
@@ -225,7 +225,7 @@
   "Test for https://debbugs.gnu.org/cgi/bugreport.cgi?bug=27243#61 ."
   (let ((test-dir (make-temp-file "test-dir-" t))
         (dired-auto-revert-buffer t)
-        allbufs)
+        test-subdir1 test-subdir2 allbufs)
     (unwind-protect
         (progn
           (with-current-buffer (find-file-noselect test-dir)
@@ -295,9 +295,9 @@
 
 (ert-deftest dired-test-bug27899 ()
   "Test for https://debbugs.gnu.org/27899 ."
-  (dired (list (expand-file-name "src" source-directory)
-               "cygw32.c" "alloc.c" "w32xfns.c" "xdisp.c"))
-  (let ((orig dired-hide-details-mode))
+  (let* ((dir (expand-file-name "src" source-directory))
+	 (buf (dired (list dir "cygw32.c" "alloc.c" "w32xfns.c" "xdisp.c")))
+         (orig dired-hide-details-mode))
     (dired-goto-file (expand-file-name "cygw32.c"))
     (forward-line 0)
     (unwind-protect
@@ -363,7 +363,8 @@
 (defmacro dired-test-with-temp-dirs (just-empty-dirs &rest body)
   "Helper macro for Bug#27940 test."
   (declare (indent 1) (debug body))
-  (let ((dir (make-symbol "dir")))
+  (let ((dir (make-symbol "dir"))
+        (ignore-funcs (make-symbol "ignore-funcs")))
     `(let* ((,dir (make-temp-file "bug27940" t))
             (dired-deletion-confirmer (lambda (_) "yes")) ; Suppress prompts.
             (inhibit-message t)
diff --git a/test/lisp/emacs-lisp/benchmark-tests.el b/test/lisp/emacs-lisp/benchmark-tests.el
index cba53aefc9..8de7818bdb 100644
--- a/test/lisp/emacs-lisp/benchmark-tests.el
+++ b/test/lisp/emacs-lisp/benchmark-tests.el
@@ -23,9 +23,9 @@
 (require 'ert)
 
 (ert-deftest benchmark-tests ()
-  (let (str t-long t-short m)
-    (should (consp (benchmark-run nil (setq m (1+ 0)))))
-    (should (consp (benchmark-run 1 (setq m (1+ 0)))))
+  (let (str t-long t-short)
+    (should (consp (benchmark-run nil (1+ 0))))
+    (should (consp (benchmark-run 1 (1+ 0))))
     (should (stringp (benchmark nil (1+ 0))))
     (should (stringp (benchmark 1 (1+ 0))))
     (should (consp (benchmark-run-compiled nil (1+ 0))))
@@ -33,10 +33,10 @@
     ;; First test is heavier, must need longer time.
     (should (> (car (benchmark-run nil
                       (let ((n 100000)) (while (> n 1) (setq n (1- n))))))
-               (car (benchmark-run nil (setq m (1+ 0))))))
+               (car (benchmark-run nil (1+ 0)))))
     (should (> (car (benchmark-run nil
                       (let ((n 100000)) (while (> n 1) (setq n (1- n))))))
-               (car (benchmark-run nil (setq m (1+ 0))))))
+               (car (benchmark-run nil (1+ 0)))))
     (should (> (car (benchmark-run-compiled nil
                       (let ((n 100000)) (while (> n 1) (setq n (1- n))))))
                (car (benchmark-run-compiled nil (1+ 0)))))
@@ -46,8 +46,6 @@
     (setq str (benchmark nil '(1+ 0)))
     (string-match "Elapsed time: \\([0-9.]+\\)" str)
     (setq t-short (string-to-number (match-string 1 str)))
-    (should (> t-long t-short))
-    ;; Silence compiler.
-    m))
+    (should (> t-long t-short))))
 
 ;;; benchmark-tests.el ends here.
diff --git a/test/lisp/emacs-lisp/eieio-tests/eieio-tests.el b/test/lisp/emacs-lisp/eieio-tests/eieio-tests.el
index 5ba094c007..69dc16443f 100644
--- a/test/lisp/emacs-lisp/eieio-tests/eieio-tests.el
+++ b/test/lisp/emacs-lisp/eieio-tests/eieio-tests.el
@@ -887,15 +887,34 @@ Subclasses to override slot attributes.")
   (should (= (length (eieio-build-class-alist 'opt-test1 nil)) 2))
   (should (= (length (eieio-build-class-alist 'opt-test1 t)) 1)))
 
+(mapatoms (lambda (a)
+            (when (and (fboundp a)
+                       (string-match "\\`cl--?generic"
+                                     (symbol-name a)))
+              (trace-function-background a))))
+
 (defclass eieio--testing () ())
 
 (defmethod constructor :static ((_x eieio--testing) newname &rest _args)
   (list newname 2))
 
+(defun eieio-test-dump-trace ()
+  (message "%s" (with-current-buffer "*trace-output*"
+                  (goto-char (point-min))
+                  (while (re-search-forward "[\0-\010\013-\037]" nil t)
+                    (insert (prog1 (format "\\%03o" (char-before))
+                              (delete-char -1))))
+                  (buffer-string))))
+(eieio-test-dump-trace)
+
 (ert-deftest eieio-test-37-obsolete-name-in-constructor ()
   ;; FIXME repeated intermittent failures on hydra and elsewhere (bug#24503).
   :tags '(:unstable)
-  (should (equal (eieio--testing "toto") '("toto" 2))))
+  (with-current-buffer "*trace-output*"
+    (erase-buffer))
+  (unwind-protect
+      (should (equal (eieio--testing "toto") '("toto" 2)))
+    (eieio-test-dump-trace)))
 
 (ert-deftest eieio-autoload ()
   "Tests to see whether reftex-auc has been autoloaded"
diff --git a/test/lisp/emacs-lisp/package-tests.el b/test/lisp/emacs-lisp/package-tests.el
index 0059c546ac..83f5228488 100644
--- a/test/lisp/emacs-lisp/package-tests.el
+++ b/test/lisp/emacs-lisp/package-tests.el
@@ -473,8 +473,8 @@ Must called from within a `tar-mode' buffer."
 		       (let ((process-environment
 			      (cons (format "HOME=%s" homedir)
 				    process-environment)))
-			 (epg-check-configuration
-                          (epg-find-configuration 'OpenPGP)))
+			 (epg-check-configuration (epg-configuration))
+			 (epg-find-configuration 'OpenPGP))
 		     (delete-directory homedir t)))))
   (let* ((keyring (expand-file-name "key.pub" package-test-data-dir))
 	 (package-test-data-dir
diff --git a/test/lisp/eshell/em-ls-tests.el b/test/lisp/eshell/em-ls-tests.el
index c5c9eac324..1ce832f1dc 100644
--- a/test/lisp/eshell/em-ls-tests.el
+++ b/test/lisp/eshell/em-ls-tests.el
@@ -26,7 +26,6 @@
 
 (require 'ert)
 (require 'em-ls)
-(require 'dired)
 
 (ert-deftest em-ls-test-bug27631 ()
   "Test for https://debbugs.gnu.org/27631 ."
diff --git a/test/lisp/hi-lock-tests.el b/test/lisp/hi-lock-tests.el
index 4c639b03dc..40d76ee9de 100644
--- a/test/lisp/hi-lock-tests.el
+++ b/test/lisp/hi-lock-tests.el
@@ -29,7 +29,7 @@
     (with-temp-buffer
       (insert "a A b B\n")
       (cl-letf (((symbol-function 'completing-read)
-                   (lambda (_prompt _coll _x _y _z _hist defaults)
+                   (lambda (prompt coll x y z hist defaults)
                      (car defaults))))
         (dotimes (_ 2)
           (let ((face (hi-lock-read-face-name)))
@@ -41,7 +41,7 @@
     (with-temp-buffer
       (insert "foo bar")
       (cl-letf (((symbol-function 'completing-read)
-                 (lambda (_prompt _coll _x _y _z _hist defaults)
+                 (lambda (prompt coll x y z hist defaults)
                    (car defaults))))
         (hi-lock-set-pattern "9999" (hi-lock-read-face-name)) ; No match
         (hi-lock-set-pattern "foo" (hi-lock-read-face-name)))
diff --git a/test/lisp/international/mule-tests.el b/test/lisp/international/mule-tests.el
index 59c9ff5aab..3c3bae1493 100644
--- a/test/lisp/international/mule-tests.el
+++ b/test/lisp/international/mule-tests.el
@@ -36,7 +36,4 @@
                      (find-auto-coding "" (buffer-size)))
                    '(utf-8 . :coding)))))
 
-;; Stop "Local Variables" above causing confusion when visiting this file.
-
-
 ;;; mule-tests.el ends here
diff --git a/test/lisp/ls-lisp-tests.el b/test/lisp/ls-lisp-tests.el
index 91e8b0b701..d16ffa3acd 100644
--- a/test/lisp/ls-lisp-tests.el
+++ b/test/lisp/ls-lisp-tests.el
@@ -26,7 +26,6 @@
 ;;; Code:
 (require 'ert)
 (require 'ls-lisp)
-(require 'dired)
 
 (ert-deftest ls-lisp-unload ()
   "Test for https://debbugs.gnu.org/xxxxx ."
diff --git a/test/lisp/net/tramp-archive-tests.el b/test/lisp/net/tramp-archive-tests.el
index a3201bdba4..33916f82da 100644
--- a/test/lisp/net/tramp-archive-tests.el
+++ b/test/lisp/net/tramp-archive-tests.el
@@ -809,7 +809,7 @@ This tests also `file-executable-p', `file-writable-p' and `set-file-modes'."
   (skip-unless (tramp-archive--test-emacs27-p))
 
   ;; tramp-archive is neither loaded at Emacs startup, nor when
-  ;; loading a file like "/mock::foo" (which loads Tramp).
+  ;; loading a file like "/ssh::" (which loads Tramp).
   (let ((default-directory (expand-file-name temporary-file-directory))
 	(code
 	 "(progn \
@@ -818,7 +818,7 @@ This tests also `file-executable-p', `file-writable-p' and `set-file-modes'."
 	    (file-attributes %S \"/\") \
 	    (message \"tramp-archive loaded: %%s %%s\" \
               (featurep 'tramp) (featurep 'tramp-archive)))"))
-    (dolist (file `("/mock::foo" ,(concat tramp-archive-test-archive "foo")))
+    (dolist (file `("/ssh::foo" ,(concat tramp-archive-test-archive "foo")))
       (should
        (string-match
 	(format
diff --git a/test/lisp/net/tramp-tests.el b/test/lisp/net/tramp-tests.el
index 193d3c9a4b..d11bf46fd6 100644
--- a/test/lisp/net/tramp-tests.el
+++ b/test/lisp/net/tramp-tests.el
@@ -4722,8 +4722,6 @@ process sentinels.  They shall not disturb each other."
 
   ;; This test could be blocked on hydra.  So we set a timeout of 300
   ;; seconds, and we send a SIGUSR1 signal after 300 seconds.
-  ;; This clearly doesn't work though, because the test not
-  ;; infrequently hangs for hours until killed by the infrastructure.
   (with-timeout (300 (tramp--test-timeout-handler))
     (define-key special-event-map [sigusr1] 'tramp--test-timeout-handler)
     (tramp--test-instrument-test-case (if (getenv "EMACS_HYDRA_CI") 10 0)
@@ -4748,7 +4746,6 @@ process sentinels.  They shall not disturb each other."
             (or
              (ignore-errors
                (string-to-number (getenv "REMOTE_PARALLEL_PROCESSES")))
-	     (if (getenv "EMACS_HYDRA_CI") 5)
              10))
            ;; On hydra, timings are bad.
            (timer-repeat
diff --git a/test/lisp/progmodes/bat-mode-tests.el b/test/lisp/progmodes/bat-mode-tests.el
index 5b824841d4..4fa8de10c6 100644
--- a/test/lisp/progmodes/bat-mode-tests.el
+++ b/test/lisp/progmodes/bat-mode-tests.el
@@ -63,11 +63,10 @@
   "Test fontification of iteration variables."
   (should
    (equal
-    (bat-test-fontify "echo %%a\necho %%~dp1\necho %%~$PATH:I\necho %%~1")
+    (bat-test-fontify "echo %%a\necho %%~dp1\necho %%~$PATH:I")
     "<span class=\"builtin\">echo</span> %%<span class=\"variable-name\">a</span>
 <span class=\"builtin\">echo</span> %%~dp<span class=\"variable-name\">1</span>
-<span class=\"builtin\">echo</span> %%~$<span class=\"variable-name\">PATH</span>:<span class=\"variable-name\">I</span>
-<span class=\"builtin\">echo</span> %%~<span class=\"variable-name\">1</span>")))
+<span class=\"builtin\">echo</span> %%~$<span class=\"variable-name\">PATH</span>:<span class=\"variable-name\">I</span>")))
 
 (defun bat-test-fill-paragraph (str)
   "Return the result of invoking `fill-paragraph' on STR in a `bat-mode' buffer."
diff --git a/test/lisp/progmodes/ruby-mode-tests.el b/test/lisp/progmodes/ruby-mode-tests.el
index 72d83affae..b16698fba1 100644
--- a/test/lisp/progmodes/ruby-mode-tests.el
+++ b/test/lisp/progmodes/ruby-mode-tests.el
@@ -705,15 +705,13 @@ VALUES-PLIST is a list with alternating index and value elements."
 
 (ert-deftest ruby-forward-sexp-skips-method-calls-with-keyword-names ()
   (ruby-with-temp-buffer ruby-sexp-test-example
-    (goto-char (point-min))
-    (forward-line 1)
+    (goto-line 2)
     (ruby-forward-sexp)
     (should (= 8 (line-number-at-pos)))))
 
 (ert-deftest ruby-backward-sexp-skips-method-calls-with-keyword-names ()
   (ruby-with-temp-buffer ruby-sexp-test-example
-    (goto-char (point-min))
-    (forward-line 7)
+    (goto-line 8)
     (end-of-line)
     (ruby-backward-sexp)
     (should (= 2 (line-number-at-pos)))))
diff --git a/test/lisp/ses-tests.el b/test/lisp/ses-tests.el
index c773c9b396..c9966e237f 100644
--- a/test/lisp/ses-tests.el
+++ b/test/lisp/ses-tests.el
@@ -38,7 +38,7 @@ interactively."
       (dolist (c '((0 0 1) (1 0 (1+ A1))))
         (apply 'ses-cell-set-formula c)
         (apply 'ses-calculate-cell (list (car c) (cadr c) nil)))
-      (should (eq (bound-and-true-p A2) 2)))))
+      (should (eq A2 2)))))
 
 (ert-deftest ses-tests-plain-formula ()
   "Check that setting A1 to 1 and A2 to (1+ A1), makes A2 value
@@ -49,16 +49,13 @@ equal to 2. This is done  using interactive calls."
       (dolist (c '((0 0 1) (1 0 (1+ A1))))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook)
-      (should (eq (bound-and-true-p A2) 2)))))
+      (should (eq A2 2)))))
 
 ;; PLAIN CELL RENAMING TESTS
 ;; ======================================================================
 
-(defvar ses--foo)
-(defvar ses--cells)
-
 (ert-deftest ses-tests-lowlevel-renamed-cell ()
-  "Check that renaming A1 to `ses--foo' and setting `ses--foo' to 1 and A2 to (1+ ses--foo), makes A2 value equal to 2.
+  "Check that renaming A1 to `foo' and setting `foo' to 1 and A2 to (1+ foo), makes A2 value equal to 2.
 This is done using low level functions, `ses-rename-cell' is not
 called but instead we use text replacement in the buffer
 previously passed in text mode."
@@ -72,63 +69,63 @@ previously passed in text mode."
       (text-mode)
       (goto-char (point-min))
       (while (re-search-forward "\\<A1\\>" nil t)
-        (replace-match "ses--foo" t t))
+        (replace-match "foo" t t))
       (ses-mode)
       (should-not  (local-variable-p 'A1))
-      (should (eq ses--foo 1))
-      (should (equal (ses-cell-formula 1 0) '(ses-safe-formula (1+ ses--foo))))
-      (should (eq (bound-and-true-p A2) 2)))))
+      (should (eq foo 1))
+      (should (equal (ses-cell-formula 1 0) '(ses-safe-formula (1+ foo))))
+      (should (eq A2 2)))))
 
 (ert-deftest ses-tests-renamed-cell ()
-  "Check that renaming A1 to `ses--foo' and setting `ses--foo' to 1 and A2
-to (1+ ses--foo), makes A2 value equal to 2."
+  "Check that renaming A1 to `foo' and setting `foo' to 1 and A2
+to (1+ foo), makes A2 value equal to 2."
   (let ((ses-initial-size '(2 . 1)))
     (with-temp-buffer
       (ses-mode)
-      (ses-rename-cell 'ses--foo (ses-get-cell 0 0))
-      (dolist (c '((0 0 1) (1 0 (1+ ses--foo))))
+      (ses-rename-cell 'foo (ses-get-cell 0 0))
+      (dolist (c '((0 0 1) (1 0 (1+ foo))))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook)
       (should-not  (local-variable-p 'A1))
-      (should (eq ses--foo 1))
-      (should (equal (ses-cell-formula 1 0) '(1+ ses--foo)))
-      (should (eq (bound-and-true-p A2) 2)))))
+      (should (eq foo 1))
+      (should (equal (ses-cell-formula 1 0) '(1+ foo)))
+      (should (eq A2 2)))))
 
 (ert-deftest ses-tests-renamed-cell-after-setting ()
   "Check that setting A1 to 1 and A2 to (1+ A1), and then
-renaming A1 to `ses--foo' makes `ses--foo' value equal to 2."
+renaming A1 to `foo' makes `foo' value equal to 2."
   (let ((ses-initial-size '(2 . 1)))
     (with-temp-buffer
       (ses-mode)
       (dolist (c '((0 0 1) (1 0 (1+ A1))))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook); deferred recalc
-      (ses-rename-cell 'ses--foo (ses-get-cell 0 0))
+      (ses-rename-cell 'foo (ses-get-cell 0 0))
       (should-not  (local-variable-p 'A1))
-      (should (eq ses--foo 1))
-      (should (equal (ses-cell-formula 1 0) '(1+ ses--foo)))
-      (should (eq (bound-and-true-p A2) 2)))))
+      (should (eq foo 1))
+      (should (equal (ses-cell-formula 1 0) '(1+ foo)))
+      (should (eq A2 2)))))
 
 (ert-deftest ses-tests-renaming-cell-with-one-symbol-formula ()
   "Check that setting A1 to 1 and A2 to A1, and then renaming A1
-to `ses--foo' makes `ses--foo' value equal to 1. Then set A1 to 2 and check
-that `ses--foo' becomes 2."
+to `foo' makes `foo' value equal to 1. Then set A1 to 2 and check
+that `foo' becomes 2."
   (let ((ses-initial-size '(3 . 1)))
     (with-temp-buffer
       (ses-mode)
       (dolist (c '((0 0 1) (1 0 A1)))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook); deferred recalc
-      (ses-rename-cell 'ses--foo (ses-get-cell 0 0))
+      (ses-rename-cell 'foo (ses-get-cell 0 0))
       (ses-command-hook); deferred recalc
       (should-not  (local-variable-p 'A1))
-      (should (eq ses--foo 1))
-      (should (equal (ses-cell-formula 1 0) 'ses--foo))
-      (should (eq (bound-and-true-p A2) 1))
+      (should (eq foo 1))
+      (should (equal (ses-cell-formula 1 0) 'foo))
+      (should (eq A2 1))
       (funcall-interactively 'ses-edit-cell 0 0 2)
       (ses-command-hook); deferred recalc
-      (should (eq (bound-and-true-p A2) 2))
-      (should (eq ses--foo 2)))))
+      (should (eq A2 2))
+      (should (eq foo 2)))))
 
 
 ;; ROW INSERTION TESTS
@@ -147,31 +144,32 @@ to A2 and inserting a row, makes A2 value empty, and A3 equal to
       (ses-jump 'A2)
       (ses-insert-row 1)
       (ses-command-hook)
-      (should-not (bound-and-true-p A2))
-      (should (eq (bound-and-true-p A3) 2)))))
+      (should-not A2)
+      (should (eq A3 2)))))
 
-(defvar ses--bar)
+; (defvar ses-tests-trigger nil)
 
 (ert-deftest ses-tests-renamed-cells-row-insertion ()
-  "Check that setting A1 to 1 and A2 to (1+ A1), and then renaming A1 to `ses--foo' and A2 to `ses--bar' jumping
-to `ses--bar' and inserting a row, makes A2 value empty, and `ses--bar' equal to
+  "Check that setting A1 to 1 and A2 to (1+ A1), and then renaming A1 to `foo' and A2 to `bar' jumping
+to `bar' and inserting a row, makes A2 value empty, and `bar' equal to
 2."
+  (setq ses-tests-trigger nil)
   (let ((ses-initial-size '(2 . 1)))
     (with-temp-buffer
       (ses-mode)
       (dolist (c '((0 0 1) (1 0 (1+ A1))))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook)
-      (ses-rename-cell 'ses--foo (ses-get-cell 0 0))
+      (ses-rename-cell 'foo (ses-get-cell 0 0))
       (ses-command-hook)
-      (ses-rename-cell 'ses--bar (ses-get-cell 1 0))
+      (ses-rename-cell 'bar (ses-get-cell 1 0))
       (ses-command-hook)
-      (should (eq ses--bar 2))
-      (ses-jump 'ses--bar)
+      (should (eq bar 2))
+      (ses-jump 'bar)
       (ses-insert-row 1)
       (ses-command-hook)
-      (should-not (bound-and-true-p A2))
-      (should (eq ses--bar 2)))))
+      (should-not A2)
+      (should (eq bar 2)))))
 
 
 (provide 'ses-tests)
diff --git a/test/lisp/simple-tests.el b/test/lisp/simple-tests.el
index 64b341bd46..91fdd5e816 100644
--- a/test/lisp/simple-tests.el
+++ b/test/lisp/simple-tests.el
@@ -489,12 +489,13 @@ See Bug#21722."
       (should (equal pos (point))))))
 
 (ert-deftest line-number-at-pos-when-passing-point ()
-  (with-temp-buffer
-    (insert "a\nb\nc\nd\n")
-    (should (equal (line-number-at-pos 1) 1))
-    (should (equal (line-number-at-pos 3) 2))
-    (should (equal (line-number-at-pos 5) 3))
-    (should (equal (line-number-at-pos 7) 4))))
+  (let (pos)
+    (with-temp-buffer
+      (insert "a\nb\nc\nd\n")
+      (should (equal (line-number-at-pos 1) 1))
+      (should (equal (line-number-at-pos 3) 2))
+      (should (equal (line-number-at-pos 5) 3))
+      (should (equal (line-number-at-pos 7) 4)))))
 
 
 ;;; Auto fill.
diff --git a/test/lisp/term-tests.el b/test/lisp/term-tests.el
index 8aaa61a210..234dfa1f0d 100644
--- a/test/lisp/term-tests.el
+++ b/test/lisp/term-tests.el
@@ -124,18 +124,6 @@ line6\r
                     40 12 (list "\eAnSiTc /f" "oo/\n") 'default-directory)
                    "/foo/"))))
 
-(ert-deftest term-line-wrapping-then-motion ()
-  "Make sure we reset the line-wrapping state after moving cursor.
-A real-life example is the default zsh prompt which writes spaces
-to the end of line (triggering line-wrapping state), and then
-sends a carriage return followed by another space to overwrite
-the first character of the line."
-  (let* ((width 10)
-         (strs (list "x" (make-string (1- width) ?_)
-                     "\r_")))
-    (should (equal (term-test-screen-from-input width 12 strs)
-                   (make-string width ?_)))))
-
 (provide 'term-tests)
 
 ;;; term-tests.el ends here
diff --git a/test/lisp/vc/diff-mode-tests.el b/test/lisp/vc/diff-mode-tests.el
index 7900e41b25..1e35f9f7cd 100644
--- a/test/lisp/vc/diff-mode-tests.el
+++ b/test/lisp/vc/diff-mode-tests.el
@@ -182,7 +182,7 @@ youthfulness
             (with-temp-buffer
               (cd temp-dir)
               (insert patch)
-              (goto-char (point-min))
+              (beginning-of-buffer)
               (diff-apply-hunk)
               (diff-apply-hunk)
               (diff-apply-hunk))
diff --git a/test/lisp/vc/vc-tests.el b/test/lisp/vc/vc-tests.el
index ffab0ff456..c48fd448b4 100644
--- a/test/lisp/vc/vc-tests.el
+++ b/test/lisp/vc/vc-tests.el
@@ -109,7 +109,7 @@
 (require 'ert)
 (require 'vc)
 
-(declare-function w32-application-type "w32proc.c")
+(declare-function w32-application-type "w32proc")
 
 ;; The working horses.
 
diff --git a/test/src/eval-tests.el b/test/src/eval-tests.el
index 50051dfd23..fd12184995 100644
--- a/test/src/eval-tests.el
+++ b/test/src/eval-tests.el
@@ -64,24 +64,4 @@ crash/abort/malloc assert failure on the next test."
         (signal-hook-function #'ignore))
     (should-error (eval-tests--exceed-specbind-limit))))
 
-(defun eval-tests--exceed-specbind-limit ()
-  (defvar eval-tests--var1)
-  (defvar eval-tests--var2)
-  ;; Bind two variables, to make extra sure we hit the
-  ;; `max-specpdl-size' limit before the `max-lisp-eval-depth' limit.
-  (let ((eval-tests--var1 1)
-        (eval-tests--var2 2))
-    ;; Recurse until we hit the limit.
-    (eval-tests--exceed-specbind-limit)))
-
-(ert-deftest eval-exceed-specbind-with-signal-hook ()
-  "Test for Bug#30481.
-Check that Emacs doesn't crash when exceeding specbind limit with
-`signal-hook-function' bound.  NOTE: Without the fix for
-Bug#30481, this test can appear to pass, but cause a
-crash/abort/malloc assert failure on the next test."
-  (let ((max-specpdl-size (/ max-lisp-eval-depth 2))
-        (signal-hook-function #'ignore))
-    (should-error (eval-tests--exceed-specbind-limit))))
-
 ;;; eval-tests.el ends here
diff --git a/test/src/json-tests.el b/test/src/json-tests.el
index 09067bad8c..3bbf9eb96b 100644
--- a/test/src/json-tests.el
+++ b/test/src/json-tests.el
@@ -26,11 +26,6 @@
 (require 'cl-lib)
 (require 'map)
 
-(declare-function json-serialize "json.c" (object))
-(declare-function json-insert "json.c" (object))
-(declare-function json-parse-string "json.c" (string &rest args))
-(declare-function json-parse-buffer "json.c" (&rest args))
-
 (define-error 'json-tests--error "JSON test error")
 
 (ert-deftest json-serialize/roundtrip ()
-- 
2.21.0


From 3e7212a55a21de5ee274314aca707ee2bde87bc8 Mon Sep 17 00:00:00 2001
From: Nick Drozd <nicholasdrozd@gmail.com>
Date: Tue, 8 Jan 2019 18:24:40 -0600
Subject: [PATCH 010/297] Rewrite as_type methods in terms of From (#1221)

Currently a lot of type conversions are written as methods on
LispObject, and the From trait implementations are written in terms of
those. It should be the other way around, so move the as_type logic
into the From implementations and make the as_type functions just do
casts. This will make it easier to remove them entirely in the future,
allowing the type system to do more work.

A few as_type functions, like as_window_configuration_or_error, were
only used in a few places, so those were cut entirely.
---
 rust_src/src/buffers.rs              | 18 +++++++---------
 rust_src/src/charset.rs              | 12 +++++------
 rust_src/src/chartable.rs            | 18 ++++++----------
 rust_src/src/coding.rs               |  3 ++-
 rust_src/src/frames.rs               |  9 ++++----
 rust_src/src/hashtable.rs            | 32 +++++++++++-----------------
 rust_src/src/lisp.rs                 | 12 ++++++++---
 rust_src/src/marker.rs               |  9 ++++----
 rust_src/src/multibyte.rs            | 21 +++++++++++-------
 rust_src/src/numbers.rs              | 26 +++++++++++-----------
 rust_src/src/obarray.rs              | 10 ++-------
 rust_src/src/process.rs              |  9 ++++----
 rust_src/src/symbols.rs              | 26 +++++++++++-----------
 rust_src/src/syntax.rs               | 10 ++++-----
 rust_src/src/threads.rs              |  5 ++---
 rust_src/src/window_configuration.rs | 12 ++++-------
 rust_src/src/windows.rs              |  9 ++++----
 17 files changed, 110 insertions(+), 131 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 641422b743..b550f52ec2 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -433,7 +433,7 @@ impl LispObject {
     }
 
     pub fn as_buffer(self) -> Option<LispBufferRef> {
-        self.as_vectorlike().and_then(|v| v.as_buffer())
+        self.into()
     }
 
     pub fn as_live_buffer(self) -> Option<LispBufferRef> {
@@ -441,14 +441,13 @@ impl LispObject {
     }
 
     pub fn as_buffer_or_error(self) -> LispBufferRef {
-        self.as_buffer()
-            .unwrap_or_else(|| wrong_type!(Qbufferp, self))
+        self.into()
     }
 }
 
 impl From<LispObject> for LispBufferRef {
     fn from(o: LispObject) -> Self {
-        o.as_buffer_or_error()
+        o.as_buffer().unwrap_or_else(|| wrong_type!(Qbufferp, o))
     }
 }
 
@@ -460,7 +459,7 @@ impl From<LispBufferRef> for LispObject {
 
 impl From<LispObject> for Option<LispBufferRef> {
     fn from(o: LispObject) -> Self {
-        o.as_buffer()
+        o.as_vectorlike().and_then(|v| v.as_buffer())
     }
 }
 
@@ -471,18 +470,17 @@ impl LispObject {
     }
 
     pub fn as_overlay(self) -> Option<LispOverlayRef> {
-        self.as_misc().and_then(|m| m.as_overlay())
+        self.into()
     }
 
     pub fn as_overlay_or_error(self) -> LispOverlayRef {
-        self.as_overlay()
-            .unwrap_or_else(|| wrong_type!(Qoverlayp, self))
+        self.into()
     }
 }
 
 impl From<LispObject> for LispOverlayRef {
     fn from(o: LispObject) -> Self {
-        o.as_overlay_or_error()
+        o.as_overlay().unwrap_or_else(|| wrong_type!(Qoverlayp, o))
     }
 }
 
@@ -494,7 +492,7 @@ impl From<LispOverlayRef> for LispObject {
 
 impl From<LispObject> for Option<LispOverlayRef> {
     fn from(o: LispObject) -> Self {
-        o.as_overlay()
+        o.as_misc().and_then(|m| m.as_overlay())
     }
 }
 
diff --git a/rust_src/src/charset.rs b/rust_src/src/charset.rs
index 87072f546e..710d575503 100644
--- a/rust_src/src/charset.rs
+++ b/rust_src/src/charset.rs
@@ -3,19 +3,17 @@
 use remacs_macros::lisp_fn;
 
 use crate::{
-    hashtable::HashLookupResult,
+    hashtable::{HashLookupResult, LispHashTableRef},
     lisp::{defsubr, LispObject},
     remacs_sys::Vcharset_hash_table,
 };
 
 impl LispObject {
     pub fn is_charset(self) -> bool {
-        unsafe {
-            let h_ref = Vcharset_hash_table.as_hash_table_or_error();
-            match h_ref.lookup(self) {
-                HashLookupResult::Found(_) => true,
-                HashLookupResult::Missing(_) => false,
-            }
+        let h_ref: LispHashTableRef = unsafe { Vcharset_hash_table }.into();
+        match h_ref.lookup(self) {
+            HashLookupResult::Found(_) => true,
+            HashLookupResult::Missing(_) => false,
         }
     }
 }
diff --git a/rust_src/src/chartable.rs b/rust_src/src/chartable.rs
index 7d93a6039e..718c1154c9 100644
--- a/rust_src/src/chartable.rs
+++ b/rust_src/src/chartable.rs
@@ -27,27 +27,23 @@ impl LispObject {
     }
 
     pub fn as_char_table(self) -> Option<LispCharTableRef> {
-        self.as_vectorlike().and_then(|v| v.as_char_table())
-    }
-
-    pub fn as_char_table_or_error(self) -> LispCharTableRef {
-        if let Some(chartable) = self.as_char_table() {
-            chartable
-        } else {
-            wrong_type!(Qchar_table_p, self)
-        }
+        self.into()
     }
 }
 
 impl From<LispObject> for LispCharTableRef {
     fn from(o: LispObject) -> Self {
-        o.as_char_table_or_error()
+        if let Some(chartable) = o.as_char_table() {
+            chartable
+        } else {
+            wrong_type!(Qchar_table_p, o)
+        }
     }
 }
 
 impl From<LispObject> for Option<LispCharTableRef> {
     fn from(o: LispObject) -> Self {
-        o.as_char_table()
+        o.as_vectorlike().and_then(|v| v.as_char_table())
     }
 }
 
diff --git a/rust_src/src/coding.rs b/rust_src/src/coding.rs
index 87cac97b5a..1493a68bc4 100644
--- a/rust_src/src/coding.rs
+++ b/rust_src/src/coding.rs
@@ -7,6 +7,7 @@ use crate::{
     hashtable::{
         gethash,
         HashLookupResult::{Found, Missing},
+        LispHashTableRef,
     },
     lisp::defsubr,
     lisp::LispObject,
@@ -30,7 +31,7 @@ fn coding_system_spec(coding_system: LispObject) -> LispObject {
 /// Return the ID of OBJECT.
 /// Same as the CODING_SYSTEM_ID C macro.
 pub fn coding_system_id(object: LispObject) -> isize {
-    let h_ref = unsafe { Vcoding_system_hash_table }.as_hash_table_or_error();
+    let h_ref: LispHashTableRef = unsafe { Vcoding_system_hash_table }.into();
     match h_ref.lookup(object) {
         Found(idx) => idx as isize,
         Missing(_) => -1,
diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index 5e21452855..a30d992c30 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -38,7 +38,7 @@ impl LispFrameRef {
 
 impl From<LispObject> for LispFrameRef {
     fn from(o: LispObject) -> Self {
-        o.as_frame_or_error()
+        o.as_frame().unwrap_or_else(|| wrong_type!(Qframep, o))
     }
 }
 
@@ -50,7 +50,7 @@ impl From<LispFrameRef> for LispObject {
 
 impl From<LispObject> for Option<LispFrameRef> {
     fn from(o: LispObject) -> Self {
-        o.as_frame()
+        o.as_vectorlike().and_then(|v| v.as_frame())
     }
 }
 
@@ -61,13 +61,12 @@ impl LispObject {
     }
 
     pub fn as_frame(self) -> Option<LispFrameRef> {
-        self.as_vectorlike().and_then(|v| v.as_frame())
+        self.into()
     }
 
     // Same as CHECK_FRAME
     pub fn as_frame_or_error(self) -> LispFrameRef {
-        self.as_frame()
-            .unwrap_or_else(|| wrong_type!(Qframep, self))
+        self.into()
     }
 
     pub fn as_live_frame(self) -> Option<LispFrameRef> {
diff --git a/rust_src/src/hashtable.rs b/rust_src/src/hashtable.rs
index 464217d15d..0f170b7486 100644
--- a/rust_src/src/hashtable.rs
+++ b/rust_src/src/hashtable.rs
@@ -134,13 +134,23 @@ impl LispHashTableRef {
 
 impl From<LispObject> for LispHashTableRef {
     fn from(o: LispObject) -> Self {
-        o.as_hash_table_or_error()
+        if o.is_hash_table() {
+            LispHashTableRef::new(o.get_untaggedptr() as *mut Lisp_Hash_Table)
+        } else {
+            wrong_type!(Qhash_table_p, o);
+        }
     }
 }
 
 impl From<LispHashTableRef> for LispObject {
     fn from(h: LispHashTableRef) -> Self {
-        LispObject::from_hash_table(h)
+        let object = LispObject::tag_ptr(h, Lisp_Type::Lisp_Vectorlike);
+        debug_assert!(
+            object.is_vectorlike() && object.get_untaggedptr() == h.as_ptr() as *mut c_void
+        );
+
+        debug_assert!(object.is_hash_table());
+        object
     }
 }
 
@@ -149,24 +159,6 @@ impl LispObject {
         self.as_vectorlike()
             .map_or(false, |v| v.is_pseudovector(pvec_type::PVEC_HASH_TABLE))
     }
-
-    pub fn as_hash_table_or_error(self) -> LispHashTableRef {
-        if self.is_hash_table() {
-            LispHashTableRef::new(self.get_untaggedptr() as *mut Lisp_Hash_Table)
-        } else {
-            wrong_type!(Qhash_table_p, self);
-        }
-    }
-
-    pub fn from_hash_table(hashtable: LispHashTableRef) -> LispObject {
-        let object = LispObject::tag_ptr(hashtable, Lisp_Type::Lisp_Vectorlike);
-        debug_assert!(
-            object.is_vectorlike() && object.get_untaggedptr() == hashtable.as_ptr() as *mut c_void
-        );
-
-        debug_assert!(object.is_hash_table());
-        object
-    }
 }
 
 /// An iterator used for iterating over the indices
diff --git a/rust_src/src/lisp.rs b/rust_src/src/lisp.rs
index 16d1ae06b9..b062300ed7 100644
--- a/rust_src/src/lisp.rs
+++ b/rust_src/src/lisp.rs
@@ -230,17 +230,23 @@ impl LispObject {
     }
 
     pub fn as_subr(self) -> Option<LispSubrRef> {
-        self.as_vectorlike().and_then(|v| v.as_subr())
+        self.into()
     }
 
     pub fn as_subr_or_error(self) -> LispSubrRef {
-        self.as_subr().unwrap_or_else(|| wrong_type!(Qsubrp, self))
+        self.into()
     }
 }
 
 impl From<LispObject> for LispSubrRef {
     fn from(o: LispObject) -> Self {
-        o.as_subr_or_error()
+        o.as_subr().unwrap_or_else(|| wrong_type!(Qsubrp, o))
+    }
+}
+
+impl From<LispObject> for Option<LispSubrRef> {
+    fn from(o: LispObject) -> Self {
+        o.as_vectorlike().and_then(|v| v.as_subr())
     }
 }
 
diff --git a/rust_src/src/marker.rs b/rust_src/src/marker.rs
index 8ae0a4d9bf..50c04e0648 100644
--- a/rust_src/src/marker.rs
+++ b/rust_src/src/marker.rs
@@ -103,7 +103,7 @@ impl LispMarkerRef {
 
 impl From<LispObject> for LispMarkerRef {
     fn from(o: LispObject) -> Self {
-        o.as_marker_or_error()
+        o.as_marker().unwrap_or_else(|| wrong_type!(Qmarkerp, o))
     }
 }
 
@@ -115,7 +115,7 @@ impl From<LispMarkerRef> for LispObject {
 
 impl From<LispObject> for Option<LispMarkerRef> {
     fn from(o: LispObject) -> Self {
-        o.as_marker()
+        o.as_misc().and_then(|m| m.as_marker())
     }
 }
 
@@ -126,12 +126,11 @@ impl LispObject {
     }
 
     pub fn as_marker(self) -> Option<LispMarkerRef> {
-        self.as_misc().and_then(|m| m.as_marker())
+        self.into()
     }
 
     pub fn as_marker_or_error(self) -> LispMarkerRef {
-        self.as_marker()
-            .unwrap_or_else(|| wrong_type!(Qmarkerp, self))
+        self.into()
     }
 }
 
diff --git a/rust_src/src/multibyte.rs b/rust_src/src/multibyte.rs
index ab074d194d..0c169c321d 100644
--- a/rust_src/src/multibyte.rs
+++ b/rust_src/src/multibyte.rs
@@ -259,7 +259,17 @@ impl From<EmacsDouble> for LispObject {
 
 impl From<LispObject> for LispStringRef {
     fn from(o: LispObject) -> Self {
-        o.as_string_or_error()
+        o.as_string().unwrap_or_else(|| wrong_type!(Qstringp, o))
+    }
+}
+
+impl From<LispObject> for Option<LispStringRef> {
+    fn from(o: LispObject) -> Self {
+        if o.is_string() {
+            Some(unsafe { o.as_string_unchecked() })
+        } else {
+            None
+        }
     }
 }
 
@@ -275,16 +285,11 @@ impl LispObject {
     }
 
     pub fn as_string(self) -> Option<LispStringRef> {
-        if self.is_string() {
-            Some(unsafe { self.as_string_unchecked() })
-        } else {
-            None
-        }
+        self.into()
     }
 
     pub fn as_string_or_error(self) -> LispStringRef {
-        self.as_string()
-            .unwrap_or_else(|| wrong_type!(Qstringp, self))
+        self.into()
     }
 
     pub unsafe fn as_string_unchecked(self) -> LispStringRef {
diff --git a/rust_src/src/numbers.rs b/rust_src/src/numbers.rs
index c01a3a318d..f2cd951ea8 100644
--- a/rust_src/src/numbers.rs
+++ b/rust_src/src/numbers.rs
@@ -170,13 +170,22 @@ impl From<EmacsInt> for LispNumber {
 
 impl From<LispObject> for LispNumber {
     fn from(o: LispObject) -> Self {
-        o.as_number_coerce_marker_or_error()
+        o.as_number_coerce_marker()
+            .unwrap_or_else(|| wrong_type!(Qnumber_or_marker_p, o))
     }
 }
 
 impl From<LispObject> for Option<LispNumber> {
     fn from(o: LispObject) -> Self {
-        o.as_number_coerce_marker()
+        if let Some(n) = o.as_fixnum() {
+            Some(LispNumber::Fixnum(n))
+        } else if let Some(f) = o.as_float() {
+            Some(LispNumber::Float(f))
+        } else if let Some(m) = o.as_marker() {
+            Some(LispNumber::Fixnum(m.charpos_or_error() as EmacsInt))
+        } else {
+            None
+        }
     }
 }
 
@@ -207,20 +216,11 @@ impl LispObject {
     */
 
     pub fn as_number_coerce_marker(self) -> Option<LispNumber> {
-        if let Some(n) = self.as_fixnum() {
-            Some(LispNumber::Fixnum(n))
-        } else if let Some(f) = self.as_float() {
-            Some(LispNumber::Float(f))
-        } else if let Some(m) = self.as_marker() {
-            Some(LispNumber::Fixnum(m.charpos_or_error() as EmacsInt))
-        } else {
-            None
-        }
+        self.into()
     }
 
     pub fn as_number_coerce_marker_or_error(self) -> LispNumber {
-        self.as_number_coerce_marker()
-            .unwrap_or_else(|| wrong_type!(Qnumber_or_marker_p, self))
+        self.into()
     }
 }
 
diff --git a/rust_src/src/obarray.rs b/rust_src/src/obarray.rs
index 2577e9cd22..3c9eeadd5f 100644
--- a/rust_src/src/obarray.rs
+++ b/rust_src/src/obarray.rs
@@ -78,15 +78,9 @@ impl LispObarrayRef {
     }
 }
 
-impl LispObject {
-    pub fn as_obarray_or_error(self) -> LispObarrayRef {
-        LispObarrayRef::new(check_obarray(self))
-    }
-}
-
 impl From<LispObject> for LispObarrayRef {
     fn from(o: LispObject) -> LispObarrayRef {
-        o.as_obarray_or_error()
+        LispObarrayRef::new(check_obarray(o))
     }
 }
 
@@ -95,7 +89,7 @@ impl From<LispObject> for Option<LispObarrayRef> {
         if o.is_nil() {
             None
         } else {
-            Some(o.as_obarray_or_error())
+            Some(o.into())
         }
     }
 }
diff --git a/rust_src/src/process.rs b/rust_src/src/process.rs
index cb2bdb53af..8f80a27e9f 100644
--- a/rust_src/src/process.rs
+++ b/rust_src/src/process.rs
@@ -49,18 +49,17 @@ impl LispObject {
     }
 
     pub fn as_process(self) -> Option<LispProcessRef> {
-        self.as_vectorlike().and_then(|v| v.as_process())
+        self.into()
     }
 
     pub fn as_process_or_error(self) -> LispProcessRef {
-        self.as_process()
-            .unwrap_or_else(|| wrong_type!(Qprocessp, self))
+        self.into()
     }
 }
 
 impl From<LispObject> for LispProcessRef {
     fn from(o: LispObject) -> Self {
-        o.as_process_or_error()
+        o.as_process().unwrap_or_else(|| wrong_type!(Qprocessp, o))
     }
 }
 
@@ -72,7 +71,7 @@ impl From<LispProcessRef> for LispObject {
 
 impl From<LispObject> for Option<LispProcessRef> {
     fn from(o: LispObject) -> Self {
-        o.as_process()
+        o.as_vectorlike().and_then(|v| v.as_process())
     }
 }
 
diff --git a/rust_src/src/symbols.rs b/rust_src/src/symbols.rs
index 830198a9b4..58b88acd0d 100644
--- a/rust_src/src/symbols.rs
+++ b/rust_src/src/symbols.rs
@@ -153,7 +153,11 @@ impl LispSymbolRef {
 
 impl From<LispObject> for LispSymbolRef {
     fn from(o: LispObject) -> Self {
-        o.as_symbol_or_error()
+        if let Some(sym) = o.as_symbol() {
+            sym
+        } else {
+            wrong_type!(Qsymbolp, o)
+        }
     }
 }
 
@@ -165,7 +169,11 @@ impl From<LispSymbolRef> for LispObject {
 
 impl From<LispObject> for Option<LispSymbolRef> {
     fn from(o: LispObject) -> Self {
-        o.as_symbol()
+        if o.is_symbol() {
+            Some(LispSymbolRef::new(o.symbol_ptr_value() as *mut Lisp_Symbol))
+        } else {
+            None
+        }
     }
 }
 
@@ -176,21 +184,11 @@ impl LispObject {
     }
 
     pub fn as_symbol(self) -> Option<LispSymbolRef> {
-        if self.is_symbol() {
-            Some(LispSymbolRef::new(
-                self.symbol_ptr_value() as *mut Lisp_Symbol
-            ))
-        } else {
-            None
-        }
+        self.into()
     }
 
     pub fn as_symbol_or_error(self) -> LispSymbolRef {
-        if let Some(sym) = self.as_symbol() {
-            sym
-        } else {
-            wrong_type!(Qsymbolp, self)
-        }
+        self.into()
     }
 
     pub fn symbol_or_string_as_string(self) -> LispStringRef {
diff --git a/rust_src/src/syntax.rs b/rust_src/src/syntax.rs
index 0d528fa31c..ec6f07a1bb 100644
--- a/rust_src/src/syntax.rs
+++ b/rust_src/src/syntax.rs
@@ -98,24 +98,24 @@ pub extern "C" fn check_syntax_table(obj: LispObject) {
 /// Construct a new syntax table and return it.
 /// It is a copy of the TABLE, which defaults to the standard syntax table.
 #[lisp_fn(min = "0")]
-pub fn copy_syntax_table(mut table: LispObject) -> LispObject {
+pub fn copy_syntax_table(mut table: LispObject) -> LispCharTableRef {
     let buffer_table = unsafe { buffer_defaults.syntax_table_ };
     if table.is_not_nil() {
         check_syntax_table(table);
     } else {
         table = buffer_table;
     }
-    let copy = unsafe { Fcopy_sequence(table) };
+    let copy: LispCharTableRef = unsafe { Fcopy_sequence(table) }.into();
 
     // Only the standard syntax table should have a default element.
     // Other syntax tables should inherit from parents instead.
-    unsafe { set_char_table_defalt(copy, Qnil) };
+    unsafe { set_char_table_defalt(copy.into(), Qnil) };
 
     // Copied syntax tables should all have parents.
     // If we copied one with no parent, such as the standard syntax table,
     // use the standard syntax table as the copy's parent.
-    if copy.as_char_table_or_error().parent.is_nil() {
-        unsafe { Fset_char_table_parent(copy, buffer_table) };
+    if copy.parent.is_nil() {
+        unsafe { Fset_char_table_parent(copy.into(), buffer_table) };
     }
     copy
 }
diff --git a/rust_src/src/threads.rs b/rust_src/src/threads.rs
index 241816e311..f2d67d73e1 100644
--- a/rust_src/src/threads.rs
+++ b/rust_src/src/threads.rs
@@ -48,7 +48,7 @@ impl ThreadStateRef {
 
 impl From<LispObject> for ThreadStateRef {
     fn from(o: LispObject) -> Self {
-        o.as_thread_or_error()
+        o.as_thread().unwrap_or_else(|| wrong_type!(Qthreadp, o))
     }
 }
 
@@ -69,8 +69,7 @@ impl LispObject {
     }
 
     pub fn as_thread_or_error(self) -> ThreadStateRef {
-        self.as_thread()
-            .unwrap_or_else(|| wrong_type!(Qthreadp, self))
+        self.into()
     }
 }
 
diff --git a/rust_src/src/window_configuration.rs b/rust_src/src/window_configuration.rs
index fb97f4f5f9..145c4c4602 100644
--- a/rust_src/src/window_configuration.rs
+++ b/rust_src/src/window_configuration.rs
@@ -103,7 +103,8 @@ impl SavedWindowRef {
 
 impl From<LispObject> for SaveWindowDataRef {
     fn from(o: LispObject) -> Self {
-        o.as_window_configuration_or_error()
+        o.as_window_configuration()
+            .unwrap_or_else(|| wrong_type!(Qwindow_configuration_p, o))
     }
 }
 
@@ -112,11 +113,6 @@ impl LispObject {
         self.as_vectorlike()
             .and_then(|v| v.as_window_configuration())
     }
-
-    pub fn as_window_configuration_or_error(self) -> SaveWindowDataRef {
-        self.as_window_configuration()
-            .unwrap_or_else(|| wrong_type!(Qwindow_configuration_p, self))
-    }
 }
 
 /// Return t if OBJECT is a window-configuration object.
@@ -150,8 +146,8 @@ pub extern "C" fn compare_window_configurations(
     ignore_positions: bool,
 ) -> bool {
     compare_window_configurations_rust(
-        configuration1.as_window_configuration_or_error(),
-        configuration2.as_window_configuration_or_error(),
+        configuration1.into(),
+        configuration2.into(),
         ignore_positions,
     )
 }
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 1a758bd642..36294e47bc 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -227,7 +227,7 @@ impl LispWindowRef {
 
 impl From<LispObject> for LispWindowRef {
     fn from(o: LispObject) -> Self {
-        o.as_window_or_error()
+        o.as_window().unwrap_or_else(|| wrong_type!(Qwindowp, o))
     }
 }
 
@@ -239,7 +239,7 @@ impl From<LispWindowRef> for LispObject {
 
 impl From<LispObject> for Option<LispWindowRef> {
     fn from(o: LispObject) -> Self {
-        o.as_window()
+        o.as_vectorlike().and_then(|v| v.as_window())
     }
 }
 
@@ -250,12 +250,11 @@ impl LispObject {
     }
 
     pub fn as_window(self) -> Option<LispWindowRef> {
-        self.as_vectorlike().and_then(|v| v.as_window())
+        self.into()
     }
 
     pub fn as_window_or_error(self) -> LispWindowRef {
-        self.as_window()
-            .unwrap_or_else(|| wrong_type!(Qwindowp, self))
+        self.into()
     }
 
     pub fn as_minibuffer_or_error(self) -> LispWindowRef {
-- 
2.21.0


From 7ddcea91bdb09fc2288f8cc488497d470aa71f72 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Fri, 16 Feb 2018 16:30:02 +0200
Subject: [PATCH 011/297] ; * lisp/textmodes/flyspell.el
 (flyspell-auto-correct-word): Fix last change.

---
 lisp/textmodes/flyspell.el | 1 +
 1 file changed, 1 insertion(+)

diff --git a/lisp/textmodes/flyspell.el b/lisp/textmodes/flyspell.el
index d87cb5e72e..0f64ab2095 100644
--- a/lisp/textmodes/flyspell.el
+++ b/lisp/textmodes/flyspell.el
@@ -1932,6 +1932,7 @@ cycles through the possible corrections of the current word.
 
 See `flyspell-get-word' for details of how this finds the word to
 spell-check."
+ix last change.
   (interactive)
   ;; If we are not in the construct where flyspell should be active,
   ;; invoke the original binding of M-TAB, if that was recorded.
-- 
2.21.0


From 2b6231965159294824d7829578804e1a5f945570 Mon Sep 17 00:00:00 2001
From: Noam Postavsky <npostavs@gmail.com>
Date: Sun, 4 Feb 2018 20:43:26 -0500
Subject: [PATCH 012/297] Use pkg-config to find lcms2 CFLAGS and LIBS
 (Bug#30346)

* configure.ac: Use EMACS_CHECK_MODULES fors LCMS2 rather than
AC_SEARCH_LIBS.
* src/Makefile.in: Get LCMS2_LIBS and LCMS2_CFLAGS from configure,
instead of just LIBLCMS2.
---
 configure.ac | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/configure.ac b/configure.ac
index 141cfe2b0f..ef13d6879e 100644
--- a/configure.ac
+++ b/configure.ac
@@ -3381,6 +3381,24 @@ fi
 AC_SUBST(LCMS2_CFLAGS)
 AC_SUBST(LCMS2_LIBS)
 
+HAVE_ZLIB=no
+LIBZ=
+if test "${with_zlib}" != "no"; then
+  OLIBS=$LIBS
+  AC_SEARCH_LIBS([inflateEnd], [z], [HAVE_ZLIB=yes])
+  LIBS=$OLIBS
+  case $ac_cv_search_inflateEnd in
+    -*) LIBZ=$ac_cv_search_inflateEnd ;;
+  esac
+fi
+if test "${HAVE_ZLIB}" = "yes"; then
+  AC_DEFINE([HAVE_ZLIB], 1, [Define to 1 if you have the zlib library (-lz).])
+  ### mingw32 doesn't use -lz, since it loads the library dynamically.
+  if test "${opsys}" = "mingw32"; then
+     LIBZ=
+  fi
+fi
+
 ### Dynamic modules support
 LIBMODULES=
 HAVE_MODULES=no
-- 
2.21.0


From ec1e4ee43654f7b3770b53d09de122d98c0e1d54 Mon Sep 17 00:00:00 2001
From: Noam Postavsky <npostavs@gmail.com>
Date: Thu, 15 Feb 2018 22:13:51 -0500
Subject: [PATCH 013/297] Avoid memory corruption with specpdl overflow +
 edebug (Bug#30481)

If grow_specpdl fails due to outgrowing max_specpdl_size, it will
signal an error *before* growing the specpdl array.  Therefore, when
handling the signal, specpdl_ptr points past the end of the specpdl
array and any further use of of specpdl before unwinding (e.g., if
edebug binds signal-hook-function) will cause memory corruption.
* src/eval.c (signal_or_quit): Don't call `signal-hook-function' if
the specpdl_ptr is already past the end of the specpdl array.
* test/src/eval-tests.el (eval-tests--exceed-specbind-limit)
(eval-exceed-specbind-with-signal-hook): New test & helper function.
---
 test/src/eval-tests.el | 20 ++++++++++++++++++++
 1 file changed, 20 insertions(+)

diff --git a/test/src/eval-tests.el b/test/src/eval-tests.el
index fd12184995..50051dfd23 100644
--- a/test/src/eval-tests.el
+++ b/test/src/eval-tests.el
@@ -64,4 +64,24 @@ crash/abort/malloc assert failure on the next test."
         (signal-hook-function #'ignore))
     (should-error (eval-tests--exceed-specbind-limit))))
 
+(defun eval-tests--exceed-specbind-limit ()
+  (defvar eval-tests--var1)
+  (defvar eval-tests--var2)
+  ;; Bind two variables, to make extra sure we hit the
+  ;; `max-specpdl-size' limit before the `max-lisp-eval-depth' limit.
+  (let ((eval-tests--var1 1)
+        (eval-tests--var2 2))
+    ;; Recurse until we hit the limit.
+    (eval-tests--exceed-specbind-limit)))
+
+(ert-deftest eval-exceed-specbind-with-signal-hook ()
+  "Test for Bug#30481.
+Check that Emacs doesn't crash when exceeding specbind limit with
+`signal-hook-function' bound.  NOTE: Without the fix for
+Bug#30481, this test can appear to pass, but cause a
+crash/abort/malloc assert failure on the next test."
+  (let ((max-specpdl-size (/ max-lisp-eval-depth 2))
+        (signal-hook-function #'ignore))
+    (should-error (eval-tests--exceed-specbind-limit))))
+
 ;;; eval-tests.el ends here
-- 
2.21.0


From 1e13472be9abecbee6c82e9d62c9b27b8b9421d9 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Tue, 20 Feb 2018 06:22:57 +0200
Subject: [PATCH 014/297] Fix documentation of 'flyspell-auto-correct-word'

* lisp/textmodes/flyspell.el (flyspell-get-word): Elaborate in the
doc string on how the function looks for the word to spell-check.
(flyspell-word, flyspell-auto-correct-word): Refer to
'flyspell-get-word' for details about finding the word.
(Bug#30462)
---
 lisp/textmodes/flyspell.el | 1 -
 1 file changed, 1 deletion(-)

diff --git a/lisp/textmodes/flyspell.el b/lisp/textmodes/flyspell.el
index 0f64ab2095..d87cb5e72e 100644
--- a/lisp/textmodes/flyspell.el
+++ b/lisp/textmodes/flyspell.el
@@ -1932,7 +1932,6 @@ cycles through the possible corrections of the current word.
 
 See `flyspell-get-word' for details of how this finds the word to
 spell-check."
-ix last change.
   (interactive)
   ;; If we are not in the construct where flyspell should be active,
   ;; invoke the original binding of M-TAB, if that was recorded.
-- 
2.21.0


From 5d5915f172bd336031a70fe6332366a3dff93249 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Wed, 21 Feb 2018 20:32:11 +0200
Subject: [PATCH 015/297] More improvements in the Emacs manual

* doc/emacs/help.texi (Misc Help):
* doc/emacs/m-x.texi (M-x):
* doc/emacs/mini.texi (Minibuffer File, Repetition): Prevent
breaking of command sequences between lines.  Reported by Wojciech
Politarczyk <w.politarczyk@gmail.com> in emacs-manual-bugs@gnu.org.

* doc/emacs/sending.texi (Header Editing): Fix capitalization.
---
 doc/emacs/sending.texi | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/doc/emacs/sending.texi b/doc/emacs/sending.texi
index b7bdd69c7c..5652f58322 100644
--- a/doc/emacs/sending.texi
+++ b/doc/emacs/sending.texi
@@ -424,7 +424,7 @@ Move to the @samp{Bcc} header (@code{message-goto-bcc}).
 @item C-c C-f C-r
 Move to the @samp{Reply-to} header (@code{message-goto-reply-to}).
 @item C-c C-f C-f
-Move to the @samp{Mail-Followup-To} header field
+Move to the @samp{Mail-followup-to} header field
 (@code{message-goto-followup-to}).
 @item C-c C-f C-w
 Add a new @samp{Fcc} header field, with file-name completion
-- 
2.21.0


From 0e026e06d572beb8dfa2be768742e13d951e7335 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Thu, 22 Feb 2018 09:37:00 +0200
Subject: [PATCH 016/297] Fix capitalization of "Mail-Followup-To"

* doc/emacs/sending.texi (Header Editing, Mail Headers):
Standardize on "Mail-Followup-To" as the capitalization.
---
 doc/emacs/sending.texi | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/doc/emacs/sending.texi b/doc/emacs/sending.texi
index 5652f58322..b7bdd69c7c 100644
--- a/doc/emacs/sending.texi
+++ b/doc/emacs/sending.texi
@@ -424,7 +424,7 @@ Move to the @samp{Bcc} header (@code{message-goto-bcc}).
 @item C-c C-f C-r
 Move to the @samp{Reply-to} header (@code{message-goto-reply-to}).
 @item C-c C-f C-f
-Move to the @samp{Mail-followup-to} header field
+Move to the @samp{Mail-Followup-To} header field
 (@code{message-goto-followup-to}).
 @item C-c C-f C-w
 Add a new @samp{Fcc} header field, with file-name completion
-- 
2.21.0


From 5ca5982e0b522076f75d4c216be9589a431824fe Mon Sep 17 00:00:00 2001
From: Daniel Colascione <dancol@dancol.org>
Date: Thu, 22 Feb 2018 17:28:38 -0800
Subject: [PATCH 017/297] Remove unnecessary explicit subword-mode use from
 isearch

* lisp/isearch.el (isearch-yank-word-or-char): Remove explicit
use of subword-mode. These days, subword-mode use is an
automatic side effect of forward-word.
---
 lisp/isearch.el | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/lisp/isearch.el b/lisp/isearch.el
index a41adf0c2c..533ec7445e 100644
--- a/lisp/isearch.el
+++ b/lisp/isearch.el
@@ -2091,6 +2091,12 @@ If optional ARG is non-nil, pull in the next ARG characters."
   (isearch-yank-internal (lambda () (forward-char arg) (point))))
 
 (defun isearch--yank-char-or-syntax (syntax-list fn)
+||||||| parent of b7542b2a0a... Remove unnecessary explicit subword-mode use from isearch
+(declare-function subword-forward "subword" (&optional arg))
+(defun isearch-yank-word-or-char ()
+  "Pull next character, subword or word from buffer into search string.
+Subword is used when `subword-mode' is activated. "
+  (interactive)
   (isearch-yank-internal
    (lambda ()
      (if (or (memq (char-syntax (or (char-after) 0)) syntax-list)
-- 
2.21.0


From c4f051fb796f8df2d1411b605601562436164913 Mon Sep 17 00:00:00 2001
From: Daniel Colascione <dancol@dancol.org>
Date: Thu, 22 Feb 2018 17:42:48 -0800
Subject: [PATCH 018/297] Add isearch-yank-symbol-or-char

* doc/emacs/search.texi (Isearch Yank): Document new
function, keybindings.

* etc/NEWS: Mention isearch changes.

* lisp/isearch.el (isearch--yank-char-or-syntax): New function.
(isearch-yank-word-or-char): Call it.
(isearch-yank-symbol-or-char): New function.
(isearch-mode-map): Change 'C-M-w' binding from
'isearch-del-char' to isearch-yank-symbol-or-char; add 'C-M-d'
binding for 'isearch-del-char'.
---
 lisp/isearch.el | 6 ------
 1 file changed, 6 deletions(-)

diff --git a/lisp/isearch.el b/lisp/isearch.el
index 533ec7445e..a41adf0c2c 100644
--- a/lisp/isearch.el
+++ b/lisp/isearch.el
@@ -2091,12 +2091,6 @@ If optional ARG is non-nil, pull in the next ARG characters."
   (isearch-yank-internal (lambda () (forward-char arg) (point))))
 
 (defun isearch--yank-char-or-syntax (syntax-list fn)
-||||||| parent of b7542b2a0a... Remove unnecessary explicit subword-mode use from isearch
-(declare-function subword-forward "subword" (&optional arg))
-(defun isearch-yank-word-or-char ()
-  "Pull next character, subword or word from buffer into search string.
-Subword is used when `subword-mode' is activated. "
-  (interactive)
   (isearch-yank-internal
    (lambda ()
      (if (or (memq (char-syntax (or (char-after) 0)) syntax-list)
-- 
2.21.0


From 2b18a40b1b24356db112631b2025053cd9c3b999 Mon Sep 17 00:00:00 2001
From: Daniel Colascione <dancol@dancol.org>
Date: Thu, 22 Feb 2018 17:45:01 -0800
Subject: [PATCH 019/297] Add more build outputs to .gitignore

* .gitignore: Add more generated files
---
 .gitignore | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/.gitignore b/.gitignore
index 989f404bbf..d5798f52a4 100644
--- a/.gitignore
+++ b/.gitignore
@@ -49,6 +49,9 @@ src/config.h
 src/epaths.h
 src/emacs-module.h
 
+# Miscellaneous build stuf
+build-aux/
+
 # C-level sources built by 'make'.
 lib/alloca.h
 lib/byteswap.h
@@ -113,6 +116,9 @@ lisp/subdirs.el
 
 # Dependencies.
 deps/
+lib/.deps
+src/stamp-h.in
+src/stamp-h1
 
 # Logs and temporaries.
 *.log
-- 
2.21.0


From a80e7e649caa1637a88bc440f2e747bf2cb7f794 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Fri, 23 Feb 2018 11:57:52 -0800
Subject: [PATCH 020/297] * .gitignore: revert latest change; not currently
 needed

---
 .gitignore | 6 ------
 1 file changed, 6 deletions(-)

diff --git a/.gitignore b/.gitignore
index d5798f52a4..989f404bbf 100644
--- a/.gitignore
+++ b/.gitignore
@@ -49,9 +49,6 @@ src/config.h
 src/epaths.h
 src/emacs-module.h
 
-# Miscellaneous build stuf
-build-aux/
-
 # C-level sources built by 'make'.
 lib/alloca.h
 lib/byteswap.h
@@ -116,9 +113,6 @@ lisp/subdirs.el
 
 # Dependencies.
 deps/
-lib/.deps
-src/stamp-h.in
-src/stamp-h1
 
 # Logs and temporaries.
 *.log
-- 
2.21.0


From 8892ab250433021beff8aa68f13dfd718210b9dc Mon Sep 17 00:00:00 2001
From: Daniel Colascione <dancol@dancol.org>
Date: Mon, 26 Feb 2018 09:18:02 -0800
Subject: [PATCH 021/297] Make bare "make" in src actually build emacs again

* src/Makefile.in (all): Move target ahead of dep-file inclusion.
---
 src/Makefile.in | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/src/Makefile.in b/src/Makefile.in
index 0e345c4f3f..04e03e7557 100644
--- a/src/Makefile.in
+++ b/src/Makefile.in
@@ -453,6 +453,10 @@ ALLOBJS = $(FIRSTFILE_OBJ) $(VMLIMIT_OBJ) $(obj) -lremacs $(otherobj)
 all: remacs$(EXEEXT) $(OTHER_FILES)
 .PHONY: all
 
+# Must be first, before dep inclusion!
+all: emacs$(EXEEXT) $(OTHER_FILES)
+.PHONY: all
+
 AUTO_DEPEND = @AUTO_DEPEND@
 DEPDIR = deps
 ifeq ($(AUTO_DEPEND),yes)
-- 
2.21.0


From dd3e0511abc3ca907e5e51fc3c0a667a5a44269a Mon Sep 17 00:00:00 2001
From: Stefan Monnier <monnier@iro.umontreal.ca>
Date: Tue, 27 Feb 2018 20:39:06 -0500
Subject: [PATCH 022/297] * lisp/gnus/mm-extern.el: Use lexical-binding

Don't require 'cl'.
(mm-extern-anon-ftp): Remove unused var 'mode'.
---
 lisp/gnus/mm-extern.el | 19 ++++++++-----------
 1 file changed, 8 insertions(+), 11 deletions(-)

diff --git a/lisp/gnus/mm-extern.el b/lisp/gnus/mm-extern.el
index e2f8bd4af3..fbae669ce9 100644
--- a/lisp/gnus/mm-extern.el
+++ b/lisp/gnus/mm-extern.el
@@ -1,4 +1,4 @@
-;;; mm-extern.el --- showing message/external-body
+;;; mm-extern.el --- showing message/external-body  -*- lexical-binding:t -*-
 
 ;; Copyright (C) 2000-2018 Free Software Foundation, Inc.
 
@@ -24,8 +24,6 @@
 
 ;;; Code:
 
-(eval-when-compile (require 'cl))
-
 (require 'mm-util)
 (require 'mm-decode)
 (require 'mm-url)
@@ -33,13 +31,13 @@
 (defvar gnus-article-mime-handles)
 
 (defvar mm-extern-function-alist
-  '((local-file . mm-extern-local-file)
-    (url . mm-extern-url)
-    (anon-ftp . mm-extern-anon-ftp)
-    (ftp . mm-extern-ftp)
-;;;     (tftp . mm-extern-tftp)
-    (mail-server . mm-extern-mail-server)
-;;;     (afs . mm-extern-afs))
+  `((local-file . ,#'mm-extern-local-file)
+    (url . ,#'mm-extern-url)
+    (anon-ftp . ,#'mm-extern-anon-ftp)
+    (ftp . ,#'mm-extern-ftp)
+    ;; (tftp . ,#'mm-extern-tftp)
+    (mail-server . ,#'mm-extern-mail-server)
+    ;; (afs . ,#'mm-extern-afs))
     ))
 
 (defvar mm-extern-anonymous "anonymous")
@@ -72,7 +70,6 @@
 	 (name (cdr (assq 'name params)))
 	 (site (cdr (assq 'site params)))
 	 (directory (cdr (assq 'directory params)))
-	 (mode (cdr (assq 'mode params)))
 	 (path (concat "/" (or mm-extern-anonymous
 			       (read-string (format "ID for %s: " site)))
 		       "@" site ":" directory "/" name))
-- 
2.21.0


From 34d211a02ca8639f2afd300901c8ae3623627982 Mon Sep 17 00:00:00 2001
From: Stefan Monnier <monnier@iro.umontreal.ca>
Date: Tue, 27 Feb 2018 20:47:23 -0500
Subject: [PATCH 023/297] * lisp/gnus/mm-decode.el: Use lexical-binding and use
 cl-lib

(mm-display-parts): Remove unused arg 'no-default'.  Use 'cond'.
(mm-display-external): Use closures rather than `(lambda ...).
Don't bother with 'lexical-let'.
(mm-insert-part): No need for string-to-multibyte now that
'insert' will do that for us now (it used to behave more like
string-make-multibyte).
(mm-pipe-part): Remove unused var 'name'.
(shr-width, shr-content-function, shr-inhibit-images): Declare.
(mm-shr): Use a closure rather than `(lambda ...).
---
 lisp/gnus/mm-decode.el | 125 ++++++++++++++++++++---------------------
 1 file changed, 61 insertions(+), 64 deletions(-)

diff --git a/lisp/gnus/mm-decode.el b/lisp/gnus/mm-decode.el
index e1a0435b55..372b6da44b 100644
--- a/lisp/gnus/mm-decode.el
+++ b/lisp/gnus/mm-decode.el
@@ -1,4 +1,4 @@
-;;; mm-decode.el --- Functions for decoding MIME things
+;;; mm-decode.el --- Functions for decoding MIME things  -*- lexical-binding:t -*-
 
 ;; Copyright (C) 1998-2018 Free Software Foundation, Inc.
 
@@ -773,15 +773,16 @@ MIME-Version header before proceeding."
       (insert-buffer-substring obuf beg)
       (current-buffer))))
 
-(defun mm-display-parts (handle &optional no-default)
-  (if (stringp (car handle))
-      (mapcar 'mm-display-parts (cdr handle))
-    (if (bufferp (car handle))
-	(save-restriction
-	  (narrow-to-region (point) (point))
-	  (mm-display-part handle)
-	  (goto-char (point-max)))
-      (mapcar 'mm-display-parts handle))))
+(defun mm-display-parts (handle)
+  (cond
+   ((stringp (car handle)) (mapcar #'mm-display-parts (cdr handle)))
+   ((bufferp (car handle))
+    (save-restriction
+      (narrow-to-region (point) (point))
+      (mm-display-part handle)
+      (goto-char (point-max))))
+   (t
+    (mapcar #'mm-display-parts handle))))
 
 (autoload 'mailcap-parse-mailcaps "mailcap")
 (autoload 'mailcap-mime-info "mailcap")
@@ -961,15 +962,15 @@ external if displayed external."
 				      mm-external-terminal-program
 				      "-e" shell-file-name
 				      shell-command-switch command)
-		       `(lambda (process state)
-			  (if (eq 'exit (process-status process))
-			      (run-at-time
-			       60.0 nil
-			       (lambda ()
-				 (ignore-errors (delete-file ,file))
-				 (ignore-errors (delete-directory
-						 ,(file-name-directory
-						   file))))))))
+		       (lambda (process _state)
+			 (if (eq 'exit (process-status process))
+			     (run-at-time
+			      60.0 nil
+			      (lambda ()
+				(ignore-errors (delete-file file))
+				(ignore-errors (delete-directory
+						(file-name-directory
+						 file))))))))
 		    (require 'term)
 		    (require 'gnus-win)
 		    (set-buffer
@@ -982,13 +983,13 @@ external if displayed external."
 		    (term-char-mode)
 		    (set-process-sentinel
 		     (get-buffer-process buffer)
-		     `(lambda (process state)
-			(when (eq 'exit (process-status process))
-			  (ignore-errors (delete-file ,file))
-			  (ignore-errors
-			    (delete-directory ,(file-name-directory file)))
-			  (gnus-configure-windows
-			   ',gnus-current-window-configuration))))
+                     (let ((wc gnus-current-window-configuration))
+		       (lambda (process _state)
+			 (when (eq 'exit (process-status process))
+			   (ignore-errors (delete-file file))
+			   (ignore-errors
+			     (delete-directory (file-name-directory file)))
+			   (gnus-configure-windows wc)))))
 		    (gnus-configure-windows 'display-term))
 		(mm-handle-set-external-undisplayer handle (cons file buffer))
 		(add-to-list 'mm-temp-files-to-be-deleted file t))
@@ -1032,34 +1033,29 @@ external if displayed external."
 				   shell-command-switch command)
 		    (set-process-sentinel
 		     (get-buffer-process buffer)
-		     (lexical-let ((outbuf outbuf)
-				   (file file)
-				   (buffer buffer)
-				   (command command)
-				   (handle handle))
-		       (lambda (process state)
-			 (when (eq (process-status process) 'exit)
-			   (run-at-time
-			    60.0 nil
-			    (lambda ()
-			      (ignore-errors (delete-file file))
-			      (ignore-errors (delete-directory
-					      (file-name-directory file)))))
-			   (when (buffer-live-p outbuf)
-			     (with-current-buffer outbuf
-			       (let ((buffer-read-only nil)
-				     (point (point)))
-				 (forward-line 2)
-				 (let ((start (point)))
-				   (mm-insert-inline
-				    handle (with-current-buffer buffer
-					     (buffer-string)))
-				   (put-text-property start (point)
-						      'face 'mm-command-output))
-				 (goto-char point))))
-			   (when (buffer-live-p buffer)
-			     (kill-buffer buffer)))
-			 (message "Displaying %s...done" command)))))
+		     (lambda (process _state)
+		       (when (eq (process-status process) 'exit)
+			 (run-at-time
+			  60.0 nil
+			  (lambda ()
+			    (ignore-errors (delete-file file))
+			    (ignore-errors (delete-directory
+					    (file-name-directory file)))))
+			 (when (buffer-live-p outbuf)
+			   (with-current-buffer outbuf
+			     (let ((buffer-read-only nil)
+				   (point (point)))
+			       (forward-line 2)
+			       (let ((start (point)))
+				 (mm-insert-inline
+				  handle (with-current-buffer buffer
+					   (buffer-string)))
+				 (put-text-property start (point)
+						    'face 'mm-command-output))
+			       (goto-char point))))
+			 (when (buffer-live-p buffer)
+			   (kill-buffer buffer)))
+		       (message "Displaying %s...done" command))))
 		(mm-handle-set-external-undisplayer
 		 handle (cons file buffer))
 		(add-to-list 'mm-temp-files-to-be-deleted file t))
@@ -1170,9 +1166,9 @@ external if displayed external."
     (goto-char (point-min))))
 
 (defun mm-assoc-string-match (alist type)
-  (dolist (elem alist)
+  (cl-dolist (elem alist)
     (when (string-match (car elem) type)
-      (return elem))))
+      (cl-return elem))))
 
 (defun mm-automatic-display-p (handle)
   "Say whether the user wants HANDLE to be displayed automatically."
@@ -1302,8 +1298,6 @@ are ignored."
 			 'gnus-decoded)
 		     (with-current-buffer (mm-handle-buffer handle)
 		       (buffer-string)))
-		    ((mm-multibyte-p)
-		     (string-to-multibyte (mm-get-part handle no-cache)))
 		    (t
 		     (mm-get-part handle no-cache)))))
     (save-restriction
@@ -1448,8 +1442,7 @@ text/html\\(?:;\\s-*charset=\\([^\t\n\r \"'>]+\\)\\)?[^>]*>" nil t)
 (defun mm-pipe-part (handle &optional cmd)
   "Pipe HANDLE to a process.
 Use CMD as the process."
-  (let ((name (mail-content-type-get (mm-handle-type handle) 'name))
-	(command (or cmd
+  (let ((command (or cmd
 		     (read-shell-command
 		      "Shell command on MIME part: " mm-last-shell-command))))
     (mm-with-unibyte-buffer
@@ -1784,6 +1777,9 @@ If RECURSIVE, search recursively."
 (declare-function shr-insert-document "shr" (dom))
 (defvar shr-blocked-images)
 (defvar shr-use-fonts)
+(defvar shr-width)
+(defvar shr-content-function)
+(defvar shr-inhibit-images)
 
 (defun mm-shr (handle)
   ;; Require since we bind its variables.
@@ -1840,10 +1836,11 @@ text/html;\\s-*charset=\\([^\t\n\r \"'>]+\\)[^>]*>" nil t)
       (mm-convert-shr-links)
       (mm-handle-set-undisplayer
        handle
-       `(lambda ()
-	  (let ((inhibit-read-only t))
-	    (delete-region ,(point-min-marker)
-			   ,(point-max-marker))))))))
+       (let ((min (point-min-marker))
+             (max (point-max-marker)))
+         (lambda ()
+	   (let ((inhibit-read-only t))
+	     (delete-region min max))))))))
 
 (defvar shr-image-map)
 
-- 
2.21.0


From a0698f6445155c93c4ebd092e51cab2d40b2d8c7 Mon Sep 17 00:00:00 2001
From: Dmitry Gutov <dgutov@yandex.ru>
Date: Wed, 28 Feb 2018 03:38:37 +0200
Subject: [PATCH 024/297] Fix xref--next-error-function behavior WRT current
 buffer

* lisp/progmodes/xref.el (xref--show-location): Make sure to
make the target window selected at the end, and its buffer
current (bug#20489).
---
 lisp/progmodes/xref.el | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/lisp/progmodes/xref.el b/lisp/progmodes/xref.el
index e0f5b2d367..1c1fc597c5 100644
--- a/lisp/progmodes/xref.el
+++ b/lisp/progmodes/xref.el
@@ -501,8 +501,9 @@ SELECT is `quit', also quit the *xref* window."
              (xref-buffer (current-buffer)))
         (cond (select
                (if (eq select 'quit) (quit-window nil nil))
-               (with-current-buffer xref-buffer
-                 (select-window (xref--show-pos-in-buf marker buf))))
+               (select-window
+                (with-current-buffer xref-buffer
+                  (xref--show-pos-in-buf marker buf))))
               (t
                (save-selected-window
                  (xref--with-dedicated-window
-- 
2.21.0


From 68a1bedd2214ed1f6a835606a459cf33c6e9edbe Mon Sep 17 00:00:00 2001
From: Dmitry Gutov <dgutov@yandex.ru>
Date: Wed, 28 Feb 2018 04:03:16 +0200
Subject: [PATCH 025/297] xref--next-error-function: Move xref's window point

* lisp/progmodes/xref.el (xref--next-error-function): Move
xref's window point if it's visible.  When we don't do that,
navigation can start looping after a while.
---
 lisp/progmodes/xref.el | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/lisp/progmodes/xref.el b/lisp/progmodes/xref.el
index 1c1fc597c5..5a9a7a925a 100644
--- a/lisp/progmodes/xref.el
+++ b/lisp/progmodes/xref.el
@@ -693,6 +693,10 @@ references displayed in the current *xref* buffer."
     (dotimes (_ n)
       (setq xref (xref--search-property 'xref-item backward)))
     (cond (xref
+           ;; Save the current position (when the buffer is visible,
+           ;; it gets reset to that window's point from time to time).
+           (let ((win (get-buffer-window (current-buffer))))
+             (and win (set-window-point win (point))))
            (xref--show-location (xref-item-location xref) t))
           (t
            (error "No %s xref" (if backward "previous" "next"))))))
-- 
2.21.0


From 752383513f616c9ddb6d6a85c7960fba7c2c6215 Mon Sep 17 00:00:00 2001
From: Dmitry Gutov <dgutov@yandex.ru>
Date: Wed, 28 Feb 2018 15:43:40 +0200
Subject: [PATCH 026/297] Support PREDICATE in ido-read-buffer

* lisp/ido.el (ido-predicate): New variable.
(ido-read-buffer): Bind it.
(ido-make-buffer-list): Use it.
---
 lisp/ido.el | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/lisp/ido.el b/lisp/ido.el
index da0c9d463d..7ff3d6820b 100644
--- a/lisp/ido.el
+++ b/lisp/ido.el
@@ -1135,6 +1135,9 @@ selected.")
 (defvar ido-current-directory nil
   "Current directory for `ido-find-file'.")
 
+(defvar ido-predicate nil
+  "Current completion predicate.")
+
 (defvar ido-auto-merge-timer nil
   "Delay timer for auto merge.")
 
@@ -3480,6 +3483,11 @@ it is put to the start of the list."
     (if ido-temp-list
 	(nconc ido-temp-list ido-current-buffers)
       (setq ido-temp-list ido-current-buffers))
+    (if ido-predicate
+        (setq ido-temp-list (seq-filter
+                             (lambda (name)
+                               (funcall ido-predicate (cons name (get-buffer name))))
+                             ido-temp-list)))
     (if default
 	(setq ido-temp-list
 	      (cons default (delete default ido-temp-list))))
@@ -4845,10 +4853,13 @@ Modified from `icomplete-completions'."
 Return the name of a buffer selected.
 PROMPT is the prompt to give to the user.  DEFAULT if given is the default
 buffer to be selected, which will go to the front of the list.
-If REQUIRE-MATCH is non-nil, an existing buffer must be selected."
+If REQUIRE-MATCH is non-nil, an existing buffer must be selected.
+Optional arg PREDICATE if non-nil is a function limiting the
+buffers that can be considered."
   (let* ((ido-current-directory nil)
 	 (ido-directory-nonreadable nil)
 	 (ido-directory-too-big nil)
+         (ido-predicate predicate)
 	 (ido-context-switch-command 'ignore)
 	 (buf (ido-read-internal 'buffer prompt 'ido-buffer-history default require-match)))
     (if (eq ido-exit 'fallback)
-- 
2.21.0


From 62e9420265ddcdb3c09c52a815400a70835a58cd Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Wed, 28 Feb 2018 15:10:11 +0100
Subject: [PATCH 027/297] Some minor Tramp tweaks

* lisp/net/tramp-adb.el (tramp-adb-get-ls-command): Fix docstring.

* lisp/net/tramp-sh.el (tramp-vc-registered-read-file-names):
Quote file.

* lisp/net/tramp.el (tramp-handle-substitute-in-file-name):
Make it more robust.
---
 lisp/net/tramp-adb.el |  2 +-
 lisp/net/tramp-sh.el  | 10 ++++++----
 lisp/net/tramp.el     |  2 +-
 3 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/lisp/net/tramp-adb.el b/lisp/net/tramp-adb.el
index cb80506786..7ac61b843f 100644
--- a/lisp/net/tramp-adb.el
+++ b/lisp/net/tramp-adb.el
@@ -458,7 +458,7 @@ pass to the OPERATION."
 			   result)))))))))
 
 (defun tramp-adb-get-ls-command (vec)
-  "Determine `ls' command at its arguments."
+  "Determine `ls' command and its arguments."
   (with-tramp-connection-property vec "ls"
     (tramp-message vec 5 "Finding a suitable `ls' command")
     (cond
diff --git a/lisp/net/tramp-sh.el b/lisp/net/tramp-sh.el
index ff5d404aaa..f619ac3063 100644
--- a/lisp/net/tramp-sh.el
+++ b/lisp/net/tramp-sh.el
@@ -962,15 +962,16 @@ busybox awk '{}' </dev/null"
 (defconst tramp-vc-registered-read-file-names
   "echo \"(\"
 while read file; do
+    quoted=`echo \"$file\" | sed -e \"s/\\\"/\\\\\\\\\\\\\\\\\\\"/\"`
     if %s \"$file\"; then
-	echo \"(\\\"$file\\\" \\\"file-exists-p\\\" t)\"
+	echo \"(\\\"$quoted\\\" \\\"file-exists-p\\\" t)\"
     else
-	echo \"(\\\"$file\\\" \\\"file-exists-p\\\" nil)\"
+	echo \"(\\\"$quoted\\\" \\\"file-exists-p\\\" nil)\"
     fi
     if %s \"$file\"; then
-	echo \"(\\\"$file\\\" \\\"file-readable-p\\\" t)\"
+	echo \"(\\\"$quoted\\\" \\\"file-readable-p\\\" t)\"
     else
-	echo \"(\\\"$file\\\" \\\"file-readable-p\\\" nil)\"
+	echo \"(\\\"$quoted\\\" \\\"file-readable-p\\\" nil)\"
     fi
 done
 echo \")\""
@@ -2054,6 +2055,7 @@ file names."
 	  (t2 (tramp-tramp-file-p newname))
 	  (length (tramp-compat-file-attribute-size
 		   (file-attributes (file-truename filename))))
+	  ;; `file-extended-attributes' exists since Emacs 24.4.
 	  (attributes (and preserve-extended-attributes
 			   (apply 'file-extended-attributes (list filename)))))
 
diff --git a/lisp/net/tramp.el b/lisp/net/tramp.el
index bae039dba1..6011239253 100644
--- a/lisp/net/tramp.el
+++ b/lisp/net/tramp.el
@@ -3564,7 +3564,7 @@ support symbolic links."
 		  (concat (file-remote-p filename)
 			  (substitute-in-file-name localname))))))
       ;; "/m:h:~" does not work for completion.  We use "/m:h:~/".
-      (if (string-match "^~$" localname)
+      (if (and (stringp localname) (string-equal "~" localname))
 	  (concat filename "/")
 	filename))))
 
-- 
2.21.0


From 8df62b7020cbc8063501cd514c30eb3170e0f016 Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Sat, 24 Feb 2018 17:56:43 +0100
Subject: [PATCH 028/297] * doc/misc/ebrowse.texi: Use @key{} for keys.

---
 doc/misc/ebrowse.texi | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/doc/misc/ebrowse.texi b/doc/misc/ebrowse.texi
index 9ac2af1bcf..b6f2c1865f 100644
--- a/doc/misc/ebrowse.texi
+++ b/doc/misc/ebrowse.texi
@@ -482,7 +482,7 @@ you are working on, some classes will only be known to exist but the
 location of their declarations and definitions will not be known.
 
 @item @key{RET}
-Works like @kbd{SPC}, except that it finds the class
+Works like @kbd{@key{SPC}}, except that it finds the class
 declaration rather than viewing it, so that it is ready for
 editing.
 @end table
@@ -886,7 +886,7 @@ the member.
 This command finds the declaration of the member the cursor is on.
 
 @item @key{SPC}
-This is the same command as @kbd{RET}, but views the member definition
+This is the same command as @kbd{@key{RET}}, but views the member definition
 instead of finding the member's source file.
 
 @item v
@@ -1314,7 +1314,7 @@ the next position stored in the position stack.
 
 @item C-c C-m p
 Displays an electric buffer showing all positions saved in the stack.
-You can select a position by pressing @kbd{SPC} in a line.  You can
+You can select a position by pressing @kbd{@key{SPC}} in a line.  You can
 view a position with @kbd{v}.
 @end table
 
-- 
2.21.0


From e0564da8fb8bd60ed5a5687675be4e180ff2bfa1 Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Sat, 24 Feb 2018 20:40:39 +0100
Subject: [PATCH 029/297] Fix @cindex entries in org.texi

* doc/misc/org.texi: Fix @cindex entries.  Use consistently
@code{} for keywords.
---
 doc/misc/org.texi | 657 +++++++++++++++++++++++-----------------------
 1 file changed, 328 insertions(+), 329 deletions(-)

diff --git a/doc/misc/org.texi b/doc/misc/org.texi
index 17931905f1..03a18e4738 100644
--- a/doc/misc/org.texi
+++ b/doc/misc/org.texi
@@ -1340,9 +1340,9 @@ following lines anywhere in the buffer:
 #+STARTUP: showeverything
 @end example
 
-@cindex property, VISIBILITY
+@cindex property, @code{VISIBILITY}
 @noindent
-Furthermore, any entries with a @samp{VISIBILITY} property (@pxref{Properties
+Furthermore, any entries with a @code{VISIBILITY} property (@pxref{Properties
 and columns}) will get their visibility adapted accordingly.  Allowed values
 for this property are @code{folded}, @code{children}, @code{content}, and
 @code{all}.
@@ -1350,7 +1350,7 @@ for this property are @code{folded}, @code{children}, @code{content}, and
 @table @asis
 @orgcmd{C-u C-u @key{TAB},org-set-startup-visibility}
 Switch back to the startup visibility of the buffer, i.e., whatever is
-requested by startup options and @samp{VISIBILITY} properties in individual
+requested by startup options and @code{VISIBILITY} properties in individual
 entries.
 @end table
 
@@ -1817,7 +1817,7 @@ or by a custom function.
 @cindex drawers
 @cindex visibility cycling, drawers
 
-@cindex org-insert-drawer
+@cindex @code{org-insert-drawer}
 @kindex C-c C-x d
 Sometimes you want to keep information associated with an entry, but you
 normally don't want to see it.  For this, Org mode has @emph{drawers}.  They
@@ -2565,7 +2565,7 @@ rows/columns.
 @cindex references, named
 @cindex name, of column or field
 @cindex constants, in calculations
-@cindex #+CONSTANTS
+@cindex @code{#+CONSTANTS}
 
 @vindex org-table-formula-constants
 @samp{$name} is interpreted as the name of a column, parameter or
@@ -2602,7 +2602,7 @@ numbers.
 @cindex references, to a different table
 @cindex name, of column or field
 @cindex constants, in calculations
-@cindex #+NAME, for table
+@cindex @code{#+NAME}, for table
 
 You may also reference constants, fields and ranges from a different table,
 either in the current file or even in a different file.  The syntax is
@@ -2824,8 +2824,8 @@ preceded by @samp{:=}, for example @samp{:=vsum(@@II..III)}.  When you press
 the formula will be stored as the formula for this field, evaluated, and the
 current field will be replaced with the result.
 
-@cindex #+TBLFM
-Formulas are stored in a special line starting with @samp{#+TBLFM:} directly
+@cindex @code{#+TBLFM}
+Formulas are stored in a special line starting with @code{#+TBLFM:} directly
 below the table.  If you type the equation in the 4th field of the 3rd data
 line in the table, the formula will look like @samp{@@3$4=$1+$2}.  When
 inserting/deleting/swapping columns and rows with the appropriate commands,
@@ -2843,7 +2843,7 @@ command
 @table @kbd
 @orgcmd{C-u C-c =,org-table-eval-formula}
 Install a new formula for the current field.  The command prompts for a
-formula with default taken from the @samp{#+TBLFM:} line, applies
+formula with default taken from the @code{#+TBLFM:} line, applies
 it to the current field, and stores it.
 @end table
 
@@ -2890,7 +2890,7 @@ the formula will be stored as the formula for the current column, evaluated
 and the current field replaced with the result.  If the field contains only
 @samp{=}, the previously stored formula for this column is used.  For each
 column, Org will only remember the most recently used formula.  In the
-@samp{#+TBLFM:} line, column formulas will look like @samp{$4=$1+$2}.  The
+@code{#+TBLFM:} line, column formulas will look like @samp{$4=$1+$2}.  The
 left-hand side of a column formula cannot be the name of column, it must be
 the numeric column reference or @code{$>}.
 
@@ -2901,7 +2901,7 @@ following command:
 @orgcmd{C-c =,org-table-eval-formula}
 Install a new formula for the current column and replace current field with
 the result of the formula.  The command prompts for a formula, with default
-taken from the @samp{#+TBLFM} line, applies it to the current field and
+taken from the @code{#+TBLFM} line, applies it to the current field and
 stores it.  With a numeric prefix argument(e.g., @kbd{C-5 C-c =}) the command
 will apply it to that many consecutive fields in the current column.
 @end table
@@ -3037,25 +3037,25 @@ Turn the coordinate grid in the table on and off.
 @end table
 
 Making a table field blank does not remove the formula associated with
-the field, because that is stored in a different line (the @samp{#+TBLFM}
+the field, because that is stored in a different line (the @code{#+TBLFM}
 line)---during the next recalculation the field will be filled again.
 To remove a formula from a field, you have to give an empty reply when
-prompted for the formula, or to edit the @samp{#+TBLFM} line.
+prompted for the formula, or to edit the @code{#+TBLFM} line.
 
 @kindex C-c C-c
-You may edit the @samp{#+TBLFM} directly and re-apply the changed
+You may edit the @code{#+TBLFM} directly and re-apply the changed
 equations with @kbd{C-c C-c} in that line or with the normal
 recalculation commands in the table.
 
 @anchor{Using multiple #+TBLFM lines}
-@subsubheading Using multiple #+TBLFM lines
-@cindex #+TBLFM line, multiple
-@cindex #+TBLFM
-@cindex #+TBLFM, switching
+@subsubheading Using multiple @code{#+TBLFM} lines
+@cindex @code{#+TBLFM} line, multiple
+@cindex @code{#+TBLFM}
+@cindex @code{#+TBLFM}, switching
 @kindex C-c C-c
 
 You may apply the formula temporarily.  This is useful when you
-switch the formula.  Place multiple @samp{#+TBLFM} lines right
+switch the formula.  Place multiple @code{#+TBLFM} lines right
 after the table, and then press @kbd{C-c C-c} on the formula to
 apply.  Here is an example:
 
@@ -3082,7 +3082,7 @@ Pressing @kbd{C-c C-c} in the line of @samp{#+TBLFM: $2=$1*2} yields:
 
 @noindent
 Note: If you recalculate this table (with @kbd{C-u C-c *}, for example), you
-will get the following result of applying only the first @samp{#+TBLFM} line.
+will get the following result of applying only the first @code{#+TBLFM} line.
 
 @example
 | x | y |
@@ -3249,7 +3249,7 @@ functions.
 @section Org-Plot
 @cindex graph, in tables
 @cindex plot tables using Gnuplot
-@cindex #+PLOT
+@cindex @code{#+PLOT}
 
 Org-Plot can produce graphs of information stored in org tables, either
 graphically or in ASCII-art.
@@ -3432,7 +3432,7 @@ internal structure of all links, use the menu entry
 @cindex links, internal
 @cindex targets, for links
 
-@cindex property, CUSTOM_ID
+@cindex property, @code{CUSTOM_ID}
 If the link does not look like a URL, it is considered to be internal in the
 current file.  The most important case is a link like
 @samp{[[#my-custom-id]]} which will link to the entry with the
@@ -3448,7 +3448,7 @@ point to the corresponding headline.  The preferred match for a text link is
 a @i{dedicated target}: the same string in double angular brackets, like
 @samp{<<My Target>>}.
 
-@cindex #+NAME
+@cindex @code{#+NAME}
 If no dedicated target exists, the link will then try to match the exact name
 of an element within the buffer.  Naming is done with the @code{#+NAME}
 keyword, which has to be put in the line before the element it refers to, as
@@ -3640,8 +3640,8 @@ removed from the link and result in a wrong link---you should avoid putting
 timestamp in the headline.}.
 
 @vindex org-id-link-to-org-use-id
-@cindex property, CUSTOM_ID
-@cindex property, ID
+@cindex property, @code{CUSTOM_ID}
+@cindex property, @code{ID}
 If the headline has a @code{CUSTOM_ID} property, a link to this custom ID
 will be stored.  In addition or alternatively (depending on the value of
 @code{org-id-link-to-org-use-id}), a globally unique @code{ID} property will
@@ -3883,7 +3883,7 @@ what the Org author is doing besides Emacs hacking with
 If you need special abbreviations just for a single Org buffer, you
 can define them in the file with
 
-@cindex #+LINK
+@cindex @code{#+LINK}
 @example
 #+LINK: bugzilla  http://10.1.2.9/bugzilla/show_bug.cgi?id=
 #+LINK: google    http://www.google.com/search?q=%s
@@ -4241,9 +4241,9 @@ unique keys across both sets of keywords.}
 @subsection Setting up keywords for individual files
 @cindex keyword options
 @cindex per-file keywords
-@cindex #+TODO
-@cindex #+TYP_TODO
-@cindex #+SEQ_TODO
+@cindex @code{#+TODO}
+@cindex @code{#+TYP_TODO}
+@cindex @code{#+SEQ_TODO}
 
 It can be very useful to use different aspects of the TODO mechanism in
 different files.  For file-local settings, you need to add special lines to
@@ -4318,7 +4318,7 @@ foreground or a background color.
 @cindex TODO dependencies, NOBLOCKING
 
 @vindex org-enforce-todo-dependencies
-@cindex property, ORDERED
+@cindex property, @code{ORDERED}
 The structure of Org files (hierarchy and lists) makes it easy to define TODO
 dependencies.  Usually, a parent TODO task should not be marked DONE until
 all subtasks (defined as children tasks) are marked as DONE@.  And sometimes
@@ -4357,7 +4357,7 @@ property:
 @table @kbd
 @orgcmd{C-c C-x o,org-toggle-ordered-property}
 @vindex org-track-ordered-property-with-tag
-@cindex property, ORDERED
+@cindex property, @code{ORDERED}
 Toggle the @code{ORDERED} property of the current entry.  A property is used
 for this behavior because this should be local to the current entry, not
 inherited like a tag.  However, if you would like to @i{track} the value of
@@ -4439,7 +4439,7 @@ the entry with a @samp{Closing Note} heading.
 
 @vindex org-log-states-order-reversed
 @vindex org-log-into-drawer
-@cindex property, LOG_INTO_DRAWER
+@cindex property, @code{LOG_INTO_DRAWER}
 When TODO keywords are used as workflow states (@pxref{Workflow states}), you
 might want to keep track of when a state change occurred and maybe take a
 note about this change.  You can either record just a timestamp, or a
@@ -4493,12 +4493,12 @@ to a buffer:
 #+TODO: TODO(t) WAIT(w@@/!) | DONE(d!) CANCELED(c@@)
 @end example
 
-@cindex property, LOGGING
-In order to define logging settings that are local to a subtree or a
-single item, define a LOGGING property in this entry.  Any non-empty
-LOGGING property resets all logging settings to @code{nil}.  You may then turn
-on logging for this specific tree using STARTUP keywords like
-@code{lognotedone} or @code{logrepeat}, as well as adding state specific
+@cindex property, @code{LOGGING}
+In order to define logging settings that are local to a subtree or a single
+item, define a @code{LOGGING} property in this entry.  Any non-empty
+@code{LOGGING} property resets all logging settings to @code{nil}.  You may
+then turn on logging for this specific tree using @code{#+STARTUP} keywords
+like @code{lognotedone} or @code{logrepeat}, as well as adding state specific
 settings like @code{TODO(!)}.  For example
 
 @example
@@ -4669,7 +4669,7 @@ these values (highest, lowest, default) like this (please make sure that
 the highest priority is earlier in the alphabet than the lowest
 priority):
 
-@cindex #+PRIORITIES
+@cindex @code{#+PRIORITIES}
 @example
 #+PRIORITIES: A C B
 @end example
@@ -4698,7 +4698,7 @@ be updated each time the TODO status of a child changes, or when pressing
 ** DONE Talk to neighbor
 @end example
 
-@cindex property, COOKIE_DATA
+@cindex property, @code{COOKIE_DATA}
 If a heading has both checkboxes and TODO children below it, the meaning of
 the statistics cookie become ambiguous.  Set the property
 @code{COOKIE_DATA} to either @samp{checkbox} or @samp{todo} to resolve
@@ -4770,7 +4770,7 @@ checked.
 
 @cindex statistics, for checkboxes
 @cindex checkbox statistics
-@cindex property, COOKIE_DATA
+@cindex property, @code{COOKIE_DATA}
 @vindex org-checkbox-hierarchical-statistics
 The @samp{[2/4]} and @samp{[1/3]} in the first and second line are cookies
 indicating how many checkboxes present in this entry have been checked off,
@@ -4792,7 +4792,7 @@ to either @samp{checkbox} or @samp{todo} to resolve this issue.
 
 @cindex blocking, of checkboxes
 @cindex checkbox blocking
-@cindex property, ORDERED
+@cindex property, @code{ORDERED}
 If the current outline node has an @code{ORDERED} property, checkboxes must
 be checked off in sequence, and an error will be thrown if you try to check
 off a box while there are unchecked boxes above it.
@@ -4829,7 +4829,7 @@ Insert a new item with a checkbox.  This works only if the cursor is already
 in a plain list item (@pxref{Plain lists}).
 @orgcmd{C-c C-x o,org-toggle-ordered-property}
 @vindex org-track-ordered-property-with-tag
-@cindex property, ORDERED
+@cindex property, @code{ORDERED}
 Toggle the @code{ORDERED} property of the entry, to toggle if checkboxes must
 be checked off in sequence.  A property is used for this behavior because
 this should be local to the current entry, not inherited like a tag.
@@ -4897,7 +4897,7 @@ a hypothetical level zero that surrounds the entire file.  Use a line like
 this@footnote{As with all these in-buffer settings, pressing @kbd{C-c C-c}
 activates any changes in the line.}:
 
-@cindex #+FILETAGS
+@cindex @code{#+FILETAGS}
 @example
 #+FILETAGS: :Peter:Boss:Secret:
 @end example
@@ -4959,7 +4959,7 @@ currently used in the buffer.  You may also globally specify a hard list
 of tags with the variable @code{org-tag-alist}.  Finally you can set
 the default tags for a given file with lines like
 
-@cindex #+TAGS
+@cindex @code{#+TAGS}
 @example
 #+TAGS: @@work @@home @@tennisclub
 #+TAGS: laptop car pc sailboat
@@ -4978,7 +4978,7 @@ If you have a preferred set of tags that you would like to use in every file,
 in addition to those defined on a per-file basis by TAGS option lines, then
 you may specify a list of tags with the variable
 @code{org-tag-persistent-alist}.  You may turn this off on a per-file basis
-by adding a STARTUP option line to that file:
+by adding a @code{#+STARTUP} option line to that file:
 
 @example
 #+STARTUP: noptag
@@ -5328,8 +5328,8 @@ publishers and the number of disks in a box like this:
 
 If you want to set properties that can be inherited by any entry in a
 file, use a line like
-@cindex property, _ALL
-@cindex #+PROPERTY
+@cindex property, @code{_ALL}
+@cindex @code{#+PROPERTY}
 @example
 #+PROPERTY: NDisks_ALL 1 2 3 4
 @end example
@@ -5340,7 +5340,7 @@ buffer with @kbd{C-c C-c} to activate this change.
 If you want to add to the value of an existing property, append a @code{+} to
 the property name.  The following results in the property @code{var} having
 the value ``foo=1 bar=2''.
-@cindex property, +
+@cindex property, @code{+}
 @example
 #+PROPERTY: var  foo=1
 #+PROPERTY: var+ bar=2
@@ -5349,7 +5349,7 @@ the value ``foo=1 bar=2''.
 It is also possible to add to the values of inherited properties.  The
 following results in the @code{genres} property having the value ``Classic
 Baroque'' under the @code{Goldberg Variations} subtree.
-@cindex property, +
+@cindex property, @code{+}
 @example
 * CD collection
 ** Classic
@@ -5384,7 +5384,7 @@ in the current file will be offered as possible completions.
 Set a property.  This prompts for a property name and a value.  If
 necessary, the property drawer is created as well.
 @item C-u M-x org-insert-drawer RET
-@cindex org-insert-drawer
+@cindex @code{org-insert-drawer}
 Insert a property drawer into the current entry.  The drawer will be
 inserted early in the entry, but after the lines with planning
 information like deadlines.
@@ -5415,20 +5415,20 @@ a column view (@pxref{Column view}), or to use them in queries.  The
 following property names are special and should not be used as keys in the
 properties drawer:
 
-@cindex property, special, ALLTAGS
-@cindex property, special, BLOCKED
-@cindex property, special, CLOCKSUM
-@cindex property, special, CLOCKSUM_T
-@cindex property, special, CLOSED
-@cindex property, special, DEADLINE
-@cindex property, special, FILE
-@cindex property, special, ITEM
-@cindex property, special, PRIORITY
-@cindex property, special, SCHEDULED
-@cindex property, special, TAGS
-@cindex property, special, TIMESTAMP
-@cindex property, special, TIMESTAMP_IA
-@cindex property, special, TODO
+@cindex property, special, @code{ALLTAGS}
+@cindex property, special, @code{BLOCKED}
+@cindex property, special, @code{CLOCKSUM}
+@cindex property, special, @code{CLOCKSUM_T}
+@cindex property, special, @code{CLOSED}
+@cindex property, special, @code{DEADLINE}
+@cindex property, special, @code{FILE}
+@cindex property, special, @code{ITEM}
+@cindex property, special, @code{PRIORITY}
+@cindex property, special, @code{SCHEDULED}
+@cindex property, special, @code{TAGS}
+@cindex property, special, @code{TIMESTAMP}
+@cindex property, special, @code{TIMESTAMP_IA}
+@cindex property, special, @code{TODO}
 @example
 ALLTAGS      @r{All tags, including inherited ones.}
 BLOCKED      @r{"t" if task is currently blocked by children or siblings.}
@@ -5508,7 +5508,7 @@ search will stop at this value and return @code{nil}.
 Org mode has a few properties for which inheritance is hard-coded, at
 least for the special applications for which they are used:
 
-@cindex property, COLUMNS
+@cindex property, @code{COLUMNS}
 @table @code
 @item COLUMNS
 The @code{:COLUMNS:} property defines the format of column view
@@ -5517,16 +5517,16 @@ where a @code{:COLUMNS:} property is defined is used as the starting
 point for a column view table, independently of the location in the
 subtree from where columns view is turned on.
 @item CATEGORY
-@cindex property, CATEGORY
+@cindex property, @code{CATEGORY}
 For agenda view, a category set through a @code{:CATEGORY:} property
 applies to the entire subtree.
 @item ARCHIVE
-@cindex property, ARCHIVE
+@cindex property, @code{ARCHIVE}
 For archiving, the @code{:ARCHIVE:} property may define the archive
 location for the entire subtree (@pxref{Moving subtrees}).
 @item LOGGING
-@cindex property, LOGGING
-The LOGGING property may define logging settings for an entry or a
+@cindex property, @code{LOGGING}
+The @code{LOGGING} property may define logging settings for an entry or a
 subtree (@pxref{Tracking TODO state changes}).
 @end table
 
@@ -5571,7 +5571,7 @@ done by defining a column format line.
 
 To define a column format for an entire file, use a line like
 
-@cindex #+COLUMNS
+@cindex @code{#+COLUMNS}
 @example
 #+COLUMNS: %25ITEM %TAGS %PRIORITY %TODO
 @end example
@@ -5766,7 +5766,7 @@ exported or printed directly.  If you want to capture a column view, use
 a @code{columnview} dynamic block (@pxref{Dynamic blocks}).  The frame
 of this block looks like this:
 
-@cindex #+BEGIN, columnview
+@cindex @code{#+BEGIN}, columnview
 @example
 * The column view
 #+BEGIN: columnview :hlines 1 :id "label"
@@ -5782,7 +5782,7 @@ This is the most important parameter.  Column view is a feature that is
 often localized to a certain (sub)tree, and the capture block might be
 at a different location in the file.  To identify the tree whose view to
 capture, you can use 4 values:
-@cindex property, ID
+@cindex property, @code{ID}
 @example
 local     @r{use the tree in which the capture block is located}
 global    @r{make a global view, including all headings in the file}
@@ -5790,7 +5790,7 @@ global    @r{make a global view, including all headings in the file}
           @r{run column view at the top of this file}
 "@var{ID}"      @r{call column view in the tree that has an @code{:ID:}}
           @r{property with the value @i{label}.  You can use}
-          @r{@kbd{M-x org-id-copy RET} to create a globally unique ID for}
+          @r{@kbd{M-x org-id-copy RET} to create a globally unique @code{ID} for}
           @r{the current entry and copy it to the kill-ring.}
 @end example
 @item :hlines
@@ -5814,7 +5814,7 @@ The following commands insert or update the dynamic block:
 @table @kbd
 @orgcmd{C-c C-x i,org-insert-columns-dblock}
 Insert a dynamic block capturing a column view.  You will be prompted
-for the scope or ID of the view.
+for the scope or @code{ID} of the view.
 @orgcmdkkc{C-c C-c,C-c C-x C-u,org-dblock-update}
 Update dynamic block at point.
 @orgcmd{C-u C-c C-x C-u,org-update-all-dblocks}
@@ -6222,7 +6222,7 @@ they refer to.
 
 @table @var
 @item DEADLINE
-@cindex DEADLINE keyword
+@cindex @code{DEADLINE} keyword
 
 Meaning: the task (most likely a TODO item, though not necessarily) is supposed
 to be finished on that date.
@@ -6248,7 +6248,7 @@ deactivated if the task gets scheduled and you set
 @code{org-agenda-skip-deadline-prewarning-if-scheduled} to @code{t}.
 
 @item SCHEDULED
-@cindex SCHEDULED keyword
+@cindex @code{SCHEDULED} keyword
 
 Meaning: you are planning to start working on that task on the given
 date.
@@ -6313,7 +6313,7 @@ an item:
 @table @kbd
 @c
 @orgcmd{C-c C-d,org-deadline}
-Insert @samp{DEADLINE} keyword along with a stamp.  Any CLOSED timestamp will
+Insert @code{DEADLINE} keyword along with a stamp.  Any CLOSED timestamp will
 be removed.  When called with a prefix arg, an existing deadline will be
 removed from the entry.  Depending on the variable
 @code{org-log-redeadline}@footnote{with corresponding @code{#+STARTUP}
@@ -6322,7 +6322,7 @@ keywords @code{logredeadline}, @code{lognoteredeadline}, and
 deadline.
 
 @orgcmd{C-c C-s,org-schedule}
-Insert @samp{SCHEDULED} keyword along with a stamp.  Any CLOSED timestamp
+Insert @code{SCHEDULED} keyword along with a stamp.  Any CLOSED timestamp
 will be removed.  When called with a prefix argument, remove the scheduling
 date from the entry.  Depending on the variable
 @code{org-log-reschedule}@footnote{with corresponding @code{#+STARTUP}
@@ -6356,8 +6356,8 @@ to the previous week before any current timestamp.
 @cindex tasks, repeated
 @cindex repeated tasks
 
-Some tasks need to be repeated again and again.  Org mode helps to
-organize such tasks using a so-called repeater in a DEADLINE, SCHEDULED,
+Some tasks need to be repeated again and again.  Org mode helps to organize
+such tasks using a so-called repeater in a @code{DEADLINE}, @code{SCHEDULED},
 or plain timestamp.  In the following example
 @example
 ** TODO Pay the rent
@@ -6374,18 +6374,18 @@ first and the warning period last: @code{DEADLINE: <2005-10-01 Sat +1m -3d>}.
 @vindex org-todo-repeat-to-state
 Deadlines and scheduled items produce entries in the agenda when they are
 over-due, so it is important to be able to mark such an entry as completed
-once you have done so.  When you mark a DEADLINE or a SCHEDULE with the TODO
-keyword DONE, it will no longer produce entries in the agenda.  The problem
-with this is, however, that then also the @emph{next} instance of the
-repeated entry will not be active.  Org mode deals with this in the following
-way: When you try to mark such an entry DONE (using @kbd{C-c C-t}), it will
-shift the base date of the repeating timestamp by the repeater interval, and
-immediately set the entry state back to TODO@footnote{In fact, the target
-state is taken from, in this sequence, the @code{REPEAT_TO_STATE} property or
-the variable @code{org-todo-repeat-to-state}.  If neither of these is
-specified, the target state defaults to the first state of the TODO state
-sequence.}.  In the example above, setting the state to DONE would actually
-switch the date like this:
+once you have done so.  When you mark a @code{DEADLINE} or a @code{SCHEDULED}
+with the TODO keyword DONE, it will no longer produce entries in the agenda.
+The problem with this is, however, that then also the @emph{next} instance of
+the repeated entry will not be active.  Org mode deals with this in the
+following way: When you try to mark such an entry DONE (using @kbd{C-c C-t}),
+it will shift the base date of the repeating timestamp by the repeater
+interval, and immediately set the entry state back to TODO@footnote{In fact,
+the target state is taken from, in this sequence, the @code{REPEAT_TO_STATE}
+property or the variable @code{org-todo-repeat-to-state}.  If neither of
+these is specified, the target state defaults to the first state of the TODO
+state sequence.}.  In the example above, setting the state to DONE would
+actually switch the date like this:
 
 @example
 ** TODO Pay the rent
@@ -6491,22 +6491,21 @@ what to do with it.
 @orgcmd{C-c C-x C-i,org-clock-in}
 @vindex org-clock-into-drawer
 @vindex org-clock-continuously
-@cindex property, LOG_INTO_DRAWER
-Start the clock on the current item (clock-in).  This inserts the CLOCK
-keyword together with a timestamp.  If this is not the first clocking of
-this item, the multiple CLOCK lines will be wrapped into a
-@code{:LOGBOOK:} drawer (see also the variable
-@code{org-clock-into-drawer}).  You can also overrule
-the setting of this variable for a subtree by setting a
-@code{CLOCK_INTO_DRAWER} or @code{LOG_INTO_DRAWER} property.
-When called with a @kbd{C-u} prefix argument,
-select the task from a list of recently clocked tasks.  With two @kbd{C-u
-C-u} prefixes, clock into the task at point and mark it as the default task;
-the default task will then always be available with letter @kbd{d} when
-selecting a clocking task.  With three @kbd{C-u C-u C-u} prefixes, force
-continuous clocking by starting the clock when the last clock stopped.@*
-@cindex property: CLOCK_MODELINE_TOTAL
-@cindex property: LAST_REPEAT
+@cindex property, @code{LOG_INTO_DRAWER}
+!Start the clock on the current item (clock-in).  This inserts the
+@code{CLOCK} keyword together with a timestamp.  If this is not the first
+clocking of this item, the multiple @code{CLOCK} lines will be wrapped into a
+@code{:LOGBOOK:} drawer (see also the variable @code{org-clock-into-drawer}).
+You can also overrule the setting of this variable for a subtree by setting a
+@code{CLOCK_INTO_DRAWER} or @code{LOG_INTO_DRAWER} property.  When called
+with a @kbd{C-u} prefix argument, select the task from a list of recently
+clocked tasks.  With two @kbd{C-u C-u} prefixes, clock into the task at point
+and mark it as the default task; the default task will then always be
+available with letter @kbd{d} when selecting a clocking task.  With three
+@kbd{C-u C-u C-u} prefixes, force continuous clocking by starting the clock
+when the last clock stopped.@*
+@cindex property, @code{CLOCK_MODELINE_TOTAL}
+@cindex property, @code{LAST_REPEAT}
 @vindex org-clock-modeline-total
 While the clock is running, the current clocking time is shown in the mode
 line, along with the title of the task.  The clock time shown will be all
@@ -6615,7 +6614,7 @@ needs to be in the @code{#+BEGIN: clocktable} line for this command.  If
 Here is an example of the frame for a clock table as it is inserted into the
 buffer with the @kbd{C-c C-x C-r} command:
 
-@cindex #+BEGIN, clocktable
+@cindex @code{#+BEGIN}, clocktable
 @example
 #+BEGIN: clocktable :maxlevel 2 :emphasize nil :scope file
 #+END: clocktable
@@ -6691,8 +6690,8 @@ but you can specify your own function using the @code{:formatter} parameter.
              @r{E.g., @code{:sort (1 . ?a)} sorts the first column alphabetically.}
 :compact     @r{Abbreviation for @code{:level nil :indent t :narrow 40! :tcolumns 1}}
              @r{All are overwritten except if there is an explicit @code{:narrow}}
-:timestamp   @r{A timestamp for the entry, when available.  Look for SCHEDULED,}
-             @r{DEADLINE, TIMESTAMP and TIMESTAMP_IA, in this order.}
+:timestamp   @r{A timestamp for the entry, when available.  Look for @code{SCHEDULED},}
+             @r{@code{DEADLINE}, @code{TIMESTAMP} and @code{TIMESTAMP_IA}, in this order.}
 :properties  @r{List of properties that should be shown in the table.  Each}
              @r{property will get its own column.}
 :inherit-props @r{When this flag is @code{t}, the values for @code{:properties} will be inherited.}
@@ -6823,7 +6822,7 @@ with @code{org-clock-in} and two @kbd{C-u C-u} with @code{org-clock-in-last}.
 @section Effort estimates
 @cindex effort estimates
 
-@cindex property, Effort
+@cindex property, @code{EFFORT}
 If you want to plan your work in a very detailed way, or if you need to
 produce offers with quotations of the estimated work effort, you may want to
 assign effort estimates to entries.  If you are also clocking your work, you
@@ -7041,7 +7040,7 @@ Visit the last stored capture item in its buffer.
 @end table
 
 @vindex org-capture-bookmark
-@cindex org-capture-last-stored
+@cindex @code{org-capture-last-stored}
 You can also jump to the bookmark @code{org-capture-last-stored}, which will
 automatically be created unless you set @code{org-capture-bookmark} to
 @code{nil}.
@@ -7462,12 +7461,12 @@ Delete all of a task's attachments.  A safer way is to open the directory in
 @command{dired} and delete from there.
 
 @orgcmdtkc{s,C-c C-a s,org-attach-set-directory}
-@cindex property, ATTACH_DIR
+@cindex property, @code{ATTACH_DIR}
 Set a specific directory as the entry's attachment directory.  This works by
 putting the directory path into the @code{ATTACH_DIR} property.
 
 @orgcmdtkc{i,C-c C-a i,org-attach-set-inherit}
-@cindex property, ATTACH_DIR_INHERIT
+@cindex property, @code{ATTACH_DIR_INHERIT}
 Set the @code{ATTACH_DIR_INHERIT} property, so that children will use the
 same directory for attachments as the parent does.
 @end table
@@ -7641,14 +7640,14 @@ javascript:location.href='org-protocol://open-source?&url='+
       encodeURIComponent(location.href)
 @end example
 
-@cindex protocol, open-source, :base-url property
-@cindex :base-url property in open-source protocol
-@cindex protocol, open-source, :working-directory property
-@cindex :working-directory property in open-source protocol
-@cindex protocol, open-source, :online-suffix property
-@cindex :online-suffix property in open-source protocol
-@cindex protocol, open-source, :working-suffix property
-@cindex :working-suffix property in open-source protocol
+@cindex protocol, open-source, @code{:base-url} property
+@cindex @code{:base-url} property in open-source protocol
+@cindex protocol, open-source, @code{:working-directory} property
+@cindex @code{:working-directory} property in open-source protocol
+@cindex protocol, open-source, @code{:online-suffix} property
+@cindex @code{:online-suffix} property in open-source protocol
+@cindex protocol, open-source, @code{:working-suffix} property
+@cindex @code{:working-suffix} property in open-source protocol
 @vindex org-protocol-project-alist
 The variable @code{org-protocol-project-alist} maps URLs to local file names,
 by stripping URL parameters from the end and replacing the @code{:base-url}
@@ -7685,8 +7684,8 @@ to something like
 @code{open-source} handler probably cannot find a file named
 @file{/home/user/example/print/posters.html.php} and fails.
 
-@cindex protocol, open-source, :rewrites property
-@cindex :rewrites property in open-source protocol
+@cindex protocol, open-source, @code{:rewrites} property
+@cindex @code{:rewrites property} in open-source protocol
 Such an entry in @code{org-protocol-project-alist} may hold an additional
 property @code{:rewrites}.  This property is a list of cons cells, each of
 which maps a regular expression to a path relative to the
@@ -7837,12 +7836,12 @@ see the documentation string of the variable
 
 There is also an in-buffer option for setting this variable, for example:
 
-@cindex #+ARCHIVE
+@cindex @code{#+ARCHIVE}
 @example
 #+ARCHIVE: %s_done::
 @end example
 
-@cindex property, ARCHIVE
+@cindex property, @code{ARCHIVE}
 @noindent
 If you would like to have a special ARCHIVE location for a single entry
 or a (sub)tree, give the entry an @code{:ARCHIVE:} property with the
@@ -8150,7 +8149,7 @@ The purpose of the weekly/daily @emph{agenda} is to act like a page of a
 paper agenda, showing all the tasks for the current week or day.
 
 @table @kbd
-@cindex org-agenda, command
+@cindex @code{org-agenda}, command
 @orgcmd{C-c a a,org-agenda-list}
 Compile an agenda for the current week from a list of Org files.  The agenda
 shows the entries for each day.  With a numeric prefix@footnote{For backward
@@ -8637,7 +8636,7 @@ associated with the item.
 @subsection Categories
 
 @cindex category
-@cindex #+CATEGORY
+@cindex @code{#+CATEGORY}
 The category is a broad label assigned to each agenda item.  By default, the
 category is simply derived from the file name, but you can also specify it
 with a special line in the buffer, like this:
@@ -8647,8 +8646,8 @@ with a special line in the buffer, like this:
 @end example
 
 @noindent
-@cindex property, CATEGORY
-If you would like to have a special CATEGORY for a single entry or a
+@cindex property, @code{CATEGORY}
+If you would like to have a special @code{CATEGORY} for a single entry or a
 (sub)tree, give the entry a @code{:CATEGORY:} property with the
 special category you want to apply as the value.
 
@@ -9860,7 +9859,7 @@ does not have a specific format---defined in a property, or in its file---it
 uses @code{org-columns-default-format}.
 
 @item
-@cindex property, special, CLOCKSUM
+@cindex property, special, @code{CLOCKSUM}
 If any of the columns has a summary type defined (@pxref{Column attributes}),
 turning on column view in the agenda will visit all relevant agenda files and
 make sure that the computations of this property are up to date.  This is
@@ -9884,7 +9883,7 @@ clocked time in the displayed period use clock table mode (press @kbd{R} in
 the agenda).
 
 @item
-@cindex property, special, CLOCKSUM_T
+@cindex property, special, @code{CLOCKSUM_T}
 When the column view in the agenda shows the @code{CLOCKSUM_T}, that is
 always today's clocked time for this item.  So even in the weekly agenda, the
 clocksum listed in column view only originates from today.  This lets you
@@ -9924,7 +9923,7 @@ To preserve the line breaks, indentation and blank lines in a region, but
 otherwise use normal formatting, you can use this construct, which can also
 be used to format poetry.
 
-@cindex #+BEGIN_VERSE
+@cindex @code{#+BEGIN_VERSE}
 @cindex verse blocks
 @example
 #+BEGIN_VERSE
@@ -9940,7 +9939,7 @@ When quoting a passage from another document, it is customary to format this
 as a paragraph that is indented on both the left and the right margin.  You
 can include quotations in Org mode documents like this:
 
-@cindex #+BEGIN_QUOTE
+@cindex @code{#+BEGIN_QUOTE}
 @cindex quote blocks
 @example
 #+BEGIN_QUOTE
@@ -9950,7 +9949,7 @@ but not any simpler -- Albert Einstein
 @end example
 
 If you would like to center some text, do it like this:
-@cindex #+BEGIN_CENTER
+@cindex @code{#+BEGIN_CENTER}
 @cindex center blocks
 @example
 #+BEGIN_CENTER
@@ -9994,8 +9993,8 @@ a horizontal line.
 @section Images and Tables
 
 @cindex tables, markup rules
-@cindex #+CAPTION
-@cindex #+NAME
+@cindex @code{#+CAPTION}
+@cindex @code{#+NAME}
 Both the native Org mode tables (@pxref{Tables}) and tables formatted with
 the @file{table.el} package will be exported properly.  For Org mode tables,
 the lines before the first horizontal separator line will become table header
@@ -10046,7 +10045,7 @@ or may not be handled.
 You can include literal examples that should not be subjected to
 markup.  Such examples will be typeset in monospace, so this is well suited
 for source code and similar examples.
-@cindex #+BEGIN_EXAMPLE
+@cindex @code{#+BEGIN_EXAMPLE}
 
 @example
 #+BEGIN_EXAMPLE
@@ -10085,7 +10084,7 @@ example@footnote{Code in @samp{src} blocks may also be evaluated either
 interactively or on export.  @xref{Working with source code}, for more
 information on evaluating code blocks.}, see @ref{Easy templates} for
 shortcuts to easily insert code blocks.
-@cindex #+BEGIN_SRC
+@cindex @code{#+BEGIN_SRC}
 
 @example
 #+BEGIN_SRC emacs-lisp
@@ -10600,7 +10599,7 @@ Org document by adjusting outline visibility settings.
 @section Export settings
 @cindex Export, settings
 
-@cindex #+OPTIONS
+@cindex @code{#+OPTIONS}
 Export options can be set: globally with variables; for an individual file by
 making variables buffer-local with in-buffer settings (@pxref{In-buffer
 settings}), by setting individual keywords, or by specifying them in a
@@ -10608,7 +10607,7 @@ compact form with the @code{#+OPTIONS} keyword; or for a tree by setting
 properties (@pxref{Properties and columns}).  Options set at a specific level
 override options set at a more general level.
 
-@cindex #+SETUPFILE
+@cindex @code{#+SETUPFILE}
 In-buffer settings may appear anywhere in the file, either directly or
 indirectly through a file included using @samp{#+SETUPFILE: filename or URL}
 syntax.  Option keyword sets tailored to a particular back-end can be
@@ -10624,29 +10623,29 @@ variables, include:
 
 @table @samp
 @item AUTHOR
-@cindex #+AUTHOR
+@cindex @code{#+AUTHOR}
 @vindex user-full-name
 The document author (@code{user-full-name}).
 
 @item CREATOR
-@cindex #+CREATOR
+@cindex @code{#+CREATOR}
 @vindex org-export-creator-string
 Entity responsible for output generation (@code{org-export-creator-string}).
 
 @item DATE
-@cindex #+DATE
+@cindex @code{#+DATE}
 @vindex org-export-date-timestamp-format
 A date or a time-stamp@footnote{The variable
 @code{org-export-date-timestamp-format} defines how this time-stamp will be
 exported.}.
 
 @item EMAIL
-@cindex #+EMAIL
+@cindex @code{#+EMAIL}
 @vindex user-mail-address
 The email address (@code{user-mail-address}).
 
 @item LANGUAGE
-@cindex #+LANGUAGE
+@cindex @code{#+LANGUAGE}
 @vindex org-export-default-language
 Language to use for translating certain strings
 (@code{org-export-default-language}).  With @samp{#+LANGUAGE: fr}, for
@@ -10654,7 +10653,7 @@ example, Org translates @emph{Table of contents} to the French @emph{Table
 des matières}.
 
 @item SELECT_TAGS
-@cindex #+SELECT_TAGS
+@cindex @code{#+SELECT_TAGS}
 @vindex org-export-select-tags
 The default value is @code{:export:}.  When a tree is tagged with
 @code{:export:} (@code{org-export-select-tags}), Org selects that tree and
@@ -10663,7 +10662,7 @@ see below.  When selectively exporting files with @code{:export:} tags set,
 Org does not export any text that appears before the first headline.
 
 @item EXCLUDE_TAGS
-@cindex #+EXCLUDE_TAGS
+@cindex @code{#+EXCLUDE_TAGS}
 @vindex org-export-exclude-tags
 The default value is @code{:noexport:}.  When a tree is tagged with
 @code{:noexport:} (@code{org-export-exclude-tags}), Org excludes that tree
@@ -10673,12 +10672,12 @@ unconditionally excluded from the export, even if they have an
 code blocks contained in them.
 
 @item TITLE
-@cindex #+TITLE
+@cindex @code{#+TITLE}
 @cindex document title
 Org displays this title.  For long titles, use multiple @code{#+TITLE} lines.
 
 @item EXPORT_FILE_NAME
-@cindex #+EXPORT_FILE_NAME
+@cindex @code{#+EXPORT_FILE_NAME}
 The name of the output file to be generated.  Otherwise, Org generates the
 file name based on the buffer name and the extension based on the back-end
 format.
@@ -10784,7 +10783,7 @@ Toggle inclusion of inlinetasks (@code{org-export-with-inlinetasks}).
 
 @item num:
 @vindex org-export-with-section-numbers
-@cindex property, UNNUMBERED
+@cindex property, @code{UNNUMBERED}
 Toggle section-numbers (@code{org-export-with-section-numbers}).  When set to
 number @samp{n}, Org numbers only those headlines at level @samp{n} or above.
 Setting @code{UNNUMBERED} property to non-@code{nil} disables numbering of
@@ -10860,7 +10859,7 @@ respectively, @samp{EXPORT_DATE} and @samp{EXPORT_FILE_NAME}.  Except for
 @samp{SETUPFILE}, all other keywords listed above have an @samp{EXPORT_}
 equivalent.
 
-@cindex #+BIND
+@cindex @code{#+BIND}
 @vindex org-export-allow-bind-keywords
 If @code{org-export-allow-bind-keywords} is non-@code{nil}, Emacs variables
 can become buffer-local during export by using the BIND keyword.  Its syntax
@@ -10873,7 +10872,7 @@ settings that cannot be changed using keywords.
 @cindex list of tables
 @cindex list of listings
 
-@cindex #+TOC
+@cindex @code{#+TOC}
 @vindex org-export-with-toc
 Org normally inserts the table of contents directly before the first headline
 of the file.  Org sets the TOC depth the same as the headline levels in the
@@ -10919,7 +10918,7 @@ with captions.
 #+TOC: tables             @r{build a list of tables}
 @end example
 
-@cindex property, ALT_TITLE
+@cindex property, @code{ALT_TITLE}
 Normally Org uses the headline for its entry in the table of contents.  But
 with @code{ALT_TITLE} property, a different entry can be specified for the
 table of contents.
@@ -10929,7 +10928,7 @@ table of contents.
 @cindex include files, during export
 Include other files during export.  For example, to include your @file{.emacs}
 file, you could use:
-@cindex #+INCLUDE
+@cindex @code{#+INCLUDE}
 
 @example
 #+INCLUDE: "~/.emacs" src emacs-lisp
@@ -11001,7 +11000,7 @@ Visit the include file at point.
 @node Macro replacement
 @section Macro replacement
 @cindex macro replacement, during export
-@cindex #+MACRO
+@cindex @code{#+MACRO}
 
 @vindex org-export-global-macros
 Macros replace text snippets during export.  Macros are defined globally in
@@ -11093,9 +11092,9 @@ Lines starting with zero or more whitespace characters followed by one
 @samp{#} and a whitespace are treated as comments and, as such, are not
 exported.
 
-@cindex #+BEGIN_COMMENT
-Likewise, regions surrounded by @samp{#+BEGIN_COMMENT}
-... @samp{#+END_COMMENT} are not exported.
+@cindex @code{#+BEGIN_COMMENT}
+Likewise, regions surrounded by @code{#+BEGIN_COMMENT}
+... @code{#+END_COMMENT} are not exported.
 
 @cindex comment trees
 Finally, a @samp{COMMENT} keyword at the beginning of an entry, but after any
@@ -11151,7 +11150,7 @@ settings}).
 
 @table @samp
 @item SUBTITLE
-@cindex #+SUBTITLE (ASCII)
+@cindex @code{#+SUBTITLE} (ASCII)
 The document subtitle.  For long subtitles, use multiple @code{#+SUBTITLE}
 lines in the Org file.  Org prints them on one continuous line, wrapping into
 multiple lines if necessary.
@@ -11168,8 +11167,8 @@ where levels become lists, @pxref{Export settings}.
 To insert text within the Org file by the ASCII back-end, use one the
 following constructs, inline, keyword, or export block:
 
-@cindex #+ASCII
-@cindex #+BEGIN_EXPORT ascii
+@cindex @code{#+ASCII}
+@cindex @code{#+BEGIN_EXPORT ascii}
 @example
 Inline text @@@@ascii:and additional text@@@@ within a paragraph.
 
@@ -11181,7 +11180,7 @@ Org exports text in this block only when using ASCII back-end.
 @end example
 
 @subheading ASCII specific attributes
-@cindex #+ATTR_ASCII
+@cindex @code{#+ATTR_ASCII}
 @cindex horizontal rules, in ASCII export
 
 ASCII back-end recognizes only one attribute, @code{:width}, which specifies
@@ -11195,8 +11194,8 @@ syntax for specifying widths is:
 
 @subheading ASCII special blocks
 @cindex special blocks, in ASCII export
-@cindex #+BEGIN_JUSTIFYLEFT
-@cindex #+BEGIN_JUSTIFYRIGHT
+@cindex @code{#+BEGIN_JUSTIFYLEFT}
+@cindex @code{#+BEGIN_JUSTIFYRIGHT}
 
 Besides @code{#+BEGIN_CENTER} blocks (@pxref{Paragraphs}), ASCII back-end has
 these two left and right justification blocks:
@@ -11254,7 +11253,7 @@ output.  These keywords work similar to the general options settings
 
 @table @samp
 @item BEAMER_THEME
-@cindex #+BEAMER_THEME
+@cindex @code{#+BEAMER_THEME}
 @vindex org-beamer-theme
 The Beamer layout theme (@code{org-beamer-theme}).  Use square brackets for
 options.  For example:
@@ -11263,24 +11262,24 @@ options.  For example:
 @end smallexample
 
 @item BEAMER_FONT_THEME
-@cindex #+BEAMER_FONT_THEME
+@cindex @code{#+BEAMER_FONT_THEME}
 The Beamer font theme.
 
 @item BEAMER_INNER_THEME
-@cindex #+BEAMER_INNER_THEME
+@cindex @code{#+BEAMER_INNER_THEME}
 The Beamer inner theme.
 
 @item BEAMER_OUTER_THEME
-@cindex #+BEAMER_OUTER_THEME
+@cindex @code{#+BEAMER_OUTER_THEME}
 The Beamer outer theme.
 
 @item BEAMER_HEADER
-@cindex #+BEAMER_HEADER
+@cindex @code{#+BEAMER_HEADER}
 Arbitrary lines inserted in the preamble, just before the @samp{hyperref}
 settings.
 
 @item DESCRIPTION
-@cindex #+DESCRIPTION (Beamer)
+@cindex @code{#+DESCRIPTION} (Beamer)
 The document description.  For long descriptions, use multiple
 @code{#+DESCRIPTION} keywords.  By default, @samp{hyperref} inserts
 @code{#+DESCRIPTION} as metadata.  Use @code{org-latex-hyperref-template} to
@@ -11288,7 +11287,7 @@ configure document metadata.  Use @code{org-latex-title-command} to configure
 typesetting of description as part of front matter.
 
 @item KEYWORDS
-@cindex #+KEYWORDS (Beamer)
+@cindex @code{#+KEYWORDS} (Beamer)
 The keywords for defining the contents of the document.  Use multiple
 @code{#+KEYWORDS} lines if necessary.  By default, @samp{hyperref} inserts
 @code{#+KEYWORDS} as metadata.  Use @code{org-latex-hyperref-template} to
@@ -11296,7 +11295,7 @@ configure document metadata.  Use @code{org-latex-title-command} to configure
 typesetting of keywords as part of front matter.
 
 @item SUBTITLE
-@cindex #+SUBTITLE (Beamer)
+@cindex @code{#+SUBTITLE} (Beamer)
 @vindex org-beamer-subtitle-format
 Document's subtitle.  For typesetting, use @code{org-beamer-subtitle-format}
 string.  Use @code{org-latex-hyperref-template} to configure document
@@ -11318,7 +11317,7 @@ Org headlines become Beamer frames when the heading level in Org is equal to
 @code{org-beamer-frame-level} or @code{H} value in an @code{OPTIONS} line
 (@pxref{Export settings}).
 
-@cindex property, BEAMER_ENV
+@cindex property, @code{BEAMER_ENV}
 Org overrides headlines to frames conversion for the current tree of an Org
 file if it encounters the @code{BEAMER_ENV} property set to @code{frame} or
 @code{fullframe}.  Org ignores whatever @code{org-beamer-frame-level} happens
@@ -11337,7 +11336,7 @@ aid and has no semantic relevance.}.  For valid values see
 @code{org-beamer-environments-extra}.
 
 @item
-@cindex property, BEAMER_REF
+@cindex property, @code{BEAMER_REF}
 If @code{BEAMER_ENV} is set to @code{appendix}, Org exports the entry as an
 appendix.  When set to @code{note}, Org exports the entry as a note within
 the frame or between frames, depending on the entry's heading level.  When
@@ -11351,8 +11350,8 @@ not its content.  This is useful for inserting content between frames.  It is
 also useful for properly closing a @code{column} environment.
 @end itemize
 
-@cindex property, BEAMER_ACT
-@cindex property, BEAMER_OPT
+@cindex property, @code{BEAMER_ACT}
+@cindex property, @code{BEAMER_OPT}
 When @code{BEAMER_ACT} is set for a headline, Org export translates that
 headline as an overlay or action specification.  When enclosed in square
 brackets, Org export makes the overlay specification a default.  Use
@@ -11361,7 +11360,7 @@ or block.  The Beamer export back-end wraps with appropriate angular or
 square brackets.  It also adds the @code{fragile} option for any code that may
 require a verbatim block.
 
-@cindex property, BEAMER_COL
+@cindex property, @code{BEAMER_COL}
 To create a column on the Beamer slide, use the @code{BEAMER_COL} property
 for its headline in the Org file.  Set the value of @code{BEAMER_COL} to a
 decimal number representing the fraction of the total text width.  Beamer
@@ -11376,8 +11375,8 @@ needs, use the @code{BEAMER_ENV} property.
 @node Beamer specific syntax
 @subsection Beamer specific syntax
 Since Org's Beamer export back-end is an extension of the @LaTeX{} back-end,
-it recognizes other @LaTeX{} specific syntax---for example, @samp{#+LATEX:}
-or @samp{#+ATTR_LATEX:}.  @xref{@LaTeX{} export}, for details.
+it recognizes other @LaTeX{} specific syntax---for example, @code{#+LATEX:}
+or @code{#+ATTR_LATEX:}.  @xref{@LaTeX{} export}, for details.
 
 Beamer export wraps the table of contents generated with @code{toc:t}
 @code{OPTION} keyword in a @code{frame} environment.  Beamer export does not
@@ -11390,8 +11389,8 @@ contents}).  Use square brackets for specifying options.
 
 Insert Beamer-specific code using the following constructs:
 
-@cindex #+BEAMER
-@cindex #+BEGIN_EXPORT beamer
+@cindex @code{#+BEAMER}
+@cindex @code{#+BEGIN_EXPORT beamer}
 @example
 #+BEAMER: \pause
 
@@ -11412,7 +11411,7 @@ this example:
 A *@@@@beamer:<2->@@@@useful* feature
 @end example
 
-@cindex #+ATTR_BEAMER
+@cindex @code{#+ATTR_BEAMER}
 Beamer export recognizes the @code{ATTR_BEAMER} keyword with the following
 attributes from Beamer configurations: @code{:environment} for changing local
 Beamer environment, @code{:overlay} for specifying Beamer overlays in angular
@@ -11536,66 +11535,66 @@ described in @ref{Export settings}.
 
 @table @samp
 @item DESCRIPTION
-@cindex #+DESCRIPTION (HTML)
+@cindex @code{#+DESCRIPTION} (HTML)
 This is the document's description, which the HTML exporter inserts it as a
 HTML meta tag in the HTML file.  For long descriptions, use multiple
 @code{#+DESCRIPTION} lines.  The exporter takes care of wrapping the lines
 properly.
 
 @item HTML_DOCTYPE
-@cindex #+HTML_DOCTYPE
+@cindex @code{#+HTML_DOCTYPE}
 @vindex org-html-doctype
 Specify the document type, for example: HTML5 (@code{org-html-doctype}).
 
 @item HTML_CONTAINER
-@cindex #+HTML_CONTAINER
+@cindex @code{#+HTML_CONTAINER}
 @vindex org-html-container-element
 Specify the HTML container, such as @samp{div}, for wrapping sections and
 elements (@code{org-html-container-element}).
 
 @item HTML_LINK_HOME
-@cindex #+HTML_LINK_HOME
+@cindex @code{#+HTML_LINK_HOME}
 @vindex org-html-link-home
 The URL for home link (@code{org-html-link-home}).
 
 @item HTML_LINK_UP
-@cindex #+HTML_LINK_UP
+@cindex @code{#+HTML_LINK_UP}
 @vindex org-html-link-up
 The URL for the up link of exported HTML pages (@code{org-html-link-up}).
 
 @item HTML_MATHJAX
-@cindex #+HTML_MATHJAX
+@cindex @code{#+HTML_MATHJAX}
 @vindex org-html-mathjax-options
 Options for MathJax (@code{org-html-mathjax-options}).  MathJax is used to
 typeset @LaTeX{} math in HTML documents.  @xref{Math formatting in HTML
 export}, for an example.
 
 @item HTML_HEAD
-@cindex #+HTML_HEAD
+@cindex @code{#+HTML_HEAD}
 @vindex org-html-head
 Arbitrary lines for appending to the HTML document's head
 (@code{org-html-head}).
 
 @item HTML_HEAD_EXTRA
-@cindex #+HTML_HEAD_EXTRA
+@cindex @code{#+HTML_HEAD_EXTRA}
 @vindex org-html-head-extra
 More arbitrary lines for appending to the HTML document's head
 (@code{org-html-head-extra}).
 
 @item KEYWORDS
-@cindex #+KEYWORDS (HTML)
+@cindex @code{#+KEYWORDS} (HTML)
 Keywords to describe the document's content.  HTML exporter inserts these
 keywords as HTML meta tags.  For long keywords, use multiple
 @code{#+KEYWORDS} lines.
 
 @item LATEX_HEADER
-@cindex #+LATEX_HEADER (HTML)
+@cindex @code{#+LATEX_HEADER} (HTML)
 Arbitrary lines for appending to the preamble; HTML exporter appends when
 transcoding @LaTeX{} fragments to images (@pxref{Math formatting in HTML
 export}).
 
 @item SUBTITLE
-@cindex #+SUBTITLE (HTML)
+@cindex @code{#+SUBTITLE} (HTML)
 The document's subtitle.  HTML exporter formats subtitle if document type is
 @samp{HTML5} and the CSS has a @samp{subtitle} class.
 @end table
@@ -11729,14 +11728,13 @@ back-end can insert that HTML code in the output, use this inline syntax:
 text@@@@html:</b>@@@@}.  For larger raw HTML code blocks, use these HTML
 export code blocks:
 
-@cindex #+HTML
-@cindex #+BEGIN_EXPORT html
+@cindex @code{#+HTML}
 @example
 #+HTML: Literal HTML code for export
 @end example
 
 @noindent or
-@cindex #+BEGIN_EXPORT html
+@cindex @code{#+BEGIN_EXPORT html}
 
 @example
 #+BEGIN_EXPORT html
@@ -11773,7 +11771,7 @@ example, by using @code{#+ATTR_HTML} lines to specify new format attributes
 to @code{<a>} or @code{<img>} tags.  This example shows changing the link's
 @code{title} and @code{style}:
 
-@cindex #+ATTR_HTML
+@cindex @code{#+ATTR_HTML}
 @example
 #+ATTR_HTML: :title The Org mode homepage :style color:red;
 [[http://orgmode.org]]
@@ -11789,8 +11787,8 @@ exporting Org tables to HTML.  By default, the exporter does not draw frames
 and cell borders.  To change for this for a table, use the following lines
 before the table in the Org file:
 
-@cindex #+CAPTION
-@cindex #+ATTR_HTML
+@cindex @code{#+CAPTION}
+@cindex @code{#+ATTR_HTML}
 @example
 #+CAPTION: This is a table with lines around and between cells
 #+ATTR_HTML: :border 2 :rules all :frame border
@@ -11863,8 +11861,8 @@ Org file.  This example shows realignment to right, and adds @code{alt} and
 @code{title} attributes in support of text viewers and modern web accessibility
 standards.
 
-@cindex #+CAPTION
-@cindex #+ATTR_HTML
+@cindex @code{#+CAPTION}
+@cindex @code{#+ATTR_HTML}
 @example
 #+CAPTION: A black cat stalking a spider
 #+ATTR_HTML: :alt cat/spider image :title Action! :align right
@@ -11973,7 +11971,7 @@ p.creator           @r{creator info, about org mode version}
 .done               @r{the DONE keywords, all states that count as done}
 .WAITING            @r{each TODO keyword also uses a class named after itself}
 .timestamp          @r{timestamp}
-.timestamp-kwd      @r{keyword associated with a timestamp, like SCHEDULED}
+.timestamp-kwd      @r{keyword associated with a timestamp, like @code{SCHEDULED}}
 .timestamp-wrapper  @r{span around keyword plus timestamp}
 .tag                @r{tag in a headline}
 ._HOME              @r{each tag uses itself as a class, "@@" replaced by "_"}
@@ -12001,14 +11999,14 @@ p.footnote          @r{footnote definition paragraph, containing a footnote}
 @vindex org-html-head-include-default-style
 @vindex org-html-head
 @vindex org-html-head-extra
-@cindex #+HTML_INCLUDE_STYLE
+@cindex @code{#+HTML_INCLUDE_STYLE}
 The HTML export back-end includes a compact default style in each exported
 HTML file.  To override the default style with another style, use these
 keywords in the Org file.  They will replace the global defaults the HTML
 exporter uses.
 
-@cindex #+HTML_HEAD
-@cindex #+HTML_HEAD_EXTRA
+@cindex @code{#+HTML_HEAD}
+@cindex @code{#+HTML_HEAD_EXTRA}
 @example
 #+HTML_HEAD: <link rel="stylesheet" type="text/css" href="style1.css" />
 #+HTML_HEAD_EXTRA: <link rel="alternate stylesheet" type="text/css" href="style2.css" />
@@ -12058,7 +12056,7 @@ it on your own web server.
 
 To use this program, just add this line to the Org file:
 
-@cindex #+INFOJS_OPT
+@cindex @code{#+INFOJS_OPT}
 @example
 #+INFOJS_OPT: view:info toc:nil
 @end example
@@ -12179,7 +12177,7 @@ The @LaTeX{} export back-end has several additional keywords for customizing
 
 @table @samp
 @item DESCRIPTION
-@cindex #+DESCRIPTION (@LaTeX{})
+@cindex @code{#+DESCRIPTION} (@LaTeX{})
 The document's description.  The description along with author name,
 keywords, and related file metadata are inserted in the output file by the
 @samp{hyperref} package.  See @code{org-latex-hyperref-template} for
@@ -12188,7 +12186,7 @@ typesetting description into the document's front matter.  Use multiple
 @code{#+DESCRIPTION} lines for long descriptions.
 
 @item LATEX_CLASS
-@cindex #+LATEX_CLASS
+@cindex @code{#+LATEX_CLASS}
 @vindex org-latex-default-class
 @vindex org-latex-classes
 This is @LaTeX{} document class, such as @code{article}, @code{report},
@@ -12199,32 +12197,32 @@ default class name from the @code{org-latex-default-class} variable.  Org has
 element of @code{org-latex-classes}.
 
 @item LATEX_CLASS_OPTIONS
-@cindex #+LATEX_CLASS_OPTIONS
+@cindex @code{#+LATEX_CLASS_OPTIONS}
 Options the @LaTeX{} export back-end uses when calling the @LaTeX{} document
 class.
 
 @item LATEX_COMPILER
-@cindex #+LATEX_COMPILER
+@cindex @code{#+LATEX_COMPILER}
 @vindex org-latex-compiler
 The compiler, such as @samp{pdflatex}, @samp{xelatex}, @samp{lualatex}, for
 producing the PDF (@code{org-latex-compiler}).
 
 @item LATEX_HEADER
-@cindex #+LATEX_HEADER
+@cindex @code{#+LATEX_HEADER}
 @vindex org-latex-classes
 Arbitrary lines to add to the document's preamble, before the @samp{hyperref}
 settings.  See @code{org-latex-classes} for adjusting the structure and order
 of the @LaTeX{} headers.
 
 @item LATEX_HEADER_EXTRA
-@cindex #+LATEX_HEADER_EXTRA
+@cindex @code{#+LATEX_HEADER_EXTRA}
 @vindex org-latex-classes
 Arbitrary lines to add to the document's preamble, before the @samp{hyperref}
 settings.  See @code{org-latex-classes} for adjusting the structure and order
 of the @LaTeX{} headers.
 
 @item KEYWORDS
-@cindex #+KEYWORDS (@LaTeX{})
+@cindex @code{#+KEYWORDS} (@LaTeX{})
 The keywords for the document.  The description along with author name,
 keywords, and related file metadata are inserted in the output file by the
 @samp{hyperref} package.  See @code{org-latex-hyperref-template} for
@@ -12233,7 +12231,7 @@ typesetting description into the document's front matter.  Use multiple
 @code{#+KEYWORDS} lines if necessary.
 
 @item SUBTITLE
-@cindex #+SUBTITLE (@LaTeX{})
+@cindex @code{#+SUBTITLE} (@LaTeX{})
 @vindex org-latex-subtitle-separate
 @vindex org-latex-subtitle-format
 The document's subtitle.  It is typeset as per
@@ -12275,10 +12273,10 @@ exporter splices the values of @code{org-latex-default-packages-alist} and
 @code{org-latex-packages-alist}.  Use the same three variables to define
 custom sectioning or custom classes.
 
-@cindex #+LATEX_CLASS
-@cindex #+LATEX_CLASS_OPTIONS
-@cindex property, EXPORT_LATEX_CLASS
-@cindex property, EXPORT_LATEX_CLASS_OPTIONS
+@cindex @code{#+LATEX_CLASS}
+@cindex @code{#+LATEX_CLASS_OPTIONS}
+@cindex property, @code{EXPORT_LATEX_CLASS}
+@cindex property, @code{EXPORT_LATEX_CLASS_OPTIONS}
 The @LaTeX{} export back-end sends the @code{LATEX_CLASS_OPTIONS} keyword and
 @code{EXPORT_LATEX_CLASS_OPTIONS} property as options to the @LaTeX{}
 @code{\documentclass} macro.  The options and the syntax for specifying them,
@@ -12288,8 +12286,8 @@ including enclosing them in square brackets, follow @LaTeX{} conventions.
 #+LATEX_CLASS_OPTIONS: [a4paper,11pt,twoside,twocolumn]
 @end example
 
-@cindex #+LATEX_HEADER
-@cindex #+LATEX_HEADER_EXTRA
+@cindex @code{#+LATEX_HEADER}
+@cindex @code{#+LATEX_HEADER_EXTRA}
 The @LaTeX{} export back-end appends values from @code{LATEX_HEADER} and
 @code{LATEX_HEADER_EXTRA} keywords to the @LaTeX{} header.  The docstring for
 @code{org-latex-classes} explains in more detail.  Also note that @LaTeX{}
@@ -12323,14 +12321,14 @@ Code embedded in-line @@@@latex:any arbitrary LaTeX code@@@@ in a paragraph.
 @end example
 
 Inserting as one or more keyword lines in the Org file:
-@cindex #+LATEX
+@cindex @code{#+LATEX}
 @example
 #+LATEX: any arbitrary LaTeX code
 @end example
 
 Inserting as an export block in the Org file, where the back-end exports any
 code between begin and end markers:
-@cindex #+BEGIN_EXPORT latex
+@cindex @code{#+BEGIN_EXPORT latex}
 @example
 #+BEGIN_EXPORT latex
 any arbitrary LaTeX code
@@ -12340,7 +12338,7 @@ any arbitrary LaTeX code
 @node Tables in @LaTeX{} export
 @subsection Tables in @LaTeX{} export
 @cindex tables, in @LaTeX{} export
-@cindex #+ATTR_LATEX, in tables
+@cindex @code{#+ATTR_LATEX}, in tables
 
 The @LaTeX{} export back-end can pass several @LaTeX{} attributes for table
 contents and layout.  Besides specifying label and caption (@pxref{Images and
@@ -12444,7 +12442,7 @@ Set the caption with the @LaTeX{} command
 @subsection Images in @LaTeX{} export
 @cindex images, inline in @LaTeX{}
 @cindex inlining images in @LaTeX{}
-@cindex #+ATTR_LATEX, in images
+@cindex @code{#+ATTR_LATEX}, in images
 
 The @LaTeX{} export back-end processes image links in Org files that do not
 have descriptions, such as these links @samp{[[file:img.jpg]]} or
@@ -12514,7 +12512,7 @@ Set the @code{:comment-include} attribute to non-@code{nil} value for the
 @node Plain lists in @LaTeX{} export
 @subsection Plain lists in @LaTeX{} export
 @cindex plain lists, in @LaTeX{} export
-@cindex #+ATTR_LATEX, in plain lists
+@cindex @code{#+ATTR_LATEX}, in plain lists
 
 The @LaTeX{} export back-end accepts the @code{:environment} and
 @code{:options} attributes for plain lists.  Both attributes work together
@@ -12548,7 +12546,7 @@ four:
 @node Source blocks in @LaTeX{} export
 @subsection Source blocks in @LaTeX{} export
 @cindex source blocks, in @LaTeX{} export
-@cindex #+ATTR_LATEX, in source blocks
+@cindex @code{#+ATTR_LATEX}, in source blocks
 
 The @LaTeX{} export back-end can make source code blocks into floating
 objects through the attributes @code{:float} and @code{:options}.  For
@@ -12595,7 +12593,7 @@ variables.
 @subsection Example blocks in @LaTeX{} export
 @cindex example blocks, in @LaTeX{} export
 @cindex verbatim blocks, in @LaTeX{} export
-@cindex #+ATTR_LATEX, in example blocks
+@cindex @code{#+ATTR_LATEX}, in example blocks
 
 The @LaTeX{} export back-end wraps the contents of example blocks in a
 @samp{verbatim} environment.  To change this behavior to use another
@@ -12615,7 +12613,7 @@ This sentence is false.
 @cindex special blocks, in @LaTeX{} export
 @cindex abstract, in @LaTeX{} export
 @cindex proof, in @LaTeX{} export
-@cindex #+ATTR_LATEX, in special blocks
+@cindex @code{#+ATTR_LATEX}, in special blocks
 
 
 For other special blocks in the Org file, the @LaTeX{} export back-end makes
@@ -12663,7 +12661,7 @@ example:
 @node Horizontal rules in @LaTeX{} export
 @subsection Horizontal rules in @LaTeX{} export
 @cindex horizontal rules, in @LaTeX{} export
-@cindex #+ATTR_LATEX, in horizontal rules
+@cindex @code{#+ATTR_LATEX}, in horizontal rules
 
 The @LaTeX{} export back-end converts horizontal rules by the specified
 @code{:width} and @code{:thickness} attributes.  For example:
@@ -12747,10 +12745,10 @@ executable.  Without @file{zip}, export cannot finish.
 @anchor{x-export-to-odt}
 @cindex region, active
 @cindex active region
-@cindex transient-mark-mode
+@cindex @code{transient-mark-mode}
 @table @kbd
 @orgcmd{C-c C-e o o,org-odt-export-to-odt}
-@cindex property EXPORT_FILE_NAME
+@cindex property, @code{EXPORT_FILE_NAME}
 
 Export as OpenDocument Text file.
 
@@ -12787,13 +12785,13 @@ output.  Setting these keywords works similar to the general options
 
 @table @samp
 @item DESCRIPTION
-@cindex #+DESCRIPTION (ODT)
+@cindex @code{#+DESCRIPTION} (ODT)
 This is the document's description, which the ODT export back-end inserts as
 document metadata.  For long descriptions, use multiple @code{#+DESCRIPTION}
 lines.
 
 @item KEYWORDS
-@cindex #+KEYWORDS (ODT)
+@cindex @code{#+KEYWORDS} (ODT)
 The keywords for the document.  The ODT export back-end inserts the
 description along with author name, keywords, and related file metadata as
 metadata in the output file.  Use multiple @code{#+KEYWORDS} lines if
@@ -12882,7 +12880,7 @@ Open one, modify, and save as either OpenDocument Text (@file{.odt}) or
 OpenDocument Template (@file{.ott}) file.
 
 @item
-@cindex #+ODT_STYLES_FILE
+@cindex @code{#+ODT_STYLES_FILE}
 @vindex org-odt-styles-file
 Customize the variable @code{org-odt-styles-file} and point it to the
 newly created file.  For additional configuration options
@@ -12941,7 +12939,7 @@ back-end honors any table alignments and relative widths for columns
 Note that the ODT export back-end interprets column widths as weighted
 ratios, the default weight being 1.
 
-@cindex #+ATTR_ODT
+@cindex @code{#+ATTR_ODT}
 
 Specifying @code{:rel-width} property on an @code{#+ATTR_ODT} line controls
 the width of the table.  For example:
@@ -12998,7 +12996,7 @@ when clicked jumps to @uref{http://Orgmode.org} website, do the following
 
 @subsubheading Sizing and scaling of embedded images
 
-@cindex #+ATTR_ODT
+@cindex @code{#+ATTR_ODT}
 Control the size and scale of the embedded images with the @code{#+ATTR_ODT}
 attribute.
 
@@ -13054,7 +13052,7 @@ height:width ratio, do the following
 
 @subsubheading Anchoring of images
 
-@cindex #+ATTR_ODT
+@cindex @code{#+ATTR_ODT}
 The ODT export back-end can anchor images to @samp{"as-char"},
 @samp{"paragraph"}, or @samp{"page"}.  Set the preferred anchor using the
 @code{:anchor} property of the @code{#+ATTR_ODT} line.
@@ -13452,7 +13450,7 @@ This paragraph is specially formatted and uses bold text.
 @subsubheading Customizing tables in ODT export
 @cindex tables, in ODT export
 
-@cindex #+ATTR_ODT
+@cindex @code{#+ATTR_ODT}
 Override the default table format by specifying a custom table style with the
 @code{#+ATTR_ODT} line.  For a discussion on default formatting of tables
 @pxref{Tables in ODT export}.
@@ -13696,52 +13694,52 @@ Texinfo output.  Setting these keywords works similar to the general options
 @table @samp
 
 @item SUBTITLE
-@cindex #+SUBTITLE (Texinfo)
+@cindex @code{#+SUBTITLE} (Texinfo)
 The document subtitle.
 
 @item SUBAUTHOR
-@cindex #+SUBAUTHOR
+@cindex @code{#+SUBAUTHOR}
 The document subauthor.
 
 @item TEXINFO_FILENAME
-@cindex #+TEXINFO_FILENAME
+@cindex @code{#+TEXINFO_FILENAME}
 The Texinfo filename.
 
 @item TEXINFO_CLASS
-@cindex #+TEXINFO_CLASS
+@cindex @code{#+TEXINFO_CLASS}
 @vindex org-texinfo-default-class
 The default document class (@code{org-texinfo-default-class}), which must be
 a member of @code{org-texinfo-classes}.
 
 @item TEXINFO_HEADER
-@cindex #+TEXINFO_HEADER
+@cindex @code{#+TEXINFO_HEADER}
 Arbitrary lines inserted at the end of the header.
 
 @item TEXINFO_POST_HEADER
-@cindex #+TEXINFO_POST_HEADER
+@cindex @code{#+TEXINFO_POST_HEADER}
 Arbitrary lines inserted after the end of the header.
 
 @item TEXINFO_DIR_CATEGORY
-@cindex #+TEXINFO_DIR_CATEGORY
+@cindex @code{#+TEXINFO_DIR_CATEGORY}
 The directory category of the document.
 
 @item TEXINFO_DIR_TITLE
-@cindex #+TEXINFO_DIR_TITLE
+@cindex @code{#+TEXINFO_DIR_TITLE}
 The directory title of the document.
 
 @item TEXINFO_DIR_DESC
-@cindex #+TEXINFO_DIR_DESC
+@cindex @code{#+TEXINFO_DIR_DESC}
 The directory description of the document.
 
 @item TEXINFO_PRINTED_TITLE
-@cindex #+TEXINFO_PRINTED_TITLE
+@cindex @code{#+TEXINFO_PRINTED_TITLE}
 The printed title of the document.
 @end table
 
 @node Texinfo file header
 @subsection Texinfo file header
 
-@cindex #+TEXINFO_FILENAME
+@cindex @code{#+TEXINFO_FILENAME}
 After creating the header for a Texinfo file, the Texinfo back-end
 automatically generates a name and destination path for the Info file.  To
 override this default with a more sensible path and name, specify the
@@ -13749,8 +13747,8 @@ override this default with a more sensible path and name, specify the
 
 @vindex org-texinfo-coding-system
 @vindex org-texinfo-classes
-@cindex #+TEXINFO_HEADER
-@cindex #+TEXINFO_CLASS
+@cindex @code{#+TEXINFO_HEADER}
+@cindex @code{#+TEXINFO_CLASS}
 Along with the output's file name, the Texinfo header also contains language
 details (@pxref{Export settings}) and encoding system as set in the
 @code{org-texinfo-coding-system} variable.  Insert @code{#+TEXINFO_HEADER}
@@ -13764,14 +13762,14 @@ setting the @code{#+TEXINFO_CLASS} keyword to that class.
 @node Texinfo title and copyright page
 @subsection Texinfo title and copyright page
 
-@cindex #+TEXINFO_PRINTED_TITLE
+@cindex @code{#+TEXINFO_PRINTED_TITLE}
 The default template for hard copy output has a title page with
 @code{#+TITLE} and @code{#+AUTHOR} (@pxref{Export settings}).  To replace the
 regular @code{#+TITLE} with something different for the printed version, use
 the @code{#+TEXINFO_PRINTED_TITLE} and @code{#+SUBTITLE} keywords.  Both
 expect raw Texinfo code for setting their values.
 
-@cindex #+SUBAUTHOR
+@cindex @code{#+SUBAUTHOR}
 If one @code{#+AUTHOR} is not sufficient, add multiple @code{#+SUBAUTHOR}
 keywords.  They have to be set in raw Texinfo code.
 
@@ -13781,7 +13779,7 @@ keywords.  They have to be set in raw Texinfo code.
 #+TEXINFO_PRINTED_TITLE: This Long Title@@inlinefmt@{tex,@@*@} Is Broken in @@TeX@{@}
 @end example
 
-@cindex property, COPYING
+@cindex property, @code{COPYING}
 Copying material is defined in a dedicated headline with a non-@code{nil}
 @code{:COPYING:} property.  The back-end inserts the contents within a
 @code{@@copying} command at the beginning of the document.  The heading
@@ -13809,9 +13807,9 @@ Copyright information is printed on the back of the title page.
 @cindex @code{install-info} parameters, in Texinfo export
 @cindex Texinfo export, @code{install-info} parameters
 
-@cindex #+TEXINFO_DIR_CATEGORY
-@cindex #+TEXINFO_DIR_TITLE
-@cindex #+TEXINFO_DIR_DESC
+@cindex @code{#+TEXINFO_DIR_CATEGORY}
+@cindex @code{#+TEXINFO_DIR_TITLE}
+@cindex @code{#+TEXINFO_DIR_DESC}
 The end result of the Texinfo export process is the creation of an Info file.
 This Info file's metadata has variables for category, title, and description:
 @code{#+TEXINFO_DIR_CATEGORY}, @code{#+TEXINFO_DIR_TITLE}, and
@@ -13831,7 +13829,7 @@ Here is an example that writes to the Info directory file:
 
 @vindex org-texinfo-classes
 @vindex org-texinfo-default-class
-@cindex #+TEXINFO_CLASS
+@cindex @code{#+TEXINFO_CLASS}
 The Texinfo export back-end uses a pre-defined scheme to convert Org
 headlines to an equivalent Texinfo structuring commands.  A scheme like this
 maps top-level headlines to numbered chapters tagged as @code{@@chapter} and
@@ -13846,12 +13844,12 @@ If an Org headline's level has no associated Texinfo structuring command, or
 is below a certain threshold (@pxref{Export settings}), then the Texinfo
 export back-end makes it into a list item.
 
-@cindex property, APPENDIX
+@cindex property, @code{APPENDIX}
 The Texinfo export back-end makes any headline with a non-@code{nil}
 @code{:APPENDIX:} property into an appendix.  This happens independent of the
 Org headline level or the @code{#+TEXINFO_CLASS}.
 
-@cindex property, DESCRIPTION
+@cindex property, @code{DESCRIPTION}
 The Texinfo export back-end creates a menu entry after the Org headline for
 each regular sectioning structure.  To override this with a shorter menu
 entry, use the @code{:ALT_TITLE:} property (@pxref{Table of contents}).
@@ -13877,22 +13875,22 @@ Top Node,,texinfo}, for more information.
 @node Indices
 @subsection Indices
 
-@cindex #+CINDEX
+@cindex @code{#+CINDEX}
 @cindex concept index, in Texinfo export
 @cindex Texinfo export, index, concept
-@cindex #+FINDEX
+@cindex @code{#+FINDEX}
 @cindex function index, in Texinfo export
 @cindex Texinfo export, index, function
-@cindex #+KINDEX
+@cindex @code{#+KINDEX}
 @cindex keystroke index, in Texinfo export
 @cindex Texinfo export, keystroke index
-@cindex #+PINDEX
+@cindex @code{#+PINDEX}
 @cindex program index, in Texinfo export
 @cindex Texinfo export, program index
-@cindex #+TINDEX
+@cindex @code{#+TINDEX}
 @cindex data type index, in Texinfo export
 @cindex Texinfo export, data type index
-@cindex #+VINDEX
+@cindex @code{#+VINDEX}
 @cindex variable index, in Texinfo export
 @cindex Texinfo export, variable index
 The Texinfo export back-end recognizes these indexing keywords if used in the
@@ -13905,7 +13903,7 @@ escaped with @samp{@@} if they not belong to a Texinfo command.
 #+CINDEX: Defining indexing entries
 @end example
 
-@cindex property, INDEX
+@cindex property, @code{INDEX}
 For the back-end to generate an index entry for a headline, set the
 @code{:INDEX:} property to @samp{cp} or @samp{vr}.  These abbreviations come
 from Texinfo that stand for concept index and variable index.  The Texinfo
@@ -13925,8 +13923,8 @@ inserts the index after its contents.
 
 Use any of the following three methods to insert or escape raw Texinfo code:
 
-@cindex #+TEXINFO
-@cindex #+BEGIN_EXPORT texinfo
+@cindex @code{#+TEXINFO}
+@cindex @code{#+BEGIN_EXPORT texinfo}
 @example
 Richard @@@@texinfo:@@sc@{@@@@Stallman@@@@texinfo:@}@@@@ commence' GNU.
 
@@ -13941,10 +13939,10 @@ This paragraph is preceded by...
 
 @node Plain lists in Texinfo export
 @subsection Plain lists in Texinfo export
-@cindex #+ATTR_TEXINFO, in plain lists
+@cindex @code{#+ATTR_TEXINFO}, in plain lists
 @cindex Two-column tables, in Texinfo export
 
-@cindex :table-type attribute, in Texinfo export
+@cindex @code{:table-type} attribute, in Texinfo export
 The Texinfo export back-end by default converts description lists in the Org
 file using the default command @code{@@table}, which results in a table with
 two columns.  To change this behavior, specify @code{:table-type} with
@@ -13952,14 +13950,14 @@ two columns.  To change this behavior, specify @code{:table-type} with
 @inforef{Two-column Tables,,texinfo}.
 
 @vindex org-texinfo-table-default-markup
-@cindex :indic attribute, in Texinfo export
+@cindex @code{:indic} attribute, in Texinfo export
 The Texinfo export back-end by default also applies a text highlight based on
 the defaults stored in @code{org-texinfo-table-default-markup}.  To override
 the default highlight command, specify another one with the @code{:indic}
 attribute.
 
 @cindex Multiple entries in two-column tables, in Texinfo export
-@cindex :sep attribute, in Texinfo export
+@cindex @code{:sep} attribute, in Texinfo export
 Org syntax is limited to one entry per list item.  Nevertheless, the Texinfo
 export back-end can split that entry according to any text provided through
 the @code{:sep} attribute.  Each part then becomes a new entry in the first
@@ -13985,7 +13983,7 @@ This is the common text for variables foo and bar.
 
 @node Tables in Texinfo export
 @subsection Tables in Texinfo export
-@cindex #+ATTR_TEXINFO, in tables
+@cindex @code{#+ATTR_TEXINFO}, in tables
 
 When exporting tables, the Texinfo export back-end uses the widest cell width
 in each column.  To override this and instead specify as fractions of line
@@ -13998,7 +13996,7 @@ length, use the @code{:columns} attribute.  See example below.
 
 @node Images in Texinfo export
 @subsection Images in Texinfo export
-@cindex #+ATTR_TEXINFO, in images
+@cindex @code{#+ATTR_TEXINFO}, in images
 
 Insert a file link to the image in the Org file, and the Texinfo export
 back-end inserts the image.  These links must have the usual supported image
@@ -14013,7 +14011,7 @@ the text using Texinfo code, as shown in the example:
 
 @node Special blocks in Texinfo export
 @subsection Special blocks
-@cindex #+ATTR_TEXINFO, in special blocks
+@cindex @code{#+ATTR_TEXINFO}, in special blocks
 
 The Texinfo export back-end converts special blocks to commands with the same
 name.  It also adds any @code{:options} attributes to the end of the command,
@@ -14136,7 +14134,7 @@ configure the variable @code{org-icalendar-categories}.  To assign clock
 alarms based on time, configure the @code{org-icalendar-alarm-time} variable.
 
 @vindex org-icalendar-store-UID
-@cindex property, ID
+@cindex property, @code{ID}
 The iCalendar format standard requires globally unique identifier---UID---for
 each entry.  The iCalendar export back-end creates UIDs during export.  To
 save a copy of the UID in the Org file set the variable
@@ -14165,26 +14163,27 @@ and write it to @code{org-icalendar-combined-agenda-file} file name.
 
 @vindex org-use-property-inheritance
 @vindex org-icalendar-include-body
-@cindex property, SUMMARY
-@cindex property, DESCRIPTION
-@cindex property, LOCATION
-@cindex property, TIMEZONE
-The iCalendar export back-end includes SUMMARY, DESCRIPTION, LOCATION and
-TIMEZONE properties from the Org entries when exporting.  To force the
-back-end to inherit the LOCATION and TIMEZONE properties, configure the
-@code{org-use-property-inheritance} variable.
-
-When Org entries do not have SUMMARY, DESCRIPTION and LOCATION properties,
-the iCalendar export back-end derives the summary from the headline, and
-derives the description from the body of the Org item.  The
-@code{org-icalendar-include-body} variable limits the maximum number of
+@cindex property, @code{SUMMARY}
+@cindex property, @code{DESCRIPTION}
+@cindex property, @code{LOCATION}
+@cindex property, @code{TIMEZONE}
+The iCalendar export back-end includes @code{SUMMARY}, @code{DESCRIPTION},
+@code{LOCATION} and @code{TIMEZONE} properties from the Org entries when
+exporting.  To force the back-end to inherit the @code{LOCATION} and
+@code{TIMEZONE} properties, configure the @code{org-use-property-inheritance}
+variable.
+
+When Org entries do not have @code{SUMMARY}, @code{DESCRIPTION} and
+@code{LOCATION} properties, the iCalendar export back-end derives the summary
+from the headline, and derives the description from the body of the Org item.
+The @code{org-icalendar-include-body} variable limits the maximum number of
 characters of the content are turned into its description.
 
-The TIMEZONE property can be used to specify a per-entry time zone, and will
-be applied to any entry with timestamp information.  Time zones should be
-specified as per the IANA time zone database format, e.g.@: ``Asia/Almaty''.
-Alternately, the property value can be ``UTC'', to force UTC time for this
-entry only.
+The @code{TIMEZONE} property can be used to specify a per-entry time zone,
+and will be applied to any entry with timestamp information.  Time zones
+should be specified as per the IANA time zone database format, e.g.@:
+``Asia/Almaty''.  Alternately, the property value can be ``UTC'', to force
+UTC time for this entry only.
 
 Exporting to iCalendar format depends in large part on the capabilities of
 the destination application.  Some are more lenient than others.  Consult the
@@ -14473,7 +14472,7 @@ and many other properties of a project.
 
 @node Project alist
 @subsection The variable @code{org-publish-project-alist}
-@cindex org-publish-project-alist
+@cindex @code{org-publish-project-alist}
 @cindex projects, for publishing
 
 @vindex org-publish-project-alist
@@ -14929,7 +14928,7 @@ The file will be created when first publishing a project with the
 "theindex.inc"}.  You can then build around this include statement by adding
 a title, style information, etc.
 
-@cindex #+INDEX
+@cindex @code{#+INDEX}
 Index entries are specified with @code{#+INDEX} keyword.  An entry that
 contains an exclamation mark will create a sub item.
 
@@ -15100,8 +15099,8 @@ such as not inside comments and fixed width areas.  Here's a sample
 #+END_SRC
 @end example
 
-Org can take the code in the block between the @samp{#+BEGIN_SRC} and
-@samp{#+END_SRC} tags, and format, compile, execute, and show the results.
+Org can take the code in the block between the @code{#+BEGIN_SRC} and
+@code{#+END_SRC} tags, and format, compile, execute, and show the results.
 Org can simplify many housekeeping tasks essential to modern code
 maintenance.  That's why these blocks in Org mode literature are sometimes
 referred to as @samp{live code} blocks (as compared to the static text and
@@ -15110,7 +15109,7 @@ block by tweaking the headers for compiling, execution, extraction.
 
 Org's @samp{src} code block type is one of many block types, such as quote,
 export, verse, latex, example, and verbatim.  This section pertains to
-@samp{src} code blocks between @samp{#+BEGIN_SRC} and @samp{#+END_SRC}
+@code{src} code blocks between @code{#+BEGIN_SRC} and @code{#+END_SRC}
 
 For editing @samp{src} code blocks, Org provides native Emacs major-modes.
 That leverages the latest Emacs features for that source code language mode.
@@ -15172,8 +15171,8 @@ Details of Org's facilities for working with source code are shown next.
 @section Structure of code blocks
 @cindex code block, structure
 @cindex source code, block structure
-@cindex #+NAME
-@cindex #+BEGIN_SRC
+@cindex @code{#+NAME}
+@cindex @code{#+BEGIN_SRC}
 
 Org offers two ways to structure source code in Org documents: in a
 @samp{src} block, and directly inline.  Both specifications are shown below.
@@ -15215,7 +15214,7 @@ results.  Code from other blocks, other files, and from table formulas
 (@pxref{The spreadsheet}) can use the name to reference a @samp{src} block.
 This naming serves the same purpose as naming Org tables.  Org mode requires
 unique names.  For duplicate names, Org mode's behavior is undefined.
-@cindex #+NAME
+@cindex @code{#+NAME}
 @item #+BEGIN_SRC
 @item #+END_SRC
 Mandatory.  They mark the start and end of a block that Org requires.  The
@@ -15426,7 +15425,7 @@ block header arguments: One, set @code{padline} (@pxref{padline}) to true
 @section Evaluating code blocks
 @cindex code block, evaluating
 @cindex source code, evaluating
-@cindex #+RESULTS
+@cindex @code{#+RESULTS}
 
 A note about security: With code evaluation comes the risk of harm.  Org
 safeguards by prompting for user's permission before executing any code in
@@ -15449,7 +15448,7 @@ evaluation from the @kbd{C-c C-c} key binding.} calls the
 @code{org-babel-execute-src-block} function, which executes the code in the
 block, collects the results, and inserts them in the buffer.
 
-@cindex #+CALL
+@cindex @code{#+CALL}
 By calling a named code block@footnote{Actually, the constructs call_<name>()
 and src_<lang>@{@} are not evaluated when they appear in a keyword line
 (i.e. lines starting with @code{#+KEYWORD:}, @pxref{In-buffer settings}).}
@@ -15732,7 +15731,7 @@ each line.  Note that Org currently accepts the plural spelling of
 @code{#+HEADER:} only as a convenience for backward-compatibility.  It may be
 removed at some point.
 
-@cindex #+HEADER:
+@cindex @code{#+HEADER:}
 
 Multi-line header arguments on an unnamed @samp{src} code block:
 
@@ -17252,7 +17251,7 @@ emacs -Q --batch --eval "
 * Speed keys::                  Electric commands at the beginning of a headline
 * Code evaluation security::    Org mode files evaluate inline code
 * Customization::               Adapting Org to changing tastes
-* In-buffer settings::          Overview of the #+KEYWORDS
+* In-buffer settings::          Overview of the @code{#+KEYWORDS}
 * The very busy C-c C-c key::   When in doubt, press C-c C-c
 * Clean view::                  Getting rid of leading stars in the outline
 * TTY keys::                    Using Org on a tty
@@ -17300,7 +17299,7 @@ can be used in search links like @samp{[[*find this headline]]}.
 @item
 After @samp{:} in a headline, complete tags.  The list of tags is taken
 from the variable @code{org-tag-alist} (possibly set through the
-@samp{#+TAGS} in-buffer option, @pxref{Setting tags}), or it is created
+@code{#+TAGS} in-buffer option, @pxref{Setting tags}), or it is created
 dynamically from all tags used in the current buffer.
 @item
 After @samp{:} and not in a headline, complete property keys.  The list
@@ -17313,7 +17312,7 @@ After @samp{#+}, complete the special keywords like @samp{TYP_TODO} or
 file-specific @samp{OPTIONS}.  After option keyword is complete, pressing
 @kbd{M-@key{TAB}} again will insert example settings for that option.
 @item
-After @samp{#+STARTUP: }, complete startup keywords.
+After @code{#+STARTUP:}, complete startup keywords.
 @item
 When the point is anywhere else, complete dictionary words using Ispell.
 @end itemize
@@ -17477,13 +17476,13 @@ reopening the Org file in Emacs also activates the changes.
 @table @kbd
 @item #+ARCHIVE: %s_done::
 Sets the archive location of the agenda file.  This location applies to the
-lines until the next @samp{#+ARCHIVE} line, if any, in the Org file.  The
+lines until the next @code{#+ARCHIVE} line, if any, in the Org file.  The
 first archive location in the Org file also applies to any entries before it.
 The corresponding variable is @code{org-archive-location}.
 @item #+CATEGORY:
 Sets the category of the agenda file, which applies to the entire document.
 @item #+COLUMNS: %25ITEM ...
-@cindex property, COLUMNS
+@cindex property, @code{COLUMNS}
 Sets the default format for columns view.  Org uses this format for column
 views where there is no @code{COLUMNS} property.
 @item #+CONSTANTS: name1=value1 ...
@@ -17510,7 +17509,7 @@ have a lower ASCII number than the lowest priority.
 @item #+PROPERTY: Property_Name Value
 This line sets a default inheritance value for entries in the current
 buffer, most useful for specifying the allowed values of a property.
-@cindex #+SETUPFILE
+@cindex @code{#+SETUPFILE}
 @item #+SETUPFILE: file or URL
 The setup file or a URL pointing to such file is for additional in-buffer
 settings.  Org loads this file and parses it for any settings in it only when
@@ -17522,7 +17521,7 @@ parses the contents of this document as if it was included in the buffer.  It
 can be another Org file.  To visit the file (not a URL), @kbd{C-c '} while
 the cursor is on the line with the file name.
 @item #+STARTUP:
-@cindex #+STARTUP
+@cindex @code{#+STARTUP}
 Startup options Org uses when first visiting a file.
 
 The first set of options deals with the initial visibility of the outline
@@ -17703,7 +17702,7 @@ fnadjust    @r{automatically renumber and sort footnotes}
 nofnadjust  @r{do not renumber and sort automatically}
 @end example
 
-@cindex org-hide-block-startup
+@cindex @code{org-hide-block-startup}
 To hide blocks on startup, use these keywords.  The corresponding variable is
 @code{org-hide-block-startup}.
 @cindex @code{hideblocks}, STARTUP keyword
@@ -17713,7 +17712,7 @@ hideblocks   @r{Hide all begin/end blocks on startup}
 nohideblocks @r{Do not hide blocks on startup}
 @end example
 
-@cindex org-pretty-entities
+@cindex @code{org-pretty-entities}
 The display of entities as UTF-8 characters is governed by the variable
 @code{org-pretty-entities} and the keywords
 @cindex @code{entitiespretty}, STARTUP keyword
@@ -17728,11 +17727,11 @@ entitiesplain   @r{Leave entities plain}
 These lines specify valid tags for this file.  Org accepts multiple tags
 lines.  Tags could correspond to the @emph{fast tag selection} keys.  The
 corresponding variable is @code{org-tag-alist}.
-@cindex #+TBLFM
+@cindex @code{#+TBLFM}
 @item #+TBLFM:
 This line is for formulas for the table directly above.  A table can have
-multiple @samp{#+TBLFM:} lines.  On table recalculation, Org applies only the
-first @samp{#+TBLFM:} line.  For details see @ref{Using multiple #+TBLFM
+multiple @code{#+TBLFM:} lines.  On table recalculation, Org applies only the
+first @code{#+TBLFM:} line.  For details see @ref{Using multiple #+TBLFM
 lines} in @ref{Editing and debugging formulas}.
 @item #+TITLE:, #+AUTHOR:, #+EMAIL:, #+LANGUAGE:, #+DATE:,
 @itemx #+OPTIONS:, #+BIND:,
@@ -17748,7 +17747,7 @@ The corresponding variable is @code{org-todo-keywords}.
 @node The very busy C-c C-c key
 @section The very busy C-c C-c key
 @kindex C-c C-c
-@cindex C-c C-c, overview
+@cindex @kbd{C-c C-c}, overview
 
 The @kbd{C-c C-c} key in Org serves many purposes depending on the context.
 It is probably the most over-worked, multi-purpose key combination in Org.
@@ -18427,7 +18426,7 @@ the mode is C, then:
 At the location of source, Org needs a special line to direct Orgtbl to
 translate and to find the target for inserting the translated table.  For
 example:
-@cindex #+ORGTBL
+@cindex @code{#+ORGTBL}
 @example
 #+ORGTBL: SEND table_name translation_function arguments...
 @end example
@@ -18481,7 +18480,7 @@ install templates for other export formats.}  with the command @kbd{M-x
 orgtbl-insert-radio-table RET}, which prompts for a table name.  For example,
 if @samp{salesfigures} is the name, the template inserts:
 
-@cindex #+ORGTBL, SEND
+@cindex @code{#+ORGTBL}, @samp{SEND}
 @example
 % BEGIN RECEIVE ORGTBL salesfigures
 % END RECEIVE ORGTBL salesfigures
@@ -18497,7 +18496,7 @@ The line @code{#+ORGTBL: SEND} tells Orgtbl mode to use the function
 @code{orgtbl-to-latex} to convert the table to @LaTeX{} format, then insert
 the table at the target (receive) location named @code{salesfigures}.  Now
 the table is ready for data entry.  It can even use spreadsheet
-features@footnote{If the @samp{#+TBLFM} line contains an odd number of dollar
+features@footnote{If the @code{#+TBLFM} line contains an odd number of dollar
 characters, this may cause problems with font-lock in @LaTeX{} mode.  As
 shown in the example you can fix this by adding an extra line inside the
 @code{comment} environment that is used to balance the dollar expressions.
@@ -18628,14 +18627,14 @@ translator functions by posting them to the Org users mailing list,
 @node Radio lists
 @subsection Radio lists
 @cindex radio lists
-@cindex org-list-insert-radio-list
+@cindex @code{org-list-insert-radio-list}
 
 Call the @code{org-list-insert-radio-list} function to insert a radio list
 template in HTML, @LaTeX{}, and Texinfo mode documents.  Sending and
 receiving radio lists works is the same as for radio tables (@pxref{Radio
 tables}) except for these differences:
 
-@cindex #+ORGLST
+@cindex @code{#+ORGLST}
 @itemize @minus
 @item
 Orgstruct mode must be active.
@@ -18679,7 +18678,7 @@ time}).
 Dynamic blocks can have names and function parameters.  The syntax is similar
 to @samp{src} code block specifications:
 
-@cindex #+BEGIN:dynamic block
+@cindex @code{#+BEGIN}, dynamic block
 @example
 #+BEGIN: myblock :parameter1 value1 :parameter2 value2 ...
 
@@ -18941,7 +18940,7 @@ priority-n   @r{The computed numerical priority}
 
 @noindent
 If the selection of the agenda item was based on a timestamp, including those
-items with @samp{DEADLINE} and @samp{SCHEDULED} keywords, then Org includes
+items with @code{DEADLINE} and @code{SCHEDULED} keywords, then Org includes
 date and time in the output.
 
 If the selection of the agenda item was based on a timestamp  (or
-- 
2.21.0


From 716f34dea5d5a6cac3eefcb26aee5239b4c8d49d Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Sat, 24 Feb 2018 20:52:21 +0100
Subject: [PATCH 030/297] Fix @cindex entries in manuals

* doc/emacs/custom.texi:
* doc/emacs/dired.texi:
* doc/emacs/display.texi:
* doc/emacs/files.texi:
* doc/emacs/frames.texi:
* doc/emacs/killing.texi:
* doc/emacs/maintaining.texi:
* doc/emacs/misc.texi:
* doc/emacs/msdos-xtra.texi:
* doc/emacs/msdos.texi:
* doc/emacs/search.texi:
* doc/emacs/text.texi:
* doc/emacs/trouble.texi:
* doc/lispintro/emacs-lisp-intro.texi:
* doc/lispref/strings.texi:
* doc/lispref/text.texi:
* doc/misc/cc-mode.texi:
* doc/misc/efaq.texi:
* doc/misc/eieio.texi:
* doc/misc/emacs-mime.texi:
* doc/misc/gnus.texi:
* doc/misc/htmlfontify.texi:
* doc/misc/idlwave.texi:
* doc/misc/message.texi:
* doc/misc/mh-e.texi:
* doc/misc/sem-user.texi:
* doc/misc/ses.texi:
* doc/misc/tramp.texi:
* doc/misc/vhdl-mode.texi: Fix @cindex entries.
---
 doc/emacs/custom.texi               |  2 +-
 doc/emacs/dired.texi                |  4 ++--
 doc/emacs/display.texi              | 36 ++++++++++++++---------------
 doc/emacs/files.texi                |  2 +-
 doc/emacs/frames.texi               |  6 ++---
 doc/emacs/killing.texi              |  2 +-
 doc/emacs/maintaining.texi          |  2 +-
 doc/emacs/misc.texi                 |  2 +-
 doc/emacs/msdos.texi                |  2 +-
 doc/emacs/search.texi               | 10 ++++----
 doc/emacs/text.texi                 |  2 +-
 doc/emacs/trouble.texi              |  4 ++--
 doc/lispintro/emacs-lisp-intro.texi |  2 +-
 doc/lispref/strings.texi            |  2 +-
 doc/lispref/text.texi               |  2 +-
 doc/misc/cc-mode.texi               |  6 ++---
 doc/misc/efaq.texi                  |  2 +-
 doc/misc/eieio.texi                 |  6 ++---
 doc/misc/emacs-mime.texi            |  8 +++----
 doc/misc/gnus.texi                  |  4 ++--
 doc/misc/htmlfontify.texi           |  6 ++---
 doc/misc/idlwave.texi               |  2 +-
 doc/misc/message.texi               |  2 +-
 doc/misc/mh-e.texi                  | 24 +++++++++----------
 doc/misc/sem-user.texi              |  6 ++---
 doc/misc/ses.texi                   |  8 +++----
 doc/misc/vhdl-mode.texi             |  4 ++--
 27 files changed, 79 insertions(+), 79 deletions(-)

diff --git a/doc/emacs/custom.texi b/doc/emacs/custom.texi
index 05925f043c..a9f261b307 100644
--- a/doc/emacs/custom.texi
+++ b/doc/emacs/custom.texi
@@ -2159,7 +2159,7 @@ loading of this library, use the option @samp{--no-site-file}.
 better to put them in @file{default.el}, so that users can more easily
 override them.
 
-@cindex site-lisp directories
+@cindex @file{site-lisp} directories
   You can place @file{default.el} and @file{site-start.el} in any of
 the directories which Emacs searches for Lisp libraries.  The variable
 @code{load-path} (@pxref{Lisp Libraries}) specifies these directories.
diff --git a/doc/emacs/dired.texi b/doc/emacs/dired.texi
index b924a6d16b..14d5243387 100644
--- a/doc/emacs/dired.texi
+++ b/doc/emacs/dired.texi
@@ -1370,8 +1370,8 @@ C-c}.
 
 @node Image-Dired
 @section Viewing Image Thumbnails in Dired
-@cindex image-dired mode
-@cindex image-dired
+@cindex @code{image-dired} mode
+@cindex @code{image-dired}
 
   Image-Dired is a facility for browsing image files.  It provides viewing
 the images either as thumbnails or in full size, either inside Emacs
diff --git a/doc/emacs/display.texi b/doc/emacs/display.texi
index 64a1d4b5fa..42b07cc0fe 100644
--- a/doc/emacs/display.texi
+++ b/doc/emacs/display.texi
@@ -526,7 +526,7 @@ frames as if they have a dark background, whereas a value of
 background.
 
 @cindex background color
-@cindex default face
+@cindex @code{default face}
   You can customize a face to alter its attributes, and save those
 customizations for future Emacs sessions.  @xref{Face Customization},
 for details.
@@ -535,7 +535,7 @@ for details.
 of its attributes are specified.  Its background color is also used as
 the frame's background color.  @xref{Colors}.
 
-@cindex cursor face
+@cindex @code{cursor} face
   Another special face is the @code{cursor} face.  On graphical
 displays, the background color of this face is used to draw the text
 cursor.  None of the other attributes of this face have any effect;
@@ -627,10 +627,10 @@ but you should not make it a variable-width font.
 @item fixed-pitch-serif
 This face is like @code{fixed-pitch}, except the font has serifs and
 looks more like traditional typewriting.
-@cindex variable-pitch face
+@cindex @code{variable-pitch} face
 @item variable-pitch
 This face forces use of a variable-width font.
-@cindex shadow face
+@cindex @code{shadow} face
 @item shadow
 This face is used for making the text less noticeable than the surrounding
 ordinary text.  Usually this can be achieved by using shades of gray in
@@ -685,40 +685,40 @@ frame:
 
 @table @code
 @item mode-line
-@cindex mode-line face
+@cindex @code{mode-line} face
 @cindex faces for mode lines
 This face is used for the mode line of the currently selected window,
 and for menu bars when toolkit menus are not used.  By default, it's
 drawn with shadows for a raised effect on graphical displays, and
 drawn as the inverse of the default face on non-windowed terminals.
 @item mode-line-inactive
-@cindex mode-line-inactive face
+@cindex @code{mode-line-inactive} face
 Like @code{mode-line}, but used for mode lines of the windows other
 than the selected one (if @code{mode-line-in-non-selected-windows} is
 non-@code{nil}).  This face inherits from @code{mode-line}, so changes
 in that face affect mode lines in all windows.
 @item mode-line-highlight
-@cindex mode-line-highlight face
+@cindex @code{mode-line-highlight} face
 Like @code{highlight}, but used for mouse-sensitive portions of text
 on mode lines.  Such portions of text typically pop up tooltips
 (@pxref{Tooltips}) when the mouse pointer hovers above them.
 @item mode-line-buffer-id
-@cindex mode-line-buffer-id face
+@cindex @code{mode-line-buffer-id} face
 This face is used for buffer identification parts in the mode line.
 @item header-line
-@cindex header-line face
+@cindex @code{header-line} face
 Similar to @code{mode-line} for a window's header line, which appears
 at the top of a window just as the mode line appears at the bottom.
 Most windows do not have a header line---only some special modes, such
 Info mode, create one.
 @item header-line-highlight
-@cindex header-line-highlight face
+@cindex @code{header-line-highlight} face
 Similar to @code{highlight} and @code{mode-line-highlight}, but used
 for mouse-sensitive portions of text on header lines.  This is a
 separate face because the @code{header-line} face might be customized
 in a way that does not interact well with @code{highlight}.
 @item vertical-border
-@cindex vertical-border face
+@cindex @code{vertical-border} face
 This face is used for the vertical divider between windows on text
 terminals.
 @item minibuffer-prompt
@@ -765,7 +765,7 @@ This face determines the color of tool bar icons.  @xref{Tool Bars}.
 This face determines the colors and font of Emacs's menus.  @xref{Menu
 Bars}.
 @item tty-menu-enabled-face
-@cindex faces for text-mode menus
+@cindex faces for @code{text-mode} menus
 @cindex TTY menu faces
 This face is used to display enabled menu items on text-mode
 terminals.
@@ -1177,7 +1177,7 @@ empty lines at the end of a buffer, without realizing it.  In most
 cases, this @dfn{trailing whitespace} has no effect, but sometimes it
 can be a nuisance.
 
-@cindex trailing-whitespace face
+@cindex @code{trailing-whitespace} face
   You can make trailing whitespace at the end of a line visible by
 setting the buffer-local variable @code{show-trailing-whitespace} to
 @code{t}.  Then Emacs displays trailing whitespace, using the face
@@ -1508,8 +1508,8 @@ as octal escape sequences instead of caret escape sequences.
 @cindex non-breaking space
 @cindex non-breaking hyphen
 @cindex soft hyphen
-@cindex escape-glyph face
-@cindex nobreak-space face
+@cindex @code{escape-glyph} face
+@cindex @code{nobreak-space} face
   Some non-@acronym{ASCII} characters have the same appearance as an
 @acronym{ASCII} space or hyphen (minus) character.  Such characters
 can cause problems if they are entered into a buffer without your
@@ -1531,7 +1531,7 @@ elisp, The Emacs Lisp Reference Manual}.
 
 @cindex glyphless characters
 @cindex characters with no font glyphs
-@cindex glyphless-char face
+@cindex @code{glyphless-char} face
   On graphical displays, some characters may have no glyphs in any of
 the fonts available to Emacs.  These @dfn{glyphless characters} are
 normally displayed as boxes containing the hexadecimal character code.
@@ -1546,7 +1546,7 @@ for details.
 
 @cindex curly quotes, and terminal capabilities
 @cindex curved quotes, and terminal capabilities
-@cindex homoglyph face
+@cindex @code{homoglyph} face
 
 Emacs tries to determine if the curved quotes @samp{‘} and @samp{’}
 can be displayed on the current display.  By default, if this seems to
@@ -1801,7 +1801,7 @@ may wish to customize the variables
 @code{display-line-numbers-width} to a large enough value, to avoid
 occasional miscalculations of space reserved for the line numbers.
 
-@cindex line-number face
+@cindex @code{line-number} face
 The line numbers are displayed in a special face @code{line-number}.
 The current line number is displayed in a different face,
 @code{line-number-current-line}, so you can make the current line's
diff --git a/doc/emacs/files.texi b/doc/emacs/files.texi
index 3fc0dc915e..dfdcc205da 100644
--- a/doc/emacs/files.texi
+++ b/doc/emacs/files.texi
@@ -1857,7 +1857,7 @@ variable @code{tramp-mode} to @code{nil}.  You can turn off the
 feature in individual cases by quoting the file name with @samp{/:}
 (@pxref{Quoted File Names}).
 
-@cindex ange-ftp
+@cindex @code{ange-ftp}
   Remote file access through FTP is handled by the Ange-FTP package, which
 is documented in the following.  Remote file access through the other
 methods is handled by the Tramp package, which has its own manual.
diff --git a/doc/emacs/frames.texi b/doc/emacs/frames.texi
index 84e0fb2d25..af5d9cd130 100644
--- a/doc/emacs/frames.texi
+++ b/doc/emacs/frames.texi
@@ -894,7 +894,7 @@ that server's selected frame.
 
 @node Frame Parameters
 @section Frame Parameters
-@cindex default-frame-alist
+@vindex default-frame-alist
 
   You can control the default appearance and behavior of all frames by
 specifying a default list of @dfn{frame parameters} in the variable
@@ -918,7 +918,7 @@ default font to @samp{Monospace-10}:
   For a list of frame parameters and their effects, see @ref{Frame
 Parameters,,, elisp, The Emacs Lisp Reference Manual}.
 
-@cindex initial-frame-alist
+@vindex initial-frame-alist
   You can also specify a list of frame parameters which apply to just
 the initial frame, by customizing the variable
 @code{initial-frame-alist}.
@@ -992,7 +992,7 @@ end of the buffer is shown; if @code{nil}, the thumb will be at the
 bottom when the end of the buffer is shown.  You cannot over-scroll
 when the entire buffer is visible.
 
-@cindex scroll-bar face
+@cindex @code{scroll-bar} face
   The visual appearance of the scroll bars is controlled by the
 @code{scroll-bar} face.  (Some toolkits, such as GTK and MS-Windows,
 ignore this face; the scroll-bar appearance there can only be
diff --git a/doc/emacs/killing.texi b/doc/emacs/killing.texi
index 19aa9077d7..4118b752e6 100644
--- a/doc/emacs/killing.texi
+++ b/doc/emacs/killing.texi
@@ -590,7 +590,7 @@ you can access it using the following Emacs commands:
 @table @kbd
 @findex mouse-set-secondary
 @kindex M-Drag-mouse-1
-@cindex secondary-selection face
+@cindex @code{secondary-selection} face
 @item M-Drag-mouse-1
 Set the secondary selection, with one end at the place where you press
 down the button, and the other end at the place where you release it
diff --git a/doc/emacs/maintaining.texi b/doc/emacs/maintaining.texi
index 29ded9e3a3..a400b2d628 100644
--- a/doc/emacs/maintaining.texi
+++ b/doc/emacs/maintaining.texi
@@ -628,7 +628,7 @@ they use the concept of checking out individual files.
 @node Log Buffer
 @subsection Features of the Log Entry Buffer
 
-@cindex C-c C-c @r{(Log Edit mode)}
+@kindex C-c C-c @r{(Log Edit mode)}
 @findex log-edit-done
   When you tell VC to commit a change, it pops up a buffer named
 @file{*vc-log*}.  In this buffer, you should write a @dfn{log entry}
diff --git a/doc/emacs/misc.texi b/doc/emacs/misc.texi
index d8f202f684..e1b8070f43 100644
--- a/doc/emacs/misc.texi
+++ b/doc/emacs/misc.texi
@@ -409,7 +409,7 @@ is needed.  For OpenDocument and Microsoft Office documents, the
 @code{unoconv} tool is needed.}, and displaying those images.
 
 @findex doc-view-toggle-display
-@cindex doc-view-minor-mode
+@findex doc-view-minor-mode
   When you visit a document file that can be displayed with DocView
 mode, Emacs automatically uses DocView mode @footnote{The needed
 external tools for the document type must be available, and Emacs must
diff --git a/doc/emacs/msdos.texi b/doc/emacs/msdos.texi
index e49280e88d..e0a3d29f58 100644
--- a/doc/emacs/msdos.texi
+++ b/doc/emacs/msdos.texi
@@ -116,7 +116,7 @@ invoked---that will always give you an editor.  When invoked via
 the program that invoked @command{emacsclient}.
 @end enumerate
 
-@cindex emacsclient, on MS-Windows
+@cindex @command{emacsclient}, on MS-Windows
 Note that, due to limitations of MS-Windows, Emacs cannot have both
 GUI and text-mode frames in the same session.  It also cannot open
 text-mode frames on more than a single @dfn{Command Prompt} window,
diff --git a/doc/emacs/search.texi b/doc/emacs/search.texi
index 9d7ff59bee..887fd982d0 100644
--- a/doc/emacs/search.texi
+++ b/doc/emacs/search.texi
@@ -92,7 +92,7 @@ the first @samp{F} previously found.  After another @kbd{O}, the
 cursor moves to just after the first @samp{FOO}.
 
 @cindex faces for highlighting search matches
-@cindex isearch face
+@cindex @code{isearch} face
   At each step, Emacs highlights the @dfn{current match}---the buffer
 text that matches the search string---using the @code{isearch} face
 (@pxref{Faces}).  @xref{Search Customizations}, for various options
@@ -280,7 +280,7 @@ down-casing.
 @node Error in Isearch
 @subsection Errors in Incremental Search
 
-@cindex isearch-fail face
+@cindex @code{isearch-fail} face
   If your string is not found at all, the echo area says @samp{Failing
 I-Search}, and the cursor moves past the place where Emacs found as
 much of your string as it could.  Thus, if you search for @samp{FOOT},
@@ -1552,8 +1552,8 @@ replacements are not added to the command history, and cannot be
 reused.
 
 @cindex faces for highlighting query replace
-@cindex query-replace face
-@cindex lazy-highlight face, in replace
+@cindex @code{query-replace} face
+@cindex @code{lazy-highlight} face, in replace
 @vindex query-replace-highlight
 @vindex query-replace-lazy-highlight
 @vindex query-replace-show-replacement
@@ -1869,7 +1869,7 @@ setting the variable @code{search-highlight} to @code{nil}.
 
 @cindex lazy highlighting customizations
 @vindex isearch-lazy-highlight
-@cindex lazy-highlight face
+@cindex @code{lazy-highlight} face
   The other matches for the search string that are visible on display
 are highlighted using the @code{lazy-highlight} face.  Setting the
 variable @code{isearch-lazy-highlight} to @code{nil} disables this
diff --git a/doc/emacs/text.texi b/doc/emacs/text.texi
index d32bb3c768..2363fc7f11 100644
--- a/doc/emacs/text.texi
+++ b/doc/emacs/text.texi
@@ -2175,7 +2175,7 @@ text properties.
 @cindex soft newline
 @cindex newlines, hard and soft
 
-@cindex use-hard-newlines
+@findex use-hard-newlines
   In Enriched mode, Emacs distinguishes between two different kinds of
 newlines, @dfn{hard} newlines and @dfn{soft} newlines.  You can also
 enable or disable this feature in other buffers, by typing @kbd{M-x
diff --git a/doc/emacs/trouble.texi b/doc/emacs/trouble.texi
index efe26cf7bf..ea02bb8da8 100644
--- a/doc/emacs/trouble.texi
+++ b/doc/emacs/trouble.texi
@@ -1394,8 +1394,8 @@ patches) over all your contributions.
 @node Service
 @section How To Get Help with GNU Emacs
 @cindex help in using Emacs
-@cindex help-gnu-emacs mailing list
-@cindex gnu.emacs.help newsgroup
+@cindex @samp{help-gnu-emacs} mailing list
+@cindex @samp{gnu.emacs.help} newsgroup
 
 If you need help installing, using or changing GNU Emacs, there are
 two ways to find it:
diff --git a/doc/lispintro/emacs-lisp-intro.texi b/doc/lispintro/emacs-lisp-intro.texi
index 16216bb774..ec751be7e1 100644
--- a/doc/lispintro/emacs-lisp-intro.texi
+++ b/doc/lispintro/emacs-lisp-intro.texi
@@ -5882,7 +5882,7 @@ find and use again and again.
 @node New insert-buffer
 @subsection New Body for @code{insert-buffer}
 @findex insert-buffer@r{, new version body}
-@cindex new version body for insert-buffer
+@cindex new version body for @code{insert-buffer}
 
 The body in the GNU Emacs 22 version is more confusing than the original.
 
diff --git a/doc/lispref/strings.texi b/doc/lispref/strings.texi
index 5452ea6879..8a9e27d00e 100644
--- a/doc/lispref/strings.texi
+++ b/doc/lispref/strings.texi
@@ -727,7 +727,7 @@ minus sign if the argument is negative.
      @result{} "-23.5"
 @end example
 
-@cindex int-to-string
+@cindex @code{int-to-string}
 @code{int-to-string} is a semi-obsolete alias for this function.
 
 See also the function @code{format} in @ref{Formatting Strings}.
diff --git a/doc/lispref/text.texi b/doc/lispref/text.texi
index 9de270c2d8..e992c0f561 100644
--- a/doc/lispref/text.texi
+++ b/doc/lispref/text.texi
@@ -3862,7 +3862,7 @@ clicks on the link quickly without moving the mouse.  This behavior is
 controlled by the user option @code{mouse-1-click-follows-link}.
 @xref{Mouse References,,, emacs, The GNU Emacs Manual}.
 
-@cindex follow-link (text or overlay property)
+@kindex follow-link @r{(text or overlay property)}
   To set up the link so that it obeys
 @code{mouse-1-click-follows-link}, you must either (1) apply a
 @code{follow-link} text or overlay property to the link text, or (2)
diff --git a/doc/misc/cc-mode.texi b/doc/misc/cc-mode.texi
index a506213ea2..e10808954d 100644
--- a/doc/misc/cc-mode.texi
+++ b/doc/misc/cc-mode.texi
@@ -356,9 +356,9 @@ Customizing Macros
 
 @cindex BOCM
 @cindex history
-@cindex awk-mode.el
-@cindex c-mode.el
-@cindex c++-mode.el
+@cindex @file{awk-mode.el}
+@cindex @file{c-mode.el}
+@cindex @file{c++-mode.el}
 
 Welcome to @ccmode{}, a GNU Emacs mode for editing files containing C,
 C++, Objective-C, Java, CORBA IDL (and the variants CORBA PSDL and
diff --git a/doc/misc/efaq.texi b/doc/misc/efaq.texi
index 4d645ec6d4..af4cdd47f9 100644
--- a/doc/misc/efaq.texi
+++ b/doc/misc/efaq.texi
@@ -201,7 +201,7 @@ Also, on very few keyboards does @kbd{C-?} generate @acronym{ASCII} code 127.
 @section What does @file{M-x @var{command}} mean?
 @cindex Extended commands
 @cindex Commands, extended
-@cindex M-x, meaning of
+@cindex @kbd{M-x}, meaning of
 
 @kbd{M-x @var{command}} means type @kbd{M-x}, then type the name of the
 command, then type @key{RET}.  (@xref{Basic keys}, if you're not sure
diff --git a/doc/misc/eieio.texi b/doc/misc/eieio.texi
index 16c341b887..689ff72b72 100644
--- a/doc/misc/eieio.texi
+++ b/doc/misc/eieio.texi
@@ -1263,13 +1263,13 @@ The @var{parent-instance} slot indicates the instance which is
 considered the parent of the current instance.  Default is @code{nil}.
 @end deftp
 
-@cindex clone
+@cindex @code{clone}
 To use this class, inherit from it with your own class.
 To make a new instance that inherits from and existing instance of your
 class, use the @code{clone} method with additional parameters
 to specify local values.
 
-@cindex slot-unbound
+@cindex @code{slot-unbound}
 The @code{eieio-instance-inheritor} class works by causing cloned
 objects to have all slots unbound.  This class' @code{slot-unbound}
 method will cause references to unbound slots to be redirected to the
@@ -1395,7 +1395,7 @@ with a minimum of effort.
 
 @deftp {Class} eieio-speedbar buttontype buttonface
 Enables base speedbar display for a class.
-@cindex speedbar-make-tag-line
+@cindex @code{speedbar-make-tag-line}
 The slot @var{buttontype} is any of the symbols allowed by the
 function @code{speedbar-make-tag-line} for the @var{exp-button-type}
 argument @xref{Extending,,,speedbar}.
diff --git a/doc/misc/emacs-mime.texi b/doc/misc/emacs-mime.texi
index 4fbb3e5673..2c607cc97c 100644
--- a/doc/misc/emacs-mime.texi
+++ b/doc/misc/emacs-mime.texi
@@ -179,18 +179,18 @@ Emacs source code.  This item works only in the groups matching
 @code{mm-uu-emacs-sources-regexp}.
 
 @item diff
-@vindex diff
+@findex diff
 @vindex mm-uu-diff-groups-regexp
 Patches.  This is intended for groups where diffs of committed files
 are automatically sent to.  It only works in groups matching
 @code{mm-uu-diff-groups-regexp}.
 
 @item verbatim-marks
-@cindex verbatim-marks
+@findex verbatim-marks
 Slrn-style verbatim marks.
 
 @item LaTeX
-@cindex LaTeX
+@findex LaTeX
 LaTeX documents.  It only works in groups matching
 @code{mm-uu-tex-groups-regexp}.
 
@@ -1093,7 +1093,7 @@ If non-@code{nil} a format=flowed article will be displayed flowed.
 @node Interface Functions
 @chapter Interface Functions
 @cindex interface functions
-@cindex mail-parse
+@cindex @code{mail-parse}
 
 The @code{mail-parse} library is an abstraction over the actual
 low-level libraries that are described in the next chapter.
diff --git a/doc/misc/gnus.texi b/doc/misc/gnus.texi
index 17fbe0e3e3..c9bcc7f064 100644
--- a/doc/misc/gnus.texi
+++ b/doc/misc/gnus.texi
@@ -7043,7 +7043,7 @@ visible effects, but is useful if you use the @kbd{A T} command a lot
 
 The server has to support @acronym{NOV} for any of this to work.
 
-@cindex Gmane, gnus-fetch-old-headers
+@cindex Gmane, @code{gnus-fetch-old-headers}
 This feature can seriously impact performance it ignores all locally
 cached header entries.  Setting it to @code{t} for groups for a server
 that doesn't expire articles (such as news.gmane.org), leads to very
@@ -12225,7 +12225,7 @@ If non-@code{nil}, use the same article buffer for all the groups.
 article buffer.
 
 @item gnus-widen-article-window
-@cindex gnus-widen-article-window
+@vindex gnus-widen-article-window
 If non-@code{nil}, selecting the article buffer with the @kbd{h}
 command will ``widen'' the article window to take the entire frame.
 
diff --git a/doc/misc/htmlfontify.texi b/doc/misc/htmlfontify.texi
index 9f1d1b4ee3..6bc57daf62 100644
--- a/doc/misc/htmlfontify.texi
+++ b/doc/misc/htmlfontify.texi
@@ -1116,7 +1116,7 @@ Some of the (informal) data structures used in Htmlfontify are detailed here:
 @table @code
 
 @item hfy-style-assoc
-@cindex hfy-style-assoc
+@cindex @code{hfy-style-assoc}
 @anchor{hfy-style-assoc}
 
 An assoc representing/describing an Emacs face.  Properties may be repeated,
@@ -1148,7 +1148,7 @@ Some examples:
 @end lisp
 
 @item hfy-sheet-assoc
-@cindex hfy-sheet-assoc
+@cindex @code{hfy-sheet-assoc}
 @anchor{hfy-sheet-assoc}
 
 An assoc with elements of the form @samp{(face-name style-name . style-string)}.
@@ -1160,7 +1160,7 @@ The actual stylesheet for each page is derived from one of these.
 @end lisp
 
 @item hfy-facemap-assoc
-@cindex hfy-facemap-assoc
+@cindex @code{hfy-facemap-assoc}
 @anchor{hfy-facemap-assoc}
 
 An assoc of @code{(point . @var{face-symbol})} or
diff --git a/doc/misc/idlwave.texi b/doc/misc/idlwave.texi
index c37ca16b0c..e1a6eb66f5 100644
--- a/doc/misc/idlwave.texi
+++ b/doc/misc/idlwave.texi
@@ -172,7 +172,7 @@ Catalogs
 @cindex CORBA (Common Object Request Broker Architecture)
 @cindex Interface Definition Language
 @cindex Interactive Data Language
-@cindex cc-mode.el
+@cindex @file{cc-mode.el}
 @cindex @file{idl.el}
 @cindex @file{idl-shell.el}
 @cindex Feature overview
diff --git a/doc/misc/message.texi b/doc/misc/message.texi
index 1ef67fe0cb..3cfc81a7a8 100644
--- a/doc/misc/message.texi
+++ b/doc/misc/message.texi
@@ -1222,7 +1222,7 @@ according to two different standards, namely @acronym{PGP} or
 @node Passphrase caching
 @subsection Passphrase caching
 
-@cindex gpg-agent
+@cindex @command{gpg-agent}
 Message with EasyPG internally calls GnuPG (the @command{gpg} or
 @command{gpgsm} command) to perform
 data encryption, and in certain cases (decrypting or signing for
diff --git a/doc/misc/mh-e.texi b/doc/misc/mh-e.texi
index 5f0cc32cc4..a9c8bbbfb3 100644
--- a/doc/misc/mh-e.texi
+++ b/doc/misc/mh-e.texi
@@ -2101,9 +2101,9 @@ Emacs 21 and XEmacs. For more information, see
 @uref{http://quimby.gnus.org/circus/face/}.}.
 
 @cindex @command{uncompface}
-@cindex Emacs, packages, x-face
+@cindex Emacs, packages, @samp{x-face}
 @cindex Unix commands, @command{uncompface}
-@cindex x-face package
+@cindex @samp{x-face} package
 @vindex mh-show-xface
 
 Next is the traditional @samp{X-Face:} header field@footnote{The
@@ -2306,8 +2306,8 @@ System: type @kbd{M-! xterm -e mhshow @var{message-number}}. You can
 leave out the @samp{xterm -e} if you use @command{mhlist} or
 @command{mhstore}.}.
 
-@cindex Emacs, packages, mm-decode
-@cindex mm-decode package
+@cindex Emacs, packages, @samp{mm-decode}
+@cindex @samp{mm-decode} package
 @findex mh-toggle-mh-decode-mime-flag
 @kindex ; (semicolon)
 @vindex mh-decode-mime-flag
@@ -2904,8 +2904,8 @@ Another related function is the command @kbd{P F}
 faces and not. When faces are enabled, the printed message will look
 very similar to the message in the MH-Show buffer.
 
-@cindex ps-print package
-@cindex Emacs, packages, ps-print
+@cindex @samp{ps-print} package
+@cindex Emacs, packages, @samp{ps-print}
 
 MH-E uses the @samp{ps-print} package to do the printing, so you can
 customize the printing further by going to the @samp{ps-print}
@@ -4997,8 +4997,8 @@ You can also turn on the @code{mh-delete-yanked-msg-window-flag}
 option to delete the window containing the original message after
 yanking it to make more room on your screen for your reply.
 
-@cindex Emacs, packages, supercite
-@cindex supercite package
+@cindex Emacs, packages, @samp{supercite}
+@cindex @samp{supercite} package
 @kindex r
 @vindex mail-citation-hook
 @vindex mh-yank-behavior
@@ -5061,8 +5061,8 @@ and it should leave point and mark around the modified citation text
 for the next hook function. The standard prefix
 @code{mh-ins-buf-prefix} is not added if this hook is set.
 
-@cindex Emacs, packages, trivial-cite
-@cindex trivial-cite package
+@cindex Emacs, packages, @samp{trivial-cite}
+@cindex @samp{trivial-cite} package
 @vindex mh-yank-behavior
 
 For example, if you use the hook function
@@ -5499,7 +5499,7 @@ LyogWFBNICovCnN0YXRpYyBjaGFyICogc2V0aWF0aG9tZV94cG1bXSA9IHsKIjQ1IDQ1IDc2N
 @end cartouche
 @i{MH-E @sc{mime} draft ready to send}
 
-@cindex undo effects of mh-mml-to-mime
+@cindex undo effects of @code{mh-mml-to-mime}
 
 This action can be undone by running @kbd{C-_} (@code{undo}).
 
@@ -5507,7 +5507,7 @@ This action can be undone by running @kbd{C-_} (@code{undo}).
 @cindex @command{mhn}
 @cindex MH commands, @command{mhbuild}
 @cindex MH commands, @command{mhn}
-@cindex undo effects of mh-mh-to-mime
+@cindex undo effects of @code{mh-mh-to-mime}
 @findex mh-mh-to-mime
 @findex mh-mh-to-mime-undo
 @kindex C-c C-e
diff --git a/doc/misc/sem-user.texi b/doc/misc/sem-user.texi
index e82162621b..8484a7bfe2 100644
--- a/doc/misc/sem-user.texi
+++ b/doc/misc/sem-user.texi
@@ -1145,7 +1145,7 @@ Typing @kbd{RET} on a reference line jumps to that reference.
 
 @node MRU Bookmarks
 @section MRU Bookmarks mode
-@cindex semantic-mru-bookmark-mode
+@cindex @code{semantic-mru-bookmark-mode}
 
 Semantic MRU Bookmarks mode is a minor mode that keeps track of the
 tags you have edited, allowing you to quickly return to them later
@@ -1193,7 +1193,7 @@ declarations.  Other possible tag classes are @code{variable},
 
 @node Highlight Func Mode
 @section Highlight Func Mode
-@cindex semantic-highlight-func-mode
+@cindex @code{semantic-highlight-func-mode}
 
 Semantic Highlight Function minor mode highlights the declaration line
 of the current function or tag (that is to say, the first line that
@@ -1220,7 +1220,7 @@ Func mode.
 
 @node Tag Decoration Mode
 @section Tag Decoration Mode
-@cindex semantic-decoration-mode
+@cindex @code{semantic-decoration-mode}
 
 Semantic Tag Decoration mode ``decorates'' each tag based on certain
 arbitrary features of that tag.  Decorations are specified using the
diff --git a/doc/misc/ses.texi b/doc/misc/ses.texi
index 60963adcb2..4db5fda34a 100644
--- a/doc/misc/ses.texi
+++ b/doc/misc/ses.texi
@@ -1282,10 +1282,10 @@ avoid virus warnings, each function used in a formula needs
 
 @node Uses of defadvice in @acronym{SES}
 @section Uses of defadvice in @acronym{SES}
-@cindex defadvice
-@cindex undo-more
-@cindex copy-region-as-kill
-@cindex yank
+@findex defadvice
+@findex undo-more
+@findex copy-region-as-kill
+@findex yank
 
 @table @code
 @item undo-more
diff --git a/doc/misc/vhdl-mode.texi b/doc/misc/vhdl-mode.texi
index e94fba6fc6..c061fb8e43 100644
--- a/doc/misc/vhdl-mode.texi
+++ b/doc/misc/vhdl-mode.texi
@@ -322,7 +322,7 @@ the minibuffer when you hit @kbd{TAB}.
 @chapter  Customizing Indentation
 @cindex   Customizing Indentation
 
-@cindex vhdl-set-offset
+@cindex @code{vhdl-set-offset}
 @cindex set-offset (vhdl-)
 The @code{vhdl-offsets-alist} variable is where you customize all your
 indentations.  You simply need to decide what additional offset you want
@@ -334,7 +334,7 @@ pre-defined styles will suit your needs, but if not, this section will
 describe how to set up basic editing configurations.  @xref{Styles}, for
 an explanation of how to set up named styles.
 
-@cindex vhdl-basic-offset
+@cindex @code{vhdl-basic-offset}
 @cindex basic-offset (vhdl-)
 As mentioned previously, the variable @code{vhdl-offsets-alist} is an
 association list between syntactic symbols and the offsets to be applied
-- 
2.21.0


From 75119827037a390a6065341e903f19f7946f206e Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Sun, 25 Feb 2018 16:29:39 +0100
Subject: [PATCH 031/297] Fix @kindex entries in manuals

* doc/emacs/basic.texi:
* doc/emacs/buffers.texi:
* doc/emacs/building.texi:
* doc/emacs/calendar.texi:
* doc/emacs/custom.texi:
* doc/emacs/dired.texi:
* doc/emacs/display.texi:
* doc/emacs/files.texi:
* doc/emacs/frames.texi:
* doc/emacs/help.texi:
* doc/emacs/indent.texi:
* doc/emacs/killing.texi:
* doc/emacs/kmacro.texi:
* doc/emacs/mark.texi:
* doc/emacs/mini.texi:
* doc/emacs/misc.texi:
* doc/emacs/modes.texi:
* doc/emacs/msdos-xtra.texi:
* doc/emacs/msdos.texi:
* doc/emacs/mule.texi:
* doc/emacs/picture-xtra.texi:
* doc/emacs/programs.texi:
* doc/emacs/regs.texi:
* doc/emacs/rmail.texi:
* doc/emacs/screen.texi:
* doc/emacs/search.texi:
* doc/emacs/sending.texi:
* doc/emacs/text.texi:
* doc/emacs/trouble.texi:
* doc/lispref/files.texi:
* doc/misc/calc.texi:
* doc/misc/cc-mode.texi:
* doc/misc/ediff.texi:
* doc/misc/epa.texi:
* doc/misc/ert.texi:
* doc/misc/eww.texi:
* doc/misc/forms.texi:
* doc/misc/gnus.texi:
* doc/misc/info.texi:
* doc/misc/mairix-el.texi:
* doc/misc/message.texi:
* doc/misc/mh-e.texi:
* doc/misc/newsticker.texi:
* doc/misc/org.texi:
* doc/misc/pcl-cvs.texi:
* doc/misc/rcirc.texi:
* doc/misc/sc.texi:
* doc/misc/sieve.texi:
* doc/misc/vhdl-mode.texi:
* doc/misc/vip.texi:
* doc/misc/viper.texi:
* doc/misc/woman.texi: Fix @kindex entries.  Mark keys consistently.
---
 doc/emacs/basic.texi        |   24 +-
 doc/emacs/buffers.texi      |   10 +-
 doc/emacs/building.texi     |    8 +-
 doc/emacs/calendar.texi     |    2 +-
 doc/emacs/custom.texi       |    6 +-
 doc/emacs/dired.texi        |   10 +-
 doc/emacs/display.texi      |   12 +-
 doc/emacs/files.texi        |    2 +-
 doc/emacs/frames.texi       |    8 +-
 doc/emacs/help.texi         |    9 +-
 doc/emacs/indent.texi       |    4 +-
 doc/emacs/killing.texi      |    2 +-
 doc/emacs/kmacro.texi       |    8 +-
 doc/emacs/mark.texi         |   10 +-
 doc/emacs/mini.texi         |   14 +-
 doc/emacs/misc.texi         |   20 +-
 doc/emacs/modes.texi        |    6 +-
 doc/emacs/msdos.texi        |    6 +-
 doc/emacs/mule.texi         |   26 +-
 doc/emacs/picture-xtra.texi |    4 +-
 doc/emacs/programs.texi     |   28 +-
 doc/emacs/regs.texi         |    2 +-
 doc/emacs/rmail.texi        |    6 +-
 doc/emacs/screen.texi       |    2 +-
 doc/emacs/search.texi       |   14 +-
 doc/emacs/sending.texi      |    2 +-
 doc/emacs/text.texi         |   46 +-
 doc/emacs/trouble.texi      |    2 +-
 doc/lispref/files.texi      |    4 +-
 doc/misc/calc.texi          |   28 +-
 doc/misc/cc-mode.texi       |   36 +-
 doc/misc/ediff.texi         |    8 +-
 doc/misc/epa.texi           |   24 +-
 doc/misc/ert.texi           |   14 +-
 doc/misc/eww.texi           |    4 +-
 doc/misc/forms.texi         |   24 +-
 doc/misc/gnus.texi          | 1547 +++++++++++++++++------------------
 doc/misc/info.texi          |   10 +-
 doc/misc/mairix-el.texi     |   10 -
 doc/misc/message.texi       |   14 +-
 doc/misc/mh-e.texi          |   44 +-
 doc/misc/newsticker.texi    |   16 +-
 doc/misc/org.texi           |  223 +++--
 doc/misc/pcl-cvs.texi       |    6 +-
 doc/misc/rcirc.texi         |   10 +-
 doc/misc/sc.texi            |    2 +-
 doc/misc/sieve.texi         |    4 +-
 doc/misc/vhdl-mode.texi     |   12 +-
 doc/misc/vip.texi           |  438 +++++-----
 doc/misc/viper.texi         |  432 +++++-----
 doc/misc/woman.texi         |    8 +-
 51 files changed, 1581 insertions(+), 1630 deletions(-)

diff --git a/doc/emacs/basic.texi b/doc/emacs/basic.texi
index aa91f0555e..cc689af6d2 100644
--- a/doc/emacs/basic.texi
+++ b/doc/emacs/basic.texi
@@ -40,7 +40,7 @@ adds the character to the buffer at point.  Insertion moves point
 forward, so that point remains just after the inserted text.
 @xref{Point}.
 
-@kindex RET
+@kindex @key{RET}
 @kindex C-j
 @cindex newline
 @c @findex electric-indent-just-newline
@@ -182,7 +182,7 @@ keyboard commands that move point in more sophisticated ways.
 Move forward one character (@code{forward-char}).
 
 @item @key{RIGHT}
-@kindex RIGHT
+@kindex @key{RIGHT}
 @findex right-char
 This command (@code{right-char}) behaves like @kbd{C-f}, except when
 point is in a right-to-left paragraph (@pxref{Bidirectional Editing}).
@@ -193,7 +193,7 @@ point is in a right-to-left paragraph (@pxref{Bidirectional Editing}).
 Move backward one character (@code{backward-char}).
 
 @item @key{LEFT}
-@kindex LEFT
+@kindex @key{LEFT}
 @findex left-char
 This command (@code{left-char}) behaves like @kbd{C-b}, except if the
 current paragraph is right-to-left (@pxref{Bidirectional Editing}).
@@ -201,7 +201,7 @@ current paragraph is right-to-left (@pxref{Bidirectional Editing}).
 @item C-n
 @itemx @key{DOWN}
 @kindex C-n
-@kindex DOWN
+@kindex @key{DOWN}
 @findex next-line
 Move down one screen line (@code{next-line}).  This command attempts
 to keep the horizontal position unchanged, so if you start in the
@@ -210,7 +210,7 @@ middle of one line, you move to the middle of the next.
 @item C-p
 @itemx @key{UP}
 @kindex C-p
-@kindex UP
+@kindex @key{UP}
 @findex previous-line
 Move up one screen line (@code{previous-line}).  This command
 preserves position within the line, like @kbd{C-n}.
@@ -218,14 +218,14 @@ preserves position within the line, like @kbd{C-n}.
 @item C-a
 @itemx @key{Home}
 @kindex C-a
-@kindex HOME key
+@kindex @key{HOME}
 @findex move-beginning-of-line
 Move to the beginning of the line (@code{move-beginning-of-line}).
 
 @item C-e
 @itemx @key{End}
 @kindex C-e
-@kindex END key
+@kindex @key{END}
 @findex move-end-of-line
 Move to the end of the line (@code{move-end-of-line}).
 
@@ -234,8 +234,8 @@ Move forward one word (@code{forward-word}).  @xref{Words}.
 
 @item C-@key{RIGHT}
 @itemx M-@key{RIGHT}
-@kindex C-RIGHT
-@kindex M-RIGHT
+@kindex C-@key{RIGHT}
+@kindex M-@key{RIGHT}
 @findex right-word
 This command (@code{right-word}) behaves like @kbd{M-f}, except it
 moves @emph{backward} by one word if the current paragraph is
@@ -246,8 +246,8 @@ Move backward one word (@code{backward-word}).  @xref{Words}.
 
 @item C-@key{LEFT}
 @itemx M-@key{LEFT}
-@kindex C-LEFT
-@kindex M-LEFT
+@kindex C-@key{LEFT}
+@kindex M-@key{LEFT}
 @findex left-word
 This command (@code{left-word}) behaves like @kbd{M-b}, except it
 moves @emph{forward} by one word if the current paragraph is
@@ -314,7 +314,7 @@ also specify @var{n} by giving @kbd{M-g M-g} a numeric prefix argument.
 a plain prefix argument.
 
 @item M-g @key{TAB}
-@kindex M-g TAB
+@kindex M-g @key{TAB}
 @findex move-to-column
 Read a number @var{n} and move to column @var{n} in the current line.
 Column 0 is the leftmost column.  If called with a prefix argument,
diff --git a/doc/emacs/buffers.texi b/doc/emacs/buffers.texi
index f8c1856058..2f0bb9740d 100644
--- a/doc/emacs/buffers.texi
+++ b/doc/emacs/buffers.texi
@@ -111,8 +111,8 @@ it, Emacs asks for the file name to use, and the buffer's major mode
 is re-established taking that file name into account (@pxref{Choosing
 Modes}).
 
-@kindex C-x LEFT
-@kindex C-x RIGHT
+@kindex C-x @key{LEFT}
+@kindex C-x @key{RIGHT}
 @findex next-buffer
 @findex previous-buffer
   For conveniently switching between a few buffers, use the commands
@@ -419,13 +419,13 @@ removing the flags.
 
 @item @key{DEL}
 @findex Buffer-menu-backup-unmark
-@kindex DEL @r{(Buffer Menu)}
+@kindex @key{DEL} @r{(Buffer Menu)}
 Move to the previous line and remove all flags on that line
 (@code{Buffer-menu-backup-unmark}).
 
 @item M-@key{DEL}
 @findex Buffer-menu-unmark-all-buffers
-@kindex M-DEL @r{(Buffer Menu)}
+@kindex M-@key{DEL} @r{(Buffer Menu)}
 Remove a particular flag from all lines
 (@code{Buffer-menu-unmark-all-buffers}).  This asks for a single
 character, and unmarks buffers marked with that character; typing
@@ -479,7 +479,7 @@ visible buffer is displayed in its place.
 @itemx f
 @findex Buffer-menu-this-window
 @kindex f @r{(Buffer Menu)}
-@kindex RET @r{(Buffer Menu)}
+@kindex @key{RET} @r{(Buffer Menu)}
 Select this line's buffer, replacing the @file{*Buffer List*} buffer
 in its window (@code{Buffer-menu-this-window}).
 
diff --git a/doc/emacs/building.texi b/doc/emacs/building.texi
index d79efd089f..92e1a59ed0 100644
--- a/doc/emacs/building.texi
+++ b/doc/emacs/building.texi
@@ -770,7 +770,7 @@ be bizarre.  See the GDB manual entry regarding @code{jump} for
 details.
 
 @item @key{TAB}
-@kindex TAB @r{(GUD)}
+@kindex @key{TAB} @r{(GUD)}
 @findex gud-gdb-complete-command
 With GDB, complete a symbol name (@code{gud-gdb-complete-command}).
 This key is available only in the GUD interaction buffer.
@@ -1000,7 +1000,7 @@ to the @dfn{current breakpoint} (the breakpoint which point is on):
 
 @table @kbd
 @item @key{SPC}
-@kindex SPC @r{(GDB Breakpoints buffer)}
+@kindex @key{SPC} @r{(GDB Breakpoints buffer)}
 @findex gdb-toggle-breakpoint
 Enable/disable current breakpoint (@code{gdb-toggle-breakpoint}).  On
 a graphical display, this changes the color of the dot in the fringe
@@ -1013,7 +1013,7 @@ is enabled, and gray when it is disabled.
 Delete the current breakpoint (@code{gdb-delete-breakpoint}).
 
 @item @key{RET}
-@kindex RET @r{(GDB Breakpoints buffer)}
+@kindex @key{RET} @r{(GDB Breakpoints buffer)}
 @findex gdb-goto-breakpoint
 Visit the source line for the current breakpoint
 (@code{gdb-goto-breakpoint}).
@@ -1206,7 +1206,7 @@ immediate children exceeds the value of the variable
   To delete a complex watch expression, move point to the root
 expression in the speedbar and type @kbd{D} (@code{gdb-var-delete}).
 
-@kindex RET @r{(GDB speedbar)}
+@kindex @key{RET} @r{(GDB speedbar)}
 @findex gdb-edit-value
   To edit a variable with a simple data type, or a simple element of a
 complex data type, move point there in the speedbar and type @key{RET}
diff --git a/doc/emacs/calendar.texi b/doc/emacs/calendar.texi
index c6a84b5ab1..98089fd20f 100644
--- a/doc/emacs/calendar.texi
+++ b/doc/emacs/calendar.texi
@@ -328,7 +328,7 @@ date.
 (@code{calendar-redraw}) to redraw it.  (This can only happen if you use
 non-Calendar-mode editing commands.)
 
-@kindex SPC @r{(Calendar mode)}
+@kindex @key{SPC} @r{(Calendar mode)}
   In Calendar mode, you can use @key{SPC} (@code{scroll-other-window})
 and @key{DEL} (@code{scroll-other-window-down}) to scroll the other
 window (if there is one) up or down, respectively.  This is handy when
diff --git a/doc/emacs/custom.texi b/doc/emacs/custom.texi
index a9f261b307..cdcdb6a29c 100644
--- a/doc/emacs/custom.texi
+++ b/doc/emacs/custom.texi
@@ -123,8 +123,8 @@ or moving point there and typing @kbd{@key{RET}}.  For example, the group
 names like @samp{[Editing]} are links; activating one of these links
 brings up the customization buffer for that group.
 
-@kindex TAB @r{(customization buffer)}
-@kindex S-TAB @r{(customization buffer)}
+@kindex @key{TAB} @r{(customization buffer)}
+@kindex @key{S-TAB} @r{(customization buffer)}
 @findex widget-forward
 @findex widget-backward
   In the customization buffer, you can type @kbd{@key{TAB}}
@@ -243,7 +243,7 @@ You don't have to worry about specifying a value that is not valid;
 the @samp{Set for Current Session} operation checks for validity and
 will not install an unacceptable value.
 
-@kindex M-TAB @r{(customization buffer)}
+@kindex M-@key{TAB} @r{(customization buffer)}
 @kindex C-M-i @r{(customization buffer)}
 @findex widget-complete
   While editing certain kinds of values, such as file names, directory
diff --git a/doc/emacs/dired.texi b/doc/emacs/dired.texi
index 14d5243387..28558b2834 100644
--- a/doc/emacs/dired.texi
+++ b/doc/emacs/dired.texi
@@ -136,7 +136,7 @@ buffers.  The keys @kbd{C-n} and @kbd{C-p} are redefined to put the
 cursor at the beginning of the file name on the line, rather than at
 the beginning of the line.
 
-@kindex SPC @r{(Dired)}
+@kindex @key{SPC} @r{(Dired)}
   For extra convenience, @key{SPC} and @kbd{n} in Dired are equivalent
 to @kbd{C-n}.  @kbd{p} is equivalent to @kbd{C-p}.  (Moving by lines
 is so common in Dired that it deserves to be easy to type.)  @key{DEL}
@@ -204,7 +204,7 @@ region for deletion; in this case, the command does not move point,
 and ignores any prefix argument.
 
 @kindex u @r{(Dired deletion)}
-@kindex DEL @r{(Dired)}
+@kindex @key{DEL} @r{(Dired)}
   The reason for flagging files for deletion, rather than deleting
 files immediately, is to reduce the danger of deleting a file
 accidentally.  Until you direct Dired to delete the flagged files, you
@@ -348,7 +348,7 @@ and supplying that file name (@code{dired-find-file}).  @xref{Visiting}.
 
 @item @key{RET}
 @itemx e
-@kindex RET @r{(Dired)}
+@kindex @key{RET} @r{(Dired)}
 @kindex e @r{(Dired)}
 Equivalent to @kbd{f}.
 
@@ -464,7 +464,7 @@ unmark the previous @minus{}@var{n} files).
 
 @item @key{DEL}
 @itemx * @key{DEL}
-@kindex * DEL @r{(Dired)}
+@kindex * @key{DEL} @r{(Dired)}
 @findex dired-unmark-backward
 @cindex unmarking files (in Dired)
 Move point to previous line and remove any mark on that line
@@ -485,7 +485,7 @@ Remove all marks from all the files in this Dired buffer
 @item * ? @var{markchar}
 @itemx M-@key{DEL}
 @kindex * ? @r{(Dired)}
-@kindex M-DEL @r{(Dired)}
+@kindex M-@key{DEL} @r{(Dired)}
 @findex dired-unmark-all-files
 Remove all marks that use the character @var{markchar}
 (@code{dired-unmark-all-files}).  If invoked with @kbd{M-@key{DEL}},
diff --git a/doc/emacs/display.texi b/doc/emacs/display.texi
index 42b07cc0fe..e86c3e8fc9 100644
--- a/doc/emacs/display.texi
+++ b/doc/emacs/display.texi
@@ -79,10 +79,10 @@ Scroll backward (@code{scroll-down-command}).
 
 @kindex C-v
 @kindex M-v
-@kindex next
-@kindex prior
-@kindex PageDown
-@kindex PageUp
+@kindex @key{next}
+@kindex @key{prior}
+@kindex @key{PageDown}
+@kindex @key{PageUp}
 @findex scroll-up-command
 @findex scroll-down-command
   @kbd{C-v} (@code{scroll-up-command}) scrolls forward by nearly the
@@ -447,8 +447,8 @@ it.  @xref{Disabling}.
 @cindex mode, View
 
 @kindex s @r{(View mode)}
-@kindex SPC @r{(View mode)}
-@kindex DEL @r{(View mode)}
+@kindex @key{SPC} @r{(View mode)}
+@kindex @key{DEL} @r{(View mode)}
   View mode is a minor mode that lets you scan a buffer by sequential
 screenfuls.  It provides commands for scrolling through the buffer
 conveniently but not for changing it.  Apart from the usual Emacs
diff --git a/doc/emacs/files.texi b/doc/emacs/files.texi
index dfdcc205da..bcebc4bd4e 100644
--- a/doc/emacs/files.texi
+++ b/doc/emacs/files.texi
@@ -1957,7 +1957,7 @@ then specifying @file{/tmp/foo*bar} will visit only
 @cindex file name caching
 @cindex cache of file names
 @pindex find
-@kindex C-TAB
+@kindex C-@key{TAB}
 @findex file-cache-minibuffer-complete
   You can use the @dfn{file name cache} to make it easy to locate a
 file by name, without having to remember exactly where it is located.
diff --git a/doc/emacs/frames.texi b/doc/emacs/frames.texi
index af5d9cd130..0992503142 100644
--- a/doc/emacs/frames.texi
+++ b/doc/emacs/frames.texi
@@ -472,14 +472,14 @@ cycles through all the frames on your terminal.
 @findex delete-other-frames
 Delete all frames on the current terminal, except the selected one.
 
-@item M-<F10>
-@kindex M-<F10>
+@item M-@key{F10}
+@kindex M-@key{F10}
 @findex toggle-frame-maximized
 Toggle the maximization state of the current frame.  When a frame is
 maximized, it fills the screen.
 
-@item <F11>
-@kindex <F11>
+@item @key{F11>}
+@kindex @key{F11}
 @findex toggle-frame-fullscreen
 Toggle full-screen mode for the current frame.  (The difference
 between full-screen and maximized is normally that the former
diff --git a/doc/emacs/help.texi b/doc/emacs/help.texi
index e005fe358d..4abd267276 100644
--- a/doc/emacs/help.texi
+++ b/doc/emacs/help.texi
@@ -4,12 +4,11 @@
 @c See file emacs.texi for copying conditions.
 @node Help
 @chapter Help
-@kindex Help
 @cindex help
 @cindex self-documentation
 @findex help-command
 @kindex C-h
-@kindex F1
+@kindex @key{F1}
 
 @kindex C-h C-h
 @findex help-for-help
@@ -432,7 +431,7 @@ Go back to the previous help topic (@code{help-go-back}).
 @findex help-follow
 @findex help-go-back
 @findex help-go-forward
-@kindex RET @r{(Help mode)}
+@kindex @key{RET} @r{(Help mode)}
 @kindex C-c C-b @r{(Help mode)}
 @kindex l @r{(Help mode)}
 @kindex C-c C-f @r{(Help mode)}
@@ -456,9 +455,9 @@ code definitions, and URLs (web pages).  The first two are opened in
 Emacs, and the third using a web browser via the @code{browse-url}
 command (@pxref{Browse-URL}).
 
-@kindex TAB @r{(Help mode)}
+@kindex @key{TAB} @r{(Help mode)}
 @findex forward-button
-@kindex S-TAB @r{(Help mode)}
+@kindex S-@key{TAB} @r{(Help mode)}
 @findex backward-button
   In a help buffer, @key{TAB} (@code{forward-button}) moves point
 forward to the next hyperlink, while @kbd{S-@key{TAB}}
diff --git a/doc/emacs/indent.texi b/doc/emacs/indent.texi
index b38e85819c..eae334449c 100644
--- a/doc/emacs/indent.texi
+++ b/doc/emacs/indent.texi
@@ -17,7 +17,7 @@ programming language modes.  @xref{Program Indent}, for additional
 documentation about indenting in programming modes.
 
 @findex indent-for-tab-command
-@kindex TAB @r{(indentation)}
+@kindex @key{TAB} @r{(indentation)}
   The simplest way to perform indentation is the @key{TAB} key.  In
 most major modes, this runs the command @code{indent-for-tab-command}.
 (In C and related modes, @key{TAB} runs the command
@@ -120,7 +120,7 @@ If a numeric argument is supplied, indent every line in the region to
 that column number.
 
 @item C-x @key{TAB}
-@kindex C-x TAB
+@kindex C-x @key{TAB}
 @findex indent-rigidly
 @cindex remove indentation
 This command is used to change the indentation of all lines that begin
diff --git a/doc/emacs/killing.texi b/doc/emacs/killing.texi
index 4118b752e6..7b89dce4e6 100644
--- a/doc/emacs/killing.texi
+++ b/doc/emacs/killing.texi
@@ -111,7 +111,7 @@ active (@pxref{Using Region}).
 
 @kindex M-\
 @findex delete-horizontal-space
-@kindex M-SPC
+@kindex M-@key{SPC}
 @findex just-one-space
 @findex cycle-spacing
   The other delete commands are those that delete only whitespace
diff --git a/doc/emacs/kmacro.texi b/doc/emacs/kmacro.texi
index 7e28d1d920..844ca8e9b6 100644
--- a/doc/emacs/kmacro.texi
+++ b/doc/emacs/kmacro.texi
@@ -64,8 +64,8 @@ Run the last keyboard macro on each line that begins in the region
 (@code{apply-macro-to-region-lines}).
 @end table
 
-@kindex F3
-@kindex F4
+@kindex @key{F3}
+@kindex @key{F4}
 @findex kmacro-start-macro-or-insert-counter
 @findex kmacro-end-or-call-macro
 @findex kmacro-end-and-call-macro
@@ -481,7 +481,7 @@ Edit the last 300 keystrokes as a keyboard macro
 
 @findex kmacro-edit-macro
 @kindex C-x C-k C-e
-@kindex C-x C-k RET
+@kindex C-x C-k @key{RET}
   You can edit the last keyboard macro by typing @kbd{C-x C-k C-e} or
 @kbd{C-x C-k @key{RET}} (@code{kmacro-edit-macro}).  This formats the
 macro definition in a buffer and enters a specialized major mode for
@@ -505,7 +505,7 @@ keyboard input that you would use to invoke the macro---@kbd{C-x e} or
 @section Stepwise Editing a Keyboard Macro
 
 @findex kmacro-step-edit-macro
-@kindex C-x C-k SPC
+@kindex C-x C-k @key{SPC}
   You can interactively replay and edit the last keyboard
 macro, one command at a time, by typing @kbd{C-x C-k @key{SPC}}
 (@code{kmacro-step-edit-macro}).  Unless you quit the macro using
diff --git a/doc/emacs/mark.texi b/doc/emacs/mark.texi
index 0ffa9f74ac..20cc67a1e7 100644
--- a/doc/emacs/mark.texi
+++ b/doc/emacs/mark.texi
@@ -79,7 +79,7 @@ Set the mark at point if the mark is inactive, then move point.
 @xref{Shift Selection}.
 @end table
 
-@kindex C-SPC
+@kindex C-@key{SPC}
 @kindex C-@@
 @findex set-mark-command
   The most common way to set the mark is with @kbd{C-@key{SPC}}
@@ -309,7 +309,7 @@ Move point to where the mark was, and restore the mark from the ring
 of former marks.
 @end table
 
-@kindex C-SPC C-SPC
+@kindex C-@key{SPC} C-@key{SPC}
   The command @kbd{C-@key{SPC} C-@key{SPC}} is handy when you want to
 use the mark to remember a position to which you may wish to return.
 It pushes the current point onto the mark ring, without activating the
@@ -320,7 +320,7 @@ and the second @kbd{C-@key{SPC}} deactivates it.  (When Transient Mark
 mode is off, @kbd{C-@key{SPC} C-@key{SPC}} instead activates Transient
 Mark mode temporarily; @pxref{Disabled Transient Mark}.)
 
-@kindex C-u C-SPC
+@kindex C-u C-@key{SPC}
   To return to a marked position, use @code{set-mark-command} with a
 prefix argument: @kbd{C-u C-@key{SPC}}.  This moves point to where the
 mark was, and deactivates the mark if it was active.  Each subsequent
@@ -365,7 +365,7 @@ of buffers that you have been in, and, for each buffer, a place where
 you set the mark.  The length of the global mark ring is controlled by
 @code{global-mark-ring-max}, and is 16 by default.
 
-@kindex C-x C-SPC
+@kindex C-x C-@key{SPC}
 @findex pop-global-mark
   The command @kbd{C-x C-@key{SPC}} (@code{pop-global-mark}) jumps to
 the buffer and position of the latest entry in the global ring.  It also
@@ -447,7 +447,7 @@ using @kbd{C-@key{SPC} C-@key{SPC}} or @kbd{C-u C-x C-x}.
 
 @table @kbd
 @item C-@key{SPC} C-@key{SPC}
-@kindex C-SPC C-SPC@r{, disabling Transient Mark}
+@kindex C-@key{SPC} C-@key{SPC}@r{, disabling Transient Mark}
 Set the mark at point (like plain @kbd{C-@key{SPC}}) and enable
 Transient Mark mode just once, until the mark is deactivated.  (This
 is not really a separate command; you are using the @kbd{C-@key{SPC}}
diff --git a/doc/emacs/mini.texi b/doc/emacs/mini.texi
index 8278de7f31..ec979dc707 100644
--- a/doc/emacs/mini.texi
+++ b/doc/emacs/mini.texi
@@ -259,7 +259,7 @@ Completion}.
 @node Completion Example
 @subsection Completion Example
 
-@kindex TAB @r{(completion example)}
+@kindex @key{TAB} @r{(completion example)}
   A simple example may help here.  @kbd{M-x} uses the minibuffer to
 read the name of a command, so completion works by matching the
 minibuffer text against the names of existing Emacs commands.  Suppose
@@ -311,7 +311,7 @@ first (@code{minibuffer-complete-and-exit}).  @xref{Completion Exit}.
 Display a list of completions (@code{minibuffer-completion-help}).
 @end table
 
-@kindex TAB @r{(completion)}
+@kindex @key{TAB} @r{(completion)}
 @findex minibuffer-complete
   @key{TAB} (@code{minibuffer-complete}) is the most fundamental
 completion command.  It searches for all possible completions that
@@ -319,7 +319,7 @@ match the existing minibuffer text, and attempts to complete as much
 as it can.  @xref{Completion Styles}, for how completion alternatives
 are chosen.
 
-@kindex SPC @r{(completion)}
+@kindex @key{SPC} @r{(completion)}
 @findex minibuffer-complete-word
   @key{SPC} (@code{minibuffer-complete-word}) completes like
 @key{TAB}, but only up to the next hyphen or space.  If you have
@@ -372,7 +372,7 @@ completion alternative (@code{previous-completion}).
 @node Completion Exit
 @subsection Completion Exit
 
-@kindex RET @r{(completion in minibuffer)}
+@kindex @key{RET} @r{(completion in minibuffer)}
 @findex minibuffer-complete-and-exit
   When a command reads an argument using the minibuffer with
 completion, it also controls what happens when you type @key{RET}
@@ -648,8 +648,8 @@ directory.
 
 @findex previous-line-or-history-element
 @findex next-line-or-history-element
-@kindex UP @r{(minibuffer history)}
-@kindex DOWN @r{(minibuffer history)}
+@kindex @key{UP} @r{(minibuffer history)}
+@kindex @key{DOWN} @r{(minibuffer history)}
   The arrow keys @kbd{@key{UP}} and @kbd{@key{DOWN}} work like
 @kbd{M-p} and @kbd{M-n}, but if the current history item is longer
 than a single line, they allow you to move to the previous or next
@@ -720,7 +720,7 @@ Display the entire command history, showing all the commands
 @kbd{C-x @key{ESC} @key{ESC}} can repeat, most recent first.
 @end table
 
-@kindex C-x ESC ESC
+@kindex C-x @key{ESC} @key{ESC}
 @findex repeat-complex-command
   @kbd{C-x @key{ESC} @key{ESC}} re-executes a recent command that used
 the minibuffer.  With no argument, it repeats the last such command.
diff --git a/doc/emacs/misc.texi b/doc/emacs/misc.texi
index e1b8070f43..7f2a0a1107 100644
--- a/doc/emacs/misc.texi
+++ b/doc/emacs/misc.texi
@@ -129,7 +129,7 @@ sessions.
   The following commands are available in the Gnus group buffer:
 
 @table @kbd
-@kindex SPC @r{(Gnus Group mode)}
+@kindex @key{SPC} @r{(Gnus Group mode)}
 @findex gnus-group-read-group
 @item @key{SPC}
 Switch to the summary buffer for the group on the current line.
@@ -177,7 +177,7 @@ Kill the group on the current line.  Killed groups are not recorded in
 the @file{.newsrc} file, and they are not shown in the @kbd{l} or
 @kbd{L} listings.
 
-@kindex DEL @r{(Gnus Group mode)}
+@kindex @key{DEL} @r{(Gnus Group mode)}
 @item @key{DEL}
 Move point to the previous group containing unread articles.
 
@@ -203,7 +203,7 @@ Update your Gnus settings, and quit Gnus.
   The following commands are available in the Gnus summary buffer:
 
 @table @kbd
-@kindex SPC @r{(Gnus Summary mode)}
+@kindex @key{SPC} @r{(Gnus Summary mode)}
 @findex gnus-summary-next-page
 @item @key{SPC}
 If there is no article selected, select the article on the current
@@ -214,7 +214,7 @@ buffer, select the next unread article.
 Thus, you can read through all articles by repeatedly typing
 @key{SPC}.
 
-@kindex DEL @r{(Gnus Summary mode)}
+@kindex @key{DEL} @r{(Gnus Summary mode)}
 @findex gnus-summary-prev-page
 @item @key{DEL}
 Scroll the text of the article backwards.
@@ -481,8 +481,8 @@ page, type @kbd{p}, @key{prior} or @kbd{C-x [}
 
 @findex doc-view-scroll-up-or-next-page
 @findex doc-view-scroll-down-or-previous-page
-@kindex SPC @r{(DocView mode)}
-@kindex DEL @r{(DocView mode)}
+@kindex @key{SPC} @r{(DocView mode)}
+@kindex @key{DEL} @r{(DocView mode)}
   @key{SPC} (@code{doc-view-scroll-up-or-next-page}) is a convenient
 way to advance through the document.  It scrolls within the current
 page or advances to the next.  @key{DEL} moves backwards in a similar
@@ -826,7 +826,7 @@ commands:
 
 @table @kbd
 @item @key{RET}
-@kindex RET @r{(Shell mode)}
+@kindex @key{RET} @r{(Shell mode)}
 @findex comint-send-input
 Send the current line as input to the subshell
 (@code{comint-send-input}).  Any shell prompt at the beginning of the
@@ -836,7 +836,7 @@ interactive shell.  However, you can also invoke @key{RET} elsewhere
 in the shell buffer to submit the current line as input.
 
 @item @key{TAB}
-@kindex TAB @r{(Shell mode)}
+@kindex @key{TAB} @r{(Shell mode)}
 @findex completion-at-point@r{, in Shell Mode}
 @cindex shell completion
 Complete the command name or file name before point in the shell
@@ -1182,7 +1182,7 @@ Move point to the previous prompt (@code{comint-previous-prompt}).
 @item C-c C-n
 Move point to the following prompt (@code{comint-next-prompt}).
 
-@kindex C-c RET @r{(Shell mode)}
+@kindex C-c @key{RET} @r{(Shell mode)}
 @findex comint-copy-old-input
 @item C-c @key{RET}
 Copy the input command at point, inserting the copy at the end of the
@@ -2796,7 +2796,7 @@ the package commentary by typing @kbd{C-h P browse-url @key{RET}}.
 Activate URLs and e-mail addresses in the current buffer.
 @end table
 
-@kindex C-c RET @r{(Goto Address mode)}
+@kindex C-c @key{RET} @r{(Goto Address mode)}
 @findex goto-address-at-point
   You can make Emacs mark out URLs specially in the current buffer, by
 typing @kbd{M-x goto-address-mode}.  When this buffer-local minor mode
diff --git a/doc/emacs/modes.texi b/doc/emacs/modes.texi
index 2bbc17b26d..fd8f0110a3 100644
--- a/doc/emacs/modes.texi
+++ b/doc/emacs/modes.texi
@@ -33,8 +33,8 @@ one another, and of the selected major mode.
 @section Major Modes
 @cindex major modes
 @cindex mode, major
-@kindex TAB @r{(and major modes)}
-@kindex DEL @r{(and major modes)}
+@kindex @key{TAB} @r{(and major modes)}
+@kindex @key{DEL} @r{(and major modes)}
 @kindex C-j @r{(and major modes)}
 
   Every buffer possesses a major mode, which determines the editing
@@ -236,7 +236,7 @@ called Outline mode.  @xref{Outline Mode}.
 @cindex Overwrite mode
 @cindex mode, Overwrite
 @findex overwrite-mode
-@kindex INSERT
+@kindex @key{INSERT}
 @item
 Overwrite mode causes ordinary printing characters to replace existing
 text instead of shoving it to the right.  For example, if point is in
diff --git a/doc/emacs/msdos.texi b/doc/emacs/msdos.texi
index e0a3d29f58..ee132cdc0f 100644
--- a/doc/emacs/msdos.texi
+++ b/doc/emacs/msdos.texi
@@ -565,7 +565,7 @@ modifier with the trailing dash but with no key indicates that all
 Windows defined hotkeys for that modifier are to be overridden in the
 favor of Emacs.
 
-@kindex M-TAB@r{, (MS-Windows)}
+@kindex M-@key{TAB}@r{, (MS-Windows)}
 @cindex @kbd{M-@key{TAB}} vs @kbd{@key{Alt}-@key{TAB}} (MS-Windows)
 @cindex @kbd{@key{Alt}-@key{TAB}} vs @kbd{M-@key{TAB}} (MS-Windows)
   For example, @code{(w32-register-hot-key [M-tab])} lets you use
@@ -679,8 +679,8 @@ its normal effect: for example, @kbd{@key{Lwindow}} opens the
 @code{Start} menu, etc.
 
 @vindex w32-recognize-altgr
-@kindex AltGr @r{(MS-Windows)}
-@cindex AltGr key (MS-Windows)
+@kindex @key{AltGr} @r{(MS-Windows)}
+@cindex @key{AltGr} key (MS-Windows)
   The variable @code{w32-recognize-altgr} controls whether the
 @key{AltGr} key (if it exists on your keyboard), or its equivalent,
 the combination of the right @key{Alt} and left @key{Ctrl} keys
diff --git a/doc/emacs/mule.texi b/doc/emacs/mule.texi
index 01184e2ae1..87c22e9959 100644
--- a/doc/emacs/mule.texi
+++ b/doc/emacs/mule.texi
@@ -130,7 +130,7 @@ various @dfn{input methods}, typically one for each script or
 language, which make it easier to type characters in the script.
 @xref{Input Methods}.
 
-@kindex C-x RET
+@kindex C-x @key{RET}
   The prefix key @kbd{C-x @key{RET}} is used for commands that pertain
 to multibyte characters, coding systems, and input methods.
 
@@ -577,7 +577,7 @@ Display a list of all the supported input methods.
 
 @findex set-input-method
 @vindex current-input-method
-@kindex C-x RET C-\
+@kindex C-x @key{RET} C-\
   To choose an input method for the current buffer, use @kbd{C-x
 @key{RET} C-\} (@code{set-input-method}).  This command reads the
 input method name from the minibuffer; the name normally starts with the
@@ -1020,7 +1020,7 @@ Convert a region that was decoded using coding system @var{wrong},
 decoding it using coding system @var{right} instead.
 @end table
 
-@kindex C-x RET f
+@kindex C-x @key{RET} f
 @findex set-buffer-file-coding-system
   The command @kbd{C-x @key{RET} f}
 (@code{set-buffer-file-coding-system}) sets the file coding system for
@@ -1042,7 +1042,7 @@ current buffer.  For example, @kbd{C-x @key{RET} f dos @key{RET}} will
 cause Emacs to save the current buffer's text with DOS-style
 carriage-return linefeed line endings.
 
-@kindex C-x RET c
+@kindex C-x @key{RET} c
 @findex universal-coding-system-argument
   Another way to specify the coding system for a file is when you visit
 the file.  First use the command @kbd{C-x @key{RET} c}
@@ -1076,7 +1076,7 @@ then save it in a file.  Selecting a language environment typically sets
 this variable to a good choice of default coding system for that language
 environment.
 
-@kindex C-x RET r
+@kindex C-x @key{RET} r
 @findex revert-buffer-with-coding-system
   If you visit a file with a wrong coding system, you can correct this
 with @kbd{C-x @key{RET} r} (@code{revert-buffer-with-coding-system}).
@@ -1112,8 +1112,8 @@ subprocess input and output in the current buffer
 (@code{set-buffer-process-coding-system}).
 @end table
 
-@kindex C-x RET x
-@kindex C-x RET X
+@kindex C-x @key{RET} x
+@kindex C-x @key{RET} X
 @findex set-selection-coding-system
 @findex set-next-selection-coding-system
   The command @kbd{C-x @key{RET} x} (@code{set-selection-coding-system})
@@ -1138,7 +1138,7 @@ list of some of these symbols, Emacs tries only the request types in
 the list, in order, until one of them succeeds, or until the list is
 exhausted.
 
-@kindex C-x RET p
+@kindex C-x @key{RET} p
 @findex set-buffer-process-coding-system
   The command @kbd{C-x @key{RET} p} (@code{set-buffer-process-coding-system})
 specifies the coding system for input and output to a subprocess.  This
@@ -1180,7 +1180,7 @@ names (@code{set-file-name-coding-system}).
 @end table
 
 @findex set-file-name-coding-system
-@kindex C-x RET F
+@kindex C-x @key{RET} F
 @cindex file names with non-@acronym{ASCII} characters
   The command @kbd{C-x @key{RET} F} (@code{set-file-name-coding-system})
 specifies a coding system to use for encoding file @emph{names}.  It
@@ -1246,7 +1246,7 @@ Use coding system @var{coding} for keyboard input
 (@code{set-keyboard-coding-system}).
 @end table
 
-@kindex C-x RET t
+@kindex C-x @key{RET} t
 @findex set-terminal-coding-system
   The command @kbd{C-x @key{RET} t} (@code{set-terminal-coding-system})
 specifies the coding system for terminal output.  If you specify a
@@ -1263,7 +1263,7 @@ Emacs knows which characters the terminal can actually handle.
 Emacs can deduce the proper coding system from your terminal type or
 your locale specification (@pxref{Language Environments}).
 
-@kindex C-x RET k
+@kindex C-x @key{RET} k
 @findex set-keyboard-coding-system
 @vindex keyboard-coding-system
   The command @kbd{C-x @key{RET} k} (@code{set-keyboard-coding-system}),
@@ -1842,8 +1842,8 @@ character positions may look discontinuous if the region spans
 reordered text.  This is normal and similar to the behavior of other
 programs that support bidirectional text.
 
-@kindex RIGHT@r{, and bidirectional text}
-@kindex LEFT@r{, and bidirectional text}
+@kindex @key{RIGHT}@r{, and bidirectional text}
+@kindex @key{LEFT}@r{, and bidirectional text}
 @findex right-char@r{, and bidirectional text}
 @findex left-char@r{, and bidirectional text}
   Cursor motion commands bound to arrow keys, such as @key{LEFT} and
diff --git a/doc/emacs/picture-xtra.texi b/doc/emacs/picture-xtra.texi
index 39c353b0ff..35387a07b0 100644
--- a/doc/emacs/picture-xtra.texi
+++ b/doc/emacs/picture-xtra.texi
@@ -191,7 +191,7 @@ C-b} (@code{picture-motion-reverse}) moves in the opposite direction.
 @node Tabs in Picture
 @subsection Picture Mode Tabs
 
-@kindex M-TAB @r{(Picture mode)}
+@kindex M-@key{TAB} @r{(Picture mode)}
 @findex picture-tab-search
 @vindex picture-tab-chars
   Two kinds of tab-like action are provided in Picture mode.  Use
@@ -214,7 +214,7 @@ current tab stop settings; it is the Picture mode equivalent of
 @code{tab-to-tab-stop}.  Normally it just moves point, but with a numeric
 argument it clears the text that it moves over.
 
-@kindex C-c TAB @r{(Picture mode)}
+@kindex C-c @key{TAB} @r{(Picture mode)}
 @findex picture-set-tab-stops
   The context-based and tab-stop-based forms of tabbing are brought
 together by the command @kbd{C-c @key{TAB}} (@code{picture-set-tab-stops}).
diff --git a/doc/emacs/programs.texi b/doc/emacs/programs.texi
index 6af661ec02..88afec61da 100644
--- a/doc/emacs/programs.texi
+++ b/doc/emacs/programs.texi
@@ -99,7 +99,7 @@ language that you might want to edit.  If it doesn't have a mode for
 your favorite language, the mode might be implemented in a package not
 distributed with Emacs (@pxref{Packages}); or you can contribute one.
 
-@kindex DEL @r{(programming modes)}
+@kindex @key{DEL} @r{(programming modes)}
 @findex backward-delete-char-untabify
   In most programming languages, indentation should vary from line to
 line to illustrate the structure of the program.  Therefore, in most
@@ -346,7 +346,7 @@ Insert a newline, then adjust indentation of following line
 (@code{newline}).
 @end table
 
-@kindex TAB @r{(programming modes)}
+@kindex @key{TAB} @r{(programming modes)}
 @findex indent-line-function
   The basic indentation command is @kbd{@key{TAB}}
 (@code{indent-for-tab-command}), which was documented in
@@ -411,7 +411,7 @@ indentation of the line where the grouping starts).  The function that
 etc.  To correct the overall indentation as well, type @kbd{@key{TAB}}
 first.
 
-@kindex C-u TAB
+@kindex C-u @key{TAB}
   If you like the relative indentation within a grouping but not the
 indentation of its first line, move point to that first line and type
 @kbd{C-u @key{TAB}}.  In Lisp, C, and some other major modes,
@@ -683,7 +683,7 @@ argument moves the previous balanced expression backwards across those
 before it.  An argument of zero, rather than doing nothing, transposes
 the balanced expressions ending at or after point and the mark.
 
-@kindex C-M-SPC
+@kindex C-M-@key{SPC}
   To operate on balanced expressions with a command which acts on the
 region, type @kbd{C-M-@key{SPC}} (@code{mark-sexp}).  This sets the
 mark where @kbd{C-M-f} would move to.  While the mark is active, each
@@ -1008,7 +1008,7 @@ effect as @kbd{C-u M-;} by typing @kbd{M-x comment-kill}
 (@code{comment-dwim} actually calls @code{comment-kill} as a
 subroutine when it is given a prefix argument).
 
-@kindex C-c C-c (C mode)
+@kindex C-c C-c @r{(C mode)}
 @findex comment-region
 @findex uncomment-region
   The command @kbd{M-x comment-region} is equivalent to calling
@@ -1345,7 +1345,7 @@ nor comments).  The default value is @code{code}.
   Completion is normally done in the minibuffer (@pxref{Completion}),
 but you can also complete symbol names in ordinary Emacs buffers.
 
-@kindex M-TAB
+@kindex M-@key{TAB}
 @kindex C-M-i
   In programming language modes, type @kbd{C-M-i} or @kbd{M-@key{TAB}}
 to complete the partial symbol before point.  On graphical displays,
@@ -1451,7 +1451,7 @@ Prompt for the name of a function defined in any file Emacs has
 parsed, and move point there (@code{semantic-complete-jump}).
 
 @item C-c , @key{SPC}
-@kindex C-c , SPC
+@kindex C-c , @key{SPC}
 Display a list of possible completions for the symbol at point
 (@code{semantic-complete-analyze-inline}).  This also activates a set
 of special key bindings for choosing a completion: @kbd{@key{RET}}
@@ -1625,7 +1625,7 @@ behind.  A prefix argument acts as a repeat count.  With a negative
 argument, move backward.
 
 @item M-a
-@kindex M-a (C mode)
+@kindex M-a @r{(C mode)}
 @findex c-beginning-of-statement
 Move point to the beginning of the innermost C statement
 (@code{c-beginning-of-statement}).  If point is already at the beginning
@@ -1636,7 +1636,7 @@ In comments or in strings which span more than one line, this command
 moves by sentences instead of statements.
 
 @item M-e
-@kindex M-e (C mode)
+@kindex M-e @r{(C mode)}
 @findex c-end-of-statement
 Move point to the end of the innermost C statement or sentence; like
 @kbd{M-a} except that it moves in the other direction
@@ -1701,17 +1701,17 @@ preprocessor commands.
 @item C-c C-@key{DEL}
 @itemx C-c @key{DEL}
 @findex c-hungry-delete-backwards
-@kindex C-c C-DEL (C Mode)
-@kindex C-c DEL (C Mode)
+@kindex C-c C-@key{DEL} @r{(C Mode)}
+@kindex C-c @key{DEL} @r{(C Mode)}
 Delete the entire block of whitespace preceding point (@code{c-hungry-delete-backwards}).
 
 @item C-c C-d
 @itemx C-c C-@key{Delete}
 @itemx C-c @key{Delete}
 @findex c-hungry-delete-forward
-@kindex C-c C-d (C Mode)
-@kindex C-c C-Delete (C Mode)
-@kindex C-c Delete (C Mode)
+@kindex C-c C-d @r{(C Mode)}
+@kindex C-c C-@key{Delete} @r{(C Mode)}
+@kindex C-c @key{Delete} @r{(C Mode)}
 Delete the entire block of whitespace after point (@code{c-hungry-delete-forward}).
 @end table
 
diff --git a/doc/emacs/regs.texi b/doc/emacs/regs.texi
index 8ff36ca554..37a69347f4 100644
--- a/doc/emacs/regs.texi
+++ b/doc/emacs/regs.texi
@@ -70,7 +70,7 @@ Jump to the position and buffer saved in register @var{r}
 (@code{jump-to-register}).
 @end table
 
-@kindex C-x r SPC
+@kindex C-x r @key{SPC}
 @findex point-to-register
   Typing @kbd{C-x r @key{SPC}} (@code{point-to-register}), followed by
 a character @kbd{@var{r}}, saves both the position of point and the
diff --git a/doc/emacs/rmail.texi b/doc/emacs/rmail.texi
index e9371f39a9..15d66a3840 100644
--- a/doc/emacs/rmail.texi
+++ b/doc/emacs/rmail.texi
@@ -109,9 +109,9 @@ Scroll to start of message (@code{rmail-beginning-of-message}).
 Scroll to end of message (@code{rmail-end-of-message}).
 @end table
 
-@kindex SPC @r{(Rmail)}
-@kindex DEL @r{(Rmail)}
-@kindex S-SPC @r{(Rmail)}
+@kindex @key{SPC} @r{(Rmail)}
+@kindex @key{DEL} @r{(Rmail)}
+@kindex S-@key{SPC} @r{(Rmail)}
   Since the most common thing to do while reading a message is to
 scroll through it by screenfuls, Rmail makes @key{SPC} and @key{DEL}
 (or @kbd{S-@key{SPC}}) do the same as @kbd{C-v} (@code{scroll-up-command})
diff --git a/doc/emacs/screen.texi b/doc/emacs/screen.texi
index 19a4a9e4b6..674d1165d8 100644
--- a/doc/emacs/screen.texi
+++ b/doc/emacs/screen.texi
@@ -304,7 +304,7 @@ the full command name and documentation for a menu item, type
 @kbd{C-h k}, and then select the menu bar with the mouse in the usual
 way (@pxref{Key Help}).
 
-@kindex F10
+@kindex @key{F10}
 @findex menu-bar-open
 @cindex menu bar access using keyboard
   Instead of using the mouse, you can also invoke the first menu bar
diff --git a/doc/emacs/search.texi b/doc/emacs/search.texi
index 887fd982d0..d55ff26ab8 100644
--- a/doc/emacs/search.texi
+++ b/doc/emacs/search.texi
@@ -404,7 +404,7 @@ or @code{query-replace-regexp} (depending on search mode) with the
 current search string used as the string to replace.  A negative
 prefix argument means to replace backward.  @xref{Query Replace}.
 
-@kindex M-TAB @r{(Incremental search)}
+@kindex M-@key{TAB} @r{(Incremental search)}
   Typing @kbd{M-@key{TAB}} in incremental search invokes
 @code{isearch-complete}, which attempts to complete the search string
 using the search ring (the previous search strings you used) as a list
@@ -1193,8 +1193,8 @@ differences usually don't matter; etc.  This is known as
 tailor them to your needs.
 
 @cindex lax space matching in search
-@kindex M-s SPC @r{(Incremental search)}
-@kindex SPC @r{(Incremental search)}
+@kindex M-s @key{SPC} @r{(Incremental search)}
+@kindex @key{SPC} @r{(Incremental search)}
 @findex isearch-toggle-lax-whitespace
 @vindex search-whitespace-regexp
   By default, search commands perform @dfn{lax space matching}:
@@ -1577,10 +1577,10 @@ read-only text.  The default is not to ignore them.
 or regexp are:
 
 @ignore @c Not worth it.
-@kindex SPC @r{(query-replace)}
-@kindex DEL @r{(query-replace)}
+@kindex @key{SPC} @r{(query-replace)}
+@kindex @key{DEL} @r{(query-replace)}
 @kindex , @r{(query-replace)}
-@kindex RET @r{(query-replace)}
+@kindex @key{RET} @r{(query-replace)}
 @kindex . @r{(query-replace)}
 @kindex ! @r{(query-replace)}
 @kindex ^ @r{(query-replace)}
@@ -1777,7 +1777,7 @@ Note that matches for the regexp you type are extended to include
 complete lines, and a match that starts before the previous match ends
 is not considered a match.
 
-@kindex RET @r{(Occur mode)}
+@kindex @key{RET} @r{(Occur mode)}
 @kindex o @r{(Occur mode)}
 @kindex C-o @r{(Occur mode)}
 In the @file{*Occur*} buffer, you can click on each entry, or move
diff --git a/doc/emacs/sending.texi b/doc/emacs/sending.texi
index b7bdd69c7c..c7cc005a21 100644
--- a/doc/emacs/sending.texi
+++ b/doc/emacs/sending.texi
@@ -461,7 +461,7 @@ just after the header separator line---that is, to the beginning of
 the body.
 
 @findex message-tab
-@kindex TAB @r{(Message mode)}
+@kindex @key{TAB} @r{(Message mode)}
   While editing a header field that contains addresses, such as
 @samp{To:}, @samp{Cc:} and @samp{Bcc:}, you can complete an address by
 typing @key{TAB} (@code{message-tab}).  This attempts to insert the
diff --git a/doc/emacs/text.texi b/doc/emacs/text.texi
index 2363fc7f11..991d145306 100644
--- a/doc/emacs/text.texi
+++ b/doc/emacs/text.texi
@@ -137,7 +137,7 @@ kill only the next word but not the punctuation before it, simply do
 @kbd{M-@key{DEL}}.)  @kbd{M-d} takes arguments just like @kbd{M-f}.
 
 @findex backward-kill-word
-@kindex M-DEL
+@kindex M-@key{DEL}
   @kbd{M-@key{DEL}} (@code{backward-kill-word}) kills the word before
 point.  It kills everything from point back to where @kbd{M-b} would
 move to.  For instance, if point is after the space in @w{@samp{FOO,
@@ -214,7 +214,7 @@ of the sentence.  With a positive numeric argument @var{n}, it kills
 the next @var{n} sentences; with a negative argument @minus{}@var{n},
 it kills back to the beginning of the @var{n}th preceding sentence.
 
-@kindex C-x DEL
+@kindex C-x @key{DEL}
 @findex backward-kill-sentence
   The @kbd{C-x @key{DEL}} (@code{backward-kill-sentence}) kills back
 to the beginning of a sentence.
@@ -888,7 +888,7 @@ paragraphs.  As a result, paragraphs can be indented, and adaptive
 filling determines what indentation to use when filling a paragraph.
 @xref{Adaptive Fill}.
 
-@kindex TAB @r{(Text mode)}
+@kindex @key{TAB} @r{(Text mode)}
   In Text mode, the @key{TAB} (@code{indent-for-tab-command}) command
 usually inserts whitespace up to the next tab stop, instead of
 indenting the current line.  @xref{Indentation}, for details.
@@ -915,7 +915,7 @@ paragraph-indent-minor-mode} to enable an equivalent minor mode for
 situations where you shouldn't change the major mode---in mail
 composition, for instance.
 
-@kindex M-TAB @r{(Text mode)}
+@kindex M-@key{TAB} @r{(Text mode)}
   Text mode binds @kbd{M-@key{TAB}} to @code{ispell-complete-word}.
 This command performs completion of the partial word in the buffer
 before point, using the spelling dictionary as the space of possible
@@ -1362,7 +1362,7 @@ starts with one or more @samp{*} characters.  @xref{Outline Format}.
 In addition, any line that begins with the @samp{#} character is
 treated as a comment.
 
-@kindex TAB @r{(Org Mode)}
+@kindex @key{TAB} @r{(Org Mode)}
 @findex org-cycle
   Org mode provides commands for easily viewing and manipulating the
 outline structure.  The simplest of these commands is @key{TAB}
@@ -1373,26 +1373,26 @@ of its direct children, if any, and (iii) showing the entire subtree.
 If invoked in a body line, the global binding for @key{TAB} is
 executed.
 
-@kindex S-TAB @r{(Org Mode)}
+@kindex S-@key{TAB} @r{(Org Mode)}
 @findex org-shifttab
   Typing @kbd{S-@key{TAB}} (@code{org-shifttab}) anywhere in an Org mode
 buffer cycles the visibility of the entire outline structure, between
 (i) showing only top-level heading lines, (ii) showing all heading
 lines but no body lines, and (iii) showing everything.
 
-@kindex M-<up> @r{(Org Mode)}
-@kindex M-<down> @r{(Org Mode)}
-@kindex M-<left> @r{(Org Mode)}
-@kindex M-<right> @r{(Org Mode)}
+@kindex M-@key{UP} @r{(Org Mode)}
+@kindex M-@key{DOWN} @r{(Org Mode)}
+@kindex M-@key{LEFT} @r{(Org Mode)}
+@kindex M-@key{RIGHT} @r{(Org Mode)}
 @findex org-metaup
 @findex org-metadown
 @findex org-metaleft
 @findex org-metaright
   You can move an entire entry up or down in the buffer, including its
-body lines and subtree (if any), by typing @kbd{M-<up>}
-(@code{org-metaup}) or @kbd{M-<down>} (@code{org-metadown}) on the
+body lines and subtree (if any), by typing @kbd{M-@key{UP}}
+(@code{org-metaup}) or @kbd{M-@key{DOWN}} (@code{org-metadown}) on the
 heading line.  Similarly, you can promote or demote a heading line
-with @kbd{M-<left>} (@code{org-metaleft}) and @kbd{M-<right>}
+with @kbd{M-@key{LEFT}} (@code{org-metaleft}) and @kbd{M-@key{RIGHT}}
 (@code{org-metaright}).  These commands execute their global bindings
 if invoked on a body line.
 
@@ -1862,7 +1862,7 @@ in a local variable list in each of the subfiles.  @xref{File
 Variables}.
 
 @findex tex-bibtex-file
-@kindex C-c TAB @r{(@TeX{} mode)}
+@kindex C-c @key{TAB} @r{(@TeX{} mode)}
 @vindex tex-bibtex-command
   For @LaTeX{} files, you can use Bib@TeX{} to process the auxiliary
 file for the current buffer's file.  Bib@TeX{} looks up bibliographic
@@ -2005,7 +2005,7 @@ Run a shell command (which you must specify) to validate the current
 buffer as SGML (@code{sgml-validate}).
 
 @item C-c @key{TAB}
-@kindex C-c TAB @r{(SGML mode)}
+@kindex C-c @key{TAB} @r{(SGML mode)}
 @findex sgml-tags-invisible
 Toggle the visibility of existing tags in the buffer.  This can be
 used as a cheap preview (@code{sgml-tags-invisible}).
@@ -2318,7 +2318,7 @@ These margins also affect fill commands such as @kbd{M-q}
 for specifying indentation:
 
 @table @code
-@kindex C-x TAB @r{(Enriched mode)}
+@kindex C-x @key{TAB} @r{(Enriched mode)}
 @findex increase-left-margin
 @item Indent More
 Indent the region by 4 columns (@code{increase-left-margin}).  In
@@ -2858,7 +2858,7 @@ buffer.  There are three ways to enter two-column mode:
 
 @table @asis
 @item @kbd{@key{F2} 2} or @kbd{C-x 6 2}
-@kindex F2 2
+@kindex @key{F2} 2
 @kindex C-x 6 2
 @findex 2C-two-columns
 Enter two-column mode with the current buffer on the left, and on the
@@ -2871,7 +2871,7 @@ This command is appropriate when the current buffer is empty or contains
 just one column and you want to add another column.
 
 @item @kbd{@key{F2} s} or @kbd{C-x 6 s}
-@kindex F2 s
+@kindex @key{F2} s
 @kindex C-x 6 s
 @findex 2C-split
 Split the current buffer, which contains two-column text, into two
@@ -2886,7 +2886,7 @@ two-column text, and you wish to separate the columns temporarily.
 
 @item @kbd{@key{F2} b @var{buffer} @key{RET}}
 @itemx @kbd{C-x 6 b @var{buffer} @key{RET}}
-@kindex F2 b
+@kindex @key{F2} b
 @kindex C-x 6 b
 @findex 2C-associate-buffer
 Enter two-column mode using the current buffer as the left-hand buffer,
@@ -2910,15 +2910,15 @@ way to write a line that spans both columns while in two-column
 mode: write it in the left-hand buffer, and put an empty line in the
 right-hand buffer.)
 
-@kindex F2 RET
-@kindex C-x 6 RET
+@kindex @key{F2} @key{RET}
+@kindex C-x 6 @key{RET}
 @findex 2C-newline
   The command @kbd{C-x 6 @key{RET}} or @kbd{@key{F2} @key{RET}}
 (@code{2C-newline}) inserts a newline in each of the two buffers at
 corresponding positions.  This is the easiest way to add a new line to
 the two-column text while editing it in split buffers.
 
-@kindex F2 1
+@kindex @key{F2} 1
 @kindex C-x 6 1
 @findex 2C-merge
   When you have edited both buffers as you wish, merge them with
@@ -2926,7 +2926,7 @@ the two-column text while editing it in split buffers.
 text from the right-hand buffer as a second column in the other buffer.
 To go back to two-column editing, use @kbd{@key{F2} s}.
 
-@kindex F2 d
+@kindex @key{F2} d
 @kindex C-x 6 d
 @findex 2C-dissociate
   Use @kbd{@key{F2} d} or @kbd{C-x 6 d} to dissociate the two buffers,
diff --git a/doc/emacs/trouble.texi b/doc/emacs/trouble.texi
index ea02bb8da8..f8e96ac079 100644
--- a/doc/emacs/trouble.texi
+++ b/doc/emacs/trouble.texi
@@ -91,7 +91,7 @@ argument, you can cancel that argument with @kbd{C-g} and remain in the
 recursive edit.
 
 @findex keyboard-escape-quit
-@kindex ESC ESC ESC
+@kindex @key{ESC} @key{ESC} @key{ESC}
   The sequence @kbd{@key{ESC} @key{ESC} @key{ESC}}
 (@code{keyboard-escape-quit}) can either quit or abort.  (We defined
 it this way because @key{ESC} means ``get out'' in many PC programs.)
diff --git a/doc/lispref/files.texi b/doc/lispref/files.texi
index 68cc3df49a..6c6655c77d 100644
--- a/doc/lispref/files.texi
+++ b/doc/lispref/files.texi
@@ -3250,7 +3250,7 @@ shown above; the details are crucial for proper behavior in the case of
 multiple handlers, and for operations that have two file names that may
 each have handlers.
 
-@kindex safe-magic (@r{property})
+@kindex safe-magic @r{(property)}
   Handlers that don't really do anything special for actual access to the
 file---such as the ones that implement completion of host names for
 remote file names---should have a non-@code{nil} @code{safe-magic}
@@ -3260,7 +3260,7 @@ file names, by prefixing them with @samp{/:}.  But if the handler that
 would be used for them has a non-@code{nil} @code{safe-magic}
 property, the @samp{/:} is not added.
 
-@kindex operations (@r{property})
+@kindex operations @r{(property)}
   A file name handler can have an @code{operations} property to
 declare which operations it handles in a nontrivial way.  If this
 property has a non-@code{nil} value, it should be a list of
diff --git a/doc/misc/calc.texi b/doc/misc/calc.texi
index a4a091f243..a29097cfda 100644
--- a/doc/misc/calc.texi
+++ b/doc/misc/calc.texi
@@ -10906,27 +10906,27 @@ degrees, minutes, and seconds.
 @ignore
 @mindex @null
 @end ignore
-@kindex ' (HMS forms)
+@kindex ' @r{(HMS forms)}
 @ignore
 @mindex @null
 @end ignore
-@kindex " (HMS forms)
+@kindex " @r{(HMS forms)}
 @ignore
 @mindex @null
 @end ignore
-@kindex h (HMS forms)
+@kindex h @r{(HMS forms)}
 @ignore
 @mindex @null
 @end ignore
-@kindex o (HMS forms)
+@kindex o @r{(HMS forms)}
 @ignore
 @mindex @null
 @end ignore
-@kindex m (HMS forms)
+@kindex m @r{(HMS forms)}
 @ignore
 @mindex @null
 @end ignore
-@kindex s (HMS forms)
+@kindex s @r{(HMS forms)}
 The default format for HMS values is
 @samp{@var{hours}@@ @var{mins}' @var{secs}"}.  During entry, the letters
 @samp{h} (for ``hours'') or
@@ -11125,7 +11125,7 @@ integers but this is not required.
 @ignore
 @mindex M
 @end ignore
-@kindex M (modulo forms)
+@kindex M @r{(modulo forms)}
 @ignore
 @mindex mod
 @end ignore
@@ -11280,7 +11280,7 @@ would indeed have been negligible.
 @ignore
 @mindex p
 @end ignore
-@kindex p (error forms)
+@kindex p @r{(error forms)}
 @tindex +/-
 To enter an error form during regular numeric entry, use the @kbd{p}
 (``plus-or-minus'') key to type the @samp{+/-} symbol.  (If you try actually
@@ -16682,8 +16682,8 @@ or matrix argument, these functions operate element-wise.
 @ignore
 @mindex v p
 @end ignore
-@kindex v p (complex)
-@kindex V p (complex)
+@kindex v p @r{(complex)}
+@kindex V p @r{(complex)}
 @pindex calc-pack
 The @kbd{v p} (@code{calc-pack}) command can pack the top two numbers on
 the stack into a composite object such as a complex number.  With
@@ -16694,8 +16694,8 @@ with an argument of @mathit{-2}, it produces a polar complex number.
 @ignore
 @mindex v u
 @end ignore
-@kindex v u (complex)
-@kindex V u (complex)
+@kindex v u @r{(complex)}
+@kindex V u @r{(complex)}
 @pindex calc-unpack
 The @kbd{v u} (@code{calc-unpack}) command takes the complex number
 (or other composite object) on the top of the stack and unpacks it
@@ -20234,7 +20234,7 @@ the conjugate transpose of its argument, i.e., @samp{conj(trn(x))}.
 @ignore
 @mindex A
 @end ignore
-@kindex A (vectors)
+@kindex A @r{(vectors)}
 @pindex calc-abs (vectors)
 @ignore
 @mindex abs
@@ -20280,7 +20280,7 @@ exactly three elements.
 @ignore
 @mindex &
 @end ignore
-@kindex & (matrices)
+@kindex & @r{(matrices)}
 @pindex calc-inv (matrices)
 @ignore
 @mindex inv
diff --git a/doc/misc/cc-mode.texi b/doc/misc/cc-mode.texi
index e10808954d..438919b2d8 100644
--- a/doc/misc/cc-mode.texi
+++ b/doc/misc/cc-mode.texi
@@ -671,7 +671,7 @@ These commands indent code:
 
 @table @asis
 @item @kbd{@key{TAB}} (@code{c-indent-command})
-@kindex TAB
+@kindex @key{TAB}
 @findex c-indent-command
 @findex indent-command @r{(c-)}
 This command indents the current line.  That is all you need to know
@@ -920,8 +920,8 @@ must be in column zero.  See @ref{Defuns,,,@emacsman{},
 
 @item @kbd{C-M-a} (AWK Mode) (@code{c-awk-beginning-of-defun})
 @itemx @kbd{C-M-e} (AWK Mode) (@code{c-awk-end-of-defun})
-@kindex C-M-a (AWK Mode)
-@kindex C-M-e (AWK Mode)
+@kindex C-M-a @r{(AWK Mode)}
+@kindex C-M-e @r{(AWK Mode)}
 @findex c-awk-beginning-of-defun
 @findex awk-beginning-of-defun @r{(c-)}
 @findex c-awk-end-of-defun
@@ -1518,10 +1518,10 @@ deletion.
 
 @table @asis
 @item @kbd{@key{DEL}} (@code{c-electric-backspace})
-@kindex DEL
+@kindex @key{DEL}
 @findex c-electric-backspace
 @findex electric-backspace @r{(c-)}
-This command is run by default when you hit the @kbd{DEL} key.  When
+This command is run by default when you hit the @kbd{@key{DEL}} key.  When
 hungry delete mode is enabled, it deletes any amount of whitespace in
 the backwards direction.  Otherwise, or when used with a prefix
 argument or in a literal (@pxref{Auto-newlines}), the command just
@@ -1567,10 +1567,10 @@ rather than using the minor mode toggling.
 
 @table @asis
 @item @kbd{C-c C-@key{DEL}}, or @kbd{C-c @key{DEL}} (@code{c-hungry-delete-backwards})@footnote{This command was formerly known as @code{c-hungry-backspace}.}
-@kindex C-c C-<backspace>
-@kindex C-c <backspace>
-@kindex C-c C-DEL
-@kindex C-c DEL
+@kindex C-c C-@key{Backspace}
+@kindex C-c @key{Backspace}
+@kindex C-c C-@key{DEL}
+@kindex C-c @key{DEL}
 @findex c-hungry-delete-backwards
 @findex hungry-delete-backwards @r{(c-)}
 Delete any amount of whitespace in the backwards direction (regardless
@@ -1581,21 +1581,21 @@ a character terminal.
 
 @item @kbd{C-c C-d}, @kbd{C-c C-@key{DELETE}}, or @kbd{C-c @key{DELETE}} (@code{c-hungry-delete-forward})
 @kindex C-c C-d
-@kindex C-c C-<DELETE>
-@kindex C-c <DELETE>
+@kindex C-c C-@key{Delete}
+@kindex C-c @key{Delete}
 @findex c-hungry-delete-forward
 @findex hungry-delete-forward @r{(c-)}
 Delete any amount of whitespace in the forward direction (regardless
 whether hungry-delete mode is enabled or not).  This command is bound
-to both @kbd{C-c C-@key{DELETE}} and @kbd{C-c @key{DELETE}} for the
+to both @kbd{C-c C-@key{Delete}} and @kbd{C-c @key{Delete}} for the
 same reason as for @key{DEL} above.
 @end table
 @end table
 
-@kindex <delete>
-@kindex <backspace>
+@kindex @key{Delete}
+@kindex @key{Backspace}
 
-When we talk about @kbd{@key{DEL}}, and @kbd{@key{DELETE}} above, we
+When we talk about @kbd{@key{DEL}}, and @kbd{@key{Delete}} above, we
 actually do so without connecting them to the physical keys commonly
 known as @key{Backspace} and @key{Delete}.  The default bindings to
 those two keys depends on the flavor of (X)Emacs you are using.
@@ -7248,15 +7248,15 @@ early on:
 Set the variable @code{c-basic-offset}.  @xref{Getting Started}.
 
 @item
-@kindex RET
+@kindex @key{RET}
 @kindex C-j
-@emph{Why does/doesn't the @kbd{RET} key indent the new line?}
+@emph{Why does/doesn't the @kbd{@key{RET}} key indent the new line?}
 
 Emacs's convention used to be that @kbd{RET} just adds a newline, and that
 @kbd{C-j} adds a newline and indents it.  In Emacs-24.4, this convention was
 reversed.
 
-If you use an older Emacs and you want @kbd{RET} do this
+If you use an older Emacs and you want @kbd{@key{RET}} do this
 too, add this to your @code{c-initialization-hook}:
 
 @example
diff --git a/doc/misc/ediff.texi b/doc/misc/ediff.texi
index e488fc07f8..86b93056d1 100644
--- a/doc/misc/ediff.texi
+++ b/doc/misc/ediff.texi
@@ -541,14 +541,14 @@ Copies the difference region from buffer C to buffer B@.
 The command @kbd{rb} undoes this.
 
 @item p
-@itemx DEL
+@itemx @key{DEL}
 @kindex p
-@kindex DEL
+@kindex @key{DEL}
 Makes the previous difference region current.
 @item n
-@itemx SPC
+@itemx @key{SPC}
 @kindex n
-@kindex SPC
+@kindex @key{SPC}
 Makes the next difference region current.
 
 @item j
diff --git a/doc/misc/epa.texi b/doc/misc/epa.texi
index 237617a524..d5dfe70760 100644
--- a/doc/misc/epa.texi
+++ b/doc/misc/epa.texi
@@ -281,22 +281,22 @@ The following keys are assigned.
 
 @table @kbd
 @item : d
-@kindex @kbd{: d}
+@kindex : d
 @findex epa-dired-do-decrypt
 Decrypt marked files.
 
 @item : v
-@kindex @kbd{: v}
+@kindex : v
 @findex epa-dired-do-verify
 Verify marked files.
 
 @item : s
-@kindex @kbd{: s}
+@kindex : s
 @findex epa-dired-do-sign
 Sign marked files.
 
 @item : e
-@kindex @kbd{: e}
+@kindex : e
 @findex epa-dired-do-encrypt
 Encrypt marked files.
 
@@ -322,26 +322,26 @@ interface.  Try @kbd{M-x customize-variable epa-global-mail-mode}.
 
 @table @kbd
 @item C-c C-e C-d and C-c C-e d
-@kindex @kbd{C-c C-e C-d}
-@kindex @kbd{C-c C-e d}
+@kindex C-c C-e C-d
+@kindex C-c C-e d
 @findex epa-mail-decrypt
 Decrypt OpenPGP armors in the current buffer.
 
 @item C-c C-e C-v and C-c C-e v
-@kindex @kbd{C-c C-e C-v}
-@kindex @kbd{C-c C-e v}
+@kindex C-c C-e C-v
+@kindex C-c C-e v
 @findex epa-mail-verify
 Verify OpenPGP cleartext signed messages in the current buffer.
 
 @item C-c C-e C-s and C-c C-e s
-@kindex @kbd{C-c C-e C-s}
-@kindex @kbd{C-c C-e s}
+@kindex C-c C-e C-s
+@kindex C-c C-e s
 @findex epa-mail-sign
 Compose a signed message from the current buffer.
 
 @item C-c C-e C-e and C-c C-e e
-@kindex @kbd{C-c C-e C-e}
-@kindex @kbd{C-c C-e e}
+@kindex C-c C-e C-e
+@kindex C-c C-e e
 @findex epa-mail-encrypt
 @vindex epa-mail-aliases
 Compose an encrypted message from the current buffer.
diff --git a/doc/misc/ert.texi b/doc/misc/ert.texi
index 3553560f49..3929e102a6 100644
--- a/doc/misc/ert.texi
+++ b/doc/misc/ert.texi
@@ -203,7 +203,7 @@ different Emacs versions.
 
 @findex ert
 You can run the tests that are currently defined in your Emacs with
-the command @kbd{@kbd{M-x} ert @kbd{RET} t @kbd{RET}}.  (For an
+the command @kbd{M-x ert @key{RET} t @key{RET}}.  (For an
 explanation of the @code{t} argument, @pxref{Test Selectors}.) ERT will pop
 up a new buffer, the ERT results buffer, showing the results of the
 tests run.  It looks like this:
@@ -260,11 +260,11 @@ unexpected result.  In the example above, there are two failures, both
 due to failed @code{should} forms.  @xref{Understanding Explanations},
 for more details.
 
-@kindex TAB@r{, in ert results buffer}
-@kindex S-TAB@r{, in ert results buffer}
-In the ERT results buffer, @kbd{TAB} and @kbd{S-TAB} cycle between
+@kindex @key{TAB}@r{, in ert results buffer}
+@kindex S-@key{TAB}@r{, in ert results buffer}
+In the ERT results buffer, @kbd{@key{TAB}} and @kbd{S-@key{TAB}} cycle between
 buttons.  Each name of a function or macro in this buffer is a button;
-moving point to it and typing @kbd{RET} jumps to its definition.
+moving point to it and typing @kbd{@key{RET}} jumps to its definition.
 
 @kindex r@r{, in ert results buffer}
 @kindex d@r{, in ert results buffer}
@@ -273,7 +273,7 @@ moving point to it and typing @kbd{RET} jumps to its definition.
 @cindex backtrace of a failed test
 Pressing @kbd{r} re-runs the test near point on its own.  Pressing
 @kbd{d} re-runs it with the debugger enabled.  @kbd{.} jumps to the
-definition of the test near point (@kbd{RET} has the same effect if
+definition of the test near point (@kbd{@key{RET}} has the same effect if
 point is on the name of the test).  On a failed test, @kbd{b} shows
 the backtrace of the failure.
 
@@ -817,7 +817,7 @@ failed.  This can be useful to figure out how far it got.
 @item
 You can instrument tests for debugging the same way you instrument
 @code{defun}s for debugging: go to the source code of the test and
-type @kbd{@kbd{C-u} @kbd{C-M-x}}.  Then, go back to the ERT buffer and
+type @kbd{C-u C-M-x}.  Then, go back to the ERT buffer and
 re-run the test with @kbd{r} or @kbd{d}.
 
 @cindex discard obsolete test results
diff --git a/doc/misc/eww.texi b/doc/misc/eww.texi
index 258a2f2bff..0b1fb6598b 100644
--- a/doc/misc/eww.texi
+++ b/doc/misc/eww.texi
@@ -98,8 +98,8 @@ web page hit @kbd{g} (@code{eww-reload}).  Pressing @kbd{w}
 (@code{eww-copy-page-url}) will copy the current URL to the kill ring.
 
 @findex eww-open-in-new-buffer
-@kindex M-RET
-  The @kbd{M-RET} command (@code{eww-open-in-new-buffer}) opens the
+@kindex M-@key{RET}
+  The @kbd{M-@key{RET}} command (@code{eww-open-in-new-buffer}) opens the
 URL at point in a new EWW buffer, akin to opening a link in a new
 ``tab'' in other browsers.
 
diff --git a/doc/misc/forms.texi b/doc/misc/forms.texi
index 9857a67745..41847dfcff 100644
--- a/doc/misc/forms.texi
+++ b/doc/misc/forms.texi
@@ -226,9 +226,9 @@ Jump to the last record (@code{forms-last-record}).  This command also
 recalculates the number of records in the data file.
 
 @findex forms-next-field
-@kindex TAB
+@kindex @key{TAB}
 @item @key{TAB}
-@kindex C-c TAB
+@kindex C-c @key{TAB}
 @itemx C-c @key{TAB}
 Jump to the next field in the current record (@code{forms-next-field}).
 With a numeric argument @var{n}, jump forward @var{n} fields.  If this command
@@ -334,25 +334,25 @@ The following function key definitions are set up in Forms mode
 (whether read-only or not):
 
 @table @kbd
-@kindex next
-@item next
+@kindex @key{NEXT}
+@item @key{NEXT}
 forms-next-record
 
-@kindex prior
-@item prior
+@kindex @key{PRIOR}
+@item @key{PRIOR}
 forms-prev-record
 
-@kindex begin
-@item begin
+@kindex @key{BEGIN}
+@item @key{BEGIN}
 forms-first-record
 
-@kindex end
-@item end
+@kindex @key{END}
+@item @key{END}
 forms-last-record
 
-@kindex S-Tab
+@kindex S-@key{TAB}
 @findex forms-prev-field
-@item S-Tab
+@item S-@key{TAB}
 forms-prev-field
 @end table
 
diff --git a/doc/misc/gnus.texi b/doc/misc/gnus.texi
index c9bcc7f064..0d51240adb 100644
--- a/doc/misc/gnus.texi
+++ b/doc/misc/gnus.texi
@@ -959,7 +959,6 @@ Emacs for Heathens
 If you haven't used Emacs much before using Gnus, read @ref{Emacs for
 Heathens} first.
 
-@kindex M-x gnus
 @findex gnus
 If your system administrator has set things up properly, starting Gnus
 and reading news is extremely easy---you just type @kbd{M-x gnus} in
@@ -969,7 +968,6 @@ minimal setup for posting should also customize the variables
 @code{user-full-name} and @code{user-mail-address}.
 
 @findex gnus-other-frame
-@kindex M-x gnus-other-frame
 If you want to start Gnus in a different frame, you can use the command
 @kbd{M-x gnus-other-frame} instead.
 
@@ -1000,7 +998,7 @@ terminology section (@pxref{Terminology}).
 First of all, you should know that there is a special buffer called
 @file{*Server*} that lists all the servers Gnus knows about.  You can
 press @kbd{^} from the Group buffer to see it.  In the Server buffer,
-you can press @kbd{RET} on a defined server to see all the groups it
+you can press @kbd{@key{RET}} on a defined server to see all the groups it
 serves (subscribed or not!).  You can also add or delete servers, edit
 a foreign server's definition, agentize or de-agentize a server, and
 do many other neat things.  @xref{Server Buffer}.
@@ -1043,7 +1041,7 @@ If that fails as well, Gnus will try to use the machine running Emacs
 as an @acronym{NNTP} server.  That's a long shot, though.
 
 @findex gnus-group-browse-foreign-server
-@kindex B (Group)
+@kindex B @r{(Group)}
 However, if you use one @acronym{NNTP} server regularly and are just
 interested in a couple of groups from a different server, you would be
 better served by using the @kbd{B} command in the group buffer.  It will
@@ -1087,7 +1085,6 @@ groups, you'll find it difficult to actually do anything in the group
 buffer.  But, hey, that's your problem.  Blllrph!
 
 @findex gnus-no-server
-@kindex M-x gnus-no-server
 @c @head
 If you know that the server is definitely down, or you just want to read
 your mail without bothering with the server at all, you can use the
@@ -1354,13 +1351,11 @@ you have read is by keeping track of article numbers.  So when you
 change @code{gnus-select-method}, your @file{.newsrc} file becomes
 worthless.
 
-@kindex M-x gnus-group-clear-data-on-native-groups
 @findex gnus-group-clear-data-on-native-groups
 You can use the @kbd{M-x gnus-group-clear-data-on-native-groups}
 command to clear out all data that you have on your native groups.
 Use with caution.
 
-@kindex M-x gnus-group-clear-data
 @findex gnus-group-clear-data
 Clear the data from the current group only---nix out marks and the
 list of read articles (@code{gnus-group-clear-data}).
@@ -1704,7 +1699,7 @@ long as Gnus is active.
 @end menu
 
 You can customize the Group Mode tool bar, see @kbd{M-x
-customize-apropos RET gnus-group-tool-bar}.  This feature is only
+customize-apropos @key{RET} gnus-group-tool-bar}.  This feature is only
 available in Emacs.
 
 The tool bar icons are now (de)activated correctly depending on the
@@ -1989,37 +1984,37 @@ expected, hopefully.
 @table @kbd
 
 @item n
-@kindex n (Group)
+@kindex n @r{(Group)}
 @findex gnus-group-next-unread-group
 Go to the next group that has unread articles
 (@code{gnus-group-next-unread-group}).
 
 @item p
-@itemx DEL
-@kindex DEL (Group)
-@kindex p (Group)
+@itemx @key{DEL}
+@kindex @key{DEL} @r{(Group)}
+@kindex p @r{(Group)}
 @findex gnus-group-prev-unread-group
 Go to the previous group that has unread articles
 (@code{gnus-group-prev-unread-group}).
 
 @item N
-@kindex N (Group)
+@kindex N @r{(Group)}
 @findex gnus-group-next-group
 Go to the next group (@code{gnus-group-next-group}).
 
 @item P
-@kindex P (Group)
+@kindex P @r{(Group)}
 @findex gnus-group-prev-group
 Go to the previous group (@code{gnus-group-prev-group}).
 
 @item M-n
-@kindex M-n (Group)
+@kindex M-n @r{(Group)}
 @findex gnus-group-next-unread-group-same-level
 Go to the next unread group on the same (or lower) level
 (@code{gnus-group-next-unread-group-same-level}).
 
 @item M-p
-@kindex M-p (Group)
+@kindex M-p @r{(Group)}
 @findex gnus-group-prev-unread-group-same-level
 Go to the previous unread group on the same (or lower) level
 (@code{gnus-group-prev-unread-group-same-level}).
@@ -2030,20 +2025,20 @@ Three commands for jumping to groups:
 @table @kbd
 
 @item j
-@kindex j (Group)
+@kindex j @r{(Group)}
 @findex gnus-group-jump-to-group
 Jump to a group (and make it visible if it isn't already)
 (@code{gnus-group-jump-to-group}).  Killed groups can be jumped to, just
 like living groups.
 
 @item ,
-@kindex , (Group)
+@kindex , @r{(Group)}
 @findex gnus-group-best-unread-group
 Jump to the unread group with the lowest level
 (@code{gnus-group-best-unread-group}).
 
 @item .
-@kindex . (Group)
+@kindex . @r{(Group)}
 @findex gnus-group-first-unread-group
 Jump to the first group with unread articles
 (@code{gnus-group-first-unread-group}).
@@ -2067,8 +2062,8 @@ Otherwise, the point is set to the group just exited.  The default is
 
 @table @kbd
 
-@item SPACE
-@kindex SPACE (Group)
+@item @key{SPC}
+@kindex @key{SPC} @r{(Group)}
 @findex gnus-group-read-group
 Select the current group, switch to the summary buffer and display the
 first unread article (@code{gnus-group-read-group}).  If there are no
@@ -2079,16 +2074,16 @@ determines the number of articles Gnus will fetch.  If @var{n} is
 positive, Gnus fetches the @var{n} newest articles, if @var{n} is
 negative, Gnus fetches the @code{abs(@var{n})} oldest articles.
 
-Thus, @kbd{SPC} enters the group normally, @kbd{C-u SPC} offers old
-articles, @kbd{C-u 4 2 SPC} fetches the 42 newest articles, and @kbd{C-u
-- 4 2 SPC} fetches the 42 oldest ones.
+Thus, @kbd{@key{SPC}} enters the group normally, @kbd{C-u @key{SPC}}
+offers old articles, @kbd{C-u 4 2 @key{SPC}} fetches the 42 newest
+articles, and @kbd{C-u - 4 2 @key{SPC}} fetches the 42 oldest ones.
 
 When you are in the group (in the Summary buffer), you can type
 @kbd{M-g} to fetch new articles, or @kbd{C-u M-g} to also show the old
 ones.
 
-@item RET
-@kindex RET (Group)
+@item @key{RET}
+@kindex @key{RET} @r{(Group)}
 @findex gnus-group-select-group
 Select the current group and switch to the summary buffer
 (@code{gnus-group-select-group}).  Takes the same arguments as
@@ -2096,27 +2091,27 @@ Select the current group and switch to the summary buffer
 does not display the first unread article automatically upon group
 entry.
 
-@item M-RET
-@kindex M-RET (Group)
+@item M-@key{RET}
+@kindex M-@key{RET} @r{(Group)}
 @findex gnus-group-quick-select-group
 This does the same as the command above, but tries to do it with the
 minimum amount of fuzz (@code{gnus-group-quick-select-group}).  No
 scoring/killing will be performed, there will be no highlights and no
 expunging.  This might be useful if you're in a real hurry and have to
 enter some humongous group.  If you give a 0 prefix to this command
-(i.e., @kbd{0 M-RET}), Gnus won't even generate the summary buffer,
+(i.e., @kbd{0 M-@key{RET}}), Gnus won't even generate the summary buffer,
 which is useful if you want to toggle threading before generating the
 summary buffer (@pxref{Summary Generation Commands}).
 
-@item M-SPACE
-@kindex M-SPACE (Group)
+@item M-@key{SPC}
+@kindex M-@key{SPC} @r{(Group)}
 @findex gnus-group-visible-select-group
-This is yet one more command that does the same as the @kbd{RET}
+This is yet one more command that does the same as the @kbd{@key{RET}}
 command, but this one does it without expunging and hiding dormants
 (@code{gnus-group-visible-select-group}).
 
-@item C-M-RET
-@kindex C-M-RET (Group)
+@item C-M-@key{RET}
+@kindex C-M-@key{RET} @r{(Group)}
 @findex gnus-group-select-group-ephemerally
 Finally, this command selects the current group ephemerally without
 doing any processing of its contents
@@ -2164,7 +2159,7 @@ means Gnus never ignores old articles.
 @vindex gnus-auto-select-first
 @vindex gnus-auto-select-subject
 If @code{gnus-auto-select-first} is non-@code{nil}, select an article
-automatically when entering a group with the @kbd{SPACE} command.
+automatically when entering a group with the @kbd{@key{SPC}} command.
 Which article this is controlled by the
 @code{gnus-auto-select-subject} variable.  Valid values for this
 variable are:
@@ -2207,15 +2202,15 @@ selected.
 The following commands allow for managing your subscriptions in the
 Group buffer.  If you want to subscribe to many groups, it's probably
 more convenient to go to the @ref{Server Buffer}, and choose the
-server there using @kbd{RET} or @kbd{SPC}.  Then you'll have the
+server there using @kbd{@key{RET}} or @kbd{@key{SPC}}.  Then you'll have the
 commands listed in @ref{Browse Foreign Server} at hand.
 
 @table @kbd
 
 @item S t
 @itemx u
-@kindex S t (Group)
-@kindex u (Group)
+@kindex S t @r{(Group)}
+@kindex u @r{(Group)}
 @findex gnus-group-unsubscribe-current-group
 @c @icon{gnus-group-unsubscribe}
 Toggle subscription to the current group
@@ -2223,8 +2218,8 @@ Toggle subscription to the current group
 
 @item S s
 @itemx U
-@kindex S s (Group)
-@kindex U (Group)
+@kindex S s @r{(Group)}
+@kindex U @r{(Group)}
 @findex gnus-group-unsubscribe-group
 Prompt for a group to subscribe, and then subscribe it.  If it was
 subscribed already, unsubscribe it instead
@@ -2232,21 +2227,21 @@ subscribed already, unsubscribe it instead
 
 @item S k
 @itemx C-k
-@kindex S k (Group)
-@kindex C-k (Group)
+@kindex S k @r{(Group)}
+@kindex C-k @r{(Group)}
 @findex gnus-group-kill-group
 @c @icon{gnus-group-kill-group}
 Kill the current group (@code{gnus-group-kill-group}).
 
 @item S y
 @itemx C-y
-@kindex S y (Group)
-@kindex C-y (Group)
+@kindex S y @r{(Group)}
+@kindex C-y @r{(Group)}
 @findex gnus-group-yank-group
 Yank the last killed group (@code{gnus-group-yank-group}).
 
 @item C-x C-t
-@kindex C-x C-t (Group)
+@kindex C-x C-t @r{(Group)}
 @findex gnus-group-transpose-groups
 Transpose two groups (@code{gnus-group-transpose-groups}).  This isn't
 really a subscription command, but you can use it instead of a
@@ -2254,18 +2249,18 @@ kill-and-yank sequence sometimes.
 
 @item S w
 @itemx C-w
-@kindex S w (Group)
-@kindex C-w (Group)
+@kindex S w @r{(Group)}
+@kindex C-w @r{(Group)}
 @findex gnus-group-kill-region
 Kill all groups in the region (@code{gnus-group-kill-region}).
 
 @item S z
-@kindex S z (Group)
+@kindex S z @r{(Group)}
 @findex gnus-group-kill-all-zombies
 Kill all zombie groups (@code{gnus-group-kill-all-zombies}).
 
 @item S C-k
-@kindex S C-k (Group)
+@kindex S C-k @r{(Group)}
 @findex gnus-group-kill-level
 Kill all groups on a certain level (@code{gnus-group-kill-level}).
 These groups can't be yanked back after killing, so this command should
@@ -2286,7 +2281,7 @@ Also @pxref{Group Levels}.
 @table @kbd
 
 @item c
-@kindex c (Group)
+@kindex c @r{(Group)}
 @findex gnus-group-catchup-current
 @vindex gnus-group-catchup-group-hook
 @c @icon{gnus-group-catchup-current}
@@ -2296,19 +2291,18 @@ Mark all unticked articles in this group as read
 the group buffer.
 
 @item C
-@kindex C (Group)
+@kindex C @r{(Group)}
 @findex gnus-group-catchup-current-all
 Mark all articles in this group, even the ticked ones, as read
 (@code{gnus-group-catchup-current-all}).
 
 @item M-c
-@kindex M-c (Group)
+@kindex M-c @r{(Group)}
 @findex gnus-group-clear-data
 Clear the data from the current group---nix out marks and the list of
 read articles (@code{gnus-group-clear-data}).
 
 @item M-x gnus-group-clear-data-on-native-groups
-@kindex M-x gnus-group-clear-data-on-native-groups
 @findex gnus-group-clear-data-on-native-groups
 If you have switched from one @acronym{NNTP} server to another, all your marks
 and read ranges have become worthless.  You can use this command to
@@ -2334,7 +2328,7 @@ Remember:  The higher the level of the group, the less important it is.
 @table @kbd
 
 @item S l
-@kindex S l (Group)
+@kindex S l @r{(Group)}
 @findex gnus-group-set-current-level
 Set the level of the current group.  If a numeric prefix is given, the
 next @var{n} groups will have their levels set.  The user will be
@@ -2478,37 +2472,37 @@ with the process mark and then execute the command.
 @table @kbd
 
 @item #
-@kindex # (Group)
+@kindex # @r{(Group)}
 @itemx M m
-@kindex M m (Group)
+@kindex M m @r{(Group)}
 @findex gnus-group-mark-group
 Set the mark on the current group (@code{gnus-group-mark-group}).
 
 @item M-#
-@kindex M-# (Group)
+@kindex M-# @r{(Group)}
 @itemx M u
-@kindex M u (Group)
+@kindex M u @r{(Group)}
 @findex gnus-group-unmark-group
 Remove the mark from the current group
 (@code{gnus-group-unmark-group}).
 
 @item M U
-@kindex M U (Group)
+@kindex M U @r{(Group)}
 @findex gnus-group-unmark-all-groups
 Remove the mark from all groups (@code{gnus-group-unmark-all-groups}).
 
 @item M w
-@kindex M w (Group)
+@kindex M w @r{(Group)}
 @findex gnus-group-mark-region
 Mark all groups between point and mark (@code{gnus-group-mark-region}).
 
 @item M b
-@kindex M b (Group)
+@kindex M b @r{(Group)}
 @findex gnus-group-mark-buffer
 Mark all groups in the buffer (@code{gnus-group-mark-buffer}).
 
 @item M r
-@kindex M r (Group)
+@kindex M r @r{(Group)}
 @findex gnus-group-mark-regexp
 Mark all groups that match some regular expression
 (@code{gnus-group-mark-regexp}).
@@ -2549,7 +2543,7 @@ variable @code{gnus-parameters}, @xref{Group Parameters}.
 @table @kbd
 
 @item G m
-@kindex G m (Group)
+@kindex G m @r{(Group)}
 @findex gnus-group-make-group
 @cindex making groups
 Make a new group (@code{gnus-group-make-group}).  Gnus will prompt you
@@ -2557,13 +2551,13 @@ for a name, a method and possibly an @dfn{address}.  For an easier way
 to subscribe to @acronym{NNTP} groups (@pxref{Browse Foreign Server}).
 
 @item G M
-@kindex G M (Group)
+@kindex G M @r{(Group)}
 @findex gnus-group-read-ephemeral-group
 Make an ephemeral group (@code{gnus-group-read-ephemeral-group}).  Gnus
 will prompt you for a name, a method and an @dfn{address}.
 
 @item G r
-@kindex G r (Group)
+@kindex G r @r{(Group)}
 @findex gnus-group-rename-group
 @cindex renaming groups
 Rename the current group to something else
@@ -2572,45 +2566,45 @@ groups---mail groups mostly.  This command might very well be quite slow
 on some back ends.
 
 @item G c
-@kindex G c (Group)
+@kindex G c @r{(Group)}
 @cindex customizing
 @findex gnus-group-customize
 Customize the group parameters (@code{gnus-group-customize}).
 
 @item G e
-@kindex G e (Group)
+@kindex G e @r{(Group)}
 @findex gnus-group-edit-group-method
 @cindex renaming groups
 Enter a buffer where you can edit the select method of the current
 group (@code{gnus-group-edit-group-method}).
 
 @item G p
-@kindex G p (Group)
+@kindex G p @r{(Group)}
 @findex gnus-group-edit-group-parameters
 Enter a buffer where you can edit the group parameters
 (@code{gnus-group-edit-group-parameters}).
 
 @item G E
-@kindex G E (Group)
+@kindex G E @r{(Group)}
 @findex gnus-group-edit-group
 Enter a buffer where you can edit the group info
 (@code{gnus-group-edit-group}).
 
 @item G d
-@kindex G d (Group)
+@kindex G d @r{(Group)}
 @findex gnus-group-make-directory-group
 @cindex nndir
 Make a directory group (@pxref{Directory Groups}).  You will be prompted
 for the directory's name (@code{gnus-group-make-directory-group}).
 
 @item G h
-@kindex G h (Group)
+@kindex G h @r{(Group)}
 @cindex help group
 @findex gnus-group-make-help-group
 Make the Gnus help group (@code{gnus-group-make-help-group}).
 
 @item G D
-@kindex G D (Group)
+@kindex G D @r{(Group)}
 @findex gnus-group-enter-directory
 @cindex nneething
 Read an arbitrary directory as if it were a newsgroup with the
@@ -2618,7 +2612,7 @@ Read an arbitrary directory as if it were a newsgroup with the
 @xref{Anything Groups}.
 
 @item G f
-@kindex G f (Group)
+@kindex G f @r{(Group)}
 @findex gnus-group-make-doc-group
 @cindex ClariNet Briefs
 @cindex nndoc
@@ -2634,14 +2628,14 @@ you run this command without a prefix, Gnus will guess at the file
 type.  @xref{Document Groups}.
 
 @item G u
-@kindex G u (Group)
+@kindex G u @r{(Group)}
 @vindex gnus-useful-groups
 @findex gnus-group-make-useful-group
 Create one of the groups mentioned in @code{gnus-useful-groups}
 (@code{gnus-group-make-useful-group}).
 
 @item G w
-@kindex G w (Group)
+@kindex G w @r{(Group)}
 @findex gnus-group-make-web-group
 @cindex Google
 @cindex nnweb
@@ -2658,14 +2652,14 @@ to a particular group by using a match string like
 @samp{shaving group:alt.sysadmin.recovery}.
 
 @item G R
-@kindex G R (Group)
+@kindex G R @r{(Group)}
 @findex gnus-group-make-rss-group
 Make a group based on an @acronym{RSS} feed
 (@code{gnus-group-make-rss-group}).  You will be prompted for an URL@.
 @xref{RSS}.
 
-@item G DEL
-@kindex G DEL (Group)
+@item G @key{DEL}
+@kindex G @key{DEL} @r{(Group)}
 @findex gnus-group-delete-group
 This function will delete the current group
 (@code{gnus-group-delete-group}).  If given a prefix, this function will
@@ -2675,13 +2669,13 @@ absolutely sure of what you are doing.  This command can't be used on
 read-only groups (like @code{nntp} groups), though.
 
 @item G V
-@kindex G V (Group)
+@kindex G V @r{(Group)}
 @findex gnus-group-make-empty-virtual
 Make a new, fresh, empty @code{nnvirtual} group
 (@code{gnus-group-make-empty-virtual}).  @xref{Virtual Groups}.
 
 @item G v
-@kindex G v (Group)
+@kindex G v @r{(Group)}
 @findex gnus-group-add-to-virtual
 Add the current group to an @code{nnvirtual} group
 (@code{gnus-group-add-to-virtual}).  Uses the process/prefix convention.
@@ -3260,8 +3254,8 @@ These commands all list various slices of the groups available.
 
 @item l
 @itemx A s
-@kindex A s (Group)
-@kindex l (Group)
+@kindex A s @r{(Group)}
+@kindex l @r{(Group)}
 @findex gnus-group-list-groups
 List all groups that have unread articles
 (@code{gnus-group-list-groups}).  If the numeric prefix is used, this
@@ -3272,8 +3266,8 @@ groups).
 
 @item L
 @itemx A u
-@kindex A u (Group)
-@kindex L (Group)
+@kindex A u @r{(Group)}
+@kindex L @r{(Group)}
 @findex gnus-group-list-all-groups
 List all groups, whether they have unread articles or not
 (@code{gnus-group-list-all-groups}).  If the numeric prefix is used,
@@ -3282,14 +3276,14 @@ it lists groups of level seven or lower (i.e., just subscribed and
 unsubscribed groups).
 
 @item A l
-@kindex A l (Group)
+@kindex A l @r{(Group)}
 @findex gnus-group-list-level
 List all unread groups on a specific level
 (@code{gnus-group-list-level}).  If given a prefix, also list the groups
 with no unread articles.
 
 @item A k
-@kindex A k (Group)
+@kindex A k @r{(Group)}
 @findex gnus-group-list-killed
 List all killed groups (@code{gnus-group-list-killed}).  If given a
 prefix argument, really list all groups that are available, but aren't
@@ -3297,23 +3291,23 @@ currently (un)subscribed.  This could entail reading the active file
 from the server.
 
 @item A z
-@kindex A z (Group)
+@kindex A z @r{(Group)}
 @findex gnus-group-list-zombies
 List all zombie groups (@code{gnus-group-list-zombies}).
 
 @item A m
-@kindex A m (Group)
+@kindex A m @r{(Group)}
 @findex gnus-group-list-matching
 List all unread, subscribed groups with names that match a regexp
 (@code{gnus-group-list-matching}).
 
 @item A M
-@kindex A M (Group)
+@kindex A M @r{(Group)}
 @findex gnus-group-list-all-matching
 List groups that match a regexp (@code{gnus-group-list-all-matching}).
 
 @item A A
-@kindex A A (Group)
+@kindex A A @r{(Group)}
 @findex gnus-group-list-active
 List absolutely all groups in the active file(s) of the
 server(s) you are connected to (@code{gnus-group-list-active}).  This
@@ -3324,34 +3318,34 @@ don't exist (yet)---these will be listed as if they were killed groups.
 Take the output with some grains of salt.
 
 @item A a
-@kindex A a (Group)
+@kindex A a @r{(Group)}
 @findex gnus-group-apropos
 List all groups that have names that match a regexp
 (@code{gnus-group-apropos}).
 
 @item A d
-@kindex A d (Group)
+@kindex A d @r{(Group)}
 @findex gnus-group-description-apropos
 List all groups that have names or descriptions that match a regexp
 (@code{gnus-group-description-apropos}).
 
 @item A c
-@kindex A c (Group)
+@kindex A c @r{(Group)}
 @findex gnus-group-list-cached
 List all groups with cached articles (@code{gnus-group-list-cached}).
 
 @item A ?
-@kindex A ? (Group)
+@kindex A ? @r{(Group)}
 @findex gnus-group-list-dormant
 List all groups with dormant articles (@code{gnus-group-list-dormant}).
 
 @item A !
-@kindex A ! (Group)
+@kindex A ! @r{(Group)}
 @findex gnus-group-list-ticked
 List all groups with ticked articles (@code{gnus-group-list-ticked}).
 
 @item A /
-@kindex A / (Group)
+@kindex A / @r{(Group)}
 @findex gnus-group-list-limit
 Further limit groups within the current selection
 (@code{gnus-group-list-limit}).  If you've first limited to groups
@@ -3361,12 +3355,12 @@ giving you the groups that have both dormant articles and cached
 articles.
 
 @item A f
-@kindex A f (Group)
+@kindex A f @r{(Group)}
 @findex gnus-group-list-flush
 Flush groups from the current selection (@code{gnus-group-list-flush}).
 
 @item A p
-@kindex A p (Group)
+@kindex A p @r{(Group)}
 @findex gnus-group-list-plus
 List groups plus the current selection (@code{gnus-group-list-plus}).
 
@@ -3390,7 +3384,7 @@ groups.  It is @code{t} by default.
 @section Sorting Groups
 @cindex sorting groups
 
-@kindex C-c C-s (Group)
+@kindex C-c C-s @r{(Group)}
 @findex gnus-group-sort-groups
 @vindex gnus-group-sort-function
 The @kbd{C-c C-s} (@code{gnus-group-sort-groups}) command sorts the
@@ -3446,43 +3440,43 @@ some sorting criteria:
 
 @table @kbd
 @item G S a
-@kindex G S a (Group)
+@kindex G S a @r{(Group)}
 @findex gnus-group-sort-groups-by-alphabet
 Sort the group buffer alphabetically by group name
 (@code{gnus-group-sort-groups-by-alphabet}).
 
 @item G S u
-@kindex G S u (Group)
+@kindex G S u @r{(Group)}
 @findex gnus-group-sort-groups-by-unread
 Sort the group buffer by the number of unread articles
 (@code{gnus-group-sort-groups-by-unread}).
 
 @item G S l
-@kindex G S l (Group)
+@kindex G S l @r{(Group)}
 @findex gnus-group-sort-groups-by-level
 Sort the group buffer by group level
 (@code{gnus-group-sort-groups-by-level}).
 
 @item G S v
-@kindex G S v (Group)
+@kindex G S v @r{(Group)}
 @findex gnus-group-sort-groups-by-score
 Sort the group buffer by group score
 (@code{gnus-group-sort-groups-by-score}).  @xref{Group Score}.
 
 @item G S r
-@kindex G S r (Group)
+@kindex G S r @r{(Group)}
 @findex gnus-group-sort-groups-by-rank
 Sort the group buffer by group rank
 (@code{gnus-group-sort-groups-by-rank}).  @xref{Group Score}.
 
 @item G S m
-@kindex G S m (Group)
+@kindex G S m @r{(Group)}
 @findex gnus-group-sort-groups-by-method
 Sort the group buffer alphabetically by back end name@*
 (@code{gnus-group-sort-groups-by-method}).
 
 @item G S n
-@kindex G S n (Group)
+@kindex G S n @r{(Group)}
 @findex gnus-group-sort-groups-by-real-name
 Sort the group buffer alphabetically by real (unprefixed) group name
 (@code{gnus-group-sort-groups-by-real-name}).
@@ -3499,49 +3493,49 @@ You can also sort a subset of the groups:
 
 @table @kbd
 @item G P a
-@kindex G P a (Group)
+@kindex G P a @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-alphabet
 Sort the groups alphabetically by group name
 (@code{gnus-group-sort-selected-groups-by-alphabet}).
 
 @item G P u
-@kindex G P u (Group)
+@kindex G P u @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-unread
 Sort the groups by the number of unread articles
 (@code{gnus-group-sort-selected-groups-by-unread}).
 
 @item G P l
-@kindex G P l (Group)
+@kindex G P l @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-level
 Sort the groups by group level
 (@code{gnus-group-sort-selected-groups-by-level}).
 
 @item G P v
-@kindex G P v (Group)
+@kindex G P v @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-score
 Sort the groups by group score
 (@code{gnus-group-sort-selected-groups-by-score}).  @xref{Group Score}.
 
 @item G P r
-@kindex G P r (Group)
+@kindex G P r @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-rank
 Sort the groups by group rank
 (@code{gnus-group-sort-selected-groups-by-rank}).  @xref{Group Score}.
 
 @item G P m
-@kindex G P m (Group)
+@kindex G P m @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-method
 Sort the groups alphabetically by back end name@*
 (@code{gnus-group-sort-selected-groups-by-method}).
 
 @item G P n
-@kindex G P n (Group)
+@kindex G P n @r{(Group)}
 @findex gnus-group-sort-selected-groups-by-real-name
 Sort the groups alphabetically by real (unprefixed) group name
 (@code{gnus-group-sort-selected-groups-by-real-name}).
 
 @item G P s
-@kindex G P s (Group)
+@kindex G P s @r{(Group)}
 @findex gnus-group-sort-selected-groups
 Sort the groups according to @code{gnus-group-sort-function}.
 
@@ -3557,13 +3551,13 @@ move groups around.
 
 @table @kbd
 @item b
-@kindex b (Group)
+@kindex b @r{(Group)}
 @findex gnus-group-check-bogus-groups
 Find bogus groups and delete them
 (@code{gnus-group-check-bogus-groups}).
 
 @item F
-@kindex F (Group)
+@kindex F @r{(Group)}
 @findex gnus-group-find-new-groups
 Find new groups and process them (@code{gnus-group-find-new-groups}).
 With 1 @kbd{C-u}, use the @code{ask-server} method to query the server
@@ -3572,7 +3566,7 @@ to query the server for new groups, and subscribe the new groups as
 zombies.
 
 @item C-c C-x
-@kindex C-c C-x (Group)
+@kindex C-c C-x @r{(Group)}
 @findex gnus-group-expire-articles
 @cindex expiring mail
 Run all expirable articles in the current group through the expiry
@@ -3581,7 +3575,7 @@ all expirable articles in the group that have been around for a while.
 (@pxref{Expiring Mail}).
 
 @item C-c C-M-x
-@kindex C-c C-M-x (Group)
+@kindex C-c C-M-x @r{(Group)}
 @findex gnus-group-expire-all-groups
 @cindex expiring mail
 Run all expirable articles in all groups through the expiry process
@@ -3597,7 +3591,7 @@ Run all expirable articles in all groups through the expiry process
 
 @table @kbd
 @item B
-@kindex B (Group)
+@kindex B @r{(Group)}
 @findex gnus-group-browse-foreign-server
 You will be queried for a select method and a server name.  Gnus will
 then attempt to contact this server and let you browse the groups there
@@ -3613,28 +3607,28 @@ Here's a list of keystrokes available in the browse mode:
 
 @table @kbd
 @item n
-@kindex n (Browse)
+@kindex n @r{(Browse)}
 @findex gnus-group-next-group
 Go to the next group (@code{gnus-group-next-group}).
 
 @item p
-@kindex p (Browse)
+@kindex p @r{(Browse)}
 @findex gnus-group-prev-group
 Go to the previous group (@code{gnus-group-prev-group}).
 
-@item SPACE
-@kindex SPACE (Browse)
+@item @key{SPC}
+@kindex @key{SPC} @r{(Browse)}
 @findex gnus-browse-read-group
 Enter the current group and display the first article
 (@code{gnus-browse-read-group}).
 
-@item RET
-@kindex RET (Browse)
+@item @key{RET}
+@kindex @key{RET} @r{(Browse)}
 @findex gnus-browse-select-group
 Enter the current group (@code{gnus-browse-select-group}).
 
 @item u
-@kindex u (Browse)
+@kindex u @r{(Browse)}
 @findex gnus-browse-unsubscribe-current-group
 @vindex gnus-browse-subscribe-newsgroup-method
 Unsubscribe to the current group, or, as will be the case here,
@@ -3645,24 +3639,24 @@ using the variable @code{gnus-browse-subscribe-newsgroup-method}.  See
 
 @item l
 @itemx q
-@kindex q (Browse)
-@kindex l (Browse)
+@kindex q @r{(Browse)}
+@kindex l @r{(Browse)}
 @findex gnus-browse-exit
 Exit browse mode (@code{gnus-browse-exit}).
 
 @item d
-@kindex d (Browse)
+@kindex d @r{(Browse)}
 @findex gnus-browse-describe-group
 Describe the current group (@code{gnus-browse-describe-group}).
 
 @item ?
-@kindex ? (Browse)
+@kindex ? @r{(Browse)}
 @findex gnus-browse-describe-briefly
 Describe browse mode briefly (well, there's not much to describe, is
 there) (@code{gnus-browse-describe-briefly}).
 
-@item DEL
-@kindex DEL (Browse)
+@item @key{DEL}
+@kindex @key{DEL} @r{(Browse)}
 @findex gnus-browse-delete-group
 This function will delete the current group
 (@code{gnus-browse-delete-group}).  If given a prefix, this function
@@ -3680,20 +3674,20 @@ Yes, Gnus is ex(c)iting.
 
 @table @kbd
 @item z
-@kindex z (Group)
+@kindex z @r{(Group)}
 @findex gnus-group-suspend
 Suspend Gnus (@code{gnus-group-suspend}).  This doesn't really exit Gnus,
 but it kills all buffers except the Group buffer.  I'm not sure why this
 is a gain, but then who am I to judge?
 
 @item q
-@kindex q (Group)
+@kindex q @r{(Group)}
 @findex gnus-group-exit
 @c @icon{gnus-group-exit}
 Quit Gnus (@code{gnus-group-exit}).
 
 @item Q
-@kindex Q (Group)
+@kindex Q @r{(Group)}
 @findex gnus-group-quit
 Quit Gnus without saving the @file{.newsrc} files (@code{gnus-group-quit}).
 The dribble file will be saved, though (@pxref{Auto Save}).
@@ -3752,7 +3746,7 @@ Gnus
 @end example
 
 @findex gnus-topic-mode
-@kindex t (Group)
+@kindex t @r{(Group)}
 To get this @emph{fab} functionality you simply turn on (ooh!) the
 @code{gnus-topic} minor mode---type @kbd{t} in the group buffer.  (This
 is a toggling command.)
@@ -3801,22 +3795,22 @@ the way you like.
 @table @kbd
 
 @item T n
-@kindex T n (Topic)
+@kindex T n @r{(Topic)}
 @findex gnus-topic-create-topic
 Prompt for a new topic name and create it
 (@code{gnus-topic-create-topic}).
 
-@item T TAB
-@itemx TAB
-@kindex T TAB (Topic)
-@kindex TAB (Topic)
+@item T @key{TAB}
+@itemx @key{TAB}
+@kindex T @key{TAB} @r{(Topic)}
+@kindex @key{TAB} @r{(Topic)}
 @findex gnus-topic-indent
 ``Indent'' the current topic so that it becomes a sub-topic of the
 previous topic (@code{gnus-topic-indent}).  If given a prefix,
 ``un-indent'' the topic instead.
 
-@item M-TAB
-@kindex M-TAB (Topic)
+@item M-@key{TAB}
+@kindex M-@key{TAB} @r{(Topic)}
 @findex gnus-topic-unindent
 ``Un-indent'' the current topic so that it becomes a sub-topic of the
 parent of its current parent (@code{gnus-topic-unindent}).
@@ -3831,13 +3825,13 @@ kill and yank rather than cut and paste.
 @table @kbd
 
 @item C-k
-@kindex C-k (Topic)
+@kindex C-k @r{(Topic)}
 @findex gnus-topic-kill-group
 Kill a group or topic (@code{gnus-topic-kill-group}).  All groups in the
 topic will be removed along with the topic.
 
 @item C-y
-@kindex C-y (Topic)
+@kindex C-y @r{(Topic)}
 @findex gnus-topic-yank-group
 Yank the previously killed group or topic
 (@code{gnus-topic-yank-group}).  Note that all topics will be yanked
@@ -3860,10 +3854,10 @@ key.
 
 @table @kbd
 
-@item RET
-@kindex RET (Topic)
+@item @key{RET}
+@kindex @key{RET} @r{(Topic)}
 @findex gnus-topic-select-group
-@itemx SPACE
+@itemx @key{SPC}
 Either select a group or fold a topic (@code{gnus-topic-select-group}).
 When you perform this command on a group, you'll enter the group, as
 usual.  When done on a topic line, the topic will be folded (if it was
@@ -3878,38 +3872,38 @@ Now for a list of other commands, in no particular order.
 @table @kbd
 
 @item T m
-@kindex T m (Topic)
+@kindex T m @r{(Topic)}
 @findex gnus-topic-move-group
 Move the current group to some other topic
 (@code{gnus-topic-move-group}).  This command uses the process/prefix
 convention (@pxref{Process/Prefix}).
 
 @item T j
-@kindex T j (Topic)
+@kindex T j @r{(Topic)}
 @findex gnus-topic-jump-to-topic
 Go to a topic (@code{gnus-topic-jump-to-topic}).
 
 @item T c
-@kindex T c (Topic)
+@kindex T c @r{(Topic)}
 @findex gnus-topic-copy-group
 Copy the current group to some other topic
 (@code{gnus-topic-copy-group}).  This command uses the process/prefix
 convention (@pxref{Process/Prefix}).
 
 @item T h
-@kindex T h (Topic)
+@kindex T h @r{(Topic)}
 @findex gnus-topic-hide-topic
 Hide the current topic (@code{gnus-topic-hide-topic}).  If given
 a prefix, hide the topic permanently.
 
 @item T s
-@kindex T s (Topic)
+@kindex T s @r{(Topic)}
 @findex gnus-topic-show-topic
 Show the current topic (@code{gnus-topic-show-topic}).  If given
 a prefix, show the topic permanently.
 
 @item T D
-@kindex T D (Topic)
+@kindex T D @r{(Topic)}
 @findex gnus-topic-remove-group
 Remove a group from the current topic (@code{gnus-topic-remove-group}).
 This command is mainly useful if you have the same group in several
@@ -3923,39 +3917,39 @@ This command uses the process/prefix convention
 (@pxref{Process/Prefix}).
 
 @item T M
-@kindex T M (Topic)
+@kindex T M @r{(Topic)}
 @findex gnus-topic-move-matching
 Move all groups that match some regular expression to a topic
 (@code{gnus-topic-move-matching}).
 
 @item T C
-@kindex T C (Topic)
+@kindex T C @r{(Topic)}
 @findex gnus-topic-copy-matching
 Copy all groups that match some regular expression to a topic
 (@code{gnus-topic-copy-matching}).
 
 @item T H
-@kindex T H (Topic)
+@kindex T H @r{(Topic)}
 @findex gnus-topic-toggle-display-empty-topics
 Toggle hiding empty topics
 (@code{gnus-topic-toggle-display-empty-topics}).
 
 @item T #
-@kindex T # (Topic)
+@kindex T # @r{(Topic)}
 @findex gnus-topic-mark-topic
 Mark all groups in the current topic with the process mark
 (@code{gnus-topic-mark-topic}).  This command works recursively on
 sub-topics unless given a prefix.
 
 @item T M-#
-@kindex T M-# (Topic)
+@kindex T M-# @r{(Topic)}
 @findex gnus-topic-unmark-topic
 Remove the process mark from all groups in the current topic
 (@code{gnus-topic-unmark-topic}).  This command works recursively on
 sub-topics unless given a prefix.
 
 @item C-c C-x
-@kindex C-c C-x (Topic)
+@kindex C-c C-x @r{(Topic)}
 @findex gnus-topic-expire-articles
 @cindex expiring mail
 Run all expirable articles in the current group or topic through the
@@ -3963,33 +3957,33 @@ expiry process (if any)
 (@code{gnus-topic-expire-articles}).  (@pxref{Expiring Mail}).
 
 @item T r
-@kindex T r (Topic)
+@kindex T r @r{(Topic)}
 @findex gnus-topic-rename
 Rename a topic (@code{gnus-topic-rename}).
 
-@item T DEL
-@kindex T DEL (Topic)
+@item T @key{DEL}
+@kindex T @key{DEL} @r{(Topic)}
 @findex gnus-topic-delete
 Delete an empty topic (@code{gnus-topic-delete}).
 
 @item A T
-@kindex A T (Topic)
+@kindex A T @r{(Topic)}
 @findex gnus-topic-list-active
 List all groups that Gnus knows about in a topics-ified way
 (@code{gnus-topic-list-active}).
 
 @item T M-n
-@kindex T M-n (Topic)
+@kindex T M-n @r{(Topic)}
 @findex gnus-topic-goto-next-topic
 Go to the next topic (@code{gnus-topic-goto-next-topic}).
 
 @item T M-p
-@kindex T M-p (Topic)
+@kindex T M-p @r{(Topic)}
 @findex gnus-topic-goto-previous-topic
 Go to the previous topic (@code{gnus-topic-goto-previous-topic}).
 
 @item G p
-@kindex G p (Topic)
+@kindex G p @r{(Topic)}
 @findex gnus-topic-edit-parameters
 @cindex group parameters
 @cindex topic parameters
@@ -4052,49 +4046,49 @@ commands:
 
 @table @kbd
 @item T S a
-@kindex T S a (Topic)
+@kindex T S a @r{(Topic)}
 @findex gnus-topic-sort-groups-by-alphabet
 Sort the current topic alphabetically by group name
 (@code{gnus-topic-sort-groups-by-alphabet}).
 
 @item T S u
-@kindex T S u (Topic)
+@kindex T S u @r{(Topic)}
 @findex gnus-topic-sort-groups-by-unread
 Sort the current topic by the number of unread articles
 (@code{gnus-topic-sort-groups-by-unread}).
 
 @item T S l
-@kindex T S l (Topic)
+@kindex T S l @r{(Topic)}
 @findex gnus-topic-sort-groups-by-level
 Sort the current topic by group level
 (@code{gnus-topic-sort-groups-by-level}).
 
 @item T S v
-@kindex T S v (Topic)
+@kindex T S v @r{(Topic)}
 @findex gnus-topic-sort-groups-by-score
 Sort the current topic by group score
 (@code{gnus-topic-sort-groups-by-score}).  @xref{Group Score}.
 
 @item T S r
-@kindex T S r (Topic)
+@kindex T S r @r{(Topic)}
 @findex gnus-topic-sort-groups-by-rank
 Sort the current topic by group rank
 (@code{gnus-topic-sort-groups-by-rank}).  @xref{Group Score}.
 
 @item T S m
-@kindex T S m (Topic)
+@kindex T S m @r{(Topic)}
 @findex gnus-topic-sort-groups-by-method
 Sort the current topic alphabetically by back end name
 (@code{gnus-topic-sort-groups-by-method}).
 
 @item T S e
-@kindex T S e (Topic)
+@kindex T S e @r{(Topic)}
 @findex gnus-topic-sort-groups-by-server
 Sort the current topic alphabetically by server name
 (@code{gnus-topic-sort-groups-by-server}).
 
 @item T S s
-@kindex T S s (Topic)
+@kindex T S s @r{(Topic)}
 @findex gnus-topic-sort-groups
 Sort the current topic according to the function(s) given by the
 @code{gnus-group-sort-function} variable
@@ -4369,7 +4363,7 @@ header will be displayed incorrectly in the article buffer.
 @table @kbd
 
 @item v
-@kindex v (Group)
+@kindex v @r{(Group)}
 @cindex keys, reserved for users (Group)
 The key @kbd{v} is reserved for users.  You can bind it to some
 command or better use it as a prefix key.  For example:
@@ -4385,13 +4379,13 @@ On keys reserved for users in Emacs and on keybindings in general
 @xref{Keymaps, Keymaps, , emacs, The Emacs Editor}.
 
 @item ^
-@kindex ^ (Group)
+@kindex ^ @r{(Group)}
 @findex gnus-group-enter-server-mode
 Enter the server buffer (@code{gnus-group-enter-server-mode}).
 @xref{Server Buffer}.
 
 @item a
-@kindex a (Group)
+@kindex a @r{(Group)}
 @findex gnus-group-post-news
 Start composing a message (a news by default)
 (@code{gnus-group-post-news}).  If given a prefix, post to the group
@@ -4401,7 +4395,7 @@ article might be a mail instead of a news, if a mail group is specified
 with the prefix argument.  @xref{Composing Messages}.
 
 @item m
-@kindex m (Group)
+@kindex m @r{(Group)}
 @findex gnus-group-mail
 Mail a message somewhere (@code{gnus-group-mail}).  If given a prefix,
 use the posting style of the group under the point.  If the prefix is 1,
@@ -4409,7 +4403,7 @@ prompt for a group name to find the posting style.
 @xref{Composing Messages}.
 
 @item i
-@kindex i (Group)
+@kindex i @r{(Group)}
 @findex gnus-group-news
 Start composing a news (@code{gnus-group-news}).  If given a prefix,
 post to the group under the point.  If the prefix is 1, prompt
@@ -4422,7 +4416,7 @@ in question.  The corresponding back end must have a request-post method
 for this to work though.
 
 @item G z
-@kindex G z (Group)
+@kindex G z @r{(Group)}
 @findex gnus-group-compact-group
 
 Compact the group under point (@code{gnus-group-compact-group}).
@@ -4467,7 +4461,7 @@ whether they are empty or not.
 @table @kbd
 
 @item g
-@kindex g (Group)
+@kindex g @r{(Group)}
 @findex gnus-group-get-new-news
 @c @icon{gnus-group-get-new-news}
 Check the server(s) for new articles.  If the numerical prefix is used,
@@ -4477,7 +4471,7 @@ command will force a total re-reading of the active file(s) from the
 back end(s).
 
 @item M-g
-@kindex M-g (Group)
+@kindex M-g @r{(Group)}
 @findex gnus-group-get-new-news-this-group
 @vindex gnus-goto-next-group-when-activating
 @c @icon{gnus-group-get-new-news-this-group}
@@ -4489,11 +4483,11 @@ to move point to the next group or not.  It is @code{t} by default.
 @findex gnus-activate-all-groups
 @cindex activating groups
 @item C-c M-g
-@kindex C-c M-g (Group)
+@kindex C-c M-g @r{(Group)}
 Activate absolutely all groups (@code{gnus-activate-all-groups}).
 
 @item R
-@kindex R (Group)
+@kindex R @r{(Group)}
 @cindex restarting
 @findex gnus-group-restart
 Restart Gnus (@code{gnus-group-restart}).  This saves the @file{.newsrc}
@@ -4521,8 +4515,8 @@ news.
 @item H d
 @itemx C-c C-d
 @c @icon{gnus-group-describe-group}
-@kindex H d (Group)
-@kindex C-c C-d (Group)
+@kindex H d @r{(Group)}
+@kindex C-c C-d @r{(Group)}
 @cindex describing groups
 @cindex group description
 @findex gnus-group-describe-group
@@ -4530,26 +4524,26 @@ Describe the current group (@code{gnus-group-describe-group}).  If given
 a prefix, force Gnus to re-read the description from the server.
 
 @item M-d
-@kindex M-d (Group)
+@kindex M-d @r{(Group)}
 @findex gnus-group-describe-all-groups
 Describe all groups (@code{gnus-group-describe-all-groups}).  If given a
 prefix, force Gnus to re-read the description file from the server.
 
 @item H v
 @itemx V
-@kindex V (Group)
-@kindex H v (Group)
+@kindex V @r{(Group)}
+@kindex H v @r{(Group)}
 @cindex version
 @findex gnus-version
 Display current Gnus version numbers (@code{gnus-version}).
 
 @item ?
-@kindex ? (Group)
+@kindex ? @r{(Group)}
 @findex gnus-group-describe-briefly
 Give a very short help message (@code{gnus-group-describe-briefly}).
 
 @item C-c C-i
-@kindex C-c C-i (Group)
+@kindex C-c C-i @r{(Group)}
 @cindex info
 @cindex manual
 @findex gnus-info-find-node
@@ -4623,7 +4617,7 @@ either.
 @table @kbd
 
 @item r
-@kindex r (Group)
+@kindex r @r{(Group)}
 @findex gnus-group-read-init-file
 @vindex gnus-init-file
 @cindex reading init file
@@ -4631,7 +4625,7 @@ Re-read the init file (@code{gnus-init-file}, which defaults to
 @file{~/.gnus.el}) (@code{gnus-group-read-init-file}).
 
 @item s
-@kindex s (Group)
+@kindex s @r{(Group)}
 @findex gnus-group-save-newsrc
 @cindex saving .newsrc
 Save the @file{.newsrc.eld} file (and @file{.newsrc} if wanted)
@@ -4639,7 +4633,7 @@ Save the @file{.newsrc.eld} file (and @file{.newsrc} if wanted)
 file(s) whether Gnus thinks it is necessary or not.
 
 @c @item Z
-@c @kindex Z (Group)
+@c @kindex Z @r{(Group)}
 @c @findex gnus-group-clear-dribble
 @c Clear the dribble buffer (@code{gnus-group-clear-dribble}).
 
@@ -4689,7 +4683,7 @@ if address "sender" "owner-ding@@hpc.uh.edu" @{
 @table @kbd
 
 @item D g
-@kindex D g (Group)
+@kindex D g @r{(Group)}
 @findex gnus-sieve-generate
 @vindex gnus-sieve-file
 @cindex generating sieve script
@@ -4697,7 +4691,7 @@ Regenerate a Sieve script from the @code{sieve} group parameters and
 put you into the @code{gnus-sieve-file} without saving it.
 
 @item D u
-@kindex D u (Group)
+@kindex D u @r{(Group)}
 @findex gnus-sieve-update
 @vindex gnus-sieve-file
 @cindex updating sieve script
@@ -4721,10 +4715,10 @@ group buffer (@pxref{Selecting a Group}).
 You can have as many summary buffers open as you wish.
 
 You can customize the Summary Mode tool bar, see @kbd{M-x
-customize-apropos RET gnus-summary-tool-bar}.  This feature is only
+customize-apropos @key{RET} gnus-summary-tool-bar}.  This feature is only
 available in Emacs.
 
-@kindex v (Summary)
+@kindex v @r{(Summary)}
 @cindex keys, reserved for users (Summary)
 The key @kbd{v} is reserved for users.  You can bind it to some
 command or better use it as a prefix key.  For example:
@@ -5204,22 +5198,22 @@ None of these commands select articles.
 @table @kbd
 @item G M-n
 @itemx M-n
-@kindex M-n (Summary)
-@kindex G M-n (Summary)
+@kindex M-n @r{(Summary)}
+@kindex G M-n @r{(Summary)}
 @findex gnus-summary-next-unread-subject
 Go to the next summary line of an unread article
 (@code{gnus-summary-next-unread-subject}).
 
 @item G M-p
 @itemx M-p
-@kindex M-p (Summary)
-@kindex G M-p (Summary)
+@kindex M-p @r{(Summary)}
+@kindex G M-p @r{(Summary)}
 @findex gnus-summary-prev-unread-subject
 Go to the previous summary line of an unread article
 (@code{gnus-summary-prev-unread-subject}).
 
 @item G g
-@kindex G g (Summary)
+@kindex G g @r{(Summary)}
 @findex gnus-summary-goto-subject
 Ask for an article number and then go to the summary line of that article
 without displaying the article (@code{gnus-summary-goto-subject}).
@@ -5281,7 +5275,7 @@ the given number of lines from the top.
 @item gnus-summary-stop-at-end-of-message
 @vindex gnus-summary-stop-at-end-of-message
 If non-@code{nil}, don't go to the next article when hitting
-@kbd{SPC}, and you're at the end of the article.
+@kbd{@key{SPC}}, and you're at the end of the article.
 
 @end table
 
@@ -5306,69 +5300,69 @@ If you want to fetch new articles or redisplay the group, see
 @ref{Exiting the Summary Buffer}.
 
 @table @kbd
-@item SPACE
-@kindex SPACE (Summary)
+@item @key{SPC}
+@kindex @key{SPC} @r{(Summary)}
 @findex gnus-summary-next-page
 Select the current article, or, if that one's read already, the next
 unread article (@code{gnus-summary-next-page}).
 
-If you have an article window open already and you press @kbd{SPACE}
+If you have an article window open already and you press @kbd{@key{SPC}}
 again, the article will be scrolled.  This lets you conveniently
-@kbd{SPACE} through an entire newsgroup.  @xref{Paging the Article}.
+@kbd{@key{SPC}} through an entire newsgroup.  @xref{Paging the Article}.
 
 @item G n
 @itemx n
-@kindex n (Summary)
-@kindex G n (Summary)
+@kindex n @r{(Summary)}
+@kindex G n @r{(Summary)}
 @findex gnus-summary-next-unread-article
 @c @icon{gnus-summary-next-unread}
 Go to next unread article (@code{gnus-summary-next-unread-article}).
 
 @item G p
 @itemx p
-@kindex p (Summary)
+@kindex p @r{(Summary)}
 @findex gnus-summary-prev-unread-article
 @c @icon{gnus-summary-prev-unread}
 Go to previous unread article (@code{gnus-summary-prev-unread-article}).
 
 @item G N
 @itemx N
-@kindex N (Summary)
-@kindex G N (Summary)
+@kindex N @r{(Summary)}
+@kindex G N @r{(Summary)}
 @findex gnus-summary-next-article
 Go to the next article (@code{gnus-summary-next-article}).
 
 @item G P
 @itemx P
-@kindex P (Summary)
-@kindex G P (Summary)
+@kindex P @r{(Summary)}
+@kindex G P @r{(Summary)}
 @findex gnus-summary-prev-article
 Go to the previous article (@code{gnus-summary-prev-article}).
 
 @item G C-n
-@kindex G C-n (Summary)
+@kindex G C-n @r{(Summary)}
 @findex gnus-summary-next-same-subject
 Go to the next article with the same subject
 (@code{gnus-summary-next-same-subject}).
 
 @item G C-p
-@kindex G C-p (Summary)
+@kindex G C-p @r{(Summary)}
 @findex gnus-summary-prev-same-subject
 Go to the previous article with the same subject
 (@code{gnus-summary-prev-same-subject}).
 
 @item G f
 @itemx .
-@kindex G f  (Summary)
-@kindex .  (Summary)
+@kindex G f  @r{(Summary)}
+@kindex .  @r{(Summary)}
 @findex gnus-summary-first-unread-article
 Go to the first unread article
 (@code{gnus-summary-first-unread-article}).
 
 @item G b
 @itemx ,
-@kindex G b (Summary)
-@kindex , (Summary)
+@kindex G b @r{(Summary)}
+@kindex , @r{(Summary)}
 @findex gnus-summary-best-unread-article
 Go to the unread article with the highest score
 (@code{gnus-summary-best-unread-article}).  If given a prefix argument,
@@ -5376,13 +5370,13 @@ go to the first unread article that has a score over the default score.
 
 @item G l
 @itemx l
-@kindex l (Summary)
-@kindex G l (Summary)
+@kindex l @r{(Summary)}
+@kindex G l @r{(Summary)}
 @findex gnus-summary-goto-last-article
 Go to the previous article read (@code{gnus-summary-goto-last-article}).
 
 @item G o
-@kindex G o (Summary)
+@kindex G o @r{(Summary)}
 @findex gnus-summary-pop-article
 @cindex history
 @cindex article history
@@ -5395,8 +5389,8 @@ For a somewhat related issue (if you use these commands a lot),
 
 @item G j
 @itemx j
-@kindex j (Summary)
-@kindex G j (Summary)
+@kindex j @r{(Summary)}
+@kindex G j @r{(Summary)}
 @findex gnus-summary-goto-article
 Ask for an article number or @code{Message-ID}, and then go to that
 article (@code{gnus-summary-goto-article}).
@@ -5448,10 +5442,10 @@ instead.  It will leave marks like @code{gnus-low-score-mark},
 
 @table @kbd
 
-@item SPACE
-@kindex SPACE (Summary)
+@item @key{SPC}
+@kindex @key{SPC} @r{(Summary)}
 @findex gnus-summary-next-page
-Pressing @kbd{SPACE} will scroll the current article forward one page,
+Pressing @kbd{@key{SPC}} will scroll the current article forward one page,
 or, if you have come to the end of the current article, will choose the
 next article (@code{gnus-summary-next-page}).
 
@@ -5464,27 +5458,27 @@ what is considered uninteresting with
 @code{gnus-article-boring-faces}.  You can manually view the article's
 pages, no matter how boring, using @kbd{C-M-v}.
 
-@item DEL
-@kindex DEL (Summary)
+@item @key{DEL}
+@kindex @key{DEL} @r{(Summary)}
 @findex gnus-summary-prev-page
 Scroll the current article back one page (@code{gnus-summary-prev-page}).
 
-@item RET
-@kindex RET (Summary)
+@item @key{RET}
+@kindex @key{RET} @r{(Summary)}
 @findex gnus-summary-scroll-up
 Scroll the current article one line forward
 (@code{gnus-summary-scroll-up}).
 
-@item M-RET
-@kindex M-RET (Summary)
+@item M-@key{RET}
+@kindex M-@key{RET} @r{(Summary)}
 @findex gnus-summary-scroll-down
 Scroll the current article one line backward
 (@code{gnus-summary-scroll-down}).
 
 @item A g
 @itemx g
-@kindex A g (Summary)
-@kindex g (Summary)
+@kindex A g @r{(Summary)}
+@kindex g @r{(Summary)}
 @findex gnus-summary-show-article
 @vindex gnus-summary-show-article-charset-alist
 (Re)fetch the current article (@code{gnus-summary-show-article}).  If
@@ -5495,7 +5489,7 @@ treatment functions.
 
 @cindex charset, view article with different charset
 If given a numerical prefix, you can do semi-manual charset stuff.
-@kbd{C-u 0 g cn-gb-2312 RET} will decode the message as if it were
+@kbd{C-u 0 g cn-gb-2312 @key{RET}} will decode the message as if it were
 encoded in the @code{cn-gb-2312} charset.  If you have
 
 @lisp
@@ -5508,29 +5502,29 @@ then you can say @kbd{C-u 1 g} to get the same effect.
 
 @item A <
 @itemx <
-@kindex < (Summary)
-@kindex A < (Summary)
+@kindex < @r{(Summary)}
+@kindex A < @r{(Summary)}
 @findex gnus-summary-beginning-of-article
 Scroll to the beginning of the article
 (@code{gnus-summary-beginning-of-article}).
 
 @item A >
 @itemx >
-@kindex > (Summary)
-@kindex A > (Summary)
+@kindex > @r{(Summary)}
+@kindex A > @r{(Summary)}
 @findex gnus-summary-end-of-article
 Scroll to the end of the article (@code{gnus-summary-end-of-article}).
 
 @item A s
 @itemx s
-@kindex A s (Summary)
-@kindex s (Summary)
+@kindex A s @r{(Summary)}
+@kindex s @r{(Summary)}
 @findex gnus-summary-isearch-article
 Perform an isearch in the article buffer
 (@code{gnus-summary-isearch-article}).
 
 @item h
-@kindex h (Summary)
+@kindex h @r{(Summary)}
 @findex gnus-summary-select-article-buffer
 Select the article buffer (@code{gnus-summary-select-article-buffer}).
 
@@ -5559,8 +5553,8 @@ Commands for composing a mail message:
 
 @item S r
 @itemx r
-@kindex S r (Summary)
-@kindex r (Summary)
+@kindex S r @r{(Summary)}
+@kindex r @r{(Summary)}
 @findex gnus-summary-reply
 @c @icon{gnus-summary-mail-reply}
 @c @icon{gnus-summary-reply}
@@ -5569,8 +5563,8 @@ Mail a reply to the author of the current article
 
 @item S R
 @itemx R
-@kindex R (Summary)
-@kindex S R (Summary)
+@kindex R @r{(Summary)}
+@kindex S R @r{(Summary)}
 @findex gnus-summary-reply-with-original
 @c @icon{gnus-summary-reply-with-original}
 Mail a reply to the author of the current article and include the
@@ -5578,7 +5572,7 @@ original message (@code{gnus-summary-reply-with-original}).  This
 command uses the process/prefix convention.
 
 @item S w
-@kindex S w (Summary)
+@kindex S w @r{(Summary)}
 @findex gnus-summary-wide-reply
 Mail a wide reply to the author of the current article
 (@code{gnus-summary-wide-reply}).  A @dfn{wide reply} is a reply that
@@ -5587,7 +5581,7 @@ goes out to all people listed in the @code{To}, @code{From} (or
 present, that's used instead.
 
 @item S W
-@kindex S W (Summary)
+@kindex S W @r{(Summary)}
 @findex gnus-summary-wide-reply-with-original
 Mail a wide reply to the current article and include the original
 message (@code{gnus-summary-wide-reply-with-original}).  This command uses
@@ -5595,14 +5589,14 @@ the process/prefix convention, but only uses the headers from the
 first article to determine the recipients.
 
 @item S L
-@kindex S L (Summary)
+@kindex S L @r{(Summary)}
 @findex gnus-summary-reply-to-list-with-original
 When replying to a message from a mailing list, send a reply to that
 message to the mailing list, and include the original message
 (@code{gnus-summary-reply-to-list-with-original}).
 
 @item S v
-@kindex S v (Summary)
+@kindex S v @r{(Summary)}
 @findex gnus-summary-very-wide-reply
 Mail a very wide reply to the author of the current article
 (@code{gnus-summary-wide-reply}).  A @dfn{very wide reply} is a reply
@@ -5611,14 +5605,14 @@ that goes out to all people listed in the @code{To}, @code{From} (or
 articles.  This command uses the process/prefix convention.
 
 @item S V
-@kindex S V (Summary)
+@kindex S V @r{(Summary)}
 @findex gnus-summary-very-wide-reply-with-original
 Mail a very wide reply to the author of the current article and include the
 original message (@code{gnus-summary-very-wide-reply-with-original}).  This
 command uses the process/prefix convention.
 
 @item S B r
-@kindex S B r (Summary)
+@kindex S B r @r{(Summary)}
 @findex gnus-summary-reply-broken-reply-to
 Mail a reply to the author of the current article but ignore the
 @code{Reply-To} field (@code{gnus-summary-reply-broken-reply-to}).
@@ -5628,7 +5622,7 @@ the @code{broken-reply-to} group parameter instead, so things will work
 correctly.  @xref{Group Parameters}.
 
 @item S B R
-@kindex S B R (Summary)
+@kindex S B R @r{(Summary)}
 @findex gnus-summary-reply-broken-reply-to-with-original
 Mail a reply to the author of the current article and include the
 original message but ignore the @code{Reply-To} field
@@ -5636,8 +5630,8 @@ original message but ignore the @code{Reply-To} field
 
 @item S o m
 @itemx C-c C-f
-@kindex S o m (Summary)
-@kindex C-c C-f (Summary)
+@kindex S o m @r{(Summary)}
+@kindex C-c C-f @r{(Summary)}
 @findex gnus-summary-mail-forward
 @c @icon{gnus-summary-mail-forward}
 Forward the current article to some other person
@@ -5654,8 +5648,8 @@ section.
 
 @item S m
 @itemx m
-@kindex m (Summary)
-@kindex S m (Summary)
+@kindex m @r{(Summary)}
+@kindex S m @r{(Summary)}
 @findex gnus-summary-mail-other-window
 @c @icon{gnus-summary-mail-originate}
 Prepare a mail (@code{gnus-summary-mail-other-window}).  By default, use
@@ -5663,7 +5657,7 @@ the posting style of the current group.  If given a prefix, disable that.
 If the prefix is 1, prompt for a group name to find the posting style.
 
 @item S i
-@kindex S i (Summary)
+@kindex S i @r{(Summary)}
 @findex gnus-summary-news-other-window
 Prepare a news (@code{gnus-summary-news-other-window}).  By default,
 post to the current group.  If given a prefix, disable that.  If the
@@ -5676,7 +5670,7 @@ in question.  The corresponding back end must have a request-post method
 for this to work though.
 
 @item S D b
-@kindex S D b (Summary)
+@kindex S D b @r{(Summary)}
 @findex gnus-summary-resend-bounced-mail
 @cindex bouncing mail
 If you have sent a mail, but the mail was bounced back to you for some
@@ -5689,7 +5683,7 @@ that mail and display it for easy perusal of its headers.  This might
 very well fail, though.
 
 @item S D r
-@kindex S D r (Summary)
+@kindex S D r @r{(Summary)}
 @findex gnus-summary-resend-message
 Not to be confused with the previous command,
 @code{gnus-summary-resend-message} will prompt you for an address to
@@ -5710,21 +5704,21 @@ This command understands the process/prefix convention
 (@pxref{Process/Prefix}).
 
 @item S D e
-@kindex S D e (Summary)
+@kindex S D e @r{(Summary)}
 @findex gnus-summary-resend-message-edit
 
 Like the previous command, but will allow you to edit the message as
 if it were a new message before resending.
 
 @item S O m
-@kindex S O m (Summary)
+@kindex S O m @r{(Summary)}
 @findex gnus-uu-digest-mail-forward
 Digest the current series (@pxref{Decoding Articles}) and forward the
 result using mail (@code{gnus-uu-digest-mail-forward}).  This command
 uses the process/prefix convention (@pxref{Process/Prefix}).
 
 @item S M-c
-@kindex S M-c (Summary)
+@kindex S M-c @r{(Summary)}
 @findex gnus-summary-mail-crosspost-complaint
 @cindex crossposting
 @cindex excessive crossposting
@@ -5754,8 +5748,8 @@ Commands for posting a news article:
 @table @kbd
 @item S p
 @itemx a
-@kindex a (Summary)
-@kindex S p (Summary)
+@kindex a @r{(Summary)}
+@kindex S p @r{(Summary)}
 @findex gnus-summary-post-news
 @c @icon{gnus-summary-post-news}
 Prepare for posting an article (@code{gnus-summary-post-news}).  By
@@ -5764,16 +5758,16 @@ If the prefix is 1, prompt for another group instead.
 
 @item S f
 @itemx f
-@kindex f (Summary)
-@kindex S f (Summary)
+@kindex f @r{(Summary)}
+@kindex S f @r{(Summary)}
 @findex gnus-summary-followup
 @c @icon{gnus-summary-followup}
 Post a followup to the current article (@code{gnus-summary-followup}).
 
 @item S F
 @itemx F
-@kindex S F (Summary)
-@kindex F (Summary)
+@kindex S F @r{(Summary)}
+@kindex F @r{(Summary)}
 @c @icon{gnus-summary-followup-with-original}
 @findex gnus-summary-followup-with-original
 Post a followup to the current article and include the original message
@@ -5781,13 +5775,13 @@ Post a followup to the current article and include the original message
 process/prefix convention.
 
 @item S n
-@kindex S n (Summary)
+@kindex S n @r{(Summary)}
 @findex gnus-summary-followup-to-mail
 Post a followup to the current article via news, even if you got the
 message through mail (@code{gnus-summary-followup-to-mail}).
 
 @item S N
-@kindex S N (Summary)
+@kindex S N @r{(Summary)}
 @findex gnus-summary-followup-to-mail-with-original
 Post a followup to the current article via news, even if you got the
 message through mail and include the original message
@@ -5795,7 +5789,7 @@ message through mail and include the original message
 the process/prefix convention.
 
 @item S o p
-@kindex S o p (Summary)
+@kindex S o p @r{(Summary)}
 @findex gnus-summary-post-forward
 Forward the current article to a newsgroup
 (@code{gnus-summary-post-forward}).
@@ -5810,7 +5804,7 @@ but use the flipped value of (@code{message-forward-as-mime}).  By
 default, the message is decoded and forwarded as an rfc822 @acronym{MIME} section.
 
 @item S O p
-@kindex S O p (Summary)
+@kindex S O p @r{(Summary)}
 @findex gnus-uu-digest-post-forward
 @cindex digests
 @cindex making digests
@@ -5819,7 +5813,7 @@ Digest the current series and forward the result to a newsgroup
 process/prefix convention.
 
 @item S u
-@kindex S u (Summary)
+@kindex S u @r{(Summary)}
 @findex gnus-uu-post-news
 @c @icon{gnus-uu-post-news}
 Uuencode a file, split it into parts, and post it as a series
@@ -5835,7 +5829,7 @@ Manual}, for more information.
 
 @table @kbd
 @item S y
-@kindex S y (Summary)
+@kindex S y @r{(Summary)}
 @findex gnus-summary-yank-message
 Yank the current article into an already existing Message composition
 buffer (@code{gnus-summary-yank-message}).  This command prompts for
@@ -5856,7 +5850,7 @@ really, really wish you hadn't posted that?
 Well, you can't cancel mail, but you can cancel posts.
 
 @findex gnus-summary-cancel-article
-@kindex C (Summary)
+@kindex C @r{(Summary)}
 @c @icon{gnus-summary-cancel-article}
 Find the article you wish to cancel (you can only cancel your own
 articles, so don't try any funny stuff).  Then press @kbd{C} or @kbd{S
@@ -5881,7 +5875,7 @@ corrections, you can post a @dfn{superseding} article that will replace
 your original article.
 
 @findex gnus-summary-supersede-article
-@kindex S (Summary)
+@kindex S @r{(Summary)}
 Go to the original article and press @kbd{S s}
 (@code{gnus-summary-supersede-article}).  You will be put in a buffer
 where you can edit the article all you want before sending it off the
@@ -6064,7 +6058,7 @@ followups, you can use the @kbd{/ D} command (@pxref{Limiting}).
 Otherwise (except for the visibility issue), they are just like ticked
 messages.
 
-@item SPACE
+@item @key{SPC}
 @vindex gnus-unread-mark
 Marked as unread (@code{gnus-unread-mark}).
 
@@ -6248,8 +6242,8 @@ All the marking commands understand the numeric prefix.
 @table @kbd
 @item M c
 @itemx M-u
-@kindex M c (Summary)
-@kindex M-u (Summary)
+@kindex M c @r{(Summary)}
+@kindex M-u @r{(Summary)}
 @findex gnus-summary-clear-mark-forward
 @cindex mark as unread
 Clear all readedness-marks from the current article
@@ -6258,38 +6252,38 @@ article as unread.
 
 @item M t
 @itemx !
-@kindex ! (Summary)
-@kindex M t (Summary)
+@kindex ! @r{(Summary)}
+@kindex M t @r{(Summary)}
 @findex gnus-summary-tick-article-forward
 Tick the current article (@code{gnus-summary-tick-article-forward}).
 @xref{Article Caching}.
 
 @item M ?
 @itemx ?
-@kindex ? (Summary)
-@kindex M ? (Summary)
+@kindex ? @r{(Summary)}
+@kindex M ? @r{(Summary)}
 @findex gnus-summary-mark-as-dormant
 Mark the current article as dormant
 (@code{gnus-summary-mark-as-dormant}).  @xref{Article Caching}.
 
 @item M d
 @itemx d
-@kindex M d (Summary)
-@kindex d (Summary)
+@kindex M d @r{(Summary)}
+@kindex d @r{(Summary)}
 @findex gnus-summary-mark-as-read-forward
 Mark the current article as read
 (@code{gnus-summary-mark-as-read-forward}).
 
 @item D
-@kindex D (Summary)
+@kindex D @r{(Summary)}
 @findex gnus-summary-mark-as-read-backward
 Mark the current article as read and move point to the previous line
 (@code{gnus-summary-mark-as-read-backward}).
 
 @item M k
 @itemx k
-@kindex k (Summary)
-@kindex M k (Summary)
+@kindex k @r{(Summary)}
+@kindex M k @r{(Summary)}
 @findex gnus-summary-kill-same-subject-and-select
 Mark all articles that have the same subject as the current one as read,
 and then select the next unread article
@@ -6297,82 +6291,82 @@ and then select the next unread article
 
 @item M K
 @itemx C-k
-@kindex M K (Summary)
-@kindex C-k (Summary)
+@kindex M K @r{(Summary)}
+@kindex C-k @r{(Summary)}
 @findex gnus-summary-kill-same-subject
 Mark all articles that have the same subject as the current one as read
 (@code{gnus-summary-kill-same-subject}).
 
 @item M C
-@kindex M C (Summary)
+@kindex M C @r{(Summary)}
 @findex gnus-summary-catchup
 @c @icon{gnus-summary-catchup}
 Mark all unread articles as read (@code{gnus-summary-catchup}).
 
 @item M C-c
-@kindex M C-c (Summary)
+@kindex M C-c @r{(Summary)}
 @findex gnus-summary-catchup-all
 Mark all articles in the group as read---even the ticked and dormant
 articles (@code{gnus-summary-catchup-all}).
 
 @item M H
-@kindex M H (Summary)
+@kindex M H @r{(Summary)}
 @findex gnus-summary-catchup-to-here
 Catchup the current group to point (before the point)
 (@code{gnus-summary-catchup-to-here}).
 
 @item M h
-@kindex M h (Summary)
+@kindex M h @r{(Summary)}
 @findex gnus-summary-catchup-from-here
 Catchup the current group from point (after the point)
 (@code{gnus-summary-catchup-from-here}).
 
 @item C-w
-@kindex C-w (Summary)
+@kindex C-w @r{(Summary)}
 @findex gnus-summary-mark-region-as-read
 Mark all articles between point and mark as read
 (@code{gnus-summary-mark-region-as-read}).
 
 @item M V k
-@kindex M V k (Summary)
+@kindex M V k @r{(Summary)}
 @findex gnus-summary-kill-below
 Kill all articles with scores below the default score (or below the
 numeric prefix) (@code{gnus-summary-kill-below}).
 
 @item M e
 @itemx E
-@kindex M e (Summary)
-@kindex E (Summary)
+@kindex M e @r{(Summary)}
+@kindex E @r{(Summary)}
 @findex gnus-summary-mark-as-expirable
 Mark the current article as expirable
 (@code{gnus-summary-mark-as-expirable}).
 
 @item M b
-@kindex M b (Summary)
+@kindex M b @r{(Summary)}
 @findex gnus-summary-set-bookmark
 Set a bookmark in the current article
 (@code{gnus-summary-set-bookmark}).
 
 @item M B
-@kindex M B (Summary)
+@kindex M B @r{(Summary)}
 @findex gnus-summary-remove-bookmark
 Remove the bookmark from the current article
 (@code{gnus-summary-remove-bookmark}).
 
 @item M V c
-@kindex M V c (Summary)
+@kindex M V c @r{(Summary)}
 @findex gnus-summary-clear-above
 Clear all marks from articles with scores over the default score (or
 over the numeric prefix) (@code{gnus-summary-clear-above}).
 
 @item M V u
-@kindex M V u (Summary)
+@kindex M V u @r{(Summary)}
 @findex gnus-summary-tick-above
 Tick all articles with scores over the default score (or over the
 numeric prefix) (@code{gnus-summary-tick-above}).
 
 @item M V m
-@kindex M V m (Summary)
+@kindex M V m @r{(Summary)}
 @findex gnus-summary-mark-above
 Prompt for a mark, and mark all articles with scores over the default
 score (or over the numeric prefix) with this mark
@@ -6385,7 +6379,7 @@ be taken after setting a mark.  If non-@code{nil}, point will move to
 the next/previous unread article.  If @code{nil}, point will just move
 one line up or down.  As a special case, if this variable is
 @code{never}, all the marking commands as well as other commands (like
-@kbd{SPACE}) will move to the next article, whether it is unread or not.
+@kbd{@key{SPC}}) will move to the next article, whether it is unread or not.
 The default is @code{t}.
 
 
@@ -6445,8 +6439,8 @@ articles into the cache.  For more information,
 
 @item M P p
 @itemx #
-@kindex # (Summary)
-@kindex M P p (Summary)
+@kindex # @r{(Summary)}
+@kindex M P p @r{(Summary)}
 @findex gnus-summary-mark-as-processable
 Mark the current article with the process mark
 (@code{gnus-summary-mark-as-processable}).
@@ -6454,99 +6448,99 @@ Mark the current article with the process mark
 
 @item M P u
 @itemx M-#
-@kindex M P u (Summary)
-@kindex M-# (Summary)
+@kindex M P u @r{(Summary)}
+@kindex M-# @r{(Summary)}
 Remove the process mark, if any, from the current article
 (@code{gnus-summary-unmark-as-processable}).
 
 @item M P U
-@kindex M P U (Summary)
+@kindex M P U @r{(Summary)}
 @findex gnus-summary-unmark-all-processable
 Remove the process mark from all articles
 (@code{gnus-summary-unmark-all-processable}).
 
 @item M P i
-@kindex M P i (Summary)
+@kindex M P i @r{(Summary)}
 @findex gnus-uu-invert-processable
 Invert the list of process marked articles
 (@code{gnus-uu-invert-processable}).
 
 @item M P R
-@kindex M P R (Summary)
+@kindex M P R @r{(Summary)}
 @findex gnus-uu-mark-by-regexp
 Mark articles that have a @code{Subject} header that matches a regular
 expression (@code{gnus-uu-mark-by-regexp}).
 
 @item M P G
-@kindex M P G (Summary)
+@kindex M P G @r{(Summary)}
 @findex gnus-uu-unmark-by-regexp
 Unmark articles that have a @code{Subject} header that matches a regular
 expression (@code{gnus-uu-unmark-by-regexp}).
 
 @item M P r
-@kindex M P r (Summary)
+@kindex M P r @r{(Summary)}
 @findex gnus-uu-mark-region
 Mark articles in region (@code{gnus-uu-mark-region}).
 
 @item M P g
-@kindex M P g (Summary)
+@kindex M P g @r{(Summary)}
 @findex gnus-uu-unmark-region
 Unmark articles in region (@code{gnus-uu-unmark-region}).
 
 @item M P t
-@kindex M P t (Summary)
+@kindex M P t @r{(Summary)}
 @findex gnus-uu-mark-thread
 Mark all articles in the current (sub)thread
 (@code{gnus-uu-mark-thread}).
 
 @item M P T
-@kindex M P T (Summary)
+@kindex M P T @r{(Summary)}
 @findex gnus-uu-unmark-thread
 Unmark all articles in the current (sub)thread
 (@code{gnus-uu-unmark-thread}).
 
 @item M P v
-@kindex M P v (Summary)
+@kindex M P v @r{(Summary)}
 @findex gnus-uu-mark-over
 Mark all articles that have a score above the prefix argument
 (@code{gnus-uu-mark-over}).
 
 @item M P s
-@kindex M P s (Summary)
+@kindex M P s @r{(Summary)}
 @findex gnus-uu-mark-series
 Mark all articles in the current series (@code{gnus-uu-mark-series}).
 
 @item M P S
-@kindex M P S (Summary)
+@kindex M P S @r{(Summary)}
 @findex gnus-uu-mark-sparse
 Mark all series that have already had some articles marked
 (@code{gnus-uu-mark-sparse}).
 
 @item M P a
-@kindex M P a (Summary)
+@kindex M P a @r{(Summary)}
 @findex gnus-uu-mark-all
 Mark all articles in series order (@code{gnus-uu-mark-all}).
 
 @item M P b
-@kindex M P b (Summary)
+@kindex M P b @r{(Summary)}
 @findex gnus-uu-mark-buffer
 Mark all articles in the buffer in the order they appear
 (@code{gnus-uu-mark-buffer}).
 
 @item M P k
-@kindex M P k (Summary)
+@kindex M P k @r{(Summary)}
 @findex gnus-summary-kill-process-mark
 Push the current process mark set onto the stack and unmark all articles
 (@code{gnus-summary-kill-process-mark}).
 
 @item M P y
-@kindex M P y (Summary)
+@kindex M P y @r{(Summary)}
 @findex gnus-summary-yank-process-mark
 Pop the previous process mark set from the stack and restore it
 (@code{gnus-summary-yank-process-mark}).
 
 @item M P w
-@kindex M P w (Summary)
+@kindex M P w @r{(Summary)}
 @findex gnus-summary-save-process-mark
 Push the current process mark set onto the stack
 (@code{gnus-summary-save-process-mark}).
@@ -6574,42 +6568,42 @@ articles.
 
 @item / /
 @itemx / s
-@kindex / / (Summary)
+@kindex / / @r{(Summary)}
 @findex gnus-summary-limit-to-subject
 Limit the summary buffer to articles that match some subject
 (@code{gnus-summary-limit-to-subject}).  If given a prefix, exclude
 matching articles.
 
 @item / a
-@kindex / a (Summary)
+@kindex / a @r{(Summary)}
 @findex gnus-summary-limit-to-author
 Limit the summary buffer to articles that match some author
 (@code{gnus-summary-limit-to-author}).  If given a prefix, exclude
 matching articles.
 
 @item / R
-@kindex / R (Summary)
+@kindex / R @r{(Summary)}
 @findex gnus-summary-limit-to-recipient
 Limit the summary buffer to articles that match some recipient
 (@code{gnus-summary-limit-to-recipient}).  If given a prefix, exclude
 matching articles.
 
 @item / A
-@kindex / A (Summary)
+@kindex / A @r{(Summary)}
 @findex gnus-summary-limit-to-address
 Limit the summary buffer to articles in which contents of From, To or Cc
 header match a given address (@code{gnus-summary-limit-to-address}).  If
 given a prefix, exclude matching articles.
 
 @item / S
-@kindex / S (Summary)
+@kindex / S @r{(Summary)}
 @findex gnus-summary-limit-to-singletons
 Limit the summary buffer to articles that aren't part of any displayed
 threads (@code{gnus-summary-limit-to-singletons}).  If given a prefix,
 limit to articles that are part of displayed threads.
 
 @item / x
-@kindex / x (Summary)
+@kindex / x @r{(Summary)}
 @findex gnus-summary-limit-to-extra
 Limit the summary buffer to articles that match one of the ``extra''
 headers (@pxref{To From Newsgroups})
@@ -6618,8 +6612,8 @@ matching articles.
 
 @item / u
 @itemx x
-@kindex / u (Summary)
-@kindex x (Summary)
+@kindex / u @r{(Summary)}
+@kindex x @r{(Summary)}
 @findex gnus-summary-limit-to-unread
 Limit the summary buffer to articles not marked as read
 (@code{gnus-summary-limit-to-unread}).  If given a prefix, limit the
@@ -6627,46 +6621,46 @@ buffer to articles strictly unread.  This means that ticked and
 dormant articles will also be excluded.
 
 @item / m
-@kindex / m (Summary)
+@kindex / m @r{(Summary)}
 @findex gnus-summary-limit-to-marks
 Ask for a mark and then limit to all articles that have been marked
 with that mark (@code{gnus-summary-limit-to-marks}).
 
 @item / t
-@kindex / t (Summary)
+@kindex / t @r{(Summary)}
 @findex gnus-summary-limit-to-age
 Ask for a number and then limit the summary buffer to articles older than (or equal to) that number of days
 (@code{gnus-summary-limit-to-age}).  If given a prefix, limit to
 articles younger than that number of days.
 
 @item / n
-@kindex / n (Summary)
+@kindex / n @r{(Summary)}
 @findex gnus-summary-limit-to-articles
 With prefix @samp{n}, limit the summary buffer to the next @samp{n}
 articles.  If not given a prefix, use the process marked articles
 instead.  (@code{gnus-summary-limit-to-articles}).
 
 @item / w
-@kindex / w (Summary)
+@kindex / w @r{(Summary)}
 @findex gnus-summary-pop-limit
 Pop the previous limit off the stack and restore it
 (@code{gnus-summary-pop-limit}).  If given a prefix, pop all limits off
 the stack.
 
 @item / .
-@kindex / . (Summary)
+@kindex / . @r{(Summary)}
 @findex gnus-summary-limit-to-unseen
 Limit the summary buffer to the unseen articles
 (@code{gnus-summary-limit-to-unseen}).
 
 @item / v
-@kindex / v (Summary)
+@kindex / v @r{(Summary)}
 @findex gnus-summary-limit-to-score
 Limit the summary buffer to articles that have a score at or above some
 score (@code{gnus-summary-limit-to-score}).
 
 @item / p
-@kindex / p (Summary)
+@kindex / p @r{(Summary)}
 @findex gnus-summary-limit-to-display-predicate
 Limit the summary buffer to articles that satisfy the @code{display}
 group parameter predicate
@@ -6674,7 +6668,7 @@ group parameter predicate
 Parameters}, for more on this predicate.
 
 @item / r
-@kindex / r (Summary)
+@kindex / r @r{(Summary)}
 @findex gnus-summary-limit-to-replied
 Limit the summary buffer to replied articles
 (@code{gnus-summary-limit-to-replied}).  If given a prefix, exclude
@@ -6682,55 +6676,55 @@ replied articles.
 
 @item / E
 @itemx M S
-@kindex M S (Summary)
-@kindex / E (Summary)
+@kindex M S @r{(Summary)}
+@kindex / E @r{(Summary)}
 @findex gnus-summary-limit-include-expunged
 Include all expunged articles in the limit
 (@code{gnus-summary-limit-include-expunged}).
 
 @item / D
-@kindex / D (Summary)
+@kindex / D @r{(Summary)}
 @findex gnus-summary-limit-include-dormant
 Include all dormant articles in the limit
 (@code{gnus-summary-limit-include-dormant}).
 
 @item / *
-@kindex / * (Summary)
+@kindex / * @r{(Summary)}
 @findex gnus-summary-limit-include-cached
 Include all cached articles in the limit
 (@code{gnus-summary-limit-include-cached}).
 
 @item / d
-@kindex / d (Summary)
+@kindex / d @r{(Summary)}
 @findex gnus-summary-limit-exclude-dormant
 Exclude all dormant articles from the limit
 (@code{gnus-summary-limit-exclude-dormant}).
 
 @item / M
-@kindex / M (Summary)
+@kindex / M @r{(Summary)}
 @findex gnus-summary-limit-exclude-marks
 Exclude all marked articles (@code{gnus-summary-limit-exclude-marks}).
 
 @item / T
-@kindex / T (Summary)
+@kindex / T @r{(Summary)}
 @findex gnus-summary-limit-include-thread
 Include all the articles in the current thread in the limit.
 
 @item / c
-@kindex / c (Summary)
+@kindex / c @r{(Summary)}
 @findex gnus-summary-limit-exclude-childless-dormant
 Exclude all dormant articles that have no children from the limit@*
 (@code{gnus-summary-limit-exclude-childless-dormant}).
 
 @item / C
-@kindex / C (Summary)
+@kindex / C @r{(Summary)}
 @findex gnus-summary-limit-mark-excluded-as-read
 Mark all excluded unread articles as read
 (@code{gnus-summary-limit-mark-excluded-as-read}).  If given a prefix,
 also mark excluded ticked and dormant articles as read.
 
 @item / b
-@kindex / b (Summary)
+@kindex / b @r{(Summary)}
 @findex gnus-summary-limit-to-bodies
 Limit the summary buffer to articles that have bodies that match a
 certain regexp (@code{gnus-summary-limit-to-bodies}).  If given a
@@ -6738,7 +6732,7 @@ prefix, reverse the limit.  This command is quite slow since it
 requires selecting each article to find the matches.
 
 @item / h
-@kindex / h (Summary)
+@kindex / h @r{(Summary)}
 @findex gnus-summary-limit-to-headers
 Like the previous command, only limit to headers instead
 (@code{gnus-summary-limit-to-headers}).
@@ -6751,13 +6745,13 @@ prefix as well.
 
 @table @kbd
 @item / N
-@kindex / N (Summary)
+@kindex / N @r{(Summary)}
 @findex gnus-summary-insert-new-articles
 Insert all new articles in the summary buffer.  It scans for new emails
 if @var{back-end}@code{-get-new-mail} is non-@code{nil}.
 
 @item / o
-@kindex / o (Summary)
+@kindex / o @r{(Summary)}
 @findex gnus-summary-insert-old-articles
 Insert all old articles in the summary buffer.  If given a numbered
 prefix, fetch this number of articles.
@@ -7197,8 +7191,8 @@ meaningful.  Here's one example:
 
 @item T k
 @itemx C-M-k
-@kindex T k (Summary)
-@kindex C-M-k (Summary)
+@kindex T k @r{(Summary)}
+@kindex C-M-k @r{(Summary)}
 @findex gnus-summary-kill-thread
 Mark all articles in the current (sub-)thread as read
 (@code{gnus-summary-kill-thread}).  If the prefix argument is positive,
@@ -7207,71 +7201,71 @@ articles instead.
 
 @item T l
 @itemx C-M-l
-@kindex T l (Summary)
-@kindex C-M-l (Summary)
+@kindex T l @r{(Summary)}
+@kindex C-M-l @r{(Summary)}
 @findex gnus-summary-lower-thread
 Lower the score of the current (sub-)thread
 (@code{gnus-summary-lower-thread}).
 
 @item T i
-@kindex T i (Summary)
+@kindex T i @r{(Summary)}
 @findex gnus-summary-raise-thread
 Increase the score of the current (sub-)thread
 (@code{gnus-summary-raise-thread}).
 
 @item T #
-@kindex T # (Summary)
+@kindex T # @r{(Summary)}
 @findex gnus-uu-mark-thread
 Set the process mark on the current (sub-)thread
 (@code{gnus-uu-mark-thread}).
 
 @item T M-#
-@kindex T M-# (Summary)
+@kindex T M-# @r{(Summary)}
 @findex gnus-uu-unmark-thread
 Remove the process mark from the current (sub-)thread
 (@code{gnus-uu-unmark-thread}).
 
 @item T T
-@kindex T T (Summary)
+@kindex T T @r{(Summary)}
 @findex gnus-summary-toggle-threads
 Toggle threading (@code{gnus-summary-toggle-threads}).
 
 @item T s
-@kindex T s (Summary)
+@kindex T s @r{(Summary)}
 @findex gnus-summary-show-thread
 Expose the (sub-)thread hidden under the current article, if any@*
 (@code{gnus-summary-show-thread}).
 
 @item T h
-@kindex T h (Summary)
+@kindex T h @r{(Summary)}
 @findex gnus-summary-hide-thread
 Hide the current (sub-)thread (@code{gnus-summary-hide-thread}).
 
 @item T S
-@kindex T S (Summary)
+@kindex T S @r{(Summary)}
 @findex gnus-summary-show-all-threads
 Expose all hidden threads (@code{gnus-summary-show-all-threads}).
 
 @item T H
-@kindex T H (Summary)
+@kindex T H @r{(Summary)}
 @findex gnus-summary-hide-all-threads
 Hide all threads (@code{gnus-summary-hide-all-threads}).
 
 @item T t
-@kindex T t (Summary)
+@kindex T t @r{(Summary)}
 @findex gnus-summary-rethread-current
 Re-thread the current article's thread
 (@code{gnus-summary-rethread-current}).  This works even when the
 summary buffer is otherwise unthreaded.
 
 @item T ^
-@kindex T ^ (Summary)
+@kindex T ^ @r{(Summary)}
 @findex gnus-summary-reparent-thread
 Make the current article the child of the marked (or previous) article
 (@code{gnus-summary-reparent-thread}).
 
 @item T M-^
-@kindex T M-^ (Summary)
+@kindex T M-^ @r{(Summary)}
 @findex gnus-summary-reparent-children
 Make the current article the parent of the marked articles
 (@code{gnus-summary-reparent-children}).
@@ -7284,35 +7278,35 @@ understand the numeric prefix.
 @table @kbd
 
 @item T n
-@kindex T n (Summary)
+@kindex T n @r{(Summary)}
 @itemx C-M-f
-@kindex C-M-n (Summary)
-@itemx M-down
-@kindex M-down (Summary)
+@kindex C-M-n @r{(Summary)}
+@itemx M-@key{DOWN}
+@kindex M-@key{DOWN} @r{(Summary)}
 @findex gnus-summary-next-thread
 Go to the next thread (@code{gnus-summary-next-thread}).
 
 @item T p
-@kindex T p (Summary)
+@kindex T p @r{(Summary)}
 @itemx C-M-b
-@kindex C-M-p (Summary)
-@itemx M-up
-@kindex M-up (Summary)
+@kindex C-M-p @r{(Summary)}
+@itemx M-@key{UP}
+@kindex M-@key{UP} @r{(Summary)}
 @findex gnus-summary-prev-thread
 Go to the previous thread (@code{gnus-summary-prev-thread}).
 
 @item T d
-@kindex T d (Summary)
+@kindex T d @r{(Summary)}
 @findex gnus-summary-down-thread
 Descend the thread (@code{gnus-summary-down-thread}).
 
 @item T u
-@kindex T u (Summary)
+@kindex T u @r{(Summary)}
 @findex gnus-summary-up-thread
 Ascend the thread (@code{gnus-summary-up-thread}).
 
 @item T o
-@kindex T o (Summary)
+@kindex T o @r{(Summary)}
 @findex gnus-summary-top-thread
 Go to the top of the thread (@code{gnus-summary-top-thread}).
 @end table
@@ -7654,12 +7648,12 @@ you use two explicit commands for managing persistent articles:
 @table @kbd
 
 @item *
-@kindex * (Summary)
+@kindex * @r{(Summary)}
 @findex gnus-cache-enter-article
 Make the current article persistent (@code{gnus-cache-enter-article}).
 
 @item M-*
-@kindex M-* (Summary)
+@kindex M-* @r{(Summary)}
 @findex gnus-cache-remove-article
 Remove the current article from the persistent articles
 (@code{gnus-cache-remove-article}).  This will normally delete the
@@ -7697,7 +7691,7 @@ select another article.  You can make an article sticky with:
 
 @table @kbd
 @item A S
-@kindex A S (Summary)
+@kindex A S @r{(Summary)}
 @findex gnus-sticky-article
 Make the current article sticky.  If a prefix arg is given, ask for a
 name for this sticky article buffer.
@@ -7707,12 +7701,12 @@ To close a sticky article buffer you can use these commands:
 
 @table @kbd
 @item q
-@kindex q (Article)
+@kindex q @r{@r{(Article)}}
 @findex bury-buffer
 Puts this sticky article buffer at the end of the list of all buffers.
 
 @item k
-@kindex k (Article)
+@kindex k @r{(Article)}
 @findex gnus-kill-sticky-article-buffer
 Kills this sticky article buffer.
 @end table
@@ -7778,61 +7772,61 @@ deleted before saving.
 
 @item O o
 @itemx o
-@kindex O o (Summary)
-@kindex o (Summary)
+@kindex O o @r{(Summary)}
+@kindex o @r{(Summary)}
 @findex gnus-summary-save-article
 @c @icon{gnus-summary-save-article}
 Save the current article using the default article saver
 (@code{gnus-summary-save-article}).
 
 @item O m
-@kindex O m (Summary)
+@kindex O m @r{(Summary)}
 @findex gnus-summary-save-article-mail
 Save the current article in a Unix mail box (mbox) file
 (@code{gnus-summary-save-article-mail}).
 
 @item O r
-@kindex O r (Summary)
+@kindex O r @r{(Summary)}
 @findex gnus-summary-save-article-rmail
 Save the current article in Rmail format
 (@code{gnus-summary-save-article-rmail}).  This is mbox since Emacs 23,
 Babyl in older versions.
 
 @item O f
-@kindex O f (Summary)
+@kindex O f @r{(Summary)}
 @findex gnus-summary-save-article-file
 @c @icon{gnus-summary-save-article-file}
 Save the current article in plain file format
 (@code{gnus-summary-save-article-file}).
 
 @item O F
-@kindex O F (Summary)
+@kindex O F @r{(Summary)}
 @findex gnus-summary-write-article-file
 Write the current article in plain file format, overwriting any previous
 file contents (@code{gnus-summary-write-article-file}).
 
 @item O b
-@kindex O b (Summary)
+@kindex O b @r{(Summary)}
 @findex gnus-summary-save-article-body-file
 Save the current article body in plain file format
 (@code{gnus-summary-save-article-body-file}).
 
 @item O h
-@kindex O h (Summary)
+@kindex O h @r{(Summary)}
 @findex gnus-summary-save-article-folder
 Save the current article in mh folder format
 (@code{gnus-summary-save-article-folder}).
 
 @item O v
-@kindex O v (Summary)
+@kindex O v @r{(Summary)}
 @findex gnus-summary-save-article-vm
 Save the current article in a VM folder
 (@code{gnus-summary-save-article-vm}).
 
 @item O p
 @itemx |
-@kindex O p (Summary)
-@kindex | (Summary)
+@kindex O p @r{(Summary)}
+@kindex | @r{(Summary)}
 @findex gnus-summary-pipe-output
 @vindex gnus-summary-pipe-output-default-command
 Save the current article in a pipe.  Uhm, like, what I mean is---Pipe
@@ -7845,7 +7839,7 @@ to a string containing the default command and options (default
 @code{nil}).
 
 @item O P
-@kindex O P (Summary)
+@kindex O P @r{(Summary)}
 @findex gnus-summary-muttprint
 @vindex gnus-summary-muttprint-program
 Save the current article into muttprint.  That is, print it using the
@@ -8152,24 +8146,24 @@ commands, and you have to mark the articles manually with @kbd{#}.
 @table @kbd
 
 @item X u
-@kindex X u (Summary)
+@kindex X u @r{(Summary)}
 @findex gnus-uu-decode-uu
 @c @icon{gnus-uu-decode-uu}
 Uudecodes the current series (@code{gnus-uu-decode-uu}).
 
 @item X U
-@kindex X U (Summary)
+@kindex X U @r{(Summary)}
 @findex gnus-uu-decode-uu-and-save
 Uudecodes and saves the current series
 (@code{gnus-uu-decode-uu-and-save}).
 
 @item X v u
-@kindex X v u (Summary)
+@kindex X v u @r{(Summary)}
 @findex gnus-uu-decode-uu-view
 Uudecodes and views the current series (@code{gnus-uu-decode-uu-view}).
 
 @item X v U
-@kindex X v U (Summary)
+@kindex X v U @r{(Summary)}
 @findex gnus-uu-decode-uu-and-save-view
 Uudecodes, views and saves the current series
 (@code{gnus-uu-decode-uu-and-save-view}).
@@ -8210,22 +8204,22 @@ some commands to deal with these:
 @table @kbd
 
 @item X s
-@kindex X s (Summary)
+@kindex X s @r{(Summary)}
 @findex gnus-uu-decode-unshar
 Unshars the current series (@code{gnus-uu-decode-unshar}).
 
 @item X S
-@kindex X S (Summary)
+@kindex X S @r{(Summary)}
 @findex gnus-uu-decode-unshar-and-save
 Unshars and saves the current series (@code{gnus-uu-decode-unshar-and-save}).
 
 @item X v s
-@kindex X v s (Summary)
+@kindex X v s @r{(Summary)}
 @findex gnus-uu-decode-unshar-view
 Unshars and views the current series (@code{gnus-uu-decode-unshar-view}).
 
 @item X v S
-@kindex X v S (Summary)
+@kindex X v S @r{(Summary)}
 @findex gnus-uu-decode-unshar-and-save-view
 Unshars, views and saves the current series
 (@code{gnus-uu-decode-unshar-and-save-view}).
@@ -8239,24 +8233,24 @@ Unshars, views and saves the current series
 @table @kbd
 
 @item X p
-@kindex X p (Summary)
+@kindex X p @r{(Summary)}
 @findex gnus-uu-decode-postscript
 Unpack the current PostScript series (@code{gnus-uu-decode-postscript}).
 
 @item X P
-@kindex X P (Summary)
+@kindex X P @r{(Summary)}
 @findex gnus-uu-decode-postscript-and-save
 Unpack and save the current PostScript series
 (@code{gnus-uu-decode-postscript-and-save}).
 
 @item X v p
-@kindex X v p (Summary)
+@kindex X v p @r{(Summary)}
 @findex gnus-uu-decode-postscript-view
 View the current PostScript series
 (@code{gnus-uu-decode-postscript-view}).
 
 @item X v P
-@kindex X v P (Summary)
+@kindex X v P @r{(Summary)}
 @findex gnus-uu-decode-postscript-and-save-view
 View and save the current PostScript series
 (@code{gnus-uu-decode-postscript-and-save-view}).
@@ -8268,19 +8262,19 @@ View and save the current PostScript series
 
 @table @kbd
 @item X o
-@kindex X o (Summary)
+@kindex X o @r{(Summary)}
 @findex gnus-uu-decode-save
 Save the current series
 (@code{gnus-uu-decode-save}).
 
 @item X b
-@kindex X b (Summary)
+@kindex X b @r{(Summary)}
 @findex gnus-uu-decode-binhex
 Unbinhex the current series (@code{gnus-uu-decode-binhex}).  This
 doesn't really work yet.
 
 @item X Y
-@kindex X Y (Summary)
+@kindex X Y @r{(Summary)}
 @findex gnus-uu-decode-yenc
 yEnc-decode the current series and save it (@code{gnus-uu-decode-yenc}).
 @end table
@@ -8554,7 +8548,7 @@ you want it to look like technicolor fruit salad.
 @table @kbd
 
 @item W H a
-@kindex W H a (Summary)
+@kindex W H a @r{(Summary)}
 @findex gnus-article-highlight
 @findex gnus-article-maybe-highlight
 Do much highlighting of the current article
@@ -8562,7 +8556,7 @@ Do much highlighting of the current article
 text, the signature, and adds buttons to the body and the head.
 
 @item W H h
-@kindex W H h (Summary)
+@kindex W H h @r{(Summary)}
 @findex gnus-article-highlight-headers
 @vindex gnus-header-face-alist
 Highlight the headers (@code{gnus-article-highlight-headers}).  The
@@ -8576,7 +8570,7 @@ the header value.  The first match made will be used.  Note that
 @var{regexp} shouldn't have @samp{^} prepended---Gnus will add one.
 
 @item W H c
-@kindex W H c (Summary)
+@kindex W H c @r{(Summary)}
 @findex gnus-article-highlight-citation
 Highlight cited text (@code{gnus-article-highlight-citation}).
 
@@ -8637,7 +8631,7 @@ is @code{t}.
 
 
 @item W H s
-@kindex W H s (Summary)
+@kindex W H s @r{(Summary)}
 @vindex gnus-signature-separator
 @vindex gnus-signature-face
 @findex gnus-article-highlight-signature
@@ -8658,7 +8652,7 @@ default.
 @cindex article emphasis
 
 @findex gnus-article-emphasize
-@kindex W e (Summary)
+@kindex W e @r{(Summary)}
 People commonly add emphasis to words in news articles by writing things
 like @samp{_this_} or @samp{*this*} or @samp{/this/}.  Gnus can make
 this look nicer by running the article through the @kbd{W e}
@@ -8729,32 +8723,32 @@ too much cruft in most articles.
 @table @kbd
 
 @item W W a
-@kindex W W a (Summary)
+@kindex W W a @r{(Summary)}
 @findex gnus-article-hide
 Do quite a lot of hiding on the article buffer
 (@kbd{gnus-article-hide}).  In particular, this function will hide
 headers, @acronym{PGP}, cited text and the signature.
 
 @item W W h
-@kindex W W h (Summary)
+@kindex W W h @r{(Summary)}
 @findex gnus-article-hide-headers
 Hide headers (@code{gnus-article-hide-headers}).  @xref{Hiding
 Headers}.
 
 @item W W b
-@kindex W W b (Summary)
+@kindex W W b @r{(Summary)}
 @findex gnus-article-hide-boring-headers
 Hide headers that aren't particularly interesting
 (@code{gnus-article-hide-boring-headers}).  @xref{Hiding Headers}.
 
 @item W W s
-@kindex W W s (Summary)
+@kindex W W s @r{(Summary)}
 @findex gnus-article-hide-signature
 Hide signature (@code{gnus-article-hide-signature}).  @xref{Article
 Signature}.
 
 @item W W l
-@kindex W W l (Summary)
+@kindex W W l @r{(Summary)}
 @findex gnus-article-hide-list-identifiers
 @vindex gnus-list-identifiers
 Strip list identifiers specified in @code{gnus-list-identifiers}.  These
@@ -8773,13 +8767,13 @@ subject.  This can also be a list of regular expressions.
 @end table
 
 @item W W P
-@kindex W W P (Summary)
+@kindex W W P @r{(Summary)}
 @findex gnus-article-hide-pem
 Hide @acronym{PEM} (privacy enhanced messages) cruft
 (@code{gnus-article-hide-pem}).
 
 @item W W B
-@kindex W W B (Summary)
+@kindex W W B @r{(Summary)}
 @findex gnus-article-strip-banner
 @vindex gnus-article-banner-alist
 @vindex gnus-article-address-banner-alist
@@ -8833,7 +8827,7 @@ sends, you can use the following element to remove them:
 @end table
 
 @item W W c
-@kindex W W c (Summary)
+@kindex W W c @r{(Summary)}
 @findex gnus-article-hide-citation
 Hide citation (@code{gnus-article-hide-citation}).  Some variables for
 customizing the hiding:
@@ -8869,7 +8863,7 @@ and bottom of the text, respectively, to remain visible.
 @end table
 
 @item W W C-c
-@kindex W W C-c (Summary)
+@kindex W W C-c @r{(Summary)}
 @findex gnus-article-hide-citation-maybe
 
 Hide citation (@code{gnus-article-hide-citation-maybe}) depending on the
@@ -8888,7 +8882,7 @@ is hidden.
 @end table
 
 @item W W C
-@kindex W W C (Summary)
+@kindex W W C @r{(Summary)}
 @findex gnus-article-hide-citation-in-followups
 Hide cited text in articles that aren't roots
 (@code{gnus-article-hide-citation-in-followups}).  This isn't very
@@ -8938,14 +8932,14 @@ interactive Washing functions but with all default treatments
 (@pxref{Customizing Articles}).
 
 @item W l
-@kindex W l (Summary)
+@kindex W l @r{(Summary)}
 @findex gnus-summary-stop-page-breaking
 Remove page breaks from the current article
 (@code{gnus-summary-stop-page-breaking}).  @xref{Misc Article}, for page
 delimiters.
 
 @item W r
-@kindex W r (Summary)
+@kindex W r @r{(Summary)}
 @findex gnus-summary-caesar-message
 @c @icon{gnus-summary-caesar-message}
 Do a Caesar rotate (rot13) on the article buffer
@@ -8959,12 +8953,12 @@ positions in the alphabet, e.g., @samp{B} (letter #2) -> @samp{O} (letter
 is rumored to have employed this form of, uh, somewhat weak encryption.
 
 @item W m
-@kindex W m (Summary)
+@kindex W m @r{(Summary)}
 @findex gnus-summary-morse-message
 Morse decode the article buffer (@code{gnus-summary-morse-message}).
 
 @item W i
-@kindex W i (Summary)
+@kindex W i @r{(Summary)}
 @findex gnus-summary-idna-message
 Decode IDNA encoded domain names in the current articles.  IDNA
 encoded domain names looks like @samp{xn--bar}.  If a string remain
@@ -8975,25 +8969,25 @@ to work.
 
 @item W t
 @item t
-@kindex W t (Summary)
-@kindex t (Summary)
+@kindex W t @r{(Summary)}
+@kindex t @r{(Summary)}
 @findex gnus-summary-toggle-header
 Toggle whether to display all headers in the article buffer
 (@code{gnus-summary-toggle-header}).
 
 @item W v
-@kindex W v (Summary)
+@kindex W v @r{(Summary)}
 @findex gnus-summary-verbose-headers
 Toggle whether to display all headers in the article buffer permanently
 (@code{gnus-summary-verbose-headers}).
 
 @item W o
-@kindex W o (Summary)
+@kindex W o @r{(Summary)}
 @findex gnus-article-treat-overstrike
 Treat overstrike (@code{gnus-article-treat-overstrike}).
 
 @item W d
-@kindex W d (Summary)
+@kindex W d @r{(Summary)}
 @findex gnus-article-treat-dumbquotes
 @vindex gnus-article-dumbquotes-map
 @cindex Smartquotes
@@ -9011,7 +9005,7 @@ like @code{\222} or @code{\264} where you're expecting some kind of
 apostrophe or quotation mark, then try this wash.
 
 @item W U
-@kindex W U (Summary)
+@kindex W U @r{(Summary)}
 @findex gnus-article-treat-non-ascii
 @cindex Unicode
 @cindex Non-@acronym{ASCII}
@@ -9022,7 +9016,7 @@ and doesn't show accented characters, ``advanced'' punctuation, and the
 like.  For instance, @samp{»} is translated into @samp{>>}, and so on.
 
 @item W Y f
-@kindex W Y f (Summary)
+@kindex W Y f @r{(Summary)}
 @findex gnus-article-outlook-deuglify-article
 @cindex Outlook Express
 Full deuglify of broken Outlook (Express) articles: Treat dumbquotes,
@@ -9030,7 +9024,7 @@ unwrap lines, repair attribution and rearrange citation.
 (@code{gnus-article-outlook-deuglify-article}).
 
 @item W Y u
-@kindex W Y u (Summary)
+@kindex W Y u @r{(Summary)}
 @findex gnus-article-outlook-unwrap-lines
 @vindex gnus-outlook-deuglify-unwrap-min
 @vindex gnus-outlook-deuglify-unwrap-max
@@ -9042,19 +9036,19 @@ maximum length of an unwrapped citation line.
 (@code{gnus-article-outlook-unwrap-lines}).
 
 @item W Y a
-@kindex W Y a (Summary)
+@kindex W Y a @r{(Summary)}
 @findex gnus-article-outlook-repair-attribution
 Repair a broken attribution line.@*
 (@code{gnus-article-outlook-repair-attribution}).
 
 @item W Y c
-@kindex W Y c (Summary)
+@kindex W Y c @r{(Summary)}
 @findex gnus-article-outlook-rearrange-citation
 Repair broken citations by rearranging the text.
 (@code{gnus-article-outlook-rearrange-citation}).
 
 @item W w
-@kindex W w (Summary)
+@kindex W w @r{(Summary)}
 @findex gnus-article-fill-cited-article
 Do word wrap (@code{gnus-article-fill-cited-article}).
 
@@ -9062,18 +9056,18 @@ You can give the command a numerical prefix to specify the width to use
 when filling.
 
 @item W Q
-@kindex W Q (Summary)
+@kindex W Q @r{(Summary)}
 @findex gnus-article-fill-long-lines
 Fill long lines (@code{gnus-article-fill-long-lines}).
 
 @item W C
-@kindex W C (Summary)
+@kindex W C @r{(Summary)}
 @findex gnus-article-capitalize-sentences
 Capitalize the first word in each sentence
 (@code{gnus-article-capitalize-sentences}).
 
 @item W c
-@kindex W c (Summary)
+@kindex W c @r{(Summary)}
 @findex gnus-article-remove-cr
 Translate CRLF pairs (i.e., @samp{^M}s on the end of the lines) into LF
 (this takes care of DOS line endings), and then translate any remaining
@@ -9081,7 +9075,7 @@ CRs into LF (this takes care of Mac line endings)
 (@code{gnus-article-remove-cr}).
 
 @item W q
-@kindex W q (Summary)
+@kindex W q @r{(Summary)}
 @findex gnus-article-de-quoted-unreadable
 Treat quoted-printable (@code{gnus-article-de-quoted-unreadable}).
 Quoted-Printable is one common @acronym{MIME} encoding employed when
@@ -9093,7 +9087,7 @@ done automatically by Gnus if the message in question has a
 has been done.  If a prefix is given, a charset will be asked for.
 
 @item W 6
-@kindex W 6 (Summary)
+@kindex W 6 @r{(Summary)}
 @findex gnus-article-de-base64-unreadable
 Treat base64 (@code{gnus-article-de-base64-unreadable}).  Base64 is
 one common @acronym{MIME} encoding employed when sending
@@ -9103,14 +9097,14 @@ usually done automatically by Gnus if the message in question has a
 has been done.  If a prefix is given, a charset will be asked for.
 
 @item W Z
-@kindex W Z (Summary)
+@kindex W Z @r{(Summary)}
 @findex gnus-article-decode-HZ
 Treat HZ or HZP (@code{gnus-article-decode-HZ}).  HZ (or HZP) is one
 common encoding employed when sending Chinese articles.  It typically
 makes strings look like @samp{~@{<:Ky2;S@{#,NpJ)l6HK!#~@}}.
 
 @item W A
-@kindex W A (Summary)
+@kindex W A @r{(Summary)}
 @findex gnus-article-treat-ansi-sequences
 @cindex @acronym{ANSI} control sequences
 Translate @acronym{ANSI} SGR control sequences into overlays or
@@ -9118,7 +9112,7 @@ extents (@code{gnus-article-treat-ansi-sequences}).  @acronym{ANSI}
 sequences are used in some Chinese hierarchies for highlighting.
 
 @item W u
-@kindex W u (Summary)
+@kindex W u @r{(Summary)}
 @findex gnus-article-unsplit-urls
 Remove newlines from within URLs.  Some mailers insert newlines into
 outgoing email messages to keep lines short.  This reformatting can
@@ -9126,7 +9120,7 @@ split long URLs onto multiple lines.  Repair those URLs by removing
 the newlines (@code{gnus-article-unsplit-urls}).
 
 @item W h
-@kindex W h (Summary)
+@kindex W h @r{(Summary)}
 @findex gnus-article-wash-html
 Treat @acronym{HTML} (@code{gnus-article-wash-html}).  Note that this is
 usually done automatically by Gnus if the message in question has a
@@ -9166,19 +9160,19 @@ Use html2text---a simple @acronym{HTML} converter included with Gnus.
 @end table
 
 @item W b
-@kindex W b (Summary)
+@kindex W b @r{(Summary)}
 @findex gnus-article-add-buttons
 Add clickable buttons to the article (@code{gnus-article-add-buttons}).
 @xref{Article Buttons}.
 
 @item W B
-@kindex W B (Summary)
+@kindex W B @r{(Summary)}
 @findex gnus-article-add-buttons-to-head
 Add clickable buttons to the article headers
 (@code{gnus-article-add-buttons-to-head}).
 
 @item W p
-@kindex W p (Summary)
+@kindex W p @r{(Summary)}
 @findex gnus-article-verify-x-pgp-sig
 Verify a signed control message
 (@code{gnus-article-verify-x-pgp-sig}).  Control messages such as
@@ -9189,57 +9183,57 @@ message.@footnote{@acronym{PGP} keys for many hierarchies are
 available at @uref{https://ftp.isc.org/pub/pgpcontrol/README.html}}
 
 @item W s
-@kindex W s (Summary)
+@kindex W s @r{(Summary)}
 @findex gnus-summary-force-verify-and-decrypt
 Verify a signed (@acronym{PGP}, @acronym{PGP/MIME} or
 @acronym{S/MIME}) message
 (@code{gnus-summary-force-verify-and-decrypt}). @xref{Security}.
 
 @item W a
-@kindex W a (Summary)
+@kindex W a @r{(Summary)}
 @findex gnus-article-strip-headers-in-body
 Strip headers like the @code{X-No-Archive} header from the beginning of
 article bodies (@code{gnus-article-strip-headers-in-body}).
 
 @item W E l
-@kindex W E l (Summary)
+@kindex W E l @r{(Summary)}
 @findex gnus-article-strip-leading-blank-lines
 Remove all blank lines from the beginning of the article
 (@code{gnus-article-strip-leading-blank-lines}).
 
 @item W E m
-@kindex W E m (Summary)
+@kindex W E m @r{(Summary)}
 @findex gnus-article-strip-multiple-blank-lines
 Replace all blank lines with empty lines and then all multiple empty
 lines with a single empty line.
 (@code{gnus-article-strip-multiple-blank-lines}).
 
 @item W E t
-@kindex W E t (Summary)
+@kindex W E t @r{(Summary)}
 @findex gnus-article-remove-trailing-blank-lines
 Remove all blank lines at the end of the article
 (@code{gnus-article-remove-trailing-blank-lines}).
 
 @item W E a
-@kindex W E a (Summary)
+@kindex W E a @r{(Summary)}
 @findex gnus-article-strip-blank-lines
 Do all the three commands above
 (@code{gnus-article-strip-blank-lines}).
 
 @item W E A
-@kindex W E A (Summary)
+@kindex W E A @r{(Summary)}
 @findex gnus-article-strip-all-blank-lines
 Remove all blank lines
 (@code{gnus-article-strip-all-blank-lines}).
 
 @item W E s
-@kindex W E s (Summary)
+@kindex W E s @r{(Summary)}
 @findex gnus-article-strip-leading-space
 Remove all white space from the beginning of all lines of the article
 body (@code{gnus-article-strip-leading-space}).
 
 @item W E e
-@kindex W E e (Summary)
+@kindex W E e @r{(Summary)}
 @findex gnus-article-strip-trailing-space
 Remove all white space from the end of all lines of the article
 body (@code{gnus-article-strip-trailing-space}).
@@ -9257,24 +9251,24 @@ These commands perform various transformations of article header.
 @table @kbd
 
 @item W G u
-@kindex W G u (Summary)
+@kindex W G u @r{(Summary)}
 @findex gnus-article-treat-unfold-headers
 Unfold folded header lines (@code{gnus-article-treat-unfold-headers}).
 
 @item W G n
-@kindex W G n (Summary)
+@kindex W G n @r{(Summary)}
 @findex gnus-article-treat-fold-newsgroups
 Fold the @code{Newsgroups} and @code{Followup-To} headers
 (@code{gnus-article-treat-fold-newsgroups}).
 
 @item W G f
-@kindex W G f (Summary)
+@kindex W G f @r{(Summary)}
 @findex gnus-article-treat-fold-headers
 Fold all the message headers
 (@code{gnus-article-treat-fold-headers}).
 
 @item W E w
-@kindex W E w (Summary)
+@kindex W E w @r{(Summary)}
 @findex gnus-article-remove-leading-whitespace
 Remove excessive whitespace from all headers
 (@code{gnus-article-remove-leading-whitespace}).
@@ -9288,7 +9282,7 @@ Remove excessive whitespace from all headers
 
 People often include references to other stuff in articles, and it would
 be nice if Gnus could just fetch whatever it is that people talk about
-with the minimum of fuzz when you hit @kbd{RET} or use the middle mouse
+with the minimum of fuzz when you hit @kbd{@key{RET}} or use the middle mouse
 button on these references.
 
 @vindex gnus-button-man-handler
@@ -9494,31 +9488,31 @@ when the article was sent.
 @table @kbd
 
 @item W T u
-@kindex W T u (Summary)
+@kindex W T u @r{(Summary)}
 @findex gnus-article-date-ut
 Display the date in UT (aka. GMT, aka ZULU)
 (@code{gnus-article-date-ut}).
 
 @item W T i
-@kindex W T i (Summary)
+@kindex W T i @r{(Summary)}
 @findex gnus-article-date-iso8601
 @cindex ISO 8601
 Display the date in international format, aka. ISO 8601
 (@code{gnus-article-date-iso8601}).
 
 @item W T l
-@kindex W T l (Summary)
+@kindex W T l @r{(Summary)}
 @findex gnus-article-date-local
 Display the date in the local timezone (@code{gnus-article-date-local}).
 
 @item W T p
-@kindex W T p (Summary)
+@kindex W T p @r{(Summary)}
 @findex gnus-article-date-english
 Display the date in a format that's easily pronounceable in English
 (@code{gnus-article-date-english}).
 
 @item W T s
-@kindex W T s (Summary)
+@kindex W T s @r{(Summary)}
 @vindex gnus-article-time-format
 @findex gnus-article-date-user
 @findex format-time-string
@@ -9529,7 +9523,7 @@ to @code{format-time-string}.  See the documentation of that variable
 for a list of possible format specs.
 
 @item W T e
-@kindex W T e (Summary)
+@kindex W T e @r{(Summary)}
 @findex gnus-article-date-lapsed
 @findex gnus-start-date-timer
 @findex gnus-stop-date-timer
@@ -9545,7 +9539,7 @@ To make this line updated continually, set the
 seconds (the default is @code{nil}).
 
 @item W T o
-@kindex W T o (Summary)
+@kindex W T o @r{(Summary)}
 @findex gnus-article-date-original
 Display the original date (@code{gnus-article-date-original}).  This can
 be useful if you normally use some other conversion function and are
@@ -9589,58 +9583,58 @@ they'll be removed.
 
 @table @kbd
 @item W D x
-@kindex W D x (Summary)
+@kindex W D x @r{(Summary)}
 @findex gnus-article-display-x-face
 Display an @code{X-Face} in the @code{From} header.
 (@code{gnus-article-display-x-face}).
 
 @item W D d
-@kindex W D d (Summary)
+@kindex W D d @r{(Summary)}
 @findex gnus-article-display-face
 Display a @code{Face} in the @code{From} header.
 (@code{gnus-article-display-face}).
 
 @item W D s
-@kindex W D s (Summary)
+@kindex W D s @r{(Summary)}
 @findex gnus-treat-smiley
 Display smileys (@code{gnus-treat-smiley}).
 
 @item W D f
-@kindex W D f (Summary)
+@kindex W D f @r{(Summary)}
 @findex gnus-treat-from-picon
 Piconify the @code{From} header (@code{gnus-treat-from-picon}).
 
 @item W D m
-@kindex W D m (Summary)
+@kindex W D m @r{(Summary)}
 @findex gnus-treat-mail-picon
 Piconify all mail headers (i.e., @code{Cc}, @code{To})
 (@code{gnus-treat-mail-picon}).
 
 @item W D n
-@kindex W D n (Summary)
+@kindex W D n @r{(Summary)}
 @findex gnus-treat-newsgroups-picon
 Piconify all news headers (i.e., @code{Newsgroups} and
 @code{Followup-To}) (@code{gnus-treat-newsgroups-picon}).
 
 @item W D g
-@kindex W D g (Summary)
+@kindex W D g @r{(Summary)}
 @findex gnus-treat-from-gravatar
 Gravatarify the @code{From} header (@code{gnus-treat-from-gravatar}).
 
 @item W D h
-@kindex W D h (Summary)
+@kindex W D h @r{(Summary)}
 @findex gnus-treat-mail-gravatar
 Gravatarify all mail headers (i.e., @code{Cc}, @code{To})
 (@code{gnus-treat-from-gravatar}).
 
 @item W D D
-@kindex W D D (Summary)
+@kindex W D D @r{(Summary)}
 @findex gnus-article-remove-images
 Remove all images from the article buffer
 (@code{gnus-article-remove-images}).
 
 @item W D W
-@kindex W D W (Summary)
+@kindex W D W @r{(Summary)}
 @findex gnus-html-show-images
 If you're reading an @acronym{HTML} article rendered with
 @code{gnus-article-html}, then you can insert any blocked images in
@@ -9718,7 +9712,7 @@ signature after all.
 
 @table @kbd
 @item A t
-@kindex A t (Summary)
+@kindex A t @r{(Summary)}
 @findex gnus-article-babel
 Translate the article from one language to another
 (@code{gnus-article-babel}).
@@ -9738,43 +9732,43 @@ instance, @kbd{3 K v} means ``view the third @acronym{MIME} part''.
 @table @kbd
 @item b
 @itemx K v
-@kindex b (Summary)
-@kindex K v (Summary)
+@kindex b @r{(Summary)}
+@kindex K v @r{(Summary)}
 View the @acronym{MIME} part.
 
 @item K o
-@kindex K o (Summary)
+@kindex K o @r{(Summary)}
 Save the @acronym{MIME} part.
 
 @item K O
-@kindex K O (Summary)
+@kindex K O @r{(Summary)}
 Prompt for a file name, then save the @acronym{MIME} part and strip it
 from the article.  The stripped @acronym{MIME} object will be referred
 via the message/external-body @acronym{MIME} type.
 
 @item K r
-@kindex K r (Summary)
+@kindex K r @r{(Summary)}
 Replace the @acronym{MIME} part with an external body.
 
 @item K d
-@kindex K d (Summary)
+@kindex K d @r{(Summary)}
 Delete the @acronym{MIME} part and add some information about the
 removed part.
 
 @item K c
-@kindex K c (Summary)
+@kindex K c @r{(Summary)}
 Copy the @acronym{MIME} part.
 
 @item K e
-@kindex K e (Summary)
+@kindex K e @r{(Summary)}
 View the @acronym{MIME} part externally.
 
 @item K i
-@kindex K i (Summary)
+@kindex K i @r{(Summary)}
 View the @acronym{MIME} part internally.
 
 @item K |
-@kindex K | (Summary)
+@kindex K | @r{(Summary)}
 Pipe the @acronym{MIME} part to an external command.
 @end table
 
@@ -9783,7 +9777,7 @@ the same manner:
 
 @table @kbd
 @item K H
-@kindex K H (Summary)
+@kindex K H @r{(Summary)}
 @findex gnus-article-browse-html-article
 View @samp{text/html} parts of the current article with a WWW browser.
 Inline images embedded in a message using the @code{cid} scheme, as they
@@ -9805,13 +9799,13 @@ including images if any to the browser, and deletes them when exiting
 the group (if you want).
 
 @item K b
-@kindex K b (Summary)
+@kindex K b @r{(Summary)}
 Make all the @acronym{MIME} parts have buttons in front of them.  This is
 mostly useful if you wish to save (or perform other actions) on inlined
 parts.
 
 @item W M h
-@kindex W M h (Summary)
+@kindex W M h @r{(Summary)}
 @findex gnus-mime-buttonize-attachments-in-header
 @vindex gnus-mime-display-attachment-buttons-in-header
 Display @acronym{MIME} part buttons in the end of the header of an
@@ -9824,7 +9818,7 @@ The default is @code{t}.  To change the appearance of buttons, customize
 @code{gnus-header-face-alist}.
 
 @item K m
-@kindex K m (Summary)
+@kindex K m @r{(Summary)}
 @findex gnus-summary-repair-multipart
 Some multipart messages are transmitted with missing or faulty headers.
 This command will attempt to ``repair'' these messages so that they can
@@ -9832,26 +9826,26 @@ be viewed in a more pleasant manner
 (@code{gnus-summary-repair-multipart}).
 
 @item X m
-@kindex X m (Summary)
+@kindex X m @r{(Summary)}
 @findex gnus-summary-save-parts
 Save all parts matching a @acronym{MIME} type to a directory
 (@code{gnus-summary-save-parts}).  Understands the process/prefix
 convention (@pxref{Process/Prefix}).
 
 @item M-t
-@kindex M-t (Summary)
+@kindex M-t @r{(Summary)}
 @findex gnus-summary-toggle-display-buttonized
 Toggle the buttonized display of the article buffer
 (@code{gnus-summary-toggle-display-buttonized}).
 
 @item W M w
-@kindex W M w (Summary)
+@kindex W M w @r{(Summary)}
 @findex gnus-article-decode-mime-words
 Decode RFC 2047-encoded words in the article headers
 (@code{gnus-article-decode-mime-words}).
 
 @item W M c
-@kindex W M c (Summary)
+@kindex W M c @r{(Summary)}
 @findex gnus-article-decode-charset
 Decode encoded article bodies as well as charsets
 (@code{gnus-article-decode-charset}).
@@ -9864,7 +9858,7 @@ include @acronym{MIME} headers), you can set the @code{charset} group/topic
 parameter to the required charset (@pxref{Group Parameters}).
 
 @item W M v
-@kindex W M v (Summary)
+@kindex W M v @r{(Summary)}
 @findex gnus-mime-view-all-parts
 View all the @acronym{MIME} parts in the current article
 (@code{gnus-mime-view-all-parts}).
@@ -10123,7 +10117,7 @@ something like
 @item A P
 @cindex PostScript
 @cindex printing
-@kindex A P (Summary)
+@kindex A P @r{(Summary)}
 @vindex gnus-ps-print-hook
 @findex gnus-summary-print-article
 Generate and print a PostScript image of the article buffer
@@ -10154,68 +10148,68 @@ can't really see why you'd want that.
 @table @kbd
 
 @item C-c C-s C-n
-@kindex C-c C-s C-n (Summary)
+@kindex C-c C-s C-n @r{(Summary)}
 @findex gnus-summary-sort-by-number
 Sort by article number (@code{gnus-summary-sort-by-number}).
 
 @item C-c C-s C-m C-n
-@kindex C-c C-s C-n (Summary)
+@kindex C-c C-s C-n @r{(Summary)}
 @findex gnus-summary-sort-by-most-recent-number
 Sort by most recent article number
 (@code{gnus-summary-sort-by-most-recent-number}).
 
 @item C-c C-s C-a
-@kindex C-c C-s C-a (Summary)
+@kindex C-c C-s C-a @r{(Summary)}
 @findex gnus-summary-sort-by-author
 Sort by author (@code{gnus-summary-sort-by-author}).
 
 @item C-c C-s C-t
-@kindex C-c C-s C-t (Summary)
+@kindex C-c C-s C-t @r{(Summary)}
 @findex gnus-summary-sort-by-recipient
 Sort by recipient (@code{gnus-summary-sort-by-recipient}).
 
 @item C-c C-s C-s
-@kindex C-c C-s C-s (Summary)
+@kindex C-c C-s C-s @r{(Summary)}
 @findex gnus-summary-sort-by-subject
 Sort by subject (@code{gnus-summary-sort-by-subject}).
 
 @item C-c C-s C-d
-@kindex C-c C-s C-d (Summary)
+@kindex C-c C-s C-d @r{(Summary)}
 @findex gnus-summary-sort-by-date
 Sort by date (@code{gnus-summary-sort-by-date}).
 
 @item C-c C-s C-m C-d
-@kindex C-c C-s C-m C-d (Summary)
+@kindex C-c C-s C-m C-d @r{(Summary)}
 @findex gnus-summary-sort-by-most-recent-date
 Sort by most recent date (@code{gnus-summary-sort-by-most-recent-date}).
 
 @item C-c C-s C-l
-@kindex C-c C-s C-l (Summary)
+@kindex C-c C-s C-l @r{(Summary)}
 @findex gnus-summary-sort-by-lines
 Sort by lines (@code{gnus-summary-sort-by-lines}).
 
 @item C-c C-s C-c
-@kindex C-c C-s C-c (Summary)
+@kindex C-c C-s C-c @r{(Summary)}
 @findex gnus-summary-sort-by-chars
 Sort by article length (@code{gnus-summary-sort-by-chars}).
 
 @item C-c C-s C-m C-m
-@kindex C-c C-s C-m C-m (Summary)
+@kindex C-c C-s C-m C-m @r{(Summary)}
 @findex gnus-summary-sort-by-marks
 Sort by article ``readedness'' marks (@code{gnus-summary-sort-by-marks}).
 
 @item C-c C-s C-i
-@kindex C-c C-s C-i (Summary)
+@kindex C-c C-s C-i @r{(Summary)}
 @findex gnus-summary-sort-by-score
 Sort by score (@code{gnus-summary-sort-by-score}).
 
 @item C-c C-s C-r
-@kindex C-c C-s C-r (Summary)
+@kindex C-c C-s C-r @r{(Summary)}
 @findex gnus-summary-sort-by-random
 Randomize (@code{gnus-summary-sort-by-random}).
 
 @item C-c C-s C-o
-@kindex C-c C-s C-o (Summary)
+@kindex C-c C-s C-o @r{(Summary)}
 @findex gnus-summary-sort-by-original
 Sort using the default sorting method
 (@code{gnus-summary-sort-by-original}).
@@ -10238,7 +10232,7 @@ If a prefix argument if given, the sort order is reversed.
 
 @table @kbd
 @item ^
-@kindex ^ (Summary)
+@kindex ^ @r{(Summary)}
 @findex gnus-summary-refer-parent-article
 If you'd like to read the parent of the current article, and it is not
 displayed in the summary buffer, you might still be able to.  That is,
@@ -10258,13 +10252,13 @@ article.
 
 @item A R (Summary)
 @findex gnus-summary-refer-references
-@kindex A R (Summary)
+@kindex A R @r{(Summary)}
 Fetch all articles mentioned in the @code{References} header of the
 article (@code{gnus-summary-refer-references}).
 
 @item A T (Summary)
 @findex gnus-summary-refer-thread
-@kindex A T (Summary)
+@kindex A T @r{(Summary)}
 Display the full thread where the current article appears
 (@code{gnus-summary-refer-thread}).  This command has to fetch all the
 headers in the current group to work, so it usually takes a while.  If
@@ -10282,7 +10276,7 @@ by giving the @kbd{A T} command a numerical prefix.
 
 @item M-^ (Summary)
 @findex gnus-summary-refer-article
-@kindex M-^ (Summary)
+@kindex M-^ @r{(Summary)}
 @cindex Message-ID
 @cindex fetching by Message-ID
 You can also ask Gnus for an arbitrary article, no matter what group it
@@ -10352,7 +10346,6 @@ buffer the articles she wants to read.  Then she starts reading the
 articles with just an article buffer displayed.
 
 @findex gnus-pick-mode
-@kindex M-x gnus-pick-mode
 Gnus provides a summary buffer minor mode that allows
 this---@code{gnus-pick-mode}.  This basically means that a few process
 mark commands become one-keystroke commands to allow easy marking, and
@@ -10362,7 +10355,7 @@ Here are the available keystrokes when using pick mode:
 
 @table @kbd
 @item .
-@kindex . (Pick)
+@kindex . @r{(Pick)}
 @findex gnus-pick-article-or-thread
 Pick the article or thread on the current line
 (@code{gnus-pick-article-or-thread}).  If the variable
@@ -10372,14 +10365,14 @@ it selects just the article.  If given a numerical prefix, go to that
 thread or article and pick it.  (The line number is normally displayed
 at the beginning of the summary pick lines.)
 
-@item SPACE
-@kindex SPACE (Pick)
+@item @key{SPC}
+@kindex @key{SPC} @r{(Pick)}
 @findex gnus-pick-next-page
 Scroll the summary buffer up one page (@code{gnus-pick-next-page}).  If
 at the end of the buffer, start reading the picked articles.
 
 @item u
-@kindex u (Pick)
+@kindex u @r{(Pick)}
 @findex gnus-pick-unmark-article-or-thread.
 Unpick the thread or article
 (@code{gnus-pick-unmark-article-or-thread}).  If the variable
@@ -10388,8 +10381,8 @@ thread if used at the first article of the thread.  Otherwise it unpicks
 just the article.  You can give this key a numerical prefix to unpick
 the thread or article at that line.
 
-@item RET
-@kindex RET (Pick)
+@item @key{RET}
+@kindex @key{RET} @r{(Pick)}
 @findex gnus-pick-start-reading
 @vindex gnus-pick-display-summary
 Start reading the picked articles (@code{gnus-pick-start-reading}).  If
@@ -10431,14 +10424,13 @@ Variables}).  It accepts the same format specs that
 @cindex binary groups
 
 @findex gnus-binary-mode
-@kindex M-x gnus-binary-mode
 If you spend much time in binary groups, you may grow tired of hitting
-@kbd{X u}, @kbd{n}, @kbd{RET} all the time.  @kbd{M-x gnus-binary-mode}
+@kbd{X u}, @kbd{n}, @kbd{@key{RET}} all the time.  @kbd{M-x gnus-binary-mode}
 is a minor mode for summary buffers that makes all ordinary Gnus article
 selection functions uudecode series of articles and display the result
 instead of just displaying the articles the normal way.
 
-@kindex g (Binary)
+@kindex g @r{(Binary)}
 @findex gnus-binary-show-article
 The only way, in fact, to see the actual articles is the @kbd{g}
 command, when you have turned on this mode
@@ -10614,7 +10606,7 @@ process/prefix convention (@pxref{Process/Prefix}).
 @table @kbd
 
 @item B e
-@kindex B e (Summary)
+@kindex B e @r{(Summary)}
 @findex gnus-summary-expire-articles
 @cindex expiring mail
 Run all expirable articles in the current group through the expiry
@@ -10623,7 +10615,7 @@ expirable articles in the group that have been around for a while.
 (@pxref{Expiring Mail}).
 
 @item B C-M-e
-@kindex B C-M-e (Summary)
+@kindex B C-M-e @r{(Summary)}
 @findex gnus-summary-expire-articles-now
 @cindex expiring mail
 Delete all the expirable articles in the group
@@ -10631,8 +10623,8 @@ Delete all the expirable articles in the group
 articles eligible for expiry in the current group will
 disappear forever into that big @file{/dev/null} in the sky.
 
-@item B DEL
-@kindex B DEL (Summary)
+@item B @key{DEL}
+@kindex B @key{DEL} @r{(Summary)}
 @cindex deleting mail
 @findex gnus-summary-delete-article
 @c @icon{gnus-summary-mail-delete}
@@ -10641,7 +10633,7 @@ disk forever and ever, never to return again.'' Use with caution.
 (@code{gnus-summary-delete-article}).
 
 @item B m
-@kindex B m (Summary)
+@kindex B m @r{(Summary)}
 @cindex move mail
 @findex gnus-summary-move-article
 @vindex gnus-preserve-marks
@@ -10650,7 +10642,7 @@ Move the article from one mail group to another
 @code{gnus-preserve-marks} is non-@code{nil} (which is the default).
 
 @item B c
-@kindex B c (Summary)
+@kindex B c @r{(Summary)}
 @cindex copy mail
 @findex gnus-summary-copy-article
 @c @icon{gnus-summary-mail-copy}
@@ -10659,7 +10651,7 @@ Copy the article from one group (mail group or not) to a mail group
 @code{gnus-preserve-marks} is non-@code{nil} (which is the default).
 
 @item B B
-@kindex B B (Summary)
+@kindex B B @r{(Summary)}
 @cindex crosspost mail
 @findex gnus-summary-crosspost-article
 Crosspost the current article to some other group
@@ -10668,21 +10660,21 @@ the article in the other group, and the Xref headers of the article will
 be properly updated.
 
 @item B i
-@kindex B i (Summary)
+@kindex B i @r{(Summary)}
 @findex gnus-summary-import-article
 Import an arbitrary file into the current mail newsgroup
 (@code{gnus-summary-import-article}).  You will be prompted for a file
 name, a @code{From} header and a @code{Subject} header.
 
 @item B I
-@kindex B I (Summary)
+@kindex B I @r{(Summary)}
 @findex gnus-summary-create-article
 Create an empty article in the current mail newsgroups
 (@code{gnus-summary-create-article}).  You will be prompted for a
 @code{From} header and a @code{Subject} header.
 
 @item B r
-@kindex B r (Summary)
+@kindex B r @r{(Summary)}
 @findex gnus-summary-respool-article
 @vindex gnus-summary-respool-default-method
 Respool the mail article (@code{gnus-summary-respool-article}).
@@ -10694,10 +10686,10 @@ Marks will be preserved if @code{gnus-preserve-marks} is non-@code{nil}
 
 @item B w
 @itemx e
-@kindex B w (Summary)
-@kindex e (Summary)
+@kindex B w @r{(Summary)}
+@kindex e @r{(Summary)}
 @findex gnus-summary-edit-article
-@kindex C-c C-c (Article)
+@kindex C-c C-c @r{(Article)}
 @findex gnus-summary-edit-article-done
 Edit the current article (@code{gnus-summary-edit-article}).  To finish
 editing and make the changes permanent, type @kbd{C-c C-c}
@@ -10705,20 +10697,20 @@ editing and make the changes permanent, type @kbd{C-c C-c}
 @kbd{C-c C-c} command, Gnus won't re-highlight the article.
 
 @item B q
-@kindex B q (Summary)
+@kindex B q @r{(Summary)}
 @findex gnus-summary-respool-query
 If you want to re-spool an article, you might be curious as to what group
 the article will end up in before you do the re-spooling.  This command
 will tell you (@code{gnus-summary-respool-query}).
 
 @item B t
-@kindex B t (Summary)
+@kindex B t @r{(Summary)}
 @findex gnus-summary-respool-trace
 Similarly, this command will display all fancy splitting patterns used
 when respooling, if any (@code{gnus-summary-respool-trace}).
 
 @item B p
-@kindex B p (Summary)
+@kindex B p @r{(Summary)}
 @findex gnus-summary-article-posted-p
 Some people have a tendency to send you ``courtesy'' copies when they
 follow up to articles you have posted.  These usually have a
@@ -10732,7 +10724,7 @@ propagation is much faster than news propagation, and the news copy may
 just not have arrived yet.
 
 @item K E
-@kindex K E (Summary)
+@kindex K E @r{(Summary)}
 @findex gnus-article-encrypt-body
 @vindex gnus-article-encrypt-protocol
 Encrypt the body of an article (@code{gnus-article-encrypt-body}).
@@ -10867,20 +10859,20 @@ Also @pxref{Group Parameters}.
 @table @kbd
 
 @item H d
-@kindex H d (Summary)
+@kindex H d @r{(Summary)}
 @findex gnus-summary-describe-group
 Give a brief description of the current group
 (@code{gnus-summary-describe-group}).  If given a prefix, force
 rereading the description from the server.
 
 @item H h
-@kindex H h (Summary)
+@kindex H h @r{(Summary)}
 @findex gnus-summary-describe-briefly
 Give an extremely brief description of the most important summary
 keystrokes (@code{gnus-summary-describe-briefly}).
 
 @item H i
-@kindex H i (Summary)
+@kindex H i @r{(Summary)}
 @findex gnus-info-find-node
 Go to the Gnus info node (@code{gnus-info-find-node}).
 @end table
@@ -10892,31 +10884,31 @@ Go to the Gnus info node (@code{gnus-info-find-node}).
 @table @kbd
 
 @item M-s
-@kindex M-s (Summary)
+@kindex M-s @r{(Summary)}
 @findex gnus-summary-search-article-forward
 Search through all subsequent (raw) articles for a regexp
 (@code{gnus-summary-search-article-forward}).
 
 @item M-r
-@kindex M-r (Summary)
+@kindex M-r @r{(Summary)}
 @findex gnus-summary-search-article-backward
 Search through all previous (raw) articles for a regexp
 (@code{gnus-summary-search-article-backward}).
 
 @item M-S
-@kindex M-S (Summary)
+@kindex M-S @r{(Summary)}
 @findex gnus-summary-repeat-search-article-forward
 Repeat the previous search forwards
 (@code{gnus-summary-repeat-search-article-forward}).
 
 @item M-R
-@kindex M-R (Summary)
+@kindex M-R @r{(Summary)}
 @findex gnus-summary-repeat-search-article-backward
 Repeat the previous search backwards
 (@code{gnus-summary-repeat-search-article-backward}).
 
 @item &
-@kindex & (Summary)
+@kindex & @r{(Summary)}
 @findex gnus-summary-execute-command
 This command will prompt you for a header, a regular expression to match
 on this field, and a command to be executed if the match is made
@@ -10924,11 +10916,12 @@ on this field, and a command to be executed if the match is made
 string, the match is done on the entire article.  If given a prefix,
 search backward instead.
 
-For instance, @kbd{& RET some.*string RET #} will put the process mark on
-all articles that have heads or bodies that match @samp{some.*string}.
+For instance, @kbd{& @key{RET} some.*string @key{RET} #} will put the
+process mark on all articles that have heads or bodies that match
+@samp{some.*string}.
 
 @item M-&
-@kindex M-& (Summary)
+@kindex M-& @r{(Summary)}
 @findex gnus-summary-universal-argument
 Perform any operation on all articles that have been marked with
 the process mark (@code{gnus-summary-universal-argument}).
@@ -10940,24 +10933,24 @@ the process mark (@code{gnus-summary-universal-argument}).
 @table @kbd
 
 @item Y g
-@kindex Y g (Summary)
+@kindex Y g @r{(Summary)}
 @findex gnus-summary-prepare
 Regenerate the current summary buffer (@code{gnus-summary-prepare}).
 
 @item Y c
-@kindex Y c (Summary)
+@kindex Y c @r{(Summary)}
 @findex gnus-summary-insert-cached-articles
 Pull all cached articles (for the current group) into the summary buffer
 (@code{gnus-summary-insert-cached-articles}).
 
 @item Y d
-@kindex Y d (Summary)
+@kindex Y d @r{(Summary)}
 @findex gnus-summary-insert-dormant-articles
 Pull all dormant articles (for the current group) into the summary buffer
 (@code{gnus-summary-insert-dormant-articles}).
 
 @item Y t
-@kindex Y t (Summary)
+@kindex Y t @r{(Summary)}
 @findex gnus-summary-insert-ticked-articles
 Pull all ticked articles (for the current group) into the summary buffer
 (@code{gnus-summary-insert-ticked-articles}).
@@ -10972,8 +10965,8 @@ Pull all ticked articles (for the current group) into the summary buffer
 
 @item A D
 @itemx C-d
-@kindex C-d (Summary)
-@kindex A D (Summary)
+@kindex C-d @r{(Summary)}
+@kindex A D @r{(Summary)}
 @findex gnus-summary-enter-digest-group
 If the current article is a collection of other articles (for instance,
 a digest), you might use this command to enter a group based on that
@@ -11007,7 +11000,7 @@ If it has any other value or there is no next (unread) article, the
 article selected before entering to the digest group will appear.
 
 @item C-M-d
-@kindex C-M-d (Summary)
+@kindex C-M-d @r{(Summary)}
 @findex gnus-summary-read-document
 This command is very similar to the one above, but lets you gather
 several documents into one biiig group
@@ -11018,7 +11011,7 @@ command understands the process/prefix convention
 (@pxref{Process/Prefix}).
 
 @item C-t
-@kindex C-t (Summary)
+@kindex C-t @r{(Summary)}
 @findex gnus-summary-toggle-truncation
 Toggle truncation of summary lines
 (@code{gnus-summary-toggle-truncation}).  This will probably confuse the
@@ -11026,19 +11019,19 @@ line centering function in the summary buffer, so it's not a good idea
 to have truncation switched off while reading articles.
 
 @item =
-@kindex = (Summary)
+@kindex = @r{(Summary)}
 @findex gnus-summary-expand-window
 Expand the summary buffer window (@code{gnus-summary-expand-window}).
 If given a prefix, force an @code{article} window configuration.
 
 @item C-M-e
-@kindex C-M-e (Summary)
+@kindex C-M-e @r{(Summary)}
 @findex gnus-summary-edit-parameters
 Edit the group parameters (@pxref{Group Parameters}) of the current
 group (@code{gnus-summary-edit-parameters}).
 
 @item C-M-a
-@kindex C-M-a (Summary)
+@kindex C-M-a @r{(Summary)}
 @findex gnus-summary-customize-parameters
 Customize the group parameters (@pxref{Group Parameters}) of the current
 group (@code{gnus-summary-customize-parameters}).
@@ -11059,9 +11052,9 @@ group and return you to the group buffer.
 @item Z Z
 @itemx Z Q
 @itemx q
-@kindex Z Z (Summary)
-@kindex Z Q (Summary)
-@kindex q (Summary)
+@kindex Z Z @r{(Summary)}
+@kindex Z Q @r{(Summary)}
+@kindex q @r{(Summary)}
 @findex gnus-summary-exit
 @vindex gnus-summary-exit-hook
 @vindex gnus-summary-prepare-exit-hook
@@ -11077,43 +11070,43 @@ group mode having no more (unread) groups.
 
 @item Z E
 @itemx Q
-@kindex Z E (Summary)
-@kindex Q (Summary)
+@kindex Z E @r{(Summary)}
+@kindex Q @r{(Summary)}
 @findex gnus-summary-exit-no-update
 Exit the current group without updating any information on the group
 (@code{gnus-summary-exit-no-update}).
 
 @item Z c
 @itemx c
-@kindex Z c (Summary)
-@kindex c (Summary)
+@kindex Z c @r{(Summary)}
+@kindex c @r{(Summary)}
 @findex gnus-summary-catchup-and-exit
 @c @icon{gnus-summary-catchup-and-exit}
 Mark all unticked articles in the group as read and then exit
 (@code{gnus-summary-catchup-and-exit}).
 
 @item Z C
-@kindex Z C (Summary)
+@kindex Z C @r{(Summary)}
 @findex gnus-summary-catchup-all-and-exit
 Mark all articles, even the ticked ones, as read and then exit
 (@code{gnus-summary-catchup-all-and-exit}).
 
 @item Z n
-@kindex Z n (Summary)
+@kindex Z n @r{(Summary)}
 @findex gnus-summary-catchup-and-goto-next-group
 Mark all articles as read and go to the next group
 (@code{gnus-summary-catchup-and-goto-next-group}).
 
 @item Z p
-@kindex Z p (Summary)
+@kindex Z p @r{(Summary)}
 @findex gnus-summary-catchup-and-goto-prev-group
 Mark all articles as read and go to the previous group
 (@code{gnus-summary-catchup-and-goto-prev-group}).
 
 @item Z R
 @itemx C-x C-s
-@kindex Z R (Summary)
-@kindex C-x C-s (Summary)
+@kindex Z R @r{(Summary)}
+@kindex C-x C-s @r{(Summary)}
 @findex gnus-summary-reselect-current-group
 Exit this group, and then enter it again
 (@code{gnus-summary-reselect-current-group}).  If given a prefix, select
@@ -11121,8 +11114,8 @@ all articles, both read and unread.
 
 @item Z G
 @itemx M-g
-@kindex Z G (Summary)
-@kindex M-g (Summary)
+@kindex Z G @r{(Summary)}
+@kindex M-g @r{(Summary)}
 @findex gnus-summary-rescan-group
 @c @icon{gnus-summary-mail-get}
 Exit the group, check for new articles in the group, and select the
@@ -11130,19 +11123,19 @@ group (@code{gnus-summary-rescan-group}).  If given a prefix, select all
 articles, both read and unread.
 
 @item Z N
-@kindex Z N (Summary)
+@kindex Z N @r{(Summary)}
 @findex gnus-summary-next-group
 Exit the group and go to the next group
 (@code{gnus-summary-next-group}).
 
 @item Z P
-@kindex Z P (Summary)
+@kindex Z P @r{(Summary)}
 @findex gnus-summary-prev-group
 Exit the group and go to the previous group
 (@code{gnus-summary-prev-group}).
 
 @item Z s
-@kindex Z s (Summary)
+@kindex Z s @r{(Summary)}
 @findex gnus-summary-save-newsrc
 Save the current number of read/marked articles in the dribble buffer
 and then save the dribble buffer (@code{gnus-summary-save-newsrc}).  If
@@ -11413,7 +11406,7 @@ encrypted messages up can be found in the message manual
 @cindex mailing list
 @cindex RFC 2396
 
-@kindex A M (summary)
+@kindex A M @r{(Summary)}
 @findex gnus-mailing-list-insinuate
 Gnus understands some mailing list fields of RFC 2369.  To enable it,
 add a @code{to-list} group parameter (@pxref{Group Parameters}),
@@ -11425,33 +11418,33 @@ That enables the following commands to the summary buffer:
 @table @kbd
 
 @item C-c C-n h
-@kindex C-c C-n h (Summary)
+@kindex C-c C-n h @r{(Summary)}
 @findex gnus-mailing-list-help
 Send a message to fetch mailing list help, if List-Help field exists.
 
 @item C-c C-n s
-@kindex C-c C-n s (Summary)
+@kindex C-c C-n s @r{(Summary)}
 @findex gnus-mailing-list-subscribe
 Send a message to subscribe the mailing list, if List-Subscribe field exists.
 
 @item C-c C-n u
-@kindex C-c C-n u (Summary)
+@kindex C-c C-n u @r{(Summary)}
 @findex gnus-mailing-list-unsubscribe
 Send a message to unsubscribe the mailing list, if List-Unsubscribe
 field exists.
 
 @item C-c C-n p
-@kindex C-c C-n p (Summary)
+@kindex C-c C-n p @r{(Summary)}
 @findex gnus-mailing-list-post
 Post to the mailing list, if List-Post field exists.
 
 @item C-c C-n o
-@kindex C-c C-n o (Summary)
+@kindex C-c C-n o @r{(Summary)}
 @findex gnus-mailing-list-owner
 Send a message to the mailing list owner, if List-Owner field exists.
 
 @item C-c C-n a
-@kindex C-c C-n a (Summary)
+@kindex C-c C-n a @r{(Summary)}
 @findex gnus-mailing-list-archive
 Browse the mailing list archive, if List-Archive field exists.
 
@@ -11629,9 +11622,9 @@ The following commands are available when you have placed point over a
 
 @table @kbd
 @findex gnus-article-press-button
-@item RET (Article)
-@kindex RET (Article)
-@itemx BUTTON-2 (Article)
+@item @key{RET} (Article)
+@kindex @key{RET} @r{(Article)}
+@itemx @key{BUTTON-2} (Article)
 Toggle displaying of the @acronym{MIME} object
 (@code{gnus-article-press-button}).  If built-in viewers can not display
 the object, Gnus resorts to external viewers in the @file{mailcap}
@@ -11639,33 +11632,33 @@ files.  If a viewer has the @samp{copiousoutput} specification, the
 object is displayed inline.
 
 @findex gnus-mime-view-part
-@item M-RET (Article)
-@kindex M-RET (Article)
+@item M-@key{RET} (Article)
+@kindex M-@key{RET} @r{(Article)}
 @itemx v (Article)
 Prompt for a method, and then view the @acronym{MIME} object using this
 method (@code{gnus-mime-view-part}).
 
 @findex gnus-mime-view-part-as-type
 @item t (Article)
-@kindex t (Article)
+@kindex t @r{(Article)}
 View the @acronym{MIME} object as if it were a different @acronym{MIME} media type
 (@code{gnus-mime-view-part-as-type}).
 
 @findex gnus-mime-view-part-as-charset
 @item C (Article)
-@kindex C (Article)
+@kindex C @r{(Article)}
 Prompt for a charset, and then view the @acronym{MIME} object using this
 charset (@code{gnus-mime-view-part-as-charset}).
 
 @findex gnus-mime-save-part
 @item o (Article)
-@kindex o (Article)
+@kindex o @r{(Article)}
 Prompt for a file name, and then save the @acronym{MIME} object
 (@code{gnus-mime-save-part}).
 
 @findex gnus-mime-save-part-and-strip
 @item C-o (Article)
-@kindex C-o (Article)
+@kindex C-o @r{(Article)}
 Prompt for a file name, then save the @acronym{MIME} object and strip it from
 the article.  Then proceed to article editing, where a reasonable
 suggestion is being made on how the altered article should look
@@ -11675,14 +11668,14 @@ message/external-body @acronym{MIME} type.
 
 @findex gnus-mime-replace-part
 @item r (Article)
-@kindex r (Article)
+@kindex r @r{(Article)}
 Prompt for a file name, replace the @acronym{MIME} object with an
 external body referring to the file via the message/external-body
 @acronym{MIME} type.  (@code{gnus-mime-replace-part}).
 
 @findex gnus-mime-delete-part
 @item d (Article)
-@kindex d (Article)
+@kindex d @r{(Article)}
 Delete the @acronym{MIME} object from the article and replace it with some
 information about the removed @acronym{MIME} object
 (@code{gnus-mime-delete-part}).
@@ -11691,7 +11684,7 @@ information about the removed @acronym{MIME} object
 
 @findex gnus-mime-copy-part
 @item c (Article)
-@kindex c (Article)
+@kindex c @r{(Article)}
 Copy the @acronym{MIME} object to a fresh buffer and display this buffer
 (@code{gnus-mime-copy-part}).  If given a prefix, copy the raw contents
 without decoding.  If given a numerical prefix, you can do semi-manual
@@ -11703,14 +11696,14 @@ Accessing Compressed Files, emacs, The Emacs Editor}).
 
 @findex gnus-mime-print-part
 @item p (Article)
-@kindex p (Article)
+@kindex p @r{(Article)}
 Print the @acronym{MIME} object (@code{gnus-mime-print-part}).  This
 command respects the @samp{print=} specifications in the
 @file{.mailcap} file.
 
 @findex gnus-mime-inline-part
 @item i (Article)
-@kindex i (Article)
+@kindex i @r{(Article)}
 Insert the contents of the @acronym{MIME} object into the buffer
 (@code{gnus-mime-inline-part}) as @samp{text/plain}.  If given a prefix, insert
 the raw contents without decoding.  If given a numerical prefix, you can
@@ -11723,25 +11716,25 @@ Compressed Files, emacs, The Emacs Editor}).
 
 @findex gnus-mime-view-part-internally
 @item E (Article)
-@kindex E (Article)
+@kindex E @r{(Article)}
 View the @acronym{MIME} object with an internal viewer.  If no internal
 viewer is available, use an external viewer
 (@code{gnus-mime-view-part-internally}).
 
 @findex gnus-mime-view-part-externally
 @item e (Article)
-@kindex e (Article)
+@kindex e @r{(Article)}
 View the @acronym{MIME} object with an external viewer.
 (@code{gnus-mime-view-part-externally}).
 
 @findex gnus-mime-pipe-part
 @item | (Article)
-@kindex | (Article)
+@kindex | @r{(Article)}
 Output the @acronym{MIME} object to a process (@code{gnus-mime-pipe-part}).
 
 @findex gnus-mime-action-on-part
 @item . (Article)
-@kindex . (Article)
+@kindex . @r{(Article)}
 Interactively run an action on the @acronym{MIME} object
 (@code{gnus-mime-action-on-part}).
 
@@ -11925,7 +11918,7 @@ controlling variable is a predicate list, as described above.
 
 @ifinfo
 @c Avoid sort of redundant entries in the same section for the printed
-@c manual, but add them in info to allow 'i gnus-treat-foo-bar RET' or
+@c manual, but add them in info to allow 'i gnus-treat-foo-bar @key{RET}' or
 @c 'i foo-bar'.
 @vindex gnus-treat-buttonize
 @vindex gnus-treat-buttonize-head
@@ -12130,7 +12123,7 @@ buffer, which means that you don't actually have to have a summary
 buffer displayed while reading.  You can do it all from the article
 buffer.
 
-@kindex v (Article)
+@kindex v @r{(Article)}
 @cindex keys, reserved for users (Article)
 The key @kbd{v} is reserved for users.  You can bind it to some
 command or better use it as a prefix key.
@@ -12139,70 +12132,70 @@ A few additional keystrokes are available:
 
 @table @kbd
 
-@item SPACE
-@kindex SPACE (Article)
+@item @key{SPC}
+@kindex @key{SPC} @r{(Article)}
 @findex gnus-article-next-page
 Scroll forwards one page (@code{gnus-article-next-page}).
-This is exactly the same as @kbd{h SPACE h}.
+This is exactly the same as @kbd{h @key{SPC} h}.
 
-@item DEL
-@kindex DEL (Article)
+@item @key{DEL}
+@kindex @key{DEL} @r{(Article)}
 @findex gnus-article-prev-page
 Scroll backwards one page (@code{gnus-article-prev-page}).
-This is exactly the same as @kbd{h DEL h}.
+This is exactly the same as @kbd{h @key{DEL} h}.
 
 @item C-c ^
-@kindex C-c ^ (Article)
+@kindex C-c ^ @r{(Article)}
 @findex gnus-article-refer-article
 If point is in the neighborhood of a @code{Message-ID} and you press
 @kbd{C-c ^}, Gnus will try to get that article from the server
 (@code{gnus-article-refer-article}).
 
 @item C-c C-m
-@kindex C-c C-m (Article)
+@kindex C-c C-m @r{(Article)}
 @findex gnus-article-mail
 Send a reply to the address near point (@code{gnus-article-mail}).  If
 given a prefix, include the mail.
 
 @item s
-@kindex s (Article)
+@kindex s @r{(Article)}
 @findex gnus-article-show-summary
 Reconfigure the buffers so that the summary buffer becomes visible
 (@code{gnus-article-show-summary}).
 
 @item ?
-@kindex ? (Article)
+@kindex ? @r{(Article)}
 @findex gnus-article-describe-briefly
 Give a very brief description of the available keystrokes
 (@code{gnus-article-describe-briefly}).
 
-@item TAB
-@kindex TAB (Article)
+@item @key{TAB}
+@kindex @key{TAB} @r{(Article)}
 @findex gnus-article-next-button
 Go to the next button, if any (@code{gnus-article-next-button}).  This
 only makes sense if you have buttonizing turned on.
 
-@item M-TAB
-@kindex M-TAB (Article)
+@item M-@key{TAB}
+@kindex M-@key{TAB} @r{(Article)}
 @findex gnus-article-prev-button
 Go to the previous button, if any (@code{gnus-article-prev-button}).
 
 @item R
-@kindex R (Article)
+@kindex R @r{(Article)}
 @findex gnus-article-reply-with-original
 Send a reply to the current article and yank the current article
 (@code{gnus-article-reply-with-original}).  If the region is active,
 only yank the text in the region.
 
 @item S W
-@kindex S W (Article)
+@kindex S W @r{(Article)}
 @findex gnus-article-wide-reply-with-original
 Send a wide reply to the current article and yank the current article
 (@code{gnus-article-wide-reply-with-original}).  If the region is
 active, only yank the text in the region.
 
 @item F
-@kindex F (Article)
+@kindex F @r{(Article)}
 @findex gnus-article-followup-with-original
 Send a followup to the current article and yank the current article
 (@code{gnus-article-followup-with-original}).  If the region is active,
@@ -12348,7 +12341,7 @@ when @code{mm-text-html-renderer} (@pxref{Display Customization,
 @cindex using s/mime
 @cindex using smime
 
-@kindex C-c C-c (Post)
+@kindex C-c C-c @r{(Post)}
 All commands for posting and mailing will put you in a message buffer
 where you can edit the article all you like, before you send the
 article by pressing @kbd{C-c C-c}.  @xref{Top, , Overview, message,
@@ -12946,10 +12939,10 @@ correct parameters.  The content of the group is not lost.
 
 @c @findex gnus-dissociate-buffer-from-draft
 @c @kindex C-c M-d (Mail)
-@c @kindex C-c M-d (Post)
+@c @kindex C-c M-d @r{(Post)}
 @c @findex gnus-associate-buffer-with-draft
 @c @kindex C-c C-d (Mail)
-@c @kindex C-c C-d (Post)
+@c @kindex C-c C-d @r{(Post)}
 @c If you're writing some super-secret message that you later want to
 @c encode with PGP before sending, you may wish to turn the auto-saving
 @c (and association with the draft group) off.  You never know who might be
@@ -12964,7 +12957,7 @@ correct parameters.  The content of the group is not lost.
 @c @code{gnus-use-draft} to @code{nil}.  It is @code{t} by default.
 
 @findex gnus-draft-edit-message
-@kindex D e (Draft)
+@kindex D e @r{(Draft)}
 When you want to continue editing the article, you simply enter the
 draft group and push @kbd{D e} (@code{gnus-draft-edit-message}) to do
 that.  You will be placed in a buffer where you left off.
@@ -12973,9 +12966,9 @@ Rejected articles will also be put in this draft group (@pxref{Rejected
 Articles}).
 
 @findex gnus-draft-send-all-messages
-@kindex D s (Draft)
+@kindex D s @r{(Draft)}
 @findex gnus-draft-send-message
-@kindex D S (Draft)
+@kindex D S @r{(Draft)}
 If you have lots of rejected messages you want to post (or mail) without
 doing further editing, you can use the @kbd{D s} command
 (@code{gnus-draft-send-message}).  This command understands the
@@ -12984,12 +12977,12 @@ command (@code{gnus-draft-send-all-messages}) will ship off all messages
 in the buffer.
 
 @findex gnus-draft-toggle-sending
-@kindex D t (Draft)
+@kindex D t @r{(Draft)}
 If you have some messages that you wish not to send, you can use the
 @kbd{D t} (@code{gnus-draft-toggle-sending}) command to mark the message
 as unsendable.  This is a toggling command.
 
-Finally, if you want to delete a draft, use the normal @kbd{B DEL}
+Finally, if you want to delete a draft, use the normal @kbd{B @key{DEL}}
 command (@pxref{Mail Group Commands}).
 
 
@@ -13041,43 +13034,43 @@ signing and the @kbd{C-c C-m c} key map for encryption, as follows.
 @table @kbd
 
 @item C-c C-m s s
-@kindex C-c C-m s s (Message)
+@kindex C-c C-m s s @r{(Message)}
 @findex mml-secure-message-sign-smime
 
 Digitally sign current message using @acronym{S/MIME}.
 
 @item C-c C-m s o
-@kindex C-c C-m s o (Message)
+@kindex C-c C-m s o @r{(Message)}
 @findex mml-secure-message-sign-pgp
 
 Digitally sign current message using @acronym{PGP}.
 
 @item C-c C-m s p
-@kindex C-c C-m s p (Message)
+@kindex C-c C-m s p @r{(Message)}
 @findex mml-secure-message-sign-pgp
 
 Digitally sign current message using @acronym{PGP/MIME}.
 
 @item C-c C-m c s
-@kindex C-c C-m c s (Message)
+@kindex C-c C-m c s @r{(Message)}
 @findex mml-secure-message-encrypt-smime
 
 Digitally encrypt current message using @acronym{S/MIME}.
 
 @item C-c C-m c o
-@kindex C-c C-m c o (Message)
+@kindex C-c C-m c o @r{(Message)}
 @findex mml-secure-message-encrypt-pgp
 
 Digitally encrypt current message using @acronym{PGP}.
 
 @item C-c C-m c p
-@kindex C-c C-m c p (Message)
+@kindex C-c C-m c p @r{(Message)}
 @findex mml-secure-message-encrypt-pgpmime
 
 Digitally encrypt current message using @acronym{PGP/MIME}.
 
 @item C-c C-m C-n
-@kindex C-c C-m C-n (Message)
+@kindex C-c C-m C-n @r{(Message)}
 @findex mml-unsecure-message
 Remove security related @acronym{MML} tags from message.
 
@@ -13224,72 +13217,72 @@ in your init files.
 @table @kbd
 
 @item v
-@kindex v (Server)
+@kindex v @r{(Server)}
 @cindex keys, reserved for users (Server)
 The key @kbd{v} is reserved for users.  You can bind it to some
 command or better use it as a prefix key.
 
 @item a
-@kindex a (Server)
+@kindex a @r{(Server)}
 @findex gnus-server-add-server
 Add a new server (@code{gnus-server-add-server}).
 
 @item e
-@kindex e (Server)
+@kindex e @r{(Server)}
 @findex gnus-server-edit-server
 Edit a server (@code{gnus-server-edit-server}).
 
 @item S
-@kindex S (Server)
+@kindex S @r{(Server)}
 @findex gnus-server-show-server
 Show the definition of a server (@code{gnus-server-show-server}).
 
-@item SPACE
-@kindex SPACE (Server)
+@item @key{SPC}
+@kindex @key{SPC} @r{(Server)}
 @findex gnus-server-read-server
 Browse the current server (@code{gnus-server-read-server}).
 
 @item q
-@kindex q (Server)
+@kindex q @r{(Server)}
 @findex gnus-server-exit
 Return to the group buffer (@code{gnus-server-exit}).
 
 @item k
-@kindex k (Server)
+@kindex k @r{(Server)}
 @findex gnus-server-kill-server
 Kill the current server (@code{gnus-server-kill-server}).
 
 @item y
-@kindex y (Server)
+@kindex y @r{(Server)}
 @findex gnus-server-yank-server
 Yank the previously killed server (@code{gnus-server-yank-server}).
 
 @item c
-@kindex c (Server)
+@kindex c @r{(Server)}
 @findex gnus-server-copy-server
 Copy the current server (@code{gnus-server-copy-server}).
 
 @item l
-@kindex l (Server)
+@kindex l @r{(Server)}
 @findex gnus-server-list-servers
 List all servers (@code{gnus-server-list-servers}).
 
 @item s
-@kindex s (Server)
+@kindex s @r{(Server)}
 @findex gnus-server-scan-server
 Request that the server scan its sources for new articles
 (@code{gnus-server-scan-server}).  This is mainly sensible with mail
 servers.
 
 @item g
-@kindex g (Server)
+@kindex g @r{(Server)}
 @findex gnus-server-regenerate-server
 Request that the server regenerate all its data structures
 (@code{gnus-server-regenerate-server}).  This can be useful if you have
 a mail back end that has gotten out of sync.
 
 @item z
-@kindex z (Server)
+@kindex z @r{(Server)}
 @findex gnus-server-compact-server
 
 Compact all groups in the server under point
@@ -13421,7 +13414,7 @@ First you need to add a new server.  The @kbd{a} command does that.  It
 would probably be best to use @code{nnml} to read the cache.  You
 could also use @code{nnspool} or @code{nnmh}, though.
 
-Type @kbd{a nnml RET cache RET}.
+Type @kbd{a nnml @key{RET} cache @key{RET}}.
 
 You should now have a brand new @code{nnml} virtual server called
 @samp{cache}.  You now need to edit it to have the right definitions.
@@ -13441,7 +13434,7 @@ Change that to:
 @end lisp
 
 Type @kbd{C-c C-c} to return to the server buffer.  If you now press
-@kbd{RET} over this virtual server, you should be entered into a browse
+@kbd{@key{RET}} over this virtual server, you should be entered into a browse
 buffer, and you should be able to enter any of the groups displayed.
 
 
@@ -13512,44 +13505,44 @@ with the following commands:
 @table @kbd
 
 @item O
-@kindex O (Server)
+@kindex O @r{(Server)}
 @findex gnus-server-open-server
 Try to establish connection to the server on the current line
 (@code{gnus-server-open-server}).
 
 @item C
-@kindex C (Server)
+@kindex C @r{(Server)}
 @findex gnus-server-close-server
 Close the connection (if any) to the server
 (@code{gnus-server-close-server}).
 
 @item D
-@kindex D (Server)
+@kindex D @r{(Server)}
 @findex gnus-server-deny-server
 Mark the current server as unreachable
 (@code{gnus-server-deny-server}).  This will effectively disable the
 server.
 
 @item M-o
-@kindex M-o (Server)
+@kindex M-o @r{(Server)}
 @findex gnus-server-open-all-servers
 Open the connections to all servers in the buffer
 (@code{gnus-server-open-all-servers}).
 
 @item M-c
-@kindex M-c (Server)
+@kindex M-c @r{(Server)}
 @findex gnus-server-close-all-servers
 Close the connections to all servers in the buffer
 (@code{gnus-server-close-all-servers}).
 
 @item R
-@kindex R (Server)
+@kindex R @r{(Server)}
 @findex gnus-server-remove-denials
 Remove all marks to whether Gnus was denied connection from any servers
 (@code{gnus-server-remove-denials}).
 
 @item c
-@kindex c (Server)
+@kindex c @r{(Server)}
 @findex gnus-server-copy-server
 Copy a server and give it a new name
 (@code{gnus-server-copy-server}).  This can be useful if you have a
@@ -13557,7 +13550,7 @@ complex method definition, and want to use the same definition towards
 a different (physical) server.
 
 @item L
-@kindex L (Server)
+@kindex L @r{(Server)}
 @findex gnus-server-offline-server
 Set server status to offline (@code{gnus-server-offline-server}).
 
@@ -14565,7 +14558,7 @@ see @ref{Fancy Mail Splitting}.
 Note that the mail back ends are free to maul the poor, innocent,
 incoming headers all they want to.  They all add @code{Lines} headers;
 some add @code{X-Gnus-Group} headers; most rename the Unix mbox
-@code{From<SPACE>} line to something else.
+@code{From@key{SPC}} line to something else.
 
 @vindex nnmail-crosspost
 The mail back ends all support cross-posting.  If several regexps match,
@@ -14582,7 +14575,6 @@ links.  If that's the case for you, set
 @code{nnmail-crosspost-link-function} to @code{copy-file}.  (This
 variable is @code{add-name-to-file} by default.)
 
-@kindex M-x nnmail-split-history
 @findex nnmail-split-history
 If you wish to see where the previous mail split put the messages, you
 can use the @kbd{M-x nnmail-split-history} command.  If you wish to see
@@ -15721,7 +15713,7 @@ Type @kbd{G f} and give the file name to the mbox file when prompted to create a
 @code{nndoc} group from the mbox file (@pxref{Foreign Groups}).
 
 @item
-Type @kbd{SPACE} to enter the newly created group.
+Type @kbd{@key{SPC}} to enter the newly created group.
 
 @item
 Type @kbd{M P b} to process-mark all articles in this group's buffer
@@ -16036,7 +16028,7 @@ This can also be done non-destructively with
 
 @item nnmail-remove-tabs
 @findex nnmail-remove-tabs
-Translate all @samp{TAB} characters into @samp{SPACE} characters.
+Translate all @samp{@key{TAB}} characters into @samp{@key{SPC}} characters.
 
 @item nnmail-ignore-broken-references
 @findex nnmail-ignore-broken-references
@@ -16713,7 +16705,6 @@ The directory where the @acronym{NOV} files should be stored.  If
 
 
 @findex nnfolder-generate-active-file
-@kindex M-x nnfolder-generate-active-file
 If you have lots of @code{nnfolder}-like files you'd like to read with
 @code{nnfolder}, you can use the @kbd{M-x nnfolder-generate-active-file}
 command to make @code{nnfolder} aware of all likely files in
@@ -17062,14 +17053,14 @@ system because @acronym{RSS} uses UTF-8 for encoding non-@acronym{ASCII}
 text by default.  It is also used by default for non-@acronym{ASCII}
 group names.
 
-@kindex G R (Group)
+@kindex G R @r{(Group)}
 Use @kbd{G R} from the group buffer to subscribe to a feed---you will be
 prompted for the location, the title and the description of the feed.
 The title, which allows any characters, will be used for the group name
 and the name of the group data file.  The description can be omitted.
 
 An easy way to get started with @code{nnrss} is to say something like
-the following in the group buffer: @kbd{B nnrss RET RET y}, then
+the following in the group buffer: @kbd{B nnrss @key{RET} @key{RET} y}, then
 subscribe to groups.
 
 The @code{nnrss} back end saves the group data file in
@@ -18670,51 +18661,51 @@ The following commands are available in this buffer:
 
 @table @kbd
 @item q
-@kindex q (Category)
+@kindex q @r{(Category)}
 @findex gnus-category-exit
 Return to the group buffer (@code{gnus-category-exit}).
 
 @item e
-@kindex e (Category)
+@kindex e @r{(Category)}
 @findex gnus-category-customize-category
 Use a customization buffer to set all of the selected category's
 parameters at one time (@code{gnus-category-customize-category}).
 
 @item k
-@kindex k (Category)
+@kindex k @r{(Category)}
 @findex gnus-category-kill
 Kill the current category (@code{gnus-category-kill}).
 
 @item c
-@kindex c (Category)
+@kindex c @r{(Category)}
 @findex gnus-category-copy
 Copy the current category (@code{gnus-category-copy}).
 
 @item a
-@kindex a (Category)
+@kindex a @r{(Category)}
 @findex gnus-category-add
 Add a new category (@code{gnus-category-add}).
 
 @item p
-@kindex p (Category)
+@kindex p @r{(Category)}
 @findex gnus-category-edit-predicate
 Edit the predicate of the current category
 (@code{gnus-category-edit-predicate}).
 
 @item g
-@kindex g (Category)
+@kindex g @r{(Category)}
 @findex gnus-category-edit-groups
 Edit the list of groups belonging to the current category
 (@code{gnus-category-edit-groups}).
 
 @item s
-@kindex s (Category)
+@kindex s @r{(Category)}
 @findex gnus-category-edit-score
 Edit the download score rule of the current category
 (@code{gnus-category-edit-score}).
 
 @item l
-@kindex l (Category)
+@kindex l @r{(Category)}
 @findex gnus-category-list
 List all the categories (@code{gnus-category-list}).
 @end table
@@ -18788,7 +18779,7 @@ have to enable expiration in selected groups.
 @node Agent Commands
 @subsection Agent Commands
 @findex gnus-agent-toggle-plugged
-@kindex J j (Agent)
+@kindex J j @r{(Agent)}
 
 All the Gnus Agent commands are on the @kbd{J} submap.  The @kbd{J j}
 (@code{gnus-agent-toggle-plugged}) command works in all modes, and
@@ -18809,44 +18800,44 @@ toggles the plugged/unplugged state of the Gnus Agent.
 
 @table @kbd
 @item J u
-@kindex J u (Agent Group)
+@kindex J u @r{(Agent Group)}
 @findex gnus-agent-fetch-groups
 Fetch all eligible articles in the current group
 (@code{gnus-agent-fetch-groups}).
 
 @item J c
-@kindex J c (Agent Group)
+@kindex J c @r{(Agent Group)}
 @findex gnus-enter-category-buffer
 Enter the Agent category buffer (@code{gnus-enter-category-buffer}).
 
 @item J s
-@kindex J s (Agent Group)
+@kindex J s @r{(Agent Group)}
 @findex gnus-agent-fetch-session
 Fetch all eligible articles in all groups
 (@code{gnus-agent-fetch-session}).
 
 @item J S
-@kindex J S (Agent Group)
+@kindex J S @r{(Agent Group)}
 @findex gnus-group-send-queue
 Send all sendable messages in the queue group
 (@code{gnus-group-send-queue}).  @xref{Drafts}.
 
 @item J a
-@kindex J a (Agent Group)
+@kindex J a @r{(Agent Group)}
 @findex gnus-agent-add-group
 Add the current group to an Agent category
 (@code{gnus-agent-add-group}).  This command understands the
 process/prefix convention (@pxref{Process/Prefix}).
 
 @item J r
-@kindex J r (Agent Group)
+@kindex J r @r{(Agent Group)}
 @findex gnus-agent-remove-group
 Remove the current group from its category, if any
 (@code{gnus-agent-remove-group}).  This command understands the
 process/prefix convention (@pxref{Process/Prefix}).
 
 @item J Y
-@kindex J Y (Agent Group)
+@kindex J Y @r{(Agent Group)}
 @findex gnus-agent-synchronize-flags
 Synchronize flags changed while unplugged with remote server, if any.
 
@@ -18859,43 +18850,43 @@ Synchronize flags changed while unplugged with remote server, if any.
 
 @table @kbd
 @item J #
-@kindex J # (Agent Summary)
+@kindex J # @r{(Agent Summary)}
 @findex gnus-agent-mark-article
 Mark the article for downloading (@code{gnus-agent-mark-article}).
 
 @item J M-#
-@kindex J M-# (Agent Summary)
+@kindex J M-# @r{(Agent Summary)}
 @findex gnus-agent-unmark-article
 Remove the downloading mark from the article
 (@code{gnus-agent-unmark-article}).
 
 @cindex %
 @item @@
-@kindex @@ (Agent Summary)
+@kindex @@ @r{(Agent Summary)}
 @findex gnus-agent-toggle-mark
 Toggle whether to download the article
 (@code{gnus-agent-toggle-mark}).  The download mark is @samp{%} by
 default.
 
 @item J c
-@kindex J c (Agent Summary)
+@kindex J c @r{(Agent Summary)}
 @findex gnus-agent-catchup
 Mark all articles as read (@code{gnus-agent-catchup}) that are neither cached, downloaded, nor downloadable.
 
 @item J S
-@kindex J S (Agent Summary)
+@kindex J S @r{(Agent Summary)}
 @findex gnus-agent-fetch-group
 Download all eligible (@pxref{Agent Categories}) articles in this group.
 (@code{gnus-agent-fetch-group}).
 
 @item J s
-@kindex J s (Agent Summary)
+@kindex J s @r{(Agent Summary)}
 @findex gnus-agent-summary-fetch-series
 Download all processable articles in this group.
 (@code{gnus-agent-summary-fetch-series}).
 
 @item J u
-@kindex J u (Agent Summary)
+@kindex J u @r{(Agent Summary)}
 @findex gnus-agent-summary-fetch-group
 Download all downloadable articles in the current group
 (@code{gnus-agent-summary-fetch-group}).
@@ -18908,13 +18899,13 @@ Download all downloadable articles in the current group
 
 @table @kbd
 @item J a
-@kindex J a (Agent Server)
+@kindex J a @r{(Agent Server)}
 @findex gnus-agent-add-server
 Add the current server to the list of servers covered by the Gnus Agent
 (@code{gnus-agent-add-server}).
 
 @item J r
-@kindex J r (Agent Server)
+@kindex J r @r{(Agent Server)}
 @findex gnus-agent-remove-server
 Remove the current server from the list of servers covered by the Gnus
 Agent (@code{gnus-agent-remove-server}).
@@ -19015,8 +19006,6 @@ sense if you are using a nntp or nnimap back end.
 
 @vindex gnus-agent-expire-days
 @findex gnus-agent-expire
-@kindex M-x gnus-agent-expire
-@kindex M-x gnus-agent-expire-group
 @findex gnus-agent-expire-group
 @cindex agent expiry
 @cindex Gnus agent expiry
@@ -19070,14 +19059,12 @@ failure.  Running @code{gnus-agent-regenerate} or
 such that you don't need to download these articles a second time.
 
 @findex gnus-agent-regenerate
-@kindex M-x gnus-agent-regenerate
 The command @code{gnus-agent-regenerate} will perform
 @code{gnus-agent-regenerate-group} on every agentized group.  While
 you can run @code{gnus-agent-regenerate} in any buffer, it is strongly
 recommended that you first close all summary buffers.
 
 @findex gnus-agent-regenerate-group
-@kindex M-x gnus-agent-regenerate-group
 The command @code{gnus-agent-regenerate-group} uses the local copies
 of individual articles to repair the local @acronym{NOV}(header) database.  It
 then updates the internal data structures that document which articles
@@ -19463,18 +19450,18 @@ General score commands that don't actually change the score file:
 @table @kbd
 
 @item V s
-@kindex V s (Summary)
+@kindex V s @r{(Summary)}
 @findex gnus-summary-set-score
 Set the score of the current article (@code{gnus-summary-set-score}).
 
 @item V S
-@kindex V S (Summary)
+@kindex V S @r{(Summary)}
 @findex gnus-summary-current-score
 Display the score of the current article
 (@code{gnus-summary-current-score}).
 
 @item V t
-@kindex V t (Summary)
+@kindex V t @r{(Summary)}
 @findex gnus-score-find-trace
 Display all score rules that have been used on the current article
 (@code{gnus-score-find-trace}).  In the @file{*Score Trace*} buffer, you
@@ -19483,12 +19470,12 @@ current line and @kbd{f} to format (@code{gnus-score-pretty-print}) the
 score file and edit it.
 
 @item V w
-@kindex V w (Summary)
+@kindex V w @r{(Summary)}
 @findex gnus-score-find-favourite-words
 List words used in scoring (@code{gnus-score-find-favourite-words}).
 
 @item V R
-@kindex V R (Summary)
+@kindex V R @r{(Summary)}
 @findex gnus-summary-rescore
 Run the current summary through the scoring process
 (@code{gnus-summary-rescore}).  This might be useful if you're playing
@@ -19496,32 +19483,32 @@ around with your score files behind Gnus' back and want to see the
 effect you're having.
 
 @item V c
-@kindex V c (Summary)
+@kindex V c @r{(Summary)}
 @findex gnus-score-change-score-file
 Make a different score file the current
 (@code{gnus-score-change-score-file}).
 
 @item V e
-@kindex V e (Summary)
+@kindex V e @r{(Summary)}
 @findex gnus-score-edit-current-scores
 Edit the current score file (@code{gnus-score-edit-current-scores}).
 You will be popped into a @code{gnus-score-mode} buffer (@pxref{Score
 File Editing}).
 
 @item V f
-@kindex V f (Summary)
+@kindex V f @r{(Summary)}
 @findex gnus-score-edit-file
 Edit a score file and make this score file the current one
 (@code{gnus-score-edit-file}).
 
 @item V F
-@kindex V F (Summary)
+@kindex V F @r{(Summary)}
 @findex gnus-score-flush-cache
 Flush the score cache (@code{gnus-score-flush-cache}).  This is useful
 after editing score files.
 
 @item V C
-@kindex V C (Summary)
+@kindex V C @r{(Summary)}
 @findex gnus-score-customize
 Customize a score file in a visually pleasing manner
 (@code{gnus-score-customize}).
@@ -19533,13 +19520,13 @@ The rest of these commands modify the local score file.
 @table @kbd
 
 @item V m
-@kindex V m (Summary)
+@kindex V m @r{(Summary)}
 @findex gnus-score-set-mark-below
 Prompt for a score, and mark all articles with a score below this as
 read (@code{gnus-score-set-mark-below}).
 
 @item V x
-@kindex V x (Summary)
+@kindex V x @r{(Summary)}
 @findex gnus-score-set-expunge-below
 Prompt for a score, and add a score rule to the current score file to
 expunge all articles below this score
@@ -19674,7 +19661,7 @@ Immediately scoring.
 @item
 If you are scoring on @samp{e} (extra) headers, you will then be prompted for
 the header name on which you wish to score.  This must be a header named
-in gnus-extra-headers, and @samp{TAB} completion is available.
+in gnus-extra-headers, and @samp{@key{TAB}} completion is available.
 
 @end enumerate
 
@@ -19709,13 +19696,13 @@ There aren't many of these as yet, I'm afraid.
 @table @kbd
 
 @item W e
-@kindex W e (Group)
+@kindex W e @r{(Group)}
 @findex gnus-score-edit-all-score
 Edit the apply-to-all-groups all.SCORE file.  You will be popped into
 a @code{gnus-score-mode} buffer (@pxref{Score File Editing}).
 
 @item W f
-@kindex W f (Group)
+@kindex W f @r{(Group)}
 @findex gnus-score-flush-cache
 Gnus maintains a cache of score alists to avoid having to reload them
 all the time.  This command will flush the cache
@@ -20199,20 +20186,20 @@ additional commands:
 @table @kbd
 
 @item C-c C-c
-@kindex C-c C-c (Score)
+@kindex C-c C-c @r{(Score)}
 @findex gnus-score-edit-exit
 Save the changes you have made and return to the summary buffer
 (@code{gnus-score-edit-exit}).
 
 @item C-c C-d
-@kindex C-c C-d (Score)
+@kindex C-c C-d @r{(Score)}
 @findex gnus-score-edit-insert-date
 Insert the current date in numerical format
 (@code{gnus-score-edit-insert-date}).  This is really the day number, if
 you were wondering.
 
 @item C-c C-p
-@kindex C-c C-p (Score)
+@kindex C-c C-p @r{(Score)}
 @findex gnus-score-pretty-print
 The adaptive score files are saved in an unformatted fashion.  If you
 intend to read one of these files, you want to @dfn{pretty print} it
@@ -20578,7 +20565,7 @@ Restart Gnus and rebuild your @code{nnml} overview files with the
 time if you have much mail.
 
 Now you can score on @samp{To} and @samp{Cc} as ``extra headers'' like
-so: @kbd{I e s p To RET <your name> RET}.
+so: @kbd{I e s p To @key{RET} <your name> @key{RET}}.
 
 See?  Simple.
 
@@ -20765,12 +20752,12 @@ Two summary functions for editing a @sc{gnus} kill file:
 @table @kbd
 
 @item M-k
-@kindex M-k (Summary)
+@kindex M-k @r{(Summary)}
 @findex gnus-summary-edit-local-kill
 Edit this group's kill file (@code{gnus-summary-edit-local-kill}).
 
 @item M-K
-@kindex M-K (Summary)
+@kindex M-K @r{(Summary)}
 @findex gnus-summary-edit-global-kill
 Edit the general kill file (@code{gnus-summary-edit-global-kill}).
 @end table
@@ -20780,12 +20767,12 @@ Two group mode functions for editing the kill files:
 @table @kbd
 
 @item M-k
-@kindex M-k (Group)
+@kindex M-k @r{(Group)}
 @findex gnus-group-edit-local-kill
 Edit this group's kill file (@code{gnus-group-edit-local-kill}).
 
 @item M-K
-@kindex M-K (Group)
+@kindex M-K @r{(Group)}
 @findex gnus-group-edit-global-kill
 Edit the general kill file (@code{gnus-group-edit-global-kill}).
 @end table
@@ -21725,7 +21712,7 @@ want.
 @item
 The name of the @strong{back end server} where mairix should store its
 searches.  This must be a full server name, like @code{nnml:mymail}.
-Just hit @kbd{TAB} to see the available servers.  Currently, servers
+Just hit @kbd{@key{TAB}} to see the available servers.  Currently, servers
 which are accessed through @code{nnmaildir}, @code{nnimap} and
 @code{nnml} are supported.  As explained above, for locally stored
 mails, this can be an existing server where you store your mails.
@@ -21770,34 +21757,34 @@ In group mode:
 @table @kbd
 
 @item G b c
-@kindex G b c (Group)
+@kindex G b c @r{(Group)}
 @findex nnmairix-create-server-and-default-group
 Creates @code{nnmairix} server and default search group for this server
 (@code{nnmairix-create-server-and-default-group}).  You should have done
 this by now (@pxref{Configuring nnmairix}).
 
 @item G b s
-@kindex G b s (Group)
+@kindex G b s @r{(Group)}
 @findex nnmairix-search
 Prompts for query which is then sent to the mairix binary.  Search
 results are put into the default search group which is automatically
 displayed (@code{nnmairix-search}).
 
 @item G b m
-@kindex G b m (Group)
+@kindex G b m @r{(Group)}
 @findex nnmairix-widget-search
 Allows you to create a mairix search or a permanent group more
 comfortably using graphical widgets, similar to a customization
 group.  Just try it to see how it works (@code{nnmairix-widget-search}).
 
 @item G b i
-@kindex G b i (Group)
+@kindex G b i @r{(Group)}
 @findex nnmairix-search-interactive
 Another command for creating a mairix query more comfortably, but uses
 only the minibuffer (@code{nnmairix-search-interactive}).
 
 @item G b g
-@kindex G b g (Group)
+@kindex G b g @r{(Group)}
 @findex nnmairix-create-search-group
 Creates a permanent group which is associated with a search query
 (@code{nnmairix-create-search-group}).  The @code{nnmairix} back end
@@ -21805,20 +21792,20 @@ automatically calls mairix when you update this group with @kbd{g} or
 @kbd{M-g}.
 
 @item G b q
-@kindex G b q (Group)
+@kindex G b q @r{(Group)}
 @findex nnmairix-group-change-query-this-group
 Changes the search query for the @code{nnmairix} group under cursor
 (@code{nnmairix-group-change-query-this-group}).
 
 @item G b t
-@kindex G b t (Group)
+@kindex G b t @r{(Group)}
 @findex nnmairix-group-toggle-threads-this-group
 Toggles the 'threads' parameter for the @code{nnmairix} group under cursor,
 i.e., if you want see the whole threads of the found messages
 (@code{nnmairix-group-toggle-threads-this-group}).
 
 @item G b u
-@kindex G b u (Group)
+@kindex G b u @r{(Group)}
 @findex nnmairix-update-database
 @vindex nnmairix-mairix-update-options
 Calls mairix binary for updating the database
@@ -21828,20 +21815,20 @@ and @code{-Q} for making this as fast as possible (see variable
 options).
 
 @item G b r
-@kindex G b r (Group)
+@kindex G b r @r{(Group)}
 @findex nnmairix-group-toggle-readmarks-this-group
 Keep articles in this @code{nnmairix} group always read or unread, or leave the
 marks unchanged (@code{nnmairix-group-toggle-readmarks-this-group}).
 
 @item G b d
-@kindex G b d (Group)
+@kindex G b d @r{(Group)}
 @findex nnmairix-group-delete-recreate-this-group
 Recreate @code{nnmairix} group on the ``real'' mail back end
 (@code{nnmairix-group-delete-recreate-this-group}).  You can do this if
 you always get wrong article counts with a @code{nnmairix} group.
 
 @item G b a
-@kindex G b a (Group)
+@kindex G b a @r{(Group)}
 @findex nnmairix-group-toggle-allowfast-this-group
 Toggles the @code{allow-fast} parameters for group under cursor
 (@code{nnmairix-group-toggle-allowfast-this-group}).  The default
@@ -21853,14 +21840,14 @@ lead to dangling symlinks if something changed between updating and
 entering the group which is not yet in the mairix database.
 
 @item G b p
-@kindex G b p (Group)
+@kindex G b p @r{(Group)}
 @findex nnmairix-group-toggle-propmarks-this-group
 Toggle marks propagation for this group
 (@code{nnmairix-group-toggle-propmarks-this-group}).  (@pxref{Propagating
 marks}).
 
 @item G b o
-@kindex G b o (Group)
+@kindex G b o @r{(Group)}
 @findex nnmairix-propagate-marks
 Manually propagate marks (@code{nnmairix-propagate-marks}); needed only when
 @code{nnmairix-propagate-marks-upon-close} is set to @code{nil}.
@@ -21872,21 +21859,21 @@ In summary mode:
 @table @kbd
 
 @item G G m
-@kindex G G m (Summary)
+@kindex G G m @r{(Summary)}
 @findex nnmairix-widget-search-from-this-article
 Allows you to create a mairix query or group based on the current
 message using graphical widgets (same as @code{nnmairix-widget-search})
 (@code{nnmairix-widget-search-from-this-article}).
 
 @item G G g
-@kindex G G g (Summary)
+@kindex G G g @r{(Summary)}
 @findex nnmairix-create-search-group-from-message
 Interactively creates a new search group with query based on the current
 message, but uses the minibuffer instead of graphical widgets
 (@code{nnmairix-create-search-group-from-message}).
 
 @item G G t
-@kindex G G t (Summary)
+@kindex G G t @r{(Summary)}
 @findex nnmairix-search-thread-this-article
 Searches thread for the current article
 (@code{nnmairix-search-thread-this-article}).  This is effectively a
@@ -21894,14 +21881,14 @@ shortcut for calling @code{nnmairix-search} with @samp{m:msgid} of the
 current article and enabled threads.
 
 @item G G f
-@kindex G G f (Summary)
+@kindex G G f @r{(Summary)}
 @findex nnmairix-search-from-this-article
 Searches all messages from sender of the current article
 (@code{nnmairix-search-from-this-article}).  This is a shortcut for
 calling @code{nnmairix-search} with @samp{f:From}.
 
 @item G G o
-@kindex G G o (Summary)
+@kindex G G o @r{(Summary)}
 @findex nnmairix-goto-original-article
 (Only in @code{nnmairix} groups!) Tries determine the group this article
 originally came from and displays the article in this group, so that,
@@ -21911,7 +21898,7 @@ function will use the registry if available, but can also parse the
 article file name as a fallback method.
 
 @item G G u
-@kindex G G u (Summary)
+@kindex G G u @r{(Summary)}
 @findex nnmairix-remove-tick-mark-original-article
 Remove possibly existing tick mark from original article
 (@code{nnmairix-remove-tick-mark-original-article}).  (@pxref{nnmairix
@@ -22334,7 +22321,7 @@ for instance.  But what if you want to save without making a backup
 file, and you want Emacs to flash lights and play a nice tune at the
 same time?  You can't, and you're probably perfectly happy that way.
 
-@kindex M-i (Summary)
+@kindex M-i @r{(Summary)}
 @findex gnus-symbolic-argument
 I'm not, so I've added a second prefix---the @dfn{symbolic prefix}.  The
 prefix key is @kbd{M-i} (@code{gnus-symbolic-argument}), and the next
@@ -22390,7 +22377,6 @@ Currently Gnus uses the following formatting variables:
 All these format variables can also be arbitrary elisp forms.  In that
 case, they will be @code{eval}ed to insert the required lines.
 
-@kindex M-x gnus-update-format
 @findex gnus-update-format
 Gnus includes a command to help you while creating your own format
 specs.  @kbd{M-x gnus-update-format} will @code{eval} the current form,
@@ -24292,10 +24278,10 @@ group:
 @itemx M-d
 @itemx M s x
 @itemx S x
-@kindex $ (Summary)
-@kindex M-d (Summary)
-@kindex S x (Summary)
-@kindex M s x (Summary)
+@kindex $ @r{(Summary)}
+@kindex M-d @r{(Summary)}
+@kindex S x @r{(Summary)}
+@kindex M s x @r{(Summary)}
 @findex gnus-summary-mark-as-spam
 @findex gnus-summary-mark-as-spam
 Mark current article as spam, showing it with the @samp{$} mark
@@ -24567,7 +24553,7 @@ determined by either the @code{ham-process-destination} group
 parameter or a match in the @code{gnus-ham-process-destinations}
 variable, which is a list of regular expressions matched with group
 names (it's easiest to customize this variable with @kbd{M-x
-customize-variable @key{RET} gnus-ham-process-destinations}).  Each
+customize-variable @key{@key{RET}} gnus-ham-process-destinations}).  Each
 group name list is a standard Lisp list, if you prefer to customize
 the variable manually.  If the @code{ham-process-destination}
 parameter is not set, ham articles are left in place.  If the
@@ -24603,7 +24589,7 @@ When you leave a @emph{ham} or @emph{unclassified} group, all
 the @code{spam-process-destination} group parameter or a match in the
 @code{gnus-spam-process-destinations} variable, which is a list of
 regular expressions matched with group names (it's easiest to
-customize this variable with @kbd{M-x customize-variable @key{RET}
+customize this variable with @kbd{M-x customize-variable @key{@key{RET}}
 gnus-spam-process-destinations}).  Each group name list is a standard
 Lisp list, if you prefer to customize the variable manually.  If the
 @code{spam-process-destination} parameter is not set, the spam
@@ -26235,7 +26221,7 @@ you to optionally upload your first CloudSynchronizationDataPack(TM).
 After setting up, you can use these shortcuts from the Group buffer:
 
 @table @kbd
-@item ~ RET
+@item ~ @key{RET}
 @item ~ d
 @findex gnus-cloud-download-all-data
 @cindex cloud, download
@@ -26670,7 +26656,6 @@ to stop doing it the old way.
 
 Gnus understands all @sc{gnus} startup files.
 
-@kindex M-x gnus-bug
 @findex gnus-bug
 @cindex reporting bugs
 @cindex bugs
@@ -27749,7 +27734,7 @@ control over simplification.
 limit.
 
 @item
-@kbd{M-RET} is a new Message command for breaking cited text.
+@kbd{M-@key{RET}} is a new Message command for breaking cited text.
 
 @item
 @samp{\\1}-expressions are now valid in @code{nnmail-split-methods}.
@@ -28304,10 +28289,10 @@ Easy inclusion of X-Faces headers.  @xref{X-Face}.
 @item
 Group Carbon Copy (GCC) quoting
 
-To support groups that contains SPC and other weird characters, groups
+To support groups that contains @key{SPC} and other weird characters, groups
 are quoted before they are placed in the Gcc: header.  This means
 variables such as @code{gnus-message-archive-group} should no longer
-contain quote characters to make groups containing SPC work.  Also, if
+contain quote characters to make groups containing @key{SPC} work.  Also, if
 you are using the string @samp{nnml:foo, nnml:bar} (indicating Gcc
 into two groups) you must change it to return the list
 @code{("nnml:foo" "nnml:bar")}, otherwise the Gcc: line will be quoted
@@ -28396,7 +28381,7 @@ Gnus supports @acronym{PGP} (RFC 1991/2440), @acronym{PGP/MIME} (RFC
 
 It needs an external @acronym{S/MIME} and OpenPGP implementation, but no
 additional Lisp libraries.  This add several menu items to the
-Attachments menu, and @kbd{C-c RET} key bindings, when composing
+Attachments menu, and @kbd{C-c @key{RET}} key bindings, when composing
 messages.  This also obsoletes @code{gnus-article-hide-pgp-hook}.
 
 @item
@@ -28492,7 +28477,7 @@ message, Message Manual}).
 @item
 The tool bars have been updated to use GNOME icons in Group, Summary and
 Message mode.  You can also customize the tool bars: @kbd{M-x
-customize-apropos RET -tool-bar$} should get you started.  This is a new
+customize-apropos @key{RET} -tool-bar$} should get you started.  This is a new
 feature in Gnus 5.10.10.  (Only for Emacs, not in XEmacs.)
 
 @item The tool bar icons are now (de)activated correctly
@@ -28723,7 +28708,7 @@ commonly fetched via the protocol @acronym{NNTP}, whereas mail
 messages could be read from a file on the local disk.  The internal
 architecture of Gnus thus comprises a ``front end'' and a number of
 ``back ends''.  Internally, when you enter a group (by hitting
-@key{RET}, say), you thereby invoke a function in the front end in
+@key{@key{RET}}, say), you thereby invoke a function in the front end in
 Gnus.  The front end then ``talks'' to a back end and says things like
 ``Give me the list of articles in the foo group'' or ``Show me article
 number 4711''.
@@ -29125,12 +29110,12 @@ If all else fails, report the problem as a bug.
 @cindex bugs
 @cindex reporting bugs
 
-@kindex M-x gnus-bug
 @findex gnus-bug
-If you find a bug in Gnus, you can report it with the @kbd{M-x gnus-bug}
-command.  @kbd{M-x set-variable RET debug-on-error RET t RET}, and send
-me the backtrace.  I will fix bugs, but I can only fix them if you send
-me a precise description as to how to reproduce the bug.
+If you find a bug in Gnus, you can report it with the @kbd{M-x
+gnus-bug} command.  @kbd{M-x set-variable @key{RET} debug-on-error
+@key{RET} t @key{RET}}, and send me the backtrace.  I will fix bugs,
+but I can only fix them if you send me a precise description as to how
+to reproduce the bug.
 
 You really can never be too detailed in a bug report.  Always use the
 @kbd{M-x gnus-bug} command when you make bug reports, even if it creates
@@ -29163,9 +29148,9 @@ Lisp Reference Manual}).  To get you started with edebug, consider if
 you discover some weird behavior when pressing @kbd{c}, the first
 step is to do @kbd{C-h k c} and click on the hyperlink (Emacs only) in
 the documentation buffer that leads you to the function definition,
-then press @kbd{M-x edebug-defun RET} with point inside that function,
+then press @kbd{M-x edebug-defun @key{RET}} with point inside that function,
 return to Gnus and press @kbd{c} to invoke the code.  You will be
-placed in the lisp buffer and can single step using @kbd{SPC} and
+placed in the lisp buffer and can single step using @kbd{@key{SPC}} and
 evaluate expressions using @kbd{M-:} or inspect variables using
 @kbd{C-h v}, abort execution with @kbd{q}, and resume execution with
 @kbd{c} or @kbd{g}.
@@ -29183,8 +29168,8 @@ A fancier approach is to use the elisp profiler, ELP@.  The profiler is
 (or should be) fully documented elsewhere, but to get you started
 there are a few steps that need to be followed.  First, instrument the
 part of Gnus you are interested in for profiling, e.g., @kbd{M-x
-elp-instrument-package RET gnus} or @kbd{M-x elp-instrument-package
-RET message}.  Then perform the operation that is slow and press
+elp-instrument-package @key{RET} gnus} or @kbd{M-x elp-instrument-package
+@key{RET} message}.  Then perform the operation that is slow and press
 @kbd{M-x elp-results}.  You will then see which operations that takes
 time, and can debug them further.  If the entire operation takes much
 longer than the time spent in the slowest function in the profiler
diff --git a/doc/misc/info.texi b/doc/misc/info.texi
index 964a6c6912..c617468f57 100644
--- a/doc/misc/info.texi
+++ b/doc/misc/info.texi
@@ -311,9 +311,9 @@ You can tell that there is more that is not visible because you
 can see the text @samp{Top} rather than @samp{All} near the bottom of
 the screen.
 
-@kindex SPC @r{(Info mode)}
-@kindex DEL @r{(Info mode)}
-@kindex BACKSPACE @r{(Info mode)}
+@kindex @key{SPC} @r{(Info mode)}
+@kindex @key{DEL} @r{(Info mode)}
+@kindex @key{BACKSPACE} @r{(Info mode)}
 @findex Info-scroll-up
 @findex Info-scroll-down
   The @key{SPC}, @key{BACKSPACE} (or @key{DEL})@footnote{The key which
@@ -363,8 +363,8 @@ the menu, one by one.  Once you reach the end of a node, and have seen
 all of its subnodes, @key{SPC} takes you to the next node or to the
 parent's next node.
 
-@kindex PAGEUP @r{(Info mode)}
-@kindex PAGEDOWN @r{(Info mode)}
+@kindex @key{PAGEUP} @r{(Info mode)}
+@kindex @key{PAGEDOWN} @r{(Info mode)}
   Many keyboards nowadays have two scroll keys labeled @samp{PageUp}
 and @samp{PageDown} (or maybe @samp{Prior} and @samp{Next}).  If your
 keyboard has these keys, you can use them to move forward and backward
diff --git a/doc/misc/mairix-el.texi b/doc/misc/mairix-el.texi
index 906448c102..401ba1d7b5 100644
--- a/doc/misc/mairix-el.texi
+++ b/doc/misc/mairix-el.texi
@@ -213,7 +213,6 @@ Here's a description of the available interactive functions:
 @table @code
 
 @item mairix-search
-@kindex M-x mairix-search
 @findex mairix-search
 @vindex mairix-search-file
 @vindex mairix-file-path
@@ -229,7 +228,6 @@ is specified by the variable @code{mairix-command}, together with the options
 for making searching faster.
 
 @item mairix-widget-search
-@kindex M-x mairix-widget-search
 @findex mairix-widget-search
 @vindex mairix-widget-fields-list
 Creates a mairix query using graphical widgets.  Very handy if you're
@@ -241,28 +239,24 @@ might want to include some other fields.  This can be easily done by
 modifying @code{mairix-widget-fields-list}.
 
 @item mairix-widget-search-based-on-article
-@kindex M-x mairix-widget-search-based-on-article
 @findex mairix-widget-search-based-on-article
 Create a mairix query using graphical widgets, but based on the
 currently displayed article, i.e., the available fields will be filled
 with the current header values.
 
 @item mairix-search-from-this-article
-@kindex M-x mairix-search-from-this-article
 @findex mairix-search-from-this-article
 Search messages from sender of the current article.  This is effectively
 a shortcut for calling @code{mairix-search} with @code{f:current_from}.
 If used with a prefix, include whole threads of the found messages.
 
 @item mairix-search-thread-this-article
-@kindex M-x mairix-search-thread-this-article
 @findex mairix-search-thread-this-article
 Search thread for the current article.  This is effectively a shortcut
 for calling @code{mairix-search} with @code{m:msgid} of the current article and
 enabled threads.
 
 @item mairix-save-search
-@kindex M-x mairix-save-search
 @findex mairix-save-search
 Save the last search for future use.  You will have to specify a name
 for the search and will then be asked if you want to save your saved
@@ -272,13 +266,11 @@ your @file{.emacs}.  You can also do this later by using
 @code{mairix-edit-saved-searches}.
 
 @item mairix-use-saved-search
-@kindex M-x mairix-use-saved-search
 @findex mairix-use-saved-search
 Call mairix with a previously saved search.  You will be asked for the
 name of the saved search (use @kbd{TAB} for completion).
 
 @item mairix-edit-saved-searches
-@kindex M-x mairix-edit-saved-searches
 @findex mairix-edit-saved-searches
 Edit your current mairix searches.  This is a simple major mode for
 editing the contents of the variable @code{mairix-saved-searches}.  You
@@ -290,14 +282,12 @@ to open different searches at the same time, or if you want to regularly
 access certain searches without the need to call mairix.
 
 @item mairix-edit-saved-searches-customize
-@kindex M-x mairix-edit-saved-searches-customize
 @findex mairix-edit-saved-searches-customize
 Edit the variable @code{mairix-saved-searches} in a normal customization
 buffer.  This function exists more or less for historic reasons, but
 maybe you like it.
 
 @item mairix-update-database
-@kindex M-x mairix-update-database
 @findex mairix-update-database
 @vindex mairix-update-options
 @vindex mairix-synchronous-update
diff --git a/doc/misc/message.texi b/doc/misc/message.texi
index 3cfc81a7a8..481bd3239c 100644
--- a/doc/misc/message.texi
+++ b/doc/misc/message.texi
@@ -707,14 +707,12 @@ This means that if the recipient supports RFC 2298 she might send you a
 notification that she received the message.
 
 @item M-x message-insert-importance-high
-@kindex M-x message-insert-importance-high
 @findex message-insert-importance-high
 @cindex Importance
 Insert an @samp{Importance} header with a value of @samp{high},
 deleting headers if necessary.
 
 @item M-x message-insert-importance-low
-@kindex M-x message-insert-importance-low
 @findex message-insert-importance-low
 @cindex Importance
 Insert an @samp{Importance} header with a value of @samp{low}, deleting
@@ -1379,8 +1377,8 @@ end of the message (@code{message-kill-to-signature}).
 Delete all text in the body of the message that is outside the region
 (@code{message-delete-not-region}).
 
-@item M-RET
-@kindex M-RET
+@item M-@key{RET}
+@kindex M-@key{RET}
 @findex message-newline-and-reformat
 Insert four newlines, and then reformat if inside quoted text.
 
@@ -1390,7 +1388,7 @@ Here's an example:
 > This is some quoted text.  And here's more quoted text.
 @end example
 
-If point is before @samp{And} and you press @kbd{M-RET}, you'll get:
+If point is before @samp{And} and you press @kbd{M-@key{RET}}, you'll get:
 
 @example
 > This is some quoted text.
@@ -1408,12 +1406,12 @@ If point is before @samp{And} and you press @kbd{M-RET}, you'll get:
 Rename the buffer (@code{message-rename-buffer}).  If given a prefix,
 prompt for a new buffer name.
 
-@item TAB
-@kindex TAB
+@item @key{TAB}
+@kindex @key{TAB}
 @findex message-tab
 @vindex message-tab-body-function
 If @code{message-tab-body-function} is non-@code{nil}, execute the
-function it specifies.  Otherwise use the function bound to @kbd{TAB} in
+function it specifies.  Otherwise use the function bound to @key{TAB} in
 @code{text-mode-map} or @code{global-map}.
 
 @end table
diff --git a/doc/misc/mh-e.texi b/doc/misc/mh-e.texi
index a9c8bbbfb3..efb44e4b64 100644
--- a/doc/misc/mh-e.texi
+++ b/doc/misc/mh-e.texi
@@ -461,8 +461,8 @@ filling paragraphs. A mark can be set with @kbd{C-@@} (or
 @cindex file completion
 @cindex folder completion
 @cindex minibuffer
-@kindex SPC
-@kindex TAB
+@kindex @key{SPC}
+@kindex @key{TAB}
 
 The @dfn{minibuffer} is the bottom line of the Emacs window, where all
 prompting and multiple-character input is directed. You can use
@@ -692,7 +692,6 @@ get the big picture, and then you can read the manual as you wish.
 @cindex modes, MH-Letter
 @cindex sending mail
 @findex mh-smail
-@kindex M-x mh-smail
 
 Let's start our tour by sending ourselves a message which we can later
 read and process. Enter @kbd{M-x mh-smail} to invoke the MH-E program
@@ -762,7 +761,6 @@ message. Type @kbd{C-c C-c} now. That's all there is to it!
 @cindex modes, MH-Folder
 @cindex reading mail
 @findex mh-rmail
-@kindex M-x mh-rmail
 
 To read the mail you've just sent yourself, enter @kbd{M-x mh-rmail}.
 This incorporates the new mail and puts the output from
@@ -777,7 +775,6 @@ major mode is MH-Folder.
 
 @findex mh-rmail
 @kindex F r
-@kindex M-x mh-rmail
 
 @sp 1
 @center @strong{NOTE}
@@ -935,7 +932,6 @@ command.
 
 @findex mh-smail
 @kindex m
-@kindex M-x mh-smail
 
 If you want to send another message you can use @kbd{m} instead of
 @kbd{M-x mh-smail}. So go ahead, send some mail to your friends!
@@ -970,7 +966,6 @@ perform any refiles and deletes that you did there.
 @findex mh-rmail
 @kindex C-x b
 @kindex C-x k
-@kindex M-x mh-rmail
 @kindex q
 
 If you don't want to leave Emacs, you can type @kbd{q} to bury (hide)
@@ -1228,7 +1223,7 @@ Many commands that operate on individual messages, such as
 @code{mh-forward} or @code{mh-refile-msg} take a @code{RANGE}
 argument. This argument can be used in several ways.
 
-@kindex C-u, with ranges
+@kindex C-u@r{, with ranges}
 
 If you provide the prefix argument @kbd{C-u} to these commands, then
 you will be prompted for the message range. This can be any valid MH
@@ -1552,7 +1547,6 @@ the message numbers from outside of MH-E.
 @findex mh-rmail
 @kindex F r
 @kindex F v
-@kindex M-x mh-rmail
 
 The MH-E entry point for reading mail is @kbd{M-x mh-rmail}. This
 command incorporates your mail and creates a buffer called
@@ -1599,20 +1593,20 @@ Display message (@code{mh-show}).
 @c -------------------------
 @cindex @samp{Message > Show Message with Header} menu item
 @cindex menu item, @samp{Message > Show Message with Header}
-@kindex , (comma)
+@kindex , @r{(comma)}
 @findex mh-header-display
 @item , (comma)
 Display message with all header fields (@code{mh-header-display}).
 @c -------------------------
 @cindex @samp{Message > Show Message with Preferred Alternative} menu item
 @cindex menu item, @samp{Message > Show Message with Preferred Alternative}
-@kindex : (colon)
+@kindex : @r{(colon)}
 @findex mh-show-preferred-alternative
 @item : (colon)
 Display message with the default preferred alternative
 (@code{mh-show-preferred-alternative}).
 @c -------------------------
-@kindex ; (semicolon)
+@kindex ; @r{(semicolon)}
 @findex mh-toggle-mh-decode-mime-flag
 @item ; (semicolon)
 Toggle the value of @code{mh-decode-mime-flag}
@@ -2017,8 +2011,8 @@ detail in the following sections.
 @findex mh-previous-page
 @findex mh-show
 @findex mh-show-mouse
-@kindex , (comma)
-@kindex . (period)
+@kindex , @r{(comma)}
+@kindex . @r{(period)}
 @kindex @key{BS}
 @kindex @key{RET}
 @kindex @key{SPC}
@@ -2309,7 +2303,7 @@ leave out the @samp{xterm -e} if you use @command{mhlist} or
 @cindex Emacs, packages, @samp{mm-decode}
 @cindex @samp{mm-decode} package
 @findex mh-toggle-mh-decode-mime-flag
-@kindex ; (semicolon)
+@kindex ; @r{(semicolon)}
 @vindex mh-decode-mime-flag
 
 MH-E can handle attachments as well if the Gnus @samp{mm-decode}
@@ -2490,7 +2484,7 @@ the option @code{mm-discouraged-alternatives}, and add
 @samp{text/html}. The next best alternative, if any, will be shown.
 
 @findex mh-show-preferred-alternative
-@kindex : (colon)
+@kindex : @r{(colon)}
 
 Occasionally, though, you might want to see the preferred alternative.
 The command @kbd{:} (@code{mh-show-preferred-alternative}) displays
@@ -3859,7 +3853,6 @@ moving my cursor to @samp{out} and using the command @kbd{R}
 
 @cindex sending mail
 @findex mh-smail
-@kindex M-x mh-smail
 
 You can send a mail message in several ways. You can call @kbd{M-x
 mh-smail} directly, or from the command line like this:
@@ -4027,8 +4020,6 @@ more detail in the following sections.
 @cindex sending mail
 @findex mh-smail
 @findex mh-smail-other-window
-@kindex M-x mh-smail
-@kindex M-x mh-smail-other-window
 
 Outside of an MH-Folder buffer, you must call either @kbd{M-x
 mh-smail} or @kbd{M-x mh-smail-other-window} to compose a new message.
@@ -4401,7 +4392,7 @@ Perform completion or insert space (@code{mh-letter-complete-or-space}).
 Perform completion on header field or word preceding point
 (@code{mh-letter-complete}).
 @c -------------------------
-@kindex , (comma)
+@kindex , @r{(comma)}
 @findex mh-letter-confirm-address
 @item , (comma)
 Flash alias expansion (@code{mh-letter-confirm-address}).
@@ -4842,7 +4833,7 @@ take point to the last field from anywhere in the body.
 @findex mh-letter-complete
 @findex mh-letter-complete-or-space
 @findex mh-letter-confirm-address
-@kindex , (comma)
+@kindex , @r{(comma)}
 @kindex @key{SPC}
 @kindex M-@key{TAB}
 @vindex mh-alias-flash-on-comma
@@ -5934,7 +5925,6 @@ executed to generate the password file. For example, use @samp{ypcat
 passwd} to obtain the NIS password file.
 
 @findex mh-alias-reload
-@kindex M-x mh-alias-reload
 @vindex mh-alias-reloaded-hook
 
 Since aliases are updated frequently, MH-E reloads aliases
@@ -5950,7 +5940,6 @@ listed in your @samp{Aliasfile:} profile component. MH-E provides
 other methods for maintaining your alias file(s).
 
 @findex mh-alias-add-alias
-@kindex M-x mh-alias-add-alias
 
 You can use the @kbd{M-x mh-alias-add-alias} command which will prompt
 you for the alias and address that you would like to add. If the alias
@@ -5985,9 +5974,6 @@ Using prefixes instead of postfixes helps you explore aliases during
 completion. If you forget the name of an old dive buddy, you can enter
 @samp{div} and then @key{SPC} to get a listing of all your dive buddies.
 
-@kindex M-x mh-alias-add-address-under-point
-@kindex M-x mh-alias-grab-from-field
-
 An alias for the sender of the current message is added automatically
 by clicking on the @samp{Grab From alias} tool bar button or by running
 the @kbd{M-x mh-alias-grab-from-field} command. Aliases for other
@@ -6021,7 +6007,6 @@ more appropriate.
 
 @cindex regular expressions, @code{mh-alias-apropos}
 @findex mh-alias-apropos
-@kindex M-x mh-alias-apropos
 
 If you can't quite remember an alias, you can use @kbd{M-x
 mh-alias-apropos} to show all aliases or addresses that match a
@@ -6281,7 +6266,6 @@ containing the value for the field is given.
 @cindex speedbar
 @findex mh-visit-folder
 @kindex F v
-@kindex M-x speedbar
 @kindex mouse-2
 
 You can also use the speedbar
@@ -7514,7 +7498,6 @@ Mail}).
 @cindex sequence, @samp{cur}
 @cindex sequence, @samp{tick}
 @findex mh-update-sequences
-@kindex M-x mh-update-sequences
 @kindex q
 @kindex x
 @vindex mh-tick-seq
@@ -8001,7 +7984,6 @@ system.
 @cindex MH-E version
 @cindex @file{*MH-E Info*}
 @cindex version
-@kindex M-x mh-version
 
 One command worth noting is @kbd{M-x mh-version}. You can compare the
 version this command prints to the latest release (@pxref{Getting
@@ -8716,7 +8698,6 @@ I also point out some additional sources of information.
 
 @cindex bugs
 @cindex SourceForge
-@kindex M-x mh-version
 
 Bug reports should be filed at
 @uref{https://sourceforge.net/p/mh-e/bugs/, SourceForge}. You need to
@@ -8792,7 +8773,6 @@ instead.
 @cindex news
 @cindex @samp{MH-E-NEWS}
 @cindex @samp{README}
-@kindex M-x mh-version
 
 After you download and extract the MH-E tarball, read the
 @file{README} file and @file{MH-E-NEWS}. These correspond to the
diff --git a/doc/misc/newsticker.texi b/doc/misc/newsticker.texi
index 43d248bc7d..b94a96d8aa 100644
--- a/doc/misc/newsticker.texi
+++ b/doc/misc/newsticker.texi
@@ -239,17 +239,17 @@ The position of groups and feeds within the tree can be changed with these
 commands:
 
 @table @kbd
-@item M-up
-@itemx M-down
-@kindex M-up
-@kindex M-down
+@item M-@key{UP}
+@itemx M-@key{DOWN}
+@kindex M-@key{UP}
+@kindex M-@key{DOWN}
 @findex newsticker-group-shift-feed-up
 @findex newsticker-group-shift-feed-down
 Shift the currently selected feed up and down within its group.
-@item M-S-up
-@itemx M-S-down
-@kindex M-S-up
-@kindex M-S-down
+@item M-S-@key{UP}
+@itemx M-S-@key{DOWN}
+@kindex M-S-@key{UP}
+@kindex M-S-@key{DOWN}
 @findex newsticker-group-shift-group-up
 @findex newsticker-group-shift-group-down
 Shift the currently selected group up and down within its parent group.
diff --git a/doc/misc/org.texi b/doc/misc/org.texi
index 03a18e4738..e7cd07d948 100644
--- a/doc/misc/org.texi
+++ b/doc/misc/org.texi
@@ -1134,7 +1134,7 @@ accessing a functionality.  Org mode often uses the same key for different
 functions, depending on context.  The command that is bound to such keys has
 a generic name, like @code{org-metaright}.  In the manual we will, wherever
 possible, give the function that is internally called by the generic command.
-For example, in the chapter on document structure, @kbd{M-@key{right}} will
+For example, in the chapter on document structure, @kbd{M-@key{RIGHT}} will
 be listed to call @code{org-do-demote}, while in the chapter on tables, it
 will be listed to call @code{org-table-move-column-right}.  If you prefer,
 you can compile the manual without the command names by unsetting the flag
@@ -1390,7 +1390,7 @@ you can use the following keys to find your destination:
 @vindex org-goto-auto-isearch
 @example
 @key{TAB}         @r{Cycle visibility.}
-@key{down} / @key{up}   @r{Next/previous visible headline.}
+@key{DOWN} / @key{UP}   @r{Next/previous visible headline.}
 @key{RET}         @r{Select this location.}
 @kbd{/}           @r{Do a Sparse-tree search}
 @r{The following keys work if you turn off @code{org-goto-auto-isearch}}
@@ -1451,18 +1451,18 @@ In a new entry with no text yet, the first @key{TAB} demotes the entry to
 become a child of the previous one.  The next @key{TAB} makes it a parent,
 and so on, all the way to top level.  Yet another @key{TAB}, and you are back
 to the initial level.
-@orgcmd{M-@key{left},org-do-promote}
+@orgcmd{M-@key{LEFT},org-do-promote}
 Promote current heading by one level.
-@orgcmd{M-@key{right},org-do-demote}
+@orgcmd{M-@key{RIGHT},org-do-demote}
 Demote current heading by one level.
-@orgcmd{M-S-@key{left},org-promote-subtree}
+@orgcmd{M-S-@key{LEFT},org-promote-subtree}
 Promote the current subtree by one level.
-@orgcmd{M-S-@key{right},org-demote-subtree}
+@orgcmd{M-S-@key{RIGHT},org-demote-subtree}
 Demote the current subtree by one level.
-@orgcmd{M-@key{up},org-move-subtree-up}
+@orgcmd{M-@key{UP},org-move-subtree-up}
 Move subtree up (swap with previous subtree of same
 level).
-@orgcmd{M-@key{down},org-move-subtree-down}
+@orgcmd{M-@key{DOWN},org-move-subtree-down}
 Move subtree down (swap with next subtree of same level).
 @orgcmd{M-h,org-mark-element}
 Mark the element at point.  Hitting repeatedly will mark subsequent elements
@@ -1731,7 +1731,7 @@ one.
 @kindex M-S-@key{RET}
 @item M-S-@key{RET}
 Insert a new item with a checkbox (@pxref{Checkboxes}).
-@kindex S-@key{down}
+@kindex S-@key{DOWN}
 @item S-up
 @itemx S-down
 @cindex shift-selection-mode
@@ -1741,25 +1741,25 @@ Jump to the previous/next item in the current list@footnote{If you want to
 cycle around items that way, you may customize
 @code{org-list-use-circular-motion}.}, but only if
 @code{org-support-shift-select} is off.  If not, you can still use paragraph
-jumping commands like @kbd{C-@key{up}} and @kbd{C-@key{down}} to quite
+jumping commands like @kbd{C-@key{UP}} and @kbd{C-@key{DOWN}} to quite
 similar effect.
-@kindex M-@key{up}
-@kindex M-@key{down}
+@kindex M-@key{UP}
+@kindex M-@key{DOWN}
 @item M-up
 @itemx M-down
 Move the item including subitems up/down@footnote{See
 @code{org-list-use-circular-motion} for a cyclic behavior.} (swap with
 previous/next item of same indentation).  If the list is ordered, renumbering
 is automatic.
-@kindex M-@key{left}
-@kindex M-@key{right}
+@kindex M-@key{LEFT}
+@kindex M-@key{RIGHT}
 @item M-left
 @itemx M-right
 Decrease/increase the indentation of an item, leaving children alone.
-@kindex M-S-@key{left}
-@kindex M-S-@key{right}
-@item M-S-@key{left}
-@itemx M-S-@key{right}
+@kindex M-S-@key{LEFT}
+@kindex M-S-@key{RIGHT}
+@item M-S-@key{LEFT}
+@itemx M-S-@key{RIGHT}
 Decrease/increase the indentation of the item, including subitems.
 Initially, the item tree is selected based on current indentation.  When
 these commands are executed several times in direct succession, the initially
@@ -1797,9 +1797,9 @@ its location).  @xref{Structure editing}, for a detailed explanation.
 Turn the whole plain list into a subtree of the current heading.  Checkboxes
 (@pxref{Checkboxes}) will become TODO (resp. DONE) keywords when unchecked
 (resp. checked).
-@kindex S-@key{left}
-@kindex S-@key{right}
-@item S-left/right
+@kindex S-@key{LEFT}
+@kindex S-@key{RIGHT}
+@item S-@key{LEFT}/@key{RIGHT}
 @vindex org-support-shift-select
 This command also cycles bullet styles when the cursor in on the bullet or
 anywhere in an item line, details depending on
@@ -2153,22 +2153,22 @@ Move to beginning of the current table field, or on to the previous field.
 Move to end of the current table field, or on to the next field.
 
 @tsubheading{Column and row editing}
-@orgcmdkkcc{M-@key{left},M-@key{right},org-table-move-column-left,org-table-move-column-right}
+@orgcmdkkcc{M-@key{LEFT},M-@key{RIGHT},org-table-move-column-left,org-table-move-column-right}
 Move the current column left/right.
 @c
-@orgcmd{M-S-@key{left},org-table-delete-column}
+@orgcmd{M-S-@key{LEFT},org-table-delete-column}
 Kill the current column.
 @c
-@orgcmd{M-S-@key{right},org-table-insert-column}
+@orgcmd{M-S-@key{RIGHT},org-table-insert-column}
 Insert a new column to the left of the cursor position.
 @c
-@orgcmdkkcc{M-@key{up},M-@key{down},org-table-move-row-up,org-table-move-row-down}
+@orgcmdkkcc{M-@key{UP},M-@key{DOWN},org-table-move-row-up,org-table-move-row-down}
 Move the current row up/down.
 @c
-@orgcmd{M-S-@key{up},org-table-kill-row}
+@orgcmd{M-S-@key{UP},org-table-kill-row}
 Kill the current row or horizontal line.
 @c
-@orgcmd{M-S-@key{down},org-table-insert-row}
+@orgcmd{M-S-@key{DOWN},org-table-insert-row}
 Insert a new row above the current row.  With a prefix argument, the line is
 created below the current one.
 @c
@@ -3012,22 +3012,22 @@ formula, @key{TAB} re-indents just like in Emacs Lisp mode.
 Complete Lisp symbols, just like in Emacs Lisp mode.@footnote{Many desktops
 intercept @kbd{M-@key{TAB}} to switch windows.  Use @kbd{C-M-i} or
 @kbd{@key{ESC} @key{TAB}} instead for completion (@pxref{Completion}).}
-@kindex S-@key{up}
-@kindex S-@key{down}
-@kindex S-@key{left}
-@kindex S-@key{right}
+@kindex S-@key{UP}
+@kindex S-@key{DOWN}
+@kindex S-@key{LEFT}
+@kindex S-@key{RIGHT}
 @findex org-table-fedit-ref-up
 @findex org-table-fedit-ref-down
 @findex org-table-fedit-ref-left
 @findex org-table-fedit-ref-right
-@item S-@key{up}/@key{down}/@key{left}/@key{right}
+@item S-@key{UP}/@key{DOWN}/@key{LEFT}/@key{RIGHT}
 Shift the reference at point.  For example, if the reference is
-@code{B3} and you press @kbd{S-@key{right}}, it will become @code{C3}.
+@code{B3} and you press @kbd{S-@key{RIGHT}}, it will become @code{C3}.
 This also works for relative references and for hline references.
-@orgcmdkkcc{M-S-@key{up},M-S-@key{down},org-table-fedit-line-up,org-table-fedit-line-down}
+@orgcmdkkcc{M-S-@key{UP},M-S-@key{DOWN},org-table-fedit-line-up,org-table-fedit-line-down}
 Move the test line for column formulas in the Org buffer up and
 down.
-@orgcmdkkcc{M-@key{up},M-@key{down},org-table-fedit-scroll-down,org-table-fedit-scroll-up}
+@orgcmdkkcc{M-@key{UP},M-@key{DOWN},org-table-fedit-scroll-down,org-table-fedit-scroll-up}
 Scroll the window displaying the table.
 @kindex C-c @}
 @findex org-table-toggle-coordinate-overlays
@@ -3708,7 +3708,7 @@ becomes the default description.
 @b{Inserting stored links}@*
 All links stored during the
 current session are part of the history for this prompt, so you can access
-them with @key{up} and @key{down} (or @kbd{M-p/n}).
+them with @key{UP} and @key{DOWN} (or @kbd{M-p/n}).
 
 @b{Completion support}@* Completion with @key{TAB} will help you to insert
 valid link prefixes like @samp{https:}, including the prefixes
@@ -4041,9 +4041,9 @@ completion; otherwise force cycling through TODO states with no prompt.  When
 @code{org-use-fast-todo-selection} is set to @code{prefix}, use the fast
 selection interface.
 
-@kindex S-@key{right}
-@kindex S-@key{left}
-@item S-@key{right} @ @r{/} @ S-@key{left}
+@kindex S-@key{RIGHT}
+@kindex S-@key{LEFT}
+@item S-@key{RIGHT} @ @r{/} @ S-@key{LEFT}
 @vindex org-treat-S-cursor-todo-selection-as-state-change
 Select the following/preceding TODO state, similar to cycling.  Useful
 mostly if more than two TODO states are possible (@pxref{TODO
@@ -4124,7 +4124,7 @@ With this setup, the command @kbd{C-c C-t} will cycle an entry from TODO
 to FEEDBACK, then to VERIFY, and finally to DONE and DELEGATED@.  You may
 also use a numeric prefix argument to quickly select a specific state.  For
 example @kbd{C-3 C-c C-t} will change the state immediately to VERIFY@.
-Or you can use @kbd{S-@key{left}} to go backward through the sequence.  If you
+Or you can use @kbd{S-@key{LEFT}} to go backward through the sequence.  If you
 define many keywords, you can use in-buffer completion
 (@pxref{Completion}) or even a special one-key selection scheme
 (@pxref{Fast access to TODO states}) to insert these words into the
@@ -4190,23 +4190,23 @@ select the correct sequence.  Besides the obvious ways like typing a
 keyword or using completion, you may also apply the following commands:
 
 @table @kbd
-@kindex C-S-@key{right}
-@kindex C-S-@key{left}
+@kindex C-S-@key{RIGHT}
+@kindex C-S-@key{LEFT}
 @kindex C-u C-u C-c C-t
 @item C-u C-u C-c C-t
-@itemx C-S-@key{right}
-@itemx C-S-@key{left}
+@itemx C-S-@key{RIGHT}
+@itemx C-S-@key{LEFT}
 These keys jump from one TODO subset to the next.  In the above example,
-@kbd{C-u C-u C-c C-t} or @kbd{C-S-@key{right}} would jump from @code{TODO} or
+@kbd{C-u C-u C-c C-t} or @kbd{C-S-@key{RIGHT}} would jump from @code{TODO} or
 @code{DONE} to @code{REPORT}, and any of the words in the second row to
 @code{CANCELED}.  Note that the @kbd{C-S-} key binding conflict with
 @code{shift-selection-mode} (@pxref{Conflicts}).
-@kindex S-@key{right}
-@kindex S-@key{left}
-@item S-@key{right}
-@itemx S-@key{left}
-@kbd{S-@key{left}} and @kbd{S-@key{right}} and walk through @emph{all}
-keywords from all sets, so for example @kbd{S-@key{right}} would switch
+@kindex S-@key{RIGHT}
+@kindex S-@key{LEFT}
+@item S-@key{RIGHT}
+@itemx S-@key{LEFT}
+@kbd{S-@key{LEFT}} and @kbd{S-@key{RIGHT}} and walk through @emph{all}
+keywords from all sets, so for example @kbd{S-@key{RIGHT}} would switch
 from @code{DONE} to @code{REPORT} in the example above.  See also
 @ref{Conflicts}, for a discussion of the interaction with
 @code{shift-selection-mode}.
@@ -4642,7 +4642,7 @@ items.
 
 @table @kbd
 @item @kbd{C-c ,}
-@kindex @kbd{C-c ,}
+@kindex C-c ,
 @findex org-priority
 Set the priority of the current headline (@command{org-priority}).  The
 command prompts for a priority character @samp{A}, @samp{B} or @samp{C}.
@@ -4650,7 +4650,7 @@ When you press @key{SPC} instead, the priority cookie is removed from the
 headline.  The priorities can also be changed ``remotely'' from the agenda
 buffer with the @kbd{,} command (@pxref{Agenda commands}).
 @c
-@orgcmdkkcc{S-@key{up},S-@key{down},org-priority-up,org-priority-down}
+@orgcmdkkcc{S-@key{UP},S-@key{DOWN},org-priority-up,org-priority-down}
 @vindex org-priority-start-cycle-with-default
 Increase/decrease priority of current headline@footnote{See also the option
 @code{org-priority-start-cycle-with-default}.}.  Note that these keys are
@@ -5393,7 +5393,7 @@ With the cursor in a property drawer, this executes property commands.
 @orgcmd{C-c C-c s,org-set-property}
 Set a property in the current entry.  Both the property and the value
 can be inserted using completion.
-@orgcmdkkcc{S-@key{right},S-@key{left},org-property-next-allowed-value,org-property-previous-allowed-value}
+@orgcmdkkcc{S-@key{RIGHT},S-@key{LEFT},org-property-next-allowed-value,org-property-previous-allowed-value}
 Switch property at point to the next/previous allowed value.
 @orgcmd{C-c C-c d,org-delete-property}
 Remove a property from the current entry.
@@ -5723,17 +5723,17 @@ Same as @kbd{r}.
 @orgcmd{q,org-columns-quit}
 Exit column view.
 @tsubheading{Editing values}
-@item @key{left} @key{right} @key{up} @key{down}
+@item @key{LEFT} @key{RIGHT} @key{UP} @key{DOWN}
 Move through the column view from field to field.
-@kindex S-@key{left}
-@kindex S-@key{right}
-@item  S-@key{left}/@key{right}
+@kindex S-@key{LEFT}
+@kindex S-@key{RIGHT}
+@item  S-@key{LEFT}/@key{RIGHT}
 Switch to the next/previous allowed value of the field.  For this, you
 have to have specified allowed values for a property.
 @item 1..9,0
 Directly select the Nth allowed value, @kbd{0} selects the 10th value.
 @orgcmdkkcc{n,p,org-columns-next-allowed-value,org-columns-previous-allowed-value}
-Same as @kbd{S-@key{left}/@key{right}}
+Same as @kbd{S-@key{LEFT}/@key{RIGHT}}
 @orgcmd{e,org-columns-edit-value}
 Edit the property at point.  For the special properties, this will
 invoke the same interface that you normally use to change that
@@ -5752,9 +5752,9 @@ current column view.
 @tsubheading{Modifying the table structure}
 @orgcmdkkcc{<,>,org-columns-narrow,org-columns-widen}
 Make the column narrower/wider by one character.
-@orgcmd{S-M-@key{right},org-columns-new}
+@orgcmd{S-M-@key{RIGHT},org-columns-new}
 Insert a new column, to the left of the current column.
-@orgcmd{S-M-@key{left},org-columns-delete}
+@orgcmd{S-M-@key{LEFT},org-columns-delete}
 Delete the current column.
 @end table
 
@@ -6008,11 +6008,11 @@ instead.
 Access the agenda for the date given by the timestamp or -range at
 point (@pxref{Weekly/daily agenda}).
 @c
-@orgcmdkkcc{S-@key{left},S-@key{right},org-timestamp-down-day,org-timestamp-up-day}
+@orgcmdkkcc{S-@key{LEFT},S-@key{RIGHT},org-timestamp-down-day,org-timestamp-up-day}
 Change date at cursor by one day.  These key bindings conflict with
 shift-selection and related modes (@pxref{Conflicts}).
 @c
-@orgcmdkkcc{S-@key{up},S-@key{down},org-timestamp-up,org-timestamp-down-down}
+@orgcmdkkcc{S-@key{UP},S-@key{DOWN},org-timestamp-up,org-timestamp-down-down}
 Change the item under the cursor in a timestamp.  The cursor can be on a
 year, month, day, hour or minute.  When the timestamp contains a time range
 like @samp{15:30-16:30}, modifying the first time will also shift the second,
@@ -6136,25 +6136,25 @@ from the minibuffer:
 @kindex M-v
 @kindex C-v
 @kindex mouse-1
-@kindex S-@key{right}
-@kindex S-@key{left}
-@kindex S-@key{down}
-@kindex S-@key{up}
-@kindex M-S-@key{right}
-@kindex M-S-@key{left}
+@kindex S-@key{RIGHT}
+@kindex S-@key{LEFT}
+@kindex S-@key{DOWN}
+@kindex S-@key{UP}
+@kindex M-S-@key{RIGHT}
+@kindex M-S-@key{LEFT}
 @kindex @key{RET}
-@kindex M-S-@key{down}
-@kindex M-S-@key{up}
+@kindex M-S-@key{DOWN}
+@kindex M-S-@key{UP}
 
 @example
 @key{RET}              @r{Choose date at cursor in calendar.}
 mouse-1            @r{Select date by clicking on it.}
-S-@key{right}/@key{left}   @r{One day forward/backward.}
-S-@key{down}/@key{up}      @r{One week forward/backward.}
-M-S-@key{right}/@key{left} @r{One month forward/backward.}
+S-@key{RIGHT}/@key{LEFT}   @r{One day forward/backward.}
+S-@key{DOWN}/@key{UP}      @r{One week forward/backward.}
+M-S-@key{RIGHT}/@key{LEFT} @r{One month forward/backward.}
 > / <              @r{Scroll calendar forward/backward by one month.}
 M-v / C-v          @r{Scroll calendar forward/backward by 3 months.}
-M-S-@key{down}/@key{up}    @r{Scroll calendar forward/backward by one year.}
+M-S-@key{DOWN}/@key{UP}    @r{Scroll calendar forward/backward by one year.}
 @end example
 
 @vindex org-read-date-display-live
@@ -6194,10 +6194,10 @@ following consequences:
 You cannot place the cursor onto a timestamp anymore, only before or
 after.
 @item
-The @kbd{S-@key{up}/@key{down}} keys can no longer be used to adjust
+The @kbd{S-@key{UP}/@key{DOWN}} keys can no longer be used to adjust
 each component of a timestamp.  If the cursor is at the beginning of
-the stamp, @kbd{S-@key{up}/@key{down}} will change the stamp by one day,
-just like @kbd{S-@key{left}/@key{right}}.  At the end of the stamp, the
+the stamp, @kbd{S-@key{UP}/@key{DOWN}} will change the stamp by one day,
+just like @kbd{S-@key{LEFT}/@key{RIGHT}}.  At the end of the stamp, the
 time will be changed by one minute.
 @item
 If the timestamp contains a range of clock times or a repeater, these
@@ -6553,7 +6553,7 @@ clock duration keeps the same.
 @orgcmd{S-M-@key{up/down},org-timestamp-up/down}
 On @code{CLOCK} log lines, increase/decrease the timestamp at point and
 the one of the previous (or the next clock) timestamp by the same duration.
-For example, if you hit @kbd{S-M-@key{up}} to increase a clocked-out timestamp
+For example, if you hit @kbd{S-M-@key{UP}} to increase a clocked-out timestamp
 by five minutes, then the clocked-in timestamp of the next clock will be
 increased by five minutes.
 @orgcmd{C-c C-t,org-todo}
@@ -6604,7 +6604,7 @@ Update dynamic block at point.
 @orgkey{C-u C-c C-x C-u}
 Update all dynamic blocks (@pxref{Dynamic blocks}).  This is useful if
 you have several clock table blocks in a buffer.
-@orgcmdkxkc{S-@key{left},S-@key{right},org-clocktable-try-shift}
+@orgcmdkxkc{S-@key{LEFT},S-@key{RIGHT},org-clocktable-try-shift}
 Shift the current @code{:block} interval and update the table.  The cursor
 needs to be in the @code{#+BEGIN: clocktable} line for this command.  If
 @code{:block} is @code{today}, it will be shifted to @code{today-1} etc.
@@ -6654,7 +6654,7 @@ be selected:
              thismonth, lastmonth, thismonth-@var{N}  @r{a relative month}
              thisyear, lastyear, thisyear-@var{N}     @r{a relative year}
              untilnow
-             @r{Use @kbd{S-@key{left}/@key{right}} keys to shift the time interval.}
+             @r{Use @kbd{S-@key{LEFT}/@key{RIGHT}} keys to shift the time interval.}
 :tstart      @r{A time string specifying when to start considering times.}
              @r{Relative times like @code{"<-2w>"} can also be used.  See}
              @r{@ref{Matching tags and properties} for relative time syntax.}
@@ -6860,7 +6860,7 @@ In particular if you want to use this setup also in the agenda, a global
 setup may be advised.
 
 The way to assign estimates to individual items is then to switch to column
-mode, and to use @kbd{S-@key{right}} and @kbd{S-@key{left}} to change the
+mode, and to use @kbd{S-@key{RIGHT}} and @kbd{S-@key{LEFT}} to change the
 value.  The values you enter will immediately be summed up in the hierarchy.
 In the column next to it, any clocked time will be displayed.
 
@@ -8020,7 +8020,6 @@ Remove current file from the list of agenda files.
 @orgcmd{C-',org-cycle-agenda-files}
 @itemx C-,
 Cycle through agenda file list, visiting one file after the other.
-@kindex M-x org-iswitchb
 @item M-x org-iswitchb RET
 Command to use an @code{iswitchb}-like interface to switch to and between Org
 buffers.
@@ -8948,9 +8947,9 @@ the other commands, the cursor needs to be in the desired line.
 @tsubheading{Motion}
 @cindex motion commands in agenda
 @orgcmd{n,org-agenda-next-line}
-Next line (same as @key{down} and @kbd{C-n}).
+Next line (same as @key{DOWN} and @kbd{C-n}).
 @orgcmd{p,org-agenda-previous-line}
-Previous line (same as @key{up} and @kbd{C-p}).
+Previous line (same as @key{UP} and @kbd{C-p}).
 @orgcmd{N,org-agenda-next-item}
 Next item: same as next line, but only consider items.
 @orgcmd{P,org-agenda-previous-item}
@@ -9101,8 +9100,8 @@ Toggle the time grid on and off.  See also the variables
 @c
 @orgcmd{r,org-agenda-redo}
 Recreate the agenda buffer, for example to reflect the changes after
-modification of the timestamps of items with @kbd{S-@key{left}} and
-@kbd{S-@key{right}}.  When the buffer is the global TODO list, a prefix
+modification of the timestamps of items with @kbd{S-@key{LEFT}} and
+@kbd{S-@key{RIGHT}}.  When the buffer is the global TODO list, a prefix
 argument is interpreted to create a selective list for a specific TODO
 keyword.
 @orgcmd{g,org-agenda-redo}
@@ -9166,8 +9165,8 @@ both in the agenda buffer and in the remote buffer.
 Change the TODO state of the item, both in the agenda and in the
 original org file.
 @c
-@orgcmd{C-S-@key{right},org-agenda-todo-nextset}
-@orgcmd{C-S-@key{left},org-agenda-todo-previousset}
+@orgcmd{C-S-@key{RIGHT},org-agenda-todo-nextset}
+@orgcmd{C-S-@key{LEFT},org-agenda-todo-previousset}
 Switch to the next/previous set of TODO keywords.
 @c
 @orgcmd{C-k,org-agenda-kill}
@@ -9217,12 +9216,12 @@ the priority cookie is removed from the entry.
 @orgcmd{P,org-agenda-show-priority}
 Display weighted priority of current item.
 @c
-@orgcmdkkc{+,S-@key{up},org-agenda-priority-up}
+@orgcmdkkc{+,S-@key{UP},org-agenda-priority-up}
 Increase the priority of the current item.  The priority is changed in
 the original buffer, but the agenda is not resorted.  Use the @kbd{r}
 key for this.
 @c
-@orgcmdkkc{-,S-@key{down},org-agenda-priority-down}
+@orgcmdkkc{-,S-@key{DOWN},org-agenda-priority-down}
 Decrease the priority of the current item.
 @c
 @orgcmdkkc{z,C-c C-z,org-agenda-add-note}
@@ -9240,19 +9239,19 @@ Schedule this item.  With prefix arg remove the scheduling timestamp
 @orgcmd{C-c C-d,org-agenda-deadline}
 Set a deadline for this item.  With prefix arg remove the deadline.
 @c
-@orgcmd{S-@key{right},org-agenda-do-date-later}
+@orgcmd{S-@key{RIGHT},org-agenda-do-date-later}
 Change the timestamp associated with the current line by one day into the
 future.  If the date is in the past, the first call to this command will move
 it to today.@*
 With a numeric prefix argument, change it by that many days.  For example,
-@kbd{3 6 5 S-@key{right}} will change it by a year.  With a @kbd{C-u} prefix,
+@kbd{3 6 5 S-@key{RIGHT}} will change it by a year.  With a @kbd{C-u} prefix,
 change the time by one hour.  If you immediately repeat the command, it will
 continue to change hours even without the prefix arg.  With a double @kbd{C-u
 C-u} prefix, do the same for changing minutes.@*
 The stamp is changed in the original Org file, but the change is not directly
 reflected in the agenda buffer.  Use @kbd{r} or @kbd{g} to update the buffer.
 @c
-@orgcmd{S-@key{left},org-agenda-do-date-earlier}
+@orgcmd{S-@key{LEFT},org-agenda-do-date-earlier}
 Change the timestamp associated with the current line by one day
 into the past.
 @c
@@ -17126,10 +17125,10 @@ Active key bindings in code blocks:
 @item @kbd{C-c C-c} @tab @code{org-babel-execute-src-block}
 @kindex C-c C-o
 @item @kbd{C-c C-o} @tab @code{org-babel-open-src-block-result}
-@kindex M-up
-@item @kbd{M-@key{up}}    @tab @code{org-babel-load-in-session}
-@kindex M-down
-@item @kbd{M-@key{down}}  @tab @code{org-babel-switch-to-session}
+@kindex M-@key{UP}
+@item @kbd{M-@key{UP}}    @tab @code{org-babel-load-in-session}
+@kindex M-@key{DOWN}
+@item @kbd{M-@key{DOWN}}  @tab @code{org-babel-switch-to-session}
 @end multitable
 
 Active key bindings in Org mode buffer:
@@ -17928,23 +17927,23 @@ normal @kbd{S-@key{cursor}} for editing timestamp might be better with
 @multitable @columnfractions 0.15 0.2 0.1 0.2
 @item @b{Default} @tab @b{Alternative 1} @tab @b{Speed key} @tab @b{Alternative 2}
 @item @kbd{S-@key{TAB}}     @tab @kbd{C-u @key{TAB}}       @tab @kbd{C} @tab
-@item @kbd{M-@key{left}}    @tab @kbd{C-c C-x l}           @tab @kbd{l} @tab @kbd{@key{Esc} @key{left}}
-@item @kbd{M-S-@key{left}}  @tab @kbd{C-c C-x L}           @tab @kbd{L} @tab
-@item @kbd{M-@key{right}}   @tab @kbd{C-c C-x r}           @tab @kbd{r} @tab @kbd{@key{Esc} @key{right}}
-@item @kbd{M-S-@key{right}} @tab @kbd{C-c C-x R}           @tab @kbd{R} @tab
-@item @kbd{M-@key{up}}      @tab @kbd{C-c C-x u}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{up}}
-@item @kbd{M-S-@key{up}}    @tab @kbd{C-c C-x U}           @tab @kbd{U} @tab
-@item @kbd{M-@key{down}}    @tab @kbd{C-c C-x d}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{down}}
-@item @kbd{M-S-@key{down}}  @tab @kbd{C-c C-x D}           @tab @kbd{D} @tab
+@item @kbd{M-@key{LEFT}}    @tab @kbd{C-c C-x l}           @tab @kbd{l} @tab @kbd{@key{Esc} @key{LEFT}}
+@item @kbd{M-S-@key{LEFT}}  @tab @kbd{C-c C-x L}           @tab @kbd{L} @tab
+@item @kbd{M-@key{RIGHT}}   @tab @kbd{C-c C-x r}           @tab @kbd{r} @tab @kbd{@key{Esc} @key{RIGHT}}
+@item @kbd{M-S-@key{RIGHT}} @tab @kbd{C-c C-x R}           @tab @kbd{R} @tab
+@item @kbd{M-@key{UP}}      @tab @kbd{C-c C-x u}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{UP}}
+@item @kbd{M-S-@key{UP}}    @tab @kbd{C-c C-x U}           @tab @kbd{U} @tab
+@item @kbd{M-@key{DOWN}}    @tab @kbd{C-c C-x d}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{DOWN}}
+@item @kbd{M-S-@key{DOWN}}  @tab @kbd{C-c C-x D}           @tab @kbd{D} @tab
 @item @kbd{S-@key{RET}}     @tab @kbd{C-c C-x c}           @tab @kbd{ } @tab
 @item @kbd{M-@key{RET}}     @tab @kbd{C-c C-x m}           @tab @kbd{ } @tab @kbd{@key{Esc} @key{RET}}
 @item @kbd{M-S-@key{RET}}   @tab @kbd{C-c C-x M}           @tab @kbd{ } @tab
-@item @kbd{S-@key{left}}    @tab @kbd{C-c @key{left}}      @tab @kbd{ } @tab
-@item @kbd{S-@key{right}}   @tab @kbd{C-c @key{right}}     @tab @kbd{ } @tab
-@item @kbd{S-@key{up}}      @tab @kbd{C-c @key{up}}        @tab @kbd{ } @tab
-@item @kbd{S-@key{down}}    @tab @kbd{C-c @key{down}}      @tab @kbd{ } @tab
-@item @kbd{C-S-@key{left}}  @tab @kbd{C-c C-x @key{left}}  @tab @kbd{ } @tab
-@item @kbd{C-S-@key{right}} @tab @kbd{C-c C-x @key{right}} @tab @kbd{ } @tab
+@item @kbd{S-@key{LEFT}}    @tab @kbd{C-c @key{LEFT}}      @tab @kbd{ } @tab
+@item @kbd{S-@key{RIGHT}}   @tab @kbd{C-c @key{RIGHT}}     @tab @kbd{ } @tab
+@item @kbd{S-@key{UP}}      @tab @kbd{C-c @key{UP}}        @tab @kbd{ } @tab
+@item @kbd{S-@key{DOWN}}    @tab @kbd{C-c @key{DOWN}}      @tab @kbd{ } @tab
+@item @kbd{C-S-@key{LEFT}}  @tab @kbd{C-c C-x @key{LEFT}}  @tab @kbd{ } @tab
+@item @kbd{C-S-@key{RIGHT}} @tab @kbd{C-c C-x @key{RIGHT}} @tab @kbd{ } @tab
 @end multitable
 
 
diff --git a/doc/misc/pcl-cvs.texi b/doc/misc/pcl-cvs.texi
index 1163530e7a..32c6a52487 100644
--- a/doc/misc/pcl-cvs.texi
+++ b/doc/misc/pcl-cvs.texi
@@ -677,7 +677,7 @@ put in @samp{cvs-status-mode}.
 @cindex Movement Commands
 @findex cvs-mode-next-line
 @findex cvs-mode-previous-line
-@kindex SPC@r{--Move down one file}
+@kindex @key{SPC}@r{--Move down one file}
 @kindex n@r{--Move down one file}
 @kindex p@r{--Move up one file}
 
@@ -705,8 +705,8 @@ This key moves one file backward, towards the beginning of the buffer
 @kindex m@r{--marking a file}
 @kindex M@r{--marking all files}
 @kindex u@r{--unmark a file}
-@kindex ESC DEL@r{--unmark all files}
-@kindex DEL@r{--unmark previous file}
+@kindex @key{ESC} @key{DEL}@r{--unmark all files}
+@kindex @key{DEL}@r{--unmark previous file}
 @kindex %@r{--mark files matching regexp}
 @kindex S@r{--mark files in a particular state}
 @kindex T@r{--toggle marks}
diff --git a/doc/misc/rcirc.texi b/doc/misc/rcirc.texi
index 2437e020ee..dc715e5d68 100644
--- a/doc/misc/rcirc.texi
+++ b/doc/misc/rcirc.texi
@@ -154,7 +154,7 @@ deego: fsbot rules!
 
 @cindex nick completion
 @cindex completion of nicks
-@kindex TAB
+@kindex @key{TAB}
 Since this is so common, you can use @key{TAB} to do nick completion.
 
 @node Getting started with rcirc
@@ -215,7 +215,7 @@ When you have answered these questions, @code{rcirc} will create a server
 buffer, which will be named something like @file{*irc.freenode.net*},
 and a channel buffer for each of the channels you wanted to join.
 
-@kindex RET
+@kindex @key{RET}
 @cindex talking
 @cindex communicating
 To talk in a channel, just type what you want to say in a channel
@@ -378,7 +378,7 @@ network.  A new buffer will be created for this conversation.  It works
 like a channel with only two members.  (Also @code{/query fsbot}.)
 
 @item C-c @key{RET}
-@kindex C-c RET
+@kindex C-c @key{RET}
 @cindex /msg
 @cindex single message
 @cindex message sending
@@ -617,7 +617,7 @@ daunting task.  This chapters tells you how @code{rcirc} can help.
 @cindex modeline
 
 @comment This section copied to the Getting started with rcirc section
-@kindex C-c C-SPC
+@kindex C-c C-@key{SPC}
 @vindex rcirc-track-minor-mode
 @cindex switching channels
 @cindex tracking activity
@@ -663,7 +663,7 @@ Low priority channels have the modeline indicator ``LowPri''.
 @kbd{C-c C-@key{SPC}} will not switch to low priority channels unless
 you use the @kbd{C-u} prefix.
 
-@kindex C-c TAB
+@kindex C-c @key{TAB}
 @cindex ignored channels
 If you prefer a channel to never show up in the modeline, then you
 have to ignore it.  Use @kbd{C-c @key{TAB}} to ignore the current
diff --git a/doc/misc/sc.texi b/doc/misc/sc.texi
index 03ca842cd0..9faa8fea74 100644
--- a/doc/misc/sc.texi
+++ b/doc/misc/sc.texi
@@ -685,7 +685,7 @@ Set the preferred reference header (i.e.,
 @code{sc-preferred-header-style}) to the currently displayed header.
 
 @item @code{sc-eref-exit} (@kbd{C-j}, @key{RET}, and @key{ESC C-c})
-@kindex RET
+@kindex @key{RET}
 @kindex C-j
 @kindex q
 @findex sc-eref-exit
diff --git a/doc/misc/sieve.texi b/doc/misc/sieve.texi
index 37bb707f63..2875b163ee 100644
--- a/doc/misc/sieve.texi
+++ b/doc/misc/sieve.texi
@@ -124,7 +124,7 @@ bindings to manage Sieve scripts remotely. @xref{Managing Sieve}.
 @table @kbd
 
 @item C-c RET
-@kindex C-c RET
+@kindex C-c @key{RET}
 @findex sieve-manage
 @cindex manage remote sieve script
 Open a connection to a remote server using the Managesieve protocol.
@@ -190,7 +190,7 @@ Remove currently highlighted script.
 @item RET
 @item mouse-2
 @item f
-@kindex RET
+@kindex @key{RET}
 @kindex mouse-2
 @kindex f
 @findex sieve-edit-script
diff --git a/doc/misc/vhdl-mode.texi b/doc/misc/vhdl-mode.texi
index c061fb8e43..5aad1c2ffe 100644
--- a/doc/misc/vhdl-mode.texi
+++ b/doc/misc/vhdl-mode.texi
@@ -271,7 +271,7 @@ example again.
 @end group
 @end example
 
-@kindex TAB
+@kindex @key{TAB}
 Let's say point is on line 3 and we hit the @key{TAB} key to re-indent
 the line.  Remember that the syntactic component list for that
 line is:
@@ -822,11 +822,11 @@ symbol currently recognized}
 @cindex   Frequently Asked Questions
 
 @kindex C-x h
-@kindex ESC C-\
-@kindex ESC C-q
-@kindex ESC C-u
-@kindex RET
-@kindex LFD
+@kindex @key{ESC} C-\
+@kindex @key{ESC} C-q
+@kindex @key{ESC} C-u
+@kindex @key{RET}
+@kindex @key{LFD}
 @findex newline-and-indent
 @quotation
 
diff --git a/doc/misc/vip.texi b/doc/misc/vip.texi
index af4c05d8e4..aa55130e0e 100644
--- a/doc/misc/vip.texi
+++ b/doc/misc/vip.texi
@@ -186,8 +186,8 @@ M-x vip-mode
 @node Modes in VIP
 @section Modes in VIP
 
-@kindex 032 @kbd{C-z} (@code{vip-change-mode-to-vi})
-@kindex 0301 @kbd{C-x C-z} (@code{suspend-emacs})
+@kindex 032 C-z @r{(}@code{vip-change-mode-to-vi}@r{)}
+@kindex 0301 C-x C-z @r{(}@code{suspend-emacs}@r{)}
 
 Loading VIP has the effect of globally binding @kbd{C-z} (@kbd{Control-z})
 to the function @code{vip-change-mode-to-vi}. The default binding of @kbd{C-z}
@@ -266,7 +266,7 @@ emacs mode             vi mode                 insert mode
 @node Emacs Mode
 @subsection Emacs Mode
 
-@kindex 032 @kbd{C-z} (@code{vip-change-mode-to-vi})
+@kindex 032 C-z @r{(}@code{vip-change-mode-to-vi}@r{)}
 
 You will be in this mode just after you loaded VIP@.  You can do all
 normal Emacs editing in this mode.  Note that the key @kbd{C-z} is globally
@@ -289,16 +289,16 @@ its content while you are in insert mode.
 
 @table @kbd
 @item @key{ESC}
-@kindex 033 @kbd{ESC} (@code{vip-change-mode-to-vi}) (insert mode)
+@kindex 033 @key{ESC} @r{(}@code{vip-change-mode-to-vi}@r{) (insert mode)}
 This key will take you back to vi mode.
 @item C-h
-@kindex 010 @kbd{C-h} (@code{vip-delete-backward-char}) (insert mode)
+@kindex 010 C-h @r{(}@code{vip-delete-backward-char}@r{) (insert mode)}
 Delete previous character.
 @item C-w
-@kindex 027 @kbd{C-w} (@code{vip-delete-backward-word}) (insert mode)
+@kindex 027 C-w @r{(}@code{vip-delete-backward-word}@r{) (insert mode)}
 Delete previous word.
 @item C-z
-@kindex 032 @kbd{C-z} (@code{vip-ESC}) (insert mode)
+@kindex 032 C-z @r{(}@code{vip-ESC}@r{) (insert mode)}
 Typing this key has the same effect as typing @key{ESC} in emacs mode.
 Thus typing @kbd{C-z x} in insert mode will have the same effect as typing
 @kbd{ESC x} in emacs mode.
@@ -332,8 +332,8 @@ The major differences from Vi are explained below.
 @node Undoing
 @subsection Undoing
 
-@kindex 165 @kbd{u} (@code{vip-undo})
-@kindex 056 @kbd{.} (@code{vip-repeat})
+@kindex 165 u @r{(}@code{vip-undo}@r{)}
+@kindex 056 . @r{(}@code{vip-repeat}@r{)}
 
 You can repeat undoing by the @kbd{.} key.  So, @kbd{u} will undo
 a single change, while @kbd{u .@: .@: .@:}, for instance, will undo 4 previous
@@ -350,14 +350,14 @@ then VIP will prompt you for a new word in the minibuffer by the prompt
 @samp{foo => }.  You can then enter @samp{bar} followed by @key{RET} or
 @key{ESC} to complete the command.  Before you enter @key{RET} or
 @key{ESC} you can abort the command by typing @kbd{C-g}.  In general,
-@kindex 007 @kbd{C-g} (@code{vip-keyboard-quit})
+@kindex 007 C-g @r{(}@code{vip-keyboard-quit})
 you can abort a partially formed command by typing @kbd{C-g}.
 
 @node Searching
 @subsection Searching
 
-@kindex 057 @kbd{/} (@code{vip-search-forward})
-@kindex 077 @kbd{?} (@code{vip-search-backward})
+@kindex 057 / @r{(}@code{vip-search-forward}@r{)}
+@kindex 077 ? @r{(}@code{vip-search-backward}@r{)}
 
 As in Vi, searching is done by @kbd{/} and @kbd{?}.  The string will be
 searched literally by default.  To invoke a regular expression search,
@@ -372,12 +372,12 @@ the buffer as in Vi.  You can change this by rebinding the variable
 @node z Command
 @subsection z Command
 
-@kindex 1723 @kbd{z H} (@code{vip-line-to-top})
-@kindex 1721 @kbd{z RET} (@code{vip-line-to-top})
-@kindex 1723 @kbd{z M} (@code{vip-line-to-middle})
-@kindex 1722 @kbd{z .} (@code{vip-line-to-middle})
-@kindex 1723 @kbd{z L} (@code{vip-line-to-bottom})
-@kindex 1722 @kbd{z -} (@code{vip-line-to-bottom})
+@kindex 1723 z H @r{(}@code{vip-line-to-top}@r{)}
+@kindex 1721 z @key{RET} @r{(}@code{vip-line-to-top}@r{)}
+@kindex 1723 z M @r{(}@code{vip-line-to-middle}@r{)}
+@kindex 1722 z . @r{(}@code{vip-line-to-middle}@r{)}
+@kindex 1723 z L @r{(}@code{vip-line-to-bottom}@r{)}
+@kindex 1722 z - @r{(}@code{vip-line-to-bottom}@r{)}
 
 For those of you who cannot remember which of @kbd{z} followed by @key{RET},
 @kbd{.}@: and @kbd{-} do what.  You can also use @kbd{z} followed by @kbd{H},
@@ -392,21 +392,21 @@ Some Vi commands which do not accept a count now accept one
 @table @kbd
 @item p
 @itemx P
-@kindex 160 @kbd{p} (@code{vip-put-back})
-@kindex 120 @kbd{P} (@code{vip-Put-back})
+@kindex 160 p @r{(}@code{vip-put-back}@r{)}
+@kindex 120 P @r{(}@code{vip-Put-back}@r{)}
 Given counts, text will be yanked (in Vi's sense) that many times.  Thus
 @kbd{3 p} is the same as @kbd{p p p}.
 @item o
 @itemx O
-@kindex 157 @kbd{o} (@code{vip-open-line})
-@kindex 117 @kbd{O} (@code{vip-Open-line})
+@kindex 157 o @r{(}@code{vip-open-line}@r{)}
+@kindex 117 O @r{(}@code{vip-Open-line}@r{)}
 Given counts, that many copies of text will be inserted. Thus
 @kbd{o a b c @key{ESC}} will insert 3 lines of @samp{abc} below the current
 line.
 @item /
 @itemx ?
-@kindex 057 @kbd{/} (@code{vip-search-forward})
-@kindex 077 @kbd{?} (@code{vip-search-backward})
+@kindex 057 / @r{(}@code{vip-search-forward}@r{)}
+@kindex 077 ? @r{(}@code{vip-search-backward}@r{)}
 Given a count @var{n}, @var{n}-th occurrence will be searched.
 @end table
 
@@ -417,7 +417,7 @@ Typing an @kbd{m} followed by a lower-case character @var{ch} marks the
 point to the register named @var{ch} as in Vi.  In addition to these, we
 have following key bindings for marking.
 
-@kindex 155 @kbd{m} (@code{vip-mark-point})
+@kindex 155 m @r{(}@code{vip-mark-point}@r{)}
 
 @table @kbd
 @item m <
@@ -451,34 +451,34 @@ Note that the keys below (except for @kbd{R}) are not used in Vi.
 
 @table @kbd
 @item C-a
-@kindex 001 @kbd{C-a} (@code{vip-beginning-of-line})
+@kindex 001 C-a @r{(}@code{vip-beginning-of-line}@r{)}
 Move point to the beginning of line.
 @item C-n
-@kindex 016 @kbd{C-n} (@code{vip-next-window})
+@kindex 016 C-n @r{(}@code{vip-next-window}@r{)}
 If you have two or more windows in the screen, this key will move point to
 the next window.
 @item C-o
-@kindex 017 @kbd{C-o} (@code{vip-open-line-at-point})
+@kindex 017 C-o @r{(}@code{vip-open-line-at-point}@r{)}
 Insert a newline and leave point before it, and then enter insert mode.
 @item C-r
-@kindex 022 @kbd{C-r} (@code{isearch-backward})
+@kindex 022 C-r @r{(}@code{isearch-backward}@r{)}
 Backward incremental search.
 @item C-s
-@kindex 023 @kbd{C-s} (@code{isearch-forward})
+@kindex 023 C-s @r{(}@code{isearch-forward}@r{)}
 Forward incremental search.
 @item C-c
 @itemx C-x
 @itemx @key{ESC}
-@kindex 003 @kbd{C-c} (@code{vip-ctl-c})
-@kindex 0300 @kbd{C-x} (@code{vip-ctl-x})
-@kindex 033 @kbd{ESC} (@code{vip-ESC})
+@kindex 003 C-c @r{(}@code{vip-ctl-c}@r{)}
+@kindex 0300 C-x @r{(}@code{vip-ctl-x}@r{)}
+@kindex 033 @key{ESC} @r{(}@code{vip-ESC}@r{)}
 These keys will exit from vi mode and return to emacs mode temporarily.  If
 you hit one of these keys, Emacs will be in emacs mode and will believe
 that you hit that key in emacs mode. For example, if you hit @kbd{C-x}
 followed by @kbd{2}, then the current window will be split into 2 and you
 will be in vi mode again.
 @item \
-@kindex 134 @kbd{\} (@code{vip-escape-to-emacs})
+@kindex 134 \ @r{(}@code{vip-escape-to-emacs}@r{)}
 Escape to emacs mode.  Hitting @kbd{\} will take you to emacs mode, and you
 can execute a single Emacs command.  After executing the Emacs command you
 will be in vi mode again.  You can give a count before typing @kbd{\}.
@@ -486,13 +486,13 @@ Thus @kbd{5 \ *}, as well as @kbd{\ C-u 5 *}, will insert @samp{*****}
 before point.  Similarly @kbd{1 0 \ C-p} will move the point 10 lines above
 the current line.
 @item K
-@kindex 113 @kbd{K} (@code{vip-kill-buffer})
+@kindex 113 K @r{(}@code{vip-kill-buffer}@r{)}
 Kill current buffer if it is not modified.  Useful when you selected a
 buffer which you did not want.
 @item Q
 @itemx R
-@kindex 121 @kbd{Q} (@code{vip-query-replace})
-@kindex 122 @kbd{R} (@code{vip-replace-string})
+@kindex 121 Q @r{(}@code{vip-query-replace}@r{)}
+@kindex 122 R @r{(}@code{vip-replace-string}@r{)}
 @kbd{Q} is for query replace and @kbd{R} is for replace.  By default,
 string to be replaced are treated literally.  If you wish to do a regular
 expression replace, first do replace with empty string as the string to be
@@ -500,39 +500,39 @@ replaced.  In this way, you can toggle between vanilla and regular
 expression replacement.
 @item v
 @itemx V
-@kindex 166 @kbd{v} (@code{vip-find-file})
-@kindex 126 @kbd{V} (@code{vip-find-file-other-window})
+@kindex 166 v @r{(}@code{vip-find-file}@r{)}
+@kindex 126 V @r{(}@code{vip-find-file-other-window}@r{)}
 These keys are used to Visit files.  @kbd{v} will switch to a buffer
 visiting file whose name can be entered in the minibuffer. @kbd{V} is
 similar, but will use window different from the current window.
 @item #
-@kindex 0430 @kbd{#} (@code{vip-command-argument})
+@kindex 0430 # @r{(}@code{vip-command-argument}@r{)}
 If followed by a certain character @var{ch}, it becomes an operator whose
 argument is the region determined by the motion command that follows.
 Currently, @var{ch} can be one of @kbd{c}, @kbd{C}, @kbd{g}, @kbd{q} and
 @kbd{s}.
 @item # c
-@kindex 0432 @kbd{# c} (@code{downcase-region})
+@kindex 0432 # c @r{(}@code{downcase-region}@r{)}
 Change upper-case characters in the region to lower case
 (@code{downcase-region}).
 @item # C
-@kindex 0431 @kbd{# C} (@code{upcase-region})
+@kindex 0431 # C @r{(}@code{upcase-region}@r{)}
 Change lower-case characters in the region to upper case. For instance,
 @kbd{# C 3 w} will capitalize 3 words from the current point
 (@code{upcase-region}).
 @item # g
-@kindex 0432 @kbd{# g} (@code{vip-global-execute})
+@kindex 0432 # g @r{(}@code{vip-global-execute}@r{)}
 Execute last keyboard macro for each line in the region
 (@code{vip-global-execute}).
 @item # q
-@kindex 0432 @kbd{# q} (@code{vip-quote-region})
+@kindex 0432 # q @r{(}@code{vip-quote-region}@r{)}
 Insert specified string at the beginning of each line in the region
 (@code{vip-quote-region}).
 @item # s
-@kindex 0432 @kbd{# s} (@code{spell-region})
+@kindex 0432 # s @r{(}@code{spell-region}@r{)}
 Check spelling of words in the region (@code{spell-region}).
 @item *
-@kindex 052 @kbd{*} (@code{vip-call-last-kbd-macro})
+@kindex 052 * @r{(}@code{vip-call-last-kbd-macro}@r{)}
 Call last keyboard macro.
 @end table
 
@@ -548,21 +548,21 @@ details.
 @table @kbd
 @item C-g
 @itemx g
-@kindex 007 @kbd{C-g} (@code{vip-keyboard-quit})
-@kindex 147 @kbd{g} (@code{vip-info-on-file})
+@kindex 007 C-g @r{(}@code{vip-keyboard-quit}@r{)}
+@kindex 147 g @r{(}@code{vip-info-on-file}@r{)}
 In Vi, @kbd{C-g} is used to get information about the file associated to
 the current buffer.  Here, @kbd{g} will do that, and @kbd{C-g} is
 used to abort a command (this is for compatibility with emacs mode.)
 @item SPC
 @itemx @key{RET}
-@kindex 040 @kbd{SPC} (@code{vip-scroll})
-@kindex 015 @kbd{RET} (@code{vip-scroll-back})
+@kindex 040 @key{SPC} @r{(}@code{vip-scroll}@r{)}
+@kindex 015 @key{RET} @r{(}@code{vip-scroll-back}@r{)}
 Now these keys will scroll up and down the text of current window.
 Convenient for viewing the text.
 @item s
 @itemx S
-@kindex 163 @kbd{s} (@code{vip-switch-to-buffer})
-@kindex 123 @kbd{S} (@code{vip-switch-to-buffer-other-window})
+@kindex 163 s @r{(}@code{vip-switch-to-buffer}@r{)}
+@kindex 123 S @r{(}@code{vip-switch-to-buffer-other-window}@r{)}
 They are used to switch to a specified buffer.  Useful for switching to
 already existing buffer since buffer name completion is provided.  Also
 a default buffer will be given as part of the prompt, to which you can
@@ -570,8 +570,8 @@ switch by just typing @key{RET} key.  @kbd{s} is used to select buffer
 in the current window, while @kbd{S} selects buffer in another window.
 @item C
 @itemx X
-@kindex 103 @kbd{C} (@code{vip-ctl-c-equivalent})
-@kindex 1300 @kbd{X} (@code{vip-ctl-x-equivalent})
+@kindex 103 C @r{(}@code{vip-ctl-c-equivalent}@r{)}
+@kindex 1300 X @r{(}@code{vip-ctl-x-equivalent}@r{)}
 These keys will exit from vi mode and return to emacs mode temporarily.
 If you type @kbd{C} (@kbd{X}), Emacs will be in emacs mode and will believe
 that you have typed @kbd{C-c} (@kbd{C-x}) in emacs mode. Moreover,
@@ -588,7 +588,7 @@ vi mode again.
 
 In addition to these, @code{ctl-x-map} is slightly modified:
 
-@kindex 1301 @kbd{X 3} (@code{vip-buffer-in-two-windows})
+@kindex 1301 X 3 @r{(}@code{vip-buffer-in-two-windows}@r{)}
 
 @table @kbd
 @item X 3
@@ -604,19 +604,19 @@ basic functions related to windows, buffers and files.
 
 @table @kbd
 @item C-n
-@kindex 016 @kbd{C-n} (@code{vip-next-window})
+@kindex 016 C-n @r{(}@code{vip-next-window}@r{)}
 Switch to next window.
 @item X 1
 @itemx C-x 1
-@kindex 1301 @kbd{X 1} (@code{delete-other-windows})
+@kindex 1301 X 1 @r{(}@code{delete-other-windows}@r{)}
 Delete other windows.
 @item X 2
 @itemx C-x 2
-@kindex 1301 @kbd{X 2} (@code{split-window-vertically})
+@kindex 1301 X 2 @r{(}@code{split-window-vertically}@r{)}
 Split current window into two windows.
 @item X 3
 @itemx C-x 3
-@kindex 1301 @kbd{X 3} (@code{vip-buffer-in-two-windows})
+@kindex 1301 X 3 @r{(}@code{vip-buffer-in-two-windows}@r{)}
 Show current buffer in two windows.
 @end table
 
@@ -625,19 +625,19 @@ Show current buffer in two windows.
 
 @table @kbd
 @item s
-@kindex 163 @kbd{s} (@code{vip-switch-to-buffer})
+@kindex 163 s @r{(}@code{vip-switch-to-buffer}@r{)}
 Switch to the specified buffer in the current window
 (@code{vip-switch-to-buffer}).
 @item S
-@kindex 123 @kbd{S} (@code{vip-switch-to-buffer-other-window})
+@kindex 123 S @r{(}@code{vip-switch-to-buffer-other-window}@r{)}
 Switch to the specified buffer in another window
 (@code{vip-switch-to-buffer-other-window}).
 @item K
-@kindex 113 @kbd{K} (@code{vip-kill-buffer})
+@kindex 113 K @r{(}@code{vip-kill-buffer}@r{)}
 Kill the current buffer if it is not modified.
 @item X S
 @itemx C-x C-s
-@kindex 1302 @kbd{X S} (@code{save-buffer})
+@kindex 1302 X S @r{(}@code{save-buffer}@r{)}
 Save the current buffer in the file associated to the buffer.
 @end table
 
@@ -646,18 +646,18 @@ Save the current buffer in the file associated to the buffer.
 
 @table @kbd
 @item v
-@kindex 166 @kbd{v} (@code{vip-find-file})
+@kindex 166 v @r{(}@code{vip-find-file}@r{)}
 Visit specified file in the current window.
 @item V
-@kindex 126 @kbd{V} (@code{vip-find-file-other-window})
+@kindex 126 V @r{(}@code{vip-find-file-other-window}@r{)}
 Visit specified file in another window.
 @item X W
 @itemx C-x C-w
-@kindex 1302 @kbd{X W} (@code{write-file})
+@kindex 1302 X W @r{(}@code{write-file}@r{)}
 Write current buffer into the specified file.
 @item X I
 @itemx C-x C-i
-@kindex 1302 @kbd{X I} (@code{insert-file})
+@kindex 1302 X I @r{(}@code{insert-file}@r{)}
 
 Insert specified file at point.
 @end table
@@ -668,18 +668,18 @@ Insert specified file at point.
 @table @kbd
 @item X (
 @itemx C-x (
-@kindex 1301 @kbd{X (} (@code{start-kbd-macro})
+@kindex 1301 X ( @r{(}@code{start-kbd-macro}@r{)}
 Start remembering keyboard macro.
 @item X )
 @itemx C-x )
-@kindex 1301 @kbd{X )} (@code{end-kbd-macro})
+@kindex 1301 X ) @r{(}@code{end-kbd-macro}@r{)}
 Finish remembering keyboard macro.
 @item *
-@kindex 052 @kbd{*} (@code{vip-call-last-kbd-macro})
+@kindex 052 * @r{(}@code{vip-call-last-kbd-macro}@r{)}
 Call last remembered keyboard macro.
 @item X Z
 @itemx C-x C-z
-@kindex 1302 @kbd{X Z} (@code{suspend-emacs})
+@kindex 1302 X Z @r{(}@code{suspend-emacs}@r{)}
 Suspend Emacs.
 @item Z Z
 Exit Emacs.
@@ -715,15 +715,15 @@ commands described in this chapter are to be used in vi mode.
 
 @cindex numeric arguments
 @cindex count
-@kindex 061 @kbd{1} (numeric argument)
-@kindex 062 @kbd{2} (numeric argument)
-@kindex 063 @kbd{3} (numeric argument)
-@kindex 064 @kbd{4} (numeric argument)
-@kindex 065 @kbd{5} (numeric argument)
-@kindex 066 @kbd{6} (numeric argument)
-@kindex 067 @kbd{7} (numeric argument)
-@kindex 068 @kbd{8} (numeric argument)
-@kindex 069 @kbd{9} (numeric argument)
+@kindex 061 1 @r{(numeric argument)}
+@kindex 062 2 @r{(numeric argument)}
+@kindex 063 3 @r{(numeric argument)}
+@kindex 064 4 @r{(numeric argument)}
+@kindex 065 5 @r{(numeric argument)}
+@kindex 066 6 @r{(numeric argument)}
+@kindex 067 7 @r{(numeric argument)}
+@kindex 068 8 @r{(numeric argument)}
+@kindex 069 9 @r{(numeric argument)}
 
 Most Vi commands accept a @dfn{numeric argument} which can be supplied as
 a prefix to the commands.  A numeric argument is also called a @dfn{count}.
@@ -739,10 +739,10 @@ functions are the same in any of emacs, vi and insert mode.
 
 @table @kbd
 @item C-g
-@kindex 007 @kbd{C-g} (@code{vip-keyboard-quit})
+@kindex 007 C-g (@code{vip-keyboard-quit}@r{)}
 Quit.  Cancel running or partially typed command (@code{keyboard-quit}).
 @item C-l
-@kindex 014 @kbd{C-l} (@code{recenter})
+@kindex 014 C-l @r{(}@code{recenter}@r{)}
 Clear the screen and reprint everything (@code{recenter}).
 @end table
 
@@ -754,9 +754,9 @@ accessed from vi mode as easily as from emacs mode.
 @item C-x
 @itemx C-c
 @itemx @key{ESC}
-@kindex 003 @kbd{C-c} (@code{vip-ctl-c})
-@kindex 0300 @kbd{C-x} (@code{vip-ctl-x})
-@kindex 033 @kbd{ESC} (@code{vip-ESC})
+@kindex 003 C-c @r{(}@code{vip-ctl-c}@r{)}
+@kindex 0300 C-x @r{(}@code{vip-ctl-x}@r{)}
+@kindex 033 @key{ESC} @r{(}@code{vip-ESC}@r{)}
 Typing one of these keys have the same effect as typing it in emacs mode.
 Appropriate command will be executed according as the keys you type after
 it.  You will be in vi mode again after the execution of the command.
@@ -764,8 +764,8 @@ For instance, if you type @kbd{@key{ESC} <} (in vi mode) then the cursor will
 move to the beginning of the buffer and you will still be in vi mode.
 @item C
 @itemx X
-@kindex 103 @kbd{C} (@code{vip-ctl-c-equivalent})
-@kindex 1300 @kbd{X} (@code{vip-ctl-x-equivalent})
+@kindex 103 C @r{(}@code{vip-ctl-c-equivalent}@r{)}
+@kindex 1300 X @r{(}@code{vip-ctl-x-equivalent}@r{)}
 Typing one of these keys have the effect of typing the corresponding
 control character in emacs mode.  Moreover, if you type an upper-case
 character following it, that character will also be translated to the
@@ -773,7 +773,7 @@ corresponding control character.  Thus typing @kbd{X W} in vi mode is the
 same as typing @kbd{C-x C-w} in emacs mode.  You will be in vi mode again
 after the execution of a command.
 @item \
-@kindex 134 @kbd{\} (@code{vip-escape-to-emacs})
+@kindex 134 \ @r{(}@code{vip-escape-to-emacs}@r{)}
 Escape to emacs mode.  Hitting the @kbd{\} key will take you to emacs mode,
 and you can execute a single Emacs command.  After executing the
 Emacs command you will be in vi mode again.  You can give a count before
@@ -810,31 +810,31 @@ We have the following commands related to windows and buffers.
 
 @table @kbd
 @item C-n
-@kindex 016 @kbd{C-n} (@code{vip-next-window})
+@kindex 016 C-n @r{(}@code{vip-next-window}@r{)}
 Move cursor to the next-window (@code{vip-next-window}).
 @item X 1
-@kindex 1301 @kbd{X 1} (@code{delete-other-windows})
+@kindex 1301 X 1 @r{(}@code{delete-other-windows}@r{)}
 Delete other windows and make the selected window fill the screen
 @*(@code{delete-other-windows}).
 @item X 2
-@kindex 1301 @kbd{X 2} (@code{split-window-vertically})
+@kindex 1301 X 2 @r{(}@code{split-window-vertically}@r{)}
 Split current window into two windows (@code{split-window-vertically}).
 @item X 3
-@kindex 1301 @kbd{X 3} (@code{vip-buffer-in-two-windows})
+@kindex 1301 X 3 @r{(}@code{vip-buffer-in-two-windows}@r{)}
 Show current buffer in two windows.
 @item s @var{buffer} @key{RET}
-@kindex 163 @kbd{s} (@code{vip-switch-to-buffer})
+@kindex 163 s @r{(}@code{vip-switch-to-buffer}@r{)}
 Select or create a buffer named @var{buffer} (@code{vip-switch-to-buffer}).
 @item S @var{buffer} @key{RET}
-@kindex 123 @kbd{S} (@code{vip-switch-to-buffer-other-window})
+@kindex 123 S @r{(}@code{vip-switch-to-buffer-other-window}@r{)}
 Similar but select a buffer named @var{buffer} in another window
 @*(@code{vip-switch-to-buffer-other-window}).
 @item K
-@kindex 113 @kbd{K} (@code{vip-kill-buffer})
+@kindex 113 K @r{(}@code{vip-kill-buffer}@r{)}
 Kill the current buffer if it is not modified or if it is not associated
 with a file @*(@code{vip-kill-buffer}).
 @item X B
-@kindex 1302 @kbd{X B} (@code{list-buffers})
+@kindex 1302 X B @r{(}@code{list-buffers}@r{)}
 List the existing buffers (@code{list-buffers}).
 @end table
 
@@ -856,24 +856,24 @@ save and insert files.
 
 @table @kbd
 @item v @var{file} @key{RET}
-@kindex 166 @kbd{v} (@code{vip-find-file})
+@kindex 166 v @r{(}@code{vip-find-file}@r{)}
 Visit specified file in the current window (@code{vip-find-file}).
 @item V @var{file} @key{RET}
-@kindex 126 @kbd{V} (@code{vip-find-file-other-window})
+@kindex 126 V @r{(}@code{vip-find-file-other-window}@r{)}
 Visit specified file in another window (@code{vip-find-file-other-window}).
 @item X S
-@kindex 1302 @kbd{X S} (@code{save-buffer})
+@kindex 1302 X S @r{(}@code{save-buffer}@r{)}
 Save current buffer to the file associated with the buffer.  If no file is
 associated with the buffer, the name of the file to write out the content
 of the buffer will be asked in the minibuffer.
 @item X W @var{file} @key{RET}
-@kindex 1302 @kbd{X W} (@code{write-file})
+@kindex 1302 X W @r{(}@code{write-file}@r{)}
 Write current buffer into a specified file.
 @item X I @var{file} @key{RET}
-@kindex 1302 @kbd{X I} (@code{insert-file})
+@kindex 1302 X I @r{(}@code{insert-file}@r{)}
 Insert a specified file at point.
 @item g
-@kindex 147 @kbd{g} (@code{vip-info-on-file})
+@kindex 147 g @r{(}@code{vip-info-on-file}@r{)}
 Give information on the file associated with the current buffer.  Tell you
 the name of the file associated with the buffer, the line number of the
 current point and total line numbers in the buffer.  If no file is
@@ -940,29 +940,29 @@ buffer.
 @table @kbd
 @item @key{SPC}
 @itemx C-f
-@kindex 040 @kbd{SPC} (@code{vip-scroll})
-@kindex 006 @kbd{C-f} (@code{vip-scroll-back})
+@kindex 040 @key{SPC} @r{(}@code{vip-scroll}@r{)}
+@kindex 006 C-f @r{(}@code{vip-scroll-back}@r{)}
 Scroll text of current window upward almost full screen.  You can go
 @i{forward} in the buffer by this command (@code{vip-scroll}).
 @item @key{RET}
 @itemx C-b
-@kindex 015 @kbd{RET} (@code{vip-scroll-back})
-@kindex 002 @kbd{C-b} (@code{vip-scroll-back})
+@kindex 015 @key{RET} @r{(}@code{vip-scroll-back}@r{)}
+@kindex 002 C-b @r{(}@code{vip-scroll-back}@r{)}
 Scroll text of current window downward almost full screen.  You can go
 @i{backward} in the buffer by this command (@code{vip-scroll-back}).
 @item C-d
-@kindex 004 @kbd{C-d} (@code{vip-scroll-up})
+@kindex 004 C-d @r{(}@code{vip-scroll-up}@r{)}
 Scroll text of current window upward half screen.  You can go
 @i{down} in the buffer by this command (@code{vip-scroll-down}).
 @item C-u
-@kindex 025 @kbd{C-u} (@code{vip-scroll-down})
+@kindex 025 C-u @r{(}@code{vip-scroll-down}@r{)}
 Scroll text of current window downward half screen.  You can go
 @i{up} in the buffer by this command (@code{vip-scroll-up}).
 @item C-y
-@kindex 031 @kbd{C-y} (@code{vip-scroll-down-one})
+@kindex 031 C-y @r{(}@code{vip-scroll-down-one}@r{)}
 Scroll text of current window upward by one line (@code{vip-scroll-down-one}).
 @item C-e
-@kindex 005 @kbd{C-e} (@code{vip-scroll-up-one})
+@kindex 005 C-e @r{(}@code{vip-scroll-up-one}@r{)}
 Scroll text of current window downward by one line (@code{vip-scroll-up-one}).
 @end table
 @noindent
@@ -974,22 +974,22 @@ The following commands reposition point in the window.
 @table @kbd
 @item z H
 @itemx z @key{RET}
-@kindex 1723 @kbd{z H} (@code{vip-line-to-top})
-@kindex 1721 @kbd{z RET} (@code{vip-line-to-top})
+@kindex 1723 z H @r{(}@code{vip-line-to-top}@r{)}
+@kindex 1721 z @key{RET} @r{(}@code{vip-line-to-top}@r{)}
 Put point on the top (@i{home}) line in the window.  So the current line
 becomes the top line in the window.  Given a count @var{n}, point will be
 placed in the @var{n}-th line from top (@code{vip-line-to-top}).
 @item z M
 @itemx z .
-@kindex 1723 @kbd{z M} (@code{vip-line-to-middle})
-@kindex 1722 @kbd{z .} (@code{vip-line-to-middle})
+@kindex 1723 z M @r{(}@code{vip-line-to-middle}@r{)}
+@kindex 1722 z . @r{(}@code{vip-line-to-middle}@r{)}
 Put point on the @i{middle} line in the window.  Given a count @var{n},
 point will be placed in the @var{n}-th line from the middle line
 (@code{vip-line-to-middle}).
 @item z L
 @itemx z -
-@kindex 1723 @kbd{z L} (@code{vip-line-to-bottom})
-@kindex 1722 @kbd{z -} (@code{vip-line-to-bottom})
+@kindex 1723 z L @r{(}@code{vip-line-to-bottom}@r{)}
+@kindex 1722 z - @r{(}@code{vip-line-to-bottom}@r{)}
 Put point on the @i{bottom} line in the window.  Given a count @var{n},
 point will be placed in the @var{n}-th line from bottom
 (@code{vip-line-to-bottom}).
@@ -1004,7 +1004,7 @@ The following commands are used to mark positions in the buffer.
 
 @table @kbd
 @item m @var{ch}
-@kindex 155 @kbd{m} (@code{vip-mark-point})
+@kindex 155 m @r{(}@code{vip-mark-point}@r{)}
 Store current point in the register @var{ch}.  @var{ch} must be a
 lower-case @acronym{ASCII} letter.
 @item m <
@@ -1034,31 +1034,31 @@ to be described in the next section.
 
 @table @kbd
 @item h
-@kindex 150 @kbd{h} (@code{vip-backward-char})
+@kindex 150 h @r{(}@code{vip-backward-char}@r{)}
 Move point backward by one character.  Signal error if point is at the
 beginning of buffer, but (unlike Vi) do not complain otherwise
 (@code{vip-backward-char}).
 @item l
-@kindex 154 @kbd{l} (@code{vip-forward-char})
+@kindex 154 l @r{(}@code{vip-forward-char}@r{)}
 Move point backward by one character.  Signal error if point is at the
 end of buffer, but (unlike Vi) do not complain otherwise
 (@code{vip-forward-char}).
 @item j
-@kindex 152 @kbd{j} (@code{vip-next-line})
+@kindex 152 j @r{(}@code{vip-next-line}@r{)}
 Move point to the next line keeping the current column.  If point is on the
 last line of the buffer, a new line will be created and point will move to
 that line (@code{vip-next-line}).
 @item k
-@kindex 153 @kbd{k} (@code{vip-previous-line})
+@kindex 153 k @r{(}@code{vip-previous-line}@r{)}
 Move point to the previous line keeping the current column
 (@code{vip-next-line}).
 @item +
-@kindex 053 @kbd{+} (@code{vip-next-line-at-bol})
+@kindex 053 + @r{(}@code{vip-next-line-at-bol}@r{)}
 Move point to the next line at the first non-white character.  If point is
 on the last line of the buffer, a new line will be created and point will
 move to the beginning of that line (@code{vip-next-line-at-bol}).
 @item -
-@kindex 055 @kbd{-} (@code{vip-previous-line-at-bol})
+@kindex 055 - @r{(}@code{vip-previous-line-at-bol}@r{)}
 Move point to the previous line at the first non-white character
 (@code{vip-previous-line-at-bol}).
 @end table
@@ -1068,17 +1068,17 @@ many times.
 
 @table @kbd
 @item 0
-@kindex 060 @kbd{0} (@code{vip-beginning-of-line})
+@kindex 060 0 @r{(}@code{vip-beginning-of-line}@r{)}
 Move point to the beginning of line (@code{vip-beginning-of-line}).
 @item ^
-@kindex 136 @kbd{^} (@code{vip-bol-and-skip-white})
+@kindex 136 ^ @r{(}@code{vip-bol-and-skip-white}@r{)}
 Move point to the first non-white character on the line
 (@code{vip-bol-and-skip-white}).
 @item $
-@kindex 044 @kbd{$} (@code{vip-goto-eol})
+@kindex 044 $ @r{(}@code{vip-goto-eol}@r{)}
 Move point to the end of line (@code{vip-goto-eol}).
 @item @var{n} |
-@kindex 174 @kbd{|} (@code{vip-goto-col})
+@kindex 174 | @r{(}@code{vip-goto-col}@r{)}
 Move point to the @var{n}-th column on the line (@code{vip-goto-col}).
 @end table
 @noindent
@@ -1088,25 +1088,25 @@ Except for the @kbd{|} command, these commands neglect a count.
 
 @table @kbd
 @item w
-@kindex 167 @kbd{w} (@code{vip-forward-word})
+@kindex 167 w @r{(}@code{vip-forward-word}@r{)}
 Move point forward to the beginning of the next word
 (@code{vip-forward-word}).
 @item W
-@kindex 127 @kbd{W} (@code{vip-forward-Word})
+@kindex 127 W @r{(}@code{vip-forward-Word}@r{)}
 Move point forward to the beginning of the next word, where a @dfn{word} is
 considered as a sequence of non-white characters (@code{vip-forward-Word}).
 @item b
-@kindex 142 @kbd{b} (@code{vip-backward-word})
+@kindex 142 b @r{(}@code{vip-backward-word}@r{)}
 Move point backward to the beginning of a word (@code{vip-backward-word}).
 @item B
-@kindex 102 @kbd{B} (@code{vip-backward-Word})
+@kindex 102 B @r{(}@code{vip-backward-Word}@r{)}
 Move point backward to the beginning of a word, where a @i{word} is
 considered as a sequence of non-white characters (@code{vip-forward-Word}).
 @item e
-@kindex 145 @kbd{e} (@code{vip-end-of-word})
+@kindex 145 e @r{(}@code{vip-end-of-word}@r{)}
 Move point forward to the end of a word (@code{vip-end-of-word}).
 @item E
-@kindex 105 @kbd{E} (@code{vip-end-of-Word})
+@kindex 105 E @r{(}@code{vip-end-of-Word}@r{)}
 Move point forward to the end of a word, where a @i{word} is
 considered as a sequence of non-white characters (@code{vip-end-of-Word}).
 @end table
@@ -1120,17 +1120,17 @@ details of syntax table.
 
 @table @kbd
 @item H
-@kindex 110 @kbd{H} (@code{vip-window-top})
+@kindex 110 H @r{(}@code{vip-window-top}@r{)}
 Move point to the beginning of the @i{home} (top) line of the window.
 Given a count @var{n}, go to the @var{n}-th line from top
 (@code{vip-window-top}).
 @item M
-@kindex 115 @kbd{M} (@code{vip-window-middle})
+@kindex 115 M @r{(}@code{vip-window-middle}@r{)}
 Move point to the beginning of the @i{middle} line of the window.  Given
 a count @var{n}, go to the @var{n}-th line from the middle line
 (@code{vip-window-middle}).
 @item L
-@kindex 114 @kbd{L} (@code{vip-window-bottom})
+@kindex 114 L @r{(}@code{vip-window-bottom}@r{)}
 Move point to the beginning of the @i{lowest} (bottom) line of the
 window.  Given count, go to the @var{n}-th line from bottom
 (@code{vip-window-bottom}).
@@ -1140,19 +1140,19 @@ These commands can be used to go to the desired line visible on the screen.
 
 @table @kbd
 @item (
-@kindex 050 @kbd{(} (@code{vip-backward-sentence})
+@kindex 050 ( @r{(}@code{vip-backward-sentence}@r{)}
 Move point backward to the beginning of the sentence
 (@code{vip-backward-sentence}).
 @item )
-@kindex 051 @kbd{)} (@code{vip-forward-sentence})
+@kindex 051 ) @r{(}@code{vip-forward-sentence}@r{)}
 Move point forward to the end of the sentence
 (@code{vip-forward-sentence}).
 @item @{
-@kindex 173 @kbd{@{} (@code{vip-backward-paragraph})
+@kindex 173 @{ @r{(}@code{vip-backward-paragraph}@r{)}
 Move point backward to the beginning of the paragraph
 (@code{vip-backward-paragraph}).
 @item @}
-@kindex 175 @kbd{@}} (@code{vip-forward-paragraph})
+@kindex 175 @} @r{(}@code{vip-forward-paragraph}@r{)}
 Move point forward to the end of the paragraph
 (@code{vip-forward-paragraph}).
 @end table
@@ -1161,25 +1161,25 @@ A count repeats the effect for these commands.
 
 @table @kbd
 @item G
-@kindex 107 @kbd{G} (@code{vip-goto-line})
+@kindex 107 G @r{(}@code{vip-goto-line}@r{)}
 Given a count @var{n}, move point to the @var{n}-th line in the buffer on
 the first non-white character.  Without a count, go to the end of the buffer
 (@code{vip-goto-line}).
 @item ` `
-@kindex 140 @kbd{`} (@code{vip-goto-mark})
+@kindex 140 ` @r{(}@code{vip-goto-mark}@r{)}
 Exchange point and mark (@code{vip-goto-mark}).
 @item ` @var{ch}
 Move point to the position stored in the register @var{ch}.  @var{ch} must
 be a lower-case letter.
 @item ' '
-@kindex 047 @kbd{'} (@code{vip-goto-mark-and-skip-white})
+@kindex 047 ' @r{(}@code{vip-goto-mark-and-skip-white}@r{)}
 Exchange point and mark, and then move point to the first non-white
 character on the line (@code{vip-goto-mark-and-skip-white}).
 @item ' @var{ch}
 Move point to the position stored in the register @var{ch} and skip to the
 first non-white character on the line.  @var{ch} must be a lower-case letter.
 @item %
-@kindex 045 @kbd{%} (@code{vip-paren-match})
+@kindex 045 % @r{(}@code{vip-paren-match}@r{)}
 Move point to the matching parenthesis if point is looking at @kbd{(},
 @kbd{)}, @kbd{@{}, @kbd{@}}, @kbd{[} or @kbd{]}
 @*(@code{vip-paren-match}).
@@ -1194,27 +1194,27 @@ will repeat the effect.
 
 @table @kbd
 @item f @var{ch}
-@kindex 146 @kbd{f} (@code{vip-find-char-forward})
+@kindex 146 f @r{(}@code{vip-find-char-forward}@r{)}
 Move point forward to the character @var{ch} on the line.  Signal error if
 @var{ch} could not be found (@code{vip-find-char-forward}).
 @item F @var{ch}
-@kindex 106 @kbd{F} (@code{vip-find-char-backward})
+@kindex 106 F @r{(}@code{vip-find-char-backward}@r{)}
 Move point backward to the character @var{ch} on the line.  Signal error if
 @var{ch} could not be found (@code{vip-find-char-backward}).
 @item t @var{ch}
-@kindex 164 @kbd{t} (@code{vip-goto-char-forward})
+@kindex 164 t @r{(}@code{vip-goto-char-forward}@r{)}
 Move point forward upto the character @var{ch} on the line.  Signal error if
 @var{ch} could not be found (@code{vip-goto-char-forward}).
 @item T @var{ch}
-@kindex 124 @kbd{T} (@code{vip-goto-char-backward})
+@kindex 124 T @r{(}@code{vip-goto-char-backward}@r{)}
 Move point backward upto the character @var{ch} on the line.  Signal error if
 @var{ch} could not be found (@code{vip-goto-char-backward}).
 @item ;
-@kindex 073 @kbd{;} (@code{vip-repeat-find})
+@kindex 073 ; @r{(}@code{vip-repeat-find}@r{)}
 Repeat previous @kbd{f}, @kbd{t}, @kbd{F} or @kbd{T} command
 (@code{vip-repeat-find}).
 @item ,
-@kindex 054 @kbd{,} (@code{vip-repeat-find-opposite})
+@kindex 054 , @r{(}@code{vip-repeat-find-opposite}@r{)}
 Repeat previous @kbd{f}, @kbd{t}, @kbd{F} or @kbd{T} command, in the
 opposite direction (@code{vip-repeat-find-opposite}).
 @end table
@@ -1228,7 +1228,7 @@ Following commands are available for searching and replacing.
 
 @table @kbd
 @item / @var{string} @key{RET}
-@kindex 057 @kbd{/} (@code{vip-search-forward})
+@kindex 057 / @r{(}@code{vip-search-forward}@r{)}
 Search the first occurrence of the string @var{string} forward starting
 from point.  Given a count @var{n}, the @var{n}-th occurrence of
 @var{string} will be searched.  If the variable @code{vip-re-search} has value
@@ -1238,28 +1238,28 @@ empty string as @var{string} then the search mode will change from vanilla
 search to regular expression search and vice versa
 (@code{vip-search-forward}).
 @item ? @var{string} @key{RET}
-@kindex 077 @kbd{?} (@code{vip-search-backward})
+@kindex 077 ? @r{(}@code{vip-search-backward}@r{)}
 Same as @kbd{/}, except that search is done backward
 (@code{vip-search-backward}).
 @item n
-@kindex 156 @kbd{n} (@code{vip-search-next})
+@kindex 156 n @r{(}@code{vip-search-next}@r{)}
 Search the previous search pattern in the same direction as before
 (@code{vip-search-next}).
 @item N
-@kindex 116 @kbd{N} (@code{vip-search-Next})
+@kindex 116 N @r{(}@code{vip-search-Next}@r{)}
 Search the previous search pattern in the opposite direction
 (@code{vip-search-Next}).
 @item C-s
-@kindex 023 @kbd{C-s} (@code{isearch-forward})
+@kindex 023 C-s @r{(}@code{isearch-forward}@r{)}
 Search forward incrementally.  See GNU Emacs Manual for details
 (@code{isearch-forward}).
 @item C-r
-@kindex 022 @kbd{C-r} (@code{isearch-backward})
+@kindex 022 C-r @r{(}@code{isearch-backward}@r{)}
 Search backward incrementally (@code{isearch-backward}).
 @cindex vanilla (replacement)
 @cindex regular expression (replacement)
 @item R @var{string} RET @var{newstring}
-@kindex 122 @kbd{R} (@code{vip-replace-string})
+@kindex 122 R @r{(}@code{vip-replace-string}@r{)}
 There are two modes of replacement, @dfn{vanilla} and @dfn{regular expression}.
 If the mode is @i{vanilla} you will get a prompt @samp{Replace string:},
 and if the mode is @i{regular expression} you will ge a prompt
@@ -1270,12 +1270,12 @@ vanilla, this command replaces every occurrence of @var{string} with
 treated as a regular expression and every string matching the regular
 expression is replaced with @var{newstring} (@code{vip-replace-string}).
 @item Q @var{string} RET @var{newstring}
-@kindex 121 @kbd{Q} (@code{vip-query-replace})
+@kindex 121 Q @r{(}@code{vip-query-replace}@r{)}
 Same as @kbd{R} except that you will be asked form confirmation before each
 replacement
 @*(@code{vip-query-replace}).
 @item r @var{ch}
-@kindex 162 @kbd{r} (@code{vip-replace-char})
+@kindex 162 r @r{(}@code{vip-replace-char}@r{)}
 Replace the character point is looking at by the character @var{ch}.  Give
 count, replace that many characters by @var{ch} (@code{vip-replace-char}).
 @end table
@@ -1326,7 +1326,7 @@ command.
 
 @table @kbd
 @item d @var{motion-command}
-@kindex 1440 @kbd{d} (@code{vip-command-argument})
+@kindex 1440 d @r{(}@code{vip-command-argument}@r{)}
 Delete the region determined by the motion command @var{motion-command}.
 @end table
 @noindent
@@ -1337,7 +1337,7 @@ end of the buffer, since @kbd{G} is a line command.  A count given to the
 command above will become the count for the associated motion command.
 Thus, @kbd{3 d w} will delete three words.
 
-@kindex 042 @kbd{"} (@code{vip-command-argument})
+@kindex 042 " @r{(}@code{vip-command-argument}@r{)}
 It is also possible to save the deleted text into a register you specify.
 For example, you can say @kbd{" t 3 d w} to delete three words and save it
 to register @kbd{t}.  The name of a register is a lower-case letter between
@@ -1352,23 +1352,23 @@ We have more delete commands as below.
 
 @table @kbd
 @item d d
-@kindex 1442 @kbd{d d}
+@kindex 1442 d d
 Delete a line.  Given a count @var{n}, delete @var{n} lines.
 @item d r
-@kindex 1442 @kbd{d r}
+@kindex 1442 d r
 Delete current region.
 @item d R
-@kindex 1441 @kbd{d R}
+@kindex 1441 d R
 Expand current region and delete it.
 @item D
-@kindex 104 @kbd{D} (@code{vip-kill-line})
+@kindex 104 D @r{(}@code{vip-kill-line}@r{)}
 Delete to the end of a line (@code{vip-kill-line}).
 @item x
-@kindex 170 @kbd{x} (@code{vip-delete-char})
+@kindex 170 x @r{(}@code{vip-delete-char}@r{)}
 Delete a character after point.  Given @var{n}, delete @var{n} characters
 (@code{vip-delete-char}).
 @item @key{DEL}
-@kindex 177 @kbd{DEL} (@code{vip-delete-backward-char})
+@kindex 177 @key{DEL} @r{(}@code{vip-delete-backward-char}@r{)}
 Delete a character before point.  Given @var{n}, delete @var{n} characters
 (@code{vip-delete-backward-char}).
 @end table
@@ -1385,7 +1385,7 @@ commands that put back the yanked text into the buffer.
 
 @table @kbd
 @item y @var{motion-command}
-@kindex 1710 @kbd{y} (@code{vip-command-argument})
+@kindex 1710 y @r{(}@code{vip-command-argument}@r{)}
 Yank the region determined by the motion command @var{motion-command}.
 @end table
 @noindent
@@ -1398,14 +1398,14 @@ Use the following command to yank consecutive lines of text.
 @table @kbd
 @item y y
 @itemx Y
-@kindex 131 @kbd{Y} (@code{vip-yank-line})
-@kindex 1712 @kbd{y y} (@code{vip-yank-line})
+@kindex 131 Y @r{(}@code{vip-yank-line}@r{)}
+@kindex 1712 y y @r{(}@code{vip-yank-line}@r{)}
 Yank a line.  Given @var{n}, yank @var{n} lines (@code{vip-yank-line}).
 @item y r
-@kindex 1712 @kbd{y r}
+@kindex 1712 y r
 Yank current region.
 @item y R
-@kindex 1711 @kbd{y R}
+@kindex 1711 y R
 Expand current region and yank it.
 @end table
 
@@ -1416,7 +1416,7 @@ below.
 
 @table @kbd
 @item p
-@kindex 160 @kbd{p} (@code{vip-put-back})
+@kindex 160 p @r{(}@code{vip-put-back}@r{)}
 Insert, after the character point is looking at, most recently
 deleted/yanked text from anonymous register. Given a register name
 argument, the content of the named register will be put back.  Given a
@@ -1424,7 +1424,7 @@ count, the command will be repeated that many times. This command also
 checks if the text to put back ends with a new line character, and if so
 the text will be put below the current line (@code{vip-put-back}).
 @item P
-@kindex 120 @kbd{P} (@code{vip-Put-back})
+@kindex 120 P @r{(}@code{vip-Put-back}@r{)}
 Insert at point most recently deleted/yanked text from anonymous register.
 Given a register name argument, the content of the named register will
 be put back.  Given a count, the command will be repeated that many times.
@@ -1447,7 +1447,7 @@ Most commonly used change command takes the following form.
 
 @table @kbd
 @item c @var{motion-command}
-@kindex 1430 @kbd{c} (@code{vip-command-argument})
+@kindex 1430 c @r{(}@code{vip-command-argument}@r{)}
 Replace the content of the region determined by the motion command
 @var{motion-command} by the text you type.  If the motion command is a
 point command then you will type the text into minibuffer, and if the
@@ -1463,13 +1463,13 @@ command.
 
 @table @kbd
 @item c c
-@kindex 1432 @kbd{c c}
+@kindex 1432 c c
 Change a line.  Given a count, that many lines are changed.
 @item c r
-@kindex 1432 @kbd{c r}
+@kindex 1432 c r
 Change current region.
 @item c R
-@kindex 1431 @kbd{c R}
+@kindex 1431 c R
 Expand current region and change it.
 @end table
 
@@ -1481,13 +1481,13 @@ it.  It is also very easy to undo changes made by modifying commands.
 
 @table @kbd
 @item u
-@kindex 165 @kbd{u} (@code{vip-undo})
+@kindex 165 u @r{(}@code{vip-undo}@r{)}
 Undo the last change.  You can undo more by repeating undo by the repeat
 command @samp{.}.  For example, you can undo 5 previous changes by typing
 @samp{u....}.  If you type @samp{uu}, then the second @samp{u} undoes the
 first undo command (@code{vip-undo}).
 @item .
-@kindex 056 @kbd{.} (@code{vip-repeat})
+@kindex 056 . @r{(}@code{vip-repeat}@r{)}
 Repeat the last modifying command.  Given count @var{n} it becomes the new
 count for the repeated command.  Otherwise, the count for the last
 modifying command is used again (@code{vip-repeat}).
@@ -1500,12 +1500,12 @@ Miscellaneous Vi commands are collected here.
 
 @table @kbd
 @item Z Z
-@kindex 132 @kbd{Z Z} (@code{save-buffers-kill-emacs})
+@kindex 132 Z Z @r{(}@code{save-buffers-kill-emacs}@r{)}
 Exit Emacs.  If modified buffers exist, you will be asked whether you wish
 to save them or not (@code{save-buffers-kill-emacs}).
 @item !@: @var{motion-command} @var{format-command}
 @itemx @var{n} !@: !@: @var{format-command}
-@kindex 041 @kbd{!} (@code{vip-command-argument})
+@kindex 041 ! @r{(}@code{vip-command-argument}@r{)}
 The region determined by the motion command @var{motion-command} will be
 given to the shell command @var{format-command} and the region will be
 replaced by its output.  If a count is given, it will be passed to
@@ -1514,30 +1514,30 @@ between point and the 3rd line.  If @kbd{!} is used instead of
 @var{motion-command} then @var{n} lines will be processed by
 @var{format-command} (@code{vip-command-argument}).
 @item J
-@kindex 112 @kbd{J} (@code{vip-join-lines})
+@kindex 112 J @r{(}@code{vip-join-lines}@r{)}
 Join two lines.  Given count, join that many lines.  A space will be
 inserted at each junction (@code{vip-join-lines}).
 @item < @var{motion-command}
 @itemx @var{n} < <
-@kindex 074 @kbd{<} (@code{vip-command-argument})
+@kindex 074 < @r{(}@code{vip-command-argument}@r{)}
 Shift region determined by the motion command @var{motion-command} to
 left by @var{shift-width} (default is 8).  If @kbd{<} is used instead of
 @var{motion-command} then shift @var{n} lines
 @*(@code{vip-command-argument}).
 @item > @var{motion-command}
 @itemx @var{n} > >
-@kindex 076 @kbd{>} (@code{vip-command-argument})
+@kindex 076 > @r{(}@code{vip-command-argument}@r{)}
 Shift region determined by the motion command @var{motion-command} to
 right by @var{shift-width} (default is 8).  If @kbd{<} is used instead of
 @var{motion-command} then shift @var{n} lines
 @*(@code{vip-command-argument}).
 @item = @var{motion-command}
-@kindex 075 @kbd{=} (@code{vip-command-argument})
+@kindex 075 = @r{(}@code{vip-command-argument}@r{)}
 Indent region determined by the motion command @var{motion-command}.  If
 @kbd{=} is used instead of @var{motion-command} then indent @var{n} lines
 (@code{vip-command-argument}).
 @item *
-@kindex 052 @kbd{*} (@code{vip-call-last-kbd-macro})
+@kindex 052 * @r{(}@code{vip-call-last-kbd-macro}@r{)}
 Call last remembered keyboard macro.
 @item #
 A new vi operator. @xref{New Commands}, for more details.
@@ -1546,14 +1546,14 @@ A new vi operator. @xref{New Commands}, for more details.
 The following keys are reserved for future extensions, and currently
 assigned to a function that just beeps (@code{vip-nil}).
 
-@kindex 046 @kbd{&} (@code{vip-nil})
-@kindex 100 @kbd{@@} (@code{vip-nil})
-@kindex 125 @kbd{U} (@code{vip-nil})
-@kindex 133 @kbd{[} (@code{vip-nil})
-@kindex 135 @kbd{]} (@code{vip-nil})
-@kindex 137 @kbd{_} (@code{vip-nil})
-@kindex 161 @kbd{q} (@code{vip-nil})
-@kindex 176 @kbd{~} (@code{vip-nil})
+@kindex 046 & @r{(}@code{vip-nil}@r{)}
+@kindex 100 @@ @r{(}@code{vip-nil}@r{)}
+@kindex 125 U @r{(}@code{vip-nil}@r{)}
+@kindex 133 [ @r{(}@code{vip-nil}@r{)}
+@kindex 135 ] @r{(}@code{vip-nil}@r{)}
+@kindex 137 _ @r{(}@code{vip-nil}@r{)}
+@kindex 161 q @r{(}@code{vip-nil}@r{)}
+@kindex 176 ~ @r{(}@code{vip-nil}@r{)}
 
 @example
 &, @@, U, [, ], _, q, ~
@@ -1567,48 +1567,48 @@ keymap.  See GNU Emacs Manual for details.
 
 @table @kbd
 @item C-@@
-@kindex 000 @kbd{C-@@} (@code{set-mark-command})
+@kindex 000 C-@@ @r{(}@code{set-mark-command}@r{)}
 Set mark and push previous mark on mark ring (@code{set-mark-command}).
 @item TAB
-@kindex 011 TAB (@code{indent-for-tab-command})
+@kindex 011 @key{TAB} @r{(}@code{indent-for-tab-command}@r{)}
 Indent line for current major mode (@code{indent-for-tab-command}).
 @item C-j
-@kindex 012 @kbd{C-j} (@code{electric-newline-and-maybe-indent})
+@kindex 012 C-j @r{(}@code{electric-newline-and-maybe-indent}@r{)}
 Insert a newline, and maybe indent according to mode.
 @item C-k
-@kindex 013 @kbd{C-k} (@code{kill-line})
+@kindex 013 C-k @r{(}@code{kill-line}@r{)}
 Kill the rest of the current line; before a newline, kill the newline.
 With a numeric argument, kill that many lines from point.  Negative arguments
 kill lines backward (@code{kill-line}).
 @item C-l
-@kindex 014 @kbd{C-l} (@code{recenter})
+@kindex 014 C-l @r{(}@code{recenter}@r{)}
 Clear the screen and reprint everything (@code{recenter}).
 @item @var{n} C-p
-@kindex 020 @kbd{C-p} (@code{previous-line})
+@kindex 020 C-p @r{(}@code{previous-line}@r{)}
 Move cursor vertically up @var{n} lines (@code{previous-line}).
 @item C-q
-@kindex 021 @kbd{C-q} (@code{quoted-insert})
+@kindex 021 C-q @r{(}@code{quoted-insert}@r{)}
 Read next input character and insert it.  Useful for inserting control
 characters
 @*(@code{quoted-insert}).
 @item C-r
-@kindex 022 @kbd{C-r} (@code{isearch-backward})
+@kindex 022 C-r @r{(}@code{isearch-backward}@r{)}
 Search backward incrementally (@code{isearch-backward}).
 @item C-s
-@kindex 023 @kbd{C-s} (@code{isearch-forward})
+@kindex 023 C-s @r{(}@code{isearch-forward}@r{)}
 Search forward incrementally (@code{isearch-forward}).
 @item @var{n} C-t
-@kindex 024 @kbd{C-t} (@code{transpose-chars})
+@kindex 024 C-t @r{(}@code{transpose-chars}@r{)}
 Interchange characters around point, moving forward one character.  With
 count @var{n}, take character before point and drag it forward past @var{n}
 other characters.  If no argument and at end of line, the previous two
 characters are exchanged (@code{transpose-chars}).
 @item @var{n} C-v
-@kindex 026 @kbd{C-v} (@code{scroll-up})
+@kindex 026 C-v @r{(}@code{scroll-up}@r{)}
 Scroll text upward @var{n} lines.  If @var{n} is not given, scroll near
 full screen (@code{scroll-up}).
 @item C-w
-@kindex 027 @kbd{C-w} (@code{kill-region})
+@kindex 027 C-w @r{(}@code{kill-region}@r{)}
 Kill between point and mark.  The text is save in the kill ring.  The
 command @kbd{P} or @kbd{p} can retrieve it from kill ring
 (@code{kill-region}).
@@ -1624,29 +1624,29 @@ and you can repeat them by the repeat command @kbd{.} (@code{vip-repeat}).
 
 @table @kbd
 @item i
-@kindex 151 @kbd{i} (@code{vip-insert})
+@kindex 151 i @r{(}@code{vip-insert}@r{)}
 Enter insert mode at point (@code{vip-insert}).
 @item I
-@kindex 111 @kbd{I} (@code{vip-Insert})
+@kindex 111 I @r{(}@code{vip-Insert}@r{)}
 Enter insert mode at the first non white character on the line
 (@code{vip-Insert}).
 @item a
-@kindex 141 @kbd{a} (@code{vip-append})
+@kindex 141 a @r{(}@code{vip-append}@r{)}
 Move point forward by one character and then enter insert mode
 (@code{vip-append}).
 @item A
-@kindex 101 @kbd{A} (@code{vip-Append})
+@kindex 101 A @r{(}@code{vip-Append}@r{)}
 Enter insert mode at end of line (@code{vip-Append}).
 @item o
-@kindex 157 @kbd{o} (@code{vip-open-line})
+@kindex 157 o @r{(}@code{vip-open-line}@r{)}
 Open a new line below the current line and enter insert mode
 (@code{vip-open-line}).
 @item O
-@kindex 117 @kbd{O} (@code{vip-Open-line})
+@kindex 117 O @r{(}@code{vip-Open-line}@r{)}
 Open a new line above the current line and enter insert mode
 (@code{vip-Open-line}).
 @item C-o
-@kindex 017 @kbd{C-o} (@code{vip-open-line-at-point})
+@kindex 017 C-o @r{(}@code{vip-open-line-at-point}@r{)}
 Insert a newline and leave point before it, and then enter insert mode
 @*(@code{vip-open-line-at-point}).
 @end table
@@ -1656,16 +1656,16 @@ differently from emacs mode.
 
 @table @kbd
 @item @key{ESC}
-@kindex 033 @kbd{ESC} (@code{vip-change-mode-to-vi}) (insert mode)
+@kindex 033 @key{ESC} @r{(}@code{vip-change-mode-to-vi}@r{) (insert mode)}
 This key will take you back to vi mode (@code{vip-change-mode-to-vi}).
 @item C-h
-@kindex 010 @kbd{C-h} (@code{delete-backward-char}) (insert mode)
+@kindex 010 C-h @r{(}@code{delete-backward-char}@r{) (insert mode)}
 Delete previous character (@code{delete-backward-char}).
 @item C-w
-@kindex 027 @kbd{C-w} (@code{vip-delete-backward-word}) (insert mode)
+@kindex 027 C-w @r{(}@code{vip-delete-backward-word}@r{) (insert mode)}
 Delete previous word (@code{vip-delete-backward-word}).
 @item C-z
-@kindex 032 @kbd{C-z} (@code{vip-ESC}) (insert mode)
+@kindex 032 C-z @r{(}@code{vip-ESC}@r{) (insert mode)}
 This key simulates @key{ESC} key in emacs mode.  For instance, typing
 @kbd{C-z x} in insert mode is the same as typing @kbd{ESC x} in emacs mode
 (@code{vip-ESC}).
@@ -1685,7 +1685,7 @@ commands while in insert mode.
 @node Ex Commands
 @chapter Ex Commands
 
-@kindex 072 @kbd{:} (@code{vip-ex})
+@kindex 072 : @r{(}@code{vip-ex}@r{)}
 
 In vi mode, you can execute an Ex command @var{ex-command} by typing:
 @example
diff --git a/doc/misc/viper.texi b/doc/misc/viper.texi
index 8948437632..366d576da2 100644
--- a/doc/misc/viper.texi
+++ b/doc/misc/viper.texi
@@ -368,9 +368,9 @@ toggles Viperization of Emacs on and off.
 @node States in Viper
 @section States in Viper
 
-@kindex @kbd{C-z}
+@kindex C-z
 @kindex @key{ESC}
-@kindex @kbd{i}
+@kindex i
 @cindex Emacs state
 @cindex Vi state
 @cindex Insert state
@@ -474,7 +474,7 @@ to allow Emacs keys in Insert state.
 @node Emacs State
 @subsection Emacs State
 
-@kindex @kbd{C-z}
+@kindex C-z
 @cindex Emacs state
 
 
@@ -514,7 +514,7 @@ exceptions are:
 
 @table @kbd
 @item C-x
-@kindex @kbd{C-x}
+@kindex C-x
 @kbd{C-x} is used to invoke Emacs commands, mainly those that do window
 management.  @kbd{C-x 2} will split a window, @kbd{C-x 0} will close a
 window.  @kbd{C-x 1} will close all other windows.  @kbd{C-xb} is used to
@@ -523,14 +523,14 @@ These are about the only necessary keystrokes.
 For the rest, see the GNU Emacs Manual.
 
 @item C-c
-@kindex @kbd{C-c}
+@kindex C-c
 For user levels 2 and higher, this key serves as a prefix key for the key
 sequences used by various major modes.  For users at Viper level 1, @kbd{C-c}
 simply beeps.
 
 @item C-g and C-]
-@kindex @kbd{C-g}
-@kindex @kbd{C-]}
+@kindex C-g
+@kindex C-]
 
 These are the Emacs @samp{quit} keys.
 There will be cases where you will have to
@@ -543,7 +543,7 @@ Edit,Recursive Edit,emacs,The GNU Emacs Manual}.
 At user level 1, @kbd{C-g} is bound to @code{viper-info-on-file}
 function instead.
 @item C-\
-@kindex @kbd{C-\}
+@kindex C-\
 @cindex Meta key
 
 Viper uses @key{ESC} as a switch between Insert and Vi states.  Emacs uses
@@ -569,7 +569,7 @@ about are:
 
 @table @samp
 @item Undo
-@kindex @kbd{u}
+@kindex u
 @kbd{u} will undo.  Undo can be repeated by the @kbd{.} key.  Undo itself
 can be undone.  Another @kbd{u} will change the direction.  The presence
 of repeatable undo means that @kbd{U}, undoing lines, is not very
@@ -599,7 +599,7 @@ to case-insensitive and back.
 @cindex vanilla search
 @cindex case-sensitive search
 @cindex case-insensitive search
-@kindex @kbd{C-c /}
+@kindex C-c /
 
 @item Ex commands
 @cindex Ex commands
@@ -1302,8 +1302,8 @@ These commands have no Vi analogs.
 
 @table @kbd
 @item C-x, C-c
-@kindex @kbd{C-x}
-@kindex @kbd{C-c}
+@kindex C-x
+@kindex C-c
 These two keys invoke many important Emacs functions.  For example, if you
 hit @kbd{C-x} followed by @kbd{2}, then the current window will be split
 into 2.  Except for novice users, @kbd{C-c} is also set to execute an Emacs
@@ -1313,11 +1313,11 @@ configure @key{ESC} as Meta by setting @code{viper-no-multiple-ESC} to
 @kbd{C-\} in Insert, Replace, or Vi states will make Emacs think
 @kbd{Meta} has been hit.
 @item \
-@kindex @kbd{\}
+@kindex \
 Escape to Emacs to execute a single Emacs command.  For instance,
 @kbd{\ @key{ESC}} will act like a Meta key.
 @item Q
-@kindex @kbd{Q}
+@kindex Q
 @cindex query replace
 @kbd{Q} is for query replace.  By default,
 each string to be replaced is treated as a regular expression.  You can use
@@ -1327,16 +1327,16 @@ that @kbd{:se nomagic} turns Regexps off completely, unlike Vi).
 @item v
 @itemx V
 @itemx C-v
-@kindex @kbd{v}
-@kindex @kbd{V}
-@kindex @kbd{C-v}
+@kindex v
+@kindex V
+@kindex C-v
 These keys are used to visit files.  @kbd{v} will switch to a buffer
 visiting file whose name can be entered in the minibuffer.  @kbd{V} is
 similar, but will use a window different from the current window.
 @kbd{C-v} is like @kbd{V}, except that a new frame (X window) will be used
 instead of a new Emacs window.
 @item #
-@kindex @kbd{#}
+@kindex #
 If followed by a certain character @var{ch}, it becomes an operator whose
 argument is the region determined by the motion command that follows
 (indicated as <move>).
@@ -1344,34 +1344,34 @@ Currently, @var{ch} can be one of @kbd{c}, @kbd{C}, @kbd{g}, @kbd{q}, and
 @kbd{s}.  For instance, @kbd{#qr} will prompt you for a string and then
 prepend this string to each line in the buffer.
 @item # c
-@kindex @kbd{#c<move>}
+@kindex #c<move>
 @cindex changing case
 Change upper-case characters in the region to lower-case
 (@code{downcase-region}).
 Emacs command @kbd{M-l} does the same for words.
 @item # C
-@kindex @kbd{#C<move>}
+@kindex #C<move>
 Change lower-case characters in the region to upper-case.  For instance,
 @kbd{# C 3 w} will capitalize 3 words from the current point
 (@code{upcase-region}).
 Emacs command @kbd{M-u} does the same for words.
 @item # g
-@kindex @kbd{#g<move>}
+@kindex #g<move>
 Execute last keyboard macro for each line in the region
 (@code{viper-global-execute}).
 @item # q
-@kindex @kbd{#q<move>}
+@kindex #q<move>
 Insert specified string at the beginning of each line in the region
 (@code{viper-quote-region}).  The default string is composed of the comment
 character(s) appropriate for the current major mode.
 @item # s
-@kindex @kbd{#s<move>}
+@kindex #s<move>
 Check spelling of words in the region (@code{spell-region}).
 The function used for spelling is determined from the variable
 @code{viper-spell-function}.
 @vindex viper-spell-function
 @item *
-@kindex @kbd{*}
+@kindex *
 Call last keyboard macro.
 @item m .
 Set mark at point and push old mark off the ring
@@ -1382,41 +1382,41 @@ Set mark at beginning and end of buffer, respectively.
 Jump to mark and pop mark off the ring.  @xref{Mark,,Mark,emacs,The GNU
 Emacs Manual}, for more info.
 @item ] register
-@kindex @kbd{]<a-z>}
+@kindex ]<a-z>
 View contents of register
 @item [ textmarker
-@kindex @kbd{[<a-z>}
+@kindex [<a-z>
 View filename and position of textmarker
 @item @@#
 @item @@register
 @item @@!
-@kindex @kbd{@@#}
-@kindex @kbd{@@<a-z>}
-@kindex @kbd{@@!}
+@kindex @@#
+@kindex @@<a-z>
+@kindex @@!
 @cindex keyboard macros
 @cindex register execution
 
 Begin/end keyboard macro.  @@register has a different meaning when used after
 a @kbd{@@#}.  @xref{Macros and Registers}, for details
 @item []
-@kindex @kbd{[]}
+@kindex []
 Go to end of heading.
 @item g <@emph{movement command}>
 Search buffer for text delimited by movement command.  The canonical
 example is @kbd{gw} to search for the word under the cursor.
 @xref{Improved Search}, for details.
 @item C-g and C-]
-@kindex @kbd{C-g}
-@kindex @kbd{C-]}
+@kindex C-g
+@kindex C-]
 Quit and Abort Recursive edit.  These may be necessary on occasion.
 @xref{Vi State}, for a reason.
 @item C-c C-g
-@kindex @kbd{C-c C-g}
+@kindex C-c C-g
 Hitting @kbd{C-c} followed by @kbd{C-g} will display the information on the
 current buffer.  This is the same as hitting @kbd{C-g} in Vi, but, as
 explained above, @kbd{C-g} is needed for other purposes in Emacs.
 @item C-c /
-@kindex @kbd{C-c /}
+@kindex C-c /
 Without a prefix argument, this command toggles
 case-sensitive/case-insensitive search modes and plain vanilla/regular
 expression search.  With the prefix argument 1, i.e.,
@@ -1429,21 +1429,21 @@ this function.
 @cindex case-insensitive search
 
 @item M-p and M-n
-@kindex @kbd{M-p}
-@kindex @kbd{M-n}
+@kindex M-p
+@kindex M-n
 In the minibuffer, these commands navigate through the minibuffer
 histories, such as the history of search strings, Ex commands, etc.
 
 @item C-s
-@kindex @kbd{C-s}
+@kindex C-s
 If the minibuffer is entered via a Viper search commands @kbd{/} or @kbd{?},
 then typing this key inserts the last search string used by the
 Emacs incremental search command (that is bound to @kbd{C-s} everywhere
 except in this case).
 
 @item C-c M-p and C-c M-n
-@kindex @kbd{C-c M-p}
-@kindex @kbd{C-c M-n}
+@kindex C-c M-p
+@kindex C-c M-n
 @cindex Insertion history
 @cindex Insertion ring
 @cindex Command history
@@ -2669,10 +2669,10 @@ purpose of mouse search and mouse insert.  By default, this is set to
 @code{double-click-time} in Emacs and to
 @code{mouse-track-multi-click-time} milliseconds in XEmacs.
 @end table
-@kindex @kbd{S-mouse-1}
-@kindex @kbd{S-mouse-2}
-@kindex @kbd{meta shift button1up}
-@kindex @kbd{meta shift button2up}
+@kindex S-mouse-1
+@kindex S-mouse-2
+@kindex @key{META} @key{SHIFT} button1up
+@kindex @key{META} @key{SHIFT} button2up
 @vindex viper-multiclick-timeout
 @findex viper-mouse-click-insert-word
 @findex viper-mouse-click-search-word
@@ -3383,60 +3383,60 @@ don't want this macro, put
 in your Viper customization file.
 
 @end table
-@kindex @kbd{%}
-@kindex @kbd{C-c /}
-@kindex @kbd{N}
-@kindex @kbd{n}
-@kindex @kbd{?<cr>}
-@kindex @kbd{/<cr>}
-@kindex @kbd{?<string>}
-@kindex @kbd{/<string>}
-@kindex @kbd{''}
-@kindex @kbd{``}
-@kindex @kbd{]<a-z>}
-@kindex @kbd{[<a-z>}
-@kindex @kbd{'<a-z>}
-@kindex @kbd{`<a-z>}
-@kindex @kbd{m<a-z>}
-@kindex @kbd{[]}
-@kindex @kbd{[[}
-@kindex @kbd{]]}
-@kindex @kbd{@{}
-@kindex @kbd{@}}
-@kindex @kbd{(}
-@kindex @kbd{)}
-@kindex @kbd{M}
-@kindex @kbd{L}
-@kindex @kbd{H}
-@kindex @kbd{G}
-@kindex @kbd{E}
-@kindex @kbd{e}
-@kindex @kbd{B}
-@kindex @kbd{b}
-@kindex @kbd{W}
-@kindex @kbd{w}
-@kindex @kbd{,}
-@kindex @kbd{;}
-@kindex @kbd{T<char>}
-@kindex @kbd{F<char>}
-@kindex @kbd{t<char>}
-@kindex @kbd{f<char>}
-@kindex @kbd{|}
-@kindex @kbd{0}
-@kindex @kbd{<cr>}
-@kindex @kbd{+}
-@kindex @kbd{-}
-@kindex @kbd{^}
-@kindex @kbd{$}
-@kindex @kbd{C-p}
-@kindex @kbd{<lf>}
-@kindex @kbd{<sp>}
-@kindex @kbd{C-n}
-@kindex @kbd{C-h}
-@kindex @kbd{h}
-@kindex @kbd{j}
-@kindex @kbd{k}
-@kindex @kbd{l}
+@kindex %
+@kindex C-c /
+@kindex N
+@kindex n
+@kindex ?<cr>
+@kindex /<cr>
+@kindex ?<string>
+@kindex /<string>
+@kindex ''
+@kindex ``
+@kindex ]<a-z>
+@kindex [<a-z>
+@kindex '<a-z>
+@kindex `<a-z>
+@kindex m<a-z>
+@kindex []
+@kindex [[
+@kindex ]]
+@kindex @{
+@kindex @}
+@kindex (
+@kindex )
+@kindex M
+@kindex L
+@kindex H
+@kindex G
+@kindex E
+@kindex e
+@kindex B
+@kindex b
+@kindex W
+@kindex w
+@kindex ,
+@kindex ;
+@kindex T<char>
+@kindex F<char>
+@kindex t<char>
+@kindex f<char>
+@kindex |
+@kindex 0
+@kindex @key{CR}
+@kindex +
+@kindex -
+@kindex ^
+@kindex $
+@kindex C-p
+@kindex @key{LF}
+@kindex @key{SPC}
+@kindex C-n
+@kindex C-h
+@kindex h
+@kindex j
+@kindex k
+@kindex l
 @vindex viper-parse-sexp-ignore-comments
 
 @node Marking
@@ -3478,18 +3478,18 @@ Go to specified Viper mark.
 @item `<a-z>
 Go to specified Viper mark and go to the first CHAR on line.
 @end table
-@kindex @kbd{m<a-z>}
-@kindex @kbd{m.}
-@kindex @kbd{m>}
-@kindex @kbd{m<}
-@kindex @kbd{m,}
-@kindex @kbd{m^}
+@kindex m<a-z>
+@kindex m.
+@kindex m>
+@kindex m<
+@kindex m,
+@kindex m^
 @findex @kbd{Ex mark}
 @findex @kbd{Ex k}
-@kindex @kbd{''}
-@kindex @kbd{``}
-@kindex @kbd{`<a-z>}
-@kindex @kbd{'<a-z>}
+@kindex ''
+@kindex ``
+@kindex `<a-z>
+@kindex '<a-z>
 
 @node  Appending Text
 @subsection Appending Text
@@ -3556,22 +3556,22 @@ Since typing the above sequences of keys may be tedious, the
 functions doing the perusing can be bound to unused keyboard keys in the
 Viper customization file.  @xref{Viper Specials}, for details.
 @end table
-@kindex @kbd{C-c M-p}
-@kindex @kbd{C-c M-n}
-@kindex @kbd{.}
-@kindex @kbd{]<a-z>}
-@kindex @kbd{[<a-z>}
-@kindex @kbd{P}
-@kindex @kbd{p}
-@kindex @kbd{"<a-z1-9>p}
-@kindex @kbd{"<a-z1-9>P}
-@kindex @kbd{>>}
-@kindex @kbd{><move>}
-@kindex @kbd{O}
-@kindex @kbd{o}
-@kindex @kbd{i}
-@kindex @kbd{A}
-@kindex @kbd{a}
+@kindex C-c M-p
+@kindex C-c M-n
+@kindex .
+@kindex ]<a-z>
+@kindex [<a-z>
+@kindex P
+@kindex p
+@kindex "<a-z1-9>p
+@kindex "<a-z1-9>P
+@kindex >>
+@kindex ><move>
+@kindex O
+@kindex o
+@kindex i
+@kindex A
+@kindex a
 
 @node Editing in Insert State
 @subsection Editing in Insert State
@@ -3595,9 +3595,9 @@ Back to the begin of the change on the
 current line.
 
 @end table
-@kindex @kbd{C-u}
-@kindex @kbd{C-w}
-@kindex @kbd{C-v}
+@kindex C-u
+@kindex C-w
+@kindex C-v
 
 @node Deleting Text
 @subsection Deleting Text
@@ -3634,13 +3634,13 @@ shiftwidth to the left (layout!).
 @item <count>  <<
 Shift <count> lines one shiftwidth to the left.
 @end table
-@kindex @kbd{<<}
-@kindex @kbd{<<move>}
-@kindex @kbd{D}
-@kindex @kbd{dd}
-@kindex @kbd{d<move>}
-@kindex @kbd{X}
-@kindex @kbd{x}
+@kindex <<
+@kindex <<move>
+@kindex D
+@kindex dd
+@kindex d<move>
+@kindex X
+@kindex x
 
 @node Changing Text
 @subsection Changing Text
@@ -3727,28 +3727,28 @@ In Vi state, these keys are bound to functions that peruse the history of
 destructive Vi commands.
 @xref{Viper Specials}, for details.
 @end table
-@kindex @kbd{C-c M-p}
-@kindex @kbd{C-c M-n}
-@kindex @kbd{#q<move> }
-@kindex @kbd{#C<move>}
-@kindex @kbd{#c<move>}
-@kindex @kbd{&}
-@kindex @kbd{\&}
+@kindex C-c M-p
+@kindex C-c M-n
+@kindex #q<move>
+@kindex #C<move>
+@kindex #c<move>
+@kindex &
+@kindex \&
 @findex @kbd{Ex substitute/<pat>/<repl>/<f>}
 @findex @kbd{Ex s/<pat>/<repl>/<f>}
 @findex @kbd{Ex copy [z]}
 @findex @kbd{Ex t [z]}
 @findex @kbd{Ex move [z]}
-@kindex @kbd{J}
-@kindex @kbd{~}
-@kindex @kbd{=<move>}
-@kindex @kbd{C}
-@kindex @kbd{cc}
-@kindex @kbd{c<move>}
-@kindex @kbd{S}
-@kindex @kbd{s}
-@kindex @kbd{R}
-@kindex @kbd{r<char>}
+@kindex J
+@kindex ~
+@kindex =<move>
+@kindex C
+@kindex cc
+@kindex c<move>
+@kindex S
+@kindex s
+@kindex R
+@kindex r<char>
 
 @node Search and Replace
 @subsection Search and Replace
@@ -3817,21 +3817,21 @@ Execute <ex-command> on all lines that match <pattern>.
 @itemx :v /<pattern>/<ex-command>
 Execute <ex-command> on all lines that do not match <pattern>.
 @end table
-@kindex @kbd{&}
+@kindex &
 @findex @kbd{Ex substitute/<pat>/<repl>/<f>}
-@kindex @kbd{Q}
-@kindex @kbd{#g<move>}
+@kindex Q
+@kindex #g<move>
 @findex @kbd{Ex v}
 @findex @kbd{Ex g}
 @findex @kbd{Ex global}
 @findex @kbd{Ex vglobal}
 @findex @kbd{Ex tag <name>}
-@kindex @kbd{%}
-@kindex @kbd{N}
-@kindex @kbd{n}
-@kindex @kbd{g<move>}
-@kindex @kbd{?<string>}
-@kindex @kbd{/<string>}
+@kindex %
+@kindex N
+@kindex n
+@kindex g<move>
+@kindex ?<string>
+@kindex /<string>
 
 @node Yanking
 @subsection Yanking
@@ -3865,19 +3865,19 @@ be automatically down-cased.
 Put the contents of the (default undo) buffer
 <count> times before the cursor.  The register will
 @end table
-@kindex @kbd{P}
-@kindex @kbd{p}
-@kindex @kbd{"<a-z1-9>p}
-@kindex @kbd{"<a-z1-9>P}
-@kindex @kbd{]<a-z>}
-@kindex @kbd{[<a-z>}
-@kindex @kbd{m<a-z>}
-@kindex @kbd{Y}
-@kindex @kbd{yy}
-@kindex @kbd{"<A-Z>y<move>}
-@kindex @kbd{"<a-z>y<move>}
-@kindex @kbd{y<move>}
-@kindex @kbd{yank}
+@kindex P
+@kindex p
+@kindex "<a-z1-9>p
+@kindex "<a-z1-9>P
+@kindex ]<a-z>
+@kindex [<a-z>
+@kindex m<a-z>
+@kindex Y
+@kindex yy
+@kindex "<A-Z>y<move>
+@kindex "<a-z>y<move>
+@kindex y<move>
+@kindex yank
 @findex @kbd{Ex yank}
 
 @node Undoing
@@ -3902,9 +3902,9 @@ that have a @samp{~} appended to them.
 @findex @kbd{Ex rec}
 @findex @kbd{Ex e!}
 @findex @kbd{Ex q!}
-@kindex @kbd{.}
-@kindex @kbd{U}
-@kindex @kbd{u}
+@kindex .
+@kindex U
+@kindex u
 
 @node Display
 @section Display
@@ -3948,21 +3948,21 @@ Put line <count> at the bottom of the window
 Put line <count> in the center of the window
 (default the current line).
 @end table
-@kindex @kbd{zM}
-@kindex @kbd{zL}
-@kindex @kbd{zH}
-@kindex @kbd{z<cr>}
-@kindex @kbd{z.}
-@kindex @kbd{z-}
-@kindex @kbd{z<cr>}
-@kindex @kbd{C-b}
-@kindex @kbd{C-f}
-@kindex @kbd{C-u}
-@kindex @kbd{C-d}
-@kindex @kbd{C-y}
-@kindex @kbd{C-e}
-@kindex @kbd{C-l}
-@kindex @kbd{C-g}
+@kindex zM
+@kindex zL
+@kindex zH
+@kindex z<cr>
+@kindex z.
+@kindex z-
+@kindex z<cr>
+@kindex C-b
+@kindex C-f
+@kindex C-u
+@kindex C-d
+@kindex C-y
+@kindex C-e
+@kindex C-l
+@kindex C-g
 
 
 @node File and Buffer Handling
@@ -4078,11 +4078,11 @@ Read the file <name> into the buffer after the line <address>.
 Edit a file in current or another window, or in another frame.  File name
 is typed in minibuffer.  File completion and history are supported.
 @end table
-@kindex @kbd{v}
-@kindex @kbd{V}
+@kindex v
+@kindex V
 @findex @kbd{Ex args}
 @findex @kbd{Ex rew}
-@kindex @kbd{C-^}
+@kindex C-^
 @findex @kbd{Ex e!@: [<files>]}
 @findex @kbd{Ex e [<files>]}
 @findex @kbd{Ex edit [<files>]}
@@ -4096,7 +4096,7 @@ is typed in minibuffer.  File completion and history are supported.
 @findex @kbd{Ex r}
 @findex @kbd{Ex read}
 @findex @kbd{Ex pre}
-@kindex @kbd{ZZ}
+@kindex ZZ
 @findex @kbd{Ex wq}
 @findex @kbd{Ex w <file>}
 @findex @kbd{Ex w!@: <file>}
@@ -4171,14 +4171,14 @@ Show contents of textmarker.
 @item ]<a-z>
 Show contents of register.
 @end table
-@kindex @kbd{]<a-z>}
-@kindex @kbd{[<a-z>}
-@kindex @kbd{#g<move>}
-@kindex @kbd{*}
-@kindex @kbd{@@!<a-z>}
-@kindex @kbd{@@#}
-@kindex @kbd{@@@@}
-@kindex @kbd{@@<a-z>}
+@kindex ]<a-z>
+@kindex [<a-z>
+@kindex #g<move>
+@kindex *
+@kindex @@!<a-z>
+@kindex @@#
+@kindex @@@@
+@kindex @@<a-z>
 @findex @kbd{Ex unmap <char>}
 @findex @kbd{Ex map <char> <seq>}
 @findex @kbd{Ex unmap!@: <char>}
@@ -4410,16 +4410,16 @@ Undoes the last @kbd{C-y} and puts another kill from the kill ring.
 Using this command, you can try may different kills until you find the one
 you need.
 @end table
-@kindex @kbd{M-y}
-@kindex @kbd{C-y}
-@kindex @kbd{C-xC-f}
-@kindex @kbd{C-xo}
-@kindex @kbd{C-x2}
-@kindex @kbd{C-x1}
-@kindex @kbd{C-x0}
-@kindex @kbd{C-z}
-@kindex @kbd{C-\}
-@kindex @kbd{C-c\}
+@kindex M-y
+@kindex C-y
+@kindex C-x C-f
+@kindex C-x o
+@kindex C-x 2
+@kindex C-x 1
+@kindex C-x 0
+@kindex C-z
+@kindex C-\
+@kindex C-c\
 
 @node Mouse-bound Commands
 @section Mouse-bound Commands
@@ -4445,10 +4445,10 @@ Note: Viper sets this binding only if this mouse action is not
 already bound to something else.
 @xref{Viper Specials}, for more details.
 @end table
-@kindex @kbd{S-mouse-1}
-@kindex @kbd{S-mouse-2}
-@kindex @kbd{meta button1up}
-@kindex @kbd{meta button2up}
+@kindex S-mouse-1
+@kindex S-mouse-2
+@kindex @key{META} button1up
+@kindex @key{META} button2up
 
 @node GNU Free Documentation License
 @appendix GNU Free Documentation License
diff --git a/doc/misc/woman.texi b/doc/misc/woman.texi
index f697243cd9..7ab7905b1b 100644
--- a/doc/misc/woman.texi
+++ b/doc/misc/woman.texi
@@ -625,14 +625,14 @@ the @code{man} key bindings.
 
 @table @kbd
 @item @key{SPC}
-@kindex SPC
+@kindex @key{SPC}
 @findex scroll-up
 Scroll the man page up the window (@code{scroll-up}).
 
 @item @key{DEL}
 @itemx @kbd{S-@key{SPC}}
-@kindex DEL
-@kindex S-SPC
+@kindex @key{DEL}
+@kindex S-@key{SPC}
 @findex scroll-down
 Scroll the man page down the window (@code{scroll-down}).
 
@@ -690,7 +690,7 @@ word must be mouse-highlighted unless @code{woman-mouse-2} is used with
 the Meta key.
 
 @item @key{RET}
-@kindex RET
+@kindex @key{RET}
 @findex man-follow
 Get the man page for the topic under (or nearest to) point
 (@code{man-follow}).
-- 
2.21.0


From 123703cd19366e6ceec4a58e48c39c1681296bf2 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Sun, 25 Feb 2018 17:52:15 +0200
Subject: [PATCH 032/297] * doc/emacs/display.texi (Standard Faces): Fix markup
 of index entry.

---
 doc/emacs/display.texi | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/doc/emacs/display.texi b/doc/emacs/display.texi
index e86c3e8fc9..fdd18896f2 100644
--- a/doc/emacs/display.texi
+++ b/doc/emacs/display.texi
@@ -765,7 +765,7 @@ This face determines the color of tool bar icons.  @xref{Tool Bars}.
 This face determines the colors and font of Emacs's menus.  @xref{Menu
 Bars}.
 @item tty-menu-enabled-face
-@cindex faces for @code{text-mode} menus
+@cindex faces for text-mode menus
 @cindex TTY menu faces
 This face is used to display enabled menu items on text-mode
 terminals.
-- 
2.21.0


From 540fd6547bbbbce4d985086cc95556541d31856a Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Mon, 26 Feb 2018 09:24:39 +0100
Subject: [PATCH 033/297] Remove @key{} markups from @kindex entries in manuals

* doc/emacs/basic.texi:
* doc/emacs/buffers.texi:
* doc/emacs/building.texi:
* doc/emacs/calendar.texi:
* doc/emacs/custom.texi:
* doc/emacs/dired.texi:
* doc/emacs/display.texi:
* doc/emacs/files.texi:
* doc/emacs/frames.texi:
* doc/emacs/help.texi:
* doc/emacs/indent.texi:
* doc/emacs/killing.texi:
* doc/emacs/kmacro.texi:
* doc/emacs/mark.texi:
* doc/emacs/mini.texi:
* doc/emacs/misc.texi:
* doc/emacs/modes.texi:
* doc/emacs/msdos-xtra.texi:
* doc/emacs/msdos.texi:
* doc/emacs/mule.texi:
* doc/emacs/picture-xtra.texi:
* doc/emacs/programs.texi:
* doc/emacs/regs.texi:
* doc/emacs/rmail.texi:
* doc/emacs/screen.texi:
* doc/emacs/search.texi:
* doc/emacs/sending.texi:
* doc/emacs/text.texi:
* doc/emacs/trouble.texi:
* doc/misc/calc.texi:
* doc/misc/cc-mode.texi:
* doc/misc/ediff.texi:
* doc/misc/ert.texi:
* doc/misc/eww.texi:
* doc/misc/forms.texi:
* doc/misc/gnus.texi:
* doc/misc/idlwave.texi:
* doc/misc/info.texi:
* doc/misc/message.texi:
* doc/misc/mh-e.texi:
* doc/misc/newsticker.texi:
* doc/misc/org.texi:
* doc/misc/pcl-cvs.texi:
* doc/misc/rcirc.texi:
* doc/misc/reftex.texi:
* doc/misc/sc.texi:
* doc/misc/sieve.texi:
* doc/misc/vhdl-mode.texi:
* doc/misc/vip.texi:
* doc/misc/viper.texi:
* doc/misc/woman.texi: Remove @key{} markups from @kindex entries.
---
 doc/emacs/basic.texi        | 26 +++++-----
 doc/emacs/buffers.texi      | 10 ++--
 doc/emacs/building.texi     | 10 ++--
 doc/emacs/calendar.texi     |  2 +-
 doc/emacs/custom.texi       |  6 +--
 doc/emacs/dired.texi        | 10 ++--
 doc/emacs/display.texi      | 12 ++---
 doc/emacs/files.texi        |  2 +-
 doc/emacs/frames.texi       |  4 +-
 doc/emacs/help.texi         |  8 +--
 doc/emacs/indent.texi       |  4 +-
 doc/emacs/killing.texi      |  2 +-
 doc/emacs/kmacro.texi       |  8 +--
 doc/emacs/mark.texi         | 10 ++--
 doc/emacs/mini.texi         | 14 +++---
 doc/emacs/misc.texi         | 20 ++++----
 doc/emacs/modes.texi        |  6 +--
 doc/emacs/msdos.texi        |  4 +-
 doc/emacs/mule.texi         | 26 +++++-----
 doc/emacs/picture-xtra.texi |  4 +-
 doc/emacs/programs.texi     | 20 ++++----
 doc/emacs/regs.texi         |  2 +-
 doc/emacs/rmail.texi        |  6 +--
 doc/emacs/screen.texi       |  2 +-
 doc/emacs/search.texi       | 14 +++---
 doc/emacs/sending.texi      |  2 +-
 doc/emacs/text.texi         | 40 +++++++--------
 doc/emacs/trouble.texi      |  2 +-
 doc/misc/calc.texi          | 24 ++++-----
 doc/misc/cc-mode.texi       | 22 ++++-----
 doc/misc/ediff.texi         |  4 +-
 doc/misc/ert.texi           |  4 +-
 doc/misc/eww.texi           |  2 +-
 doc/misc/forms.texi         | 18 +++----
 doc/misc/gnus.texi          | 64 ++++++++++++------------
 doc/misc/idlwave.texi       |  4 +-
 doc/misc/info.texi          | 10 ++--
 doc/misc/message.texi       |  4 +-
 doc/misc/mh-e.texi          | 98 ++++++++++++++++++-------------------
 doc/misc/newsticker.texi    |  8 +--
 doc/misc/org.texi           | 80 +++++++++++++++---------------
 doc/misc/pcl-cvs.texi       |  6 +--
 doc/misc/rcirc.texi         | 10 ++--
 doc/misc/reftex.texi        |  2 +-
 doc/misc/sc.texi            |  2 +-
 doc/misc/sieve.texi         |  4 +-
 doc/misc/vhdl-mode.texi     | 12 ++---
 doc/misc/vip.texi           | 24 ++++-----
 doc/misc/viper.texi         | 16 +++---
 doc/misc/woman.texi         |  8 +--
 50 files changed, 351 insertions(+), 351 deletions(-)

diff --git a/doc/emacs/basic.texi b/doc/emacs/basic.texi
index cc689af6d2..b9e0ce4404 100644
--- a/doc/emacs/basic.texi
+++ b/doc/emacs/basic.texi
@@ -40,7 +40,7 @@ adds the character to the buffer at point.  Insertion moves point
 forward, so that point remains just after the inserted text.
 @xref{Point}.
 
-@kindex @key{RET}
+@kindex RET
 @kindex C-j
 @cindex newline
 @c @findex electric-indent-just-newline
@@ -182,7 +182,7 @@ keyboard commands that move point in more sophisticated ways.
 Move forward one character (@code{forward-char}).
 
 @item @key{RIGHT}
-@kindex @key{RIGHT}
+@kindex RIGHT
 @findex right-char
 This command (@code{right-char}) behaves like @kbd{C-f}, except when
 point is in a right-to-left paragraph (@pxref{Bidirectional Editing}).
@@ -193,7 +193,7 @@ point is in a right-to-left paragraph (@pxref{Bidirectional Editing}).
 Move backward one character (@code{backward-char}).
 
 @item @key{LEFT}
-@kindex @key{LEFT}
+@kindex LEFT
 @findex left-char
 This command (@code{left-char}) behaves like @kbd{C-b}, except if the
 current paragraph is right-to-left (@pxref{Bidirectional Editing}).
@@ -201,7 +201,7 @@ current paragraph is right-to-left (@pxref{Bidirectional Editing}).
 @item C-n
 @itemx @key{DOWN}
 @kindex C-n
-@kindex @key{DOWN}
+@kindex DOWN
 @findex next-line
 Move down one screen line (@code{next-line}).  This command attempts
 to keep the horizontal position unchanged, so if you start in the
@@ -210,7 +210,7 @@ middle of one line, you move to the middle of the next.
 @item C-p
 @itemx @key{UP}
 @kindex C-p
-@kindex @key{UP}
+@kindex UP
 @findex previous-line
 Move up one screen line (@code{previous-line}).  This command
 preserves position within the line, like @kbd{C-n}.
@@ -218,14 +218,14 @@ preserves position within the line, like @kbd{C-n}.
 @item C-a
 @itemx @key{Home}
 @kindex C-a
-@kindex @key{HOME}
+@kindex HOME
 @findex move-beginning-of-line
 Move to the beginning of the line (@code{move-beginning-of-line}).
 
 @item C-e
 @itemx @key{End}
 @kindex C-e
-@kindex @key{END}
+@kindex END
 @findex move-end-of-line
 Move to the end of the line (@code{move-end-of-line}).
 
@@ -234,8 +234,8 @@ Move forward one word (@code{forward-word}).  @xref{Words}.
 
 @item C-@key{RIGHT}
 @itemx M-@key{RIGHT}
-@kindex C-@key{RIGHT}
-@kindex M-@key{RIGHT}
+@kindex C-RIGHT
+@kindex M-RIGHT
 @findex right-word
 This command (@code{right-word}) behaves like @kbd{M-f}, except it
 moves @emph{backward} by one word if the current paragraph is
@@ -246,8 +246,8 @@ Move backward one word (@code{backward-word}).  @xref{Words}.
 
 @item C-@key{LEFT}
 @itemx M-@key{LEFT}
-@kindex C-@key{LEFT}
-@kindex M-@key{LEFT}
+@kindex C-LEFT
+@kindex M-LEFT
 @findex left-word
 This command (@code{left-word}) behaves like @kbd{M-b}, except it
 moves @emph{forward} by one word if the current paragraph is
@@ -277,7 +277,7 @@ On graphical displays, @kbd{C-@key{HOME}} does the same.
 
 @item M->
 @kindex M->
-@kindex C-@key{END}
+@kindex C-END
 @findex end-of-buffer
 Move to the end of the buffer (@code{end-of-buffer}).  On graphical
 displays, @kbd{C-@key{END}} does the same.
@@ -314,7 +314,7 @@ also specify @var{n} by giving @kbd{M-g M-g} a numeric prefix argument.
 a plain prefix argument.
 
 @item M-g @key{TAB}
-@kindex M-g @key{TAB}
+@kindex M-g TAB
 @findex move-to-column
 Read a number @var{n} and move to column @var{n} in the current line.
 Column 0 is the leftmost column.  If called with a prefix argument,
diff --git a/doc/emacs/buffers.texi b/doc/emacs/buffers.texi
index 2f0bb9740d..f8c1856058 100644
--- a/doc/emacs/buffers.texi
+++ b/doc/emacs/buffers.texi
@@ -111,8 +111,8 @@ it, Emacs asks for the file name to use, and the buffer's major mode
 is re-established taking that file name into account (@pxref{Choosing
 Modes}).
 
-@kindex C-x @key{LEFT}
-@kindex C-x @key{RIGHT}
+@kindex C-x LEFT
+@kindex C-x RIGHT
 @findex next-buffer
 @findex previous-buffer
   For conveniently switching between a few buffers, use the commands
@@ -419,13 +419,13 @@ removing the flags.
 
 @item @key{DEL}
 @findex Buffer-menu-backup-unmark
-@kindex @key{DEL} @r{(Buffer Menu)}
+@kindex DEL @r{(Buffer Menu)}
 Move to the previous line and remove all flags on that line
 (@code{Buffer-menu-backup-unmark}).
 
 @item M-@key{DEL}
 @findex Buffer-menu-unmark-all-buffers
-@kindex M-@key{DEL} @r{(Buffer Menu)}
+@kindex M-DEL @r{(Buffer Menu)}
 Remove a particular flag from all lines
 (@code{Buffer-menu-unmark-all-buffers}).  This asks for a single
 character, and unmarks buffers marked with that character; typing
@@ -479,7 +479,7 @@ visible buffer is displayed in its place.
 @itemx f
 @findex Buffer-menu-this-window
 @kindex f @r{(Buffer Menu)}
-@kindex @key{RET} @r{(Buffer Menu)}
+@kindex RET @r{(Buffer Menu)}
 Select this line's buffer, replacing the @file{*Buffer List*} buffer
 in its window (@code{Buffer-menu-this-window}).
 
diff --git a/doc/emacs/building.texi b/doc/emacs/building.texi
index 92e1a59ed0..c38b007f24 100644
--- a/doc/emacs/building.texi
+++ b/doc/emacs/building.texi
@@ -770,7 +770,7 @@ be bizarre.  See the GDB manual entry regarding @code{jump} for
 details.
 
 @item @key{TAB}
-@kindex @key{TAB} @r{(GUD)}
+@kindex TAB @r{(GUD)}
 @findex gud-gdb-complete-command
 With GDB, complete a symbol name (@code{gud-gdb-complete-command}).
 This key is available only in the GUD interaction buffer.
@@ -1000,7 +1000,7 @@ to the @dfn{current breakpoint} (the breakpoint which point is on):
 
 @table @kbd
 @item @key{SPC}
-@kindex @key{SPC} @r{(GDB Breakpoints buffer)}
+@kindex SPC @r{(GDB Breakpoints buffer)}
 @findex gdb-toggle-breakpoint
 Enable/disable current breakpoint (@code{gdb-toggle-breakpoint}).  On
 a graphical display, this changes the color of the dot in the fringe
@@ -1013,7 +1013,7 @@ is enabled, and gray when it is disabled.
 Delete the current breakpoint (@code{gdb-delete-breakpoint}).
 
 @item @key{RET}
-@kindex @key{RET} @r{(GDB Breakpoints buffer)}
+@kindex RET @r{(GDB Breakpoints buffer)}
 @findex gdb-goto-breakpoint
 Visit the source line for the current breakpoint
 (@code{gdb-goto-breakpoint}).
@@ -1206,7 +1206,7 @@ immediate children exceeds the value of the variable
   To delete a complex watch expression, move point to the root
 expression in the speedbar and type @kbd{D} (@code{gdb-var-delete}).
 
-@kindex @key{RET} @r{(GDB speedbar)}
+@kindex RET @r{(GDB speedbar)}
 @findex gdb-edit-value
   To edit a variable with a simple data type, or a simple element of a
 complex data type, move point there in the speedbar and type @key{RET}
@@ -1492,7 +1492,7 @@ Evaluate all the Emacs Lisp expressions in the buffer.
 @ifinfo
 @c This uses 'colon' instead of a literal ':' because Info cannot
 @c cope with a ':' in a menu.
-@kindex M-@key{colon}
+@kindex M-colon
 @end ifinfo
 @ifnotinfo
 @kindex M-:
diff --git a/doc/emacs/calendar.texi b/doc/emacs/calendar.texi
index 98089fd20f..c6a84b5ab1 100644
--- a/doc/emacs/calendar.texi
+++ b/doc/emacs/calendar.texi
@@ -328,7 +328,7 @@ date.
 (@code{calendar-redraw}) to redraw it.  (This can only happen if you use
 non-Calendar-mode editing commands.)
 
-@kindex @key{SPC} @r{(Calendar mode)}
+@kindex SPC @r{(Calendar mode)}
   In Calendar mode, you can use @key{SPC} (@code{scroll-other-window})
 and @key{DEL} (@code{scroll-other-window-down}) to scroll the other
 window (if there is one) up or down, respectively.  This is handy when
diff --git a/doc/emacs/custom.texi b/doc/emacs/custom.texi
index cdcdb6a29c..a9f261b307 100644
--- a/doc/emacs/custom.texi
+++ b/doc/emacs/custom.texi
@@ -123,8 +123,8 @@ or moving point there and typing @kbd{@key{RET}}.  For example, the group
 names like @samp{[Editing]} are links; activating one of these links
 brings up the customization buffer for that group.
 
-@kindex @key{TAB} @r{(customization buffer)}
-@kindex @key{S-TAB} @r{(customization buffer)}
+@kindex TAB @r{(customization buffer)}
+@kindex S-TAB @r{(customization buffer)}
 @findex widget-forward
 @findex widget-backward
   In the customization buffer, you can type @kbd{@key{TAB}}
@@ -243,7 +243,7 @@ You don't have to worry about specifying a value that is not valid;
 the @samp{Set for Current Session} operation checks for validity and
 will not install an unacceptable value.
 
-@kindex M-@key{TAB} @r{(customization buffer)}
+@kindex M-TAB @r{(customization buffer)}
 @kindex C-M-i @r{(customization buffer)}
 @findex widget-complete
   While editing certain kinds of values, such as file names, directory
diff --git a/doc/emacs/dired.texi b/doc/emacs/dired.texi
index 28558b2834..14d5243387 100644
--- a/doc/emacs/dired.texi
+++ b/doc/emacs/dired.texi
@@ -136,7 +136,7 @@ buffers.  The keys @kbd{C-n} and @kbd{C-p} are redefined to put the
 cursor at the beginning of the file name on the line, rather than at
 the beginning of the line.
 
-@kindex @key{SPC} @r{(Dired)}
+@kindex SPC @r{(Dired)}
   For extra convenience, @key{SPC} and @kbd{n} in Dired are equivalent
 to @kbd{C-n}.  @kbd{p} is equivalent to @kbd{C-p}.  (Moving by lines
 is so common in Dired that it deserves to be easy to type.)  @key{DEL}
@@ -204,7 +204,7 @@ region for deletion; in this case, the command does not move point,
 and ignores any prefix argument.
 
 @kindex u @r{(Dired deletion)}
-@kindex @key{DEL} @r{(Dired)}
+@kindex DEL @r{(Dired)}
   The reason for flagging files for deletion, rather than deleting
 files immediately, is to reduce the danger of deleting a file
 accidentally.  Until you direct Dired to delete the flagged files, you
@@ -348,7 +348,7 @@ and supplying that file name (@code{dired-find-file}).  @xref{Visiting}.
 
 @item @key{RET}
 @itemx e
-@kindex @key{RET} @r{(Dired)}
+@kindex RET @r{(Dired)}
 @kindex e @r{(Dired)}
 Equivalent to @kbd{f}.
 
@@ -464,7 +464,7 @@ unmark the previous @minus{}@var{n} files).
 
 @item @key{DEL}
 @itemx * @key{DEL}
-@kindex * @key{DEL} @r{(Dired)}
+@kindex * DEL @r{(Dired)}
 @findex dired-unmark-backward
 @cindex unmarking files (in Dired)
 Move point to previous line and remove any mark on that line
@@ -485,7 +485,7 @@ Remove all marks from all the files in this Dired buffer
 @item * ? @var{markchar}
 @itemx M-@key{DEL}
 @kindex * ? @r{(Dired)}
-@kindex M-@key{DEL} @r{(Dired)}
+@kindex M-DEL @r{(Dired)}
 @findex dired-unmark-all-files
 Remove all marks that use the character @var{markchar}
 (@code{dired-unmark-all-files}).  If invoked with @kbd{M-@key{DEL}},
diff --git a/doc/emacs/display.texi b/doc/emacs/display.texi
index fdd18896f2..5ddc3d63e7 100644
--- a/doc/emacs/display.texi
+++ b/doc/emacs/display.texi
@@ -79,10 +79,10 @@ Scroll backward (@code{scroll-down-command}).
 
 @kindex C-v
 @kindex M-v
-@kindex @key{next}
-@kindex @key{prior}
-@kindex @key{PageDown}
-@kindex @key{PageUp}
+@kindex next
+@kindex prior
+@kindex PageDown
+@kindex PageUp
 @findex scroll-up-command
 @findex scroll-down-command
   @kbd{C-v} (@code{scroll-up-command}) scrolls forward by nearly the
@@ -447,8 +447,8 @@ it.  @xref{Disabling}.
 @cindex mode, View
 
 @kindex s @r{(View mode)}
-@kindex @key{SPC} @r{(View mode)}
-@kindex @key{DEL} @r{(View mode)}
+@kindex SPC @r{(View mode)}
+@kindex DEL @r{(View mode)}
   View mode is a minor mode that lets you scan a buffer by sequential
 screenfuls.  It provides commands for scrolling through the buffer
 conveniently but not for changing it.  Apart from the usual Emacs
diff --git a/doc/emacs/files.texi b/doc/emacs/files.texi
index bcebc4bd4e..dfdcc205da 100644
--- a/doc/emacs/files.texi
+++ b/doc/emacs/files.texi
@@ -1957,7 +1957,7 @@ then specifying @file{/tmp/foo*bar} will visit only
 @cindex file name caching
 @cindex cache of file names
 @pindex find
-@kindex C-@key{TAB}
+@kindex C-TAB
 @findex file-cache-minibuffer-complete
   You can use the @dfn{file name cache} to make it easy to locate a
 file by name, without having to remember exactly where it is located.
diff --git a/doc/emacs/frames.texi b/doc/emacs/frames.texi
index 0992503142..94c8821006 100644
--- a/doc/emacs/frames.texi
+++ b/doc/emacs/frames.texi
@@ -473,13 +473,13 @@ cycles through all the frames on your terminal.
 Delete all frames on the current terminal, except the selected one.
 
 @item M-@key{F10}
-@kindex M-@key{F10}
+@kindex M-F10
 @findex toggle-frame-maximized
 Toggle the maximization state of the current frame.  When a frame is
 maximized, it fills the screen.
 
 @item @key{F11>}
-@kindex @key{F11}
+@kindex F11
 @findex toggle-frame-fullscreen
 Toggle full-screen mode for the current frame.  (The difference
 between full-screen and maximized is normally that the former
diff --git a/doc/emacs/help.texi b/doc/emacs/help.texi
index 4abd267276..a5700760d4 100644
--- a/doc/emacs/help.texi
+++ b/doc/emacs/help.texi
@@ -8,7 +8,7 @@
 @cindex self-documentation
 @findex help-command
 @kindex C-h
-@kindex @key{F1}
+@kindex F1
 
 @kindex C-h C-h
 @findex help-for-help
@@ -431,7 +431,7 @@ Go back to the previous help topic (@code{help-go-back}).
 @findex help-follow
 @findex help-go-back
 @findex help-go-forward
-@kindex @key{RET} @r{(Help mode)}
+@kindex RET @r{(Help mode)}
 @kindex C-c C-b @r{(Help mode)}
 @kindex l @r{(Help mode)}
 @kindex C-c C-f @r{(Help mode)}
@@ -455,9 +455,9 @@ code definitions, and URLs (web pages).  The first two are opened in
 Emacs, and the third using a web browser via the @code{browse-url}
 command (@pxref{Browse-URL}).
 
-@kindex @key{TAB} @r{(Help mode)}
+@kindex TAB @r{(Help mode)}
 @findex forward-button
-@kindex S-@key{TAB} @r{(Help mode)}
+@kindex S-TAB @r{(Help mode)}
 @findex backward-button
   In a help buffer, @key{TAB} (@code{forward-button}) moves point
 forward to the next hyperlink, while @kbd{S-@key{TAB}}
diff --git a/doc/emacs/indent.texi b/doc/emacs/indent.texi
index eae334449c..b38e85819c 100644
--- a/doc/emacs/indent.texi
+++ b/doc/emacs/indent.texi
@@ -17,7 +17,7 @@ programming language modes.  @xref{Program Indent}, for additional
 documentation about indenting in programming modes.
 
 @findex indent-for-tab-command
-@kindex @key{TAB} @r{(indentation)}
+@kindex TAB @r{(indentation)}
   The simplest way to perform indentation is the @key{TAB} key.  In
 most major modes, this runs the command @code{indent-for-tab-command}.
 (In C and related modes, @key{TAB} runs the command
@@ -120,7 +120,7 @@ If a numeric argument is supplied, indent every line in the region to
 that column number.
 
 @item C-x @key{TAB}
-@kindex C-x @key{TAB}
+@kindex C-x TAB
 @findex indent-rigidly
 @cindex remove indentation
 This command is used to change the indentation of all lines that begin
diff --git a/doc/emacs/killing.texi b/doc/emacs/killing.texi
index 7b89dce4e6..4118b752e6 100644
--- a/doc/emacs/killing.texi
+++ b/doc/emacs/killing.texi
@@ -111,7 +111,7 @@ active (@pxref{Using Region}).
 
 @kindex M-\
 @findex delete-horizontal-space
-@kindex M-@key{SPC}
+@kindex M-SPC
 @findex just-one-space
 @findex cycle-spacing
   The other delete commands are those that delete only whitespace
diff --git a/doc/emacs/kmacro.texi b/doc/emacs/kmacro.texi
index 844ca8e9b6..7e28d1d920 100644
--- a/doc/emacs/kmacro.texi
+++ b/doc/emacs/kmacro.texi
@@ -64,8 +64,8 @@ Run the last keyboard macro on each line that begins in the region
 (@code{apply-macro-to-region-lines}).
 @end table
 
-@kindex @key{F3}
-@kindex @key{F4}
+@kindex F3
+@kindex F4
 @findex kmacro-start-macro-or-insert-counter
 @findex kmacro-end-or-call-macro
 @findex kmacro-end-and-call-macro
@@ -481,7 +481,7 @@ Edit the last 300 keystrokes as a keyboard macro
 
 @findex kmacro-edit-macro
 @kindex C-x C-k C-e
-@kindex C-x C-k @key{RET}
+@kindex C-x C-k RET
   You can edit the last keyboard macro by typing @kbd{C-x C-k C-e} or
 @kbd{C-x C-k @key{RET}} (@code{kmacro-edit-macro}).  This formats the
 macro definition in a buffer and enters a specialized major mode for
@@ -505,7 +505,7 @@ keyboard input that you would use to invoke the macro---@kbd{C-x e} or
 @section Stepwise Editing a Keyboard Macro
 
 @findex kmacro-step-edit-macro
-@kindex C-x C-k @key{SPC}
+@kindex C-x C-k SPC
   You can interactively replay and edit the last keyboard
 macro, one command at a time, by typing @kbd{C-x C-k @key{SPC}}
 (@code{kmacro-step-edit-macro}).  Unless you quit the macro using
diff --git a/doc/emacs/mark.texi b/doc/emacs/mark.texi
index 20cc67a1e7..0ffa9f74ac 100644
--- a/doc/emacs/mark.texi
+++ b/doc/emacs/mark.texi
@@ -79,7 +79,7 @@ Set the mark at point if the mark is inactive, then move point.
 @xref{Shift Selection}.
 @end table
 
-@kindex C-@key{SPC}
+@kindex C-SPC
 @kindex C-@@
 @findex set-mark-command
   The most common way to set the mark is with @kbd{C-@key{SPC}}
@@ -309,7 +309,7 @@ Move point to where the mark was, and restore the mark from the ring
 of former marks.
 @end table
 
-@kindex C-@key{SPC} C-@key{SPC}
+@kindex C-SPC C-SPC
   The command @kbd{C-@key{SPC} C-@key{SPC}} is handy when you want to
 use the mark to remember a position to which you may wish to return.
 It pushes the current point onto the mark ring, without activating the
@@ -320,7 +320,7 @@ and the second @kbd{C-@key{SPC}} deactivates it.  (When Transient Mark
 mode is off, @kbd{C-@key{SPC} C-@key{SPC}} instead activates Transient
 Mark mode temporarily; @pxref{Disabled Transient Mark}.)
 
-@kindex C-u C-@key{SPC}
+@kindex C-u C-SPC
   To return to a marked position, use @code{set-mark-command} with a
 prefix argument: @kbd{C-u C-@key{SPC}}.  This moves point to where the
 mark was, and deactivates the mark if it was active.  Each subsequent
@@ -365,7 +365,7 @@ of buffers that you have been in, and, for each buffer, a place where
 you set the mark.  The length of the global mark ring is controlled by
 @code{global-mark-ring-max}, and is 16 by default.
 
-@kindex C-x C-@key{SPC}
+@kindex C-x C-SPC
 @findex pop-global-mark
   The command @kbd{C-x C-@key{SPC}} (@code{pop-global-mark}) jumps to
 the buffer and position of the latest entry in the global ring.  It also
@@ -447,7 +447,7 @@ using @kbd{C-@key{SPC} C-@key{SPC}} or @kbd{C-u C-x C-x}.
 
 @table @kbd
 @item C-@key{SPC} C-@key{SPC}
-@kindex C-@key{SPC} C-@key{SPC}@r{, disabling Transient Mark}
+@kindex C-SPC C-SPC@r{, disabling Transient Mark}
 Set the mark at point (like plain @kbd{C-@key{SPC}}) and enable
 Transient Mark mode just once, until the mark is deactivated.  (This
 is not really a separate command; you are using the @kbd{C-@key{SPC}}
diff --git a/doc/emacs/mini.texi b/doc/emacs/mini.texi
index ec979dc707..8278de7f31 100644
--- a/doc/emacs/mini.texi
+++ b/doc/emacs/mini.texi
@@ -259,7 +259,7 @@ Completion}.
 @node Completion Example
 @subsection Completion Example
 
-@kindex @key{TAB} @r{(completion example)}
+@kindex TAB @r{(completion example)}
   A simple example may help here.  @kbd{M-x} uses the minibuffer to
 read the name of a command, so completion works by matching the
 minibuffer text against the names of existing Emacs commands.  Suppose
@@ -311,7 +311,7 @@ first (@code{minibuffer-complete-and-exit}).  @xref{Completion Exit}.
 Display a list of completions (@code{minibuffer-completion-help}).
 @end table
 
-@kindex @key{TAB} @r{(completion)}
+@kindex TAB @r{(completion)}
 @findex minibuffer-complete
   @key{TAB} (@code{minibuffer-complete}) is the most fundamental
 completion command.  It searches for all possible completions that
@@ -319,7 +319,7 @@ match the existing minibuffer text, and attempts to complete as much
 as it can.  @xref{Completion Styles}, for how completion alternatives
 are chosen.
 
-@kindex @key{SPC} @r{(completion)}
+@kindex SPC @r{(completion)}
 @findex minibuffer-complete-word
   @key{SPC} (@code{minibuffer-complete-word}) completes like
 @key{TAB}, but only up to the next hyphen or space.  If you have
@@ -372,7 +372,7 @@ completion alternative (@code{previous-completion}).
 @node Completion Exit
 @subsection Completion Exit
 
-@kindex @key{RET} @r{(completion in minibuffer)}
+@kindex RET @r{(completion in minibuffer)}
 @findex minibuffer-complete-and-exit
   When a command reads an argument using the minibuffer with
 completion, it also controls what happens when you type @key{RET}
@@ -648,8 +648,8 @@ directory.
 
 @findex previous-line-or-history-element
 @findex next-line-or-history-element
-@kindex @key{UP} @r{(minibuffer history)}
-@kindex @key{DOWN} @r{(minibuffer history)}
+@kindex UP @r{(minibuffer history)}
+@kindex DOWN @r{(minibuffer history)}
   The arrow keys @kbd{@key{UP}} and @kbd{@key{DOWN}} work like
 @kbd{M-p} and @kbd{M-n}, but if the current history item is longer
 than a single line, they allow you to move to the previous or next
@@ -720,7 +720,7 @@ Display the entire command history, showing all the commands
 @kbd{C-x @key{ESC} @key{ESC}} can repeat, most recent first.
 @end table
 
-@kindex C-x @key{ESC} @key{ESC}
+@kindex C-x ESC ESC
 @findex repeat-complex-command
   @kbd{C-x @key{ESC} @key{ESC}} re-executes a recent command that used
 the minibuffer.  With no argument, it repeats the last such command.
diff --git a/doc/emacs/misc.texi b/doc/emacs/misc.texi
index 7f2a0a1107..e1b8070f43 100644
--- a/doc/emacs/misc.texi
+++ b/doc/emacs/misc.texi
@@ -129,7 +129,7 @@ sessions.
   The following commands are available in the Gnus group buffer:
 
 @table @kbd
-@kindex @key{SPC} @r{(Gnus Group mode)}
+@kindex SPC @r{(Gnus Group mode)}
 @findex gnus-group-read-group
 @item @key{SPC}
 Switch to the summary buffer for the group on the current line.
@@ -177,7 +177,7 @@ Kill the group on the current line.  Killed groups are not recorded in
 the @file{.newsrc} file, and they are not shown in the @kbd{l} or
 @kbd{L} listings.
 
-@kindex @key{DEL} @r{(Gnus Group mode)}
+@kindex DEL @r{(Gnus Group mode)}
 @item @key{DEL}
 Move point to the previous group containing unread articles.
 
@@ -203,7 +203,7 @@ Update your Gnus settings, and quit Gnus.
   The following commands are available in the Gnus summary buffer:
 
 @table @kbd
-@kindex @key{SPC} @r{(Gnus Summary mode)}
+@kindex SPC @r{(Gnus Summary mode)}
 @findex gnus-summary-next-page
 @item @key{SPC}
 If there is no article selected, select the article on the current
@@ -214,7 +214,7 @@ buffer, select the next unread article.
 Thus, you can read through all articles by repeatedly typing
 @key{SPC}.
 
-@kindex @key{DEL} @r{(Gnus Summary mode)}
+@kindex DEL @r{(Gnus Summary mode)}
 @findex gnus-summary-prev-page
 @item @key{DEL}
 Scroll the text of the article backwards.
@@ -481,8 +481,8 @@ page, type @kbd{p}, @key{prior} or @kbd{C-x [}
 
 @findex doc-view-scroll-up-or-next-page
 @findex doc-view-scroll-down-or-previous-page
-@kindex @key{SPC} @r{(DocView mode)}
-@kindex @key{DEL} @r{(DocView mode)}
+@kindex SPC @r{(DocView mode)}
+@kindex DEL @r{(DocView mode)}
   @key{SPC} (@code{doc-view-scroll-up-or-next-page}) is a convenient
 way to advance through the document.  It scrolls within the current
 page or advances to the next.  @key{DEL} moves backwards in a similar
@@ -826,7 +826,7 @@ commands:
 
 @table @kbd
 @item @key{RET}
-@kindex @key{RET} @r{(Shell mode)}
+@kindex RET @r{(Shell mode)}
 @findex comint-send-input
 Send the current line as input to the subshell
 (@code{comint-send-input}).  Any shell prompt at the beginning of the
@@ -836,7 +836,7 @@ interactive shell.  However, you can also invoke @key{RET} elsewhere
 in the shell buffer to submit the current line as input.
 
 @item @key{TAB}
-@kindex @key{TAB} @r{(Shell mode)}
+@kindex TAB @r{(Shell mode)}
 @findex completion-at-point@r{, in Shell Mode}
 @cindex shell completion
 Complete the command name or file name before point in the shell
@@ -1182,7 +1182,7 @@ Move point to the previous prompt (@code{comint-previous-prompt}).
 @item C-c C-n
 Move point to the following prompt (@code{comint-next-prompt}).
 
-@kindex C-c @key{RET} @r{(Shell mode)}
+@kindex C-c RET @r{(Shell mode)}
 @findex comint-copy-old-input
 @item C-c @key{RET}
 Copy the input command at point, inserting the copy at the end of the
@@ -2796,7 +2796,7 @@ the package commentary by typing @kbd{C-h P browse-url @key{RET}}.
 Activate URLs and e-mail addresses in the current buffer.
 @end table
 
-@kindex C-c @key{RET} @r{(Goto Address mode)}
+@kindex C-c RET @r{(Goto Address mode)}
 @findex goto-address-at-point
   You can make Emacs mark out URLs specially in the current buffer, by
 typing @kbd{M-x goto-address-mode}.  When this buffer-local minor mode
diff --git a/doc/emacs/modes.texi b/doc/emacs/modes.texi
index fd8f0110a3..2bbc17b26d 100644
--- a/doc/emacs/modes.texi
+++ b/doc/emacs/modes.texi
@@ -33,8 +33,8 @@ one another, and of the selected major mode.
 @section Major Modes
 @cindex major modes
 @cindex mode, major
-@kindex @key{TAB} @r{(and major modes)}
-@kindex @key{DEL} @r{(and major modes)}
+@kindex TAB @r{(and major modes)}
+@kindex DEL @r{(and major modes)}
 @kindex C-j @r{(and major modes)}
 
   Every buffer possesses a major mode, which determines the editing
@@ -236,7 +236,7 @@ called Outline mode.  @xref{Outline Mode}.
 @cindex Overwrite mode
 @cindex mode, Overwrite
 @findex overwrite-mode
-@kindex @key{INSERT}
+@kindex INSERT
 @item
 Overwrite mode causes ordinary printing characters to replace existing
 text instead of shoving it to the right.  For example, if point is in
diff --git a/doc/emacs/msdos.texi b/doc/emacs/msdos.texi
index ee132cdc0f..c1bcb2bb6e 100644
--- a/doc/emacs/msdos.texi
+++ b/doc/emacs/msdos.texi
@@ -565,7 +565,7 @@ modifier with the trailing dash but with no key indicates that all
 Windows defined hotkeys for that modifier are to be overridden in the
 favor of Emacs.
 
-@kindex M-@key{TAB}@r{, (MS-Windows)}
+@kindex M-TAB@r{, (MS-Windows)}
 @cindex @kbd{M-@key{TAB}} vs @kbd{@key{Alt}-@key{TAB}} (MS-Windows)
 @cindex @kbd{@key{Alt}-@key{TAB}} vs @kbd{M-@key{TAB}} (MS-Windows)
   For example, @code{(w32-register-hot-key [M-tab])} lets you use
@@ -679,7 +679,7 @@ its normal effect: for example, @kbd{@key{Lwindow}} opens the
 @code{Start} menu, etc.
 
 @vindex w32-recognize-altgr
-@kindex @key{AltGr} @r{(MS-Windows)}
+@kindex AltGr @r{(MS-Windows)}
 @cindex @key{AltGr} key (MS-Windows)
   The variable @code{w32-recognize-altgr} controls whether the
 @key{AltGr} key (if it exists on your keyboard), or its equivalent,
diff --git a/doc/emacs/mule.texi b/doc/emacs/mule.texi
index 87c22e9959..01184e2ae1 100644
--- a/doc/emacs/mule.texi
+++ b/doc/emacs/mule.texi
@@ -130,7 +130,7 @@ various @dfn{input methods}, typically one for each script or
 language, which make it easier to type characters in the script.
 @xref{Input Methods}.
 
-@kindex C-x @key{RET}
+@kindex C-x RET
   The prefix key @kbd{C-x @key{RET}} is used for commands that pertain
 to multibyte characters, coding systems, and input methods.
 
@@ -577,7 +577,7 @@ Display a list of all the supported input methods.
 
 @findex set-input-method
 @vindex current-input-method
-@kindex C-x @key{RET} C-\
+@kindex C-x RET C-\
   To choose an input method for the current buffer, use @kbd{C-x
 @key{RET} C-\} (@code{set-input-method}).  This command reads the
 input method name from the minibuffer; the name normally starts with the
@@ -1020,7 +1020,7 @@ Convert a region that was decoded using coding system @var{wrong},
 decoding it using coding system @var{right} instead.
 @end table
 
-@kindex C-x @key{RET} f
+@kindex C-x RET f
 @findex set-buffer-file-coding-system
   The command @kbd{C-x @key{RET} f}
 (@code{set-buffer-file-coding-system}) sets the file coding system for
@@ -1042,7 +1042,7 @@ current buffer.  For example, @kbd{C-x @key{RET} f dos @key{RET}} will
 cause Emacs to save the current buffer's text with DOS-style
 carriage-return linefeed line endings.
 
-@kindex C-x @key{RET} c
+@kindex C-x RET c
 @findex universal-coding-system-argument
   Another way to specify the coding system for a file is when you visit
 the file.  First use the command @kbd{C-x @key{RET} c}
@@ -1076,7 +1076,7 @@ then save it in a file.  Selecting a language environment typically sets
 this variable to a good choice of default coding system for that language
 environment.
 
-@kindex C-x @key{RET} r
+@kindex C-x RET r
 @findex revert-buffer-with-coding-system
   If you visit a file with a wrong coding system, you can correct this
 with @kbd{C-x @key{RET} r} (@code{revert-buffer-with-coding-system}).
@@ -1112,8 +1112,8 @@ subprocess input and output in the current buffer
 (@code{set-buffer-process-coding-system}).
 @end table
 
-@kindex C-x @key{RET} x
-@kindex C-x @key{RET} X
+@kindex C-x RET x
+@kindex C-x RET X
 @findex set-selection-coding-system
 @findex set-next-selection-coding-system
   The command @kbd{C-x @key{RET} x} (@code{set-selection-coding-system})
@@ -1138,7 +1138,7 @@ list of some of these symbols, Emacs tries only the request types in
 the list, in order, until one of them succeeds, or until the list is
 exhausted.
 
-@kindex C-x @key{RET} p
+@kindex C-x RET p
 @findex set-buffer-process-coding-system
   The command @kbd{C-x @key{RET} p} (@code{set-buffer-process-coding-system})
 specifies the coding system for input and output to a subprocess.  This
@@ -1180,7 +1180,7 @@ names (@code{set-file-name-coding-system}).
 @end table
 
 @findex set-file-name-coding-system
-@kindex C-x @key{RET} F
+@kindex C-x RET F
 @cindex file names with non-@acronym{ASCII} characters
   The command @kbd{C-x @key{RET} F} (@code{set-file-name-coding-system})
 specifies a coding system to use for encoding file @emph{names}.  It
@@ -1246,7 +1246,7 @@ Use coding system @var{coding} for keyboard input
 (@code{set-keyboard-coding-system}).
 @end table
 
-@kindex C-x @key{RET} t
+@kindex C-x RET t
 @findex set-terminal-coding-system
   The command @kbd{C-x @key{RET} t} (@code{set-terminal-coding-system})
 specifies the coding system for terminal output.  If you specify a
@@ -1263,7 +1263,7 @@ Emacs knows which characters the terminal can actually handle.
 Emacs can deduce the proper coding system from your terminal type or
 your locale specification (@pxref{Language Environments}).
 
-@kindex C-x @key{RET} k
+@kindex C-x RET k
 @findex set-keyboard-coding-system
 @vindex keyboard-coding-system
   The command @kbd{C-x @key{RET} k} (@code{set-keyboard-coding-system}),
@@ -1842,8 +1842,8 @@ character positions may look discontinuous if the region spans
 reordered text.  This is normal and similar to the behavior of other
 programs that support bidirectional text.
 
-@kindex @key{RIGHT}@r{, and bidirectional text}
-@kindex @key{LEFT}@r{, and bidirectional text}
+@kindex RIGHT@r{, and bidirectional text}
+@kindex LEFT@r{, and bidirectional text}
 @findex right-char@r{, and bidirectional text}
 @findex left-char@r{, and bidirectional text}
   Cursor motion commands bound to arrow keys, such as @key{LEFT} and
diff --git a/doc/emacs/picture-xtra.texi b/doc/emacs/picture-xtra.texi
index 35387a07b0..39c353b0ff 100644
--- a/doc/emacs/picture-xtra.texi
+++ b/doc/emacs/picture-xtra.texi
@@ -191,7 +191,7 @@ C-b} (@code{picture-motion-reverse}) moves in the opposite direction.
 @node Tabs in Picture
 @subsection Picture Mode Tabs
 
-@kindex M-@key{TAB} @r{(Picture mode)}
+@kindex M-TAB @r{(Picture mode)}
 @findex picture-tab-search
 @vindex picture-tab-chars
   Two kinds of tab-like action are provided in Picture mode.  Use
@@ -214,7 +214,7 @@ current tab stop settings; it is the Picture mode equivalent of
 @code{tab-to-tab-stop}.  Normally it just moves point, but with a numeric
 argument it clears the text that it moves over.
 
-@kindex C-c @key{TAB} @r{(Picture mode)}
+@kindex C-c TAB @r{(Picture mode)}
 @findex picture-set-tab-stops
   The context-based and tab-stop-based forms of tabbing are brought
 together by the command @kbd{C-c @key{TAB}} (@code{picture-set-tab-stops}).
diff --git a/doc/emacs/programs.texi b/doc/emacs/programs.texi
index 88afec61da..514a07a28f 100644
--- a/doc/emacs/programs.texi
+++ b/doc/emacs/programs.texi
@@ -99,7 +99,7 @@ language that you might want to edit.  If it doesn't have a mode for
 your favorite language, the mode might be implemented in a package not
 distributed with Emacs (@pxref{Packages}); or you can contribute one.
 
-@kindex @key{DEL} @r{(programming modes)}
+@kindex DEL @r{(programming modes)}
 @findex backward-delete-char-untabify
   In most programming languages, indentation should vary from line to
 line to illustrate the structure of the program.  Therefore, in most
@@ -346,7 +346,7 @@ Insert a newline, then adjust indentation of following line
 (@code{newline}).
 @end table
 
-@kindex @key{TAB} @r{(programming modes)}
+@kindex TAB @r{(programming modes)}
 @findex indent-line-function
   The basic indentation command is @kbd{@key{TAB}}
 (@code{indent-for-tab-command}), which was documented in
@@ -411,7 +411,7 @@ indentation of the line where the grouping starts).  The function that
 etc.  To correct the overall indentation as well, type @kbd{@key{TAB}}
 first.
 
-@kindex C-u @key{TAB}
+@kindex C-u TAB
   If you like the relative indentation within a grouping but not the
 indentation of its first line, move point to that first line and type
 @kbd{C-u @key{TAB}}.  In Lisp, C, and some other major modes,
@@ -683,7 +683,7 @@ argument moves the previous balanced expression backwards across those
 before it.  An argument of zero, rather than doing nothing, transposes
 the balanced expressions ending at or after point and the mark.
 
-@kindex C-M-@key{SPC}
+@kindex C-M-SPC
   To operate on balanced expressions with a command which acts on the
 region, type @kbd{C-M-@key{SPC}} (@code{mark-sexp}).  This sets the
 mark where @kbd{C-M-f} would move to.  While the mark is active, each
@@ -1345,7 +1345,7 @@ nor comments).  The default value is @code{code}.
   Completion is normally done in the minibuffer (@pxref{Completion}),
 but you can also complete symbol names in ordinary Emacs buffers.
 
-@kindex M-@key{TAB}
+@kindex M-TAB
 @kindex C-M-i
   In programming language modes, type @kbd{C-M-i} or @kbd{M-@key{TAB}}
 to complete the partial symbol before point.  On graphical displays,
@@ -1451,7 +1451,7 @@ Prompt for the name of a function defined in any file Emacs has
 parsed, and move point there (@code{semantic-complete-jump}).
 
 @item C-c , @key{SPC}
-@kindex C-c , @key{SPC}
+@kindex C-c , SPC
 Display a list of possible completions for the symbol at point
 (@code{semantic-complete-analyze-inline}).  This also activates a set
 of special key bindings for choosing a completion: @kbd{@key{RET}}
@@ -1701,8 +1701,8 @@ preprocessor commands.
 @item C-c C-@key{DEL}
 @itemx C-c @key{DEL}
 @findex c-hungry-delete-backwards
-@kindex C-c C-@key{DEL} @r{(C Mode)}
-@kindex C-c @key{DEL} @r{(C Mode)}
+@kindex C-c C-DEL @r{(C Mode)}
+@kindex C-c DEL @r{(C Mode)}
 Delete the entire block of whitespace preceding point (@code{c-hungry-delete-backwards}).
 
 @item C-c C-d
@@ -1710,8 +1710,8 @@ Delete the entire block of whitespace preceding point (@code{c-hungry-delete-bac
 @itemx C-c @key{Delete}
 @findex c-hungry-delete-forward
 @kindex C-c C-d @r{(C Mode)}
-@kindex C-c C-@key{Delete} @r{(C Mode)}
-@kindex C-c @key{Delete} @r{(C Mode)}
+@kindex C-c C-Delete @r{(C Mode)}
+@kindex C-c Delete @r{(C Mode)}
 Delete the entire block of whitespace after point (@code{c-hungry-delete-forward}).
 @end table
 
diff --git a/doc/emacs/regs.texi b/doc/emacs/regs.texi
index 37a69347f4..8ff36ca554 100644
--- a/doc/emacs/regs.texi
+++ b/doc/emacs/regs.texi
@@ -70,7 +70,7 @@ Jump to the position and buffer saved in register @var{r}
 (@code{jump-to-register}).
 @end table
 
-@kindex C-x r @key{SPC}
+@kindex C-x r SPC
 @findex point-to-register
   Typing @kbd{C-x r @key{SPC}} (@code{point-to-register}), followed by
 a character @kbd{@var{r}}, saves both the position of point and the
diff --git a/doc/emacs/rmail.texi b/doc/emacs/rmail.texi
index 15d66a3840..e9371f39a9 100644
--- a/doc/emacs/rmail.texi
+++ b/doc/emacs/rmail.texi
@@ -109,9 +109,9 @@ Scroll to start of message (@code{rmail-beginning-of-message}).
 Scroll to end of message (@code{rmail-end-of-message}).
 @end table
 
-@kindex @key{SPC} @r{(Rmail)}
-@kindex @key{DEL} @r{(Rmail)}
-@kindex S-@key{SPC} @r{(Rmail)}
+@kindex SPC @r{(Rmail)}
+@kindex DEL @r{(Rmail)}
+@kindex S-SPC @r{(Rmail)}
   Since the most common thing to do while reading a message is to
 scroll through it by screenfuls, Rmail makes @key{SPC} and @key{DEL}
 (or @kbd{S-@key{SPC}}) do the same as @kbd{C-v} (@code{scroll-up-command})
diff --git a/doc/emacs/screen.texi b/doc/emacs/screen.texi
index 674d1165d8..19a4a9e4b6 100644
--- a/doc/emacs/screen.texi
+++ b/doc/emacs/screen.texi
@@ -304,7 +304,7 @@ the full command name and documentation for a menu item, type
 @kbd{C-h k}, and then select the menu bar with the mouse in the usual
 way (@pxref{Key Help}).
 
-@kindex @key{F10}
+@kindex F10
 @findex menu-bar-open
 @cindex menu bar access using keyboard
   Instead of using the mouse, you can also invoke the first menu bar
diff --git a/doc/emacs/search.texi b/doc/emacs/search.texi
index d55ff26ab8..887fd982d0 100644
--- a/doc/emacs/search.texi
+++ b/doc/emacs/search.texi
@@ -404,7 +404,7 @@ or @code{query-replace-regexp} (depending on search mode) with the
 current search string used as the string to replace.  A negative
 prefix argument means to replace backward.  @xref{Query Replace}.
 
-@kindex M-@key{TAB} @r{(Incremental search)}
+@kindex M-TAB @r{(Incremental search)}
   Typing @kbd{M-@key{TAB}} in incremental search invokes
 @code{isearch-complete}, which attempts to complete the search string
 using the search ring (the previous search strings you used) as a list
@@ -1193,8 +1193,8 @@ differences usually don't matter; etc.  This is known as
 tailor them to your needs.
 
 @cindex lax space matching in search
-@kindex M-s @key{SPC} @r{(Incremental search)}
-@kindex @key{SPC} @r{(Incremental search)}
+@kindex M-s SPC @r{(Incremental search)}
+@kindex SPC @r{(Incremental search)}
 @findex isearch-toggle-lax-whitespace
 @vindex search-whitespace-regexp
   By default, search commands perform @dfn{lax space matching}:
@@ -1577,10 +1577,10 @@ read-only text.  The default is not to ignore them.
 or regexp are:
 
 @ignore @c Not worth it.
-@kindex @key{SPC} @r{(query-replace)}
-@kindex @key{DEL} @r{(query-replace)}
+@kindex SPC @r{(query-replace)}
+@kindex DEL @r{(query-replace)}
 @kindex , @r{(query-replace)}
-@kindex @key{RET} @r{(query-replace)}
+@kindex RET @r{(query-replace)}
 @kindex . @r{(query-replace)}
 @kindex ! @r{(query-replace)}
 @kindex ^ @r{(query-replace)}
@@ -1777,7 +1777,7 @@ Note that matches for the regexp you type are extended to include
 complete lines, and a match that starts before the previous match ends
 is not considered a match.
 
-@kindex @key{RET} @r{(Occur mode)}
+@kindex RET @r{(Occur mode)}
 @kindex o @r{(Occur mode)}
 @kindex C-o @r{(Occur mode)}
 In the @file{*Occur*} buffer, you can click on each entry, or move
diff --git a/doc/emacs/sending.texi b/doc/emacs/sending.texi
index c7cc005a21..b7bdd69c7c 100644
--- a/doc/emacs/sending.texi
+++ b/doc/emacs/sending.texi
@@ -461,7 +461,7 @@ just after the header separator line---that is, to the beginning of
 the body.
 
 @findex message-tab
-@kindex @key{TAB} @r{(Message mode)}
+@kindex TAB @r{(Message mode)}
   While editing a header field that contains addresses, such as
 @samp{To:}, @samp{Cc:} and @samp{Bcc:}, you can complete an address by
 typing @key{TAB} (@code{message-tab}).  This attempts to insert the
diff --git a/doc/emacs/text.texi b/doc/emacs/text.texi
index 991d145306..9ecc41e888 100644
--- a/doc/emacs/text.texi
+++ b/doc/emacs/text.texi
@@ -137,7 +137,7 @@ kill only the next word but not the punctuation before it, simply do
 @kbd{M-@key{DEL}}.)  @kbd{M-d} takes arguments just like @kbd{M-f}.
 
 @findex backward-kill-word
-@kindex M-@key{DEL}
+@kindex M-DEL
   @kbd{M-@key{DEL}} (@code{backward-kill-word}) kills the word before
 point.  It kills everything from point back to where @kbd{M-b} would
 move to.  For instance, if point is after the space in @w{@samp{FOO,
@@ -214,7 +214,7 @@ of the sentence.  With a positive numeric argument @var{n}, it kills
 the next @var{n} sentences; with a negative argument @minus{}@var{n},
 it kills back to the beginning of the @var{n}th preceding sentence.
 
-@kindex C-x @key{DEL}
+@kindex C-x DEL
 @findex backward-kill-sentence
   The @kbd{C-x @key{DEL}} (@code{backward-kill-sentence}) kills back
 to the beginning of a sentence.
@@ -888,7 +888,7 @@ paragraphs.  As a result, paragraphs can be indented, and adaptive
 filling determines what indentation to use when filling a paragraph.
 @xref{Adaptive Fill}.
 
-@kindex @key{TAB} @r{(Text mode)}
+@kindex TAB @r{(Text mode)}
   In Text mode, the @key{TAB} (@code{indent-for-tab-command}) command
 usually inserts whitespace up to the next tab stop, instead of
 indenting the current line.  @xref{Indentation}, for details.
@@ -915,7 +915,7 @@ paragraph-indent-minor-mode} to enable an equivalent minor mode for
 situations where you shouldn't change the major mode---in mail
 composition, for instance.
 
-@kindex M-@key{TAB} @r{(Text mode)}
+@kindex M-TAB @r{(Text mode)}
   Text mode binds @kbd{M-@key{TAB}} to @code{ispell-complete-word}.
 This command performs completion of the partial word in the buffer
 before point, using the spelling dictionary as the space of possible
@@ -1362,7 +1362,7 @@ starts with one or more @samp{*} characters.  @xref{Outline Format}.
 In addition, any line that begins with the @samp{#} character is
 treated as a comment.
 
-@kindex @key{TAB} @r{(Org Mode)}
+@kindex TAB @r{(Org Mode)}
 @findex org-cycle
   Org mode provides commands for easily viewing and manipulating the
 outline structure.  The simplest of these commands is @key{TAB}
@@ -1373,17 +1373,17 @@ of its direct children, if any, and (iii) showing the entire subtree.
 If invoked in a body line, the global binding for @key{TAB} is
 executed.
 
-@kindex S-@key{TAB} @r{(Org Mode)}
+@kindex S-TAB @r{(Org Mode)}
 @findex org-shifttab
   Typing @kbd{S-@key{TAB}} (@code{org-shifttab}) anywhere in an Org mode
 buffer cycles the visibility of the entire outline structure, between
 (i) showing only top-level heading lines, (ii) showing all heading
 lines but no body lines, and (iii) showing everything.
 
-@kindex M-@key{UP} @r{(Org Mode)}
-@kindex M-@key{DOWN} @r{(Org Mode)}
-@kindex M-@key{LEFT} @r{(Org Mode)}
-@kindex M-@key{RIGHT} @r{(Org Mode)}
+@kindex M-UP @r{(Org Mode)}
+@kindex M-DOWN @r{(Org Mode)}
+@kindex M-LEFT @r{(Org Mode)}
+@kindex M-RIGHT @r{(Org Mode)}
 @findex org-metaup
 @findex org-metadown
 @findex org-metaleft
@@ -1862,7 +1862,7 @@ in a local variable list in each of the subfiles.  @xref{File
 Variables}.
 
 @findex tex-bibtex-file
-@kindex C-c @key{TAB} @r{(@TeX{} mode)}
+@kindex C-c TAB @r{(@TeX{} mode)}
 @vindex tex-bibtex-command
   For @LaTeX{} files, you can use Bib@TeX{} to process the auxiliary
 file for the current buffer's file.  Bib@TeX{} looks up bibliographic
@@ -2005,7 +2005,7 @@ Run a shell command (which you must specify) to validate the current
 buffer as SGML (@code{sgml-validate}).
 
 @item C-c @key{TAB}
-@kindex C-c @key{TAB} @r{(SGML mode)}
+@kindex C-c TAB @r{(SGML mode)}
 @findex sgml-tags-invisible
 Toggle the visibility of existing tags in the buffer.  This can be
 used as a cheap preview (@code{sgml-tags-invisible}).
@@ -2318,7 +2318,7 @@ These margins also affect fill commands such as @kbd{M-q}
 for specifying indentation:
 
 @table @code
-@kindex C-x @key{TAB} @r{(Enriched mode)}
+@kindex C-x TAB @r{(Enriched mode)}
 @findex increase-left-margin
 @item Indent More
 Indent the region by 4 columns (@code{increase-left-margin}).  In
@@ -2858,7 +2858,7 @@ buffer.  There are three ways to enter two-column mode:
 
 @table @asis
 @item @kbd{@key{F2} 2} or @kbd{C-x 6 2}
-@kindex @key{F2} 2
+@kindex F2 2
 @kindex C-x 6 2
 @findex 2C-two-columns
 Enter two-column mode with the current buffer on the left, and on the
@@ -2871,7 +2871,7 @@ This command is appropriate when the current buffer is empty or contains
 just one column and you want to add another column.
 
 @item @kbd{@key{F2} s} or @kbd{C-x 6 s}
-@kindex @key{F2} s
+@kindex F2 s
 @kindex C-x 6 s
 @findex 2C-split
 Split the current buffer, which contains two-column text, into two
@@ -2886,7 +2886,7 @@ two-column text, and you wish to separate the columns temporarily.
 
 @item @kbd{@key{F2} b @var{buffer} @key{RET}}
 @itemx @kbd{C-x 6 b @var{buffer} @key{RET}}
-@kindex @key{F2} b
+@kindex F2 b
 @kindex C-x 6 b
 @findex 2C-associate-buffer
 Enter two-column mode using the current buffer as the left-hand buffer,
@@ -2910,15 +2910,15 @@ way to write a line that spans both columns while in two-column
 mode: write it in the left-hand buffer, and put an empty line in the
 right-hand buffer.)
 
-@kindex @key{F2} @key{RET}
-@kindex C-x 6 @key{RET}
+@kindex F2 RET
+@kindex C-x 6 RET
 @findex 2C-newline
   The command @kbd{C-x 6 @key{RET}} or @kbd{@key{F2} @key{RET}}
 (@code{2C-newline}) inserts a newline in each of the two buffers at
 corresponding positions.  This is the easiest way to add a new line to
 the two-column text while editing it in split buffers.
 
-@kindex @key{F2} 1
+@kindex F2 1
 @kindex C-x 6 1
 @findex 2C-merge
   When you have edited both buffers as you wish, merge them with
@@ -2926,7 +2926,7 @@ the two-column text while editing it in split buffers.
 text from the right-hand buffer as a second column in the other buffer.
 To go back to two-column editing, use @kbd{@key{F2} s}.
 
-@kindex @key{F2} d
+@kindex F2 d
 @kindex C-x 6 d
 @findex 2C-dissociate
   Use @kbd{@key{F2} d} or @kbd{C-x 6 d} to dissociate the two buffers,
diff --git a/doc/emacs/trouble.texi b/doc/emacs/trouble.texi
index f8e96ac079..ea02bb8da8 100644
--- a/doc/emacs/trouble.texi
+++ b/doc/emacs/trouble.texi
@@ -91,7 +91,7 @@ argument, you can cancel that argument with @kbd{C-g} and remain in the
 recursive edit.
 
 @findex keyboard-escape-quit
-@kindex @key{ESC} @key{ESC} @key{ESC}
+@kindex ESC ESC ESC
   The sequence @kbd{@key{ESC} @key{ESC} @key{ESC}}
 (@code{keyboard-escape-quit}) can either quit or abort.  (We defined
 it this way because @key{ESC} means ``get out'' in many PC programs.)
diff --git a/doc/misc/calc.texi b/doc/misc/calc.texi
index a29097cfda..cd2f66d24e 100644
--- a/doc/misc/calc.texi
+++ b/doc/misc/calc.texi
@@ -9710,7 +9710,7 @@ The @kbd{C-x * x} command also turns the Calculator off, no matter which
 user interface (standard, Keypad, or Embedded) is currently active.
 It also cancels @code{calc-edit} mode if used from there.
 
-@kindex d @key{SPC}
+@kindex d SPC
 @pindex calc-refresh
 @cindex Refreshing a garbled display
 @cindex Garbled displays, refreshing
@@ -10268,7 +10268,7 @@ information is cleared whenever you give any command that adds new undo
 information, i.e., if you undo, then enter a number on the stack or make
 any other change, then it will be too late to redo.
 
-@kindex M-@key{RET}
+@kindex M-RET
 @pindex calc-last-args
 @cindex Last-arguments feature
 @cindex Arguments, restoring
@@ -11732,8 +11732,8 @@ type, such as numbers, vectors, formulas, and incomplete objects.)
 @section Stack Manipulation Commands
 
 @noindent
-@kindex @key{RET}
-@kindex @key{SPC}
+@kindex RET
+@kindex SPC
 @pindex calc-enter
 @cindex Duplicating stack entries
 To duplicate the top object on the stack, press @key{RET} or @key{SPC}
@@ -11749,7 +11749,7 @@ For example, with @samp{10 20 30} on the stack,
 @kbd{C-u - 2 @key{RET}} creates @samp{10 20 30 20}, and
 @kbd{C-u 0 @key{RET}} creates @samp{10 20 30 10 20 30}.
 
-@kindex @key{LFD}
+@kindex LFD
 @pindex calc-over
 The @key{LFD} (@code{calc-over}) command (on a key marked Line-Feed if you
 have it, else on @kbd{C-j}) is like @code{calc-enter}
@@ -11759,7 +11759,7 @@ Thus with @samp{10 20 30} on the stack, @key{LFD} and @kbd{C-u 2 @key{LFD}}
 are both equivalent to @kbd{C-u - 2 @key{RET}}, producing
 @samp{10 20 30 20}.
 
-@kindex @key{DEL}
+@kindex DEL
 @kindex C-d
 @pindex calc-pop
 @cindex Removing stack entries
@@ -11777,7 +11777,7 @@ For example, with @samp{10 20 30} on the stack,
 @kbd{C-u - 2 @key{DEL}} leaves @samp{10 30}, and
 @kbd{C-u 0 @key{DEL}} leaves an empty stack.
 
-@kindex M-@key{DEL}
+@kindex M-DEL
 @pindex calc-pop-above
 The @kbd{M-@key{DEL}} (@code{calc-pop-above}) command is to @key{DEL} what
 @key{LFD} is to @key{RET}:  It interprets the sign of the numeric
@@ -11798,7 +11798,7 @@ specified element of the stack regardless of the cursor  position.
 Similarly, @key{DEL} will remove the corresponding elements from the
 stack.
 
-@kindex @key{TAB}
+@kindex TAB
 @pindex calc-roll-down
 To exchange the top two elements of the stack, press @key{TAB}
 (@code{calc-roll-down}).  Given a positive numeric prefix argument, the
@@ -11812,7 +11812,7 @@ For example, with @samp{10 20 30 40 50} on the stack,
 @kbd{C-u - 2 @key{TAB}} creates @samp{40 50 10 20 30}, and
 @kbd{C-u 0 @key{TAB}} creates @samp{50 40 30 20 10}.
 
-@kindex M-@key{TAB}
+@kindex M-TAB
 @pindex calc-roll-up
 The command @kbd{M-@key{TAB}} (@code{calc-roll-up}) is analogous to @key{TAB}
 except that it rotates upward instead of downward.  Also, the default
@@ -13075,7 +13075,7 @@ refresh the stack to leave the stack display alone.  The word ``Dirty''
 will appear in the mode line when Calc thinks the stack display may not
 reflect the latest mode settings.
 
-@kindex d @key{RET}
+@kindex d RET
 @pindex calc-refresh-top
 The @kbd{d @key{RET}} (@code{calc-refresh-top}) command reformats the
 top stack entry according to all the current modes.  Positive prefix
@@ -21942,7 +21942,7 @@ If you select an element of a vector and press @key{DEL}, that
 element is deleted from the vector.  If you delete one side of
 an equation or inequality, only the opposite side remains.
 
-@kindex j @key{DEL}
+@kindex j DEL
 @pindex calc-del-selection
 The @kbd{j @key{DEL}} (@code{calc-del-selection}) command is like
 @key{DEL} but with the auto-selecting behavior of @kbd{j '} and
@@ -21950,7 +21950,7 @@ The @kbd{j @key{DEL}} (@code{calc-del-selection}) command is like
 indicated by the cursor, or, in the absence of a selection, it
 deletes the sub-formula indicated by the cursor position.
 
-@kindex j @key{RET}
+@kindex j RET
 @pindex calc-grab-selection
 (There is also an auto-selecting @kbd{j @key{RET}} (@code{calc-copy-selection})
 command.)
diff --git a/doc/misc/cc-mode.texi b/doc/misc/cc-mode.texi
index 438919b2d8..52cd97bca6 100644
--- a/doc/misc/cc-mode.texi
+++ b/doc/misc/cc-mode.texi
@@ -671,7 +671,7 @@ These commands indent code:
 
 @table @asis
 @item @kbd{@key{TAB}} (@code{c-indent-command})
-@kindex @key{TAB}
+@kindex TAB
 @findex c-indent-command
 @findex indent-command @r{(c-)}
 This command indents the current line.  That is all you need to know
@@ -1518,7 +1518,7 @@ deletion.
 
 @table @asis
 @item @kbd{@key{DEL}} (@code{c-electric-backspace})
-@kindex @key{DEL}
+@kindex DEL
 @findex c-electric-backspace
 @findex electric-backspace @r{(c-)}
 This command is run by default when you hit the @kbd{@key{DEL}} key.  When
@@ -1567,10 +1567,10 @@ rather than using the minor mode toggling.
 
 @table @asis
 @item @kbd{C-c C-@key{DEL}}, or @kbd{C-c @key{DEL}} (@code{c-hungry-delete-backwards})@footnote{This command was formerly known as @code{c-hungry-backspace}.}
-@kindex C-c C-@key{Backspace}
-@kindex C-c @key{Backspace}
-@kindex C-c C-@key{DEL}
-@kindex C-c @key{DEL}
+@kindex C-c C-Backspace
+@kindex C-c Backspace
+@kindex C-c C-DEL
+@kindex C-c DEL
 @findex c-hungry-delete-backwards
 @findex hungry-delete-backwards @r{(c-)}
 Delete any amount of whitespace in the backwards direction (regardless
@@ -1581,8 +1581,8 @@ a character terminal.
 
 @item @kbd{C-c C-d}, @kbd{C-c C-@key{DELETE}}, or @kbd{C-c @key{DELETE}} (@code{c-hungry-delete-forward})
 @kindex C-c C-d
-@kindex C-c C-@key{Delete}
-@kindex C-c @key{Delete}
+@kindex C-c C-Delete
+@kindex C-c Delete
 @findex c-hungry-delete-forward
 @findex hungry-delete-forward @r{(c-)}
 Delete any amount of whitespace in the forward direction (regardless
@@ -1592,8 +1592,8 @@ same reason as for @key{DEL} above.
 @end table
 @end table
 
-@kindex @key{Delete}
-@kindex @key{Backspace}
+@kindex Delete
+@kindex Backspace
 
 When we talk about @kbd{@key{DEL}}, and @kbd{@key{Delete}} above, we
 actually do so without connecting them to the physical keys commonly
@@ -7248,7 +7248,7 @@ early on:
 Set the variable @code{c-basic-offset}.  @xref{Getting Started}.
 
 @item
-@kindex @key{RET}
+@kindex RET
 @kindex C-j
 @emph{Why does/doesn't the @kbd{@key{RET}} key indent the new line?}
 
diff --git a/doc/misc/ediff.texi b/doc/misc/ediff.texi
index 86b93056d1..8ffa90fb5b 100644
--- a/doc/misc/ediff.texi
+++ b/doc/misc/ediff.texi
@@ -543,12 +543,12 @@ The command @kbd{rb} undoes this.
 @item p
 @itemx @key{DEL}
 @kindex p
-@kindex @key{DEL}
+@kindex DEL
 Makes the previous difference region current.
 @item n
 @itemx @key{SPC}
 @kindex n
-@kindex @key{SPC}
+@kindex SPC
 Makes the next difference region current.
 
 @item j
diff --git a/doc/misc/ert.texi b/doc/misc/ert.texi
index 3929e102a6..82e0e27ed1 100644
--- a/doc/misc/ert.texi
+++ b/doc/misc/ert.texi
@@ -260,8 +260,8 @@ unexpected result.  In the example above, there are two failures, both
 due to failed @code{should} forms.  @xref{Understanding Explanations},
 for more details.
 
-@kindex @key{TAB}@r{, in ert results buffer}
-@kindex S-@key{TAB}@r{, in ert results buffer}
+@kindex TAB@r{, in ert results buffer}
+@kindex S-TAB@r{, in ert results buffer}
 In the ERT results buffer, @kbd{@key{TAB}} and @kbd{S-@key{TAB}} cycle between
 buttons.  Each name of a function or macro in this buffer is a button;
 moving point to it and typing @kbd{@key{RET}} jumps to its definition.
diff --git a/doc/misc/eww.texi b/doc/misc/eww.texi
index 0b1fb6598b..43adc2eda0 100644
--- a/doc/misc/eww.texi
+++ b/doc/misc/eww.texi
@@ -98,7 +98,7 @@ web page hit @kbd{g} (@code{eww-reload}).  Pressing @kbd{w}
 (@code{eww-copy-page-url}) will copy the current URL to the kill ring.
 
 @findex eww-open-in-new-buffer
-@kindex M-@key{RET}
+@kindex M-RET
   The @kbd{M-@key{RET}} command (@code{eww-open-in-new-buffer}) opens the
 URL at point in a new EWW buffer, akin to opening a link in a new
 ``tab'' in other browsers.
diff --git a/doc/misc/forms.texi b/doc/misc/forms.texi
index 41847dfcff..70463419e8 100644
--- a/doc/misc/forms.texi
+++ b/doc/misc/forms.texi
@@ -226,9 +226,9 @@ Jump to the last record (@code{forms-last-record}).  This command also
 recalculates the number of records in the data file.
 
 @findex forms-next-field
-@kindex @key{TAB}
+@kindex TAB
 @item @key{TAB}
-@kindex C-c @key{TAB}
+@kindex C-c TAB
 @itemx C-c @key{TAB}
 Jump to the next field in the current record (@code{forms-next-field}).
 With a numeric argument @var{n}, jump forward @var{n} fields.  If this command
@@ -263,14 +263,14 @@ prompted for confirmation before the record is deleted unless a numeric
 argument has been provided.
 
 @findex forms-search-forward
-@kindex C-c C-s @var{regexp} @key{RET}
+@kindex C-c C-s @var{regexp} RET
 @item C-c C-s @var{regexp} @key{RET}
 Search forward for @var{regexp} in all records following this one
 (@code{forms-search-forward}).  If found, this record is shown.
 If you give an empty argument, the previous regexp is used again.
 
 @findex forms-search-backward
-@kindex C-c C-r @var{regexp} @key{RET}
+@kindex C-c C-r @var{regexp} RET
 @item C-c C-r @var{regexp} @key{RET}
 Search backward for @var{regexp} in all records following this one
 (@code{forms-search-backward}).  If found, this record is shown.
@@ -334,23 +334,23 @@ The following function key definitions are set up in Forms mode
 (whether read-only or not):
 
 @table @kbd
-@kindex @key{NEXT}
+@kindex NEXT
 @item @key{NEXT}
 forms-next-record
 
-@kindex @key{PRIOR}
+@kindex PRIOR
 @item @key{PRIOR}
 forms-prev-record
 
-@kindex @key{BEGIN}
+@kindex BEGIN
 @item @key{BEGIN}
 forms-first-record
 
-@kindex @key{END}
+@kindex END
 @item @key{END}
 forms-last-record
 
-@kindex S-@key{TAB}
+@kindex S-TAB
 @findex forms-prev-field
 @item S-@key{TAB}
 forms-prev-field
diff --git a/doc/misc/gnus.texi b/doc/misc/gnus.texi
index 0d51240adb..8a0b631936 100644
--- a/doc/misc/gnus.texi
+++ b/doc/misc/gnus.texi
@@ -1991,7 +1991,7 @@ Go to the next group that has unread articles
 
 @item p
 @itemx @key{DEL}
-@kindex @key{DEL} @r{(Group)}
+@kindex DEL @r{(Group)}
 @kindex p @r{(Group)}
 @findex gnus-group-prev-unread-group
 Go to the previous group that has unread articles
@@ -2063,7 +2063,7 @@ Otherwise, the point is set to the group just exited.  The default is
 @table @kbd
 
 @item @key{SPC}
-@kindex @key{SPC} @r{(Group)}
+@kindex SPC @r{(Group)}
 @findex gnus-group-read-group
 Select the current group, switch to the summary buffer and display the
 first unread article (@code{gnus-group-read-group}).  If there are no
@@ -2083,7 +2083,7 @@ When you are in the group (in the Summary buffer), you can type
 ones.
 
 @item @key{RET}
-@kindex @key{RET} @r{(Group)}
+@kindex RET @r{(Group)}
 @findex gnus-group-select-group
 Select the current group and switch to the summary buffer
 (@code{gnus-group-select-group}).  Takes the same arguments as
@@ -2092,7 +2092,7 @@ does not display the first unread article automatically upon group
 entry.
 
 @item M-@key{RET}
-@kindex M-@key{RET} @r{(Group)}
+@kindex M-RET @r{(Group)}
 @findex gnus-group-quick-select-group
 This does the same as the command above, but tries to do it with the
 minimum amount of fuzz (@code{gnus-group-quick-select-group}).  No
@@ -2104,14 +2104,14 @@ which is useful if you want to toggle threading before generating the
 summary buffer (@pxref{Summary Generation Commands}).
 
 @item M-@key{SPC}
-@kindex M-@key{SPC} @r{(Group)}
+@kindex M-SPC @r{(Group)}
 @findex gnus-group-visible-select-group
 This is yet one more command that does the same as the @kbd{@key{RET}}
 command, but this one does it without expunging and hiding dormants
 (@code{gnus-group-visible-select-group}).
 
 @item C-M-@key{RET}
-@kindex C-M-@key{RET} @r{(Group)}
+@kindex C-M-RET @r{(Group)}
 @findex gnus-group-select-group-ephemerally
 Finally, this command selects the current group ephemerally without
 doing any processing of its contents
@@ -2659,7 +2659,7 @@ Make a group based on an @acronym{RSS} feed
 @xref{RSS}.
 
 @item G @key{DEL}
-@kindex G @key{DEL} @r{(Group)}
+@kindex G DEL @r{(Group)}
 @findex gnus-group-delete-group
 This function will delete the current group
 (@code{gnus-group-delete-group}).  If given a prefix, this function will
@@ -3617,13 +3617,13 @@ Go to the next group (@code{gnus-group-next-group}).
 Go to the previous group (@code{gnus-group-prev-group}).
 
 @item @key{SPC}
-@kindex @key{SPC} @r{(Browse)}
+@kindex SPC @r{(Browse)}
 @findex gnus-browse-read-group
 Enter the current group and display the first article
 (@code{gnus-browse-read-group}).
 
 @item @key{RET}
-@kindex @key{RET} @r{(Browse)}
+@kindex RET @r{(Browse)}
 @findex gnus-browse-select-group
 Enter the current group (@code{gnus-browse-select-group}).
 
@@ -3656,7 +3656,7 @@ Describe browse mode briefly (well, there's not much to describe, is
 there) (@code{gnus-browse-describe-briefly}).
 
 @item @key{DEL}
-@kindex @key{DEL} @r{(Browse)}
+@kindex DEL @r{(Browse)}
 @findex gnus-browse-delete-group
 This function will delete the current group
 (@code{gnus-browse-delete-group}).  If given a prefix, this function
@@ -3802,15 +3802,15 @@ Prompt for a new topic name and create it
 
 @item T @key{TAB}
 @itemx @key{TAB}
-@kindex T @key{TAB} @r{(Topic)}
-@kindex @key{TAB} @r{(Topic)}
+@kindex T TAB @r{(Topic)}
+@kindex TAB @r{(Topic)}
 @findex gnus-topic-indent
 ``Indent'' the current topic so that it becomes a sub-topic of the
 previous topic (@code{gnus-topic-indent}).  If given a prefix,
 ``un-indent'' the topic instead.
 
 @item M-@key{TAB}
-@kindex M-@key{TAB} @r{(Topic)}
+@kindex M-TAB @r{(Topic)}
 @findex gnus-topic-unindent
 ``Un-indent'' the current topic so that it becomes a sub-topic of the
 parent of its current parent (@code{gnus-topic-unindent}).
@@ -3855,7 +3855,7 @@ key.
 @table @kbd
 
 @item @key{RET}
-@kindex @key{RET} @r{(Topic)}
+@kindex RET @r{(Topic)}
 @findex gnus-topic-select-group
 @itemx @key{SPC}
 Either select a group or fold a topic (@code{gnus-topic-select-group}).
@@ -3962,7 +3962,7 @@ expiry process (if any)
 Rename a topic (@code{gnus-topic-rename}).
 
 @item T @key{DEL}
-@kindex T @key{DEL} @r{(Topic)}
+@kindex T DEL @r{(Topic)}
 @findex gnus-topic-delete
 Delete an empty topic (@code{gnus-topic-delete}).
 
@@ -5301,7 +5301,7 @@ If you want to fetch new articles or redisplay the group, see
 
 @table @kbd
 @item @key{SPC}
-@kindex @key{SPC} @r{(Summary)}
+@kindex SPC @r{(Summary)}
 @findex gnus-summary-next-page
 Select the current article, or, if that one's read already, the next
 unread article (@code{gnus-summary-next-page}).
@@ -5443,7 +5443,7 @@ instead.  It will leave marks like @code{gnus-low-score-mark},
 @table @kbd
 
 @item @key{SPC}
-@kindex @key{SPC} @r{(Summary)}
+@kindex SPC @r{(Summary)}
 @findex gnus-summary-next-page
 Pressing @kbd{@key{SPC}} will scroll the current article forward one page,
 or, if you have come to the end of the current article, will choose the
@@ -5459,18 +5459,18 @@ what is considered uninteresting with
 pages, no matter how boring, using @kbd{C-M-v}.
 
 @item @key{DEL}
-@kindex @key{DEL} @r{(Summary)}
+@kindex DEL @r{(Summary)}
 @findex gnus-summary-prev-page
 Scroll the current article back one page (@code{gnus-summary-prev-page}).
 
 @item @key{RET}
-@kindex @key{RET} @r{(Summary)}
+@kindex RET @r{(Summary)}
 @findex gnus-summary-scroll-up
 Scroll the current article one line forward
 (@code{gnus-summary-scroll-up}).
 
 @item M-@key{RET}
-@kindex M-@key{RET} @r{(Summary)}
+@kindex M-RET @r{(Summary)}
 @findex gnus-summary-scroll-down
 Scroll the current article one line backward
 (@code{gnus-summary-scroll-down}).
@@ -7282,7 +7282,7 @@ understand the numeric prefix.
 @itemx C-M-f
 @kindex C-M-n @r{(Summary)}
 @itemx M-@key{DOWN}
-@kindex M-@key{DOWN} @r{(Summary)}
+@kindex M-DOWN @r{(Summary)}
 @findex gnus-summary-next-thread
 Go to the next thread (@code{gnus-summary-next-thread}).
 
@@ -7291,7 +7291,7 @@ Go to the next thread (@code{gnus-summary-next-thread}).
 @itemx C-M-b
 @kindex C-M-p @r{(Summary)}
 @itemx M-@key{UP}
-@kindex M-@key{UP} @r{(Summary)}
+@kindex M-UP @r{(Summary)}
 @findex gnus-summary-prev-thread
 Go to the previous thread (@code{gnus-summary-prev-thread}).
 
@@ -10366,7 +10366,7 @@ thread or article and pick it.  (The line number is normally displayed
 at the beginning of the summary pick lines.)
 
 @item @key{SPC}
-@kindex @key{SPC} @r{(Pick)}
+@kindex SPC @r{(Pick)}
 @findex gnus-pick-next-page
 Scroll the summary buffer up one page (@code{gnus-pick-next-page}).  If
 at the end of the buffer, start reading the picked articles.
@@ -10382,7 +10382,7 @@ just the article.  You can give this key a numerical prefix to unpick
 the thread or article at that line.
 
 @item @key{RET}
-@kindex @key{RET} @r{(Pick)}
+@kindex RET @r{(Pick)}
 @findex gnus-pick-start-reading
 @vindex gnus-pick-display-summary
 Start reading the picked articles (@code{gnus-pick-start-reading}).  If
@@ -10624,7 +10624,7 @@ articles eligible for expiry in the current group will
 disappear forever into that big @file{/dev/null} in the sky.
 
 @item B @key{DEL}
-@kindex B @key{DEL} @r{(Summary)}
+@kindex B DEL @r{(Summary)}
 @cindex deleting mail
 @findex gnus-summary-delete-article
 @c @icon{gnus-summary-mail-delete}
@@ -11623,7 +11623,7 @@ The following commands are available when you have placed point over a
 @table @kbd
 @findex gnus-article-press-button
 @item @key{RET} (Article)
-@kindex @key{RET} @r{(Article)}
+@kindex RET @r{(Article)}
 @itemx @key{BUTTON-2} (Article)
 Toggle displaying of the @acronym{MIME} object
 (@code{gnus-article-press-button}).  If built-in viewers can not display
@@ -11633,7 +11633,7 @@ object is displayed inline.
 
 @findex gnus-mime-view-part
 @item M-@key{RET} (Article)
-@kindex M-@key{RET} @r{(Article)}
+@kindex M-RET @r{(Article)}
 @itemx v (Article)
 Prompt for a method, and then view the @acronym{MIME} object using this
 method (@code{gnus-mime-view-part}).
@@ -12133,13 +12133,13 @@ A few additional keystrokes are available:
 @table @kbd
 
 @item @key{SPC}
-@kindex @key{SPC} @r{(Article)}
+@kindex SPC @r{(Article)}
 @findex gnus-article-next-page
 Scroll forwards one page (@code{gnus-article-next-page}).
 This is exactly the same as @kbd{h @key{SPC} h}.
 
 @item @key{DEL}
-@kindex @key{DEL} @r{(Article)}
+@kindex DEL @r{(Article)}
 @findex gnus-article-prev-page
 Scroll backwards one page (@code{gnus-article-prev-page}).
 This is exactly the same as @kbd{h @key{DEL} h}.
@@ -12170,13 +12170,13 @@ Give a very brief description of the available keystrokes
 (@code{gnus-article-describe-briefly}).
 
 @item @key{TAB}
-@kindex @key{TAB} @r{(Article)}
+@kindex TAB @r{(Article)}
 @findex gnus-article-next-button
 Go to the next button, if any (@code{gnus-article-next-button}).  This
 only makes sense if you have buttonizing turned on.
 
 @item M-@key{TAB}
-@kindex M-@key{TAB} @r{(Article)}
+@kindex M-TAB @r{(Article)}
 @findex gnus-article-prev-button
 Go to the previous button, if any (@code{gnus-article-prev-button}).
 
@@ -13238,7 +13238,7 @@ Edit a server (@code{gnus-server-edit-server}).
 Show the definition of a server (@code{gnus-server-show-server}).
 
 @item @key{SPC}
-@kindex @key{SPC} @r{(Server)}
+@kindex SPC @r{(Server)}
 @findex gnus-server-read-server
 Browse the current server (@code{gnus-server-read-server}).
 
diff --git a/doc/misc/idlwave.texi b/doc/misc/idlwave.texi
index e1a6eb66f5..44a3831b1c 100644
--- a/doc/misc/idlwave.texi
+++ b/doc/misc/idlwave.texi
@@ -935,7 +935,7 @@ IDL code.
 @cindex String splitting
 @cindex Splitting, of lines
 
-@kindex M-@key{RET}
+@kindex M-RET
 In IDL, a newline character terminates a statement unless preceded by a
 @samp{$}.  If you would like to start a continuation line, use
 @kbd{M-@key{RET}}, which calls the command @code{idlwave-split-line}.
@@ -1523,7 +1523,7 @@ The case-insensitive heading word in doclib headers to locate the
 @cindex Function name completion
 @cindex Procedure name completion
 
-@kindex M-@key{TAB}
+@kindex M-TAB
 @kindex C-c C-i
 IDLWAVE offers completion for class names, routine names, keywords,
 system variables, system variable tags, class structure tags, regular
diff --git a/doc/misc/info.texi b/doc/misc/info.texi
index c617468f57..964a6c6912 100644
--- a/doc/misc/info.texi
+++ b/doc/misc/info.texi
@@ -311,9 +311,9 @@ You can tell that there is more that is not visible because you
 can see the text @samp{Top} rather than @samp{All} near the bottom of
 the screen.
 
-@kindex @key{SPC} @r{(Info mode)}
-@kindex @key{DEL} @r{(Info mode)}
-@kindex @key{BACKSPACE} @r{(Info mode)}
+@kindex SPC @r{(Info mode)}
+@kindex DEL @r{(Info mode)}
+@kindex BACKSPACE @r{(Info mode)}
 @findex Info-scroll-up
 @findex Info-scroll-down
   The @key{SPC}, @key{BACKSPACE} (or @key{DEL})@footnote{The key which
@@ -363,8 +363,8 @@ the menu, one by one.  Once you reach the end of a node, and have seen
 all of its subnodes, @key{SPC} takes you to the next node or to the
 parent's next node.
 
-@kindex @key{PAGEUP} @r{(Info mode)}
-@kindex @key{PAGEDOWN} @r{(Info mode)}
+@kindex PAGEUP @r{(Info mode)}
+@kindex PAGEDOWN @r{(Info mode)}
   Many keyboards nowadays have two scroll keys labeled @samp{PageUp}
 and @samp{PageDown} (or maybe @samp{Prior} and @samp{Next}).  If your
 keyboard has these keys, you can use them to move forward and backward
diff --git a/doc/misc/message.texi b/doc/misc/message.texi
index 481bd3239c..e614285dc8 100644
--- a/doc/misc/message.texi
+++ b/doc/misc/message.texi
@@ -1378,7 +1378,7 @@ Delete all text in the body of the message that is outside the region
 (@code{message-delete-not-region}).
 
 @item M-@key{RET}
-@kindex M-@key{RET}
+@kindex M-RET
 @findex message-newline-and-reformat
 Insert four newlines, and then reformat if inside quoted text.
 
@@ -1407,7 +1407,7 @@ Rename the buffer (@code{message-rename-buffer}).  If given a prefix,
 prompt for a new buffer name.
 
 @item @key{TAB}
-@kindex @key{TAB}
+@kindex TAB
 @findex message-tab
 @vindex message-tab-body-function
 If @code{message-tab-body-function} is non-@code{nil}, execute the
diff --git a/doc/misc/mh-e.texi b/doc/misc/mh-e.texi
index efb44e4b64..68d8b210ab 100644
--- a/doc/misc/mh-e.texi
+++ b/doc/misc/mh-e.texi
@@ -442,7 +442,7 @@ either @code{customize-option} or @code{add-hook}.
 @cindex point
 @cindex region
 @kindex C-@@
-@kindex C-@key{SPC}
+@kindex C-SPC
 
 There are several other terms that are used in Emacs that you should
 know. The @dfn{point} is where the cursor currently is. You can save
@@ -461,8 +461,8 @@ filling paragraphs. A mark can be set with @kbd{C-@@} (or
 @cindex file completion
 @cindex folder completion
 @cindex minibuffer
-@kindex @key{SPC}
-@kindex @key{TAB}
+@kindex SPC
+@kindex TAB
 
 The @dfn{minibuffer} is the bottom line of the Emacs window, where all
 prompting and multiple-character input is directed. You can use
@@ -787,7 +787,7 @@ use @kbd{F r} to pull all your messages into MH-E.
 @end quotation
 @sp 1
 
-@kindex @key{RET}
+@kindex RET
 @kindex n
 @kindex p
 
@@ -817,8 +817,8 @@ This is a test message to get the wheels churning...
 @end cartouche
 @i{After incorporating new messages}
 
-@kindex @key{DEL}
-@kindex @key{SPC}
+@kindex DEL
+@kindex SPC
 
 If you typed a long message, you can view subsequent pages with
 @key{SPC} and previous pages with @key{DEL}.
@@ -827,7 +827,7 @@ If you typed a long message, you can view subsequent pages with
 @section Processing Mail
 
 @cindex processing mail
-@kindex @key{RET}
+@kindex RET
 @kindex r
 
 The first thing we want to do is reply to the message that we sent
@@ -880,7 +880,7 @@ Type C-c C-c to send message, C-c ? for help
 @kindex C-f
 @kindex C-n
 @kindex C-p
-@kindex @key{BS}
+@kindex BS
 
 By default, MH will not add you to the address list of your replies,
 so if you find that the @samp{To:} header field is missing, don't
@@ -895,7 +895,7 @@ editing your message, send it with @kbd{C-c C-c} as before.
 @cindex @command{refile}
 @cindex MH commands, @command{refile}
 @cindex folders
-@kindex @key{SPC}
+@kindex SPC
 @kindex o
 
 You'll often want to save messages that were sent to you in an
@@ -915,7 +915,7 @@ in a moment.
 @cindex modes, MH-Folder
 @kindex d
 @kindex i
-@kindex @key{RET}
+@kindex RET
 @kindex n
 @kindex p
 @kindex x
@@ -1586,7 +1586,7 @@ Display cheat sheet for the MH-E commands (@code{mh-help}).
 @c -------------------------
 @cindex @samp{Message > Show Message} menu item
 @cindex menu item, @samp{Message > Show Message}
-@kindex @key{RET}
+@kindex RET
 @findex mh-show
 @item @key{RET}
 Display message (@code{mh-show}).
@@ -1612,12 +1612,12 @@ Display message with the default preferred alternative
 Toggle the value of @code{mh-decode-mime-flag}
 (@code{mh-toggle-mh-decode-mime-flag}).
 @c -------------------------
-@kindex @key{SPC}
+@kindex SPC
 @findex mh-page-msg
 @item @key{SPC}
 Display next page in message (@code{mh-page-msg}).
 @c -------------------------
-@kindex @key{BS}
+@kindex BS
 @findex mh-previous-page
 @item @key{BS}
 Display previous page in message (@code{mh-previous-page}).
@@ -1655,12 +1655,12 @@ Delete range (@code{mh-delete-msg}).
 Display cheat sheet for the commands of the current prefix in
 minibuffer (@code{mh-prefix-help}).
 @c -------------------------
-@kindex D @key{SPC}
+@kindex D SPC
 @findex mh-page-digest
 @item D @key{SPC}
 Display next message in digest (@code{mh-page-digest}).
 @c -------------------------
-@kindex D @key{BS}
+@kindex D BS
 @findex mh-page-digest-backwards
 @item D @key{BS}
 Display previous message in digest (@code{mh-page-digest-backwards}).
@@ -1691,12 +1691,12 @@ Delete messages with same subject or thread
 Display cheat sheet for the commands of the current prefix in
 minibuffer (@code{mh-prefix-help}).
 @c -------------------------
-@kindex K @key{TAB}
+@kindex K TAB
 @findex mh-next-button
 @item K @key{TAB}
 Go to the next button (@code{mh-next-button}).
 @c -------------------------
-@kindex K S-@key{TAB}
+@kindex K S-TAB
 @findex mh-prev-button
 @item K S-@key{TAB}
 Go to the previous button (@code{mh-prev-button}).
@@ -1838,7 +1838,7 @@ Move point to mouse event and show message (@code{mh-show-mouse}).
 Within the MH-Show buffer, the following command is defined.
 
 @table @kbd
-@kindex @key{RET}
+@kindex RET
 @kindex mouse-1
 @kindex mouse-2
 @findex mh-press-button
@@ -2013,9 +2013,9 @@ detail in the following sections.
 @findex mh-show-mouse
 @kindex , @r{(comma)}
 @kindex . @r{(period)}
-@kindex @key{BS}
-@kindex @key{RET}
-@kindex @key{SPC}
+@kindex BS
+@kindex RET
+@kindex SPC
 @kindex mouse-2
 
 The command @key{RET} (@code{mh-show}) displays the message that the
@@ -2194,7 +2194,7 @@ highlighting of citations entirely, choose @samp{None}.
 @cindex highlighting email addresses
 @cindex links, following
 @findex goto-address-at-point
-@kindex C-c @key{RET}
+@kindex C-c RET
 @kindex mouse-2
 @vindex goto-address-highlight-p
 
@@ -2328,9 +2328,9 @@ Attachments in MH-E are indicated by @dfn{buttons} like this:
 @findex mh-next-button
 @findex mh-press-button
 @findex mh-prev-button
-@kindex @key{RET}
-@kindex K @key{TAB}
-@kindex K S-@key{TAB}
+@kindex RET
+@kindex K TAB
+@kindex K S-TAB
 @kindex mouse-1
 @kindex mouse-2
 
@@ -2682,10 +2682,10 @@ buffer, including HTML buffers.
 @cindex digests
 @findex mh-page-digest
 @findex mh-page-digest-backwards
-@kindex D @key{BS}
-@kindex D @key{SPC}
-@kindex @key{BS}
-@kindex @key{SPC}
+@kindex D BS
+@kindex D SPC
+@kindex BS
+@kindex SPC
 
 A digest is a message that contains other messages. Special MH-E
 commands let you read digests conveniently. You can use @key{SPC} and
@@ -2989,7 +2989,7 @@ like to change the initial default directory, customize the option
 directory for storing the content of these messages.
 
 @findex mh-store-buffer
-@kindex @key{RET}
+@kindex RET
 @kindex X s
 
 By the way, @kbd{X s} calls the Emacs Lisp function
@@ -3039,7 +3039,7 @@ message with @kbd{M-<} (@code{mh-first-msg}) and @kbd{M->}
 @findex previous-line
 @kindex C-n
 @kindex C-p
-@kindex @key{RET}
+@kindex RET
 
 You can also use the Emacs commands @kbd{C-p} (@code{previous-line})
 and @kbd{C-n} (@code{next-line}) to move up and down the scan lines in
@@ -3740,7 +3740,7 @@ The command @kbd{F p} runs @code{mh-pack-folder-hook} after
 renumbering the messages. A variable that is useful with this hook
 is @code{mh-current-folder}.
 
-@kindex @key{TAB}
+@kindex TAB
 @vindex mh-recursive-folders-flag
 
 By default, operations on folders work only one level at a time. Set
@@ -4381,12 +4381,12 @@ commands in addition to the normal Emacs editing commands to help you
 edit your draft. These can also be found in the @samp{Letter} menu.
 
 @table @kbd
-@kindex @key{SPC}
+@kindex SPC
 @findex mh-letter-complete-or-space
 @item @key{SPC}
 Perform completion or insert space (@code{mh-letter-complete-or-space}).
 @c -------------------------
-@kindex M-@key{TAB}
+@kindex M-TAB
 @findex mh-letter-complete
 @item M-@key{TAB}
 Perform completion on header field or word preceding point
@@ -4397,12 +4397,12 @@ Perform completion on header field or word preceding point
 @item , (comma)
 Flash alias expansion (@code{mh-letter-confirm-address}).
 @c -------------------------
-@kindex @key{TAB}
+@kindex TAB
 @findex mh-letter-next-header-field-or-indent
 @item @key{TAB}
 Cycle to next field (@code{mh-letter-next-header-field-or-indent}).
 @c -------------------------
-@kindex S-@key{TAB}
+@kindex S-TAB
 @findex mh-letter-previous-header-field
 @item S-@key{TAB}
 Cycle to the previous header field
@@ -4807,8 +4807,8 @@ draft. @xref{Folder Selection}.
 @findex indent-relative
 @findex mh-letter-next-header-field-or-indent
 @findex mh-letter-previous-header-field
-@kindex @key{TAB}
-@kindex S-@key{TAB}
+@kindex TAB
+@kindex S-TAB
 @vindex mh-compose-skipped-header-fields
 @vindex mh-letter-header-field
 
@@ -4834,8 +4834,8 @@ take point to the last field from anywhere in the body.
 @findex mh-letter-complete-or-space
 @findex mh-letter-confirm-address
 @kindex , @r{(comma)}
-@kindex @key{SPC}
-@kindex M-@key{TAB}
+@kindex SPC
+@kindex M-TAB
 @vindex mh-alias-flash-on-comma
 @vindex mh-compose-space-does-completion-flag
 @vindex mh-letter-complete-function
@@ -5714,12 +5714,12 @@ The following commands are available in MH-Letter mode with the
 exception of @code{mh-alias-reload} which can be called from anywhere.
 
 @table @kbd
-@kindex @key{SPC}
+@kindex SPC
 @findex mh-letter-complete-or-space
 @item @key{SPC}
 Perform completion or insert space (@code{mh-letter-complete-or-space}).
 @c -------------------------
-@kindex M-@key{TAB}
+@kindex M-TAB
 @findex mh-letter-complete
 @item M-@key{TAB}
 Perform completion on header field or word preceding point
@@ -5791,7 +5791,7 @@ Hook run by @code{mh-alias-reload} after loading aliases (default:
 You can use aliases when you are adding recipients to a message.
 
 @findex minibuffer-complete
-@kindex @key{TAB}
+@kindex TAB
 @vindex mh-alias-expand-aliases-flag
 @vindex mh-compose-prompt-flag
 
@@ -5805,8 +5805,8 @@ aliases to be expanded to their respective addresses in the draft.
 
 @findex mh-letter-complete
 @findex mh-letter-complete-or-space
-@kindex @key{SPC}
-@kindex M-@key{TAB}
+@kindex SPC
+@kindex M-TAB
 
 Otherwise, you can complete aliases in the header of the draft with
 @kbd{M-@key{TAB}} (@code{mh-letter-complete}) or @key{SPC}
@@ -6607,12 +6607,12 @@ Another few commands are available in the MH-Folder buffer resulting
 from a search.
 
 @table @kbd
-@kindex @key{TAB}
+@kindex TAB
 @findex mh-index-next-folder
 @item @key{TAB}
 Jump to the next folder marker (@code{mh-index-next-folder}).
 @c -------------------------
-@kindex S-@key{TAB}
+@kindex S-TAB
 @findex mh-index-previous-folder
 @item S-@key{TAB}
 Jump to the previous folder marker (@code{mh-index-previous-folder}).
@@ -6757,8 +6757,8 @@ method with the pick method by running the command @kbd{C-c C-p}
 @cindex @samp{+mhe-index}
 @findex mh-index-next-folder
 @findex mh-index-previous-folder
-@kindex @key{TAB}
-@kindex S-@key{TAB}
+@kindex TAB
+@kindex S-TAB
 @vindex mh-search-folder
 
 The messages that are found are put in a temporary sub-folder of
diff --git a/doc/misc/newsticker.texi b/doc/misc/newsticker.texi
index b94a96d8aa..f7a28d3827 100644
--- a/doc/misc/newsticker.texi
+++ b/doc/misc/newsticker.texi
@@ -241,15 +241,15 @@ commands:
 @table @kbd
 @item M-@key{UP}
 @itemx M-@key{DOWN}
-@kindex M-@key{UP}
-@kindex M-@key{DOWN}
+@kindex M-UP
+@kindex M-DOWN
 @findex newsticker-group-shift-feed-up
 @findex newsticker-group-shift-feed-down
 Shift the currently selected feed up and down within its group.
 @item M-S-@key{UP}
 @itemx M-S-@key{DOWN}
-@kindex M-S-@key{UP}
-@kindex M-S-@key{DOWN}
+@kindex M-S-UP
+@kindex M-S-DOWN
 @findex newsticker-group-shift-group-up
 @findex newsticker-group-shift-group-down
 Shift the currently selected group up and down within its parent group.
diff --git a/doc/misc/org.texi b/doc/misc/org.texi
index e7cd07d948..e7f70e8f5c 100644
--- a/doc/misc/org.texi
+++ b/doc/misc/org.texi
@@ -1728,10 +1728,10 @@ one.
 @end table
 
 @table @kbd
-@kindex M-S-@key{RET}
+@kindex M-S-RET
 @item M-S-@key{RET}
 Insert a new item with a checkbox (@pxref{Checkboxes}).
-@kindex S-@key{DOWN}
+@kindex S-DOWN
 @item S-up
 @itemx S-down
 @cindex shift-selection-mode
@@ -1743,21 +1743,21 @@ cycle around items that way, you may customize
 @code{org-support-shift-select} is off.  If not, you can still use paragraph
 jumping commands like @kbd{C-@key{UP}} and @kbd{C-@key{DOWN}} to quite
 similar effect.
-@kindex M-@key{UP}
-@kindex M-@key{DOWN}
+@kindex M-UP
+@kindex M-DOWN
 @item M-up
 @itemx M-down
 Move the item including subitems up/down@footnote{See
 @code{org-list-use-circular-motion} for a cyclic behavior.} (swap with
 previous/next item of same indentation).  If the list is ordered, renumbering
 is automatic.
-@kindex M-@key{LEFT}
-@kindex M-@key{RIGHT}
+@kindex M-LEFT
+@kindex M-RIGHT
 @item M-left
 @itemx M-right
 Decrease/increase the indentation of an item, leaving children alone.
-@kindex M-S-@key{LEFT}
-@kindex M-S-@key{RIGHT}
+@kindex M-S-LEFT
+@kindex M-S-RIGHT
 @item M-S-@key{LEFT}
 @itemx M-S-@key{RIGHT}
 Decrease/increase the indentation of the item, including subitems.
@@ -1797,8 +1797,8 @@ its location).  @xref{Structure editing}, for a detailed explanation.
 Turn the whole plain list into a subtree of the current heading.  Checkboxes
 (@pxref{Checkboxes}) will become TODO (resp. DONE) keywords when unchecked
 (resp. checked).
-@kindex S-@key{LEFT}
-@kindex S-@key{RIGHT}
+@kindex S-LEFT
+@kindex S-RIGHT
 @item S-@key{LEFT}/@key{RIGHT}
 @vindex org-support-shift-select
 This command also cycles bullet styles when the cursor in on the bullet or
@@ -3012,10 +3012,10 @@ formula, @key{TAB} re-indents just like in Emacs Lisp mode.
 Complete Lisp symbols, just like in Emacs Lisp mode.@footnote{Many desktops
 intercept @kbd{M-@key{TAB}} to switch windows.  Use @kbd{C-M-i} or
 @kbd{@key{ESC} @key{TAB}} instead for completion (@pxref{Completion}).}
-@kindex S-@key{UP}
-@kindex S-@key{DOWN}
-@kindex S-@key{LEFT}
-@kindex S-@key{RIGHT}
+@kindex S-UP
+@kindex S-DOWN
+@kindex S-LEFT
+@kindex S-RIGHT
 @findex org-table-fedit-ref-up
 @findex org-table-fedit-ref-down
 @findex org-table-fedit-ref-left
@@ -4041,8 +4041,8 @@ completion; otherwise force cycling through TODO states with no prompt.  When
 @code{org-use-fast-todo-selection} is set to @code{prefix}, use the fast
 selection interface.
 
-@kindex S-@key{RIGHT}
-@kindex S-@key{LEFT}
+@kindex S-RIGHT
+@kindex S-LEFT
 @item S-@key{RIGHT} @ @r{/} @ S-@key{LEFT}
 @vindex org-treat-S-cursor-todo-selection-as-state-change
 Select the following/preceding TODO state, similar to cycling.  Useful
@@ -4190,8 +4190,8 @@ select the correct sequence.  Besides the obvious ways like typing a
 keyword or using completion, you may also apply the following commands:
 
 @table @kbd
-@kindex C-S-@key{RIGHT}
-@kindex C-S-@key{LEFT}
+@kindex C-S-RIGHT
+@kindex C-S-LEFT
 @kindex C-u C-u C-c C-t
 @item C-u C-u C-c C-t
 @itemx C-S-@key{RIGHT}
@@ -4201,8 +4201,8 @@ These keys jump from one TODO subset to the next.  In the above example,
 @code{DONE} to @code{REPORT}, and any of the words in the second row to
 @code{CANCELED}.  Note that the @kbd{C-S-} key binding conflict with
 @code{shift-selection-mode} (@pxref{Conflicts}).
-@kindex S-@key{RIGHT}
-@kindex S-@key{LEFT}
+@kindex S-RIGHT
+@kindex S-LEFT
 @item S-@key{RIGHT}
 @itemx S-@key{LEFT}
 @kbd{S-@key{LEFT}} and @kbd{S-@key{RIGHT}} and walk through @emph{all}
@@ -4269,7 +4269,7 @@ A setup for using several sets in parallel would be:
 @end example
 
 @cindex completion, of option keywords
-@kindex M-@key{TAB}
+@kindex M-TAB
 @noindent To make sure you are using the correct keyword, type
 @samp{#+} into the buffer and then use @kbd{M-@key{TAB}} completion.
 
@@ -4931,7 +4931,7 @@ can really speed up agenda generation.
 @cindex setting tags
 @cindex tags, setting
 
-@kindex M-@key{TAB}
+@kindex M-TAB
 Tags can simply be typed into the buffer at the end of a headline.
 After a colon, @kbd{M-@key{TAB}} offers completion on tags.  There is
 also a special command for inserting tags:
@@ -5062,17 +5062,17 @@ will turn off any other tags from that group.
 In this interface, you can also use the following special keys:
 
 @table @kbd
-@kindex @key{TAB}
+@kindex TAB
 @item @key{TAB}
 Enter a tag in the minibuffer, even if the tag is not in the predefined
 list.  You will be able to complete on all tags present in the buffer.
 You can also add several tags: just separate them with a comma.
 
-@kindex @key{SPC}
+@kindex SPC
 @item @key{SPC}
 Clear all tags for this line.
 
-@kindex @key{RET}
+@kindex RET
 @item @key{RET}
 Accept the modified set.
 
@@ -5725,8 +5725,8 @@ Exit column view.
 @tsubheading{Editing values}
 @item @key{LEFT} @key{RIGHT} @key{UP} @key{DOWN}
 Move through the column view from field to field.
-@kindex S-@key{LEFT}
-@kindex S-@key{RIGHT}
+@kindex S-LEFT
+@kindex S-RIGHT
 @item  S-@key{LEFT}/@key{RIGHT}
 Switch to the next/previous allowed value of the field.  For this, you
 have to have specified allowed values for a property.
@@ -6136,15 +6136,15 @@ from the minibuffer:
 @kindex M-v
 @kindex C-v
 @kindex mouse-1
-@kindex S-@key{RIGHT}
-@kindex S-@key{LEFT}
-@kindex S-@key{DOWN}
-@kindex S-@key{UP}
-@kindex M-S-@key{RIGHT}
-@kindex M-S-@key{LEFT}
-@kindex @key{RET}
-@kindex M-S-@key{DOWN}
-@kindex M-S-@key{UP}
+@kindex S-RIGHT
+@kindex S-LEFT
+@kindex S-DOWN
+@kindex S-UP
+@kindex M-S-RIGHT
+@kindex M-S-LEFT
+@kindex RET
+@kindex M-S-DOWN
+@kindex M-S-UP
 
 @example
 @key{RET}              @r{Choose date at cursor in calendar.}
@@ -10425,7 +10425,7 @@ details see the documentation of CD@LaTeX{} mode):
 @item
 Environment templates can be inserted with @kbd{C-c @{}.
 @item
-@kindex @key{TAB}
+@kindex TAB
 The @key{TAB} key will do template expansion if the cursor is inside a
 @LaTeX{} fragment@footnote{Org mode has a method to test if the cursor is
 inside such a fragment, see the documentation of the function
@@ -17125,9 +17125,9 @@ Active key bindings in code blocks:
 @item @kbd{C-c C-c} @tab @code{org-babel-execute-src-block}
 @kindex C-c C-o
 @item @kbd{C-c C-o} @tab @code{org-babel-open-src-block-result}
-@kindex M-@key{UP}
+@kindex M-UP
 @item @kbd{M-@key{UP}}    @tab @code{org-babel-load-in-session}
-@kindex M-@key{DOWN}
+@kindex M-DOWN
 @item @kbd{M-@key{DOWN}}  @tab @code{org-babel-switch-to-session}
 @end multitable
 
@@ -17284,7 +17284,7 @@ is involved.  Such mode-specific hot keys have become an integral part of
 Emacs and Org provides several shortcuts.
 
 @table @kbd
-@kindex M-@key{TAB}
+@kindex M-TAB
 @item M-@key{TAB}
 Complete word at point
 @itemize @bullet
diff --git a/doc/misc/pcl-cvs.texi b/doc/misc/pcl-cvs.texi
index 32c6a52487..1163530e7a 100644
--- a/doc/misc/pcl-cvs.texi
+++ b/doc/misc/pcl-cvs.texi
@@ -677,7 +677,7 @@ put in @samp{cvs-status-mode}.
 @cindex Movement Commands
 @findex cvs-mode-next-line
 @findex cvs-mode-previous-line
-@kindex @key{SPC}@r{--Move down one file}
+@kindex SPC@r{--Move down one file}
 @kindex n@r{--Move down one file}
 @kindex p@r{--Move up one file}
 
@@ -705,8 +705,8 @@ This key moves one file backward, towards the beginning of the buffer
 @kindex m@r{--marking a file}
 @kindex M@r{--marking all files}
 @kindex u@r{--unmark a file}
-@kindex @key{ESC} @key{DEL}@r{--unmark all files}
-@kindex @key{DEL}@r{--unmark previous file}
+@kindex ESC DEL@r{--unmark all files}
+@kindex DEL@r{--unmark previous file}
 @kindex %@r{--mark files matching regexp}
 @kindex S@r{--mark files in a particular state}
 @kindex T@r{--toggle marks}
diff --git a/doc/misc/rcirc.texi b/doc/misc/rcirc.texi
index dc715e5d68..2437e020ee 100644
--- a/doc/misc/rcirc.texi
+++ b/doc/misc/rcirc.texi
@@ -154,7 +154,7 @@ deego: fsbot rules!
 
 @cindex nick completion
 @cindex completion of nicks
-@kindex @key{TAB}
+@kindex TAB
 Since this is so common, you can use @key{TAB} to do nick completion.
 
 @node Getting started with rcirc
@@ -215,7 +215,7 @@ When you have answered these questions, @code{rcirc} will create a server
 buffer, which will be named something like @file{*irc.freenode.net*},
 and a channel buffer for each of the channels you wanted to join.
 
-@kindex @key{RET}
+@kindex RET
 @cindex talking
 @cindex communicating
 To talk in a channel, just type what you want to say in a channel
@@ -378,7 +378,7 @@ network.  A new buffer will be created for this conversation.  It works
 like a channel with only two members.  (Also @code{/query fsbot}.)
 
 @item C-c @key{RET}
-@kindex C-c @key{RET}
+@kindex C-c RET
 @cindex /msg
 @cindex single message
 @cindex message sending
@@ -617,7 +617,7 @@ daunting task.  This chapters tells you how @code{rcirc} can help.
 @cindex modeline
 
 @comment This section copied to the Getting started with rcirc section
-@kindex C-c C-@key{SPC}
+@kindex C-c C-SPC
 @vindex rcirc-track-minor-mode
 @cindex switching channels
 @cindex tracking activity
@@ -663,7 +663,7 @@ Low priority channels have the modeline indicator ``LowPri''.
 @kbd{C-c C-@key{SPC}} will not switch to low priority channels unless
 you use the @kbd{C-u} prefix.
 
-@kindex C-c @key{TAB}
+@kindex C-c TAB
 @cindex ignored channels
 If you prefer a channel to never show up in the modeline, then you
 have to ignore it.  Use @kbd{C-c @key{TAB}} to ignore the current
diff --git a/doc/misc/reftex.texi b/doc/misc/reftex.texi
index 55060d09b8..3803cb0eb7 100644
--- a/doc/misc/reftex.texi
+++ b/doc/misc/reftex.texi
@@ -3335,7 +3335,7 @@ have to rescan the buffer in order to see it.
 @findex reftex-arg-index
 @findex TeX-arg-index@r{, AUCTeX function}
 @findex TeX-insert-macro@r{, AUCTeX function}
-@kindex C-c @key{RET}
+@kindex C-c RET
 @b{@RefTeX{} supplies macro arguments}@* When you insert a macro
 interactively with @kbd{C-c @key{RET}}, @AUCTeX{} normally prompts for
 macro arguments.  Internally, it uses the functions
diff --git a/doc/misc/sc.texi b/doc/misc/sc.texi
index 9faa8fea74..03ca842cd0 100644
--- a/doc/misc/sc.texi
+++ b/doc/misc/sc.texi
@@ -685,7 +685,7 @@ Set the preferred reference header (i.e.,
 @code{sc-preferred-header-style}) to the currently displayed header.
 
 @item @code{sc-eref-exit} (@kbd{C-j}, @key{RET}, and @key{ESC C-c})
-@kindex @key{RET}
+@kindex RET
 @kindex C-j
 @kindex q
 @findex sc-eref-exit
diff --git a/doc/misc/sieve.texi b/doc/misc/sieve.texi
index 2875b163ee..37bb707f63 100644
--- a/doc/misc/sieve.texi
+++ b/doc/misc/sieve.texi
@@ -124,7 +124,7 @@ bindings to manage Sieve scripts remotely. @xref{Managing Sieve}.
 @table @kbd
 
 @item C-c RET
-@kindex C-c @key{RET}
+@kindex C-c RET
 @findex sieve-manage
 @cindex manage remote sieve script
 Open a connection to a remote server using the Managesieve protocol.
@@ -190,7 +190,7 @@ Remove currently highlighted script.
 @item RET
 @item mouse-2
 @item f
-@kindex @key{RET}
+@kindex RET
 @kindex mouse-2
 @kindex f
 @findex sieve-edit-script
diff --git a/doc/misc/vhdl-mode.texi b/doc/misc/vhdl-mode.texi
index 5aad1c2ffe..c061fb8e43 100644
--- a/doc/misc/vhdl-mode.texi
+++ b/doc/misc/vhdl-mode.texi
@@ -271,7 +271,7 @@ example again.
 @end group
 @end example
 
-@kindex @key{TAB}
+@kindex TAB
 Let's say point is on line 3 and we hit the @key{TAB} key to re-indent
 the line.  Remember that the syntactic component list for that
 line is:
@@ -822,11 +822,11 @@ symbol currently recognized}
 @cindex   Frequently Asked Questions
 
 @kindex C-x h
-@kindex @key{ESC} C-\
-@kindex @key{ESC} C-q
-@kindex @key{ESC} C-u
-@kindex @key{RET}
-@kindex @key{LFD}
+@kindex ESC C-\
+@kindex ESC C-q
+@kindex ESC C-u
+@kindex RET
+@kindex LFD
 @findex newline-and-indent
 @quotation
 
diff --git a/doc/misc/vip.texi b/doc/misc/vip.texi
index aa55130e0e..5efd6ed684 100644
--- a/doc/misc/vip.texi
+++ b/doc/misc/vip.texi
@@ -289,7 +289,7 @@ its content while you are in insert mode.
 
 @table @kbd
 @item @key{ESC}
-@kindex 033 @key{ESC} @r{(}@code{vip-change-mode-to-vi}@r{) (insert mode)}
+@kindex 033 ESC @r{(}@code{vip-change-mode-to-vi}@r{) (insert mode)}
 This key will take you back to vi mode.
 @item C-h
 @kindex 010 C-h @r{(}@code{vip-delete-backward-char}@r{) (insert mode)}
@@ -373,7 +373,7 @@ the buffer as in Vi.  You can change this by rebinding the variable
 @subsection z Command
 
 @kindex 1723 z H @r{(}@code{vip-line-to-top}@r{)}
-@kindex 1721 z @key{RET} @r{(}@code{vip-line-to-top}@r{)}
+@kindex 1721 z RET @r{(}@code{vip-line-to-top}@r{)}
 @kindex 1723 z M @r{(}@code{vip-line-to-middle}@r{)}
 @kindex 1722 z . @r{(}@code{vip-line-to-middle}@r{)}
 @kindex 1723 z L @r{(}@code{vip-line-to-bottom}@r{)}
@@ -471,7 +471,7 @@ Forward incremental search.
 @itemx @key{ESC}
 @kindex 003 C-c @r{(}@code{vip-ctl-c}@r{)}
 @kindex 0300 C-x @r{(}@code{vip-ctl-x}@r{)}
-@kindex 033 @key{ESC} @r{(}@code{vip-ESC}@r{)}
+@kindex 033 ESC @r{(}@code{vip-ESC}@r{)}
 These keys will exit from vi mode and return to emacs mode temporarily.  If
 you hit one of these keys, Emacs will be in emacs mode and will believe
 that you hit that key in emacs mode. For example, if you hit @kbd{C-x}
@@ -555,8 +555,8 @@ the current buffer.  Here, @kbd{g} will do that, and @kbd{C-g} is
 used to abort a command (this is for compatibility with emacs mode.)
 @item SPC
 @itemx @key{RET}
-@kindex 040 @key{SPC} @r{(}@code{vip-scroll}@r{)}
-@kindex 015 @key{RET} @r{(}@code{vip-scroll-back}@r{)}
+@kindex 040 SPC @r{(}@code{vip-scroll}@r{)}
+@kindex 015 RET @r{(}@code{vip-scroll-back}@r{)}
 Now these keys will scroll up and down the text of current window.
 Convenient for viewing the text.
 @item s
@@ -756,7 +756,7 @@ accessed from vi mode as easily as from emacs mode.
 @itemx @key{ESC}
 @kindex 003 C-c @r{(}@code{vip-ctl-c}@r{)}
 @kindex 0300 C-x @r{(}@code{vip-ctl-x}@r{)}
-@kindex 033 @key{ESC} @r{(}@code{vip-ESC}@r{)}
+@kindex 033 ESC @r{(}@code{vip-ESC}@r{)}
 Typing one of these keys have the same effect as typing it in emacs mode.
 Appropriate command will be executed according as the keys you type after
 it.  You will be in vi mode again after the execution of the command.
@@ -940,13 +940,13 @@ buffer.
 @table @kbd
 @item @key{SPC}
 @itemx C-f
-@kindex 040 @key{SPC} @r{(}@code{vip-scroll}@r{)}
+@kindex 040 SPC @r{(}@code{vip-scroll}@r{)}
 @kindex 006 C-f @r{(}@code{vip-scroll-back}@r{)}
 Scroll text of current window upward almost full screen.  You can go
 @i{forward} in the buffer by this command (@code{vip-scroll}).
 @item @key{RET}
 @itemx C-b
-@kindex 015 @key{RET} @r{(}@code{vip-scroll-back}@r{)}
+@kindex 015 RET @r{(}@code{vip-scroll-back}@r{)}
 @kindex 002 C-b @r{(}@code{vip-scroll-back}@r{)}
 Scroll text of current window downward almost full screen.  You can go
 @i{backward} in the buffer by this command (@code{vip-scroll-back}).
@@ -975,7 +975,7 @@ The following commands reposition point in the window.
 @item z H
 @itemx z @key{RET}
 @kindex 1723 z H @r{(}@code{vip-line-to-top}@r{)}
-@kindex 1721 z @key{RET} @r{(}@code{vip-line-to-top}@r{)}
+@kindex 1721 z RET @r{(}@code{vip-line-to-top}@r{)}
 Put point on the top (@i{home}) line in the window.  So the current line
 becomes the top line in the window.  Given a count @var{n}, point will be
 placed in the @var{n}-th line from top (@code{vip-line-to-top}).
@@ -1368,7 +1368,7 @@ Delete to the end of a line (@code{vip-kill-line}).
 Delete a character after point.  Given @var{n}, delete @var{n} characters
 (@code{vip-delete-char}).
 @item @key{DEL}
-@kindex 177 @key{DEL} @r{(}@code{vip-delete-backward-char}@r{)}
+@kindex 177 DEL @r{(}@code{vip-delete-backward-char}@r{)}
 Delete a character before point.  Given @var{n}, delete @var{n} characters
 (@code{vip-delete-backward-char}).
 @end table
@@ -1570,7 +1570,7 @@ keymap.  See GNU Emacs Manual for details.
 @kindex 000 C-@@ @r{(}@code{set-mark-command}@r{)}
 Set mark and push previous mark on mark ring (@code{set-mark-command}).
 @item TAB
-@kindex 011 @key{TAB} @r{(}@code{indent-for-tab-command}@r{)}
+@kindex 011 TAB @r{(}@code{indent-for-tab-command}@r{)}
 Indent line for current major mode (@code{indent-for-tab-command}).
 @item C-j
 @kindex 012 C-j @r{(}@code{electric-newline-and-maybe-indent}@r{)}
@@ -1656,7 +1656,7 @@ differently from emacs mode.
 
 @table @kbd
 @item @key{ESC}
-@kindex 033 @key{ESC} @r{(}@code{vip-change-mode-to-vi}@r{) (insert mode)}
+@kindex 033 ESC @r{(}@code{vip-change-mode-to-vi}@r{) (insert mode)}
 This key will take you back to vi mode (@code{vip-change-mode-to-vi}).
 @item C-h
 @kindex 010 C-h @r{(}@code{delete-backward-char}@r{) (insert mode)}
diff --git a/doc/misc/viper.texi b/doc/misc/viper.texi
index 366d576da2..e1c45fb40e 100644
--- a/doc/misc/viper.texi
+++ b/doc/misc/viper.texi
@@ -369,7 +369,7 @@ toggles Viperization of Emacs on and off.
 @section States in Viper
 
 @kindex C-z
-@kindex @key{ESC}
+@kindex ESC
 @kindex i
 @cindex Emacs state
 @cindex Vi state
@@ -2671,8 +2671,8 @@ purpose of mouse search and mouse insert.  By default, this is set to
 @end table
 @kindex S-mouse-1
 @kindex S-mouse-2
-@kindex @key{META} @key{SHIFT} button1up
-@kindex @key{META} @key{SHIFT} button2up
+@kindex META SHIFT button1up
+@kindex META SHIFT button2up
 @vindex viper-multiclick-timeout
 @findex viper-mouse-click-insert-word
 @findex viper-mouse-click-search-word
@@ -3423,14 +3423,14 @@ in your Viper customization file.
 @kindex f<char>
 @kindex |
 @kindex 0
-@kindex @key{CR}
+@kindex CR
 @kindex +
 @kindex -
 @kindex ^
 @kindex $
 @kindex C-p
-@kindex @key{LF}
-@kindex @key{SPC}
+@kindex LF
+@kindex SPC
 @kindex C-n
 @kindex C-h
 @kindex h
@@ -4447,8 +4447,8 @@ already bound to something else.
 @end table
 @kindex S-mouse-1
 @kindex S-mouse-2
-@kindex @key{META} button1up
-@kindex @key{META} button2up
+@kindex META button1up
+@kindex META button2up
 
 @node GNU Free Documentation License
 @appendix GNU Free Documentation License
diff --git a/doc/misc/woman.texi b/doc/misc/woman.texi
index 7ab7905b1b..f697243cd9 100644
--- a/doc/misc/woman.texi
+++ b/doc/misc/woman.texi
@@ -625,14 +625,14 @@ the @code{man} key bindings.
 
 @table @kbd
 @item @key{SPC}
-@kindex @key{SPC}
+@kindex SPC
 @findex scroll-up
 Scroll the man page up the window (@code{scroll-up}).
 
 @item @key{DEL}
 @itemx @kbd{S-@key{SPC}}
-@kindex @key{DEL}
-@kindex S-@key{SPC}
+@kindex DEL
+@kindex S-SPC
 @findex scroll-down
 Scroll the man page down the window (@code{scroll-down}).
 
@@ -690,7 +690,7 @@ word must be mouse-highlighted unless @code{woman-mouse-2} is used with
 the Meta key.
 
 @item @key{RET}
-@kindex @key{RET}
+@kindex RET
 @findex man-follow
 Get the man page for the topic under (or nearest to) point
 (@code{man-follow}).
-- 
2.21.0


From d566624eb1e54a43a541e29d7c50f0cf87362dfd Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Mon, 26 Feb 2018 13:53:37 +0100
Subject: [PATCH 034/297] Mark keys consistently in manuals

* doc/emacs/killing.texi:
* doc/lispintro/emacs-lisp-intro.texi:
* doc/misc/calc.texi:
* doc/misc/cc-mode.texi:
* doc/misc/dired-x.texi:
* doc/misc/ede.texi:
* doc/misc/edt.texi:
* doc/misc/efaq.texi:
* doc/misc/erc.texi:
* doc/misc/eshell.texi:
* doc/misc/gnus-faq.texi:
* doc/misc/gnus-news.texi:
* doc/misc/idlwave.texi:
* doc/misc/ido.texi:
* doc/misc/mairix-el.texi:
* doc/misc/message.texi:
* doc/misc/mh-e.texi:
* doc/misc/newsticker.texi:
* doc/misc/org.texi:
* doc/misc/pcl-cvs.texi:
* doc/misc/ses.texi:
* doc/misc/sieve.texi:
* doc/misc/smtpmail.texi:
* doc/misc/speedbar.texi:
* doc/misc/srecode.texi:
* doc/misc/vhdl-mode.texi:
* doc/misc/vip.texi:
* doc/misc/viper.texi: Mark keys consistently.
---
 doc/emacs/killing.texi              |   2 +-
 doc/lispintro/emacs-lisp-intro.texi |  16 ++--
 doc/misc/calc.texi                  |  14 +--
 doc/misc/cc-mode.texi               |   8 +-
 doc/misc/dired-x.texi               |   2 +-
 doc/misc/ede.texi                   |  32 +++----
 doc/misc/edt.texi                   |   4 +-
 doc/misc/efaq.texi                  |  10 +-
 doc/misc/erc.texi                   |  24 ++---
 doc/misc/eshell.texi                |  18 ++--
 doc/misc/gnus-faq.texi              |  36 ++++----
 doc/misc/gnus-news.texi             |   2 +-
 doc/misc/idlwave.texi               |   2 +-
 doc/misc/ido.texi                   |   4 +-
 doc/misc/mairix-el.texi             |  14 +--
 doc/misc/message.texi               |   8 +-
 doc/misc/mh-e.texi                  |   6 +-
 doc/misc/newsticker.texi            |   4 +-
 doc/misc/org.texi                   | 137 ++++++++++++++--------------
 doc/misc/pcl-cvs.texi               |  11 ++-
 doc/misc/ses.texi                   |   8 +-
 doc/misc/sieve.texi                 |  10 +-
 doc/misc/smtpmail.texi              |   2 +-
 doc/misc/speedbar.texi              |   4 +-
 doc/misc/srecode.texi               |  17 ++--
 doc/misc/vhdl-mode.texi             |  10 +-
 doc/misc/vip.texi                   |   8 +-
 doc/misc/viper.texi                 |   2 +-
 28 files changed, 212 insertions(+), 203 deletions(-)

diff --git a/doc/emacs/killing.texi b/doc/emacs/killing.texi
index 4118b752e6..35096cdf53 100644
--- a/doc/emacs/killing.texi
+++ b/doc/emacs/killing.texi
@@ -857,7 +857,7 @@ region is active.
 
 Unlike the standard region, the region-rectangle can have its corners
 extended past the end of buffer, or inside stretches of white space
-that point normally cannot enter, like the TAB.
+that point normally cannot enter, like the @key{TAB}.
 
 @findex rectangle-exchange-point-and-mark
 @findex exchange-point-and-mark@r{, in rectangle-mark-mode}
diff --git a/doc/lispintro/emacs-lisp-intro.texi b/doc/lispintro/emacs-lisp-intro.texi
index ec751be7e1..c86ca43954 100644
--- a/doc/lispintro/emacs-lisp-intro.texi
+++ b/doc/lispintro/emacs-lisp-intro.texi
@@ -13254,7 +13254,7 @@ If you are reading this inside of GNU Emacs and you want to see the
 whole function, you can type @kbd{C-h f} (@code{describe-function})
 and the name of the function.  This gives you the function
 documentation and the name of the library containing the function's
-source.  Place point over the name of the library and press the RET
+source.  Place point over the name of the library and press the @key{RET}
 key; you will be taken directly to the source.  (Be sure to install
 your sources!  Without them, you are like a person who tries to drive
 a car with his eyes shut!)
@@ -14739,7 +14739,7 @@ In Emacs 22
   "Edit file FILENAME.
 Switch to a buffer visiting file FILENAME,
 creating one if none already exists.
-Interactively, the default if you just type RET is the current directory,
+Interactively, the default if you just type @key{RET} is the current directory,
 but the visited file name is available through the minibuffer history:
 type M-n to pull it into the minibuffer.
 
@@ -15917,8 +15917,8 @@ a regular expression, including functions that are not interactive.
 What we want to look for is some command that prints or inserts
 columns.  Very likely, the name of the function will contain either
 the word ``print'' or the word ``insert'' or the word ``column''.
-Therefore, we can simply type @kbd{M-x apropos RET
-print\|insert\|column RET} and look at the result.  On my system, this
+Therefore, we can simply type @kbd{M-x apropos @key{RET}
+print\|insert\|column @key{RET}} and look at the result.  On my system, this
 command once took quite some time, and then produced a list of 79
 functions and variables.  Now it does not take much time at all and
 produces a list of 211 functions and variables.  Scanning down the
@@ -18147,7 +18147,7 @@ You can enter the debugger when you call the function by calling
 Type:
 
 @smallexample
-M-x debug-on-entry RET triangle-bugged RET
+M-x debug-on-entry @key{RET} triangle-bugged @key{RET}
 @end smallexample
 
 @need 1250
@@ -18255,7 +18255,7 @@ To cancel the effect of @code{debug-on-entry}, call
 @code{cancel-debug-on-entry} and the name of the function, like this:
 
 @smallexample
-M-x cancel-debug-on-entry RET triangle-bugged RET
+M-x cancel-debug-on-entry @key{RET} triangle-bugged @key{RET}
 @end smallexample
 
 @noindent
@@ -18341,7 +18341,7 @@ this by positioning your cursor within or just after the definition
 and typing
 
 @smallexample
-M-x edebug-defun RET
+M-x edebug-defun @key{RET}
 @end smallexample
 
 @noindent
@@ -18552,7 +18552,7 @@ one of those long, but decipherable functions.  You can look up
 
 In this instance, since the code is Lisp, the @file{*Help*} buffer
 contains the name of the library containing the function's source.
-You can put point over the name of the library and press the RET key,
+You can put point over the name of the library and press the @key{RET} key,
 which in this situation is bound to @code{help-follow}, and be taken
 directly to the source, in the same way as @kbd{M-.}
 (@code{find-tag}).
diff --git a/doc/misc/calc.texi b/doc/misc/calc.texi
index cd2f66d24e..1fe7948ab8 100644
--- a/doc/misc/calc.texi
+++ b/doc/misc/calc.texi
@@ -35348,13 +35348,13 @@ followed by  @kbd{=}, @kbd{&}, @kbd{#}, @kbd{\}, @kbd{/}, @kbd{+} or
 @kbd{-} as well as @kbd{*} to start Calc, and so in many cases the last
 character of the prefix can simply be typed twice.
 
-Calc is controlled by many variables, most of which can be reset
-from within Calc.  Some variables are less involved with actual
-calculation and can be set outside of Calc using Emacs's
-customization facilities.  These variables are listed below.
-Typing @kbd{M-x customize-variable RET @var{variable-name} RET}
-will bring up a buffer in which the variable's value can be redefined.
-Typing @kbd{M-x customize-group RET calc RET} will bring up a buffer which
+Calc is controlled by many variables, most of which can be reset from
+within Calc.  Some variables are less involved with actual calculation
+and can be set outside of Calc using Emacs's customization facilities.
+These variables are listed below.  Typing @kbd{M-x customize-variable
+@key{RET} @var{variable-name} @key{RET}} will bring up a buffer in
+which the variable's value can be redefined.  Typing @kbd{M-x
+customize-group @key{RET} calc @key{RET}} will bring up a buffer which
 contains all of Calc's customizable variables.  (These variables can
 also be reset by putting the appropriate lines in your .emacs file;
 @xref{Init File, ,Init File, emacs, The GNU Emacs Manual}.)
diff --git a/doc/misc/cc-mode.texi b/doc/misc/cc-mode.texi
index 52cd97bca6..d0d39d44e9 100644
--- a/doc/misc/cc-mode.texi
+++ b/doc/misc/cc-mode.texi
@@ -577,9 +577,9 @@ for the latest information on Emacs version and package compatibility
 
 @deffn Command c-version
 @findex version @r{(c-)}
-You can find out what version of @ccmode{} you are using by visiting a C
-file and entering @kbd{M-x c-version RET}.  You should see this message in
-the echo area:
+You can find out what version of @ccmode{} you are using by visiting a
+C file and entering @kbd{M-x c-version @key{RET}}.  You should see
+this message in the echo area:
 
 @example
 Using CC Mode version 5.XX
@@ -1708,7 +1708,7 @@ nomenclature and treat them as separate words:
 @item     @kbd{M-b}   @tab @code{backward-word}      @tab @code{c-backward-subword}
 @item     @kbd{M-@@}  @tab @code{mark-word}          @tab @code{c-mark-subword}
 @item     @kbd{M-d}   @tab @code{kill-word}          @tab @code{c-kill-subword}
-@item     @kbd{M-DEL} @tab @code{backward-kill-word} @tab @code{c-backward-kill-subword}
+@item     @kbd{M-@key{DEL}} @tab @code{backward-kill-word} @tab @code{c-backward-kill-subword}
 @item     @kbd{M-t}   @tab @code{transpose-words}    @tab @code{c-transpose-subwords}
 @item     @kbd{M-c}   @tab @code{capitalize-word}    @tab @code{c-capitalize-subword}
 @item     @kbd{M-u}   @tab @code{upcase-word}        @tab @code{c-upcase-subword}
diff --git a/doc/misc/dired-x.texi b/doc/misc/dired-x.texi
index 130c06b40e..60e978c9d9 100644
--- a/doc/misc/dired-x.texi
+++ b/doc/misc/dired-x.texi
@@ -995,7 +995,7 @@ If there are several Dired buffers for a directory, the most recently
 used is chosen.
 
 Dired avoids switching to the current buffer, so that if you have a
-normal and a wildcard buffer for the same directory, @kbd{C-x d RET}
+normal and a wildcard buffer for the same directory, @kbd{C-x d @key{RET}}
 will toggle between those two.
 @end table
 
diff --git a/doc/misc/ede.texi b/doc/misc/ede.texi
index 88dc9e922e..42bedb10f6 100644
--- a/doc/misc/ede.texi
+++ b/doc/misc/ede.texi
@@ -160,8 +160,8 @@ First, lets create a directory for our project.  For this example,
 we'll start with something in @file{/tmp}.
 
 @example
-C-x C-f /tmp/myproject/README RET
-M-x make-directory RET RET
+C-x C-f /tmp/myproject/README @key{RET}
+M-x make-directory @key{RET} @key{RET}
 @end example
 
 Now put some plain text in your README file to start.
@@ -169,7 +169,7 @@ Now put some plain text in your README file to start.
 Now, lets create the project:
 
 @example
-M-x ede-new RET Automake RET myproject RET
+M-x ede-new @key{RET} Automake @key{RET} myproject @key{RET}
 @end example
 
 
@@ -191,8 +191,8 @@ We'll make a more complex project, so use dired to create some more
 directories using the @kbd{+} key, and typing in new directories:
 
 @example
-+ include RET
-+ src RET
++ include @key{RET}
++ src @key{RET}
 @end example
 
 Now I'll short-cut in this tutorial.  Create the following files:
@@ -252,13 +252,13 @@ now create those projects.
 With @file{main.cpp} as your current buffer, type:
 
 @example
-M-x ede-new RET Automake RET src RET
+M-x ede-new @key{RET} Automake @key{RET} src @key{RET}
 @end example
 
 and in @file{myproj.hh} as your current buffer, type:
 
 @example
-M-x ede-new RET Automake RET include RET
+M-x ede-new @key{RET} Automake @key{RET} include @key{RET}
 @end example
 
 These steps effectively only create the Project.ede file in which you
@@ -272,7 +272,7 @@ Projects.  You can create targets either from a buffer, or from a
 
 Note: If for some reason a directory list buffer, or file does not have the
 @samp{Project} menu item, or if @ede{} keybindings don't work, just
-use @kbd{M-x revert-buffer RET} to force a refresh.  Sometimes
+use @kbd{M-x revert-buffer @key{RET}} to force a refresh.  Sometimes
 creating a new project doesn't restart buffers correctly.
 
 Lets start with the header file.  In @file{include/myproj.hh}, you
@@ -280,7 +280,7 @@ could use the menu, but we will now start using the @ede{} command prefix
 which is @kbd{C-c .}.
 
 @example
-C-c . t includes RET miscellaneous RET y
+C-c . t includes @key{RET} miscellaneous @key{RET} y
 @end example
 
 
@@ -292,7 +292,7 @@ Next, visit the @file{src} directory using dired.  There should be a
 @samp{Project} menu.   You can create a new target with
 
 @example
-. t myprogram RET program RET
+. t myprogram @key{RET} program @key{RET}
 @end example
 
 Note that @kbd{. t} is a command for creating a target.  This command
@@ -304,7 +304,7 @@ Next, place the cursor on @file{main.cpp}, and use @kbd{. a} to add
 that file to your target.
 
 @example
-. a myprogram RET
+. a myprogram @key{RET}
 @end example
 
 Note that these prompts often have completion, so you can just press
@@ -316,8 +316,8 @@ all in your dired buffer, and add them all at the same time.
 Next, do the same for the library by placing the cursor on @file{mylib.cpp}.
 
 @example
-. t mylib RET sharedobject RET
-. a mylib RET
+. t mylib @key{RET} sharedobject @key{RET}
+. a mylib @key{RET}
 @end example
 
 @section Step 5: Compile, and fail
@@ -350,7 +350,7 @@ To fix the failed compile, we need to add
 Visit @file{main.cpp}.
 
 @example
-M-x customize-project RET
+M-x customize-project @key{RET}
 @end example
 
 Select the @samp{[Settings]} subgroup of options.  Under
@@ -407,7 +407,7 @@ project.  This is because variables such as the include path are
 treated globally, whereas dependencies for a target are target specific.
 
 @example
-M-x customize-target RET
+M-x customize-target @key{RET}
 @end example
 
 On the first page, you will see an Ldlibs-local section.  Add mylib to
@@ -437,7 +437,7 @@ C-c . C
 You can run your program directly from @ede{}.
 
 @example
-C-c . R RET RET
+C-c . R @key{RET} @key{RET}
 @end example
 
 If your program takes command line arguments, you can type them in
diff --git a/doc/misc/edt.texi b/doc/misc/edt.texi
index 20a7034fb2..ddeacf16b4 100644
--- a/doc/misc/edt.texi
+++ b/doc/misc/edt.texi
@@ -192,10 +192,10 @@ EDT Emulation.  (Note: In a few rare circumstances this does not work
 properly.  In particular, it does not work if a subset of the leading
 @acronym{ASCII} characters in a key sequence are recognized by Emacs as
 having an existing binding.  For example, if the keypad 7 (@key{KP7})
-key generates the sequence @samp{<ESC>Ow} and @samp{<ESC>O} is already
+key generates the sequence @samp{@key{ESC}Ow} and @samp{@key{ESC}O} is already
 bound to a function, pressing @key{KP7} when told to do so by
 @file{edt-mapper.el} will result in @file{edt-mapper.el} incorrectly
-mapping @samp{<ESC>O} to @key{KP7} and @samp{w} to @key{KP8}.  If
+mapping @samp{@key{ESC}O} to @key{KP7} and @samp{w} to @key{KP8}.  If
 something like this happens to you, it is probably a bug in the support
 for your keyboard within Emacs @strong{or} a bug in the Unix
 termcap/terminfo support for your terminal @strong{or} a bug in the
diff --git a/doc/misc/efaq.texi b/doc/misc/efaq.texi
index af4cdd47f9..c05e2eac8a 100644
--- a/doc/misc/efaq.texi
+++ b/doc/misc/efaq.texi
@@ -173,7 +173,7 @@ Key sequences longer than one key (and some single-key sequences) are
 written inside quotes or on lines by themselves, like this:
 
 @display
-  @kbd{M-x frobnicate-while-foo RET}
+  @kbd{M-x frobnicate-while-foo @key{RET}}
 @end display
 
 @noindent
@@ -3756,9 +3756,9 @@ defines the @kbd{M-@key{TAB}} key sequence.
 
 @node Backspace invokes help
 @section Why does the @key{Backspace} key invoke help?
-@cindex Backspace key invokes help
-@cindex Help invoked by Backspace
-@cindex DEL key does not delete
+@cindex @key{Backspace} key invokes help
+@cindex Help invoked by @key{Backspace}
+@cindex @key{DEL} key does not delete
 
 The @key{Backspace} key (on most keyboards) generates @acronym{ASCII} code 8.
 @kbd{C-h} sends the same code.  In Emacs by default @kbd{C-h} invokes
@@ -4103,7 +4103,7 @@ This will disable the use of the extra keysyms systemwide, which may be
 undesirable if you actually intend to use them.
 
 @node SPC no longer completes file names
-@section Why doesn't SPC complete file names anymore?
+@section Why doesn't @key{SPC} complete file names anymore?
 @cindex @kbd{SPC} file name completion
 
 Starting with Emacs 22.1, @kbd{SPC} no longer completes file names in
diff --git a/doc/misc/erc.texi b/doc/misc/erc.texi
index 466a4fc4b8..55556c5281 100644
--- a/doc/misc/erc.texi
+++ b/doc/misc/erc.texi
@@ -117,10 +117,11 @@ connect to.
 If you want to place ERC settings in their own file, you can place them
 in @file{~/.emacs.d/.ercrc.el}, creating it if necessary.
 
-If you would rather use the Customize interface to change how ERC works,
-do @kbd{M-x customize-group RET erc RET}.  In particular, ERC comes with
-lots of modules that may be enabled or disabled; to select which ones
-you want, do @kbd{M-x customize-variable RET erc-modules RET}.
+If you would rather use the Customize interface to change how ERC
+works, do @kbd{M-x customize-group @key{RET} erc @key{RET}}.  In
+particular, ERC comes with lots of modules that may be enabled or
+disabled; to select which ones you want, do @kbd{M-x
+customize-variable @key{RET} erc-modules @key{RET}}.
 
 @menu
 * Sample Session::              Example of connecting to the #emacs channel
@@ -269,14 +270,14 @@ This is a summary of keystrokes available in every ERC buffer.
 @item C-a or <home> (@code{erc-bol})
 Go to beginning of line or end of prompt.
 
-@item RET (@code{erc-send-current-line})
+@item @key{RET} (@code{erc-send-current-line})
 Send the current line
 
-@item TAB (@code{erc-complete-word})
+@item @key{TAB} (@code{erc-complete-word})
 If at prompt, complete the current word.
 Otherwise, move to the next link or button.
 
-@item M-TAB (@code{ispell-complete-word})
+@item M-@key{TAB} (@code{ispell-complete-word})
 Complete the given word, using ispell.
 
 @item C-c C-a (@code{erc-bol})
@@ -297,7 +298,7 @@ Toggle automatic CTCP replies (like VERSION and PING).
 @item C-c C-f (@code{erc-toggle-flood-control})
 Toggle use of flood control on sent messages.
 
-@item C-c TAB (@code{erc-invite-only-mode})
+@item C-c @key{TAB} (@code{erc-invite-only-mode})
 Turn on the invite only mode (+i) for the current channel.
 
 @item C-c C-j (@code{erc-join-channel})
@@ -349,8 +350,9 @@ One way to add functionality to ERC is to customize which of its many
 modules are loaded.
 
 There is a spiffy customize interface, which may be reached by typing
-@kbd{M-x customize-option erc-modules RET}.  Alternatively, set
-@code{erc-modules} manually and then call @code{erc-update-modules}.
+@kbd{M-x customize-option @key{RET} erc-modules @key{RET}}.
+Alternatively, set @code{erc-modules} manually and then call
+@code{erc-update-modules}.
 
 The following is a list of available modules.
 
@@ -743,7 +745,7 @@ stuff, to the current ERC buffer."
 
 This section is extremely incomplete.  For now, the easiest way to
 check out all the available options for ERC is to do
-@kbd{M-x customize-group erc RET}.
+@kbd{M-x customize-group @key{RET} erc @key{RET}}.
 
 @defopt erc-hide-list
 If non, @code{nil}, this is a list of IRC message types to hide, e.g.:
diff --git a/doc/misc/eshell.texi b/doc/misc/eshell.texi
index 1789767dbe..80077e5ccd 100644
--- a/doc/misc/eshell.texi
+++ b/doc/misc/eshell.texi
@@ -894,7 +894,7 @@ will happen as it should (albeit slowly).
 
 @item Make sure syntax table is correct in Eshell mode
 
-So that @kbd{M-DEL} acts in a predictable manner, etc.
+So that @kbd{M-@key{DEL}} acts in a predictable manner, etc.
 
 @item Allow all Eshell buffers to share the same history and list-dir
 
@@ -908,19 +908,19 @@ output from all subsequent commands is swallowed.
 Make it similar to the way that @file{esh-arg.el} is structured.
 Then add parsing of @samp{$[?\n]}.
 
-@item After pressing @kbd{M-RET}, redisplay before running the next command
+@item After pressing @kbd{M-@key{RET}}, redisplay before running the next command
 
 @item Argument predicates and modifiers should work anywhere in a path
 
 @example
-/usr/local/src/editors/vim $ vi **/CVS(/)/Root(.)
-Invalid regexp: "Unmatched ( or \\("
+/usr/local/src/editors/vim $ vi **/CVS(/)/Root(.)  Invalid regexp:
+"Unmatched ( or \\("
 @end example
 
 With @command{zsh}, the glob above expands to all files named
 @file{Root} in directories named @file{CVS}.
 
-@item Typing @samp{echo $@{locate locate@}/bin<TAB>} results in a Lisp error
+@item Typing @samp{echo $@{locate locate@}/bin@key{TAB}} results in a Lisp error
 
 Perhaps it should interpolate all permutations, and make that the
 globbing result, since otherwise hitting return here will result in
@@ -960,7 +960,7 @@ At the moment, this is not supported.
 An error should be generated only if @code{eshell-error-if-no-glob} is
 non-@code{nil}.
 
-@item @samp{(+ RET SPC TAB} does not cause @code{indent-according-to-mode} to occur
+@item @samp{(+ @key{RET} @key{SPC} @key{TAB}} does not cause @code{indent-according-to-mode} to occur
 
 @item Create @code{eshell-auto-accumulate-list}
 
@@ -1172,8 +1172,8 @@ only.  That way, it could be listed as a login shell.
 @item Make @kbd{/} electric
 
 So that it automatically expands and corrects pathnames.  Or make
-pathname completion for Pcomplete auto-expand @samp{/u/i/std<TAB>} to
-@samp{/usr/include/std<TAB>}.
+pathname completion for Pcomplete auto-expand @samp{/u/i/std@key{TAB}} to
+@samp{/usr/include/std@key{TAB}}.
 
 @item Write the @command{pushd} stack to disk along with @code{last-dir-ring}
 
@@ -1221,7 +1221,7 @@ If the first thing that I do after entering Emacs is to run
 @code{eshell-command} and invoke @command{ls}, and then use @kbd{M-x
 eshell}, it doesn't display anything.
 
-@item @kbd{M-RET} during a long command (using smart display) doesn't work
+@item @kbd{M-@key{RET}} during a long command (using smart display) doesn't work
 
 Since it keeps the cursor up where the command was invoked.
 
diff --git a/doc/misc/gnus-faq.texi b/doc/misc/gnus-faq.texi
index 4175c88754..efef01f697 100644
--- a/doc/misc/gnus-faq.texi
+++ b/doc/misc/gnus-faq.texi
@@ -397,7 +397,7 @@ The ~/ means the home directory where Gnus and Emacs look
 for the configuration files.  However, you don't really
 need to know what this means, it suffices that Emacs knows
 what it means :-) You can type
-@samp{C-x C-f ~/.gnus.el RET }
+@samp{C-x C-f ~/.gnus.el @key{RET}}
 (yes, with the forward slash, even on Windows), and
 Emacs will open the right file for you.  (It will most
 likely be new, and thus empty.)
@@ -422,7 +422,7 @@ possibility to set environment variables.  Create a new one with
 name HOME and value C:\myhome.  Rebooting is not necessary.
 
 Now to create @file{~/.gnus.el}, say
-@samp{C-x C-f ~/.gnus.el RET C-x C-s}.
+@samp{C-x C-f ~/.gnus.el @key{RET} C-x C-s}.
 in Emacs.
 
 @node FAQ 3-3
@@ -459,11 +459,11 @@ subscribe to a group.
 @subsubheading Answer
 
 If you know the name of the group say @samp{U
-name.of.group RET} in group buffer (use the
+name.of.group @key{RET}} in group buffer (use the
 tab-completion Luke). Otherwise hit ^ in group buffer,
 this brings you to the server buffer. Now place point (the
 cursor) over the server which carries the group you want,
-hit @samp{RET}, move point to the group
+hit @samp{@key{RET}}, move point to the group
 you want to subscribe to and say @samp{u}
 to subscribe to it.
 
@@ -753,11 +753,11 @@ When I enter a group, all read messages are gone. How to view them again?
 @subsubheading Answer
 
 If you enter the group by saying
-@samp{RET}
+@samp{@key{RET}}
 in group buffer with point over the group, only unread and ticked messages are loaded. Say
-@samp{C-u RET}
+@samp{C-u @key{RET}}
 instead to load all available messages. If you want only the 300 newest say
-@samp{C-u 300 RET}
+@samp{C-u 300 @key{RET}}
 
 Loading only unread messages can be annoying if you have threaded view enabled, say
 
@@ -1019,7 +1019,7 @@ back ends. Gnus thinks ``highest-article-number @minus{}
 lowest-article-number = total-number-of-articles''. This
 works OK for Usenet groups, but if you delete and move
 many messages in mail groups, this fails. To cure the
-symptom, enter the group via @samp{C-u RET}
+symptom, enter the group via @samp{C-u @key{RET}}
 (this makes Gnus get all messages), then
 hit @samp{M P b} to mark all messages and
 then say @samp{B m name.of.group} to move
@@ -1494,8 +1494,8 @@ place them in ~/.emacs:
 @end example
 @noindent
 
-Now you should be ready to go. Say @samp{M-x bbdb RET
-RET} to open a bbdb buffer showing all
+Now you should be ready to go. Say @samp{M-x bbdb @key{RET}
+@key{RET}} to open a bbdb buffer showing all
 entries. Say @samp{c} to create a new
 entry, @samp{b} to search your BBDB and
 @samp{C-o} to add a new field to an
@@ -1734,15 +1734,15 @@ world, you may find tools at
 
 Now you've got to import this mbox file into Gnus. To do
 this, create a nndoc group based on the mbox file by
-saying @samp{G f /path/file.mbox RET} in
+saying @samp{G f /path/file.mbox @key{RET}} in
 Group buffer. You now have read-only access to your
 mail. If you want to import the messages to your normal
 Gnus mail groups hierarchy, enter the nndoc group you've
-just created by saying @samp{C-u RET}
+just created by saying @samp{C-u @key{RET}}
 (thus making sure all messages are retrieved), mark all
 messages by saying @samp{M P b} and
 either copy them to the desired group by saying
-@samp{B c name.of.group RET} or send them
+@samp{B c name.of.group @key{RET}} or send them
 through nnmail-split-methods (respool them) by saying
 @samp{B r}.
 
@@ -1809,7 +1809,7 @@ a Usenet group the easiest solution is probably to ask
 @uref{http://groups.google.com, groups.google.com},
 if you found the posting there, tell Google to display
 the raw message, look for the message-id, and say
-@samp{M-^ the@@message.id RET} in a
+@samp{M-^ the@@message.id @key{RET}} in a
 summary buffer.
 Since Gnus 5.10 there's also a Gnus interface for
 groups.google.com which you can call with
@@ -1853,7 +1853,7 @@ How to get rid of old unwanted mail?
 
 You can of course just mark the mail you don't need
 anymore by saying @samp{#} with point
-over the mail and then say @samp{B DEL}
+over the mail and then say @samp{B @key{DEL}}
 to get rid of them forever. You could also instead of
 actually deleting them, send them to a junk-group by
 saying @samp{B m nnml:trash-bin} which
@@ -2089,7 +2089,7 @@ How to find information and help inside Emacs?
 @subsubheading Answer
 
 The first stop should be the Gnus manual (Say
-@samp{C-h i d m Gnus RET} to start the
+@samp{C-h i d m Gnus @key{RET}} to start the
 Gnus manual, then walk through the menus or do a
 full-text search with @samp{s}). Then
 there are the general Emacs help commands starting with
@@ -2191,8 +2191,8 @@ The reason for this could be the way Gnus reads its
 active file, see the node "The Active File" in the Gnus
 manual for things you might try to speed the process up.
 An other idea would be to byte compile your @file{~/.gnus.el} (say
-@samp{M-x byte-compile-file RET ~/.gnus.el
-RET} to do it). Finally, if you have require
+@samp{M-x byte-compile-file @key{RET} ~/.gnus.el
+@key{RET}} to do it). Finally, if you have require
 statements in your .gnus, you could replace them with
 @code{with-eval-after-load}, which loads the stuff not at startup
 time, but when it's needed. Say you've got this in your
diff --git a/doc/misc/gnus-news.texi b/doc/misc/gnus-news.texi
index 91908584c9..171f59a3ad 100644
--- a/doc/misc/gnus-news.texi
+++ b/doc/misc/gnus-news.texi
@@ -324,7 +324,7 @@ messages are deleted again).
 @itemize @bullet
 
 @item The tool bar has been updated to use GNOME icons.
-You can also customize the tool bars: @kbd{M-x customize-apropos RET
+You can also customize the tool bars: @kbd{M-x customize-apropos @key{RET}
 -tool-bar$} should get you started.  (Only for Emacs, not in XEmacs.)
 @c FIXME: Document this in the manual
 
diff --git a/doc/misc/idlwave.texi b/doc/misc/idlwave.texi
index 44a3831b1c..204a449925 100644
--- a/doc/misc/idlwave.texi
+++ b/doc/misc/idlwave.texi
@@ -4064,7 +4064,7 @@ sure you check the following things:
 @itemize @bullet
 @item When you download the IDLWAVE distribution, make sure you save the
 file under the names @file{idlwave.tar.gz}.
-@item M-TAB switches among running programs---use Esc-TAB
+@item M-@key{TAB} switches among running programs---use @key{ESC}-@key{TAB}
 instead.
 @item Other issues as yet unnamed...
 @end itemize
diff --git a/doc/misc/ido.texi b/doc/misc/ido.texi
index 6666c53410..4ff978ee79 100644
--- a/doc/misc/ido.texi
+++ b/doc/misc/ido.texi
@@ -456,14 +456,14 @@ You can toggle display of the hidden buffers and files with @kbd{C-a}
 You can customize the @code{ido} group to change Ido functionality:
 
 @example
-M-x customize-group RET ido RET
+M-x customize-group @key{RET} ido @key{RET}
 @end example
 
 @noindent
 or customize a certain variable:
 
 @example
-M-x customize-variable RET ido-xxxxx
+M-x customize-variable @key{RET} ido-xxxxx @key{RET}
 @end example
 
 To modify the keybindings, use the @code{ido-setup-hook}.  For example:
diff --git a/doc/misc/mairix-el.texi b/doc/misc/mairix-el.texi
index 401ba1d7b5..8d620c720e 100644
--- a/doc/misc/mairix-el.texi
+++ b/doc/misc/mairix-el.texi
@@ -169,13 +169,13 @@ the updates incrementally and hence is very fast.
 
 First, put @code{mairix.el} in your Emacs search path and put
 @code{(require 'mairix)} into your @file{.emacs} file.  Then, use
-@kbd{M-x customize-group mairix RET} to set your preferences for
-mairix.el.  The most important items are @emph{Mairix File Path},
-@emph{Mairix Search File} and @emph{Mairix Mail Program}.  The latter
-specifies which mail program should be used to display the mairix search
-results.  Currently, RMail, Gnus with mbox files, and VM are supported.
-If you use Gnus with maildir or mh, use the native Gnus back end
-nnmairix instead.
+@kbd{M-x customize-group @key{RET} mairix @key{RET}} to set your
+preferences for mairix.el.  The most important items are @emph{Mairix
+File Path}, @emph{Mairix Search File} and @emph{Mairix Mail Program}.
+The latter specifies which mail program should be used to display the
+mairix search results.  Currently, RMail, Gnus with mbox files, and VM
+are supported.  If you use Gnus with maildir or mh, use the native
+Gnus back end nnmairix instead.
 
 If you use another Emacs mail program which is not yet supported by
 mairix.el, it is pretty easy to integrate it.  @xref{Extending},
diff --git a/doc/misc/message.texi b/doc/misc/message.texi
index e614285dc8..0a2a6ce49d 100644
--- a/doc/misc/message.texi
+++ b/doc/misc/message.texi
@@ -104,7 +104,7 @@ sending it.
 @end menu
 
 You can customize the Message Mode tool bar, see @kbd{M-x
-customize-apropos RET message-tool-bar}.  This feature is only available
+customize-apropos @key{RET} message-tool-bar}.  This feature is only available
 in Emacs.
 
 @node New Mail Message
@@ -919,7 +919,7 @@ is fully available) @acronym{IDNA} encoding happens automatically.
 
 @findex message-idna-to-ascii-rhs
 If you want to experiment with the @acronym{IDNA} encoding, you can
-invoke @kbd{M-x message-idna-to-ascii-rhs RET} in the message buffer
+invoke @kbd{M-x message-idna-to-ascii-rhs @key{RET}} in the message buffer
 to have the non-@acronym{ASCII} domain names encoded while you edit
 the message.
 
@@ -1082,7 +1082,7 @@ Since signing and especially encryption often is used when sensitive
 information is sent, you may want to have some way to ensure that your
 mail is actually signed or encrypted.  After invoking the above
 sign/encrypt commands, it is possible to preview the raw article by
-using @kbd{C-u C-c RET P} (@code{mml-preview}).  Then you can
+using @kbd{C-u C-c @key{RET} P} (@code{mml-preview}).  Then you can
 verify that your long rant about what your ex-significant other or
 whomever actually did with that funny looking person at that strange
 party the other night, actually will be sent encrypted.
@@ -1174,7 +1174,7 @@ without some kind of configuration.  Especially, you need to tell it
 where your private key and your certificate is stored.  @acronym{MML}
 uses an Emacs interface to OpenSSL, aptly named @code{smime.el}, and it
 contain a @code{custom} group used for this configuration.  So, try
-@kbd{M-x customize-group RET smime RET} and look around.
+@kbd{M-x customize-group @key{RET} smime @key{RET}} and look around.
 
 Currently there is no support for talking to a CA (or RA) to create
 your own certificate.  None is planned either.  You need to do this
diff --git a/doc/misc/mh-e.texi b/doc/misc/mh-e.texi
index 68d8b210ab..74b17264d2 100644
--- a/doc/misc/mh-e.texi
+++ b/doc/misc/mh-e.texi
@@ -3844,9 +3844,9 @@ buffers that you would rather remove, you can use both
 
 You can use dired to manipulate the folders themselves. For example, I
 renamed my @samp{+out} folder to the more common @samp{+outbox} by
-running dired on my mail directory (@kbd{M-x dired RET ~/Mail RET}),
-moving my cursor to @samp{out} and using the command @kbd{R}
-(@code{dired-do-rename}).
+running dired on my mail directory (@kbd{M-x dired @key{RET} ~/Mail
+@key{RET}}), moving my cursor to @samp{out} and using the command
+@kbd{R} (@code{dired-do-rename}).
 
 @node Sending Mail, Editing Drafts, Folders, Top
 @chapter Sending Mail
diff --git a/doc/misc/newsticker.texi b/doc/misc/newsticker.texi
index f7a28d3827..ac29ced8fb 100644
--- a/doc/misc/newsticker.texi
+++ b/doc/misc/newsticker.texi
@@ -397,8 +397,8 @@ Mark current item as immortal.  Immortal items are kept forever.
 @table @kbd
 @cindex Get News
 @item v
-@itemx RET
-@itemx <mouse-1>
+@itemx @key{RET}
+@itemx mouse-1
 @findex newsticker-treeview-browse-url
 Open the link to the full article (as contained in the current
 headline) in your web browser @code{newsticker-treeview-browse-url}).
diff --git a/doc/misc/org.texi b/doc/misc/org.texi
index e7f70e8f5c..4434636b7f 100644
--- a/doc/misc/org.texi
+++ b/doc/misc/org.texi
@@ -749,7 +749,7 @@ Specific header arguments
 
 Miscellaneous
 
-* Completion::                  M-TAB guesses completions
+* Completion::                  M-@key{TAB} guesses completions
 * Easy templates::              Quick insertion of structural elements
 * Speed keys::                  Electric commands at the beginning of a headline
 * Code evaluation security::    Org mode files evaluate inline code
@@ -884,7 +884,8 @@ We @b{strongly recommend} to stick to a single installation method.
 @subsubheading Using Emacs packaging system
 
 Recent Emacs distributions include a packaging system which lets you install
-Elisp libraries.  You can install Org with @kbd{M-x package-install RET org}.
+Elisp libraries.  You can install Org with @kbd{M-x package-install @key{RET}
+org}.
 
 @noindent @b{Important}: you need to do this in a session where no @code{.org} file has
 been visited, i.e., where no Org built-in function have been loaded.
@@ -1011,10 +1012,10 @@ version of Org available---if you are running an outdated version, it is
 quite possible that the bug has been fixed already.  If the bug persists,
 prepare a report and provide as much information as possible, including the
 version information of Emacs (@kbd{M-x emacs-version @key{RET}}) and Org
-(@kbd{M-x org-version RET}), as well as the Org related setup in the Emacs
-init file.  The easiest way to do this is to use the command
+(@kbd{M-x org-version @key{RET}}), as well as the Org related setup in the
+Emacs init file.  The easiest way to do this is to use the command
 @example
-@kbd{M-x org-submit-bug-report RET}
+@kbd{M-x org-submit-bug-report @key{RET}}
 @end example
 @noindent which will put all this information into an Emacs mail buffer so
 that you only need to add your description.  If you are not sending the Email
@@ -1074,7 +1075,7 @@ Reload uncompiled versions of all Org mode Lisp files.  The backtrace
 contains much more information if it is produced with uncompiled code.
 To do this, use
 @example
-@kbd{C-u M-x org-reload RET}
+@kbd{C-u M-x org-reload @key{RET}}
 @end example
 @noindent
 or select @code{Org -> Refresh/Reload -> Reload Org uncompiled} from the
@@ -1873,7 +1874,7 @@ export output.  Property drawers are not affected by this variable: configure
 Org mode uses begin...end blocks for various purposes from including source
 code examples (@pxref{Literal examples}) to capturing time logging
 information (@pxref{Clocking work time}).  These blocks can be folded and
-unfolded by pressing TAB in the begin line.  You can also get all blocks
+unfolded by pressing @key{TAB} in the begin line.  You can also get all blocks
 folded at startup by configuring the option @code{org-hide-block-startup}
 or on a per-file basis by using
 
@@ -1997,7 +1998,7 @@ a separate window.  The window can be closed by pressing @kbd{C-c '}.
 If you like the intuitive way the Org mode structure editing and list
 formatting works, you might want to use these commands in other modes like
 Text mode or Mail mode as well.  The minor mode @code{orgstruct-mode} makes
-this possible.   Toggle the mode with @kbd{M-x orgstruct-mode RET}, or
+this possible.   Toggle the mode with @kbd{M-x orgstruct-mode @key{RET}}, or
 turn it on by default, for example in Message mode, with one of:
 
 @lisp
@@ -2038,7 +2039,7 @@ file falls into one of the categories above.
 To explore the abstract structure of an Org buffer, run this in a buffer:
 
 @lisp
-M-: (org-element-parse-buffer) RET
+M-: (org-element-parse-buffer) @key{RET}
 @end lisp
 
 It will output a list containing the buffer's content represented as an
@@ -2132,10 +2133,10 @@ table.  But it is easier just to start typing, like
 @orgcmd{C-c C-c,org-table-align}
 Re-align the table and don't move to another field.
 @c
-@orgcmd{C-c SPC,org-table-blank-field}
+@orgcmd{C-c @key{SPC},org-table-blank-field}
 Blank the field at point.
 @c
-@orgcmd{TAB,org-table-next-field}
+@orgcmd{@key{TAB},org-table-next-field}
 Re-align the table, move to the next field.  Creates a new row if
 necessary.
 @c
@@ -2250,7 +2251,7 @@ window follow the cursor through the table and always show the current
 field.  The follow mode exits automatically when the cursor leaves the table,
 or when you repeat this command with @kbd{C-u C-u C-c `}.
 @c
-@item M-x org-table-import RET
+@item M-x org-table-import @key{RET}
 Import a file as a table.  The table should be TAB or whitespace
 separated.  Use, for example, to import a spreadsheet table or data
 from a database, because these programs generally can write
@@ -2263,7 +2264,7 @@ Tables can also be imported by pasting tabular text into the Org
 buffer, selecting the pasted text with @kbd{C-x C-x} and then using the
 @kbd{C-c |} command (see above under @i{Creation and conversion}).
 @c
-@item M-x org-table-export RET
+@item M-x org-table-export @key{RET}
 @findex org-table-export
 @vindex org-table-export-default-format
 Export the table, by default as a TAB-separated file.  Use for data
@@ -2388,11 +2389,11 @@ every vertical line you would like to have:
 @cindex Orgtbl mode
 @cindex minor mode for tables
 
-If you like the intuitive way the Org table editor works, you
-might also want to use it in other modes like Text mode or Mail mode.
-The minor mode Orgtbl mode makes this possible.  You can always toggle
-the mode with @kbd{M-x orgtbl-mode RET}.  To turn it on by default, for
-example in Message mode, use
+If you like the intuitive way the Org table editor works, you might also want
+to use it in other modes like Text mode or Mail mode.  The minor mode Orgtbl
+mode makes this possible.  You can always toggle the mode with @kbd{M-x
+orgtbl-mode @key{RET}}.  To turn it on by default, for example in Message
+mode, use
 
 @lisp
 (add-hook 'message-mode-hook 'turn-on-orgtbl)
@@ -3131,10 +3132,10 @@ hline are left alone, assuming that these are part of the table header.
 Iterate the table by recomputing it until no further changes occur.
 This may be necessary if some computed fields use the value of other
 fields that are computed @i{later} in the calculation sequence.
-@item M-x org-table-recalculate-buffer-tables RET
+@item M-x org-table-recalculate-buffer-tables @key{RET}
 @findex org-table-recalculate-buffer-tables
 Recompute all tables in the current buffer.
-@item M-x org-table-iterate-buffer-tables RET
+@item M-x org-table-iterate-buffer-tables @key{RET}
 @findex org-table-iterate-buffer-tables
 Iterate all tables in the current buffer, in order to converge table-to-table
 dependencies.
@@ -4229,8 +4230,8 @@ each keyword, in parentheses@footnote{All characters are allowed except
 @end lisp
 
 @vindex org-fast-tag-selection-include-todo
-If you then press @kbd{C-c C-t} followed by the selection key, the entry
-will be switched to this state.  @kbd{SPC} can be used to remove any TODO
+If you then press @kbd{C-c C-t} followed by the selection key, the entry will
+be switched to this state.  @kbd{@key{SPC}} can be used to remove any TODO
 keyword from an entry.@footnote{Check also the option
 @code{org-fast-tag-selection-include-todo}, it allows you to change the TODO
 state through the tags interface (@pxref{Setting tags}), in case you like to
@@ -4419,7 +4420,7 @@ Then each time you turn an entry from a TODO (not-done) state into any of the
 DONE states, a line @samp{CLOSED: [timestamp]} will be inserted just after
 the headline.  If you turn the entry back into a TODO item through further
 state cycling, that line will be removed again.  If you turn the entry back
-to a non-TODO state (by pressing @key{C-c C-t SPC} for example), that line
+to a non-TODO state (by pressing @key{C-c C-t @key{SPC}} for example), that line
 will also be removed, unless you set @code{org-closed-keep-when-no-todo} to
 non-@code{nil}.  If you want to record a note along with the timestamp,
 use@footnote{The corresponding in-buffer setting is: @code{#+STARTUP:
@@ -4449,8 +4450,8 @@ headline as an itemized list, newest first@footnote{See the option
 want to get the notes out of the way into a drawer (@pxref{Drawers}).
 Customize @code{org-log-into-drawer} to get this behavior---the recommended
 drawer for this is called @code{LOGBOOK}@footnote{Note that the
-@code{LOGBOOK} drawer is unfolded when pressing @key{SPC} in the agenda to
-show an entry---use @key{C-u SPC} to keep it folded here}.  You can also
+@code{LOGBOOK} drawer is unfolded when pressing @kbd{@key{SPC}} in the agenda to
+show an entry---use @kbd{C-u @key{SPC}} to keep it folded here}.  You can also
 overrule the setting of this variable for a subtree by setting a
 @code{LOG_INTO_DRAWER} property.
 
@@ -5383,7 +5384,7 @@ in the current file will be offered as possible completions.
 @orgcmd{C-c C-x p,org-set-property}
 Set a property.  This prompts for a property name and a value.  If
 necessary, the property drawer is created as well.
-@item C-u M-x org-insert-drawer RET
+@item C-u M-x org-insert-drawer @key{RET}
 @cindex @code{org-insert-drawer}
 Insert a property drawer into the current entry.  The drawer will be
 inserted early in the entry, but after the lines with planning
@@ -5790,7 +5791,7 @@ global    @r{make a global view, including all headings in the file}
           @r{run column view at the top of this file}
 "@var{ID}"      @r{call column view in the tree that has an @code{:ID:}}
           @r{property with the value @i{label}.  You can use}
-          @r{@kbd{M-x org-id-copy RET} to create a globally unique @code{ID} for}
+          @r{@kbd{M-x org-id-copy @key{RET}} to create a globally unique @code{ID} for}
           @r{the current entry and copy it to the kill-ring.}
 @end example
 @item :hlines
@@ -6804,7 +6805,8 @@ identical to dealing with away time due to idleness; it is just happening due
 to a recovery event rather than a set amount of idle time.
 
 You can also check all the files visited by your Org agenda for dangling
-clocks at any time using @kbd{M-x org-resolve-clocks RET} (or @kbd{C-c C-x C-z}).
+clocks at any time using @kbd{M-x org-resolve-clocks @key{RET}} (or @kbd{C-c
+C-x C-z}).
 
 @subsubheading Continuous clocking
 @cindex continuous clocking
@@ -6964,7 +6966,7 @@ If your configuration depends on @file{org-remember.el}, you need to update
 it and use the setup described below.  To convert your
 @code{org-remember-templates}, run the command
 @example
-@kbd{M-x org-capture-import-remember-templates RET}
+@kbd{M-x org-capture-import-remember-templates @key{RET}}
 @end example
 @noindent and then customize the new variable with @kbd{M-x
 customize-variable org-capture-templates}, check the result, and save the
@@ -7908,7 +7910,7 @@ To do this, each subtree is checked for open TODO entries.  If none are
 found, the command offers to set the ARCHIVE tag for the child.  If the
 cursor is @emph{not} on a headline when this command is invoked, the
 level 1 trees will be checked.
-@orgcmd{C-@kbd{TAB},org-force-cycle-archived}
+@orgcmd{C-@key{TAB},org-force-cycle-archived}
 Cycle a tree even if it is tagged with ARCHIVE.
 @orgcmd{C-c C-x A,org-archive-to-archive-sibling}
 Move the current entry to the @emph{Archive Sibling}.  This is a sibling of
@@ -8020,7 +8022,7 @@ Remove current file from the list of agenda files.
 @orgcmd{C-',org-cycle-agenda-files}
 @itemx C-,
 Cycle through agenda file list, visiting one file after the other.
-@item M-x org-iswitchb RET
+@item M-x org-iswitchb @key{RET}
 Command to use an @code{iswitchb}-like interface to switch to and between Org
 buffers.
 @end table
@@ -8786,12 +8788,13 @@ excluding the next tag.
 Org also supports automatic, context-aware tag filtering.  If the variable
 @code{org-agenda-auto-exclude-function} is set to a user-defined function,
 that function can decide which tags should be excluded from the agenda
-automatically.  Once this is set, the @kbd{/} command then accepts @kbd{RET}
-as a sub-option key and runs the auto exclusion logic.  For example, let's
-say you use a @code{Net} tag to identify tasks which need network access, an
-@code{Errand} tag for errands in town, and a @code{Call} tag for making phone
-calls.  You could auto-exclude these tags based on the availability of the
-Internet, and outside of business hours, with something like this:
+automatically.  Once this is set, the @kbd{/} command then accepts
+@kbd{@key{RET}} as a sub-option key and runs the auto exclusion logic.  For
+example, let's say you use a @code{Net} tag to identify tasks which need
+network access, an @code{Errand} tag for errands in town, and a @code{Call}
+tag for making phone calls.  You could auto-exclude these tags based on the
+availability of the Internet, and outside of business hours, with something
+like this:
 
 @smalllisp
 @group
@@ -9002,7 +9005,7 @@ Delete other windows.
 @xorgcmd{v t,org-agenda-fortnight-view}
 @xorgcmd{v m,org-agenda-month-view}
 @xorgcmd{v y,org-agenda-year-view}
-@xorgcmd{v SPC,org-agenda-reset-view}
+@xorgcmd{v @key{SPC},org-agenda-reset-view}
 @vindex org-agenda-span
 Switch to day/week/month/year view.  When switching to day or week view, this
 setting becomes the default for subsequent agenda refreshes.  Since month and
@@ -9421,7 +9424,7 @@ calendars.
 @orgcmd{H,org-agenda-holidays}
 Show holidays for three months around the cursor date.
 
-@item M-x org-icalendar-combine-agenda-files RET
+@item M-x org-icalendar-combine-agenda-files @key{RET}
 Export a single iCalendar file containing entries from all agenda files.
 This is a globally available command, and also available in the agenda menu.
 
@@ -10405,14 +10408,14 @@ To disable it, simply use
 
 CD@LaTeX{} mode is a minor mode that is normally used in combination with a
 major @LaTeX{} mode like AUC@TeX{} in order to speed-up insertion of
-environments and math templates.  Inside Org mode, you can make use of
-some of the features of CD@LaTeX{} mode.  You need to install
-@file{cdlatex.el} and @file{texmathp.el} (the latter comes also with
-AUC@TeX{}) from @url{https://staff.fnwi.uva.nl/c.dominik/Tools/cdlatex}.
-Don't use CD@LaTeX{} mode itself under Org mode, but use the light
-version @code{org-cdlatex-mode} that comes as part of Org mode.  Turn it
-on for the current buffer with @kbd{M-x org-cdlatex-mode RET}, or for all
-Org files with
+environments and math templates.  Inside Org mode, you can make use of some
+of the features of CD@LaTeX{} mode.  You need to install @file{cdlatex.el}
+and @file{texmathp.el} (the latter comes also with AUC@TeX{}) from
+@url{https://staff.fnwi.uva.nl/c.dominik/Tools/cdlatex}.  Don't use
+CD@LaTeX{} mode itself under Org mode, but use the light version
+@code{org-cdlatex-mode} that comes as part of Org mode.  Turn it on for the
+current buffer with @kbd{M-x org-cdlatex-mode @key{RET}}, or for all Org
+files with
 
 @lisp
 (add-hook 'org-mode-hook 'turn-on-org-cdlatex)
@@ -10436,7 +10439,8 @@ the second brace.  Even outside fragments, @key{TAB} will expand
 environment abbreviations at the beginning of a line.  For example, if
 you write @samp{equ} at the beginning of a line and press @key{TAB},
 this abbreviation will be expanded to an @code{equation} environment.
-To get a list of all abbreviations, type @kbd{M-x cdlatex-command-help RET}.
+To get a list of all abbreviations, type @kbd{M-x cdlatex-command-help
+@key{RET}}.
 @item
 @kindex _
 @kindex ^
@@ -10614,8 +10618,8 @@ inserted from the export dispatcher (@pxref{The export dispatcher}) using the
 @code{Insert template} command by pressing @key{#}.  To insert keywords
 individually, a good way to make sure the keyword is correct is to type
 @code{#+} and then to use @kbd{M-@key{TAB}}@footnote{Many desktops intercept
-@kbd{M-TAB} to switch windows.  Use @kbd{C-M-i} or @kbd{@key{ESC} @key{TAB}}
-instead.} for completion.
+@kbd{M-@key{TAB}} to switch windows.  Use @kbd{C-M-i} or @kbd{@key{ESC}
+@key{TAB}} instead.} for completion.
 
 The export keywords available for every back-end, and their equivalent global
 variables, include:
@@ -12845,7 +12849,7 @@ generic commands:
 @vindex org-odt-convert
 @table @kbd
 
-@item M-x org-odt-convert RET
+@item M-x org-odt-convert @key{RET}
 Convert an existing document from one format to another.  With a prefix
 argument, opens the newly produced file.
 @end table
@@ -13120,10 +13124,10 @@ To quickly verify the reliability of the @LaTeX{}-to-MathML converter, use
 the following commands:
 
 @table @kbd
-@item M-x org-odt-export-as-odf RET
+@item M-x org-odt-export-as-odf @key{RET}
 Convert a @LaTeX{} math snippet to an OpenDocument formula (@file{.odf}) file.
 
-@item M-x org-odt-export-as-odf-and-open RET
+@item M-x org-odt-export-as-odf-and-open @key{RET}
 Convert a @LaTeX{} math snippet to an OpenDocument formula (@file{.odf}) file
 and open the formula file with the system-registered application.
 @end table
@@ -14427,7 +14431,7 @@ In-place conversions are particularly handy for quick conversion of tables
 and lists in foreign buffers.  For example, turn on the minor mode @code{M-x
 orgstruct-mode} in an HTML buffer, then use the convenient Org keyboard
 commands to create a list, select it, and covert it to HTML with @code{M-x
-org-html-convert-region-to-html RET}.
+org-html-convert-region-to-html @key{RET}}.
 
 
 @node Publishing
@@ -16144,7 +16148,7 @@ Interpreted as raw Org mode.  Inserted directly into the buffer.  Aligned if
 it is a table.  Usage example: @code{:results value raw}.
 @item @code{org}
 Results enclosed in a @code{BEGIN_SRC org} block.  For comma-escape, either
-@kbd{TAB} in the block, or export the file.  Usage example: @code{:results
+@key{TAB} in the block, or export the file.  Usage example: @code{:results
 value org}.
 @item @code{html}
 Results enclosed in a @code{BEGIN_EXPORT html} block.  Usage example:
@@ -16231,7 +16235,7 @@ output file, @code{:dir} specifies the default directory during @samp{src}
 code block execution.  If it is absent, then the directory associated with
 the current buffer is used.  In other words, supplying @code{:dir path}
 temporarily has the same effect as changing the current directory with
-@kbd{M-x cd path RET}, and then not supplying @code{:dir}.  Under the
+@kbd{M-x cd path @key{RET}}, and then not supplying @code{:dir}.  Under the
 surface, @code{:dir} simply sets the value of the Emacs variable
 @code{default-directory}.
 
@@ -17245,7 +17249,7 @@ emacs -Q --batch --eval "
 @chapter Miscellaneous
 
 @menu
-* Completion::                  M-TAB guesses completions
+* Completion::                  M-@key{TAB} guesses completions
 * Easy templates::              Quick insertion of structural elements
 * Speed keys::                  Electric commands at the beginning of a headline
 * Code evaluation security::    Org mode files evaluate inline code
@@ -17455,8 +17459,8 @@ Org executes formulas in tables (@pxref{The spreadsheet}) either through the
 @cindex variables, for customization
 
 Org has more than 500 variables for customization.  They can be accessed
-through the usual @kbd{M-x org-customize RET} command.  Or through the Org
-menu, @code{Org->Customization->Browse Org Group}.  Org also has per-file
+through the usual @kbd{M-x org-customize @key{RET}} command.  Or through the
+Org menu, @code{Org->Customization->Browse Org Group}.  Org also has per-file
 settings for some variables (@pxref{In-buffer settings}).
 
 @node In-buffer settings
@@ -17910,7 +17914,8 @@ one of the following lines:
 @end example
 
 To switch between single and double stars layouts, use @kbd{M-x
-org-convert-to-odd-levels RET} and @kbd{M-x org-convert-to-oddeven-levels}.
+org-convert-to-odd-levels @key{RET}} and @kbd{M-x
+org-convert-to-oddeven-levels @key{RET}}.
 @end enumerate
 
 @node TTY keys
@@ -18056,9 +18061,9 @@ bindings in Org files, and in the agenda buffer (but not during date
 selection).
 
 @example
-S-UP      @result{}  M-p             S-DOWN     @result{}  M-n
-S-LEFT    @result{}  M--             S-RIGHT    @result{}  M-+
-C-S-LEFT  @result{}  M-S--           C-S-RIGHT  @result{}  M-S-+
+S-@key{UP}      @result{}  M-p             S-@key{DOWN}     @result{}  M-n
+S-@key{LEFT}    @result{}  M--             S-@key{RIGHT}    @result{}  M-+
+C-S-@key{LEFT}  @result{}  M-S--           C-S-@key{RIGHT}  @result{}  M-S-+
 @end example
 
 @vindex org-disputed-keys
@@ -18463,7 +18468,7 @@ Put the table after an @samp{END} statement.  For example @samp{\bye} in
 @TeX{} and @samp{\end@{document@}} in @LaTeX{}.
 @item
 Comment and uncomment each line of the table during edits.  The @kbd{M-x
-orgtbl-toggle-comment RET} command makes toggling easy.
+orgtbl-toggle-comment @key{RET}} command makes toggling easy.
 @end itemize
 
 @node A @LaTeX{} example
@@ -18476,8 +18481,8 @@ provided by @file{comment.sty}.  To activate it, put
 radio table skeleton@footnote{By default this works only for @LaTeX{}, HTML,
 and Texinfo.  Configure the variable @code{orgtbl-radio-table-templates} to
 install templates for other export formats.}  with the command @kbd{M-x
-orgtbl-insert-radio-table RET}, which prompts for a table name.  For example,
-if @samp{salesfigures} is the name, the template inserts:
+orgtbl-insert-radio-table @key{RET}}, which prompts for a table name.  For
+example, if @samp{salesfigures} is the name, the template inserts:
 
 @cindex @code{#+ORGTBL}, @samp{SEND}
 @example
diff --git a/doc/misc/pcl-cvs.texi b/doc/misc/pcl-cvs.texi
index 1163530e7a..4c61aed5b3 100644
--- a/doc/misc/pcl-cvs.texi
+++ b/doc/misc/pcl-cvs.texi
@@ -63,10 +63,11 @@ modify this GNU manual.''
 @node Top
 @top PCL-CVS
 
-This manual describes PCL-CVS, the GNU Emacs front-end to CVS@.  It
-is nowhere near complete, so you are advised to use @kbd{M-x
-customize-group RET pcl-cvs @key{RET}} and to look at the documentation strings
-of the various commands and major modes for further information.
+This manual describes PCL-CVS, the GNU Emacs front-end to CVS@.  It is
+nowhere near complete, so you are advised to use @kbd{M-x
+customize-group @key{RET} pcl-cvs @key{RET}} and to look at the
+documentation strings of the various commands and major modes for
+further information.
 @c This manual is updated to release 2.5 of PCL-CVS.
 
 @insertcopying
@@ -1109,7 +1110,7 @@ Tag all selected files by running @samp{cvs tag} on
 them (@code{cvs-mode-tag}).  It's usually preferable to tag a directory
 at a time.  Rather than selecting all files (which too often doesn't
 select all files but only the few that are displayed), clear the
-selection with @kbd{M-DEL} (@code{cvs-mode-unmark-all-files}), position
+selection with @kbd{M-@key{DEL}} (@code{cvs-mode-unmark-all-files}), position
 the cursor on the directory you want to tag and hit @kbd{t}.
 @end table
 
diff --git a/doc/misc/ses.texi b/doc/misc/ses.texi
index 4db5fda34a..aa4fe81ba5 100644
--- a/doc/misc/ses.texi
+++ b/doc/misc/ses.texi
@@ -209,7 +209,7 @@ remove blank cells from the returned list, which allows to use
 @findex keyboard-quit
 
 To create a new spreadsheet, visit a nonexistent file whose name ends
-  with ".ses".  For example, @kbd{C-x C-f test.ses RET}.
+with ".ses".  For example, @kbd{C-x C-f test.ses @key{RET}}.
 
 
 A @dfn{cell identifier} is a symbol with a column letter and a row
@@ -310,7 +310,7 @@ To enter something else (e.g., a vector), begin with a digit, then
 erase the digit and type whatever you want.
 
 @table @kbd
-@item RET
+@item @key{RET}
 Edit the existing formula in the current cell (@code{ses-edit-cell}).
 
 @item C-c C-c
@@ -357,7 +357,7 @@ Basic commands:
 @item w
 (@code{ses-set-column-width})
 
-@item TAB
+@item @key{TAB}
 Moves point to the next rightward cell, or inserts a new column if
 already at last cell on line, or inserts a new row if at endline
 (@code{ses-forward-or-insert}).
@@ -639,7 +639,7 @@ or a non-string is displayed as an error by using @code{#} filling.
 These commands set both formula and printer to @code{nil}:
 
 @table @kbd
-@item DEL
+@item @key{DEL}
 Clear cell and move left (@code{ses-clear-cell-backward}).
 
 @item C-d
diff --git a/doc/misc/sieve.texi b/doc/misc/sieve.texi
index 37bb707f63..2d290b3688 100644
--- a/doc/misc/sieve.texi
+++ b/doc/misc/sieve.texi
@@ -123,7 +123,7 @@ bindings to manage Sieve scripts remotely. @xref{Managing Sieve}.
 
 @table @kbd
 
-@item C-c RET
+@item C-c @key{RET}
 @kindex C-c RET
 @findex sieve-manage
 @cindex manage remote sieve script
@@ -160,8 +160,8 @@ press RET on <new script> to create a new script.
 @end example
 
 One of the scripts are highlighted, and standard point navigation
-commands (@kbd{<up>}, @kbd{<down>} etc.)@: can be used to navigate the
-list.
+commands (@kbd{@key{UP}}, @kbd{@key{DOWN}} etc.)@: can be used to
+navigate the list.
 
 The following commands are available in the Manage Sieve buffer:
 
@@ -187,7 +187,7 @@ Deactivates all scripts.
 @findex sieve-remove
 Remove currently highlighted script.
 
-@item RET
+@item @key{RET}
 @item mouse-2
 @item f
 @kindex RET
@@ -272,7 +272,7 @@ The @file{sieve-manage.el} library contains low-level functionality
 for talking to a server with the @sc{managesieve} protocol.
 
 A number of user-visible variables exist, which all can be customized
-in the @code{sieve} group (@kbd{M-x customize-group RET sieve RET}):
+in the @code{sieve} group (@kbd{M-x customize-group @key{RET} sieve @key{RET}}):
 
 @table @code
 
diff --git a/doc/misc/smtpmail.texi b/doc/misc/smtpmail.texi
index 6da51f798d..c3387054ba 100644
--- a/doc/misc/smtpmail.texi
+++ b/doc/misc/smtpmail.texi
@@ -354,7 +354,7 @@ directory to hold queued messages.  It defaults to
   The function @code{smtpmail-send-queued-mail} can be used to send
 any queued mail when @code{smtpmail-queue-mail} is enabled.  It is
 typically invoked interactively with @kbd{M-x
-smtpmail-send-queued-mail RET} when you are connected to the internet.
+smtpmail-send-queued-mail @key{RET}} when you are connected to the internet.
 
 @node Server workarounds
 @chapter Server workarounds
diff --git a/doc/misc/speedbar.texi b/doc/misc/speedbar.texi
index 6286ac12a9..1c1b014f54 100644
--- a/doc/misc/speedbar.texi
+++ b/doc/misc/speedbar.texi
@@ -87,7 +87,7 @@ on.  @xref{Basic Navigation}.
 @chapter Introduction
 @cindex introduction
 
-To start using speedbar use the command @kbd{M-x speedbar RET} or
+To start using speedbar use the command @kbd{M-x speedbar @key{RET}} or
 select it from the @samp{Options->Show/Hide} sub-menu.  This command
 will open a new frame to summarize the local files.  On X Window
 systems or on MS-Windows, speedbar's frame is twenty characters wide,
@@ -188,7 +188,7 @@ these are available, some additional common bindings are available.
 
 @cindex common keys
 @table @kbd
-@item RET
+@item @key{RET}
 @itemx e
 Edit/Open the current group or tag.  This behavior is dependent on the
 mode.  In general, files or buffers are opened in the attached frame,
diff --git a/doc/misc/srecode.texi b/doc/misc/srecode.texi
index afa3af1035..2987f62974 100644
--- a/doc/misc/srecode.texi
+++ b/doc/misc/srecode.texi
@@ -105,11 +105,11 @@ item should appear.
 To toggle @srecode{} minor mode on and off use:
 
 @example
-M-x srecode-minor-mode RET
+M-x srecode-minor-mode @key{RET}
 @end example
 or
 @example
-M-x global-srecode-minor-mode RET
+M-x global-srecode-minor-mode @key{RET}
 @end example
 
 or add
@@ -276,7 +276,8 @@ If the variable @code{srecode-insert-ask-variable-method} is set to
 instead create ``fields'' in the buffer.  A field-editing layer
 provides simple interaction through the fields.  Typing in a field
 will cause all variable locations that are the same to edit at the
-same time.  Pressing TAB on a field will move you to the next field.
+same time.  Pressing @kbd{@key{TAB}} on a field will move you to the
+next field.
 
 @node SRecode Minor Mode
 @chapter SRecode Minor Mode
@@ -284,17 +285,17 @@ same time.  Pressing TAB on a field will move you to the next field.
 The Semantic Recode minor mode enables a keymap and menu that provides
 simple access to different templates or template applications.
 
-The key prefix is @key{C-c /}.
+The key prefix is @kbd{C-c /}.
 
 If the variable @code{srecode-takeover-INS-key} is set, then the key
-@key{<insert>} can also be used.
+@kbd{@key{INSERT}} can also be used.
 
 The most important key is bound to @code{srecode-insert} which is
-@key{C-c / /}, or @key{insert insert}.  @ref{Quick Start}.
+@kbd{C-c / /}, or @kbd{@key{INSERT} @key{INSERT}}.  @ref{Quick Start}.
 
 Major keybindings are:
 
-@table @key
+@table @kbd
 @item C-c / /
 Insert a template whose name is typed into the minibuffer.
 @item C-c / <lower case letter>
@@ -338,7 +339,7 @@ will not be prompted to fill in values while the template is
 inserted.  Instead, short regions will be highlighted, and the cursor
 placed in a field.  Typing in the field will then fill in the value.
 Several fields might be linked together.  In that case, typing in one
-area will modify the other linked areas.  Pressing TAB will move
+area will modify the other linked areas.  Pressing @key{TAB} will move
 between editable fields in the template.
 
 Once the cursor moves out of the are inserted by the template, all the
diff --git a/doc/misc/vhdl-mode.texi b/doc/misc/vhdl-mode.texi
index c061fb8e43..8fc75106d5 100644
--- a/doc/misc/vhdl-mode.texi
+++ b/doc/misc/vhdl-mode.texi
@@ -100,7 +100,7 @@ How to customize the indentation engine.
 The major version number was incremented to 3 with the addition of
 many new features for editing VHDL code to the new indentation engine,
 which was introduced in major version 2. To find the minor revision
-number of this release, use @kbd{M-x vhdl-version RET}.
+number of this release, use @kbd{M-x vhdl-version @key{RET}}.
 
 A special word of thanks goes to Rod Whitby, who wrote the
 VHDL Mode indentation engine, and to Barry Warsaw, who wrote
@@ -119,7 +119,7 @@ makes everything highly self-explaining.
 @cindex   Getting Connected
 
 To get started, simply visit a @file{.vhd} file in Emacs; or type
-@kbd{M-x vhdl-mode RET}.
+@kbd{M-x vhdl-mode @key{RET}}.
 
 @node     New Indentation Engine
 @chapter  New Indentation Engine
@@ -302,11 +302,11 @@ being used.
 
 @vindex vhdl-echo-syntactic-information-p
 @vindex echo-syntactic-information-p @r{(vhdl-)}
-@cindex TAB
+@cindex @key{TAB}
 To help you configure VHDL Mode, you can set the variable
 @code{vhdl-echo-syntactic-information-p} to non-@code{nil} so that the
 syntactic component list and calculated offset will always be echoed in
-the minibuffer when you hit @kbd{TAB}.
+the minibuffer when you hit @kbd{@key{TAB}}.
 
 
 @ignore
@@ -548,7 +548,7 @@ already built-in.  These include:
 @findex vhdl-set-style
 @findex set-style @r{(vhdl-)}
 If you'd like to experiment with these built-in styles you can simply
-type @kbd{M-x vhdl-set-style RET} in a VHDL Mode buffer.
+type @kbd{M-x vhdl-set-style @key{RET}} in a VHDL Mode buffer.
 
 You will be prompted for one of the above styles (with completion).
 Enter one of the styles and hit @kbd{RET}.  Note however that setting a
diff --git a/doc/misc/vip.texi b/doc/misc/vip.texi
index 5efd6ed684..59df749231 100644
--- a/doc/misc/vip.texi
+++ b/doc/misc/vip.texi
@@ -553,7 +553,7 @@ details.
 In Vi, @kbd{C-g} is used to get information about the file associated to
 the current buffer.  Here, @kbd{g} will do that, and @kbd{C-g} is
 used to abort a command (this is for compatibility with emacs mode.)
-@item SPC
+@item @key{SPC}
 @itemx @key{RET}
 @kindex 040 SPC @r{(}@code{vip-scroll}@r{)}
 @kindex 015 RET @r{(}@code{vip-scroll-back}@r{)}
@@ -1258,7 +1258,7 @@ Search forward incrementally.  See GNU Emacs Manual for details
 Search backward incrementally (@code{isearch-backward}).
 @cindex vanilla (replacement)
 @cindex regular expression (replacement)
-@item R @var{string} RET @var{newstring}
+@item R @var{string} @key{RET} @var{newstring}
 @kindex 122 R @r{(}@code{vip-replace-string}@r{)}
 There are two modes of replacement, @dfn{vanilla} and @dfn{regular expression}.
 If the mode is @i{vanilla} you will get a prompt @samp{Replace string:},
@@ -1269,7 +1269,7 @@ vanilla, this command replaces every occurrence of @var{string} with
 @var{newstring}.  If the mode is regular expression, @var{string} is
 treated as a regular expression and every string matching the regular
 expression is replaced with @var{newstring} (@code{vip-replace-string}).
-@item Q @var{string} RET @var{newstring}
+@item Q @var{string} @key{RET} @var{newstring}
 @kindex 121 Q @r{(}@code{vip-query-replace}@r{)}
 Same as @kbd{R} except that you will be asked form confirmation before each
 replacement
@@ -1569,7 +1569,7 @@ keymap.  See GNU Emacs Manual for details.
 @item C-@@
 @kindex 000 C-@@ @r{(}@code{set-mark-command}@r{)}
 Set mark and push previous mark on mark ring (@code{set-mark-command}).
-@item TAB
+@item @key{TAB}
 @kindex 011 TAB @r{(}@code{indent-for-tab-command}@r{)}
 Indent line for current major mode (@code{indent-for-tab-command}).
 @item C-j
diff --git a/doc/misc/viper.texi b/doc/misc/viper.texi
index e1c45fb40e..2b300f6493 100644
--- a/doc/misc/viper.texi
+++ b/doc/misc/viper.texi
@@ -1083,7 +1083,7 @@ remembered (This is called ``learn mode'' in some editors.)
 where @samp{register} is any character from @samp{a} through @samp{z}.  Then
 you can execute this macro using @kbd{@@register}.  It is, of course,
 possible to yank some text into a register and execute it using
-@kbd{@@register}.  Typing @kbd{@@@@}, @kbd{@@RET}, or @kbd{@@C-j} will
+@kbd{@@register}.  Typing @kbd{@@@@}, @kbd{@@@key{RET}}, or @kbd{@@C-j} will
 execute the last macro that was executed using @kbd{@@register}.
 
 Viper will automatically lowercase the register, so that pressing the
-- 
2.21.0


From fdecf1f56ee14c230f0072247c36dbb67c5ac31c Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Tue, 27 Feb 2018 18:44:15 +0200
Subject: [PATCH 035/297] Avoid aborts in 'md5'

* src/fns.c (extract_data_from_object): Don't crash if called with
an invalid object.  (Bug#30627)
---
 src/fns.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/src/fns.c b/src/fns.c
index b45de7d7a2..47848dc56d 100644
--- a/src/fns.c
+++ b/src/fns.c
@@ -3046,6 +3046,9 @@ extract_data_from_object (Lisp_Object spec,
 #endif
     }
 
+  if (!STRINGP (object))
+    signal_error ("Invalid object argument",
+		  NILP (object) ? build_string ("nil") : object);
   return SSDATA (object);
 }
 
-- 
2.21.0


From b88b2a8fadc1eff4b6368f04946be5eb82caf100 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Tue, 27 Feb 2018 19:46:06 +0200
Subject: [PATCH 036/297] More fixes in the Emacs manual

* doc/emacs/xresources.texi (Table of Resources, Lucid Resources):
Sort the resources.
(Lucid Resources): Add cross-references.
(GTK Resource Basics): Fix wording.
(GTK styles): Add empty lines in a @table.  Suggested by Michael
Albinus <michael.albinus@gmx.de> in emacs-manual-bugs@gnu.org.
---
 doc/emacs/xresources.texi | 73 ++++++++++++++++++++++-----------------
 1 file changed, 41 insertions(+), 32 deletions(-)

diff --git a/doc/emacs/xresources.texi b/doc/emacs/xresources.texi
index 096e747a04..69832fdb60 100644
--- a/doc/emacs/xresources.texi
+++ b/doc/emacs/xresources.texi
@@ -160,16 +160,16 @@ Width of the frame's external border, in pixels.  This has no effect
 if Emacs is compiled with GTK+ support.
 @end ifnottex
 
-@item @code{cursorColor} (class @code{Foreground})
-Text cursor color.  If this resource is specified when Emacs starts
-up, Emacs sets its value as the background color of the @code{cursor}
-face (@pxref{Faces}).
-
 @item @code{cursorBlink} (class @code{CursorBlink})
 If the value of this resource is @samp{off} or @samp{false} or
 @samp{0} at startup, Emacs disables Blink Cursor mode (@pxref{Cursor
 Display}).
 
+@item @code{cursorColor} (class @code{Foreground})
+Text cursor color.  If this resource is specified when Emacs starts
+up, Emacs sets its value as the background color of the @code{cursor}
+face (@pxref{Faces}).
+
 @item @code{font} (class @code{Font})
 Font name for the @code{default} face (@pxref{Fonts}).  You can also
 specify a fontset name (@pxref{Fontsets}).
@@ -184,6 +184,13 @@ in which case Emacs tries using all available font backends.
 @item @code{foreground} (class @code{Foreground})
 Default foreground color for text.
 
+@item @code{fullscreen} (class @code{Fullscreen})
+The desired fullscreen size.  The value can be one of @code{fullboth},
+@code{maximized}, @code{fullwidth} or @code{fullheight}, which
+correspond to the command-line options @samp{-fs}, @samp{-mm},
+@samp{-fw}, and @samp{-fh} (@pxref{Window Size X}).  Note that this
+applies to the initial frame only.
+
 @item @code{geometry} (class @code{Geometry})
 Window size and position.  The value should be a size and position
 specification, of the same form as in the @samp{-g} or
@@ -193,18 +200,15 @@ The size applies to all frames in the Emacs session, but the position
 applies only to the initial Emacs frame (or, in the case of a resource
 for a specific frame name, only that frame).
 
-
 Be careful not to specify this resource as @samp{emacs*geometry}, as
 that may affect individual menus as well as the main Emacs frame.
 
-@item @code{fullscreen} (class @code{Fullscreen})
-The desired fullscreen size.  The value can be one of @code{fullboth},
-@code{maximized}, @code{fullwidth} or @code{fullheight}, which
-correspond to the command-line options @samp{-fs}, @samp{-mm},
-@samp{-fw}, and @samp{-fh} (@pxref{Window Size X}).  Note that this
-applies to the initial frame only.
-
 @ifnottex
+@item @code{horizontalScrollBars} (class @code{ScrollBars})
+If the value of this resource is @samp{off} or @samp{false} or
+@samp{0}, Emacs disables Horizontal Scroll Bar mode at startup
+(@pxref{Scroll Bars}).
+
 @item @code{iconName} (class @code{Title})
 Name to display in the icon.
 
@@ -318,8 +322,8 @@ This is only relevant if your Emacs is built with XIM support.  It
 might be useful to turn off XIM on slow X client/server links.
 
 @item @code{verticalScrollBars} (class @code{ScrollBars})
-Give frames scroll bars if @samp{on}; don't have scroll bars if
-@samp{off}.
+Give frames scroll bars on the left if @samp{left}, on the right if
+@samp{right}; don't have scroll bars if @samp{off}.
 
 @ifnottex
 @item @code{visualClass} (class @code{VisualClass})
@@ -346,13 +350,13 @@ resources.  @xref{Face Customization}.
 @cindex Lucid Widget X Resources
 
   If Emacs is compiled with the X toolkit support using Lucid widgets,
-you can use X resources to customize the appearance of the menu bar,
-pop-up menus, and dialog boxes.  The resources for the menu bar fall
-in the @samp{pane.menubar} class (following, as always, either the
-name of the Emacs executable or @samp{Emacs} for all Emacs
-invocations).  The resources for the pop-up menu are in the
-@samp{menu*} class.  The resources for dialog boxes are in the
-@samp{dialog*} class.
+you can use X resources to customize the appearance of the menu bar
+(@pxref{Menu Bar}), pop-up menus, and dialog boxes (@pxref{Dialog
+Boxes}).  The resources for the menu bar fall in the
+@samp{pane.menubar} class (following, as always, either the name of
+the Emacs executable or @samp{Emacs} for all Emacs invocations).  The
+resources for the pop-up menu are in the @samp{menu*} class.  The
+resources for dialog boxes are in the @samp{dialog*} class.
 
   For example, to display menu bar entries with the @samp{Courier-12}
 font (@pxref{Fonts}), write this:
@@ -374,12 +378,12 @@ Here is a list of resources for menu bars, pop-up menus, and dialogs:
 Font for menu item text.
 @item fontSet
 Fontset for menu item text.
-@item foreground
-Foreground color.
 @item background
 Background color.
 @item buttonForeground
 Foreground color for a selected item.
+@item foreground
+Foreground color.
 @ifnottex
 @item horizontalSpacing
 Horizontal spacing in pixels between items.  Default is 3.
@@ -403,14 +407,15 @@ Margin of the menu bar, in characters.  Default is 1.
 
   If Emacs is compiled with the X toolkit support using Motif or
 LessTif widgets, you can use X resources to customize the appearance
-of the menu bar, pop-up menus, and dialog boxes.  However, the
-resources are organized differently from Lucid widgets.
+of the menu bar (@pxref{Menu Bar}), pop-up menus, and dialog boxes
+(@pxref{Dialog Boxes}).  However, the resources are organized
+differently from Lucid widgets.
 
   The resource names for the menu bar are in the @samp{pane.menubar}
 class, and they must be specified in this form:
 
 @smallexample
-Emacs.pane.menubar.@var{subwidget}.@var{resource}:  @var{value}
+Emacs.pane.menubar.@var{subwidget}.@var{resource}: @var{value}
 @end smallexample
 
 @noindent
@@ -427,7 +432,7 @@ For example, to specify the font @samp{8x16} for all menu bar items,
 including submenus, write this:
 
 @smallexample
-Emacs.pane.menubar.*.fontList:  8x16
+Emacs.pane.menubar.*.fontList: 8x16
 @end smallexample
 
   Each item in a submenu also has its own name for X resources; for
@@ -471,7 +476,7 @@ itself, you must first specify the resource for all of them, then
 override the value for submenus alone.  Here is an example:
 
 @smallexample
-Emacs.pane.menubar.*.fontList:  8x16
+Emacs.pane.menubar.*.fontList: 9x18
 Emacs.pane.menubar.popup_*.fontList: 8x16
 @end smallexample
 
@@ -556,7 +561,7 @@ system, see
 @appendixsubsec GTK Resource Basics
 
   In a GTK+ 2 resource file (usually @file{~/.emacs.d/gtkrc}), the
-simplest kinds of resource settings simply assign a value to a
+simplest kind of a resource setting simply assigns a value to a
 variable.  For example, putting the following line in the resource
 file changes the font on all GTK+ widgets to @samp{courier-12}:
 
@@ -770,20 +775,24 @@ possible states are:
 @table @code
 @item NORMAL
 This is the default state for widgets.
+
 @item ACTIVE
 This is the state for a widget that is ready to do something.  It is
 also for the trough of a scroll bar, i.e., @code{bg[ACTIVE] = "red"}
 sets the scroll bar trough to red.  Buttons that have been armed
 (pressed but not released yet) are in this state.
+
 @item PRELIGHT
 This is the state for a widget that can be manipulated, when the mouse
 pointer is over it---for example when the mouse is over the thumb in
 the scroll bar or over a menu item.  When the mouse is over a button
 that is not pressed, the button is in this state.
+
 @item SELECTED
 This is the state for data that has been selected by the user.  It can
 be selected text or items selected in a list.  This state is not used
 in Emacs.
+
 @item INSENSITIVE
 This is the state for widgets that are visible, but they cannot be
 manipulated in the usual way---for example, buttons that can't be
@@ -805,14 +814,14 @@ dialog.
 
 @item bg_pixmap[@var{state}] = "@var{pixmap}"
 This specifies an image background (instead of a background color).
-@var{pixmap} should be the image file name.  GTK can use a number of
+@var{pixmap} should be the image file name.  GTK+ can use a number of
 image file formats, including XPM, XBM, GIF, JPEG and PNG@.  If you
 want a widget to use the same image as its parent, use
 @samp{<parent>}.  If you don't want any image, use @samp{<none>}.
 @samp{<none>} is the way to cancel a background image inherited from a
 parent style.
 
-You can't specify the file by its absolute file name.  GTK looks for
+You can't specify the file by its absolute file name.  GTK+ looks for
 the pixmap file in directories specified in @code{pixmap_path}.
 @code{pixmap_path} is a colon-separated list of directories within
 double quotes, specified at the top level in a @file{gtkrc} file
-- 
2.21.0


From fe16db9003976f64f58c1e8776b1771d6ef83971 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Tue, 27 Feb 2018 19:58:33 +0200
Subject: [PATCH 037/297] * doc/emacs/killing.texi (Rectangles): Don't use @key
 for characters.

---
 doc/emacs/killing.texi | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/doc/emacs/killing.texi b/doc/emacs/killing.texi
index 35096cdf53..4c47c8b047 100644
--- a/doc/emacs/killing.texi
+++ b/doc/emacs/killing.texi
@@ -857,7 +857,8 @@ region is active.
 
 Unlike the standard region, the region-rectangle can have its corners
 extended past the end of buffer, or inside stretches of white space
-that point normally cannot enter, like the @key{TAB}.
+that point normally cannot enter, like in the middle of a TAB
+character.
 
 @findex rectangle-exchange-point-and-mark
 @findex exchange-point-and-mark@r{, in rectangle-mark-mode}
-- 
2.21.0


From 8778c5f8eb9a4da62ba36727ff0b5f6690674a9b Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Tue, 27 Feb 2018 12:55:04 -0500
Subject: [PATCH 038/297] * lisp/emulation/viper.el: Unbreak it.

Since 2017-03-19, M-x viper failed with function void cl-member-if.
Perhaps it isn't used much.
---
 lisp/emulation/viper.el | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/lisp/emulation/viper.el b/lisp/emulation/viper.el
index 7292fd58c1..13a88ad11f 100644
--- a/lisp/emulation/viper.el
+++ b/lisp/emulation/viper.el
@@ -300,6 +300,8 @@
 
 ;;; Code:
 
+(require 'cl-lib)
+
 ;; compiler pacifier
 (defvar mark-even-if-inactive)
 (defvar quail-mode)
-- 
2.21.0


From 78995996a9e3d283ef214566f3e9b4f19238cc8a Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Tue, 27 Feb 2018 20:13:00 -0800
Subject: [PATCH 039/297] Document print-escape-control-characters

* doc/lispref/streams.texi, etc/NEWS: Add doc.
---
 doc/lispref/streams.texi | 7 +++++++
 etc/NEWS                 | 4 ++++
 2 files changed, 11 insertions(+)

diff --git a/doc/lispref/streams.texi b/doc/lispref/streams.texi
index 8f531347dc..cc6e066438 100644
--- a/doc/lispref/streams.texi
+++ b/doc/lispref/streams.texi
@@ -778,6 +778,13 @@ In the second expression, the local binding of
 @code{prin1}, but not during the printing of the result.
 @end defvar
 
+@defvar print-escape-control-characters
+If this variable is non-@code{nil}, control characters in strings are
+printed as backslash sequences by the print functions @code{prin1} and
+@code{print} that print with quoting.  If this variable and
+@code{print-escape-newlines} are both non-@code{nil}, the latter takes
+precedences for newlines and formfeeds.
+
 @defvar print-escape-nonascii
 If this variable is non-@code{nil}, then unibyte non-@acronym{ASCII}
 characters in strings are unconditionally printed as backslash sequences
diff --git a/etc/NEWS b/etc/NEWS
index 0eb589f45d..55b56357fb 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -1120,6 +1120,10 @@ instead of 0.8, to avoid rounding glitches.
 when a symbol's value is changed.  This is used to implement the new
 debugger command 'debug-on-variable-change'.
 
++++
+** New variable 'print-escape-control-characters' causes 'prin1' and
+'print' to output control characters as backslash sequences.
+
 +++
 ** Time conversion functions that accept a time zone rule argument now
 allow it to be OFFSET or a list (OFFSET ABBR), where the integer
-- 
2.21.0


From 1c9af20276525f06fcdbcc1999d8b2019bb6c203 Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Wed, 28 Feb 2018 16:28:11 +0100
Subject: [PATCH 040/297] Use "GTK+" where applicable in the manual

* doc/emacs/display.texi (Standard Faces, Standard Faces):
* doc/emacs/emacs.texi (Top):
* doc/emacs/files.texi (Visiting):
* doc/emacs/frames.texi (Scroll Bars):
* doc/emacs/xresources.texi: Use "GTK+" where applicable.
---
 doc/emacs/display.texi    |  6 +++---
 doc/emacs/emacs.texi      |  4 ++--
 doc/emacs/files.texi      |  2 +-
 doc/emacs/frames.texi     |  4 ++--
 doc/emacs/xresources.texi | 22 +++++++++++-----------
 5 files changed, 19 insertions(+), 19 deletions(-)

diff --git a/doc/emacs/display.texi b/doc/emacs/display.texi
index 5ddc3d63e7..312f70e13b 100644
--- a/doc/emacs/display.texi
+++ b/doc/emacs/display.texi
@@ -656,8 +656,8 @@ This face is used to highlight lazy matches for Isearch and Query
 Replace (matches other than the current one).
 @item region
 This face is used for displaying an active region (@pxref{Mark}).
-When Emacs is built with GTK support, its colors are taken from the
-current GTK theme.
+When Emacs is built with GTK+ support, its colors are taken from the
+current GTK+ theme.
 @item secondary-selection
 This face is used for displaying a secondary X selection (@pxref{Secondary
 Selection}).
@@ -741,7 +741,7 @@ The @code{:background} attribute of this face specifies the color of
 the text cursor.  @xref{Cursor Display}.
 @item tooltip
 This face is used for tooltip text.  By default, if Emacs is built
-with GTK support, tooltips are drawn via GTK and this face has no
+with GTK+ support, tooltips are drawn via GTK+ and this face has no
 effect.  @xref{Tooltips}.
 @item mouse
 This face determines the color of the mouse pointer.
diff --git a/doc/emacs/emacs.texi b/doc/emacs/emacs.texi
index e289cb5802..a9be170241 100644
--- a/doc/emacs/emacs.texi
+++ b/doc/emacs/emacs.texi
@@ -1223,8 +1223,8 @@ GTK resources
 
 * GTK Resource Basics::   Basic usage of GTK+ resources.
 * GTK Widget Names::      How GTK+ widgets are named.
-* GTK Names in Emacs::    GTK widgets used by Emacs.
-* GTK styles::            What can be customized in a GTK widget.
+* GTK Names in Emacs::    GTK+ widgets used by Emacs.
+* GTK styles::            What can be customized in a GTK+ widget.
 
 Emacs and macOS / GNUstep
 
diff --git a/doc/emacs/files.texi b/doc/emacs/files.texi
index dfdcc205da..6594f38e88 100644
--- a/doc/emacs/files.texi
+++ b/doc/emacs/files.texi
@@ -281,7 +281,7 @@ files.  Firstly, when Emacs is built with a suitable GUI toolkit,
 commands invoked with the mouse (by clicking on the menu bar or tool
 bar) use the toolkit's standard file selection dialog instead of
 prompting for the file name in the minibuffer.  On GNU/Linux and Unix
-platforms, Emacs does this when built with GTK, LessTif, and Motif
+platforms, Emacs does this when built with GTK+, LessTif, and Motif
 toolkits; on MS-Windows and Mac, the GUI version does that by default.
 For information on how to customize this, see @ref{Dialog Boxes}.
 
diff --git a/doc/emacs/frames.texi b/doc/emacs/frames.texi
index 94c8821006..c0af93cdfe 100644
--- a/doc/emacs/frames.texi
+++ b/doc/emacs/frames.texi
@@ -994,9 +994,9 @@ when the entire buffer is visible.
 
 @cindex @code{scroll-bar} face
   The visual appearance of the scroll bars is controlled by the
-@code{scroll-bar} face.  (Some toolkits, such as GTK and MS-Windows,
+@code{scroll-bar} face.  (Some toolkits, such as GTK+ and MS-Windows,
 ignore this face; the scroll-bar appearance there can only be
-customized system-wide, for GTK @pxref{GTK resources}).
+customized system-wide, for GTK+ @pxref{GTK resources}).
 
 @cindex vertical border
   On graphical frames, vertical scroll bars implicitly serve to separate
diff --git a/doc/emacs/xresources.texi b/doc/emacs/xresources.texi
index 69832fdb60..88bfb8261c 100644
--- a/doc/emacs/xresources.texi
+++ b/doc/emacs/xresources.texi
@@ -12,10 +12,10 @@ resources, as is usual for programs that use X.
 graphical widgets, such as the menu-bar, scroll-bar, and dialog boxes,
 is determined by
 @ifnottex
-GTK resources, which we will also describe.
+GTK+ resources, which we will also describe.
 @end ifnottex
 @iftex
-GTK resources.
+GTK+ resources.
 @end iftex
 When Emacs is built without GTK+ support, the appearance of these
 widgets is determined by additional X resources.
@@ -28,7 +28,7 @@ system registry (@pxref{MS-Windows Registry}).
 * Table of Resources::  Table of specific X resources that affect Emacs.
 * Lucid Resources::     X resources for Lucid menus.
 * Motif Resources::     X resources for Motif and LessTif menus.
-* GTK resources::       Resources for GTK widgets.
+* GTK resources::       Resources for GTK+ widgets.
 @end menu
 
 @node Resources
@@ -515,7 +515,7 @@ The color for the border shadow, on the top and the left.
 @node GTK resources
 @appendixsec GTK resources
 @cindex GTK+ resources
-@cindex resource files for GTK
+@cindex resource files for GTK+
 @cindex @file{~/.gtkrc-2.0} file
 @cindex @file{~/.emacs.d/gtkrc} file
 
@@ -530,7 +530,7 @@ resources are specified in either the file @file{~/.emacs.d/gtkrc}
 (for Emacs-specific GTK+ resources), or @file{~/.gtkrc-2.0} (for
 general GTK+ resources).  We recommend using @file{~/.emacs.d/gtkrc},
 since GTK+ seems to ignore @file{~/.gtkrc-2.0} when running GConf with
-GNOME@.  Note, however, that some GTK themes may override
+GNOME@.  Note, however, that some GTK+ themes may override
 customizations in @file{~/.emacs.d/gtkrc}; there is nothing we can do
 about this.  GTK+ resources do not affect aspects of Emacs unrelated
 to GTK+ widgets, such as fonts and colors in the main Emacs window;
@@ -553,8 +553,8 @@ system, see
 @menu
 * GTK Resource Basics::   Basic usage of GTK+ resources.
 * GTK Widget Names::      How GTK+ widgets are named.
-* GTK Names in Emacs::    GTK widgets used by Emacs.
-* GTK styles::            What can be customized in a GTK widget.
+* GTK Names in Emacs::    GTK+ widgets used by Emacs.
+* GTK styles::            What can be customized in a GTK+ widget.
 @end menu
 
 @node GTK Resource Basics
@@ -617,7 +617,7 @@ widget "*verticalScrollBar*" style "scroll"
 
 @node GTK Widget Names
 @appendixsubsec GTK widget names
-@cindex GTK widget names
+@cindex GTK+ widget names
 
   A GTK+ widget is specified by a @dfn{widget name} and a @dfn{widget
 class}.  The widget name refers to a specific widget
@@ -662,8 +662,8 @@ widget "*" style "my_style"
 
 @node GTK Names in Emacs
 @appendixsubsec GTK Widget Names in Emacs
-@cindex GTK widget names in Emacs
-@cindex GTK widget classes
+@cindex GTK+ widget names in Emacs
+@cindex GTK+ widget classes
 
   The GTK+ widgets used by an Emacs frame are listed below:
 
@@ -726,7 +726,7 @@ widget_class "*Menu*" style "my_menu_style"
 
 @node GTK styles
 @appendixsubsec GTK styles
-@cindex GTK styles
+@cindex GTK+ styles
 
   Here is an example of two GTK+ style declarations:
 
-- 
2.21.0


From cfa48c8f8e26a3715a1003c49a8a2a10869e6808 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Wed, 28 Feb 2018 12:35:44 -0500
Subject: [PATCH 041/297] * doc/lispref/streams.texi (Output Variables): Fix
 previous.

---
 doc/lispref/streams.texi | 1 +
 1 file changed, 1 insertion(+)

diff --git a/doc/lispref/streams.texi b/doc/lispref/streams.texi
index cc6e066438..a07500715e 100644
--- a/doc/lispref/streams.texi
+++ b/doc/lispref/streams.texi
@@ -784,6 +784,7 @@ printed as backslash sequences by the print functions @code{prin1} and
 @code{print} that print with quoting.  If this variable and
 @code{print-escape-newlines} are both non-@code{nil}, the latter takes
 precedences for newlines and formfeeds.
+@end defvar
 
 @defvar print-escape-nonascii
 If this variable is non-@code{nil}, then unibyte non-@acronym{ASCII}
-- 
2.21.0


From 6edcc6f858b5a8f9d0a5f500535ad6c357a3a94a Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Wed, 28 Feb 2018 13:39:52 -0500
Subject: [PATCH 042/297] Quieten cedet "might not be defined at runtime"
 compile warnings

* admin/grammars/scheme.by (semantic-parse-region):
* lisp/cedet/ede.el (ede--project-inode):
* lisp/cedet/semantic/texi.el (semantic-analyze-context):
Declare.
---
 admin/grammars/scheme.by    | 5 +++++
 lisp/cedet/ede.el           | 1 +
 lisp/cedet/semantic/texi.el | 2 ++
 3 files changed, 8 insertions(+)

diff --git a/admin/grammars/scheme.by b/admin/grammars/scheme.by
index ce9fff0286..5ea25508fd 100644
--- a/admin/grammars/scheme.by
+++ b/admin/grammars/scheme.by
@@ -20,6 +20,11 @@
 %package semantic-scm-by
 %provide semantic/bovine/scm-by
 
+%{
+(declare-function semantic-parse-region "semantic"
+		  (start end &optional nonterminal depth returnonerror))
+}
+
 %languagemode  scheme-mode
 %start         scheme
 
diff --git a/lisp/cedet/ede.el b/lisp/cedet/ede.el
index 76acf8a941..5bbc2d0f85 100644
--- a/lisp/cedet/ede.el
+++ b/lisp/cedet/ede.el
@@ -1095,6 +1095,7 @@ Flush the dead projects from the project cache."
     ))
 
 (defvar ede--disable-inode)             ;Defined in ede/files.el.
+(declare-function ede--project-inode "ede/files" (proj))
 
 (defun ede-global-list-sanity-check ()
   "Perform a sanity check to make sure there are no duplicate projects."
diff --git a/lisp/cedet/semantic/texi.el b/lisp/cedet/semantic/texi.el
index 9769ae8928..7fe1932479 100644
--- a/lisp/cedet/semantic/texi.el
+++ b/lisp/cedet/semantic/texi.el
@@ -365,6 +365,8 @@ Optional argument POINT is where to look for the environment."
 (eval-when-compile
   (require 'semantic/analyze))
 
+(declare-function semantic-analyze-context "semantic/analyze")
+
 (define-mode-local-override semantic-analyze-current-context
   texinfo-mode (point)
   "Analysis context makes no sense for texinfo.  Return nil."
-- 
2.21.0


From 6bf50256fcf626a2c4ab618d9b73e205d3c35a54 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Wed, 28 Feb 2018 13:44:12 -0500
Subject: [PATCH 043/297] Fix header comment in generated bovine grammar file

* lisp/cedet/semantic/bovine/grammar.el (bovine--make-parser-1):
Fix header comment in generated scm-by.el.
---
 lisp/cedet/semantic/bovine/grammar.el | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/lisp/cedet/semantic/bovine/grammar.el b/lisp/cedet/semantic/bovine/grammar.el
index 0eab01b58b..65c856a8ca 100644
--- a/lisp/cedet/semantic/bovine/grammar.el
+++ b/lisp/cedet/semantic/bovine/grammar.el
@@ -475,6 +475,7 @@ Menu items are appended to the common grammar menu.")
 	 ;; This is with-demoted-errors.
 	 (condition-case err
 	     (with-current-buffer (find-file-noselect infile)
+	       (setq infile buffer-file-name)
 	       (if outdir (setq default-directory outdir))
 	       (semantic-grammar-create-package nil t))
 	   (error (message "%s" (error-message-string err)) nil)))
@@ -509,8 +510,12 @@ Menu items are appended to the common grammar menu.")
 
 ;;; Commentary:
 ;;
-;; This file was generated from admin/grammars/"
-		lang ".by.
+;; This file was generated from "
+		(if (string-match "\\(OFFadmin/grammars/.*\\.by\\)\\'" infile)
+		    (match-string 1 infile)
+		  (concat "admin/grammars/"
+			  (if (string-equal lang "scm") "scheme" lang) ".by"))
+".
 
 ;;; Code:
 ")
-- 
2.21.0


From 812fc7255dadacf25b7f3335b4272aea102d9c7d Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Wed, 28 Feb 2018 13:55:53 -0500
Subject: [PATCH 044/297] ; Remove debug code left in previous by mistake

---
 lisp/cedet/semantic/bovine/grammar.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lisp/cedet/semantic/bovine/grammar.el b/lisp/cedet/semantic/bovine/grammar.el
index 65c856a8ca..1746f3e6ff 100644
--- a/lisp/cedet/semantic/bovine/grammar.el
+++ b/lisp/cedet/semantic/bovine/grammar.el
@@ -511,7 +511,7 @@ Menu items are appended to the common grammar menu.")
 ;;; Commentary:
 ;;
 ;; This file was generated from "
-		(if (string-match "\\(OFFadmin/grammars/.*\\.by\\)\\'" infile)
+		(if (string-match "\\(admin/grammars/.*\\.by\\)\\'" infile)
 		    (match-string 1 infile)
 		  (concat "admin/grammars/"
 			  (if (string-equal lang "scm") "scheme" lang) ".by"))
-- 
2.21.0


From 72ddb53582852df86d65f7fd0a804b258e5701b6 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Wed, 28 Feb 2018 14:35:47 -0500
Subject: [PATCH 045/297] * lisp/url/url-handlers.el
 (mm-charset-to-coding-system): Declare.

---
 lisp/url/url-handlers.el | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/lisp/url/url-handlers.el b/lisp/url/url-handlers.el
index 1fe0af65ff..7d0320cb5b 100644
--- a/lisp/url/url-handlers.el
+++ b/lisp/url/url-handlers.el
@@ -41,6 +41,9 @@
 (declare-function mm-decode-string "mm-bodies" (string charset))
 ;; mm-decode loads mail-parse.
 (declare-function mail-content-type-get "mail-parse" (ct attribute))
+;; mm-decode loads mm-bodies, which loads mm-util.
+(declare-function mm-charset-to-coding-system "mm-util"
+                 (charset &optional lbt allow-override silent))
 
 ;; Implementation status
 ;; ---------------------
-- 
2.21.0


From 9402debf9c131a0724514ad8dff43cc314a303db Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Wed, 28 Feb 2018 14:35:56 -0500
Subject: [PATCH 046/297] Quieten eshell compilation

* lisp/eshell/em-tramp.el: Require esh-cmd.
* lisp/eshell/esh-ext.el: Requie esh-io at runtime too.
---
 lisp/eshell/em-tramp.el | 1 +
 lisp/eshell/esh-ext.el  | 2 +-
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/lisp/eshell/em-tramp.el b/lisp/eshell/em-tramp.el
index c45453bf28..004c495490 100644
--- a/lisp/eshell/em-tramp.el
+++ b/lisp/eshell/em-tramp.el
@@ -26,6 +26,7 @@
 ;;; Code:
 
 (require 'esh-util)
+(require 'esh-cmd)
 
 (eval-when-compile
   (require 'esh-mode)
diff --git a/lisp/eshell/esh-ext.el b/lisp/eshell/esh-ext.el
index 1bfab23c22..ba5182deb4 100644
--- a/lisp/eshell/esh-ext.el
+++ b/lisp/eshell/esh-ext.el
@@ -37,8 +37,8 @@
 
 (eval-when-compile
   (require 'cl-lib)
-  (require 'esh-io)
   (require 'esh-cmd))
+(require 'esh-io)
 (require 'esh-arg)
 (require 'esh-opt)
 (require 'esh-proc)
-- 
2.21.0


From 3cb969e159d10a59477a6d3e629785be982b73da Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Wed, 28 Feb 2018 15:20:42 -0500
Subject: [PATCH 047/297] * configure.ac (with_gconf): Respect --without-all.

---
 configure.ac | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/configure.ac b/configure.ac
index ef13d6879e..9310a70a40 100644
--- a/configure.ac
+++ b/configure.ac
@@ -365,7 +365,12 @@ OPTION_DEFAULT_OFF([w32], [use native MS Windows GUI in a Cygwin build])
 OPTION_DEFAULT_ON([gpm],[don't use -lgpm for mouse support on a GNU/Linux console])
 OPTION_DEFAULT_ON([dbus],[don't compile with D-Bus support])
 AC_ARG_WITH([gconf],[AS_HELP_STRING([--with-gconf],
-[compile with Gconf support (Gsettings replaces this)])],[],[with_gconf=maybe])
+[compile with Gconf support (Gsettings replaces this)])],[],
+[if test $with_features = yes; then
+with_gconf=maybe
+else
+with_gconf=no
+fi])
 OPTION_DEFAULT_ON([gsettings],[don't compile with GSettings support])
 OPTION_DEFAULT_ON([selinux],[don't compile with SELinux support])
 OPTION_DEFAULT_ON([gnutls],[don't use -lgnutls for SSL/TLS support])
-- 
2.21.0


From 4cf4f411d49c8ca3192163cddb4cf81d9b0084c5 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Wed, 28 Feb 2018 15:50:37 -0500
Subject: [PATCH 048/297] Quieten compilation of octave.el

* lisp/progmodes/octave.el (compilation-forget-errors): Re-declare.
---
 lisp/progmodes/octave.el | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/lisp/progmodes/octave.el b/lisp/progmodes/octave.el
index c768d8d6f4..f5d764e16c 100644
--- a/lisp/progmodes/octave.el
+++ b/lisp/progmodes/octave.el
@@ -1165,6 +1165,8 @@ q: Don't fix\n" func file))
   "Face used to highlight function comment block.")
 
 (eval-when-compile (require 'texinfo))
+;; Undo the effects of texinfo loading tex-mode loading compile.
+(declare-function compilation-forget-errors "compile" ())
 
 (defun octave-font-lock-texinfo-comment ()
   (let ((kws
-- 
2.21.0


From 0b7cfdf2d3ba801ab95e348c433c55090aea2a9e Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Wed, 28 Feb 2018 16:55:41 -0500
Subject: [PATCH 049/297] Quieten without-x org compilation

* lisp/org/org.el (image-refresh):
* lisp/org/ox-odt.el (clear-image-cache, image-size): Declare.
---
 lisp/org/org.el    | 5 ++++-
 lisp/org/ox-odt.el | 4 ++++
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/lisp/org/org.el b/lisp/org/org.el
index 4e4620549c..2f60a07505 100644
--- a/lisp/org/org.el
+++ b/lisp/org/org.el
@@ -19316,6 +19316,9 @@ INCLUDE-LINKED is passed to `org-display-inline-images'."
     (org-toggle-inline-images)
     (org-toggle-inline-images)))
 
+;; For without-x builds.
+(declare-function image-refresh "image" (spec &optional frame))
+
 (defun org-display-inline-images (&optional include-linked refresh beg end)
   "Display inline images.
 
@@ -22905,7 +22908,7 @@ matches in paragraphs or comments, use it."
 		      (match-string 0)
 		    "")))))))))))
 
-(declare-function message-goto-body "message" ())
+(declare-function message-goto-body "message" (&optional interactive))
 (defvar message-cite-prefix-regexp)	; From message.el
 
 (defun org-fill-element (&optional justify)
diff --git a/lisp/org/ox-odt.el b/lisp/org/ox-odt.el
index cdee568fc8..1fc697a6a8 100644
--- a/lisp/org/ox-odt.el
+++ b/lisp/org/ox-odt.el
@@ -2192,6 +2192,10 @@ SHORT-CAPTION are strings."
     (org-odt-create-manifest-file-entry media-type target-file)
     target-file))
 
+;; For --without-x builds.
+(declare-function clear-image-cache "image.c" (&optional filter))
+(declare-function image-size "image.c" (spec &optional pixels frame))
+
 (defun org-odt--image-size
   (file info &optional user-width user-height scale dpi embed-as)
   (let* ((--pixels-to-cms
-- 
2.21.0


From 220bfa2c9928f8712bd64db4692ceb56c8d947b5 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 1 Mar 2018 07:29:26 -0500
Subject: [PATCH 050/297] ; Auto-commit of loaddefs files.

---
 lisp/ldefs-boot.el | 74 ++++++++++++++++++++++++++++++----------------
 1 file changed, 49 insertions(+), 25 deletions(-)

diff --git a/lisp/ldefs-boot.el b/lisp/ldefs-boot.el
index 9dfdab43dc..650122e1c5 100644
--- a/lisp/ldefs-boot.el
+++ b/lisp/ldefs-boot.el
@@ -1969,7 +1969,8 @@ result.  The overhead of the `lambda's is accounted for.
 
 (autoload 'benchmark "benchmark" "\
 Print the time taken for REPETITIONS executions of FORM.
-Interactively, REPETITIONS is taken from the prefix arg.
+Interactively, REPETITIONS is taken from the prefix arg, and
+the command prompts for the form to benchmark.
 For non-interactive use see also `benchmark-run' and
 `benchmark-run-compiled'.
 
@@ -2927,6 +2928,7 @@ Like `bug-reference-mode', but only buttonize in comments and strings.
 (put 'byte-compile-dynamic 'safe-local-variable 'booleanp)
 (put 'byte-compile-disable-print-circle 'safe-local-variable 'booleanp)
 (put 'byte-compile-dynamic-docstrings 'safe-local-variable 'booleanp)
+(put 'byte-compile-error-on-warn 'safe-local-variable 'booleanp)
 
 (put 'byte-compile-warnings 'safe-local-variable (lambda (v) (or (symbolp v) (null (delq nil (mapcar (lambda (x) (not (symbolp x))) v))))))
 
@@ -6192,7 +6194,7 @@ For example, the MH-E package updates this alist as follows:
 
 The value of PACKAGE needs to be unique and it needs to match the
 PACKAGE value appearing in the :package-version keyword.  Since
-the user might see the value in a error message, a good choice is
+the user might see the value in an error message, a good choice is
 the official name of the package, such as MH-E or Gnus.")
 
 (defalias 'customize-changed 'customize-changed-options)
@@ -9813,8 +9815,11 @@ the mode if ARG is omitted or nil.
 
 Electric Pair mode is a global minor mode.  When enabled, typing
 an open parenthesis automatically inserts the corresponding
-closing parenthesis.  (Likewise for brackets, etc.). To toggle
-the mode in a single buffer, use `electric-pair-local-mode'.
+closing parenthesis, and vice versa.  (Likewise for brackets, etc.).
+If the region is active, the parentheses (brackets, etc.) are
+inserted around the region instead.
+
+To toggle the mode in a single buffer, use `electric-pair-local-mode'.
 
 \(fn &optional ARG)" t nil)
 
@@ -9893,7 +9898,8 @@ FUNSYM must be a symbol of a defined function.
 (autoload 'elp-instrument-list "elp" "\
 Instrument, for profiling, all functions in `elp-function-list'.
 Use optional LIST if provided instead.
-If called interactively, read LIST using the minibuffer.
+If called interactively, prompt for LIST in the minibuffer;
+type \"nil\" to use `elp-function-list'.
 
 \(fn &optional LIST)" t nil)
 
@@ -15143,7 +15149,7 @@ file name to `*.gz', and sets `grep-highlight-matches' to `always'.
 
 (defalias 'rzgrep 'zrgrep)
 
-(if (fboundp 'register-definition-prefixes) (register-definition-prefixes "grep" '("rgrep-" "grep-" "kill-grep")))
+(if (fboundp 'register-definition-prefixes) (register-definition-prefixes "grep" '("grep-" "rgrep-" "kill-grep")))
 
 ;;;***
 
@@ -16525,7 +16531,7 @@ See the documentation for `calendar-holidays' for details.")
 (autoload 'holidays "holidays" "\
 Display the holidays for last month, this month, and next month.
 If called with an optional prefix argument ARG, prompts for month and year.
-This function is suitable for execution in a init file.
+This function is suitable for execution in an init file.
 
 \(fn &optional ARG)" t nil)
 
@@ -16796,7 +16802,7 @@ Extract iCalendar events from current buffer.
 
 This function searches the current buffer for the first iCalendar
 object, reads it and adds all VEVENT elements to the diary
-DIARY-FILE.
+DIARY-FILENAME.
 
 It will ask for each appointment whether to add it to the diary
 unless DO-NOT-ASK is non-nil.  When called interactively,
@@ -16809,7 +16815,7 @@ Return code t means that importing worked well, return code nil
 means that an error has occurred.  Error messages will be in the
 buffer `*icalendar-errors*'.
 
-\(fn &optional DIARY-FILE DO-NOT-ASK NON-MARKING)" t nil)
+\(fn &optional DIARY-FILENAME DO-NOT-ASK NON-MARKING)" t nil)
 
 (if (fboundp 'register-definition-prefixes) (register-definition-prefixes "icalendar" '("icalendar-")))
 
@@ -17335,6 +17341,8 @@ Return the name of a buffer selected.
 PROMPT is the prompt to give to the user.  DEFAULT if given is the default
 buffer to be selected, which will go to the front of the list.
 If REQUIRE-MATCH is non-nil, an existing buffer must be selected.
+Optional arg PREDICATE if non-nil is a function limiting the
+buffers that can be considered.
 
 \(fn PROMPT &optional DEFAULT REQUIRE-MATCH PREDICATE)" nil nil)
 
@@ -17913,8 +17921,8 @@ If non-nil this pattern is passed to `imenu--generic-function' to
 create a buffer index.
 
 For example, see the value of `fortran-imenu-generic-expression'
-used by `fortran-mode' with `imenu-syntax-alist' set locally to
-give the characters which normally have \"symbol\" syntax
+used by `fortran-mode' with `imenu-syntax-alist' set locally so that
+characters which normally have \"symbol\" syntax are considered to have
 \"word\" syntax during matching.")
 (put 'imenu-generic-expression 'risky-local-variable t)
 
@@ -22012,7 +22020,7 @@ QUALITY can be:
 ;;;### (autoloads nil "mwheel" "mwheel.el" (0 0 0 0))
 ;;; Generated autoloads from mwheel.el
 
-(if (fboundp 'register-definition-prefixes) (register-definition-prefixes "mwheel" '("mwheel-" "mouse-wheel-")))
+(if (fboundp 'register-definition-prefixes) (register-definition-prefixes "mwheel" '("mouse-wheel-" "mwheel-")))
 
 ;;;***
 
@@ -23246,6 +23254,7 @@ Coloring:
 
 ;;;### (autoloads nil "org" "org/org.el" (0 0 0 0))
 ;;; Generated autoloads from org/org.el
+(push (purecopy '(org 9 1 6)) package--builtin-versions)
 
 (autoload 'org-babel-do-load-languages "org" "\
 Load the languages defined in `org-babel-load-languages'.
@@ -24408,8 +24417,6 @@ activate the package system at any time.")
 Load Emacs Lisp packages, and activate them.
 The variable `package-load-list' controls which packages to load.
 If optional arg NO-ACTIVATE is non-nil, don't activate packages.
-If `user-init-file' does not mention `(package-initialize)', add
-it to the file.
 If called as part of loading `user-init-file', set
 `package-enable-at-startup' to nil, to prevent accidentally
 loading packages twice.
@@ -26421,7 +26428,7 @@ Optional argument FACE specifies the face to do the highlighting.
 
 ;;;### (autoloads nil "python" "progmodes/python.el" (0 0 0 0))
 ;;; Generated autoloads from progmodes/python.el
-(push (purecopy '(python 0 25 2)) package--builtin-versions)
+(push (purecopy '(python 0 26 1)) package--builtin-versions)
 
 (add-to-list 'auto-mode-alist (cons (purecopy "\\.py[iw]?\\'") 'python-mode))
 
@@ -29843,13 +29850,6 @@ Like `mail' command, but display mail buffer in another frame.
 
 (put 'server-auth-dir 'risky-local-variable t)
 
-(defvar server-name "server" "\
-The name of the Emacs server, if this Emacs process creates one.
-The command `server-start' makes use of this.  It should not be
-changed while a server is running.")
-
-(custom-autoload 'server-name "server" t)
-
 (autoload 'server-start "server" "\
 Allow this Emacs process to be a server for client processes.
 This starts a server communications subprocess through which client
@@ -31725,7 +31725,7 @@ Args are NAME BUFFER HOST PORT.
 NAME is name for process.  It is modified if necessary to make it unique.
 BUFFER is the buffer (or `buffer-name') to associate with the process.
  Process output goes at end of that buffer, unless you specify
- an output stream or filter function to handle the output.
+ a filter function to handle the output.
  BUFFER may be also nil, meaning that this process is not associated
  with any buffer
 Third arg is name of the host to connect to, or its IP address.
@@ -34063,7 +34063,7 @@ Todo mode revisit this file or, with option
 file was last visited.
 
 If you call this command before you have created any todo file in
-the current format, and you have an todo file in old format, it
+the current format, and you have a todo file in old format, it
 will ask you whether to convert that file and show it.
 Otherwise, calling this command before any todo file exists
 prompts for a file name and an initial category (defaulting to
@@ -34313,6 +34313,27 @@ Discard Tramp from loading remote files.
 ;;;;;;  0 0))
 ;;; Generated autoloads from net/tramp-archive.el
 
+(defvar tramp-archive-enabled (featurep 'dbusbind) "\
+Non-nil when file archive support is available.")
+
+(defconst tramp-archive-suffixes '("7z" "apk" "ar" "cab" "CAB" "cpio" "deb" "depot" "exe" "iso" "jar" "lzh" "LZH" "msu" "MSU" "mtree" "pax" "rar" "rpm" "shar" "tar" "tbz" "tgz" "tlz" "txz" "warc" "xar" "xpi" "xps" "zip" "ZIP") "\
+List of suffixes which indicate a file archive.
+It must be supported by libarchive(3).")
+
+(defconst tramp-archive-compression-suffixes '("bz2" "gz" "lrz" "lz" "lz4" "lzma" "lzo" "uu" "xz" "Z") "\
+List of suffixes which indicate a compressed file.
+It must be supported by libarchive(3).")
+
+(defmacro tramp-archive-autoload-file-name-regexp nil "\
+Regular expression matching archive file names." `(concat "\\`" "\\(" ".+" "\\." (regexp-opt tramp-archive-suffixes) "\\(?:" "\\." (regexp-opt tramp-archive-compression-suffixes) "\\)*" "\\)" "\\(" "/" ".*" "\\)" "\\'"))
+
+(defun tramp-register-archive-file-name-handler nil "\
+Add archive file name handler to `file-name-handler-alist'." (when tramp-archive-enabled (add-to-list 'file-name-handler-alist (cons (tramp-archive-autoload-file-name-regexp) 'tramp-autoload-file-name-handler)) (put 'tramp-archive-file-name-handler 'safe-magic t)))
+
+(add-hook 'after-init-hook 'tramp-register-archive-file-name-handler)
+
+(add-hook 'tramp-archive-unload-hook (lambda nil (remove-hook 'after-init-hook 'tramp-register-archive-file-name-handler)))
+
 (if (fboundp 'register-definition-prefixes) (register-definition-prefixes "tramp-archive" '("tramp-" "with-parsed-tramp-archive-file-name")))
 
 ;;;***
@@ -35867,7 +35888,10 @@ When called interactively with a prefix argument, prompt for REMOTE-LOCATION.
 \(fn &optional REMOTE-LOCATION)" t nil)
 
 (autoload 'vc-region-history "vc" "\
-Show the history of the region FROM..TO.
+Show the history of the region between FROM and TO.
+
+If called interactively, show the history between point and
+mark.
 
 \(fn FROM TO)" t nil)
 
-- 
2.21.0


From 50d9d0a65d92b3aa8998c63af5ce1472e69c577d Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Thu, 1 Mar 2018 17:20:32 +0200
Subject: [PATCH 051/297] Remove redundant test in fns.c

* src/fns.c (extract_data_from_object): Remove redundant
CHECK_BUFFER test.
---
 src/fns.c | 2 --
 1 file changed, 2 deletions(-)

diff --git a/src/fns.c b/src/fns.c
index 47848dc56d..b9854768a2 100644
--- a/src/fns.c
+++ b/src/fns.c
@@ -2923,8 +2923,6 @@ extract_data_from_object (Lisp_Object spec,
 
       record_unwind_current_buffer ();
 
-      CHECK_BUFFER (object);
-
       struct buffer *bp = XBUFFER (object);
       set_buffer_internal (bp);
 
-- 
2.21.0


From 8ea9e1b8f7b10eea9daa7562bb243469d8f4fa40 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 1 Mar 2018 13:07:42 -0500
Subject: [PATCH 052/297] Use select-message-coding-system in mh-comp

* lisp/mh-e/mh-comp.el (mh-send-letter):
Use select-message-coding-system.  (Bug#30060)
---
 lisp/mh-e/mh-comp.el | 24 +++++++++++++-----------
 1 file changed, 13 insertions(+), 11 deletions(-)

diff --git a/lisp/mh-e/mh-comp.el b/lisp/mh-e/mh-comp.el
index a9f809cfa1..cfdd2ae5ab 100644
--- a/lisp/mh-e/mh-comp.el
+++ b/lisp/mh-e/mh-comp.el
@@ -305,17 +305,19 @@ message and scan line."
         (file-name buffer-file-name)
         (config mh-previous-window-config)
         (coding-system-for-write
-         (if (and (local-variable-p 'buffer-file-coding-system
-                                    (current-buffer)) ;XEmacs needs two args
-                  ;; We're not sure why, but buffer-file-coding-system
-                  ;; tends to get set to undecided-unix.
-                  (not (memq buffer-file-coding-system
-                             '(undecided undecided-unix undecided-dos))))
-             buffer-file-coding-system
-           (or (and (boundp 'sendmail-coding-system) sendmail-coding-system)
-               (and (default-boundp 'buffer-file-coding-system)
-                    (default-value 'buffer-file-coding-system))
-               'iso-latin-1))))
+         (if (fboundp 'select-message-coding-system)
+             (select-message-coding-system) ; Emacs has this since at least 21.1
+           (if (and (local-variable-p 'buffer-file-coding-system
+                                      (current-buffer)) ;XEmacs needs two args
+                    ;; We're not sure why, but buffer-file-coding-system
+                    ;; tends to get set to undecided-unix.
+                    (not (memq buffer-file-coding-system
+                               '(undecided undecided-unix undecided-dos))))
+               buffer-file-coding-system
+             (or (and (boundp 'sendmail-coding-system) sendmail-coding-system)
+                 (and (default-boundp 'buffer-file-coding-system)
+                      (default-value 'buffer-file-coding-system))
+                 'iso-latin-1)))))
     ;; Older versions of spost do not support -msgid and -mime.
     (unless mh-send-uses-spost-flag
       ;; Adding a Message-ID field looks good, makes it easier to search for
-- 
2.21.0


From db00a993ebc306f2ca32187f2e43e303b23e6b00 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 1 Mar 2018 13:08:47 -0500
Subject: [PATCH 053/297] Simplify mh-thread-set-tables

* lisp/mh-e/mh-thread.el (mh-thread-set-tables):
Rewrite to simplify and remove compiler warning.
---
 lisp/mh-e/mh-thread.el | 25 +++++++++++--------------
 1 file changed, 11 insertions(+), 14 deletions(-)

diff --git a/lisp/mh-e/mh-thread.el b/lisp/mh-e/mh-thread.el
index 41a79b6f0b..ff8e6602e5 100644
--- a/lisp/mh-e/mh-thread.el
+++ b/lisp/mh-e/mh-thread.el
@@ -647,20 +647,17 @@ Only information about messages in MSG-LIST are added to the tree."
 
 (defun mh-thread-set-tables (folder)
   "Use the tables of FOLDER in current buffer."
-  (mh-flet
-   ((mh-get-table (symbol)
-                  (with-current-buffer folder
-                    (symbol-value symbol))))
-   (setq mh-thread-id-hash (mh-get-table 'mh-thread-id-hash))
-   (setq mh-thread-subject-hash (mh-get-table 'mh-thread-subject-hash))
-   (setq mh-thread-id-table (mh-get-table 'mh-thread-id-table))
-   (setq mh-thread-id-index-map (mh-get-table 'mh-thread-id-index-map))
-   (setq mh-thread-index-id-map (mh-get-table 'mh-thread-index-id-map))
-   (setq mh-thread-scan-line-map (mh-get-table 'mh-thread-scan-line-map))
-   (setq mh-thread-subject-container-hash
-         (mh-get-table 'mh-thread-subject-container-hash))
-   (setq mh-thread-duplicates (mh-get-table 'mh-thread-duplicates))
-   (setq mh-thread-history (mh-get-table 'mh-thread-history))))
+  (dolist (v '(mh-thread-id-hash
+               mh-thread-subject-hash
+               mh-thread-id-table
+               mh-thread-id-index-map
+               mh-thread-index-id-map
+               mh-thread-scan-line-map
+               mh-thread-subject-container-hash
+               mh-thread-duplicates
+               mh-thread-history))
+    ;; Emacs >= 22.1: (buffer-local-value v folder).
+    (set v (with-current-buffer folder (symbol-value v)))))
 
 (defun mh-thread-process-in-reply-to (reply-to-header)
   "Extract message id's from REPLY-TO-HEADER.
-- 
2.21.0


From cfc140d4c9dfb9a73d98aa9af657165401ae9202 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 1 Mar 2018 13:10:37 -0500
Subject: [PATCH 054/297] Quieten mh-compat compilation

* lisp/mh-e/mh-compat.el (mh-assoc-string)
(mh-replace-regexp-in-string): Silence compiler warnings.
---
 lisp/mh-e/mh-compat.el | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/lisp/mh-e/mh-compat.el b/lisp/mh-e/mh-compat.el
index 2307812736..ffeb6937f7 100644
--- a/lisp/mh-e/mh-compat.el
+++ b/lisp/mh-e/mh-compat.el
@@ -65,7 +65,8 @@ Simulate NOERROR argument in XEmacs which lacks it."
 Case is ignored if CASE-FOLD is non-nil.
 This function is used by Emacs versions that lack `assoc-string',
 introduced in Emacs 22."
-  (if case-fold
+  ;; Test for fboundp is solely to silence compiler for Emacs >= 22.1.
+  (if (and case-fold (fboundp 'assoc-ignore-case))
       (assoc-ignore-case key list)
     (assoc key list)))
 
@@ -307,7 +308,8 @@ This function is used by XEmacs that lacks `replace-regexp-in-string'.
 The function `replace-in-string' is used instead.
 The arguments FIXEDCASE, SUBEXP, and START, used by
 `replace-in-string' are ignored."
-  (replace-in-string string regexp rep literal))
+  (if (featurep 'xemacs)                ; silence Emacs compiler
+      (replace-in-string string regexp rep literal)))
 
 (defun-mh mh-test-completion
   test-completion (string collection &optional predicate)
-- 
2.21.0


From 60bcc3d9245c72b3f41e2370aba718325182437a Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 1 Mar 2018 13:11:29 -0500
Subject: [PATCH 055/297] Quieten defun-mh compilation

* lisp/mh-e/mh-acros.el (defun-mh):
Rewrite so the compiler can see it always defines target function.
---
 lisp/mh-e/mh-acros.el | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/lisp/mh-e/mh-acros.el b/lisp/mh-e/mh-acros.el
index ac31127ce6..fb8a16bd81 100644
--- a/lisp/mh-e/mh-acros.el
+++ b/lisp/mh-e/mh-acros.el
@@ -90,9 +90,10 @@ loads \"cl\" appropriately."
   "Create function NAME.
 If FUNCTION exists, then NAME becomes an alias for FUNCTION.
 Otherwise, create function NAME with ARG-LIST and BODY."
-  `(if (fboundp ',function)
-       (defalias ',name ',function)
-     (defun ,name ,arg-list ,@body)))
+  `(defalias ',name
+     (if (fboundp ',function)
+         ',function
+       (lambda ,arg-list ,@body))))
 (put 'defun-mh 'lisp-indent-function 'defun)
 (put 'defun-mh 'doc-string-elt 4)
 
-- 
2.21.0


From 2aa6a6ff9c602403ec84d2e8e3e8c148590de75e Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 1 Mar 2018 17:37:10 -0500
Subject: [PATCH 056/297] * lisp/emulation/viper-ex.el (ex-cmd-read-exit):
 Silence compiler.

---
 lisp/emulation/viper-ex.el | 10 +++++++---
 1 file changed, 7 insertions(+), 3 deletions(-)

diff --git a/lisp/emulation/viper-ex.el b/lisp/emulation/viper-ex.el
index 347e66f8ff..d95a828614 100644
--- a/lisp/emulation/viper-ex.el
+++ b/lisp/emulation/viper-ex.el
@@ -548,9 +548,13 @@ reversed."
       (setq viper-ex-work-buf (get-buffer-create viper-ex-work-buf-name))
       (set-buffer viper-ex-work-buf)
       (goto-char (point-max)))
-    (cond ((looking-back quit-regex1) (exit-minibuffer))
-	  ((looking-back stay-regex)  (insert " "))
-	  ((looking-back quit-regex2) (exit-minibuffer))
+    (cond ((looking-back quit-regex1 (line-beginning-position))
+	   (exit-minibuffer))
+	  ;; Almost certainly point-min should be line-beginning-position,
+	  ;; but probably the two are identical anyway, and who really cares?
+	  ((looking-back stay-regex (point-min)) (insert " "))
+	  ((looking-back quit-regex2 (line-beginning-position))
+	   (exit-minibuffer))
 	  (t (insert " ")))))
 
 (declare-function viper-tmp-insert-at-eob "viper-cmd" (msg))
-- 
2.21.0


From 240edd49fd91a07396df333e8d6c247ca01106f0 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Thu, 1 Mar 2018 16:24:41 -0800
Subject: [PATCH 057/297] make-docfile: minor fixes and cleanups
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

* lib-src/make-docfile.c: Include c-ctype.h.
(read_c_string_or_comment, write_c_args, scan_c_stream, skip_white)
(read_lisp_symbol, scan_lisp_file):
Prefer c_isspace etc. to listing characters by hand.
(read_c_string_or_comment): Simplify.
(scan_c_stream, read_lisp_symbol): Use true for boolean 1.
(scan_c_stream): Fix typo (c >= 'Z' && c <= 'Z').
Minor rewrites to avoid duplicate code.
(scan_c_stream, read_lisp_symbol, scan_lisp_file):
Avoid infloop if at EOF.
(skip_white, read_lisp_symbol): Don’t stuff getc result into
‘char’, as this mishandles EOF.
---
 lib-src/make-docfile.c | 95 ++++++++++++++++++++++++------------------
 1 file changed, 54 insertions(+), 41 deletions(-)

diff --git a/lib-src/make-docfile.c b/lib-src/make-docfile.c
index f115748f30..a3c2801cad 100644
--- a/lib-src/make-docfile.c
+++ b/lib-src/make-docfile.c
@@ -43,6 +43,7 @@ along with GNU Emacs.  If not, see <https://www.gnu.org/licenses/>.  */
 #include <string.h>
 
 #include <binary-io.h>
+#include <c-ctype.h>
 #include <intprops.h>
 #include <min-max.h>
 #include <unlocked-io.h>
@@ -347,7 +348,7 @@ scan_keyword_or_put_char (char ch, struct rcsoc_state *state)
 	  state->pending_newlines = 2;
 	  state->pending_spaces = 0;
 
-	  /* Skip any whitespace between the keyword and the
+	  /* Skip any spaces and newlines between the keyword and the
 	     usage string.  */
 	  int c;
 	  do
@@ -367,6 +368,7 @@ scan_keyword_or_put_char (char ch, struct rcsoc_state *state)
 		fatal ("Unexpected EOF after keyword");
 	    }
 	  while (c != ' ' && c != ')');
+
 	  put_char ('f', state);
 	  put_char ('n', state);
 
@@ -421,7 +423,7 @@ read_c_string_or_comment (FILE *infile, int printflag, bool comment,
 
   c = getc (infile);
   if (comment)
-    while (c == '\n' || c == '\r' || c == '\t' || c == ' ')
+    while (c_isspace (c))
       c = getc (infile);
 
   while (c != EOF)
@@ -431,15 +433,14 @@ read_c_string_or_comment (FILE *infile, int printflag, bool comment,
 	  if (c == '\\')
 	    {
 	      c = getc (infile);
-	      if (c == '\n' || c == '\r')
+	      switch (c)
 		{
+		case '\n': case '\r':
 		  c = getc (infile);
 		  continue;
+		case 'n': c = '\n'; break;
+		case 't': c = '\t'; break;
 		}
-	      if (c == 'n')
-		c = '\n';
-	      if (c == 't')
-		c = '\t';
 	    }
 
 	  if (c == ' ')
@@ -510,10 +511,7 @@ write_c_args (char *func, char *buf, int minargs, int maxargs)
       char c = *p;
 
       /* Notice when a new identifier starts.  */
-      if ((('A' <= c && c <= 'Z')
-	   || ('a' <= c && c <= 'z')
-	   || ('0' <= c && c <= '9')
-	   || c == '_')
+      if ((c_isalnum (c) || c == '_')
 	  != in_ident)
 	{
 	  if (!in_ident)
@@ -556,11 +554,8 @@ write_c_args (char *func, char *buf, int minargs, int maxargs)
 	  else
 	    while (ident_length-- > 0)
 	      {
-		c = *ident_start++;
-		if (c >= 'a' && c <= 'z')
-		  /* Upcase the letter.  */
-		  c += 'A' - 'a';
-		else if (c == '_')
+		c = c_toupper (*ident_start++);
+		if (c == '_')
 		  /* Print underscore as hyphen.  */
 		  c = '-';
 		putchar (c);
@@ -965,7 +960,7 @@ scan_c_stream (FILE *infile)
 	    {
 	      c = getc (infile);
 	    }
-	  while (c == ',' || c == ' ' || c == '\t' || c == '\n' || c == '\r');
+	  while (c == ',' || c_isspace (c));
 
 	  /* Read in the identifier.  */
 	  do
@@ -977,8 +972,8 @@ scan_c_stream (FILE *infile)
 		fatal ("identifier too long");
 	      c = getc (infile);
 	    }
-	  while (! (c == ',' || c == ' ' || c == '\t'
-		    || c == '\n' || c == '\r'));
+	  while (! (c == ',' || c_isspace (c)));
+
 	  input_buffer[i] = '\0';
 	  memcpy (name, input_buffer, i + 1);
 
@@ -986,7 +981,8 @@ scan_c_stream (FILE *infile)
 	    {
 	      do
 		c = getc (infile);
-	      while (c == ' ' || c == '\t' || c == '\n' || c == '\r');
+	      while (c_isspace (c));
+
 	      if (c != '"')
 		continue;
 	      c = read_c_string_or_comment (infile, -1, false, 0);
@@ -1027,7 +1023,8 @@ scan_c_stream (FILE *infile)
 		  int scanned = 0;
 		  do
 		    c = getc (infile);
-		  while (c == ' ' || c == '\n' || c == '\r' || c == '\t');
+		  while (c_isspace (c));
+
 		  if (c < 0)
 		    goto eof;
 		  ungetc (c, infile);
@@ -1077,7 +1074,7 @@ scan_c_stream (FILE *infile)
 	  int d = getc (infile);
 	  if (d == EOF)
 	    goto eof;
-	  while (1)
+	  while (true)
 	    {
 	      if (c == '*' && d == '/')
 		break;
@@ -1092,13 +1089,14 @@ scan_c_stream (FILE *infile)
 	      if (c == EOF)
 		goto eof;
 	    }
-	  while (c == ' ' || c == '\n' || c == '\r' || c == '\t');
+	  while (c_isspace (c));
+
 	  /* Check for 'attributes:' token.  */
 	  if (c == 'a' && stream_match (infile, "ttributes:"))
 	    {
 	      char *p = input_buffer;
 	      /* Collect attributes up to ')'.  */
-	      while (1)
+	      while (true)
 		{
 		  c = getc (infile);
 		  if (c == EOF)
@@ -1120,7 +1118,7 @@ scan_c_stream (FILE *infile)
 	  continue;
 	}
 
-      while (c == ' ' || c == '\n' || c == '\r' || c == '\t')
+      while (c_isspace (c))
 	c = getc (infile);
 
       if (c == '"')
@@ -1130,17 +1128,18 @@ scan_c_stream (FILE *infile)
 	c = getc (infile);
       if (c == ',')
 	{
-	  c = getc (infile);
-	  while (c == ' ' || c == '\n' || c == '\r' || c == '\t')
+	  do
 	    c = getc (infile);
-	  while ((c >= 'a' && c <= 'z') || (c >= 'Z' && c <= 'Z'))
+	  while (c_isspace (c));
+
+	  while (c_isalpha (c))
 	    c = getc (infile);
 	  if (c == ':')
 	    {
 	      doc_keyword = true;
-	      c = getc (infile);
-	      while (c == ' ' || c == '\n' || c == '\r' || c == '\t')
+	      do
 		c = getc (infile);
+	      while (c_isspace (c));
 	    }
 	}
 
@@ -1191,8 +1190,14 @@ scan_c_stream (FILE *infile)
 	      /* Copy arguments into ARGBUF.  */
 	      *p++ = c;
 	      do
-		*p++ = c = getc (infile);
+		{
+		  c = getc (infile);
+		  if (c < 0)
+		    goto eof;
+		  *p++ = c;
+		}
 	      while (c != ')');
+
 	      *p = '\0';
 	      /* Output them.  */
 	      fputs ("\n\n", stdout);
@@ -1248,25 +1253,32 @@ scan_c_stream (FILE *infile)
 static void
 skip_white (FILE *infile)
 {
-  char c = ' ';
-  while (c == ' ' || c == '\t' || c == '\n' || c == '\r')
+  int c;
+  do
     c = getc (infile);
+  while (c_isspace (c));
+
   ungetc (c, infile);
 }
 
 static void
 read_lisp_symbol (FILE *infile, char *buffer)
 {
-  char c;
+  int c;
   char *fillp = buffer;
 
   skip_white (infile);
-  while (1)
+  while (true)
     {
       c = getc (infile);
       if (c == '\\')
-	*(++fillp) = getc (infile);
-      else if (c == ' ' || c == '\t' || c == '\n' || c == '\r' || c == '(' || c == ')')
+	{
+	  c = getc (infile);
+	  if (c < 0)
+	    return;
+	  *fillp++ = c;
+	}
+      else if (c_isspace (c) || c == '(' || c == ')' || c < 0)
 	{
 	  ungetc (c, infile);
 	  *fillp = 0;
@@ -1386,7 +1398,7 @@ scan_lisp_file (const char *filename, const char *mode)
 
 	      /* Read the length.  */
 	      while ((c = getc (infile),
-		      c >= '0' && c <= '9'))
+		      c_isdigit (c)))
 		{
 		  if (INT_MULTIPLY_WRAPV (length, 10, &length)
 		      || INT_ADD_WRAPV (length, c - '0', &length)
@@ -1418,7 +1430,7 @@ scan_lisp_file (const char *filename, const char *mode)
 	      while (c == '\n' || c == '\r')
 		c = getc (infile);
 	      /* Skip the following line.  */
-	      while (c != '\n' && c != '\r')
+	      while (! (c == '\n' || c == '\r' || c < 0))
 		c = getc (infile);
 	    }
 	  continue;
@@ -1456,7 +1468,7 @@ scan_lisp_file (const char *filename, const char *mode)
 	      continue;
 	    }
 	  else
-	    while (c != ')')
+	    while (! (c == ')' || c < 0))
 	      c = getc (infile);
 	  skip_white (infile);
 
@@ -1600,7 +1612,8 @@ scan_lisp_file (const char *filename, const char *mode)
 		}
 	    }
 	  skip_white (infile);
-	  if ((c = getc (infile)) != '\"')
+	  c = getc (infile);
+	  if (c != '\"')
 	    {
 	      fprintf (stderr, "## autoload of %s unparsable (%s)\n",
 		       buffer, filename);
-- 
2.21.0


From 463087c83fb859842834bb080e4296515aaf59e5 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 1 Mar 2018 20:28:03 -0500
Subject: [PATCH 058/297] Quieten ses.el compilation

* lisp/ses.el (ses--edit-cell-completion-at-point-function)
(ses--read-printer-completion-at-point-function):
Mark unused arguments.
---
 lisp/ses.el | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/lisp/ses.el b/lisp/ses.el
index 9097bf5d81..bcf8bdb636 100644
--- a/lisp/ses.el
+++ b/lisp/ses.el
@@ -2495,7 +2495,7 @@ to are recalculated first."
          prefix-length)
     (when (and prefix (null (string= prefix "")))
       (setq prefix-length (length prefix))
-      (maphash (lambda (key val)
+      (maphash (lambda (key _val)
                  (let ((key-name (symbol-name key)))
                    (when (and (>= (length key-name) prefix-length)
                               (string= prefix (substring key-name 0 prefix-length)))
@@ -2648,7 +2648,7 @@ cells."
          prefix-length)
     (when prefix
       (setq prefix-length (length prefix))
-      (maphash (lambda (key val)
+      (maphash (lambda (key _val)
                  (let ((key-name (symbol-name key)))
                    (when (and (>= (length key-name) prefix-length)
                               (string= prefix (substring key-name 0 prefix-length)))
-- 
2.21.0


From c3eddc04234a9bdf66e0b1591ca2ba98393def27 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 1 Mar 2018 20:28:34 -0500
Subject: [PATCH 059/297] Quieten url-auth.el compilation

* lisp/url/url-auth.el (url-digest-auth-nonce-count):
Mark unused argument.
---
 lisp/url/url-auth.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lisp/url/url-auth.el b/lisp/url/url-auth.el
index 4f7b544674..67e701ecb1 100644
--- a/lisp/url/url-auth.el
+++ b/lisp/url/url-auth.el
@@ -194,7 +194,7 @@ key cache `url-digest-auth-storage'."
   (base64-encode-string
    (apply 'format "%016x%04x%04x%05x%05x" (random) (current-time)) t))
 
-(defun url-digest-auth-nonce-count (nonce)
+(defun url-digest-auth-nonce-count (_nonce)
   "The number requests sent to server with the given NONCE.
 This count includes the request we're preparing here.
 
-- 
2.21.0


From 5aa98a4c65110096c0f65479995080e03cf6a5e0 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 1 Mar 2018 20:29:23 -0500
Subject: [PATCH 060/297] * lisp/progmodes/sql.el (sql-comint-oracle): Silence
 compiler.

---
 lisp/progmodes/sql.el | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/lisp/progmodes/sql.el b/lisp/progmodes/sql.el
index d20c579f66..9bb2cf4bdf 100644
--- a/lisp/progmodes/sql.el
+++ b/lisp/progmodes/sql.el
@@ -4406,7 +4406,8 @@ The default comes from `process-coding-system-alist' and
                            (or coding 'utf-8))
                     (when (string-match (format "\\.%s\\'" (car cs)) nlslang)
                       (setq coding (cdr cs)))))
-    (set-buffer-process-coding-system coding coding)))
+    (set-process-coding-system (get-buffer-process (current-buffer))
+                               coding coding)))
 
 (defun sql-oracle-save-settings (sqlbuf)
   "Save most SQL*Plus settings so they may be reset by \\[sql-redirect]."
-- 
2.21.0


From 849d171163eae17197b2d019939e34d503cfaa92 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 1 Mar 2018 20:32:22 -0500
Subject: [PATCH 061/297] Quieten nnir.el compilation

* lisp/gnus/nnir.el (gnus-inhibit-demon, gnus-article-decode-hook):
Declare dynamic variables.
(nnir-request-group, nnir-retrieve-headers)
(nnir-request-move-article, nnir-request-update-mark)
(nnir-run-swish++, nnir-run-swish-e, nnir-run-namazu)
(nnir-run-notmuch, nnir-registry-action)
(nnir-request-create-group, nnir-request-delete-group)
(nnir-request-list, nnir-request-scan): Mark unused arguments.
(nnir-warp-to-article, nnir-run-imap, nnir-run-gmane)
(nnir-get-active): Remove unused local variables.
---
 lisp/gnus/nnir.el | 40 ++++++++++++++++++++++------------------
 1 file changed, 22 insertions(+), 18 deletions(-)

diff --git a/lisp/gnus/nnir.el b/lisp/gnus/nnir.el
index 55e00a0b69..0a7d829614 100644
--- a/lisp/gnus/nnir.el
+++ b/lisp/gnus/nnir.el
@@ -644,7 +644,7 @@ skips all prompting."
       (add-hook 'gnus-summary-mode-hook 'nnir-mode)
       (nnoo-change-server 'nnir server definitions))))
 
-(deffoo nnir-request-group (group &optional server dont-check info)
+(deffoo nnir-request-group (group &optional server dont-check _info)
   (nnir-possibly-change-group group server)
   (let ((pgroup (gnus-group-guess-full-name-from-command-method group))
 	length)
@@ -669,7 +669,9 @@ skips all prompting."
                          group)))) ; group name
   nnir-artlist)
 
-(deffoo nnir-retrieve-headers (articles &optional group server fetch-old)
+(defvar gnus-inhibit-demon)
+
+(deffoo nnir-retrieve-headers (articles &optional _group _server _fetch-old)
   (with-current-buffer nntp-server-buffer
     (let ((gnus-inhibit-demon t)
 	  (articles-by-group (nnir-categorize
@@ -716,6 +718,8 @@ skips all prompting."
       (mapc 'nnheader-insert-nov headers)
       'nov)))
 
+(defvar gnus-article-decode-hook)
+
 (deffoo nnir-request-article (article &optional group server to-buffer)
   (nnir-possibly-change-group group server)
   (if (and (stringp article)
@@ -753,7 +757,7 @@ skips all prompting."
             (cons artfullgroup artno)))))))
 
 (deffoo nnir-request-move-article (article group server accept-form
-					   &optional last internal-move-group)
+					   &optional last _internal-move-group)
   (nnir-possibly-change-group group server)
   (let* ((artfullgroup (nnir-article-group article))
 	 (artno (nnir-article-number article))
@@ -803,7 +807,8 @@ skips all prompting."
 		(error "Can't warp to a pseudo-article")))
 	 (backend-article-group (nnir-article-group cur))
          (backend-article-number (nnir-article-number cur))
-	 (quit-config (gnus-ephemeral-group-p gnus-newsgroup-name)))
+;	 (quit-config (gnus-ephemeral-group-p gnus-newsgroup-name))
+	 )
 
     ;; what should we do here? we could leave all the buffers around
     ;; and assume that we have to exit from them one by one. or we can
@@ -818,7 +823,7 @@ skips all prompting."
     (gnus-summary-read-group-1 backend-article-group t t  nil
                                nil (list backend-article-number))))
 
-(deffoo nnir-request-update-mark (group article mark)
+(deffoo nnir-request-update-mark (_group article mark)
   (let ((artgroup (nnir-article-group article))
 	(artnumber (nnir-article-number article)))
     (or (and artgroup
@@ -956,7 +961,7 @@ details on the language and supported extensions."
   (save-excursion
     (let ((qstring (cdr (assq 'query query)))
           (server (cadr (gnus-server-to-method srv)))
-          (defs (nth 2 (gnus-server-to-method srv)))
+;;          (defs (nth 2 (gnus-server-to-method srv)))
           (criteria (or (cdr (assq 'criteria query))
                         (cdr (assoc nnir-imap-default-search-key
                                     nnir-imap-search-arguments))))
@@ -1177,7 +1182,7 @@ returning the one at the supplied position."
 ;; - article number
 ;; - file size
 ;; - group
-(defun nnir-run-swish++ (query server &optional group)
+(defun nnir-run-swish++ (query server &optional _group)
   "Run QUERY against swish++.
 Returns a vector of (group name, file name) pairs (also vectors,
 actually).
@@ -1267,7 +1272,7 @@ Windows NT 4.0."
                                   (nnir-artitem-rsv y)))))))))
 
 ;; Swish-E interface.
-(defun nnir-run-swish-e (query server &optional group)
+(defun nnir-run-swish-e (query server &optional _group)
   "Run given query against swish-e.
 Returns a vector of (group name, file name) pairs (also vectors,
 actually).
@@ -1433,7 +1438,7 @@ Tested with swish-e-2.0.1 on Windows NT 4.0."
       )))
 
 ;; Namazu interface
-(defun nnir-run-namazu (query server &optional group)
+(defun nnir-run-namazu (query server &optional _group)
   "Run given query against Namazu.  Returns a vector of (group name, file name)
 pairs (also vectors, actually).
 
@@ -1502,7 +1507,7 @@ Tested with Namazu 2.0.6 on a GNU/Linux system."
                                (> (nnir-artitem-rsv x)
                                   (nnir-artitem-rsv y)))))))))
 
-(defun nnir-run-notmuch (query server &optional group)
+(defun nnir-run-notmuch (query server &optional _group)
   "Run QUERY against notmuch.
 Returns a vector of (group name, file name) pairs (also vectors,
 actually)."
@@ -1667,7 +1672,7 @@ actually)."
   "Run a search against a gmane back-end server."
       (let* ((case-fold-search t)
 	     (qstring (cdr (assq 'query query)))
-	     (server (cadr (gnus-server-to-method srv)))
+;;	     (server (cadr (gnus-server-to-method srv)))
 	     (groupspec (mapconcat
 			 (lambda (x)
 			   (if (string-match-p "gmane" x)
@@ -1809,8 +1814,7 @@ article came from is also searched."
 	groups)
     (gnus-request-list method)
     (with-current-buffer nntp-server-buffer
-      (let ((cur (current-buffer))
-	    name)
+      (let ((cur (current-buffer)))
 	(goto-char (point-min))
 	(unless (or (null nnir-ignored-newsgroups)
 		    (string= nnir-ignored-newsgroups ""))
@@ -1851,7 +1855,7 @@ article came from is also searched."
 (declare-function gnus-registry-action "gnus-registry"
                   (action data-header from &optional to method))
 
-(defun nnir-registry-action (action data-header from &optional to method)
+(defun nnir-registry-action (action data-header _from &optional to method)
   "Call `gnus-registry-action' with the original article group."
   (gnus-registry-action
    action
@@ -1886,7 +1890,7 @@ article came from is also searched."
        (gnus-group-find-parameter pgroup)))))
 
 
-(deffoo nnir-request-create-group (group &optional server args)
+(deffoo nnir-request-create-group (group &optional _server args)
   (message "Creating nnir group %s" group)
   (let* ((group (gnus-group-prefixed-name  group '(nnir "nnir")))
          (specs (assq 'nnir-specs args))
@@ -1907,13 +1911,13 @@ article came from is also searched."
     (nnir-request-update-info group (gnus-get-info group)))
   t)
 
-(deffoo nnir-request-delete-group (group &optional force server)
+(deffoo nnir-request-delete-group (_group &optional _force _server)
   t)
 
-(deffoo nnir-request-list (&optional server)
+(deffoo nnir-request-list (&optional _server)
   t)
 
-(deffoo nnir-request-scan (group method)
+(deffoo nnir-request-scan (_group _method)
   t)
 
 (deffoo nnir-request-close ()
-- 
2.21.0


From f1d3c7d95d17a62150baefe0c36208350b41b5cc Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Thu, 1 Mar 2018 17:58:26 -0800
Subject: [PATCH 062/297] Improve octal-escape output in bool vectors and
 strings

* src/print.c (octalout): New function.
(print_vectorlike): When printing bool vectors, use
octal escapes for control characters when
print-escape-control-characters is non-nil, so that
the printed representation avoids encoding issues.
Rename locals to avoid byte-vs-char confusion.
(print_object): Don't output unnecessary zeros when
printing octal escapes.  Simplify by using octalout.
---
 src/print.c | 57 ++++++++++++++++++++++++++++++++---------------------
 1 file changed, 34 insertions(+), 23 deletions(-)

diff --git a/src/print.c b/src/print.c
index b3c0f6f38f..a8bbb9d37a 100644
--- a/src/print.c
+++ b/src/print.c
@@ -313,6 +313,25 @@ printchar (unsigned int ch, Lisp_Object fun)
     }
 }
 
+/* Output an octal escape for C.  If C is less than '\100' consult the
+   following character (if any) to see whether to use three octal
+   digits to avoid misinterpretation of the next character.  The next
+   character after C will be taken from DATA, starting at byte
+   location I, if I is less than SIZE.  Use PRINTCHARFUN to output
+   each character.  */
+
+static void
+octalout (unsigned char c, unsigned char *data, ptrdiff_t i, ptrdiff_t size,
+	  Lisp_Object printcharfun)
+{
+  int digits = (c > '\77' || (i < size && '0' <= data[i] && data[i] <= '7')
+		? 3
+		: c > '\7' ? 2 : 1);
+  printchar ('\\', printcharfun);
+  do
+    printchar ('0' + ((c >> (3 * --digits)) & 7), printcharfun);
+  while (digits != 0);
+}
 
 /* Output SIZE characters, SIZE_BYTE bytes from string PTR using
    method PRINTCHARFUN.  PRINTCHARFUN nil means output to
@@ -1367,32 +1386,33 @@ print_vectorlike (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag,
     case PVEC_BOOL_VECTOR:
       {
 	EMACS_INT size = bool_vector_size (obj);
-	ptrdiff_t size_in_chars = bool_vector_bytes (size);
-	ptrdiff_t real_size_in_chars = size_in_chars;
+	ptrdiff_t size_in_bytes = bool_vector_bytes (size);
+	ptrdiff_t real_size_in_bytes = size_in_bytes;
+	unsigned char *data = bool_vector_uchar_data (obj);
 
 	int len = sprintf (buf, "#&%"pI"d\"", size);
 	strout (buf, len, len, printcharfun);
 
-	/* Don't print more characters than the specified maximum.
+	/* Don't print more bytes than the specified maximum.
 	   Negative values of print-length are invalid.  Treat them
 	   like a print-length of nil.  */
 	if (NATNUMP (Vprint_length)
-	    && XFASTINT (Vprint_length) < size_in_chars)
-	  size_in_chars = XFASTINT (Vprint_length);
+	    && XFASTINT (Vprint_length) < size_in_bytes)
+	  size_in_bytes = XFASTINT (Vprint_length);
 
-	for (ptrdiff_t i = 0; i < size_in_chars; i++)
+	for (ptrdiff_t i = 0; i < size_in_bytes; i++)
 	  {
 	    maybe_quit ();
-	    unsigned char c = bool_vector_uchar_data (obj)[i];
+	    unsigned char c = data[i];
 	    if (c == '\n' && print_escape_newlines)
 	      print_c_string ("\\n", printcharfun);
 	    else if (c == '\f' && print_escape_newlines)
 	      print_c_string ("\\f", printcharfun);
-	    else if (c > '\177')
+	    else if (c > '\177'
+		     || (print_escape_control_characters && c_iscntrl (c)))
 	      {
 		/* Use octal escapes to avoid encoding issues.  */
-		int len = sprintf (buf, "\\%o", c);
-		strout (buf, len, len, printcharfun);
+		octalout (c, data, i + 1, size_in_bytes, printcharfun);
 	      }
 	    else
 	      {
@@ -1402,7 +1422,7 @@ print_vectorlike (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag,
 	      }
 	  }
 
-	if (size_in_chars < real_size_in_chars)
+	if (size_in_bytes < real_size_in_bytes)
 	  print_c_string (" ...", printcharfun);
 	printchar ('\"', printcharfun);
       }
@@ -1854,9 +1874,7 @@ print_object (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag)
 		     (when requested) a non-ASCII character in a unibyte buffer,
 		     print single-byte non-ASCII string chars
 		     using octal escapes.  */
-		  char outbuf[5];
-		  int len = sprintf (outbuf, "\\%03o", c + 0u);
-		  strout (outbuf, len, len, printcharfun);
+		  octalout (c, SDATA (obj), i_byte, size_byte, printcharfun);
 		  need_nonhex = false;
 		}
 	      else if (multibyte
@@ -1870,7 +1888,6 @@ print_object (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag)
 		}
 	      else
 		{
-                  bool still_need_nonhex = false;
 		  /* If we just had a hex escape, and this character
 		     could be taken as part of it,
 		     output `\ ' to prevent that.  */
@@ -1884,22 +1901,16 @@ print_object (Lisp_Object obj, Lisp_Object printcharfun, bool escapeflag)
                            ? (c = 'n', true)
                            : c == '\f' && print_escape_newlines
                            ? (c = 'f', true)
-                           : c == '\0' && print_escape_control_characters
-                           ? (c = '0', still_need_nonhex = true)
                            : c == '\"' || c == '\\')
                     {
                       printchar ('\\', printcharfun);
                       printchar (c, printcharfun);
                     }
                   else if (print_escape_control_characters && c_iscntrl (c))
-                    {
-                      char outbuf[1 + 3 + 1];
-                      int len = sprintf (outbuf, "\\%03o", c + 0u);
-                      strout (outbuf, len, len, printcharfun);
-                    }
+		    octalout (c, SDATA (obj), i_byte, size_byte, printcharfun);
                   else
                     printchar (c, printcharfun);
-		  need_nonhex = still_need_nonhex;
+		  need_nonhex = false;
 		}
 	    }
 	  printchar ('\"', printcharfun);
-- 
2.21.0


From b1bae23030a851c60d3bbd76aedf96fca0871be4 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Thu, 1 Mar 2018 17:58:26 -0800
Subject: [PATCH 063/297] Arrange for loaddefs files to be greppable

Without this change, ldefs-boot.el contains a couple of stray NUL
bytes, which cause it to be considered to be a non-text file by
tools like GNU grep.
* lisp/emacs-lisp/autoload.el (autoload-print-form):
Set print-escape-control-characters to t.
---
 lisp/emacs-lisp/autoload.el | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/lisp/emacs-lisp/autoload.el b/lisp/emacs-lisp/autoload.el
index 92ad6155b5..7b4a7d04f9 100644
--- a/lisp/emacs-lisp/autoload.el
+++ b/lisp/emacs-lisp/autoload.el
@@ -324,6 +324,7 @@ put the output in."
 	    (setcdr p nil)
 	    (princ "\n(" outbuf)
 	    (let ((print-escape-newlines t)
+		  (print-escape-control-characters t)
                   (print-quoted t)
 		  (print-escape-nonascii t))
 	      (dolist (elt form)
@@ -348,6 +349,7 @@ put the output in."
 		       outbuf))
 	      (terpri outbuf)))
 	(let ((print-escape-newlines t)
+	      (print-escape-control-characters t)
               (print-quoted t)
 	      (print-escape-nonascii t))
 	  (print form outbuf)))))))
-- 
2.21.0


From 1edad6f2e7ddee7c6cd54f12a0cac042c367b02b Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 1 Mar 2018 21:19:12 -0500
Subject: [PATCH 064/297] * admin/automerge: Quieten initial reset.

---
 admin/automerge | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/admin/automerge b/admin/automerge
index 520961f1e8..e88711f8d6 100755
--- a/admin/automerge
+++ b/admin/automerge
@@ -138,7 +138,7 @@ trap "rm -f $tempfile 2> /dev/null" EXIT
 
 [ "$reset" ] && {
     echo "Resetting..."
-    git reset --hard origin/master || die "reset error"
+    git reset -q --hard origin/master || die "reset error"
 
     echo "Pulling..."
     git pull -q --ff-only || die "pull error"
-- 
2.21.0


From 20076542b4a4c31229db499e3af3ad22b5652134 Mon Sep 17 00:00:00 2001
From: Noam Postavsky <npostavs@gmail.com>
Date: Thu, 1 Mar 2018 21:52:27 -0500
Subject: [PATCH 065/297] Fix issues turned up by previous python.el change

See [1] for more discussion.
* lisp/progmodes/python.el (python--prettify-symbols-alist): Define
the obsolete alias before the variable proper, so that we correctly
get the user's settings regardless of which name they set.
(python-nav-end-of-statement): Add missing backslash.
(python-shell-send-file): Call `expand-file-name' before
`file-local-name', the expansion of "~" could be different on remote
filenames.
(python-mode): Declare prettify-symbols-alist instead of checking if
it's bound.  Use the non-obsolete python-prettify-symbols-alist name,
rather than checking if the obsolete name is bound (it always is too,
but the Emacs 24 byte compiler doesn't recognize that
define-obsolete-variable-alias defines a variable).

[1]: https://lists.gnu.org/archive/html/emacs-devel/2018-02/msg00826.html
---
 lisp/progmodes/python.el | 21 ++++++++++-----------
 1 file changed, 10 insertions(+), 11 deletions(-)

diff --git a/lisp/progmodes/python.el b/lisp/progmodes/python.el
index 142e6eb3f3..afafd1b42c 100644
--- a/lisp/progmodes/python.el
+++ b/lisp/progmodes/python.el
@@ -647,15 +647,15 @@ The type returned can be `comment', `string' or `paren'."
    ((python-rx string-delimiter)
     (0 (ignore (python-syntax-stringify))))))
 
+(define-obsolete-variable-alias 'python--prettify-symbols-alist
+  'python-prettify-symbols-alist "26.1")
+
 (defvar python-prettify-symbols-alist
   '(("lambda"  . ?λ)
     ("and" . ?∧)
     ("or" . ?∨))
   "Value for `prettify-symbols-alist' in `python-mode'.")
 
-(define-obsolete-variable-alias 'python--prettify-symbols-alist
-  'python-prettify-symbols-alist "26.1")
-
 (defsubst python-syntax-count-quotes (quote-char &optional point limit)
   "Count number of quotes around point (max is 3).
 QUOTE-CHAR is the quote char to count.  Optional argument POINT is
@@ -1520,7 +1520,7 @@ of the statement."
                        ;; narrowing.
                        (cl-assert (> string-start last-string-end)
                                   :show-args
-                                  "
+                                  "\
 Overlapping strings detected (start=%d, last-end=%d)")
                        (goto-char string-start)
                        (if (python-syntax-context 'paren)
@@ -3196,10 +3196,10 @@ t when called interactively."
                      (insert-file-contents
                       (or temp-file-name file-name))
                      (python-info-encoding)))
-         (file-name (expand-file-name (file-local-name file-name)))
+         (file-name (file-local-name (expand-file-name file-name)))
          (temp-file-name (when temp-file-name
-                           (expand-file-name
-                            (file-local-name temp-file-name)))))
+                           (file-local-name (expand-file-name
+                                             temp-file-name)))))
     (python-shell-send-string
      (format
       (concat
@@ -5299,6 +5299,7 @@ REPORT-FN is Flymake's callback function."
     (save-excursion (insert (make-string 2 last-command-event)))))
 
 (defvar electric-indent-inhibit)
+(defvar prettify-symbols-alist)
 
 ;;;###autoload
 (define-derived-mode python-mode prog-mode "Python"
@@ -5393,10 +5394,8 @@ REPORT-FN is Flymake's callback function."
            "`outline-level' function for Python mode."
            (1+ (/ (current-indentation) python-indent-offset))))
 
-  (when (and (boundp 'prettify-symbols-alist)
-             (boundp 'python--prettify-symbols-alist))
-    (set (make-local-variable 'prettify-symbols-alist)
-         python--prettify-symbols-alist))
+  (set (make-local-variable 'prettify-symbols-alist)
+       python-prettify-symbols-alist)
 
   (python-skeleton-add-menu-items)
 
-- 
2.21.0


From cc887c2999721b781b36a6e72d6c16cbc176fdce Mon Sep 17 00:00:00 2001
From: Noam Postavsky <npostavs@gmail.com>
Date: Thu, 1 Mar 2018 22:04:57 -0500
Subject: [PATCH 066/297] ; lisp/emacs-lisp/eieio.el
 (eieio-object-set-name-string): Fix quote.

---
 lisp/emacs-lisp/eieio.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lisp/emacs-lisp/eieio.el b/lisp/emacs-lisp/eieio.el
index de08e37286..1e1419f6eb 100644
--- a/lisp/emacs-lisp/eieio.el
+++ b/lisp/emacs-lisp/eieio.el
@@ -403,7 +403,7 @@ If EXTRA, include that in the string returned to represent the symbol."
 
 (cl-defgeneric eieio-object-set-name-string (obj name)
   "Set the string which is OBJ's NAME."
-  (declare (obsolete "inherit from `eieio-named' and use (setf (slot-value OBJ 'object-name) NAME) instead" "25.1"))
+  (declare (obsolete "inherit from `eieio-named' and use (setf (slot-value OBJ \\='object-name) NAME) instead" "25.1"))
   (cl-check-type name string)
   (setf (gethash obj eieio--object-names) name))
 (define-obsolete-function-alias
-- 
2.21.0


From ce90d457288a0a2d93916e89b6a4046ad04a0654 Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Thu, 1 Mar 2018 09:25:55 +0100
Subject: [PATCH 067/297] Further improvements on manuals

* doc/emacs/xresources.texi:
* doc/lispref/display.texi:
* doc/lispref/keymaps.texi:
* doc/misc/dbus.texi:
* doc/misc/efaq-w32.texi: Use "GTK+" where applicable.

* doc/emacs/xresources.texi (Resources): Mention several use
of "-xrm".
(Table of Resources) [verticalScrollBars]: Add reference to Scroll Bars.
---
 doc/emacs/xresources.texi | 30 +++++++++++++++---------------
 doc/lispref/display.texi  |  6 +++---
 doc/lispref/keymaps.texi  |  2 +-
 doc/misc/dbus.texi        |  6 +++---
 doc/misc/efaq-w32.texi    | 26 +++++++++++++-------------
 5 files changed, 35 insertions(+), 35 deletions(-)

diff --git a/doc/emacs/xresources.texi b/doc/emacs/xresources.texi
index 88bfb8261c..8d0127f910 100644
--- a/doc/emacs/xresources.texi
+++ b/doc/emacs/xresources.texi
@@ -119,19 +119,19 @@ named @samp{Emacs}.  If you write @samp{Emacs} instead of
 regardless of frame titles and regardless of the name of the
 executable file.
 
-@item -xrm @var{resource-values}
+@item -xrm @var{resource-value}
 @opindex --xrm
-@itemx --xrm=@var{resource-values}
+@itemx --xrm=@var{resource-value}
 @cindex resource values, command-line argument
 This option specifies X resource values for the present Emacs job.
 
-@var{resource-values} should have the same format that you would use
-inside a file of X resources.  To include multiple resource
-specifications in @var{resource-values}, put a newline between them,
-just as you would in a file.  You can also use @samp{#include
-"@var{filename}"} to include a file full of resource specifications.
-Resource values specified with @samp{-xrm} take precedence over all
-other resource specifications.
+@var{resource-value} should have the same format that you would use
+inside a file of X resources.  Several @samp{-xrm} options are
+possible to include multiple resource specifications.  You can also
+use @samp{#include "@var{filename}"} as @var{resource-value} to
+include a file full of resource specifications.  Resource values
+specified with @samp{-xrm} take precedence over all other resource
+specifications.
 @end table
 @end ifnottex
 
@@ -323,7 +323,7 @@ might be useful to turn off XIM on slow X client/server links.
 
 @item @code{verticalScrollBars} (class @code{ScrollBars})
 Give frames scroll bars on the left if @samp{left}, on the right if
-@samp{right}; don't have scroll bars if @samp{off}.
+@samp{right}; don't have scroll bars if @samp{off} (@pxref{Scroll Bars}).
 
 @ifnottex
 @item @code{visualClass} (class @code{VisualClass})
@@ -513,7 +513,7 @@ The color for the border shadow, on the top and the left.
 @end ifnottex
 
 @node GTK resources
-@appendixsec GTK resources
+@appendixsec GTK+ resources
 @cindex GTK+ resources
 @cindex resource files for GTK+
 @cindex @file{~/.gtkrc-2.0} file
@@ -558,7 +558,7 @@ system, see
 @end menu
 
 @node GTK Resource Basics
-@appendixsubsec GTK Resource Basics
+@appendixsubsec GTK+ Resource Basics
 
   In a GTK+ 2 resource file (usually @file{~/.emacs.d/gtkrc}), the
 simplest kind of a resource setting simply assigns a value to a
@@ -616,7 +616,7 @@ widget "*verticalScrollBar*" style "scroll"
 @end smallexample
 
 @node GTK Widget Names
-@appendixsubsec GTK widget names
+@appendixsubsec GTK+ widget names
 @cindex GTK+ widget names
 
   A GTK+ widget is specified by a @dfn{widget name} and a @dfn{widget
@@ -661,7 +661,7 @@ widget "*" style "my_style"
 @end smallexample
 
 @node GTK Names in Emacs
-@appendixsubsec GTK Widget Names in Emacs
+@appendixsubsec GTK+ Widget Names in Emacs
 @cindex GTK+ widget names in Emacs
 @cindex GTK+ widget classes
 
@@ -725,7 +725,7 @@ widget_class "*Menu*" style "my_menu_style"
 @end smallexample
 
 @node GTK styles
-@appendixsubsec GTK styles
+@appendixsubsec GTK+ styles
 @cindex GTK+ styles
 
   Here is an example of two GTK+ style declarations:
diff --git a/doc/lispref/display.texi b/doc/lispref/display.texi
index 3ae317ae78..793ede16b3 100644
--- a/doc/lispref/display.texi
+++ b/doc/lispref/display.texi
@@ -3292,7 +3292,7 @@ nominal heights and widths would suggest.
 @defun x-list-fonts name &optional reference-face frame maximum width
 This function returns a list of available font names that match
 @var{name}.  @var{name} should be a string containing a font name in
-either the Fontconfig, GTK, or XLFD format (@pxref{Fonts,,, emacs, The
+either the Fontconfig, GTK+, or XLFD format (@pxref{Fonts,,, emacs, The
 GNU Emacs Manual}).  Within an XLFD string, wildcard characters may be
 used: the @samp{*} character matches any substring, and the @samp{?}
 character matches any single character.  Case is ignored when matching
@@ -3550,7 +3550,7 @@ specifications are as follows:
 
 @table @code
 @item :name
-The font name (a string), in either XLFD, Fontconfig, or GTK format.
+The font name (a string), in either XLFD, Fontconfig, or GTK+ format.
 @xref{Fonts,,, emacs, The GNU Emacs Manual}.
 
 @item :family
@@ -5993,7 +5993,7 @@ debugging.
 @cindex embedded widgets
 @cindex webkit browser widget
 
-  Emacs is able to display native widgets, such as GTK WebKit widgets,
+  Emacs is able to display native widgets, such as GTK+ WebKit widgets,
 in Emacs buffers when it was built with the necessary support
 libraries and is running on a graphical terminal.  To test whether
 Emacs supports display of embedded widgets, check that the
diff --git a/doc/lispref/keymaps.texi b/doc/lispref/keymaps.texi
index e39db7f6d0..cc2e11e0b6 100644
--- a/doc/lispref/keymaps.texi
+++ b/doc/lispref/keymaps.texi
@@ -2750,7 +2750,7 @@ If the value is @code{grow-only}, the tool bar expands automatically,
 but does not contract automatically.  To contract the tool bar, the
 user has to redraw the frame by entering @kbd{C-l}.
 
-If Emacs is built with GTK or Nextstep, the tool bar can only show one
+If Emacs is built with GTK+ or Nextstep, the tool bar can only show one
 line, so this variable has no effect.
 @end defvar
 
diff --git a/doc/misc/dbus.texi b/doc/misc/dbus.texi
index b425bb0c00..5b14382d8b 100644
--- a/doc/misc/dbus.texi
+++ b/doc/misc/dbus.texi
@@ -1815,7 +1815,7 @@ The function returns a number, which counts the connections this Emacs
 session has established to the @var{bus} under the same unique name
 (see @code{dbus-get-unique-name}).  It depends on the libraries Emacs
 is linked with, and on the environment Emacs is running.  For example,
-if Emacs is linked with the gtk toolkit, and it runs in a GTK-aware
+if Emacs is linked with the GTK+ toolkit, and it runs in a GTK+-aware
 environment like Gnome, another connection might already be
 established.
 
@@ -1837,9 +1837,9 @@ Example: You initialize a connection to the AT-SPI bus on your host:
 
 @result{} "unix:abstract=/tmp/dbus-2yzWHOCdSD,guid=a490dd26625870ca1298b6e10000fd7f"
 
-;; If Emacs is built with gtk support, and you run in a GTK enabled
+;; If Emacs is built with GTK+ support, and you run in a GTK+-enabled
 ;; environment (like a GNOME session), the initialization reuses the
-;; connection established by GTK's atk bindings.
+;; connection established by GTK+'s atk bindings.
 (dbus-init-bus my-bus)
 
 @result{} 2
diff --git a/doc/misc/efaq-w32.texi b/doc/misc/efaq-w32.texi
index bf20c2291c..aef64ead7c 100644
--- a/doc/misc/efaq-w32.texi
+++ b/doc/misc/efaq-w32.texi
@@ -309,7 +309,7 @@ file for build instructions.
 
 You can run Emacs without any extra steps, but if you want icons in your
 Start Menu, or for Emacs to detect the image libraries that are already
-installed on your system as part of GTK, then you should run the program
+installed on your system as part of GTK+, then you should run the program
 @file{addpm.exe}, which is usually installed into the same @file{bin}
 directory with @file{emacs.exe}.
 
@@ -2199,10 +2199,10 @@ outdated.  Tools available here that are useful for Emacs include:
 @item GifLib - library to support GIF images.
 @item Grep - for searching through files with @code{grep}.
 @item Gzip - used by Emacs to automatically decompress .gz files.
-@item Jpeg - library to support JPEG images (also in GTK).
+@item Jpeg - library to support JPEG images (also in GTK+).
 @item Lha - used by @code{archive-mode} to edit .lzh files.
-@item LibPng - library to support PNG images (also in GTK).
-@item LibTiff - library to support TIFF images (also in GTK).
+@item LibPng - library to support PNG images (also in GTK+).
+@item LibTiff - library to support TIFF images (also in GTK+).
 @item Make - used by @code{compile} for building projects (also in MinGW)
 @item OpenSSL - used by @code{gnus} to talk to servers over SSL.
 @item Patch - used by @code{ediff-patch-file} and others to apply patches.
@@ -2211,21 +2211,21 @@ outdated.  Tools available here that are useful for Emacs include:
 @item Unzip - used by @code{archive-mode} for extracting zip files.
 @item Xpm - library to support XPM images (bundled with Emacs binaries)
 @item Zip - used by @code{archive-mode} for editing zip files.
-@item Zlib - required by LibPng (also in GTK).
+@item Zlib - required by LibPng (also in GTK+).
 @end itemize
 
 @node GTK
-@section GTK
-@cindex GTK image libraries
-@cindex image libraries, GTK
-@cindex addpm, using GTK image libraries
+@section GTK+
+@cindex GTK+ image libraries
+@cindex image libraries, GTK+
+@cindex addpm, using GTK+ image libraries
 
-GTK is a potential source for some of the image libraries that Emacs
-requires.  GTK is installed along with other ports of GUI software,
+GTK+ is a potential source for some of the image libraries that Emacs
+requires.  GTK+ is installed along with other ports of GUI software,
 such as the GIMP image editor, and Pidgin instant messenger client.
-If GTK is installed when you run @command{addpm}, Emacs will use the
+If GTK+ is installed when you run @command{addpm}, Emacs will use the
 image libraries that it provides, even if they are not on the
-@env{PATH}.  GTK ships with JPEG, PNG and TIFF support.
+@env{PATH}.  GTK+ ships with JPEG, PNG and TIFF support.
 
 @node Read man pages
 @section How do I read man pages?
-- 
2.21.0


From f91773e44826fb81a29a8e4a1bee9834895bbb68 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Thu, 1 Mar 2018 17:31:21 +0200
Subject: [PATCH 068/297] * lisp/dired-aux.el (dired-do-create-files): Doc fix.
  (Bug#30634)

---
 lisp/dired-aux.el | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/lisp/dired-aux.el b/lisp/dired-aux.el
index b837fb4e5e..e8b5e6755e 100644
--- a/lisp/dired-aux.el
+++ b/lisp/dired-aux.el
@@ -1842,7 +1842,8 @@ Optional arg HOW-TO determines how to treat the target.
       rfn-list  - list of the relative names for the marked files.
       fn-list   - list of the absolute names for the marked files.
       target    - the name of the target itself.
-      The rest of into-dir are optional arguments.
+    The rest of elements of the list returned by HOW-TO are optional
+    arguments for the function that is the first element of the list.
    For any other return value, TARGET is treated as a directory."
   (or op1 (setq op1 operation))
   (let* ((fn-list (dired-get-marked-files nil arg nil nil t))
-- 
2.21.0


From 4dbab7330f9cedf596a9f7260dded2146d2e91f9 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Thu, 1 Mar 2018 17:51:25 +0200
Subject: [PATCH 069/297] Improve the Emacs manual

* doc/emacs/xresources.texi (Table of Resources): Mention that
some resources are ignored by toolkit builds.
* doc/emacs/custom.texi (Key Bindings): Improve indexing.
(Bug#30530)
---
 doc/emacs/custom.texi     | 2 ++
 doc/emacs/xresources.texi | 7 ++++---
 2 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/doc/emacs/custom.texi b/doc/emacs/custom.texi
index a9f261b307..d28259c3df 100644
--- a/doc/emacs/custom.texi
+++ b/doc/emacs/custom.texi
@@ -1414,6 +1414,8 @@ commands, and @dfn{keymaps}, which record key bindings.  It also
 explains how to customize key bindings, which is done by editing your
 init file (@pxref{Init Rebinding}).
 
+@cindex reserved key bindings
+@cindex keys, reserved
   Since most modes define their own key bindings, activating a mode
 might override your custom key bindings.  A small number of keys are
 reserved for user-defined bindings, and should not be used by modes,
diff --git a/doc/emacs/xresources.texi b/doc/emacs/xresources.texi
index 8d0127f910..db2c6ffafd 100644
--- a/doc/emacs/xresources.texi
+++ b/doc/emacs/xresources.texi
@@ -138,9 +138,10 @@ specifications.
 @node Table of Resources
 @appendixsec Table of X Resources for Emacs
 
-  This table lists the X resource names that Emacs recognizes,
-excluding those that control the appearance of graphical widgets like
-the menu bar:
+  The table below lists the X resource names that Emacs recognizes.
+Note that some of the resources have no effect in Emacs compiled with
+various X toolkits (GTK+, Lucid, etc.)---we indicate below when this
+is the case.
 
 @table @asis
 @item @code{background} (class @code{Background})
-- 
2.21.0


From 7b40490193c34a723efce8c730badc0bbc62b6e7 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 1 Mar 2018 17:48:21 -0500
Subject: [PATCH 070/297] * lisp/vc/add-log.el (add-change-log-entry): Replace
 obsolete alias.

---
 lisp/vc/add-log.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lisp/vc/add-log.el b/lisp/vc/add-log.el
index bc2be4aadb..175c82f8c0 100644
--- a/lisp/vc/add-log.el
+++ b/lisp/vc/add-log.el
@@ -898,7 +898,7 @@ non-nil, otherwise in local time."
              (insert (if use-hard-newlines hard-newline "\n")
                      (if use-hard-newlines hard-newline "\n"))
              (forward-line -2)
-             (indent-relative-maybe))
+             (indent-relative-first-indent-point))
             (t
              ;; Make a new item.
              (while (looking-at "\\sW")
-- 
2.21.0


From e79eba0002bc71d2b54d275808537398d827f0ce Mon Sep 17 00:00:00 2001
From: Tak Kunihiro <tkk@misasa.okayama-u.ac.jp>
Date: Thu, 1 Mar 2018 20:44:22 -0500
Subject: [PATCH 071/297] Rename some mwheel options, for consistency

* lisp/mwheel.el (mouse-wheel-tilt-scroll)
(mouse-wheel-flip-direction): Rename from mwheel-tilt-scroll-p,
mwheel-flip-direction.
(mwheel-scroll): Update for option renaming.
* doc/emacs/frames.texi (Mouse Commands):
Update for option renaming.
---
 doc/emacs/frames.texi | 10 +++++-----
 lisp/mwheel.el        |  8 ++++----
 2 files changed, 9 insertions(+), 9 deletions(-)

diff --git a/doc/emacs/frames.texi b/doc/emacs/frames.texi
index c0af93cdfe..35ffe95e49 100644
--- a/doc/emacs/frames.texi
+++ b/doc/emacs/frames.texi
@@ -200,13 +200,13 @@ buffers are scrolled.  The variable
 @code{mouse-wheel-progressive-speed} determines whether the scroll
 speed is linked to how fast you move the wheel.
 
-@vindex mwheel-tilt-scroll-p
-@vindex mwheel-flip-direction
+@vindex mouse-wheel-tilt-scroll
+@vindex mouse-wheel-flip-direction
 Emacs can also support horizontal scrolling if your mouse's wheel can
 be tilted.  This feature is off by default; the variable
-@code{mwheel-tilt-scroll-p} turns it on.  If you'd like to reverse the
-direction of horizontal scrolling, customize the variable
-@code{mwheel-flip-direction} to a non-@code{nil} value.
+@code{mouse-wheel-tilt-scroll} turns it on.  If you'd like to reverse
+the direction of horizontal scrolling, customize the variable
+@code{mouse-wheel-flip-direction} to a non-@code{nil} value.
 
 
 @node Word and Line Mouse
diff --git a/lisp/mwheel.el b/lisp/mwheel.el
index cbd7813762..09f3953ff9 100644
--- a/lisp/mwheel.el
+++ b/lisp/mwheel.el
@@ -293,13 +293,13 @@ non-Windows systems."
                    ;; Make sure we do indeed scroll to the end of the buffer.
                    (end-of-buffer (while t (funcall mwheel-scroll-up-function)))))
                 ((eq button mouse-wheel-left-event) ; for tilt scroll
-                 (when mwheel-tilt-scroll-p
-                   (funcall (if mwheel-flip-direction
+                 (when mouse-wheel-tilt-scroll
+                   (funcall (if mouse-wheel-flip-direction
                                 mwheel-scroll-right-function
                               mwheel-scroll-left-function) amt)))
                 ((eq button mouse-wheel-right-event) ; for tilt scroll
-                 (when mwheel-tilt-scroll-p
-                   (funcall (if mwheel-flip-direction
+                 (when mouse-wheel-tilt-scroll
+                   (funcall (if mouse-wheel-flip-direction
                                 mwheel-scroll-left-function
                               mwheel-scroll-right-function) amt)))
 		(t (error "Bad binding in mwheel-scroll"))))
-- 
2.21.0


From 3f4b7b4c48cdee33c2817335dea595e8a657bdaf Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Fri, 2 Mar 2018 10:44:44 +0200
Subject: [PATCH 072/297] Fix downloading non-text files in EWW

* lisp/net/eww.el (eww-download-callback): Bind
coding-system-for-read to 'no-conversion', to avoid any code- or
EOL-conversions in downloaded files.  (Bug#30664)
---
 lisp/net/eww.el | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/lisp/net/eww.el b/lisp/net/eww.el
index caac96a485..66b1767b56 100644
--- a/lisp/net/eww.el
+++ b/lisp/net/eww.el
@@ -1532,7 +1532,8 @@ Differences in #targets are ignored."
                   eww-download-directory)))
       (goto-char (point-min))
       (re-search-forward "\r?\n\r?\n")
-      (write-region (point) (point-max) file)
+      (let ((coding-system-for-write 'no-conversion))
+        (write-region (point) (point-max) file))
       (message "Saved %s" file))))
 
 (defun eww-decode-url-file-name (string)
-- 
2.21.0


From bf30e1373ecff8358f57aab8d88295a3c210e806 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Fri, 2 Mar 2018 11:24:24 +0200
Subject: [PATCH 073/297] * src/window.c (Frecenter): Improve commentary.

---
 src/window.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/src/window.c b/src/window.c
index 678d4d0703..aef079b9d5 100644
--- a/src/window.c
+++ b/src/window.c
@@ -5008,6 +5008,9 @@ and redisplay normally--don't erase and redraw the frame.  */)
   EMACS_INT iarg UNINIT;
   int this_scroll_margin;
 
+  /* For reasons why we signal an error here, see
+     http://lists.gnu.org/archive/html/emacs-devel/2014-06/msg00053.html,
+     http://lists.gnu.org/archive/html/emacs-devel/2014-06/msg00094.html.  */
   if (buf != current_buffer)
     error ("`recenter'ing a window that does not display current-buffer.");
 
-- 
2.21.0


From 59534f7698e598e4245cf47a70732956aa3f8280 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Fri, 2 Mar 2018 16:06:32 -0500
Subject: [PATCH 074/297] * lisp/gnus/gnus.el (image-load-path): Declare for
 without-x builds.

---
 lisp/gnus/gnus.el | 1 +
 1 file changed, 1 insertion(+)

diff --git a/lisp/gnus/gnus.el b/lisp/gnus/gnus.el
index 123b64ac6c..fb2ae192f1 100644
--- a/lisp/gnus/gnus.el
+++ b/lisp/gnus/gnus.el
@@ -752,6 +752,7 @@ be set in `.emacs' instead."
   (cdr (assq gnus-logo-color-style gnus-logo-color-alist))
   "Colors used for the Gnus logo.")
 
+(defvar image-load-path)
 (declare-function image-size "image.c" (spec &optional pixels frame))
 
 (defun gnus-group-startup-message (&optional x y)
-- 
2.21.0


From 90901ef931f3dc8b893a717d9ff922a847bdc87d Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Fri, 2 Mar 2018 19:33:24 -0800
Subject: [PATCH 075/297] Quieten eshell compilation

* lisp/eshell/em-dirs.el (eshell-dirs-initialize, eshell/pwd):
* lisp/eshell/em-script.el (eshell-script-initialize):
* lisp/eshell/em-unix.el (eshell/whoami):
* lisp/eshell/esh-proc.el (eshell/jobs): Mark unused arguments.
---
 lisp/eshell/em-dirs.el   | 4 ++--
 lisp/eshell/em-script.el | 2 +-
 lisp/eshell/em-unix.el   | 2 +-
 lisp/eshell/esh-proc.el  | 2 +-
 4 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/lisp/eshell/em-dirs.el b/lisp/eshell/em-dirs.el
index 37cb6b169a..34bf821c11 100644
--- a/lisp/eshell/em-dirs.el
+++ b/lisp/eshell/em-dirs.el
@@ -207,7 +207,7 @@ Thus, this does not include the current directory.")
   (when eshell-cd-on-directory
     (make-local-variable 'eshell-interpreter-alist)
     (setq eshell-interpreter-alist
-	  (cons (cons #'(lambda (file args)
+	  (cons (cons #'(lambda (file _args)
                           (eshell-lone-directory-p file))
 		      'eshell-dirs-substitute-cd)
 		eshell-interpreter-alist)))
@@ -300,7 +300,7 @@ Thus, this does not include the current directory.")
 		    (file-name-as-directory (cdr user))))
 		 eshell-user-names)))))))
 
-(defun eshell/pwd (&rest args)
+(defun eshell/pwd (&rest _args)
   "Change output from `pwd' to be cleaner."
   (let* ((path default-directory)
 	 (len (length path)))
diff --git a/lisp/eshell/em-script.el b/lisp/eshell/em-script.el
index 1b0b220d5b..a5d8e96ba8 100644
--- a/lisp/eshell/em-script.el
+++ b/lisp/eshell/em-script.el
@@ -61,7 +61,7 @@ This includes when running `eshell-command'."
   "Initialize the script parsing code."
   (make-local-variable 'eshell-interpreter-alist)
   (setq eshell-interpreter-alist
-	(cons (cons #'(lambda (file args)
+	(cons (cons #'(lambda (file _args)
                         (string= (file-name-nondirectory file)
                                  "eshell"))
                     'eshell/source)
diff --git a/lisp/eshell/em-unix.el b/lisp/eshell/em-unix.el
index c3448de407..a18fb85507 100644
--- a/lisp/eshell/em-unix.el
+++ b/lisp/eshell/em-unix.el
@@ -965,7 +965,7 @@ Show wall-clock time elapsed during execution of COMMAND.")
 				  (eshell-stringify-list
 				   (eshell-flatten-list (cdr time-args))))))))
 
-(defun eshell/whoami (&rest args)
+(defun eshell/whoami (&rest _args)
   "Make \"whoami\" Tramp aware."
   (or (file-remote-p default-directory 'user) (user-login-name)))
 
diff --git a/lisp/eshell/esh-proc.el b/lisp/eshell/esh-proc.el
index 59fb9b926d..f1380852b3 100644
--- a/lisp/eshell/esh-proc.el
+++ b/lisp/eshell/esh-proc.el
@@ -158,7 +158,7 @@ The signals which will cause this to happen are matched by
 
 (defalias 'eshell/wait 'eshell-wait-for-process)
 
-(defun eshell/jobs (&rest args)
+(defun eshell/jobs (&rest _args)
   "List processes, if there are any."
   (and (fboundp 'process-list)
        (process-list)
-- 
2.21.0


From 7f55ad8ea4bdae99cb4d3bf068c2d47192374fa3 Mon Sep 17 00:00:00 2001
From: Evgeni Kolev <evgenysw@gmail.com>
Date: Sat, 3 Mar 2018 13:07:26 +0200
Subject: [PATCH 076/297] Fix font-lock in perl-mode

* lisp/progmodes/perl-mode.el (perl-font-lock-keywords-1): Prevent
the regexp from matching keywords if they start with a Perl sigil.
(Bug#30549)
---
 lisp/progmodes/perl-mode.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lisp/progmodes/perl-mode.el b/lisp/progmodes/perl-mode.el
index 99480788f5..c1d94acfa5 100644
--- a/lisp/progmodes/perl-mode.el
+++ b/lisp/progmodes/perl-mode.el
@@ -165,7 +165,7 @@
     ;; Fontify function and package names in declarations.
     ("\\<\\(package\\|sub\\)\\>[ \t]*\\(\\sw+\\)?"
      (1 font-lock-keyword-face) (2 font-lock-function-name-face nil t))
-    ("\\<\\(import\\|no\\|require\\|use\\)\\>[ \t]*\\(\\sw+\\)?"
+    ("\\(^\\|[^$@%&\\]\\)\\<\\(import\\|no\\|require\\|use\\)\\>[ \t]*\\(\\sw+\\)?"
      (1 font-lock-keyword-face) (2 font-lock-constant-face nil t)))
   "Subdued level highlighting for Perl mode.")
 
-- 
2.21.0


From d78f123c64c3e41c2bd7f6fa117016d38073c2af Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Sat, 3 Mar 2018 14:54:15 +0200
Subject: [PATCH 077/297] Improve commentary in simple,el

* lisp/simple.el (next-error-last-buffer): Improve commentary.
(Bug#20489)
---
 lisp/simple.el | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/lisp/simple.el b/lisp/simple.el
index edcb73ce2e..60a00286f8 100644
--- a/lisp/simple.el
+++ b/lisp/simple.el
@@ -121,6 +121,11 @@ If non-nil, the value is passed directly to `recenter'."
 A buffer becomes most recent when its compilation, grep, or
 similar mode is started, or when it is used with \\[next-error]
 or \\[compile-goto-error].")
+
+;; next-error-last-buffer is made buffer-local to keep the reference
+;; to the parent buffer used to navigate to the current buffer, so the
+;; next call of next-buffer will use the same parent buffer to
+;; continue navigation from it.
 (make-variable-buffer-local 'next-error-last-buffer)
 
 (defvar next-error-function nil
-- 
2.21.0


From 4b53e71ccd0acc403a8d0b7a8d8deb53face2269 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Sat, 3 Mar 2018 10:36:48 -0800
Subject: [PATCH 078/297] Quieten gud.el and gdb-mi.el compilation

* lisp/progmodes/gud.el (gud-gdb):
* lisp/progmodes/gdb-mi.el (gdb):
Suppress "unused lexical argument" warning.
---
 lisp/progmodes/gdb-mi.el | 2 +-
 lisp/progmodes/gud.el    | 3 ++-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/lisp/progmodes/gdb-mi.el b/lisp/progmodes/gdb-mi.el
index c664799ab0..88e34d8df9 100644
--- a/lisp/progmodes/gdb-mi.el
+++ b/lisp/progmodes/gdb-mi.el
@@ -792,7 +792,7 @@ detailed description of this mode.
   (gud-def gud-tbreak "tbreak %f:%l" "\C-t"
 	   "Set temporary breakpoint at current line.")
   (gud-def gud-jump
-	   (progn (gud-call "tbreak %f:%l") (gud-call "jump %f:%l"))
+	   (progn (gud-call "tbreak %f:%l" arg) (gud-call "jump %f:%l"))
 	   "\C-j" "Set execution address to current line.")
 
   (gud-def gud-up     "up %p"     "<" "Up N stack frames (numeric arg).")
diff --git a/lisp/progmodes/gud.el b/lisp/progmodes/gud.el
index 72f5769558..6aa9a7e4d4 100644
--- a/lisp/progmodes/gud.el
+++ b/lisp/progmodes/gud.el
@@ -378,6 +378,7 @@ we're in the GUD buffer)."
        (if (not gud-running)
 	 ,(if (stringp cmd)
 	      `(gud-call ,cmd arg)
+	    ;; Unused lexical warning if cmd does not use "arg".
 	    cmd))))
      ,(if key `(local-set-key ,(concat "\C-c" key) ',func))
      ,(if key `(global-set-key (vconcat gud-key-prefix ,key) ',func))))
@@ -771,7 +772,7 @@ the buffer in which this command was invoked."
   (gud-def gud-cont   "cont"     "\C-r" "Continue with display.")
   (gud-def gud-finish "finish"   "\C-f" "Finish executing current function.")
   (gud-def gud-jump
-	   (progn (gud-call "tbreak %f:%l") (gud-call "jump %f:%l"))
+	   (progn (gud-call "tbreak %f:%l" arg) (gud-call "jump %f:%l"))
 	   "\C-j" "Set execution address to current line.")
 
   (gud-def gud-up     "up %p"     "<" "Up N stack frames (numeric arg).")
-- 
2.21.0


From 448cdbfa61cf718f730a9efaa7412a97b73618a9 Mon Sep 17 00:00:00 2001
From: Juri Linkov <juri@linkov.net>
Date: Sun, 4 Mar 2018 00:33:30 +0200
Subject: [PATCH 079/297] =?UTF-8?q?*=20lisp/isearch.el=20(search-exit-opti?=
 =?UTF-8?q?on):=20Add=20options=20=E2=80=98shift-move=E2=80=99=20and=20?=
 =?UTF-8?q?=E2=80=98move=E2=80=99.?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Change type from ‘boolean’ to ‘choice’.  Extend docstring.
(isearch-pre-move-point): New variable.
(isearch-pre-command-hook, isearch-post-command-hook):
Handle search-exit-option for values ‘move’ and ‘shift-move’.

* doc/emacs/search.texi (Not Exiting Isearch): Document new
values ‘shift-move’ and ‘move’ of search-exit-option.

https://lists.gnu.org/archive/html/emacs-devel/2018-03/msg00013.html
---
 doc/emacs/search.texi | 14 +++++++++++-
 etc/NEWS              |  8 +++++++
 lisp/isearch.el       | 52 ++++++++++++++++++++++++++++++++++++++-----
 3 files changed, 67 insertions(+), 7 deletions(-)

diff --git a/doc/emacs/search.texi b/doc/emacs/search.texi
index 887fd982d0..0de3aee1b2 100644
--- a/doc/emacs/search.texi
+++ b/doc/emacs/search.texi
@@ -437,7 +437,7 @@ of the keymap @code{isearch-mode-map} (@pxref{Keymaps}).
 
 This subsection describes how to control whether typing a command not
 specifically meaningful in searches exits the search before executing
-the command.  It also describes two categories of commands which you
+the command.  It also describes three categories of commands which you
 can type without exiting the current incremental search, even though
 they are not themselves part of incremental search.
 
@@ -507,6 +507,18 @@ change point, the buffer contents, the match data, the current buffer,
 or the selected window and frame.  The command must not itself attempt
 an incremental search.  This feature is disabled if
 @code{isearch-allow-scroll} is @code{nil} (which it is by default).
+
+@item Motion Commands
+@cindex motion commands, during incremental search
+When @code{search-exit-option} is customized to @code{shift-move},
+you can extend the search string by holding down the shift key while
+typing cursor motion commands.  It will yank text that ends at the new
+position after moving point in the current buffer.
+
+When @code{search-exit-option} is @code{move}, you can extend the
+search string without using the shift key for cursor motion commands,
+but it applies only for certain motion command that have the
+@code{isearch-move} property on their symbols.
 @end table
 
 @node Isearch Minibuffer
diff --git a/etc/NEWS b/etc/NEWS
index 55b56357fb..23bbb5e353 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -180,6 +180,14 @@ created by 'edit-last-kbd-macro', and to save the macro by 'C-c C-c'.
 ---
 *** New filter ibuffer-filter-by-process; bound to '/E'.
 
+** Search and Replace
+
+*** 'search-exit-option' provides new options 'move' and 'shift-move'
+to extend the search string by yanking text that ends at the new
+position after moving point in the current buffer.  'shift-move'
+extends the search string by motion commands while holding down
+the shift key.
+
 ** Edebug
 
 +++
diff --git a/lisp/isearch.el b/lisp/isearch.el
index a41adf0c2c..96faa27c17 100644
--- a/lisp/isearch.el
+++ b/lisp/isearch.el
@@ -67,8 +67,23 @@
 
 
 (defcustom search-exit-option t
-  "Non-nil means random control characters terminate incremental search."
-  :type 'boolean)
+  "Defines what control characters do in incremental search.
+If t, random control and meta characters terminate the search
+and are then executed normally.
+If `edit', edit the search string instead of exiting.
+If `move', extend the search string by motion commands
+that have the `isearch-move' property on their symbols.
+If `shift-move', extend the search string by motion commands
+while holding down the shift key.
+Both `move' and `shift-move' extend the search string by yanking text
+that ends at the new position after moving point in the current buffer.
+If nil, run the command without exiting Isearch."
+  :type '(choice (const :tag "Terminate incremental search" t)
+                 (const :tag "Edit the search string" edit)
+                 (const :tag "Extend the search string by motion commands" move)
+                 (const :tag "Extend the search string by shifted motion keys" shift-move)
+                 (const :tag "Don't terminate incremental search" nil))
+  :version "27.1")
 
 (defcustom search-slow-window-lines 1
   "Number of lines in slow search display windows.
@@ -2391,6 +2406,7 @@ the bottom."
   (goto-char isearch-point))
 
 (defvar isearch-pre-scroll-point nil)
+(defvar isearch-pre-move-point nil)
 
 (defun isearch-pre-command-hook ()
   "Decide whether to exit Isearch mode before executing the command.
@@ -2398,8 +2414,9 @@ Don't exit Isearch if the key sequence that invoked this command
 is bound in `isearch-mode-map', or if the invoked command is
 a prefix argument command (when `isearch-allow-prefix' is non-nil),
 or it is a scrolling command (when `isearch-allow-scroll' is non-nil).
-Otherwise, exit Isearch (when `search-exit-option' is non-nil)
-before the command is executed globally with terminated Isearch."
+Otherwise, exit Isearch (when `search-exit-option' is t)
+before the command is executed globally with terminated Isearch.
+See more for options in `search-exit-option'."
   (let* ((key (this-single-command-keys))
 	 (main-event (aref key 0)))
     (cond
@@ -2427,6 +2444,14 @@ before the command is executed globally with terminated Isearch."
       ;; Swallow the up-event.
       (read-event)
       (setq this-command 'isearch-edit-string))
+     ;; Don't terminate the search for motion commands.
+     ((or (and (eq search-exit-option 'move)
+               (symbolp this-command)
+               (eq (get this-command 'isearch-move) t))
+          (and (eq search-exit-option 'shift-move)
+               this-command-keys-shift-translated))
+      (setq this-command-keys-shift-translated nil)
+      (setq isearch-pre-move-point (point)))
      ;; Other characters terminate the search and are then executed normally.
      (search-exit-option
       (isearch-done)
@@ -2436,13 +2461,28 @@ before the command is executed globally with terminated Isearch."
       (isearch-process-search-string key key)))))
 
 (defun isearch-post-command-hook ()
-  (when isearch-pre-scroll-point
+  (cond
+   (isearch-pre-scroll-point
     (let ((ab-bel (isearch-string-out-of-window isearch-pre-scroll-point)))
       (if ab-bel
 	  (isearch-back-into-window (eq ab-bel 'above) isearch-pre-scroll-point)
 	(goto-char isearch-pre-scroll-point)))
     (setq isearch-pre-scroll-point nil)
-    (isearch-update)))
+    (isearch-update))
+   ((memq search-exit-option '(move shift-move))
+    (when (and isearch-pre-move-point
+               (not (eq isearch-pre-move-point (point))))
+      (let ((string (buffer-substring-no-properties
+                     (or isearch-other-end isearch-opoint) (point))))
+        (if isearch-regexp (setq string (regexp-quote string)))
+        (setq isearch-string string)
+        (setq isearch-message (mapconcat 'isearch-text-char-description
+                                         string ""))
+        (setq isearch-yank-flag t)
+        (setq isearch-forward (<= (or isearch-other-end isearch-opoint) (point)))
+        (goto-char isearch-pre-move-point)
+        (isearch-search-and-update)))
+    (setq isearch-pre-move-point nil))))
 
 (defun isearch-quote-char (&optional count)
   "Quote special characters for incremental search.
-- 
2.21.0


From 201b7189252be943e56ac808ddf761e4caa23284 Mon Sep 17 00:00:00 2001
From: Bill Wohler <wohler@newt.com>
Date: Sat, 3 Mar 2018 15:57:43 -0800
Subject: [PATCH 080/297] Add missing findex entries for recently removed
 kindex entries

* doc/misc/mh-e.texi:
---
 doc/misc/mh-e.texi | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/doc/misc/mh-e.texi b/doc/misc/mh-e.texi
index 74b17264d2..b44e503996 100644
--- a/doc/misc/mh-e.texi
+++ b/doc/misc/mh-e.texi
@@ -5974,6 +5974,9 @@ Using prefixes instead of postfixes helps you explore aliases during
 completion. If you forget the name of an old dive buddy, you can enter
 @samp{div} and then @key{SPC} to get a listing of all your dive buddies.
 
+@findex mh-alias-add-address-under-point
+@findex mh-alias-grab-from-field
+
 An alias for the sender of the current message is added automatically
 by clicking on the @samp{Grab From alias} tool bar button or by running
 the @kbd{M-x mh-alias-grab-from-field} command. Aliases for other
@@ -6265,6 +6268,7 @@ containing the value for the field is given.
 @cindex folder navigation
 @cindex speedbar
 @findex mh-visit-folder
+@findex speedbar
 @kindex F v
 @kindex mouse-2
 
@@ -7984,6 +7988,7 @@ system.
 @cindex MH-E version
 @cindex @file{*MH-E Info*}
 @cindex version
+@findex mh-version
 
 One command worth noting is @kbd{M-x mh-version}. You can compare the
 version this command prints to the latest release (@pxref{Getting
@@ -8698,6 +8703,7 @@ I also point out some additional sources of information.
 
 @cindex bugs
 @cindex SourceForge
+@findex mh-version
 
 Bug reports should be filed at
 @uref{https://sourceforge.net/p/mh-e/bugs/, SourceForge}. You need to
@@ -8773,6 +8779,7 @@ instead.
 @cindex news
 @cindex @samp{MH-E-NEWS}
 @cindex @samp{README}
+@findex mh-version
 
 After you download and extract the MH-E tarball, read the
 @file{README} file and @file{MH-E-NEWS}. These correspond to the
-- 
2.21.0


From bf4665f3c0a9747f144556b6f496d9525f6df438 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Sat, 3 Mar 2018 17:17:36 -0800
Subject: [PATCH 081/297] Replace some obsolete functions in gnus

* lisp/gnus/mml-sec.el (mml-secure-epg-encrypt):
* lisp/gnus/smime.el (smime-ask-passphrase): Replace obsolete functions.
---
 lisp/gnus/mml-sec.el | 2 +-
 lisp/gnus/smime.el   | 3 ++-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/lisp/gnus/mml-sec.el b/lisp/gnus/mml-sec.el
index 099e5372b4..3855d7b796 100644
--- a/lisp/gnus/mml-sec.el
+++ b/lisp/gnus/mml-sec.el
@@ -903,7 +903,7 @@ If no one is selected, symmetric encryption will be performed.  "
 (defun mml-secure-epg-encrypt (protocol cont &optional sign)
   ;; Based on code appearing inside mml2015-epg-encrypt.
   (let* ((context (epg-make-context protocol))
-	 (config (epg-configuration))
+	 (config (epg-find-configuration 'OpenPGP))
 	 (sender (message-options-get 'message-sender))
 	 (recipients (mml-secure-recipients protocol context config sender))
 	 (signer-names (mml-secure-signer-names protocol sender))
diff --git a/lisp/gnus/smime.el b/lisp/gnus/smime.el
index 3e722d2d82..d55cea724f 100644
--- a/lisp/gnus/smime.el
+++ b/lisp/gnus/smime.el
@@ -234,10 +234,11 @@ must be set in `ldap-host-parameters-alist'."
 If `cache-key' and `password-cache' is non-nil then cache the
 password under `cache-key'."
   (let ((passphrase
-	 (password-read-and-add
+	 (password-read
 	  "Passphrase for secret key (RET for no passphrase): " cache-key)))
     (if (string= passphrase "")
 	nil
+      (and passphrase cache-key (password-cache-add cache-key passphrase))
       passphrase)))
 
 ;; OpenSSL wrappers.
-- 
2.21.0


From 0e4d127afee81ee693700de7a5f75dcf98272189 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Sat, 3 Mar 2018 17:39:20 -0800
Subject: [PATCH 082/297] * lisp/epa-mail.el (epa-mail-default-recipients):
 Replace obsolete func.

---
 lisp/epa-mail.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lisp/epa-mail.el b/lisp/epa-mail.el
index 077666ac89..c819f6734c 100644
--- a/lisp/epa-mail.el
+++ b/lisp/epa-mail.el
@@ -111,7 +111,7 @@ If no one is selected, default secret key is used.  "
 
 (defun epa-mail-default-recipients ()
   "Return the default list of encryption recipients for a mail buffer."
-  (let ((config (epg-configuration))
+  (let ((config (epg-find-configuration 'OpenPGP))
 	recipients-string real-recipients)
     (save-excursion
       (goto-char (point-min))
-- 
2.21.0


From caac64e03121b2b3cd046a69c5acf7a7f1056ea5 Mon Sep 17 00:00:00 2001
From: Daniel Colascione <dancol@dancol.org>
Date: Sun, 4 Mar 2018 17:13:28 -0800
Subject: [PATCH 083/297] Rename marker_free_list to misc_free_list

* src/alloc.c: 'marker_free_list' -> 'misc_free_list' throughout
---
 src/alloc.c | 20 ++++++++++----------
 1 file changed, 10 insertions(+), 10 deletions(-)

diff --git a/src/alloc.c b/src/alloc.c
index a50bb81409..cc52d66b32 100644
--- a/src/alloc.c
+++ b/src/alloc.c
@@ -3596,7 +3596,7 @@ struct marker_block
 static struct marker_block *marker_block;
 static int marker_block_index = MARKER_BLOCK_SIZE;
 
-static union Lisp_Misc *marker_free_list;
+static union Lisp_Misc *misc_free_list;
 
 /* Return a newly allocated Lisp_Misc object of specified TYPE.  */
 
@@ -3607,10 +3607,10 @@ allocate_misc (enum Lisp_Misc_Type type)
 
   MALLOC_BLOCK_INPUT;
 
-  if (marker_free_list)
+  if (misc_free_list)
     {
-      XSETMISC (val, marker_free_list);
-      marker_free_list = marker_free_list->u_free.chain;
+      XSETMISC (val, misc_free_list);
+      misc_free_list = misc_free_list->u_free.chain;
     }
   else
     {
@@ -3642,8 +3642,8 @@ void
 free_misc (Lisp_Object misc)
 {
   XMISCANY (misc)->type = Lisp_Misc_Free;
-  XMISC (misc)->u_free.chain = marker_free_list;
-  marker_free_list = XMISC (misc);
+  XMISC (misc)->u_free.chain = misc_free_list;
+  misc_free_list = XMISC (misc);
   consing_since_gc -= sizeof (union Lisp_Misc);
   total_free_markers++;
 }
@@ -6974,7 +6974,7 @@ sweep_misc (void)
   /* Put all unmarked misc's on free list.  For a marker, first
      unchain it from the buffer it points into.  */
 
-  marker_free_list = 0;
+  misc_free_list = 0;
 
   for (mblk = marker_block; mblk; mblk = *mprev)
     {
@@ -7001,8 +7001,8 @@ sweep_misc (void)
                  We could leave the type alone, since nobody checks it,
                  but this might catch bugs faster.  */
               mblk->markers[i].m.u_marker.type = Lisp_Misc_Free;
-              mblk->markers[i].m.u_free.chain = marker_free_list;
-              marker_free_list = &mblk->markers[i].m;
+              mblk->markers[i].m.u_free.chain = misc_free_list;
+              misc_free_list = &mblk->markers[i].m;
               this_free++;
             }
           else
@@ -7019,7 +7019,7 @@ sweep_misc (void)
         {
           *mprev = mblk->next;
           /* Unhook from the free list.  */
-          marker_free_list = mblk->markers[0].m.u_free.chain;
+          misc_free_list = mblk->markers[0].m.u_free.chain;
           lisp_free (mblk);
         }
       else
-- 
2.21.0


From 618895c572f4ae8543cddb04785181e2513463c8 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Fri, 2 Mar 2018 15:05:16 -0500
Subject: [PATCH 084/297] ; * lisp/wheel.el: Rearrange to match master, to
 reduce merge conflicts

No need to merge to master.
---
 lisp/mwheel.el | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/lisp/mwheel.el b/lisp/mwheel.el
index 09f3953ff9..fdd2aba586 100644
--- a/lisp/mwheel.el
+++ b/lisp/mwheel.el
@@ -223,6 +223,18 @@ This can be slightly disconcerting, but some people prefer it."
     (intern "mouse-7"))
   "Event used for scrolling right.")
 
+(defvar mouse-wheel-left-event
+  (if (or (featurep 'w32-win) (featurep 'ns-win))
+      'wheel-left
+    (intern "mouse-6"))
+  "Event used for scrolling left.")
+
+(defvar mouse-wheel-right-event
+  (if (or (featurep 'w32-win) (featurep 'ns-win))
+      'wheel-right
+    (intern "mouse-7"))
+  "Event used for scrolling right.")
+
 (defun mwheel-scroll (event)
   "Scroll up or down according to the EVENT.
 This should be bound only to mouse buttons 4, 5, 6, and 7 on
-- 
2.21.0


From 497819a00978a8ca98d835a0eaee82576bd7573e Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Sat, 3 Mar 2018 11:50:24 +0200
Subject: [PATCH 085/297] More improvements of the Emacs manual

* doc/emacs/rmail.texi (Rmail Reply, Rmail Sorting): Improve
wording.  Suggested by Daniel Chakraborty
<danielmchakraborty@gmail.com>.

* doc/emacs/glossary.texi (Glossary): Add cross-references.
Improve and clarify wording.  Suggested by Gijs Hillenius
<gijs@hillenius.net> in emacs-manual-bugs@gnu.org.

* doc/emacs/text.texi (Org Authoring): Add more supported formats
to the list.
(TeX Print): Improve wording.  Slightly rearrange stuff.
(TeX Misc): Mention doctex-mode-hook.
(Two-Column): Minor rearrangement of text.  Suggested by Michael
Albinus <michael.albinus@gmx.de> in emacs-manual-bugs@gnu.org.

* doc/emacs/misc.texi (Saving Emacs Sessions):
* doc/emacs/programs.texi (Program Modes): Remove redundant text
and index entries.
---
 doc/emacs/glossary.texi | 37 +++++++++++++++++++------------------
 doc/emacs/misc.texi     |  6 ------
 doc/emacs/programs.texi |  1 -
 doc/emacs/rmail.texi    |  4 ++--
 doc/emacs/text.texi     | 37 +++++++++++++++++++++----------------
 5 files changed, 42 insertions(+), 43 deletions(-)

diff --git a/doc/emacs/glossary.texi b/doc/emacs/glossary.texi
index 94f2c27cbc..dda13dd55b 100644
--- a/doc/emacs/glossary.texi
+++ b/doc/emacs/glossary.texi
@@ -103,13 +103,14 @@ supports both of these forms, as well as any mixture of them---this
 is ``bidirectional text''.  @xref{Bidirectional Editing}.
 
 @item Bind
+@anchor{Glossary---Bind}
 To bind a key sequence means to give it a binding (q.v.).
 @xref{Rebinding}.
 
 @anchor{Glossary---Binding}
 @item Binding
 A key sequence gets its meaning in Emacs by having a binding, which is a
-command (q.v.), a Lisp function that is run when you type that
+command (q.v.)---a Lisp function that is run when you type that
 sequence.  @xref{Commands,Binding}.  Customization often involves
 rebinding a character to a different command function.  The bindings of
 all key sequences are recorded in the keymaps (q.v.).  @xref{Keymaps}.
@@ -141,8 +142,8 @@ are visiting (q.v.@:) some file.  @xref{Buffers}.
 
 @item Buffer Selection History
 Emacs keeps a buffer selection history that records how recently each
-Emacs buffer has been selected.  This is used for choosing a buffer to
-select.  @xref{Buffers}.
+Emacs buffer has been selected.  This is used for choosing which
+buffer to select.  @xref{Buffers}.
 
 @item Bug
 A bug is an incorrect or unreasonable behavior of a program, or
@@ -220,9 +221,9 @@ the clipboard is used @emph{instead} of the primary selection.
 @xref{Clipboard}.
 
 @item Coding System
-A coding system is an encoding for representing text characters in a
-file or in a stream of information.  Emacs has the ability to convert
-text to or from a variety of coding systems when reading or writing it.
+A coding system is a way to encode text characters in a file or in a
+stream of information.  Emacs has the ability to convert text to or
+from a variety of coding systems when reading or writing it.
 @xref{Coding Systems}.
 
 @item Command
@@ -263,12 +264,12 @@ executes faster.
 
 @item Complete Key
 A complete key is a key sequence that fully specifies one action to be
-performed by Emacs.  For example, @kbd{X} and @kbd{C-f} and @kbd{C-x m}
-are complete keys.  Complete keys derive their meanings from being bound
-(q.v.@:) to commands (q.v.).  Thus, @kbd{X} is conventionally bound to
-a command to insert @samp{X} in the buffer; @kbd{C-x m} is
-conventionally bound to a command to begin composing a mail message.
-@xref{Keys}.
+performed by Emacs.  For example, @kbd{X} and @kbd{C-f} and @kbd{C-x
+m} are complete keys.  Complete keys derive their meanings from being
+bound (@pxref{Glossary---Bind}) to commands (q.v.).  Thus, @kbd{X} is
+conventionally bound to a command to insert @samp{X} in the buffer;
+@kbd{C-x m} is conventionally bound to a command to begin composing a
+mail message.  @xref{Keys}.
 
 @item Completion
 Completion is what Emacs does when it automatically expands an
@@ -281,11 +282,11 @@ file names.  Completion usually occurs when @key{TAB}, @key{SPC} or
 @anchor{Glossary---Continuation Line}
 @item Continuation Line
 When a line of text is longer than the width of the window, it
-normally (but see @ref{Glossary---Truncation}) takes up more than one
-screen line when displayed.  We say that the text line is continued, and all
-screen lines used for it after the first are called continuation
-lines.  @xref{Continuation Lines}.  A related Emacs feature is
-filling (q.v.).
+normally takes up more than one screen line when displayed (but see
+@ref{Glossary---Truncation}).  We say that the text line is continued,
+and all screen lines used for it after the first are called
+continuation lines.  @xref{Continuation Lines}.  A related Emacs
+feature is filling (q.v.).
 
 @item Control Character
 A control character is a character that you type by holding down the
@@ -418,7 +419,7 @@ Variables}.
 On GNU and other Unix-like systems, directory names are strings that
 end in @samp{/}.  For example, @file{/no-such-dir/} is a directory
 name whereas @file{/tmp} is not, even though @file{/tmp} names a file
-that happens to be a directory.  On MS-DOS the relationship is more
+that happens to be a directory.  On MS-Windows the relationship is more
 complicated.  @xref{Directory Names,,, elisp, the Emacs Lisp Reference
 Manual}.
 
diff --git a/doc/emacs/misc.texi b/doc/emacs/misc.texi
index e1b8070f43..60986347a7 100644
--- a/doc/emacs/misc.texi
+++ b/doc/emacs/misc.texi
@@ -2463,12 +2463,6 @@ sessions, or add this line in your init file (@pxref{Init File}):
 (desktop-save-mode 1)
 @end example
 
-@vindex desktop-auto-save-timeout
-@noindent
-When @code{desktop-save-mode} is active and the desktop file exists,
-Emacs auto-saves it every @code{desktop-auto-save-timeout}
-seconds, if that is non-@code{nil} and non-zero.
-
 @findex desktop-change-dir
 @findex desktop-revert
 @vindex desktop-path
diff --git a/doc/emacs/programs.texi b/doc/emacs/programs.texi
index 514a07a28f..c39df692ad 100644
--- a/doc/emacs/programs.texi
+++ b/doc/emacs/programs.texi
@@ -77,7 +77,6 @@ mode for the C programming language is @code{c-mode}.
 @cindex VHDL mode
 @cindex M4 mode
 @cindex Shell-script mode
-@cindex Scheme mode
 @cindex OPascal mode
 @cindex PostScript mode
 @cindex Conf mode
diff --git a/doc/emacs/rmail.texi b/doc/emacs/rmail.texi
index e9371f39a9..cb62ce3652 100644
--- a/doc/emacs/rmail.texi
+++ b/doc/emacs/rmail.texi
@@ -802,7 +802,7 @@ its contents.
 @vindex rmail-enable-mime-composing
 @findex unforward-rmail-message
   Rmail offers two formats for forwarded messages.  The default is to
-use MIME (@pxref{Rmail Display}) format.  This includes the original
+use the MIME format (@pxref{Rmail Display}).  This includes the original
 message as a separate part.  You can use a simpler format if you
 prefer, by setting the variable @code{rmail-enable-mime-composing} to
 @code{nil}.  In this case, Rmail just includes the original message
@@ -1092,7 +1092,7 @@ Sort messages of current Rmail buffer by author's name.
 @findex rmail-sort-by-recipient
 @item C-c C-s C-r
 @itemx M-x rmail-sort-by-recipient
-Sort messages of current Rmail buffer by recipient's names.
+Sort messages of current Rmail buffer by recipient's name.
 
 @findex rmail-sort-by-correspondent
 @item C-c C-s C-c
diff --git a/doc/emacs/text.texi b/doc/emacs/text.texi
index 9ecc41e888..4ffea18875 100644
--- a/doc/emacs/text.texi
+++ b/doc/emacs/text.texi
@@ -1461,8 +1461,9 @@ etc.
 export and publication.  To export the current buffer, type @kbd{C-c
 C-e} (@code{org-export}) anywhere in an Org buffer.  This command
 prompts for an export format; currently supported formats include
-HTML, @LaTeX{}, OpenDocument (@file{.odt}), and PDF@.  Some formats,
-such as PDF, require certain system tools to be installed.
+HTML, @LaTeX{}, Texinfo, OpenDocument (@file{.odt}), iCalendar,
+Markdown, man-page, and PDF@.  Some formats, such as PDF, require
+certain system tools to be installed.
 
 @vindex org-publish-project-alist
   To export several files at once to a specific directory, either
@@ -1521,14 +1522,14 @@ with @LaTeX{}.}.
   Emacs provides a @TeX{} major mode for each of these variants: Plain
 @TeX{} mode, @LaTeX{} mode, Doc@TeX{} mode, and Sli@TeX{} mode.  Emacs
 selects the appropriate mode by looking at the contents of the buffer.
-(This is done by the @code{tex-mode} command, which is normally called
-automatically when you visit a @TeX{}-like file.  @xref{Choosing
-Modes}.)  If the contents are insufficient to determine this, Emacs
-chooses the mode specified by the variable @code{tex-default-mode};
-its default value is @code{latex-mode}.  If Emacs does not guess
-right, you can select the correct variant of @TeX{} mode using the
-command @kbd{M-x plain-tex-mode}, @kbd{M-x latex-mode}, @kbd{M-x
-slitex-mode}, or @kbd{doctex-mode}.
+(This is done by invoking the @code{tex-mode} command, which is
+normally called automatically when you visit a @TeX{}-like file.
+@xref{Choosing Modes}.)  If the contents are insufficient to determine
+this, Emacs chooses the mode specified by the variable
+@code{tex-default-mode}; its default value is @code{latex-mode}.  If
+Emacs does not guess right, you can select the correct variant of
+@TeX{} mode using the command @kbd{M-x plain-tex-mode}, @kbd{M-x
+latex-mode}, @kbd{M-x slitex-mode}, or @kbd{doctex-mode}.
 
   The following sections document the features of @TeX{} mode and its
 variants.  There are several other @TeX{}-related Emacs packages,
@@ -1701,14 +1702,16 @@ chapter of a larger document).
 @table @kbd
 @item C-c C-b
 Invoke @TeX{} on the entire current buffer (@code{tex-buffer}).
+
 @item C-c C-r
 Invoke @TeX{} on the current region, together with the buffer's header
 (@code{tex-region}).
+
 @item C-c C-f
 Invoke @TeX{} on the current file (@code{tex-file}).
 
 @item C-c C-v
-Preview the output from the last @kbd{C-c C-r}, @kbd{C-c C-b}, or @kbd{C-c
+Preview the output from the last @kbd{C-c C-b}, @kbd{C-c C-r}, or @kbd{C-c
 C-f} command (@code{tex-view}).
 
 @item C-c C-p
@@ -1743,7 +1746,7 @@ C-p} (@code{tex-print}) to print a hardcopy of the output file.
 @cindex @env{TEXINPUTS} environment variable
 @vindex tex-directory
   By default, @kbd{C-c C-b} runs @TeX{} in the current directory.  The
-output of @TeX{} also goes in this directory.  To run @TeX{} in a
+output of @TeX{} is also created in this directory.  To run @TeX{} in a
 different directory, change the variable @code{tex-directory} to
 the desired directory.  If your environment variable @env{TEXINPUTS}
 contains relative names, or if your files contain
@@ -1889,14 +1892,16 @@ keys (@pxref{Completion}).
 
 @vindex tex-shell-hook
 @vindex tex-mode-hook
+@vindex doctex-mode-hook
 @vindex latex-mode-hook
 @vindex slitex-mode-hook
 @vindex plain-tex-mode-hook
   Entering any variant of @TeX{} mode runs the hooks
 @code{text-mode-hook} and @code{tex-mode-hook}.  Then it runs either
-@code{plain-tex-mode-hook}, @code{latex-mode-hook}, or
-@code{slitex-mode-hook}, whichever is appropriate.  Starting the
-@TeX{} shell runs the hook @code{tex-shell-hook}.  @xref{Hooks}.
+@code{plain-tex-mode-hook}, @code{doctex-mode-hook},
+@code{latex-mode-hook}, or @code{slitex-mode-hook}, whichever is
+appropriate.  Starting the @TeX{} shell runs the hook
+@code{tex-shell-hook}.  @xref{Hooks}.
 
 @findex iso-iso2tex
 @findex iso-tex2iso
@@ -2913,7 +2918,7 @@ right-hand buffer.)
 @kindex F2 RET
 @kindex C-x 6 RET
 @findex 2C-newline
-  The command @kbd{C-x 6 @key{RET}} or @kbd{@key{F2} @key{RET}}
+  The command @kbd{@key{F2} @key{RET}} or @kbd{C-x 6 @key{RET}}
 (@code{2C-newline}) inserts a newline in each of the two buffers at
 corresponding positions.  This is the easiest way to add a new line to
 the two-column text while editing it in split buffers.
-- 
2.21.0


From e7e025b86a433d0ce6405ff43da2cc18c23fc70f Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Sat, 3 Mar 2018 12:41:31 +0200
Subject: [PATCH 086/297] Avoid errors in flymake in builds --without-x

* lisp/progmodes/flymake.el: Require 'mwheel'.  (Bug#28732)
---
 lisp/progmodes/flymake.el | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/lisp/progmodes/flymake.el b/lisp/progmodes/flymake.el
index a47f13fea3..56f43e4bb3 100644
--- a/lisp/progmodes/flymake.el
+++ b/lisp/progmodes/flymake.el
@@ -48,6 +48,10 @@
 (require 'thingatpt) ; end-of-thing
 (require 'warnings) ; warning-numeric-level, display-warning
 (require 'compile) ; for some faces
+;; We need the next require to avoid compiler warnings and run-time
+;; errors about mouse-wheel-up/down-event in builds --without-x, where
+;; mwheel is not preloaded.
+(require 'mwheel)
 ;; when-let*, if-let*, hash-table-keys, hash-table-values:
 (eval-when-compile (require 'subr-x))
 
-- 
2.21.0


From 3a6648bf1e5d9aaf99defb22f1fdf7b55efcd499 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Sat, 3 Mar 2018 12:47:47 +0200
Subject: [PATCH 087/297] Prevent Flyspell from changing unrelated words

* lisp/textmodes/flyspell.el (flyspell-auto-correct-word): Avoid
using stale cached data from previous invocations of this command.
(Bug#30462)
---
 lisp/textmodes/flyspell.el | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/lisp/textmodes/flyspell.el b/lisp/textmodes/flyspell.el
index d87cb5e72e..e462669626 100644
--- a/lisp/textmodes/flyspell.el
+++ b/lisp/textmodes/flyspell.el
@@ -1944,6 +1944,10 @@ spell-check."
       (call-interactively flyspell--prev-meta-tab-binding)
     (let ((pos     (point))
           (old-max (point-max)))
+      ;; Flush a possibly stale cache from previous invocations of
+      ;; flyspell-auto-correct-word.
+      (if (not (eq last-command 'flyspell-auto-correct-word))
+          (setq flyspell-auto-correct-region nil))
       ;; Use the correct dictionary.
       (flyspell-accept-buffer-local-defs)
       (if (and (eq flyspell-auto-correct-pos pos)
-- 
2.21.0


From d8f794a6a46c9d5e5f16c3e5f6d654c3dd2232a4 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Sat, 3 Mar 2018 14:41:16 +0200
Subject: [PATCH 088/297] Remove outdated comment in syntax.el

* lisp/emacs-lisp/syntax.el (syntax-ppss-toplevel-pos): Remove
outdated comment.  (Bug#30617)
---
 lisp/emacs-lisp/syntax.el | 6 ------
 1 file changed, 6 deletions(-)

diff --git a/lisp/emacs-lisp/syntax.el b/lisp/emacs-lisp/syntax.el
index 6106720f7a..ad1a9665ff 100644
--- a/lisp/emacs-lisp/syntax.el
+++ b/lisp/emacs-lisp/syntax.el
@@ -363,12 +363,6 @@ An \"outermost position\" means one that it is outside of any syntactic entity:
 outside of any parentheses, comments, or strings encountered in the scan.
 If no such position is recorded in PPSS (because the end of the scan was
 itself at the outermost level), return nil."
-  ;; BEWARE! We rely on the undocumented 9th field.  The 9th field currently
-  ;; contains the list of positions of the enclosing open-parens.
-  ;; I.e. those positions are outside of any string/comment and the first of
-  ;; those is outside of any paren (i.e. corresponds to a nil ppss).
-  ;; If this list is empty but we are in a string or comment, then the 8th
-  ;; field contains a similar "toplevel" position.
   (or (car (nth 9 ppss))
       (nth 8 ppss)))
 
-- 
2.21.0


From e02c3c05205427f7b2b7804e8e7fd79b706bf98b Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Sat, 3 Mar 2018 19:39:55 +0200
Subject: [PATCH 089/297] Minor copyedits in doc/emacs/text.texi

* doc/emacs/text.texi (TeX Mode): Use @code for command markup.
(HTML Mode): Add a note about "C-x C-v" binding in HTML mode.
---
 doc/emacs/text.texi | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/doc/emacs/text.texi b/doc/emacs/text.texi
index 4ffea18875..8137945601 100644
--- a/doc/emacs/text.texi
+++ b/doc/emacs/text.texi
@@ -1528,8 +1528,8 @@ normally called automatically when you visit a @TeX{}-like file.
 this, Emacs chooses the mode specified by the variable
 @code{tex-default-mode}; its default value is @code{latex-mode}.  If
 Emacs does not guess right, you can select the correct variant of
-@TeX{} mode using the command @kbd{M-x plain-tex-mode}, @kbd{M-x
-latex-mode}, @kbd{M-x slitex-mode}, or @kbd{doctex-mode}.
+@TeX{} mode using the commands @code{plain-tex-mode},
+@code{latex-mode}, @code{slitex-mode}, or @code{doctex-mode}.
 
   The following sections document the features of @TeX{} mode and its
 variants.  There are several other @TeX{}-related Emacs packages,
@@ -2007,7 +2007,8 @@ characters themselves (@code{sgml-name-8bit-mode}).
 @kindex C-c C-v @r{(SGML mode)}
 @findex sgml-validate
 Run a shell command (which you must specify) to validate the current
-buffer as SGML (@code{sgml-validate}).
+buffer as SGML (@code{sgml-validate}).  (In HTML mode this key
+sequence runs a different command.)
 
 @item C-c @key{TAB}
 @kindex C-c TAB @r{(SGML mode)}
-- 
2.21.0


From 7578ba19097ac5790cf0edc4d3f84703a4aa6a92 Mon Sep 17 00:00:00 2001
From: Juri Linkov <juri@linkov.net>
Date: Sat, 3 Mar 2018 23:33:15 +0200
Subject: [PATCH 090/297] * lisp/progmodes/grep.el (zrgrep):

Let-bind grep-use-null-filename-separator to nil (bug#30559).
---
 lisp/progmodes/grep.el | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/lisp/progmodes/grep.el b/lisp/progmodes/grep.el
index 9b2c6f112c..dc74ad2de5 100644
--- a/lisp/progmodes/grep.el
+++ b/lisp/progmodes/grep.el
@@ -1230,6 +1230,8 @@ file name to `*.gz', and sets `grep-highlight-matches' to `always'."
 	   (grep-find-template nil)
 	   (grep-find-command nil)
 	   (grep-host-defaults-alist nil)
+           ;; `zgrep' doesn't support the `--null' option.
+	   (grep-use-null-filename-separator nil)
 	   ;; Use for `grep-read-files'
 	   (grep-files-aliases '(("all" . "* .*")
 				 ("gz"  . "*.gz"))))
-- 
2.21.0


From ec435f96591eea662260a0277c7eb4387a3dd865 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sun, 4 Mar 2018 17:09:52 -0800
Subject: [PATCH 091/297] ; Spelling fixes

---
 doc/misc/cc-mode.texi   |  2 +-
 doc/misc/org.texi       |  2 +-
 doc/misc/tramp.texi     |  2 +-
 etc/ORG-NEWS            | 12 ++++++------
 lisp/filenotify.el      |  2 +-
 lisp/frame.el           |  2 +-
 lisp/org/org-element.el |  2 +-
 lisp/org/org.el         |  4 ++--
 lisp/term.el            |  4 ++--
 9 files changed, 16 insertions(+), 16 deletions(-)

diff --git a/doc/misc/cc-mode.texi b/doc/misc/cc-mode.texi
index d0d39d44e9..5a229c1cd6 100644
--- a/doc/misc/cc-mode.texi
+++ b/doc/misc/cc-mode.texi
@@ -4734,7 +4734,7 @@ Once again, line 8 is assigned as @code{brace-entry-open} as is line
 with anchor point at the @samp{@{} of line 8@footnote{This extra
 syntactic element was introduced in @ccmode{} 5.33.1 to allow extra
 flexibility in indenting the second line of such a construct.  You can
-preserve the behaviour resulting from the former syntactic analysis by
+preserve the behavior resulting from the former syntactic analysis by
 giving @code{brace-list-entry} an offset of
 @code{c-lineup-under-anchor} (@pxref{Misc Line-Up}).}, and
 @code{brace-list-entry} anchored on the @samp{1} of line 8.
diff --git a/doc/misc/org.texi b/doc/misc/org.texi
index 4434636b7f..c727cc3f8d 100644
--- a/doc/misc/org.texi
+++ b/doc/misc/org.texi
@@ -10235,7 +10235,7 @@ for display purposes only.
 @cindex dash, special symbol
 @cindex ellipsis, special symbol
 In addition to regular entities defined above, Org exports in a special
-way@footnote{This behaviour can be disabled with @code{-} export setting
+way@footnote{This behavior can be disabled with @code{-} export setting
 (@pxref{Export settings}).} the following commonly used character
 combinations: @samp{\-} is treated as a shy hyphen, @samp{--} and @samp{---}
 are converted into dashes, and @samp{...} becomes a compact set of dots.
diff --git a/doc/misc/tramp.texi b/doc/misc/tramp.texi
index f2530cd6ea..e1c4f3e980 100644
--- a/doc/misc/tramp.texi
+++ b/doc/misc/tramp.texi
@@ -3563,7 +3563,7 @@ Why is @file{~/.sh_history} file on the remote host growing?
 @vindex tramp-histfile-override
 Due to the remote shell saving tilde expansions triggered by
 @value{tramp}, the history file is probably growing rapidly.
-@value{tramp} can suppress this behaviour with the user option
+@value{tramp} can suppress this behavior with the user option
 @option{tramp-histfile-override}.  When set to @code{t}, environment
 variable @env{HISTFILE} is unset, and environment variables
 @env{HISTFILESIZE} @env{HISTSIZE} are set to 0.
diff --git a/etc/ORG-NEWS b/etc/ORG-NEWS
index 12eab44f0f..b9f3b0cdbe 100644
--- a/etc/ORG-NEWS
+++ b/etc/ORG-NEWS
@@ -1358,7 +1358,7 @@ don't have to be distinct on a heading.
 
 Grouptags had to previously be defined with { }.  This syntax is
 already used for exclusive tags and Grouptags need their own,
-non-exclusive syntax.  This behaviour is achieved with [ ].  Note: { }
+non-exclusive syntax.  This behavior is achieved with [ ].  Note: { }
 can still be used also for Grouptags but then only one of the given
 tags can be used on the headline at the same time.  Example:
 
@@ -1422,9 +1422,9 @@ Check the documentation for more details.
 
 Thanks to Jarmo Hurri for this feature.
 
-*** New behaviour for ~org-toggle-latex-fragment~
+*** New behavior for ~org-toggle-latex-fragment~
 
-The new behaviour is the following:
+The new behavior is the following:
 
 - With a double prefix argument or with a single prefix argument when
   point is before the first headline, toggle overlays in the whole
@@ -1623,10 +1623,10 @@ leading spaces within table cells.
 Org uses the MathJax CDN by default.  See the manual and the docstring
 of ~org-html-mathjax-options~ for details.
 
-*** New behaviour in `org-export-options-alist'
+*** New behavior in `org-export-options-alist'
 
 When defining a back-end, it is now possible to specify to give
-`parse' behaviour on a keyword.  It is equivalent to call
+`parse' behavior on a keyword.  It is equivalent to call
 `org-element-parse-secondary-string' on the value.
 
 However, parsed =KEYWORD= is automatically associated to an
@@ -1745,7 +1745,7 @@ everywhere in the buffer, possibly corrupting URLs.
 *** Removed option =org-babel-sh-command=
 
 This undocumented option defaulted to the value of =shell-file-name= at
-the time of loading =ob-shell=.  The new behaviour is to use the value
+the time of loading =ob-shell=.  The new behavior is to use the value
 of =shell-file-name= directly when the shell langage is =shell=.  To chose
 a different shell, either customize =shell-file-name= or bind this
 variable locally.
diff --git a/lisp/filenotify.el b/lisp/filenotify.el
index 5d37f39a70..59a8c0e88a 100644
--- a/lisp/filenotify.el
+++ b/lisp/filenotify.el
@@ -423,7 +423,7 @@ DESCRIPTOR should be an object returned by `file-notify-add-watch'."
 
 ;; TODO:
 ;; * Watching a /dir/file may receive events for dir.
-;;   (This may be the desired behaviour.)
+;;   (This may be the desired behavior.)
 ;; * Watching a file in an already watched directory
 ;;   If the file is created and *then* a watch is added to that file, the
 ;;   watch might receive events which occurred prior to it being created,
diff --git a/lisp/frame.el b/lisp/frame.el
index 0ed7d6a64f..0cf502d506 100644
--- a/lisp/frame.el
+++ b/lisp/frame.el
@@ -2439,7 +2439,7 @@ See also `toggle-frame-maximized'."
        frame `((fullscreen . fullboth) (fullscreen-restore . ,fullscreen))))
     ;; Manipulating a frame without waiting for the fullscreen
     ;; animation to complete can cause a crash, or other unexpected
-    ;; behaviour, on macOS (bug#28496).
+    ;; behavior, on macOS (bug#28496).
     (when (featurep 'cocoa) (sleep-for 0.5))))
 
 
diff --git a/lisp/org/org-element.el b/lisp/org/org-element.el
index 844349c2fc..a63aae5329 100644
--- a/lisp/org/org-element.el
+++ b/lisp/org/org-element.el
@@ -4721,7 +4721,7 @@ indentation removed from its contents."
 ;; Cache is enabled by default, but can be disabled globally with
 ;; `org-element-use-cache'.  `org-element-cache-sync-idle-time',
 ;; org-element-cache-sync-duration' and `org-element-cache-sync-break'
-;; can be tweaked to control caching behaviour.
+;; can be tweaked to control caching behavior.
 ;;
 ;; Internally, parsed elements are stored in an AVL tree,
 ;; `org-element--cache'.  This tree is updated lazily: whenever
diff --git a/lisp/org/org.el b/lisp/org/org.el
index 2f60a07505..3ec6b4eabe 100644
--- a/lisp/org/org.el
+++ b/lisp/org/org.el
@@ -10641,7 +10641,7 @@ a timestamp or a link."
 		   (save-excursion
 		     ;; Do not validate action when point is on the
 		     ;; spaces right after the footnote label, in
-		     ;; order to be on par with behaviour on links.
+		     ;; order to be on par with behavior on links.
 		     (skip-chars-forward " \t")
 		     (let ((begin
 			    (org-element-property :contents-begin context)))
@@ -10794,7 +10794,7 @@ there is one, return it."
        (cons link end)))))
 
 ;; TODO: These functions are deprecated since `org-open-at-point'
-;; hard-codes behaviour for "file+emacs" and "file+sys" types.
+;; hard-codes behavior for "file+emacs" and "file+sys" types.
 (defun org-open-file-with-system (path)
   "Open file at PATH using the system way of opening it."
   (org-open-file path 'system))
diff --git a/lisp/term.el b/lisp/term.el
index a0313d88da..cf7699abc9 100644
--- a/lisp/term.el
+++ b/lisp/term.el
@@ -487,7 +487,7 @@ inconsistent with the state of the terminal understood by the
 inferior process.  Only the process filter is allowed to make
 changes to the buffer.
 
-Customize this option to nil if you want the previous behaviour."
+Customize this option to nil if you want the previous behavior."
   :version "26.1"
   :type 'boolean
   :group 'term)
@@ -508,7 +508,7 @@ commands can be invoked on the mouse-selected point or region,
 until the process filter (or user) moves point to the process
 mark once again.
 
-Customize this option to nil if you want the previous behaviour."
+Customize this option to nil if you want the previous behavior."
   :version "26.1"
   :type 'boolean
   :group 'term)
-- 
2.21.0


From 418e8a697e4895202f7e4939e0da4cac991f2d16 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sun, 4 Mar 2018 17:38:43 -0800
Subject: [PATCH 092/297] Spelling fixes (Bug#10068)

* lisp/gnus/gnus-score.el (gnus-score-find-favorite-words):
Rename from gnus-score-find-favourite-words.
* lisp/hfy-cmap.el (hfy-fallback-color-map)
(hfy-rgb-txt-color-map, hfy-fallback-color-values):
* lisp/htmlfontify.el (hfy-color-vals, hfy-color):
Rename from names that used 'colour' instead of 'color'.
---
 doc/misc/gnus.texi      |  4 ++--
 etc/NEWS                | 10 +++++++++
 lisp/gnus/gnus-score.el |  7 ++++--
 lisp/gnus/gnus-sum.el   |  2 +-
 lisp/hfy-cmap.el        | 35 +++++++++++++++++++-----------
 lisp/htmlfontify.el     | 48 +++++++++++++++++++++--------------------
 lisp/net/tramp-adb.el   |  2 +-
 7 files changed, 66 insertions(+), 42 deletions(-)

diff --git a/doc/misc/gnus.texi b/doc/misc/gnus.texi
index 8a0b631936..cc4b2342be 100644
--- a/doc/misc/gnus.texi
+++ b/doc/misc/gnus.texi
@@ -19471,8 +19471,8 @@ score file and edit it.
 
 @item V w
 @kindex V w @r{(Summary)}
-@findex gnus-score-find-favourite-words
-List words used in scoring (@code{gnus-score-find-favourite-words}).
+@findex gnus-score-find-favorite-words
+List words used in scoring (@code{gnus-score-find-favorite-words}).
 
 @item V R
 @kindex V R @r{(Summary)}
diff --git a/etc/NEWS b/etc/NEWS
index 23bbb5e353..688d10df07 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -142,6 +142,16 @@ This can be controlled by the new `ecomplete-sort-predicate' variable.
 *** The 'ecompleterc' file is now placed in ~/.emacs.d/ecompleterc by default
 Of course it will still find it if you have it in ~/.ecompleterc
 
+** Gnus
+*** The function 'gnus-score-find-favorite-words' has been renamed
+from 'gnus-score-find-favourite-words'.
+
+** Htmlfontify
+*** The functions 'hfy-color', 'hfy-color-vals' and
+'hfy-fallback-color-values' and the variables 'hfy-fallback-color-map'
+and 'hfy-rgb-txt-color-map' have been renamed from names that used
+'colour' instead of 'color'.
+
 ** Smtpmail
 Authentication mechanisms can be added via external packages, by
 defining new cl-defmethod of smtpmail-try-auth-method.
diff --git a/lisp/gnus/gnus-score.el b/lisp/gnus/gnus-score.el
index ec07d1ab15..ad11ff4a5c 100644
--- a/lisp/gnus/gnus-score.el
+++ b/lisp/gnus/gnus-score.el
@@ -514,7 +514,7 @@ of the last successful match.")
   "f" gnus-score-edit-file
   "F" gnus-score-flush-cache
   "t" gnus-score-find-trace
-  "w" gnus-score-find-favourite-words)
+  "w" gnus-score-find-favorite-words)
 
 ;; Summary score file commands
 
@@ -2517,7 +2517,7 @@ the score file and its full name, including the directory.")
     (set-buffer gnus-summary-buffer)
     (setq gnus-newsgroup-scored old-scored)))
 
-(defun gnus-score-find-favourite-words ()
+(defun gnus-score-find-favorite-words ()
   "List words used in scoring."
   (interactive)
   (let ((alists (gnus-score-load-files (gnus-all-score-files)))
@@ -2553,6 +2553,9 @@ the score file and its full name, including the directory.")
 	(pop rules))
       (goto-char (point-min))
       (gnus-configure-windows 'score-words))))
+(define-obsolete-function-alias
+  'gnus-score-find-favourite-words
+  'gnus-score-find-favorite-words "27.1")
 
 (defun gnus-summary-rescore ()
   "Redo the entire scoring process in the current summary."
diff --git a/lisp/gnus/gnus-sum.el b/lisp/gnus/gnus-sum.el
index a28c00be94..468f2b195e 100644
--- a/lisp/gnus/gnus-sum.el
+++ b/lisp/gnus/gnus-sum.el
@@ -2370,7 +2370,7 @@ increase the score of each group you read."
 	  ["Edit current score file" gnus-score-edit-current-scores t]
 	  ["Edit score file..." gnus-score-edit-file t]
 	  ["Trace score" gnus-score-find-trace t]
-	  ["Find words" gnus-score-find-favourite-words t]
+	  ["Find words" gnus-score-find-favorite-words t]
 	  ["Rescore buffer" gnus-summary-rescore t]
 	  ["Increase score..." gnus-summary-increase-score t]
 	  ["Lower score..." gnus-summary-lower-score t]))))
diff --git a/lisp/hfy-cmap.el b/lisp/hfy-cmap.el
index 6dea345f28..4ec24cea70 100644
--- a/lisp/hfy-cmap.el
+++ b/lisp/hfy-cmap.el
@@ -1,15 +1,15 @@
-;;; hfy-cmap.el --- Fallback colour name -> rgb mapping for `htmlfontify'
+;;; hfy-cmap.el --- Fallback color name -> rgb mapping for `htmlfontify'
 
 ;; Copyright (C) 2002-2003, 2009-2018 Free Software Foundation, Inc.
 
 ;; Emacs Lisp Archive Entry
 ;; Package: htmlfontify
 ;; Filename: hfy-cmap.el
-;; Keywords: colour, rgb
+;; Keywords: color, rgb
 ;; Author: Vivek Dasmohapatra <vivek@etla.org>
 ;; Maintainer: Vivek Dasmohapatra <vivek@etla.org>
 ;; Created: 2002-01-20
-;; Description: fallback code for colour name -> rgb mapping
+;; Description: fallback code for color name -> rgb mapping
 ;; URL: http://rtfm.etla.org/emacs/htmlfontify/
 ;; Last-Updated: Sat 2003-02-15 03:49:32 +0000
 
@@ -32,7 +32,7 @@
 
 ;;; Code:
 
-(defconst hfy-fallback-colour-map
+(defconst hfy-fallback-color-map
   '(("snow"                    65535 64250 64250)
     ("ghost white"             63736 63736 65535)
     ("GhostWhite"              63736 63736 65535)
@@ -785,8 +785,14 @@
     ("DarkRed"                 35723     0     0)
     ("light green"             37008 61166 37008)
     ("LightGreen"              37008 61166 37008)) )
+(define-obsolete-variable-alias
+  'hfy-fallback-colour-map
+  'hfy-fallback-color-map "27.1")
 
-(defvar hfy-rgb-txt-colour-map nil)
+(defvar hfy-rgb-txt-color-map nil)
+(define-obsolete-variable-alias
+  'hfy-rgb-txt-colour-map
+  'hfy-rgb-txt-color-map "27.1")
 
 (defvar hfy-rgb-load-path
   (list "/etc/X11"
@@ -806,8 +812,8 @@
 (defun htmlfontify-load-rgb-file (&optional file)
   "Load an X11 style rgb.txt FILE.
 Search `hfy-rgb-load-path' if FILE is not specified.
-Loads the variable `hfy-rgb-txt-colour-map', which is used by
-`hfy-fallback-colour-values'."
+Loads the variable `hfy-rgb-txt-color-map', which is used by
+`hfy-fallback-color-values'."
   (interactive
    (list
     (read-file-name "rgb.txt (equivalent) file: " "" nil t (hfy-rgb-file))))
@@ -822,25 +828,28 @@ Loads the variable `hfy-rgb-txt-colour-map', which is used by
 	  (htmlfontify-unload-rgb-file)
 	  (while (/= end-of-rgb 1)
 	    (if (looking-at hfy-rgb-regex)
-		(setq hfy-rgb-txt-colour-map
+		(setq hfy-rgb-txt-color-map
 		      (cons (list (match-string 4)
 				  (string-to-number (match-string 1))
 				  (string-to-number (match-string 2))
 				  (string-to-number (match-string 3)))
-			    hfy-rgb-txt-colour-map)) )
+			    hfy-rgb-txt-color-map)) )
 	    (setq end-of-rgb (forward-line)))
 	  (kill-buffer rgb-buffer)))))
 
 (defun htmlfontify-unload-rgb-file ()
   "Unload the current color name -> rgb translation map."
   (interactive)
-  (setq hfy-rgb-txt-colour-map nil))
+  (setq hfy-rgb-txt-color-map nil))
 
 ;;;###autoload
-(defun hfy-fallback-colour-values (colour-string)
+(defun hfy-fallback-color-values (color-string)
   "Use a fallback method for obtaining the rgb values for a color."
-  (cdr (assoc-string colour-string (or hfy-rgb-txt-colour-map
-                                       hfy-fallback-colour-map))) )
+  (cdr (assoc-string color-string (or hfy-rgb-txt-color-map
+				      hfy-fallback-color-map))) )
+(define-obsolete-function-alias
+  'hfy-fallback-colour-values
+  'hfy-fallback-color-values "27.1")
 
 (provide 'hfy-cmap)
 
diff --git a/lisp/htmlfontify.el b/lisp/htmlfontify.el
index dfa6bde297..799da86cd4 100644
--- a/lisp/htmlfontify.el
+++ b/lisp/htmlfontify.el
@@ -584,22 +584,23 @@ therefore no longer care about) will be invalid at any time.\n
       (if (memq elt set-b) (setq interq (cons elt interq))))
     interq))
 
-(defun hfy-colour-vals (colour)
-  "Where COLOUR is a color name or #XXXXXX style triplet, return a
+(defun hfy-color-vals (color)
+  "Where COLOR is a color name or #XXXXXX style triplet, return a
 list of three (16 bit) rgb values for said color.\n
-If a window system is unavailable, calls `hfy-fallback-colour-values'."
-  (if (string-match hfy-triplet-regex colour)
+If a window system is unavailable, calls `hfy-fallback-color-values'."
+  (if (string-match hfy-triplet-regex color)
       (mapcar
-       (lambda (x) (* (string-to-number (match-string x colour) 16) 257))
+       (lambda (x) (* (string-to-number (match-string x color) 16) 257))
        '(1 2 3))
-    ;;(message ">> %s" colour)
+    ;;(message ">> %s" color)
     (if window-system
         (if (fboundp 'color-values)
-            (color-values colour)
+            (color-values color)
           ;;(message "[%S]" window-system)
-          (x-color-values colour))
+          (x-color-values color))
       ;; blarg - tty colors are no good - go fetch some X colors:
-      (hfy-fallback-colour-values colour))))
+      (hfy-fallback-color-values color))))
+(define-obsolete-function-alias 'hfy-colour-vals 'hfy-color-vals "27.1")
 
 (defvar hfy-cperl-mode-kludged-p nil)
 
@@ -738,7 +739,7 @@ FILE is the name of the file being rendered, in case it is needed."
   "Replace the end of a CSS style declaration STYLE-STRING with the contents
 of the variable `hfy-src-doc-link-style', removing text matching the regex
 `hfy-src-doc-link-unstyle' first, if necessary."
-  ;;(message "hfy-colour-vals");;DBUG
+  ;;(message "hfy-color-vals");;DBUG
   (if (string-match hfy-src-doc-link-unstyle style-string)
       (setq style-string (replace-match "" 'fixed-case 'literal style-string)))
   (if (and (not (string-match hfy-src-doc-link-style style-string))
@@ -751,19 +752,19 @@ of the variable `hfy-src-doc-link-style', removing text matching the regex
 
 ;; utility functions - cast emacs style specification values into their
 ;; css2 equivalents:
-(defun hfy-triplet (colour)
-  "Takes a COLOUR name (string) and return a CSS rgb(R, G, B) triplet string.
+(defun hfy-triplet (color)
+  "Takes a COLOR name (string) and return a CSS rgb(R, G, B) triplet string.
 Uses the definition of \"white\" to map the numbers to the 0-255 range, so
 if you've redefined white, (esp. if you've redefined it to have a triplet
 member lower than that of the color you are processing) strange things
 may happen."
-  ;;(message "hfy-colour-vals");;DBUG
+  ;;(message "hfy-color-vals");;DBUG
   ;; TODO?  Can we do somehow do better than this?
   (cond
-   ((equal colour "unspecified-fg") (setq colour "black"))
-   ((equal colour "unspecified-bg") (setq colour "white")))
-  (let ((white (mapcar (lambda (I) (float (1+ I))) (hfy-colour-vals "white")))
-        (rgb16 (mapcar (lambda (I) (float (1+ I))) (hfy-colour-vals  colour))))
+   ((equal color "unspecified-fg") (setq color "black"))
+   ((equal color "unspecified-bg") (setq color "white")))
+  (let ((white (mapcar (lambda (I) (float (1+ I))) (hfy-color-vals "white")))
+        (rgb16 (mapcar (lambda (I) (float (1+ I))) (hfy-color-vals  color))))
     (if rgb16
         ;;(apply 'format "rgb(%d, %d, %d)"
         ;; Use #rrggbb instead, it is smaller
@@ -774,8 +775,9 @@ may happen."
                        '(0 1 2))))))
 
 (defun hfy-family (family) (list (cons "font-family"  family)))
-(defun hfy-bgcol  (colour) (list (cons "background"   (hfy-triplet colour))))
-(defun hfy-colour (colour) (list (cons "color"        (hfy-triplet colour))))
+(defun hfy-bgcol  (color) (list (cons "background"   (hfy-triplet color))))
+(defun hfy-color (color) (list (cons "color"        (hfy-triplet color))))
+(define-obsolete-function-alias 'hfy-colour 'hfy-color "27.1")
 (defun hfy-width  (width)  (list (cons "font-stretch" (symbol-name  width))))
 
 (defcustom hfy-font-zoom 1.05
@@ -825,17 +827,17 @@ regular specifiers."
       (let ((tag (car  spec))
             (val (cadr spec)))
         (cons (cl-case tag
-                (:color (cons "colour" val))
+                (:color (cons "color" val))
                 (:width (cons "width"  val))
                 (:style (cons "style"  val)))
               (hfy-box-to-border-assoc (cddr spec))))))
 
 (defun hfy-box-to-style (spec)
   (let* ((css (hfy-box-to-border-assoc  spec))
-         (col (cdr      (assoc "colour" css)))
+         (col (cdr      (assoc "color" css)))
          (s   (cdr      (assoc "style"  css))))
     (list
-     (if col (cons "border-color" (cdr (assoc "colour" css))))
+     (if col (cons "border-color" (cdr (assoc "color" css))))
      (cons "border-width" (format "%dpx" (or (cdr (assoc "width" css)) 1)))
      (cons "border-style" (cl-case s
                             (released-button "outset")
@@ -1014,7 +1016,7 @@ merged by the user - `hfy-flatten-style' should do this."
                        (:width          (hfy-width     val))
                        (:weight         (hfy-weight    val))
                        (:slant          (hfy-slant     val))
-                       (:foreground     (hfy-colour    val))
+                       (:foreground     (hfy-color     val))
                        (:background     (hfy-bgcol     val))
                        (:box            (hfy-box       val))
                        (:height         (hfy-size      val))
diff --git a/lisp/net/tramp-adb.el b/lisp/net/tramp-adb.el
index 7ac61b843f..7a0ea71aee 100644
--- a/lisp/net/tramp-adb.el
+++ b/lisp/net/tramp-adb.el
@@ -464,7 +464,7 @@ pass to the OPERATION."
     (cond
      ;; Support Android derived systems where "ls" command is provided
      ;; by GNU Coreutils. Force "ls" to print one column and set
-     ;; time-style to imitate other "ls" flavours.
+     ;; time-style to imitate other "ls" flavors.
      ((tramp-adb-send-command-and-check
        vec "ls --time-style=long-iso /dev/null")
       "ls -1 --time-style=long-iso")
-- 
2.21.0


From 58e69f8f2b542531c101a63eb385323e3d7448f9 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sun, 4 Mar 2018 17:53:07 -0800
Subject: [PATCH 093/297] uniqify -> uniquify

The latter spelling is more common both within Emacs and in
English-language sources in general (Bug#10048).
* lisp/eshell/esh-util.el (eshell-uniquify-list):
Rename from eshell-uniqify-list.  All callers changed.
* lisp/pcomplete.el (pcomplete-uniquify-list):
Rename from pcomplete-uniqify-list.  All callers changed.
---
 etc/NEWS                  |  7 +++++++
 lisp/eshell/em-cmpl.el    |  2 +-
 lisp/eshell/em-dirs.el    |  4 ++--
 lisp/eshell/em-pred.el    |  2 +-
 lisp/eshell/esh-util.el   |  5 ++++-
 lisp/org/org-pcomplete.el | 20 ++++++++++----------
 lisp/pcmpl-cvs.el         |  8 ++++----
 lisp/pcmpl-gnu.el         |  2 +-
 lisp/pcmpl-linux.el       |  6 +++---
 lisp/pcmpl-rpm.el         |  2 +-
 lisp/pcmpl-unix.el        |  2 +-
 lisp/pcomplete.el         |  7 +++++--
 12 files changed, 40 insertions(+), 27 deletions(-)

diff --git a/etc/NEWS b/etc/NEWS
index 688d10df07..dc05d8abb9 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -259,6 +259,13 @@ To restore the old behavior, use
     (add-hook 'eshell-expand-input-functions
               #'eshell-expand-history-references)
 
+*** The function 'shell-uniquify-list' has been renamed from
+'eshell-uniqify-list'.
+
+** Pcomplete
+*** The function 'pcomplete-uniquify-list' has been renamed from
+'pcomplete-uniqify-list'.
+
 ** Tramp
 
 +++
diff --git a/lisp/eshell/em-cmpl.el b/lisp/eshell/em-cmpl.el
index 1f44007746..667bdeb43b 100644
--- a/lisp/eshell/em-cmpl.el
+++ b/lisp/eshell/em-cmpl.el
@@ -434,7 +434,7 @@ to writing a completion function."
 	    (setq comps-in-path (cdr comps-in-path)))
 	  (setq paths (cdr paths)))
 	;; Add aliases which are currently visible, and Lisp functions.
-	(pcomplete-uniqify-list
+	(pcomplete-uniquify-list
 	 (if glob-name
 	     completions
 	   (setq completions
diff --git a/lisp/eshell/em-dirs.el b/lisp/eshell/em-dirs.el
index 34bf821c11..ec380e6701 100644
--- a/lisp/eshell/em-dirs.el
+++ b/lisp/eshell/em-dirs.el
@@ -282,7 +282,7 @@ Thus, this does not include the current directory.")
 (defvar pcomplete-stub)
 (defvar pcomplete-last-completion-raw)
 (declare-function pcomplete-actual-arg "pcomplete")
-(declare-function pcomplete-uniqify-list "pcomplete")
+(declare-function pcomplete-uniquify-list "pcomplete")
 
 (defun eshell-complete-user-reference ()
   "If there is a user reference, complete it."
@@ -293,7 +293,7 @@ Thus, this does not include the current directory.")
       (throw 'pcomplete-completions
 	     (progn
 	       (eshell-read-user-names)
-	       (pcomplete-uniqify-list
+	       (pcomplete-uniquify-list
 		(mapcar
 		 (function
 		  (lambda (user)
diff --git a/lisp/eshell/em-pred.el b/lisp/eshell/em-pred.el
index 61af4048d5..b3b16d909b 100644
--- a/lisp/eshell/em-pred.el
+++ b/lisp/eshell/em-pred.el
@@ -131,7 +131,7 @@ The format of each entry is
     (?e . #'(lambda (lst) (mapcar 'file-name-extension lst)))
     (?t . #'(lambda (lst) (mapcar 'file-name-nondirectory lst)))
     (?q . #'(lambda (lst) (mapcar 'eshell-escape-arg lst)))
-    (?u . #'(lambda (lst) (eshell-uniqify-list lst)))
+    (?u . #'(lambda (lst) (eshell-uniquify-list lst)))
     (?o . #'(lambda (lst) (sort lst 'string-lessp)))
     (?O . #'(lambda (lst) (nreverse (sort lst 'string-lessp))))
     (?j . (eshell-join-members))
diff --git a/lisp/eshell/esh-util.el b/lisp/eshell/esh-util.el
index 5d38c27eb1..5ef1ae4129 100644
--- a/lisp/eshell/esh-util.el
+++ b/lisp/eshell/esh-util.el
@@ -295,7 +295,7 @@ Prepend remote identification of `default-directory', if any."
 	(nconc new-list (list a))))
     (cdr new-list)))
 
-(defun eshell-uniqify-list (l)
+(defun eshell-uniquify-list (l)
   "Remove occurring multiples in L.  You probably want to sort first."
   (let ((m l))
     (while m
@@ -305,6 +305,9 @@ Prepend remote identification of `default-directory', if any."
 	(setcdr m (cddr m)))
       (setq m (cdr m))))
   l)
+(define-obsolete-function-alias
+  'eshell-uniqify-list
+  'eshell-uniquify-list "27.1")
 
 (defun eshell-stringify (object)
   "Convert OBJECT into a string value."
diff --git a/lisp/org/org-pcomplete.el b/lisp/org/org-pcomplete.el
index a7cc09def4..1acb61590f 100644
--- a/lisp/org/org-pcomplete.el
+++ b/lisp/org/org-pcomplete.el
@@ -194,7 +194,7 @@ When completing for #+STARTUP, for example, this function returns
   "Complete arguments for the #+LANGUAGE file option."
   (require 'ox)
   (pcomplete-here
-   (pcomplete-uniqify-list
+   (pcomplete-uniquify-list
     (list org-export-default-language "en"))))
 
 (defvar org-default-priority)
@@ -219,7 +219,7 @@ When completing for #+STARTUP, for example, this function returns
 (defun pcomplete/org-mode/file-option/startup ()
   "Complete arguments for the #+STARTUP file option."
   (while (pcomplete-here
-	  (let ((opts (pcomplete-uniqify-list
+	  (let ((opts (pcomplete-uniquify-list
 		       (mapcar 'car org-startup-options))))
 	    ;; Some options are mutually exclusive, and shouldn't be completed
 	    ;; against if certain other options have already been seen.
@@ -248,7 +248,7 @@ When completing for #+STARTUP, for example, this function returns
 (defun pcomplete/org-mode/file-option/options ()
   "Complete arguments for the #+OPTIONS file option."
   (while (pcomplete-here
-	  (pcomplete-uniqify-list
+	  (pcomplete-uniquify-list
 	   (append
 	    ;; Hard-coded OPTION items always available.
 	    '("H:" "\\n:" "num:" "timestamp:" "arch:" "author:" "c:"
@@ -267,7 +267,7 @@ When completing for #+STARTUP, for example, this function returns
 (defun pcomplete/org-mode/file-option/infojs_opt ()
   "Complete arguments for the #+INFOJS_OPT file option."
   (while (pcomplete-here
-	  (pcomplete-uniqify-list
+	  (pcomplete-uniquify-list
 	   (mapcar (lambda (item) (format "%s:" (car item)))
 		   (bound-and-true-p org-html-infojs-opts-table))))))
 
@@ -283,7 +283,7 @@ When completing for #+STARTUP, for example, this function returns
 (defun pcomplete/org-mode/link ()
   "Complete against defined #+LINK patterns."
   (pcomplete-here
-   (pcomplete-uniqify-list
+   (pcomplete-uniquify-list
     (copy-sequence
      (append (mapcar 'car org-link-abbrev-alist-local)
 	     (mapcar 'car org-link-abbrev-alist))))))
@@ -293,13 +293,13 @@ When completing for #+STARTUP, for example, this function returns
   "Complete against TeX-style HTML entity names."
   (require 'org-entities)
   (while (pcomplete-here
-	  (pcomplete-uniqify-list (remove nil (mapcar 'car-safe org-entities)))
+	  (pcomplete-uniquify-list (remove nil (mapcar 'car-safe org-entities)))
 	  (substring pcomplete-stub 1))))
 
 (defvar org-todo-keywords-1)
 (defun pcomplete/org-mode/todo ()
   "Complete against known TODO keywords."
-  (pcomplete-here (pcomplete-uniqify-list (copy-sequence org-todo-keywords-1))))
+  (pcomplete-here (pcomplete-uniquify-list (copy-sequence org-todo-keywords-1))))
 
 (defvar org-todo-line-regexp)
 (defun pcomplete/org-mode/searchhead ()
@@ -315,14 +315,14 @@ This needs more work, to handle headings with lots of spaces in them."
 	       (push (org-make-org-heading-search-string
 		      (match-string-no-properties 3))
 		     tbl)))
-	   (pcomplete-uniqify-list tbl)))
+	   (pcomplete-uniquify-list tbl)))
        (substring pcomplete-stub 1))))
 
 (defun pcomplete/org-mode/tag ()
   "Complete a tag name.  Omit tags already set."
   (while (pcomplete-here
 	  (mapcar (lambda (x) (concat x ":"))
-		  (let ((lst (pcomplete-uniqify-list
+		  (let ((lst (pcomplete-uniquify-list
 			      (or (remq
 				   nil
 				   (mapcar (lambda (x) (org-string-nw-p (car x)))
@@ -339,7 +339,7 @@ This needs more work, to handle headings with lots of spaces in them."
   (pcomplete-here
    (mapcar (lambda (x)
 	     (concat x ": "))
-	   (let ((lst (pcomplete-uniqify-list
+	   (let ((lst (pcomplete-uniquify-list
 		       (copy-sequence
 			(org-buffer-property-keys nil t t t)))))
 	     (dolist (prop (org-entry-properties))
diff --git a/lisp/pcmpl-cvs.el b/lisp/pcmpl-cvs.el
index a3e2b2f5b3..dedc007223 100644
--- a/lisp/pcmpl-cvs.el
+++ b/lisp/pcmpl-cvs.el
@@ -122,7 +122,7 @@
     (let (cmds)
       (while (re-search-forward "^\\s-+\\([a-z]+\\)" nil t)
 	(setq cmds (cons (match-string 1) cmds)))
-      (pcomplete-uniqify-list cmds))))
+      (pcomplete-uniquify-list cmds))))
 
 (defun pcmpl-cvs-modules ()
   "Return a list of available modules under CVS."
@@ -132,7 +132,7 @@
     (let (entries)
       (while (re-search-forward "\\(\\S-+\\)$" nil t)
 	(setq entries (cons (match-string 1) entries)))
-      (pcomplete-uniqify-list entries))))
+      (pcomplete-uniquify-list entries))))
 
 (defun pcmpl-cvs-tags (&optional opers)
   "Return all the tags which could apply to the files related to OPERS."
@@ -149,7 +149,7 @@
 	    (error "Error in output from `cvs status -v'"))
 	  (setq tags (cons (match-string 1) tags))
 	  (forward-line))))
-    (pcomplete-uniqify-list tags)))
+    (pcomplete-uniquify-list tags)))
 
 (defun pcmpl-cvs-entries (&optional opers)
   "Return the Entries for the current directory.
@@ -187,6 +187,6 @@ operation character applies, as displayed by `cvs -n update'."
                 (setq entries (cons text entries))))
             (forward-line)))))
     (setq pcomplete-stub nondir)
-    (pcomplete-uniqify-list entries)))
+    (pcomplete-uniquify-list entries)))
 
 ;;; pcmpl-cvs.el ends here
diff --git a/lisp/pcmpl-gnu.el b/lisp/pcmpl-gnu.el
index 505d10c164..16c992662d 100644
--- a/lisp/pcmpl-gnu.el
+++ b/lisp/pcmpl-gnu.el
@@ -125,7 +125,7 @@
 	(while (re-search-forward
 		(concat "^\\s-*\\([^\n#%.$][^:=\n]*\\)\\s-*:[^=]") nil t)
 	  (setq rules (append (split-string (match-string 1)) rules))))
-      (pcomplete-uniqify-list rules))))
+      (pcomplete-uniquify-list rules))))
 
 (defcustom pcmpl-gnu-tarfile-regexp
   "\\.t\\(ar\\(\\.\\(gz\\|bz2\\|Z\\|xz\\)\\)?\\|gz\\|a[zZ]\\|z2\\)\\'"
diff --git a/lisp/pcmpl-linux.el b/lisp/pcmpl-linux.el
index ce42486fda..18cc647aac 100644
--- a/lisp/pcmpl-linux.el
+++ b/lisp/pcmpl-linux.el
@@ -43,7 +43,7 @@
   "Completion for GNU/Linux `kill', using /proc filesystem."
   (if (pcomplete-match "^-\\(.*\\)" 0)
       (pcomplete-here
-       (pcomplete-uniqify-list
+       (pcomplete-uniquify-list
 	(split-string
 	 (pcomplete-process-result "kill" "-l")))
        (pcomplete-match-string 1 0)))
@@ -82,7 +82,7 @@
 		 (args (split-string line " ")))
 	    (setq points (cons (nth 1 args) points)))
 	  (forward-line)))
-      (pcomplete-uniqify-list points))))
+      (pcomplete-uniquify-list points))))
 
 (defun pcomplete-pare-list (l r)
   "Destructively remove from list L all elements matching any in list R.
@@ -109,7 +109,7 @@ Test is done using `equal'."
 	    (setq points (cons (nth 1 args) points)))
 	  (forward-line)))
       (pcomplete-pare-list
-       (pcomplete-uniqify-list points)
+       (pcomplete-uniquify-list points)
        (cons "swap" (pcmpl-linux-mounted-directories))))))
 
 ;;; pcmpl-linux.el ends here
diff --git a/lisp/pcmpl-rpm.el b/lisp/pcmpl-rpm.el
index d3250babe6..624547ecd4 100644
--- a/lisp/pcmpl-rpm.el
+++ b/lisp/pcmpl-rpm.el
@@ -96,7 +96,7 @@
 		    (pcomplete-process-result
 		     "rpm" "-q" (car pkgs) flag)))
       (setq pkgs (cdr pkgs)))
-    (pcomplete-uniqify-list (cdr provs))))
+    (pcomplete-uniquifyxo-list (cdr provs))))
 
 (defsubst pcmpl-rpm-files ()
   (pcomplete-dirs-or-entries "\\.rpm\\'"))
diff --git a/lisp/pcmpl-unix.el b/lisp/pcmpl-unix.el
index 90dde26599..1b11afd36b 100644
--- a/lisp/pcmpl-unix.el
+++ b/lisp/pcmpl-unix.el
@@ -111,7 +111,7 @@ documentation), this function returns nil."
 						(point))) ":")))
 	    (setq names (cons (nth 0 fields) names)))
 	  (forward-line))))
-    (pcomplete-uniqify-list names)))
+    (pcomplete-uniquify-list names)))
 
 (defsubst pcmpl-unix-group-names ()
   "Read the contents of /etc/group for group names."
diff --git a/lisp/pcomplete.el b/lisp/pcomplete.el
index 6078dfd744..e7d12c6341 100644
--- a/lisp/pcomplete.el
+++ b/lisp/pcomplete.el
@@ -950,7 +950,7 @@ Arguments NO-GANGING and ARGS-FOLLOW are currently ignored."
 		(function
 		 (lambda (opt)
 		   (concat "-" opt)))
-		(pcomplete-uniqify-list choices))))
+		(pcomplete-uniquify-list choices))))
     (let ((arg (pcomplete-arg)))
       (when (and (> (length arg) 1)
 		 (stringp arg)
@@ -1269,7 +1269,7 @@ If specific documentation can't be given, be generic."
 
 ;; general utilities
 
-(defun pcomplete-uniqify-list (l)
+(defun pcomplete-uniquify-list (l)
   "Sort and remove multiples in L."
   (setq l (sort l 'string-lessp))
   (let ((m l))
@@ -1280,6 +1280,9 @@ If specific documentation can't be given, be generic."
 	(setcdr m (cddr m)))
       (setq m (cdr m))))
   l)
+(define-obsolete-function-alias
+  'pcomplete-uniqify-list
+  'pcomplete-uniquify-list "27.1")
 
 (defun pcomplete-process-result (cmd &rest args)
   "Call CMD using `call-process' and return the simplest result."
-- 
2.21.0


From 1987cf01d82b0395d4233045711716d6a9085a7e Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 5 Mar 2018 08:57:21 -0800
Subject: [PATCH 094/297] * lisp/pcmpl-rpm.el (pcmpl-rpm-all-query): Fix typo
 in previous.

---
 lisp/pcmpl-rpm.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lisp/pcmpl-rpm.el b/lisp/pcmpl-rpm.el
index 624547ecd4..74ddb8b9d7 100644
--- a/lisp/pcmpl-rpm.el
+++ b/lisp/pcmpl-rpm.el
@@ -96,7 +96,7 @@
 		    (pcomplete-process-result
 		     "rpm" "-q" (car pkgs) flag)))
       (setq pkgs (cdr pkgs)))
-    (pcomplete-uniquifyxo-list (cdr provs))))
+    (pcomplete-uniquify-list (cdr provs))))
 
 (defsubst pcmpl-rpm-files ()
   (pcomplete-dirs-or-entries "\\.rpm\\'"))
-- 
2.21.0


From 7425521aedf0ac11713693875fa7435c4d0c6916 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 5 Mar 2018 13:36:05 -0500
Subject: [PATCH 095/297] ; Add fixme comments re password caching

---
 lisp/gnus/mml-sec.el | 1 +
 lisp/gnus/smime.el   | 1 +
 lisp/net/tramp.el    | 1 +
 3 files changed, 3 insertions(+)

diff --git a/lisp/gnus/mml-sec.el b/lisp/gnus/mml-sec.el
index 3855d7b796..dc10763da8 100644
--- a/lisp/gnus/mml-sec.el
+++ b/lisp/gnus/mml-sec.el
@@ -647,6 +647,7 @@ The passphrase is read and cached."
       (when passphrase
 	(let ((password-cache-expiry (mml-secure-cache-expiry-interval
 				      (epg-context-protocol context))))
+	  ;; FIXME test passphrase works before caching it.
 	  (password-cache-add password-cache-key-id passphrase))
 	(mml-secure-add-secret-key-id password-cache-key-id)
 	(copy-sequence passphrase)))))
diff --git a/lisp/gnus/smime.el b/lisp/gnus/smime.el
index d55cea724f..ab2a5b0f81 100644
--- a/lisp/gnus/smime.el
+++ b/lisp/gnus/smime.el
@@ -238,6 +238,7 @@ password under `cache-key'."
 	  "Passphrase for secret key (RET for no passphrase): " cache-key)))
     (if (string= passphrase "")
 	nil
+      ;; FIXME test passphrase works before caching it.
       (and passphrase cache-key (password-cache-add cache-key passphrase))
       passphrase)))
 
diff --git a/lisp/net/tramp.el b/lisp/net/tramp.el
index 6011239253..fe9f197694 100644
--- a/lisp/net/tramp.el
+++ b/lisp/net/tramp.el
@@ -4459,6 +4459,7 @@ Invokes `password-read' if available, `read-passwd' else."
 					  auth-passwd))))
 	       ;; Try the password cache.
 	       (let ((password (password-read pw-prompt key)))
+		 ;; FIXME test password works before caching it.
 		 (password-cache-add key password)
 		 password)
 	       ;; Else, get the password interactively.
-- 
2.21.0


From 20c00bae96b7410e0da9732fb20c536c3160dd3d Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 5 Mar 2018 14:26:50 -0500
Subject: [PATCH 096/297] Suppress some compiler warnings about pcomplete

* lisp/erc/erc-dcc.el, lisp/eshell/em-xtra.el:
Load pcomplete at run-time too, to silence compiler.
---
 lisp/erc/erc-dcc.el    | 4 +++-
 lisp/eshell/em-xtra.el | 6 ++++--
 2 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/lisp/erc/erc-dcc.el b/lisp/erc/erc-dcc.el
index 764c6cc617..5bc8c2f38b 100644
--- a/lisp/erc/erc-dcc.el
+++ b/lisp/erc/erc-dcc.el
@@ -54,7 +54,9 @@
 ;;; Code:
 
 (require 'erc)
-(eval-when-compile (require 'pcomplete))
+;; Strictly speaking, should only be needed at compile time.
+;; Require at run-time too to silence compiler.
+(require 'pcomplete)
 
 ;;;###autoload(autoload 'erc-dcc-mode "erc-dcc")
 (define-erc-module dcc nil
diff --git a/lisp/eshell/em-xtra.el b/lisp/eshell/em-xtra.el
index ce73474fb7..cc84d19854 100644
--- a/lisp/eshell/em-xtra.el
+++ b/lisp/eshell/em-xtra.el
@@ -25,8 +25,10 @@
 
 (require 'esh-util)
 (eval-when-compile
-  (require 'eshell)
-  (require 'pcomplete))
+  (require 'eshell))
+;; Strictly speaking, should only be needed at compile time.
+;; Require at run-time too to silence compiler.
+(require 'pcomplete)
 (require 'compile)
 
 ;; There are no items in this custom group, but eshell modules (ab)use
-- 
2.21.0


From 5b61aafd6e352225623d4e4a704a91d759cef6fb Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 5 Mar 2018 14:29:40 -0500
Subject: [PATCH 097/297] Suppress some unused lexical variable warnings in
 eshell

* lisp/eshell/em-tramp.el (eshell/sudo):
* lisp/eshell/em-unix.el (eshell/time):
* lisp/eshell/esh-var.el (eshell/env):
Pretend to use "args" to quieten compiler.
---
 lisp/eshell/em-tramp.el | 1 +
 lisp/eshell/em-unix.el  | 1 +
 lisp/eshell/esh-opt.el  | 1 +
 lisp/eshell/esh-var.el  | 3 +++
 4 files changed, 6 insertions(+)

diff --git a/lisp/eshell/em-tramp.el b/lisp/eshell/em-tramp.el
index 004c495490..9a72f781fc 100644
--- a/lisp/eshell/em-tramp.el
+++ b/lisp/eshell/em-tramp.el
@@ -109,6 +109,7 @@ Uses the system sudo through TRAMP's sudo method."
        :show-usage
        :usage "[(-u | --user) USER] COMMAND
 Execute a COMMAND as the superuser or another USER.")
+     args                 ; suppress "unused lexical variable" warning
      (throw 'eshell-external
 	    (let ((user (or user "root"))
 		  (host (or (file-remote-p default-directory 'host)
diff --git a/lisp/eshell/em-unix.el b/lisp/eshell/em-unix.el
index a18fb85507..04c517f82a 100644
--- a/lisp/eshell/em-unix.el
+++ b/lisp/eshell/em-unix.el
@@ -956,6 +956,7 @@ Summarize disk usage of each FILE, recursively for directories.")
        :show-usage
        :usage "COMMAND...
 Show wall-clock time elapsed during execution of COMMAND.")
+     args                 ; suppress "unused lexical variable" warning
      (setq eshell-time-start (float-time))
      (add-hook 'eshell-post-command-hook 'eshell-show-elapsed-time nil t)
      ;; after setting
diff --git a/lisp/eshell/esh-opt.el b/lisp/eshell/esh-opt.el
index 3af8fd7cac..18852ce534 100644
--- a/lisp/eshell/esh-opt.el
+++ b/lisp/eshell/esh-opt.el
@@ -111,6 +111,7 @@ interned variable `args' (created using a `let' form)."
                                ;; `options' is of the form (quote OPTS).
                                (cadr options))))
           (args processed-args))
+     ;; Unused lexical variable warning if body does not use `args'.
      ,@body-forms))
 
 ;;; Internal Functions:
diff --git a/lisp/eshell/esh-var.el b/lisp/eshell/esh-var.el
index 1af03d367c..d400e0a9be 100644
--- a/lisp/eshell/esh-var.el
+++ b/lisp/eshell/esh-var.el
@@ -343,6 +343,8 @@ This function is explicit for adding to `eshell-parse-argument-hook'."
 					       obarray 'boundp))
 	      (pcomplete-here))))
 
+;; FIXME the real "env" command does more than this, it runs a program
+;; in a modified environment.
 (defun eshell/env (&rest args)
   "Implementation of `env' in Lisp."
   (eshell-init-print-buffer)
@@ -351,6 +353,7 @@ This function is explicit for adding to `eshell-parse-argument-hook'."
    '((?h "help" nil nil "show this usage screen")
      :external "env"
      :usage "<no arguments>")
+   args                   ; suppress "unused lexical variable" warning
    (dolist (setting (sort (eshell-environment-variables) 'string-lessp))
      (eshell-buffered-print setting "\n"))
    (eshell-flush)))
-- 
2.21.0


From 95f5bd24247012d79ed984ec347a06c704399269 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 5 Mar 2018 14:32:20 -0500
Subject: [PATCH 098/297] * lisp/emacs-lisp/ewoc.el (ewoc-goto-node): Simplify
 and quieten compiler.

---
 lisp/emacs-lisp/ewoc.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lisp/emacs-lisp/ewoc.el b/lisp/emacs-lisp/ewoc.el
index 262d4d8594..52d8451f4b 100644
--- a/lisp/emacs-lisp/ewoc.el
+++ b/lisp/emacs-lisp/ewoc.el
@@ -500,7 +500,7 @@ Return the node (or nil if we just passed the last node)."
 
 (defun ewoc-goto-node (ewoc node)
   "Move point to NODE in EWOC."
-  (ewoc--set-buffer-bind-dll ewoc
+  (with-current-buffer (ewoc--buffer ewoc)
     (goto-char (ewoc--node-start-marker node))
     (if goal-column (move-to-column goal-column))
     (setf (ewoc--last-node ewoc) node)))
-- 
2.21.0


From cc649d2beb1458b009a41ab175e6dd5dfd65c1ff Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 5 Mar 2018 15:29:15 -0500
Subject: [PATCH 099/297] Small auth-source-netrc-create fix

* lisp/auth-source.el (auth-source-netrc-create):
Fix handling of auth-source-netrc-use-gpg-tokens being a list.
---
 lisp/auth-source.el | 4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

diff --git a/lisp/auth-source.el b/lisp/auth-source.el
index 8ef5f7140a..66e1897b87 100644
--- a/lisp/auth-source.el
+++ b/lisp/auth-source.el
@@ -1315,9 +1315,7 @@ See `auth-source-search' for details on SPEC."
                                                    (string-match (car item) file))
                                            (setq ret (cdr item))
                                            (setq check nil)))
-                                       ;; FIXME: `ret' unused.
-                                       ;; Should we return it here?
-                                       ))
+                                       ret))
                                     (t 'never)))
                                   (plain (or (eval default) (read-passwd prompt))))
                              ;; ask if we don't know what to do (in which case
-- 
2.21.0


From b582d44e01b6f4b4f8f2483776524f0069181550 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 5 Mar 2018 15:46:48 -0500
Subject: [PATCH 100/297] ; * lisp/minibuffer.el
 (completion-pcm--optimize-pattern): Comment.

---
 lisp/minibuffer.el | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/lisp/minibuffer.el b/lisp/minibuffer.el
index e3ae2912a8..9b6f043b57 100644
--- a/lisp/minibuffer.el
+++ b/lisp/minibuffer.el
@@ -2951,6 +2951,8 @@ or a symbol, see `completion-pcm--merge-completions'."
         (`(,(and s1 (pred stringp)) ,(and s2 (pred stringp)) . ,rest)
          (setq p (cons (concat s1 s2) rest)))
         (`(,(and p1 (pred symbolp)) ,(and p2 (guard (eq p1 p2))) . ,_)
+         ;; Unused lexical variable warning due to body not using p1, p2.
+         ;; https://debbugs.gnu.org/16771
          (setq p (cdr p)))
         (`(star ,(pred symbolp) . ,rest) (setq p `(star . ,rest)))
         (`(,(pred symbolp) star . ,rest) (setq p `(star . ,rest)))
-- 
2.21.0


From 1ab1252ba6bc887433282e7f032f2d0dca2472c8 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 5 Mar 2018 15:58:57 -0500
Subject: [PATCH 101/297] Suppress some font-lock-fontify-buffer compiler
 warnings

* lisp/htmlfontify.el (hfy-force-fontification):
* lisp/progmodes/idlw-help.el (idlwave-help-fontify):
Suppress compiler warning from backwards compatibility branch.
---
 lisp/htmlfontify.el         | 5 +++--
 lisp/progmodes/idlw-help.el | 5 +++--
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/lisp/htmlfontify.el b/lisp/htmlfontify.el
index 799da86cd4..23efcd1298 100644
--- a/lisp/htmlfontify.el
+++ b/lisp/htmlfontify.el
@@ -1830,10 +1830,11 @@ fontified.  This is a simple convenience wrapper around
    (noninteractive
     (message "hfy batch mode (%s:%S)"
              (or (buffer-file-name) (buffer-name)) major-mode)
-    (if (fboundp 'font-lock-ensure)
+    (if (fboundp 'font-lock-ensure)     ; Emacs >= 25.1
         (font-lock-ensure)
       (when font-lock-defaults
-        (font-lock-fontify-buffer))))
+        ; Silence "interactive use only" warning on Emacs >= 25.1.
+        (with-no-warnings (font-lock-fontify-buffer)))))
    ((fboundp #'jit-lock-fontify-now)
     (message "hfy jit-lock mode (%S %S)" window-system major-mode)
     (jit-lock-fontify-now))
diff --git a/lisp/progmodes/idlw-help.el b/lisp/progmodes/idlw-help.el
index cbdca015e9..54e740be11 100644
--- a/lisp/progmodes/idlw-help.el
+++ b/lisp/progmodes/idlw-help.el
@@ -1181,9 +1181,10 @@ Useful when source code is displayed as help.  See the option
 	(with-syntax-table idlwave-mode-syntax-table
           (set (make-local-variable 'font-lock-defaults)
                idlwave-font-lock-defaults)
-          (if (fboundp 'font-lock-ensure)
+          (if (fboundp 'font-lock-ensure) ; Emacs >= 25.1
               (font-lock-ensure)
-            (font-lock-fontify-buffer))))))
+            ;; Silence "interactive use only" warning on Emacs >= 25.1.
+            (with-no-warnings (font-lock-fontify-buffer)))))))
 
 
 (defun idlwave-help-error (name type class keyword)
-- 
2.21.0


From ffa27e032e21ac5ca75cfee4ab4bb9e6de426a0b Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Tue, 6 Mar 2018 15:10:49 -0500
Subject: [PATCH 102/297] Condition em-cmpl's setting of pcomplete-suffix-list

* lisp/eshell/em-cmpl.el (eshell-cmpl-initialize):
Only set pcomplete-suffix-list if it is defined.
---
 lisp/eshell/em-cmpl.el | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/lisp/eshell/em-cmpl.el b/lisp/eshell/em-cmpl.el
index 667bdeb43b..fe34d9546a 100644
--- a/lisp/eshell/em-cmpl.el
+++ b/lisp/eshell/em-cmpl.el
@@ -259,8 +259,9 @@ to writing a completion function."
        eshell-cmpl-ignore-case)
   (set (make-local-variable 'pcomplete-autolist)
        eshell-cmpl-autolist)
-  (set (make-local-variable 'pcomplete-suffix-list)
-       eshell-cmpl-suffix-list)
+  (if (boundp 'pcomplete-suffix-list)
+      (set (make-local-variable 'pcomplete-suffix-list)
+           eshell-cmpl-suffix-list))
   (set (make-local-variable 'pcomplete-recexact)
        eshell-cmpl-recexact)
   (set (make-local-variable 'pcomplete-man-function)
-- 
2.21.0


From 82173743083b5db72e610c7d21bda35ebe1ad5f4 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Wed, 7 Mar 2018 20:40:44 +0200
Subject: [PATCH 103/297] Fix display of TABs in hscrolled windows with line
 numbers

* src/dispextern.h (struct it): New members tab_offset and
line_number_produced_p.
* src/xdisp.c (display_line): Don't set row->x to a negative value
if line numbers are being displayed.  (Bug#30582)
Reset the line_number_produced_p flag before laying out the glyph
row.
(x_produce_glyphs): Use the line_number_produced_p flag to decide
whether to offset the X coordinate due to line-number display.
Use the tab_offset member to restore the original TAB width for
alignment purposes.
(move_it_in_display_line_to): Don't produce line numbers when moving
in hscrolled window to the left of first_visible_x.
(maybe_produce_line_number): Set the line_number_produced_p flag.
(Bug#30584)
* src/term.c (produce_glyphs): Correct TAB width only when
line_number_produced_p flag is set.
---
 src/dispextern.h | 10 ++++++++++
 src/term.c       |  4 ++--
 src/xdisp.c      | 51 +++++++++++++++++++++++++++++++++++++++---------
 3 files changed, 54 insertions(+), 11 deletions(-)

diff --git a/src/dispextern.h b/src/dispextern.h
index 1fea9dc833..e26947554d 100644
--- a/src/dispextern.h
+++ b/src/dispextern.h
@@ -2426,6 +2426,10 @@ struct it
      descent/ascent (line-height property).  Reset after this glyph.  */
   bool_bf constrain_row_ascent_descent_p : 1;
 
+  /* If true, glyphs for line number display were already produced for
+     the current row.  */
+  bool_bf line_number_produced_p : 1;
+
   enum line_wrap_method line_wrap;
 
   /* The ID of the default face to use.  One of DEFAULT_FACE_ID,
@@ -2605,6 +2609,12 @@ struct it
   /* The line number of point's line, or zero if not computed yet.  */
   ptrdiff_t pt_lnum;
 
+  /* Number of pixels to offset tab stops due to width fixup of the
+     first glyph that crosses first_visible_x.  This is only needed on
+     GUI frames, only when display-line-numbers is in effect, and only
+     in hscrolled windows.  */
+  int tab_offset;
+
   /* Left fringe bitmap number (enum fringe_bitmap_type).  */
   unsigned left_user_fringe_bitmap : FRINGE_ID_BITS;
 
diff --git a/src/term.c b/src/term.c
index 03310d2c81..cf8484ee7c 100644
--- a/src/term.c
+++ b/src/term.c
@@ -1593,13 +1593,13 @@ produce_glyphs (struct it *it)
 			+ it->continuation_lines_width);
       int x0 = absolute_x;
       /* Adjust for line numbers.  */
-      if (!NILP (Vdisplay_line_numbers))
+      if (!NILP (Vdisplay_line_numbers) && it->line_number_produced_p)
 	absolute_x -= it->lnum_pixel_width;
       int next_tab_x
 	= (((1 + absolute_x + it->tab_width - 1)
 	    / it->tab_width)
 	   * it->tab_width);
-      if (!NILP (Vdisplay_line_numbers))
+      if (!NILP (Vdisplay_line_numbers) && it->line_number_produced_p)
 	next_tab_x += it->lnum_pixel_width;
       int nspaces;
 
diff --git a/src/xdisp.c b/src/xdisp.c
index 747545d7ef..9f4386c09c 100644
--- a/src/xdisp.c
+++ b/src/xdisp.c
@@ -8716,8 +8716,12 @@ move_it_in_display_line_to (struct it *it,
 
   if (it->hpos == 0)
     {
-      /* If line numbers are being displayed, produce a line number.  */
-      if (should_produce_line_number (it))
+      /* If line numbers are being displayed, produce a line number.
+	 But don't do that if we are to reach first_visible_x, because
+	 line numbers are not relevant to stuff that is not visible on
+	 display.  */
+      if (!((op && MOVE_TO_X) && to_x == it->first_visible_x)
+	  && should_produce_line_number (it))
 	{
 	  if (it->current_x == it->first_visible_x)
 	    maybe_produce_line_number (it);
@@ -21173,6 +21177,8 @@ maybe_produce_line_number (struct it *it)
       it->max_phys_descent = max (it->max_phys_descent, tem_it.max_phys_descent);
     }
 
+  it->line_number_produced_p = true;
+
   bidi_unshelve_cache (itdata, false);
 }
 
@@ -21290,6 +21296,8 @@ display_line (struct it *it, int cursor_vpos)
   row->displays_text_p = true;
   row->starts_in_middle_of_char_p = it->starts_in_middle_of_char_p;
   it->starts_in_middle_of_char_p = false;
+  it->tab_offset = 0;
+  it->line_number_produced_p = false;
 
   /* Arrange the overlays nicely for our purposes.  Usually, we call
      display_line on only one line at a time, in which case this
@@ -21334,6 +21342,10 @@ display_line (struct it *it, int cursor_vpos)
 	      || move_result == MOVE_POS_MATCH_OR_ZV))
 	it->current_x = it->first_visible_x;
 
+      /* In case move_it_in_display_line_to above "produced" the line
+	 number.  */
+      it->line_number_produced_p = false;
+
       /* Record the smallest positions seen while we moved over
 	 display elements that are not visible.  This is needed by
 	 redisplay_internal for optimizing the case where the cursor
@@ -21553,6 +21565,10 @@ display_line (struct it *it, int cursor_vpos)
 	  row->extra_line_spacing = max (row->extra_line_spacing,
 					 it->max_extra_line_spacing);
 	  if (it->current_x - it->pixel_width < it->first_visible_x
+	      /* When line numbers are displayed, row->x should not be
+		 offset, as the first glyph after the line number can
+		 never be partially visible.  */
+	      && !line_number_needed
 	      /* In R2L rows, we arrange in extend_face_to_end_of_line
 		 to add a right offset to the line, by a suitable
 		 change to the stretch glyph that is the leftmost
@@ -21794,7 +21810,8 @@ display_line (struct it *it, int cursor_vpos)
 		  if (it->bidi_p)
 		    RECORD_MAX_MIN_POS (it);
 
-		  if (x < it->first_visible_x && !row->reversed_p)
+		  if (x < it->first_visible_x && !row->reversed_p
+		      && !line_number_needed)
 		    /* Glyph is partially visible, i.e. row starts at
 		       negative X position.  Don't do that in R2L
 		       rows, where we arrange to add a right offset to
@@ -21810,6 +21827,7 @@ display_line (struct it *it, int cursor_vpos)
 		     be taken care of in produce_special_glyphs.  */
 		  if (row->reversed_p
 		      && new_x > it->last_visible_x
+		      && !line_number_needed
 		      && !(it->line_wrap == TRUNCATE
 			   && WINDOW_LEFT_FRINGE_WIDTH (it->w) == 0))
 		    {
@@ -28270,8 +28288,14 @@ x_produce_glyphs (struct it *it)
 	      int x = it->current_x + it->continuation_lines_width;
 	      int x0 = x;
 	      /* Adjust for line numbers, if needed.   */
-	      if (!NILP (Vdisplay_line_numbers) && x0 >= it->lnum_pixel_width)
-		x -= it->lnum_pixel_width;
+	      if (!NILP (Vdisplay_line_numbers) && it->line_number_produced_p)
+		{
+		  x -= it->lnum_pixel_width;
+		  /* Restore the original TAB width, if required.  */
+		  if (x + it->tab_offset >= it->first_visible_x)
+		    x += it->tab_offset;
+		}
+
 	      int next_tab_x = ((1 + x + tab_width - 1) / tab_width) * tab_width;
 
 	      /* If the distance from the current position to the next tab
@@ -28279,10 +28303,19 @@ x_produce_glyphs (struct it *it)
 		 tab stop after that.  */
 	      if (next_tab_x - x < font->space_width)
 		next_tab_x += tab_width;
-	      if (!NILP (Vdisplay_line_numbers) && x0 >= it->lnum_pixel_width)
-		next_tab_x += (it->lnum_pixel_width
-			       - ((it->w->hscroll * font->space_width)
-				  % tab_width));
+	      if (!NILP (Vdisplay_line_numbers) && it->line_number_produced_p)
+		{
+		  next_tab_x += it->lnum_pixel_width;
+		  /* If the line is hscrolled, and the TAB starts before
+		     the first visible pixel, simulate negative row->x.  */
+		  if (x < it->first_visible_x)
+		    {
+		      next_tab_x -= it->first_visible_x - x;
+		      it->tab_offset = it->first_visible_x - x;
+		    }
+		  else
+		    next_tab_x -= it->tab_offset;
+		}
 
 	      it->pixel_width = next_tab_x - x0;
 	      it->nglyphs = 1;
-- 
2.21.0


From 3f3f994bded9382ca3f4ef87c1c85bb6a6ab9f94 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Wed, 7 Mar 2018 17:55:44 -0800
Subject: [PATCH 104/297] Update from Gnulib

This includes:
2018-03-07 maint: write-file-hooks -> before-save-hook
2018-03-05 binary-io: pacify gcc -Wunused-parameter
2018-03-05 fflush: adjust to glibc 2.28 libio.h removal
* build-aux/config.guess, build-aux/config.sub:
* build-aux/gitlog-to-changelog, build-aux/install-sh:
* build-aux/move-if-change, build-aux/update-copyright:
* doc/misc/texinfo.tex, lib/binary-io.h, lib/fpending.c:
* lib/stdio-impl.h: Copy from Gnulib.
---
 build-aux/config.guess     | 10 +++-------
 build-aux/config.sub       |  6 +++---
 build-aux/install-sh       |  4 ++--
 build-aux/move-if-change   |  4 ++--
 build-aux/update-copyright |  4 ++--
 doc/misc/texinfo.tex       |  4 ++--
 lib/binary-io.h            |  6 ++----
 lib/fpending.c             |  2 +-
 lib/stdio-impl.h           |  6 ++++++
 9 files changed, 23 insertions(+), 23 deletions(-)

diff --git a/build-aux/config.guess b/build-aux/config.guess
index f50dcdb6de..256083a70d 100755
--- a/build-aux/config.guess
+++ b/build-aux/config.guess
@@ -2,7 +2,7 @@
 # Attempt to guess a canonical system name.
 #   Copyright 1992-2018 Free Software Foundation, Inc.
 
-timestamp='2018-02-24'
+timestamp='2018-03-08'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -1046,11 +1046,7 @@ EOF
 	echo "$UNAME_MACHINE"-dec-linux-"$LIBC"
 	exit ;;
     x86_64:Linux:*:*)
-	if objdump -f /bin/sh | grep -q elf32-x86-64; then
-	    echo "$UNAME_MACHINE"-pc-linux-"$LIBC"x32
-	else
-	    echo "$UNAME_MACHINE"-pc-linux-"$LIBC"
-	fi
+	echo "$UNAME_MACHINE"-pc-linux-"$LIBC"
 	exit ;;
     xtensa*:Linux:*:*)
 	echo "$UNAME_MACHINE"-unknown-linux-"$LIBC"
@@ -1473,7 +1469,7 @@ EOF
 exit 1
 
 # Local variables:
-# eval: (add-hook 'write-file-functions 'time-stamp)
+# eval: (add-hook 'before-save-hook 'time-stamp)
 # time-stamp-start: "timestamp='"
 # time-stamp-format: "%:y-%02m-%02d"
 # time-stamp-end: "'"
diff --git a/build-aux/config.sub b/build-aux/config.sub
index 1d8e98bcee..9ccf09a7a3 100755
--- a/build-aux/config.sub
+++ b/build-aux/config.sub
@@ -2,7 +2,7 @@
 # Configuration validation subroutine script.
 #   Copyright 1992-2018 Free Software Foundation, Inc.
 
-timestamp='2018-02-22'
+timestamp='2018-03-08'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -1376,7 +1376,7 @@ case $os in
 	      | -ekkobsd* | -kfreebsd* | -freebsd* | -riscix* | -lynxos* \
 	      | -bosx* | -nextstep* | -cxux* | -aout* | -elf* | -oabi* \
 	      | -ptx* | -coff* | -ecoff* | -winnt* | -domain* | -vsta* \
-	      | -udi* | -eabi* | -lites* | -ieee* | -go32* | -aux* \
+	      | -udi* | -eabi* | -lites* | -ieee* | -go32* | -aux* | -hcos* \
 	      | -chorusos* | -chorusrdb* | -cegcc* | -glidix* \
 	      | -cygwin* | -msys* | -pe* | -psos* | -moss* | -proelf* | -rtems* \
 	      | -midipix* | -mingw32* | -mingw64* | -linux-gnu* | -linux-android* \
@@ -1794,7 +1794,7 @@ echo "$basic_machine$os"
 exit
 
 # Local variables:
-# eval: (add-hook 'write-file-functions 'time-stamp)
+# eval: (add-hook 'before-save-hook 'time-stamp)
 # time-stamp-start: "timestamp='"
 # time-stamp-format: "%:y-%02m-%02d"
 # time-stamp-end: "'"
diff --git a/build-aux/install-sh b/build-aux/install-sh
index ac159ceda4..5f3d36cb76 100755
--- a/build-aux/install-sh
+++ b/build-aux/install-sh
@@ -1,7 +1,7 @@
 #!/bin/sh
 # install - install a program, script, or datafile
 
-scriptversion=2017-09-23.17; # UTC
+scriptversion=2018-03-07.03; # UTC
 
 # This originates from X11R5 (mit/util/scripts/install.sh), which was
 # later released in X11R6 (xc/config/util/install.sh) with the
@@ -501,7 +501,7 @@ do
 done
 
 # Local variables:
-# eval: (add-hook 'write-file-hooks 'time-stamp)
+# eval: (add-hook 'before-save-hook 'time-stamp)
 # time-stamp-start: "scriptversion="
 # time-stamp-format: "%:y-%02m-%02d.%02H"
 # time-stamp-time-zone: "UTC0"
diff --git a/build-aux/move-if-change b/build-aux/move-if-change
index f15923613c..5da3eae80a 100755
--- a/build-aux/move-if-change
+++ b/build-aux/move-if-change
@@ -2,7 +2,7 @@
 # Like mv $1 $2, but if the files are the same, just delete $1.
 # Status is zero if successful, nonzero otherwise.
 
-VERSION='2017-09-13 06:45'; # UTC
+VERSION='2018-03-07 03:47'; # UTC
 # The definition above must lie within the first 8 lines in order
 # for the Emacs time-stamp write hook (at end) to update it.
 # If you change this file with Emacs, please let the write hook
@@ -75,7 +75,7 @@ else
 fi
 
 ## Local Variables:
-## eval: (add-hook 'write-file-hooks 'time-stamp)
+## eval: (add-hook 'before-save-hook 'time-stamp)
 ## time-stamp-start: "VERSION='"
 ## time-stamp-format: "%:y-%02m-%02d %02H:%02M"
 ## time-stamp-time-zone: "UTC0"
diff --git a/build-aux/update-copyright b/build-aux/update-copyright
index 3bb26abea1..f2fc97e368 100755
--- a/build-aux/update-copyright
+++ b/build-aux/update-copyright
@@ -3,7 +3,7 @@ eval '(exit $?0)' && eval 'exec perl -wS -0777 -pi "$0" "$@"'
     if 0;
 # Update an FSF copyright year list to include the current year.
 
-my $VERSION = '2018-01-04.14:48'; # UTC
+my $VERSION = '2018-03-07.03:47'; # UTC
 
 # Copyright (C) 2009-2018 Free Software Foundation, Inc.
 #
@@ -269,7 +269,7 @@ else
 # coding: utf-8
 # mode: perl
 # indent-tabs-mode: nil
-# eval: (add-hook 'write-file-hooks 'time-stamp)
+# eval: (add-hook 'before-save-hook 'time-stamp)
 # time-stamp-start: "my $VERSION = '"
 # time-stamp-format: "%:y-%02m-%02d.%02H:%02M"
 # time-stamp-time-zone: "UTC0"
diff --git a/doc/misc/texinfo.tex b/doc/misc/texinfo.tex
index 0af2f09b52..ac5c1d922e 100644
--- a/doc/misc/texinfo.tex
+++ b/doc/misc/texinfo.tex
@@ -3,7 +3,7 @@
 % Load plain if necessary, i.e., if running under initex.
 \expandafter\ifx\csname fmtname\endcsname\relax\input plain\fi
 %
-\def\texinfoversion{2018-02-24.16}
+\def\texinfoversion{2018-02-12.17}
 %
 % Copyright 1985, 1986, 1988, 1990, 1991, 1992, 1993, 1994, 1995,
 % 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006,
@@ -182,7 +182,7 @@
 % Hyphenation fixes.
 \hyphenation{
   Flor-i-da Ghost-script Ghost-view Mac-OS Post-Script
-  ap-pen-dix bit-map bit-maps
+  auto-ma-ti-cal-ly ap-pen-dix bit-map bit-maps
   data-base data-bases eshell fall-ing half-way long-est man-u-script
   man-u-scripts mini-buf-fer mini-buf-fers over-view par-a-digm
   par-a-digms rath-er rec-tan-gu-lar ro-bot-ics se-vere-ly set-up spa-ces
diff --git a/lib/binary-io.h b/lib/binary-io.h
index 8a63204c25..96880ddb5b 100644
--- a/lib/binary-io.h
+++ b/lib/binary-io.h
@@ -47,10 +47,8 @@ _GL_INLINE_HEADER_BEGIN
   /* Use a function rather than a macro, to avoid gcc warnings
      "warning: statement with no effect".  */
 BINARY_IO_INLINE int
-__gl_setmode (int fd, int mode)
+__gl_setmode (int fd _GL_UNUSED, int mode _GL_UNUSED)
 {
-  (void) fd;
-  (void) mode;
   return O_BINARY;
 }
 #endif
@@ -59,7 +57,7 @@ __gl_setmode (int fd, int mode)
 extern int __gl_setmode_check (int);
 #else
 BINARY_IO_INLINE int
-__gl_setmode_check (int fd) { return 0; }
+__gl_setmode_check (int fd _GL_UNUSED) { return 0; }
 #endif
 
 /* Set FD's mode to MODE, which should be either O_TEXT or O_BINARY.
diff --git a/lib/fpending.c b/lib/fpending.c
index c84e3a5b4e..789f50e4e4 100644
--- a/lib/fpending.c
+++ b/lib/fpending.c
@@ -32,7 +32,7 @@ __fpending (FILE *fp)
   /* Most systems provide FILE as a struct and the necessary bitmask in
      <stdio.h>, because they need it for implementing getc() and putc() as
      fast macros.  */
-#if defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
+#if defined _IO_EOF_SEEN || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
   return fp->_IO_write_ptr - fp->_IO_write_base;
 #elif defined __sferror || defined __DragonFly__ || defined __ANDROID__
   /* FreeBSD, NetBSD, OpenBSD, DragonFly, Mac OS X, Cygwin, Minix 3, Android */
diff --git a/lib/stdio-impl.h b/lib/stdio-impl.h
index 78d896e9f5..05c5752a24 100644
--- a/lib/stdio-impl.h
+++ b/lib/stdio-impl.h
@@ -18,6 +18,12 @@
    the same implementation of stdio extension API, except that some fields
    have different naming conventions, or their access requires some casts.  */
 
+/* Glibc 2.28 made _IO_IN_BACKUP private.  For now, work around this
+   problem by defining it ourselves.  FIXME: Do not rely on glibc
+   internals.  */
+#if !defined _IO_IN_BACKUP && defined _IO_EOF_SEEN
+# define _IO_IN_BACKUP 0x100
+#endif
 
 /* BSD stdio derived implementations.  */
 
-- 
2.21.0


From cb0ed3f2805fa4adc336c186ed252aa4ab6e111c Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Wed, 7 Mar 2018 22:56:23 -0800
Subject: [PATCH 105/297] Suppress "No MH variant found" message (bug#30669)

* lisp/mh-e/mh-e.el (mh-variant): Don't try to detect till needed.
* lisp/mh-e/mh-e.el (mh-version, mh-variant-p):
* lisp/mh-e/mh-comp.el (mh-insert-x-mailer):
Ensure mh-variant-in-use is set.
---
 lisp/mh-e/mh-comp.el | 1 +
 lisp/mh-e/mh-e.el    | 5 +++++
 2 files changed, 6 insertions(+)

diff --git a/lisp/mh-e/mh-comp.el b/lisp/mh-e/mh-comp.el
index cfdd2ae5ab..941529330e 100644
--- a/lisp/mh-e/mh-comp.el
+++ b/lisp/mh-e/mh-comp.el
@@ -1056,6 +1056,7 @@ letter."
 (defun mh-insert-x-mailer ()
   "Append an X-Mailer field to the header.
 The versions of MH-E, Emacs, and MH are shown."
+  (or mh-variant-in-use (mh-variant-set mh-variant))
   ;; Lazily initialize mh-x-mailer-string.
   (when (and mh-insert-x-mailer-flag (null mh-x-mailer-string))
     (setq mh-x-mailer-string
diff --git a/lisp/mh-e/mh-e.el b/lisp/mh-e/mh-e.el
index 05ff672da5..7b587a80d1 100644
--- a/lisp/mh-e/mh-e.el
+++ b/lisp/mh-e/mh-e.el
@@ -410,6 +410,8 @@ gnus-version)
   (require 'gnus)
   gnus-version)
 
+(defvar mh-variant)
+
 ;;;###autoload
 (defun mh-version ()
   "Display version information about MH-E and the MH mail handling system."
@@ -430,6 +432,7 @@ gnus-version)
   ;; Emacs version.
   (insert (emacs-version) "\n\n")
   ;; MH version.
+  (or mh-variant-in-use (mh-variant-set mh-variant))
   (if mh-variant-in-use
       (insert mh-variant-in-use "\n"
               " mh-progs:\t" mh-progs "\n"
@@ -876,6 +879,7 @@ variant."
 (defun mh-variant-p (&rest variants)
   "Return t if variant is any of VARIANTS.
 Currently known variants are `MH', `nmh', and `gnu-mh'."
+  (or mh-variant-in-use (mh-variant-set mh-variant))
   (let ((variant-in-use
          (cadr (assoc 'variant (assoc mh-variant-in-use (mh-variants))))))
     (not (null (member variant-in-use variants)))))
@@ -972,6 +976,7 @@ necessary and can actually cause problems."
   :set (lambda (symbol value)
          (set-default symbol value)     ;Done in mh-variant-set-variant!
          (mh-variant-set value))
+  :initialize 'custom-initialize-default
   :group 'mh-e
   :package-version '(MH-E . "8.0"))
 
-- 
2.21.0


From 0c61c4bc8b0a5373463efbfc91eb7a14e78ec8e3 Mon Sep 17 00:00:00 2001
From: Mike Kupfer <mkupfer@alum.berkeley.edu>
Date: Wed, 7 Mar 2018 22:59:14 -0800
Subject: [PATCH 106/297] * lisp/mh-e/mh-utils.el (mh-find-path): Add missing
 part of previous.

---
 lisp/mh-e/mh-utils.el | 1 +
 1 file changed, 1 insertion(+)

diff --git a/lisp/mh-e/mh-utils.el b/lisp/mh-e/mh-utils.el
index 66d87262bc..7bda0a6847 100644
--- a/lisp/mh-e/mh-utils.el
+++ b/lisp/mh-e/mh-utils.el
@@ -177,6 +177,7 @@ been set. This hook can be used the change the value of these
 variables if you need to run with different values between MH and
 MH-E."
   (unless mh-find-path-run
+    (or mh-variant-in-use (mh-variant-set mh-variant))
     ;; Sanity checks.
     (if (and (getenv "MH")
              (not (file-readable-p (getenv "MH"))))
-- 
2.21.0


From 0b7e276e890f12b07b858f40e386fa53e6543746 Mon Sep 17 00:00:00 2001
From: Mike Kupfer <mkupfer@alum.berkeley.edu>
Date: Wed, 7 Mar 2018 23:01:12 -0800
Subject: [PATCH 107/297] * lisp/mh-e/mh-e.el (mh-variant-set): Tweak failure
 message.

---
 lisp/mh-e/mh-e.el | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/lisp/mh-e/mh-e.el b/lisp/mh-e/mh-e.el
index 7b587a80d1..4515144d14 100644
--- a/lisp/mh-e/mh-e.el
+++ b/lisp/mh-e/mh-e.el
@@ -945,6 +945,8 @@ finally GNU mailutils MH."
       (when (not (mh-variant-set-variant variant))
         (message "Warning: %s variant not found. Autodetecting..." variant)
         (mh-variant-set 'autodetect)))
+     ((null valid-list)
+      (message "Unknown variant %s; can't find MH anywhere" variant))
      (t
       (message "Unknown variant %s; use %s"
                variant
-- 
2.21.0


From 120a8c9d75585b3891e808db7b27095cba1141fd Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Thu, 8 Mar 2018 14:09:38 +0100
Subject: [PATCH 108/297] Add OpenDocument formats to Tramp file archives

* doc/misc/tramp.texi (Archive file names):
* lisp/net/tramp-archive.el (tramp-archive-suffixes):
Add OpenDocument formats.
---
 doc/misc/tramp.texi       | 16 ++++++++++++++++
 lisp/net/tramp-archive.el |  8 +++++---
 2 files changed, 21 insertions(+), 3 deletions(-)

diff --git a/doc/misc/tramp.texi b/doc/misc/tramp.texi
index e1c4f3e980..3143904343 100644
--- a/doc/misc/tramp.texi
+++ b/doc/misc/tramp.texi
@@ -3059,6 +3059,22 @@ BSD mtree format
 @cindex @file{mtree} file archive suffix
 @cindex file archive suffix @file{mtree}
 
+@item @samp{.odb}, @samp{.odf}, @samp{.odg}, @samp{.odp}, @samp{.ods},
+@samp{.odt} ---
+OpenDocument formats
+@cindex @file{odb} file archive suffix
+@cindex @file{odf} file archive suffix
+@cindex @file{odg} file archive suffix
+@cindex @file{odp} file archive suffix
+@cindex @file{ods} file archive suffix
+@cindex @file{odt} file archive suffix
+@cindex file archive suffix @file{odb}
+@cindex file archive suffix @file{odf}
+@cindex file archive suffix @file{odg}
+@cindex file archive suffix @file{odp}
+@cindex file archive suffix @file{ods}
+@cindex file archive suffix @file{odt}
+
 @item @samp{.pax} ---
 Posix archives
 @cindex @file{pax} file archive suffix
diff --git a/lisp/net/tramp-archive.el b/lisp/net/tramp-archive.el
index 87b69767f0..0b5a351dea 100644
--- a/lisp/net/tramp-archive.el
+++ b/lisp/net/tramp-archive.el
@@ -62,6 +62,7 @@
 ;; * ".lzh", ".LZH" - Microsoft Windows compressed LHA archives
 ;; * ".msu", ".MSU" - Microsoft Windows Update packages
 ;; * ".mtree" - BSD mtree format
+;; * ".odb" ".odf" ".odg" ".odp" ".ods" ".odt" - OpenDocument formats
 ;; * ".pax" - Posix archives
 ;; * ".rar" - RAR archives
 ;; * ".rpm" - Red Hat packages
@@ -126,9 +127,9 @@
 ;; <https://github.com/libarchive/libarchive/wiki/LibarchiveFormats>
 ;;;###autoload
 (defconst tramp-archive-suffixes
-  ;; "cab", "lzh" and "zip" are included with lower and upper letters,
-  ;; because Microsoft Windows provides them often with capital
-  ;; letters.
+  ;; "cab", "lzh", "msu" and "zip" are included with lower and upper
+  ;; letters, because Microsoft Windows provides them often with
+  ;; capital letters.
   '("7z" ;; 7-Zip archives.
     "apk" ;; Android package kits.  Not in libarchive testsuite.
     "ar" ;; UNIX archiver formats.
@@ -142,6 +143,7 @@
     "lzh" "LZH" ;; Microsoft Windows compressed LHA archives.
     "msu" "MSU" ;; Microsoft Windows Update packages.  Not in testsuite.
     "mtree" ;; BSD mtree format.
+    "odb" "odf" "odg" "odp" "ods" "odt" ;; OpenDocument formats.  Not in testsuite.
     "pax" ;; Posix archives.
     "rar" ;; RAR archives.
     "rpm" ;; Red Hat packages.
-- 
2.21.0


From 55d98ec03f90d968990ab929534ff8f53dbebec4 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Thu, 8 Mar 2018 15:32:23 +0200
Subject: [PATCH 109/297] Fix 'window-text-pixel-size' when display properties
 are around

* src/xdisp.c (Fwindow_text_pixel_size): Correct the result when
there's a display property at the  TO position, and the call to
move_it_to overshoots.  (Bug#30746)
---
 src/xdisp.c | 45 +++++++++++++++++++++++++++++++++++++--------
 1 file changed, 37 insertions(+), 8 deletions(-)

diff --git a/src/xdisp.c b/src/xdisp.c
index 9f4386c09c..4b814dae41 100644
--- a/src/xdisp.c
+++ b/src/xdisp.c
@@ -10136,17 +10136,46 @@ include the height of both, if present, in the return value.  */)
   itdata = bidi_shelve_cache ();
   SET_TEXT_POS (startp, start, CHAR_TO_BYTE (start));
   start_display (&it, w, startp);
-
-  if (NILP (x_limit))
-    x = move_it_to (&it, end, -1, max_y, -1, MOVE_TO_POS | MOVE_TO_Y);
-  else
+  /* It makes no sense to measure dimensions of region of text that
+     crosses the point where bidi reordering changes scan direction.
+     By using unidirectional movement here we at least support the use
+     case of measuring regions of text that have a uniformly R2L
+     directionality, and regions that begin and end in text of the
+     same directionality.  */
+  it.bidi_p = false;
+  void *it2data = NULL;
+  struct it it2;
+  SAVE_IT (it2, it, it2data);
+
+  int move_op = MOVE_TO_POS | MOVE_TO_Y;
+  int to_x = -1;
+  if (!NILP (x_limit))
     {
-      it.last_visible_x = max_x;
       /* Actually, we never want move_it_to stop at to_x.  But to make
 	 sure that move_it_in_display_line_to always moves far enough,
-	 we set it to INT_MAX and specify MOVE_TO_X.  */
-      x = move_it_to (&it, end, INT_MAX, max_y, -1,
-		      MOVE_TO_POS | MOVE_TO_X | MOVE_TO_Y);
+	 we set to_x to INT_MAX and specify MOVE_TO_X.  */
+      move_op |= MOVE_TO_X;
+      to_x = INT_MAX;
+    }
+
+  x = move_it_to (&it, end, to_x, max_y, -1, move_op);
+
+  /* We could have a display property at END, in which case asking
+     move_it_to to stop at END will overshoot and stop at position
+     after END.  So we try again, stopping before END, and account for
+     the width of the last buffer position manually.  */
+  if (IT_CHARPOS (it) > end)
+    {
+      end--;
+      RESTORE_IT (&it, &it2, it2data);
+      x = move_it_to (&it, end, to_x, max_y, -1, move_op);
+      /* Add the width of the thing at TO, but only if we didn't
+	 overshoot it; if we did, it is already accounted for.  */
+      if (IT_CHARPOS (it) == end)
+	x += it.pixel_width;
+    }
+  if (!NILP (x_limit))
+    {
       /* Don't return more than X-LIMIT.  */
       if (x > max_x)
         x = max_x;
-- 
2.21.0


From 5b4a8f25400ae7e54fdc59c5091abbcb49d7162a Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Mon, 5 Mar 2018 20:37:34 +0200
Subject: [PATCH 110/297] Minor fix in Emacs manual's Glossary

* doc/emacs/glossary.texi (Glossary): Fix outdated text about
primary selection.  Reported by Gijs Hillenius
<gijs@hillenius.net> in emacs-manual-bugs@gnu.org.
---
 doc/emacs/glossary.texi | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/doc/emacs/glossary.texi b/doc/emacs/glossary.texi
index dda13dd55b..4525c816ce 100644
--- a/doc/emacs/glossary.texi
+++ b/doc/emacs/glossary.texi
@@ -1090,8 +1090,9 @@ The primary selection is one particular X selection (q.v.); it is the
 selection that most X applications use for transferring text to and from
 other applications.
 
-The Emacs kill commands set the primary selection and the yank command
-uses the primary selection when appropriate.  @xref{Killing}.
+The Emacs commands that mark or select text set the primary selection,
+and clicking the mouse inserts text from the primary selection when
+appropriate.  @xref{Shift Selection}.
 
 @item Prompt
 A prompt is text used to ask you for input.  Displaying a prompt
-- 
2.21.0


From 65d5bbd8fbeb2e3272c8ab0bfdbc7fefdfaf27fb Mon Sep 17 00:00:00 2001
From: Michael Heerdegen <michael_heerdegen@web.de>
Date: Wed, 21 Feb 2018 11:15:37 +0100
Subject: [PATCH 111/297] Define if-let* and derivatives as aliases for if-let
 etc

This commit reverts declaring `if-let' and `when-let' obsolete in
favor of the new `if-let*' and `when-let*' versions because of the
compiler warning mess (Bug#30039).  Instead we make foo-let* aliases
for foo-let.  The old single-tuple variable spec case is still
supported for backward compatibility.
* lisp/emacs-lisp/subr-x.el (if-let, when-let): Don't declare
obsolete.  Tweak edebug specs.
(and-let): Renamed from `and-let*' for compatibility with the names
`if-let' and `when-let'.
(if-let*, when-let*, and-let*): Define as aliases for `if-let',
`when-let' and `and-let'.
* test/lisp/emacs-lisp/subr-x-tests.el (if-let-single-tuple-case-test)
(when-let-single-tuple-case-test): New tests for the single-binding
tuple case.
In the whole file, prefer the names without "*".
---
 lisp/emacs-lisp/subr-x.el            |  55 +++----
 test/lisp/emacs-lisp/subr-x-tests.el | 232 ++++++++++++++-------------
 2 files changed, 144 insertions(+), 143 deletions(-)

diff --git a/lisp/emacs-lisp/subr-x.el b/lisp/emacs-lisp/subr-x.el
index 21dba377bf..b2d7f0dec4 100644
--- a/lisp/emacs-lisp/subr-x.el
+++ b/lisp/emacs-lisp/subr-x.el
@@ -121,7 +121,7 @@ If ELT is of the form ((EXPR)), listify (EXPR) with a dummy symbol."
                 binding))
             bindings)))
 
-(defmacro if-let* (varlist then &rest else)
+(defmacro if-let (varlist then &rest else)
   "Bind variables according to VARLIST and eval THEN or ELSE.
 Each binding is evaluated in turn, and evaluation stops if a
 binding value is nil.  If all are non-nil, the value of THEN is
@@ -131,10 +131,18 @@ Each element of VARLIST is a list (SYMBOL VALUEFORM) which binds
 SYMBOL to the value of VALUEFORM.  An element can additionally
 be of the form (VALUEFORM), which is evaluated and checked for
 nil; i.e. SYMBOL can be omitted if only the test result is of
-interest."
+interest.
+
+As a special case, a VARLIST of the form (SYMBOL SOMETHING) is
+treated like ((SYMBOL SOMETHING))."
   (declare (indent 2)
-           (debug ((&rest [&or symbolp (symbolp form) (form)])
+           (debug ([&or (symbolp form)
+                        (&rest [&or symbolp (symbolp form) (form)])]
                    form body)))
+  (pcase varlist
+    (`(,(pred symbolp) ,_)
+     ;; the single-tuple syntax case, for backward compatibility
+     (cl-callf list varlist)))
   (if varlist
       `(let* ,(setq varlist (internal--build-bindings varlist))
          (if ,(caar (last varlist))
@@ -142,23 +150,23 @@ interest."
            ,@else))
     `(let* () ,then)))
 
-(defmacro when-let* (varlist &rest body)
+(defmacro when-let (varlist &rest body)
   "Bind variables according to VARLIST and conditionally eval BODY.
 Each binding is evaluated in turn, and evaluation stops if a
 binding value is nil.  If all are non-nil, the value of the last
 form in BODY is returned.
 
-VARLIST is the same as in `if-let*'."
-  (declare (indent 1) (debug if-let*))
-  (list 'if-let* varlist (macroexp-progn body)))
+VARLIST is the same as in `if-let'."
+  (declare (indent 1) (debug ([&or (symbolp form)
+                                   (&rest [&or symbolp (symbolp form) (form)])]
+                              body)))
+  (list 'if-let varlist (macroexp-progn body)))
 
-(defmacro and-let* (varlist &rest body)
+(defmacro and-let (varlist &rest body)
   "Bind variables according to VARLIST and conditionally eval BODY.
-Like `when-let*', except if BODY is empty and all the bindings
+Like `when-let', except if BODY is empty and all the bindings
 are non-nil, then the result is non-nil."
-  (declare (indent 1)
-           (debug ((&rest [&or symbolp (symbolp form) (form)])
-                   body)))
+  (declare (indent 1) (debug when-let))
   (let (res)
     (if varlist
         `(let* ,(setq varlist (internal--build-bindings varlist))
@@ -166,26 +174,9 @@ are non-nil, then the result is non-nil."
                ,@(or body `(,res))))
       `(let* () ,@(or body '(t))))))
 
-(defmacro if-let (spec then &rest else)
-  "Bind variables according to SPEC and eval THEN or ELSE.
-Like `if-let*' except SPEC can have the form (SYMBOL VALUEFORM)."
-  (declare (indent 2)
-           (debug ([&or (&rest [&or symbolp (symbolp form) (form)])
-                        (symbolp form)]
-                   form body))
-           (obsolete "use `if-let*' instead." "26.1"))
-  (when (and (<= (length spec) 2)
-             (not (listp (car spec))))
-    ;; Adjust the single binding case
-    (setq spec (list spec)))
-  (list 'if-let* spec then (macroexp-progn else)))
-
-(defmacro when-let (spec &rest body)
-  "Bind variables according to SPEC and conditionally eval BODY.
-Like `when-let*' except SPEC can have the form (SYMBOL VALUEFORM)."
-  (declare (indent 1) (debug if-let)
-           (obsolete "use `when-let*' instead." "26.1"))
-  (list 'if-let spec (macroexp-progn body)))
+(defalias 'if-let*   #'if-let)
+(defalias 'when-let* #'when-let)
+(defalias 'and-let*  #'and-let)
 
 (defsubst hash-table-empty-p (hash-table)
   "Check whether HASH-TABLE is empty (has 0 elements)."
diff --git a/test/lisp/emacs-lisp/subr-x-tests.el b/test/lisp/emacs-lisp/subr-x-tests.el
index c9618f3c37..a361718c9e 100644
--- a/test/lisp/emacs-lisp/subr-x-tests.el
+++ b/test/lisp/emacs-lisp/subr-x-tests.el
@@ -28,13 +28,13 @@
 (require 'subr-x)
 
 
-;; `if-let*' tests
+;; `if-let' tests
 
-(ert-deftest subr-x-test-if-let*-single-binding-expansion ()
+(ert-deftest subr-x-test-if-let-single-binding-expansion ()
   "Test single bindings are expanded properly."
   (should (equal
            (macroexpand
-            '(if-let* ((a 1))
+            '(if-let ((a 1))
                  (- a)
                "no"))
            '(let* ((a (and t 1)))
@@ -43,7 +43,7 @@
                 "no"))))
   (should (equal
            (macroexpand
-            '(if-let* (a)
+            '(if-let (a)
                  (- a)
                "no"))
            '(let* ((a (and t a)))
@@ -51,11 +51,11 @@
                   (- a)
                 "no")))))
 
-(ert-deftest subr-x-test-if-let*-single-symbol-expansion ()
+(ert-deftest subr-x-test-if-let-single-symbol-expansion ()
   "Test single symbol bindings are expanded properly."
   (should (equal
            (macroexpand
-            '(if-let* (a)
+            '(if-let (a)
                  (- a)
                "no"))
            '(let* ((a (and t a)))
@@ -64,7 +64,7 @@
                 "no"))))
   (should (equal
            (macroexpand
-            '(if-let* (a b c)
+            '(if-let (a b c)
                  (- a)
                "no"))
            '(let* ((a (and t a))
@@ -75,7 +75,7 @@
                 "no"))))
   (should (equal
            (macroexpand
-            '(if-let* (a (b 2) c)
+            '(if-let (a (b 2) c)
                  (- a)
                "no"))
            '(let* ((a (and t a))
@@ -85,11 +85,11 @@
                   (- a)
                 "no")))))
 
-(ert-deftest subr-x-test-if-let*-nil-related-expansion ()
+(ert-deftest subr-x-test-if-let-nil-related-expansion ()
   "Test nil is processed properly."
   (should (equal
            (macroexpand
-            '(if-let* (nil)
+            '(if-let (nil)
                  (- a)
                "no"))
            '(let* ((nil (and t nil)))
@@ -98,7 +98,7 @@
                 "no"))))
   (should (equal
            (macroexpand
-            '(if-let* ((a 1) nil (b 2))
+            '(if-let ((a 1) nil (b 2))
                  (- a)
                "no"))
            '(let* ((a (and t 1))
@@ -108,106 +108,106 @@
                   (- a)
                 "no")))))
 
-(ert-deftest subr-x-test-if-let*-malformed-binding ()
+(ert-deftest subr-x-test-if-let-malformed-binding ()
   "Test malformed bindings trigger errors."
   (should-error (macroexpand
-                 '(if-let* (_ (a 1 1) (b 2) (c 3) d)
+                 '(if-let (_ (a 1 1) (b 2) (c 3) d)
                       (- a)
                     "no"))
                 :type 'error)
   (should-error (macroexpand
-                 '(if-let* (_ (a 1) (b 2 2) (c 3) d)
+                 '(if-let (_ (a 1) (b 2 2) (c 3) d)
                       (- a)
                     "no"))
                 :type 'error)
   (should-error (macroexpand
-                 '(if-let* (_ (a 1) (b 2) (c 3 3) d)
+                 '(if-let (_ (a 1) (b 2) (c 3 3) d)
                       (- a)
                     "no"))
                 :type 'error)
   (should-error (macroexpand
-                 '(if-let* ((a 1 1))
+                 '(if-let ((a 1 1))
                       (- a)
                     "no"))
                 :type 'error))
 
-(ert-deftest subr-x-test-if-let*-true ()
+(ert-deftest subr-x-test-if-let-true ()
   "Test `if-let' with truthy bindings."
   (should (equal
-           (if-let* ((a 1))
+           (if-let ((a 1))
                a
              "no")
            1))
   (should (equal
-           (if-let* ((a 1) (b 2) (c 3))
+           (if-let ((a 1) (b 2) (c 3))
                (list a b c)
              "no")
            (list 1 2 3))))
 
-(ert-deftest subr-x-test-if-let*-false ()
+(ert-deftest subr-x-test-if-let-false ()
   "Test `if-let' with falsie bindings."
   (should (equal
-           (if-let* ((a nil))
+           (if-let ((a nil))
                (list a b c)
              "no")
            "no"))
   (should (equal
-           (if-let* ((a nil) (b 2) (c 3))
+           (if-let ((a nil) (b 2) (c 3))
                (list a b c)
              "no")
            "no"))
   (should (equal
-           (if-let* ((a 1) (b nil) (c 3))
+           (if-let ((a 1) (b nil) (c 3))
                (list a b c)
              "no")
            "no"))
   (should (equal
-           (if-let* ((a 1) (b 2) (c nil))
+           (if-let ((a 1) (b 2) (c nil))
                (list a b c)
              "no")
            "no"))
   (should (equal
            (let (z)
-             (if-let* (z (a 1) (b 2) (c 3))
+             (if-let (z (a 1) (b 2) (c 3))
                  (list a b c)
                "no"))
            "no"))
   (should (equal
            (let (d)
-             (if-let* ((a 1) (b 2) (c 3) d)
+             (if-let ((a 1) (b 2) (c 3) d)
                  (list a b c)
                "no"))
            "no")))
 
-(ert-deftest subr-x-test-if-let*-bound-references ()
+(ert-deftest subr-x-test-if-let-bound-references ()
   "Test `if-let' bindings can refer to already bound symbols."
   (should (equal
-           (if-let* ((a (1+ 0)) (b (1+ a)) (c (1+ b)))
+           (if-let ((a (1+ 0)) (b (1+ a)) (c (1+ b)))
                (list a b c)
              "no")
            (list 1 2 3))))
 
-(ert-deftest subr-x-test-if-let*-and-laziness-is-preserved ()
+(ert-deftest subr-x-test-if-let-and-laziness-is-preserved ()
   "Test `if-let' respects `and' laziness."
   (let (a-called b-called c-called)
     (should (equal
-             (if-let* ((a nil)
-                       (b (setq b-called t))
-                       (c (setq c-called t)))
+             (if-let ((a nil)
+                      (b (setq b-called t))
+                      (c (setq c-called t)))
                  "yes"
                (list a-called b-called c-called))
              (list nil nil nil))))
   (let (a-called b-called c-called)
     (should (equal
-             (if-let* ((a (setq a-called t))
-                       (b nil)
-                       (c (setq c-called t)))
+             (if-let ((a (setq a-called t))
+                      (b nil)
+                      (c (setq c-called t)))
                  "yes"
                (list a-called b-called c-called))
              (list t nil nil))))
   (let (a-called b-called c-called)
     (should (equal
-             (if-let* ((a (setq a-called t))
+             (if-let ((a (setq a-called t))
                       (b (setq b-called t))
                       (c nil)
                       (d (setq c-called t)))
@@ -215,14 +215,19 @@
                (list a-called b-called c-called))
              (list t t nil)))))
 
+(defun if-let-single-tuple-case-test ()
+  "Test the BINDING-SPEC == (SYMBOL SOMETHING) case."
+  (should (equal (if-let (a 1) (1+ a)) 2))
+  (should (equal (let ((b 2)) (if-let (a b) a)) 2)))
+
 
-;; `when-let*' tests
+;; `when-let' tests
 
-(ert-deftest subr-x-test-when-let*-body-expansion ()
+(ert-deftest subr-x-test-when-let-body-expansion ()
   "Test body allows for multiple sexps wrapping with progn."
   (should (equal
            (macroexpand
-            '(when-let* ((a 1))
+            '(when-let ((a 1))
                (message "opposite")
                (- a)))
            '(let* ((a (and t 1)))
@@ -231,18 +236,18 @@
                     (message "opposite")
                     (- a)))))))
 
-(ert-deftest subr-x-test-when-let*-single-symbol-expansion ()
+(ert-deftest subr-x-test-when-let-single-symbol-expansion ()
   "Test single symbol bindings are expanded properly."
   (should (equal
            (macroexpand
-            '(when-let* (a)
+            '(when-let (a)
                (- a)))
            '(let* ((a (and t a)))
               (if a
                   (- a)))))
   (should (equal
            (macroexpand
-            '(when-let* (a b c)
+            '(when-let (a b c)
                (- a)))
            '(let* ((a (and t a))
                    (b (and a b))
@@ -251,7 +256,7 @@
                   (- a)))))
   (should (equal
            (macroexpand
-            '(when-let* (a (b 2) c)
+            '(when-let (a (b 2) c)
                (- a)))
            '(let* ((a (and t a))
                    (b (and a 2))
@@ -259,18 +264,18 @@
               (if c
                   (- a))))))
 
-(ert-deftest subr-x-test-when-let*-nil-related-expansion ()
+(ert-deftest subr-x-test-when-let-nil-related-expansion ()
   "Test nil is processed properly."
   (should (equal
            (macroexpand
-            '(when-let* (nil)
+            '(when-let (nil)
                (- a)))
            '(let* ((nil (and t nil)))
               (if nil
                   (- a)))))
   (should (equal
            (macroexpand
-            '(when-let* ((a 1) nil (b 2))
+            '(when-let ((a 1) nil (b 2))
                (- a)))
            '(let* ((a (and t 1))
                    (nil (and a nil))
@@ -278,173 +283,178 @@
               (if b
                   (- a))))))
 
-(ert-deftest subr-x-test-when-let*-malformed-binding ()
+(ert-deftest subr-x-test-when-let-malformed-binding ()
   "Test malformed bindings trigger errors."
   (should-error (macroexpand
-                 '(when-let* (_ (a 1 1) (b 2) (c 3) d)
+                 '(when-let (_ (a 1 1) (b 2) (c 3) d)
                     (- a)))
                 :type 'error)
   (should-error (macroexpand
-                 '(when-let* (_ (a 1) (b 2 2) (c 3) d)
+                 '(when-let (_ (a 1) (b 2 2) (c 3) d)
                     (- a)))
                 :type 'error)
   (should-error (macroexpand
-                 '(when-let* (_ (a 1) (b 2) (c 3 3) d)
+                 '(when-let (_ (a 1) (b 2) (c 3 3) d)
                     (- a)))
                 :type 'error)
   (should-error (macroexpand
-                 '(when-let* ((a 1 1))
+                 '(when-let ((a 1 1))
                     (- a)))
                 :type 'error))
 
-(ert-deftest subr-x-test-when-let*-true ()
+(ert-deftest subr-x-test-when-let-true ()
   "Test `when-let' with truthy bindings."
   (should (equal
-           (when-let* ((a 1))
+           (when-let ((a 1))
              a)
            1))
   (should (equal
-           (when-let* ((a 1) (b 2) (c 3))
+           (when-let ((a 1) (b 2) (c 3))
              (list a b c))
            (list 1 2 3))))
 
-(ert-deftest subr-x-test-when-let*-false ()
+(ert-deftest subr-x-test-when-let-false ()
   "Test `when-let' with falsie bindings."
   (should (equal
-           (when-let* ((a nil))
+           (when-let ((a nil))
              (list a b c)
              "no")
            nil))
   (should (equal
-           (when-let* ((a nil) (b 2) (c 3))
+           (when-let ((a nil) (b 2) (c 3))
              (list a b c)
              "no")
            nil))
   (should (equal
-           (when-let* ((a 1) (b nil) (c 3))
+           (when-let ((a 1) (b nil) (c 3))
              (list a b c)
              "no")
            nil))
   (should (equal
-           (when-let* ((a 1) (b 2) (c nil))
+           (when-let ((a 1) (b 2) (c nil))
              (list a b c)
              "no")
            nil))
   (should (equal
            (let (z)
-             (when-let* (z (a 1) (b 2) (c 3))
+             (when-let (z (a 1) (b 2) (c 3))
                (list a b c)
                "no"))
            nil))
   (should (equal
            (let (d)
-             (when-let* ((a 1) (b 2) (c 3) d)
+             (when-let ((a 1) (b 2) (c 3) d)
                (list a b c)
                "no"))
            nil)))
 
-(ert-deftest subr-x-test-when-let*-bound-references ()
+(ert-deftest subr-x-test-when-let-bound-references ()
   "Test `when-let' bindings can refer to already bound symbols."
   (should (equal
-           (when-let* ((a (1+ 0)) (b (1+ a)) (c (1+ b)))
+           (when-let ((a (1+ 0)) (b (1+ a)) (c (1+ b)))
              (list a b c))
            (list 1 2 3))))
 
-(ert-deftest subr-x-test-when-let*-and-laziness-is-preserved ()
+(ert-deftest subr-x-test-when-let-and-laziness-is-preserved ()
   "Test `when-let' respects `and' laziness."
   (let (a-called b-called c-called)
     (should (equal
              (progn
-               (when-let* ((a nil)
-                           (b (setq b-called t))
-                           (c (setq c-called t)))
+               (when-let ((a nil)
+                          (b (setq b-called t))
+                          (c (setq c-called t)))
                  "yes")
                (list a-called b-called c-called))
              (list nil nil nil))))
   (let (a-called b-called c-called)
     (should (equal
              (progn
-               (when-let* ((a (setq a-called t))
-                           (b nil)
-                           (c (setq c-called t)))
+               (when-let ((a (setq a-called t))
+                          (b nil)
+                          (c (setq c-called t)))
                  "yes")
                (list a-called b-called c-called))
              (list t nil nil))))
   (let (a-called b-called c-called)
     (should (equal
              (progn
-               (when-let* ((a (setq a-called t))
-                           (b (setq b-called t))
-                           (c nil)
-                           (d (setq c-called t)))
+               (when-let ((a (setq a-called t))
+                          (b (setq b-called t))
+                          (c nil)
+                          (d (setq c-called t)))
                  "yes")
                (list a-called b-called c-called))
              (list t t nil)))))
 
+(defun when-let-single-tuple-case-test ()
+  "Test the BINDING-SPEC == (SYMBOL SOMETHING) case."
+  (should (equal (when-let (a 1) (1+ a)) 2))
+  (should (equal (let ((b 2)) (when-let (a b) a)) 2)))
+
 
-;; `and-let*' tests
+;; `and-let' tests
 
 ;; Adapted from the Guile tests
 ;; https://git.savannah.gnu.org/cgit/guile.git/tree/test-suite/tests/srfi-2.test
 
-(ert-deftest subr-x-and-let*-test-empty-varlist ()
-  (should (equal 1 (and-let* () 1)))
-  (should (equal 2 (and-let* () 1 2)))
-  (should (equal t (and-let* ()))))
+(ert-deftest subr-x-and-let-test-empty-varlist ()
+  (should (equal 1 (and-let () 1)))
+  (should (equal 2 (and-let () 1 2)))
+  (should (equal t (and-let ()))))
 
-(ert-deftest subr-x-and-let*-test-group-1 ()
-   (should (equal nil (let ((x nil)) (and-let* (x)))))
-   (should (equal 1 (let ((x 1)) (and-let* (x)))))
-   (should (equal nil (and-let* ((x nil)))))
-   (should (equal 1 (and-let* ((x 1)))))
+(ert-deftest subr-x-and-let-test-group-1 ()
+   (should (equal nil (let ((x nil)) (and-let (x)))))
+   (should (equal 1 (let ((x 1)) (and-let (x)))))
+   (should (equal nil (and-let ((x nil)))))
+   (should (equal 1 (and-let ((x 1)))))
    ;; The error doesn't trigger when compiled: the compiler will give
    ;; a warning and then drop the erroneous code.  Therefore, use
    ;; `eval' to avoid compilation.
-   (should-error (eval '(and-let* (nil (x 1))) lexical-binding)
+   (should-error (eval '(and-let (nil (x 1))) lexical-binding)
                  :type 'setting-constant)
-   (should (equal nil (and-let* ((nil) (x 1)))))
-   (should-error (eval '(and-let* (2 (x 1))) lexical-binding)
+   (should (equal nil (and-let ((nil) (x 1)))))
+   (should-error (eval '(and-let (2 (x 1))) lexical-binding)
                  :type 'wrong-type-argument)
-   (should (equal 1 (and-let* ((2) (x 1)))))
-   (should (equal 2 (and-let* ((x 1) (2)))))
-   (should (equal nil (let ((x nil)) (and-let* (x) x))))
-   (should (equal "" (let ((x "")) (and-let* (x) x))))
-   (should (equal "" (let ((x "")) (and-let* (x)))))
-   (should (equal 2 (let ((x 1)) (and-let* (x) (+ x 1)))))
-   (should (equal nil (let ((x nil)) (and-let* (x) (+ x 1)))))
-   (should (equal 2 (let ((x 1)) (and-let* (((> x 0))) (+ x 1)))))
-   (should (equal t (let ((x 1)) (and-let* (((> x 0)))))))
-   (should (equal nil (let ((x 0)) (and-let* (((> x 0))) (+ x 1)))))
+   (should (equal 1 (and-let ((2) (x 1)))))
+   (should (equal 2 (and-let ((x 1) (2)))))
+   (should (equal nil (let ((x nil)) (and-let (x) x))))
+   (should (equal "" (let ((x "")) (and-let (x) x))))
+   (should (equal "" (let ((x "")) (and-let (x)))))
+   (should (equal 2 (let ((x 1)) (and-let (x) (+ x 1)))))
+   (should (equal nil (let ((x nil)) (and-let (x) (+ x 1)))))
+   (should (equal 2 (let ((x 1)) (and-let (((> x 0))) (+ x 1)))))
+   (should (equal t (let ((x 1)) (and-let (((> x 0)))))))
+   (should (equal nil (let ((x 0)) (and-let (((> x 0))) (+ x 1)))))
    (should (equal 3
-                  (let ((x 1)) (and-let* (((> x 0)) (x (+ x 1))) (+ x 1))))))
+                  (let ((x 1)) (and-let (((> x 0)) (x (+ x 1))) (+ x 1))))))
 
-(ert-deftest subr-x-and-let*-test-rebind ()
+(ert-deftest subr-x-and-let-test-rebind ()
    (should
     (equal 4
            (let ((x 1))
-             (and-let* (((> x 0)) (x (+ x 1)) (x (+ x 1))) (+ x 1))))))
+             (and-let (((> x 0)) (x (+ x 1)) (x (+ x 1))) (+ x 1))))))
 
-(ert-deftest subr-x-and-let*-test-group-2 ()
+(ert-deftest subr-x-and-let-test-group-2 ()
    (should
-    (equal 2 (let ((x 1)) (and-let* (x ((> x 0))) (+ x 1)))))
+    (equal 2 (let ((x 1)) (and-let (x ((> x 0))) (+ x 1)))))
    (should
-    (equal 2 (let ((x 1)) (and-let* (((progn x)) ((> x 0))) (+ x 1)))))
-   (should (equal nil (let ((x 0)) (and-let* (x ((> x 0))) (+ x 1)))))
-   (should (equal nil (let ((x nil)) (and-let* (x ((> x 0))) (+ x 1)))))
+    (equal 2 (let ((x 1)) (and-let (((progn x)) ((> x 0))) (+ x 1)))))
+   (should (equal nil (let ((x 0)) (and-let (x ((> x 0))) (+ x 1)))))
+   (should (equal nil (let ((x nil)) (and-let (x ((> x 0))) (+ x 1)))))
    (should
-    (equal nil (let ((x nil)) (and-let* (((progn x)) ((> x 0))) (+ x 1))))))
+    (equal nil (let ((x nil)) (and-let (((progn x)) ((> x 0))) (+ x 1))))))
 
-(ert-deftest subr-x-and-let*-test-group-3 ()
+(ert-deftest subr-x-and-let-test-group-3 ()
    (should
-    (equal nil (let ((x 1)) (and-let* (x (y (- x 1)) ((> y 0))) (/ x y)))))
+    (equal nil (let ((x 1)) (and-let (x (y (- x 1)) ((> y 0))) (/ x y)))))
    (should
-    (equal nil (let ((x 0)) (and-let* (x (y (- x 1)) ((> y 0))) (/ x y)))))
+    (equal nil (let ((x 0)) (and-let (x (y (- x 1)) ((> y 0))) (/ x y)))))
    (should
     (equal nil
-           (let ((x nil)) (and-let* (x (y (- x 1)) ((> y 0))) (/ x y)))))
+           (let ((x nil)) (and-let (x (y (- x 1)) ((> y 0))) (/ x y)))))
    (should
     (equal (/ 3.0 2)
-           (let ((x 3.0)) (and-let* (x (y (- x 1)) ((> y 0))) (/ x y))))))
+           (let ((x 3.0)) (and-let (x (y (- x 1)) ((> y 0))) (/ x y))))))
 
 
 
-- 
2.21.0


From 2d5a337a826cfb87fbdd61921185e4c26119bd0d Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Tue, 6 Mar 2018 19:32:39 +0200
Subject: [PATCH 112/297] More minor changes in the Glossary of the Emacs
 manual

* doc/emacs/glossary.texi (Glossary): Improve cross-references for
modifier keys.  Fix typos.  Suggested by Gijs Hillenius
<gijs@hillenius.net> in emacs-manual-bugs@gnu.org.
---
 doc/emacs/glossary.texi | 22 ++++++++++++----------
 1 file changed, 12 insertions(+), 10 deletions(-)

diff --git a/doc/emacs/glossary.texi b/doc/emacs/glossary.texi
index 4525c816ce..4ad574156a 100644
--- a/doc/emacs/glossary.texi
+++ b/doc/emacs/glossary.texi
@@ -720,10 +720,11 @@ customizing the various hooks, you can modify Emacs's behavior without
 changing any of its code.  @xref{Hooks}.
 
 @item Hyper
-Hyper is the name of a modifier bit that a keyboard input character may
-have.  To make a character Hyper, type it while holding down the
+Hyper is the name of a modifier bit that a keyboard input character
+may have.  To make a character Hyper, type it while holding down the
 @key{Hyper} key.  Such characters are given names that start with
-@kbd{Hyper-} (usually written @kbd{H-} for short).  @xref{User Input}.
+@kbd{Hyper-} (usually written @kbd{H-} for short).  @xref{Modifier
+Keys}.
 
 @item i.e.
 Short for ``id est'' in Latin, which means ``that is''.
@@ -1343,10 +1344,11 @@ which characters balance each other like parentheses, etc.
 Manual}.
 
 @item Super
-Super is the name of a modifier bit that a keyboard input character may
-have.  To make a character Super, type it while holding down the
+Super is the name of a modifier bit that a keyboard input character
+may have.  To make a character Super, type it while holding down the
 @key{SUPER} key.  Such characters are given names that start with
-@kbd{Super-} (usually written @kbd{s-} for short).  @xref{User Input}.
+@kbd{Super-} (usually written @kbd{s-} for short).  @xref{Modifier
+Keys}.
 
 @item Suspending
 Suspending Emacs means stopping it temporarily and returning control
@@ -1493,13 +1495,13 @@ Emacs divides a frame (q.v.@:) into one or more windows, each of which
 can display the contents of one buffer (q.v.@:) at any time.
 @xref{Screen}, for basic information on how Emacs uses the screen.
 @xref{Windows}, for commands to control the use of windows.  Some
-other editors use the term ``window'' for what we call a ``frame''
-(q.v.@:) in Emacs.
+other editors use the term ``window'' for what we call a ``frame'' in
+Emacs.
 
 @item Window System
 A window system is software that operates on a graphical display
-(q.v.), to subdivide the screen so that multiple applications can
-have their] own windows at the same time.  All modern operating systems
+(q.v.), to subdivide the screen so that multiple applications can have
+their own windows at the same time.  All modern operating systems
 include a window system.
 
 @item Word Abbrev
-- 
2.21.0


From 83988bbb7f5cec84305d258bad256c4ed4f21e59 Mon Sep 17 00:00:00 2001
From: Michael Heerdegen <michael_heerdegen@web.de>
Date: Tue, 6 Mar 2018 18:28:51 +0100
Subject: [PATCH 113/297] Revert last commit

This reverts commit af4697faa1f5b643f63a9ea61aa205a4c1432e23.  It's
too late for this to be in the release.
---
 lisp/emacs-lisp/subr-x.el            |  55 ++++---
 test/lisp/emacs-lisp/subr-x-tests.el | 232 +++++++++++++--------------
 2 files changed, 143 insertions(+), 144 deletions(-)

diff --git a/lisp/emacs-lisp/subr-x.el b/lisp/emacs-lisp/subr-x.el
index b2d7f0dec4..21dba377bf 100644
--- a/lisp/emacs-lisp/subr-x.el
+++ b/lisp/emacs-lisp/subr-x.el
@@ -121,7 +121,7 @@ If ELT is of the form ((EXPR)), listify (EXPR) with a dummy symbol."
                 binding))
             bindings)))
 
-(defmacro if-let (varlist then &rest else)
+(defmacro if-let* (varlist then &rest else)
   "Bind variables according to VARLIST and eval THEN or ELSE.
 Each binding is evaluated in turn, and evaluation stops if a
 binding value is nil.  If all are non-nil, the value of THEN is
@@ -131,18 +131,10 @@ Each element of VARLIST is a list (SYMBOL VALUEFORM) which binds
 SYMBOL to the value of VALUEFORM.  An element can additionally
 be of the form (VALUEFORM), which is evaluated and checked for
 nil; i.e. SYMBOL can be omitted if only the test result is of
-interest.
-
-As a special case, a VARLIST of the form (SYMBOL SOMETHING) is
-treated like ((SYMBOL SOMETHING))."
+interest."
   (declare (indent 2)
-           (debug ([&or (symbolp form)
-                        (&rest [&or symbolp (symbolp form) (form)])]
+           (debug ((&rest [&or symbolp (symbolp form) (form)])
                    form body)))
-  (pcase varlist
-    (`(,(pred symbolp) ,_)
-     ;; the single-tuple syntax case, for backward compatibility
-     (cl-callf list varlist)))
   (if varlist
       `(let* ,(setq varlist (internal--build-bindings varlist))
          (if ,(caar (last varlist))
@@ -150,23 +142,23 @@ treated like ((SYMBOL SOMETHING))."
            ,@else))
     `(let* () ,then)))
 
-(defmacro when-let (varlist &rest body)
+(defmacro when-let* (varlist &rest body)
   "Bind variables according to VARLIST and conditionally eval BODY.
 Each binding is evaluated in turn, and evaluation stops if a
 binding value is nil.  If all are non-nil, the value of the last
 form in BODY is returned.
 
-VARLIST is the same as in `if-let'."
-  (declare (indent 1) (debug ([&or (symbolp form)
-                                   (&rest [&or symbolp (symbolp form) (form)])]
-                              body)))
-  (list 'if-let varlist (macroexp-progn body)))
+VARLIST is the same as in `if-let*'."
+  (declare (indent 1) (debug if-let*))
+  (list 'if-let* varlist (macroexp-progn body)))
 
-(defmacro and-let (varlist &rest body)
+(defmacro and-let* (varlist &rest body)
   "Bind variables according to VARLIST and conditionally eval BODY.
-Like `when-let', except if BODY is empty and all the bindings
+Like `when-let*', except if BODY is empty and all the bindings
 are non-nil, then the result is non-nil."
-  (declare (indent 1) (debug when-let))
+  (declare (indent 1)
+           (debug ((&rest [&or symbolp (symbolp form) (form)])
+                   body)))
   (let (res)
     (if varlist
         `(let* ,(setq varlist (internal--build-bindings varlist))
@@ -174,9 +166,26 @@ are non-nil, then the result is non-nil."
                ,@(or body `(,res))))
       `(let* () ,@(or body '(t))))))
 
-(defalias 'if-let*   #'if-let)
-(defalias 'when-let* #'when-let)
-(defalias 'and-let*  #'and-let)
+(defmacro if-let (spec then &rest else)
+  "Bind variables according to SPEC and eval THEN or ELSE.
+Like `if-let*' except SPEC can have the form (SYMBOL VALUEFORM)."
+  (declare (indent 2)
+           (debug ([&or (&rest [&or symbolp (symbolp form) (form)])
+                        (symbolp form)]
+                   form body))
+           (obsolete "use `if-let*' instead." "26.1"))
+  (when (and (<= (length spec) 2)
+             (not (listp (car spec))))
+    ;; Adjust the single binding case
+    (setq spec (list spec)))
+  (list 'if-let* spec then (macroexp-progn else)))
+
+(defmacro when-let (spec &rest body)
+  "Bind variables according to SPEC and conditionally eval BODY.
+Like `when-let*' except SPEC can have the form (SYMBOL VALUEFORM)."
+  (declare (indent 1) (debug if-let)
+           (obsolete "use `when-let*' instead." "26.1"))
+  (list 'if-let spec (macroexp-progn body)))
 
 (defsubst hash-table-empty-p (hash-table)
   "Check whether HASH-TABLE is empty (has 0 elements)."
diff --git a/test/lisp/emacs-lisp/subr-x-tests.el b/test/lisp/emacs-lisp/subr-x-tests.el
index a361718c9e..c9618f3c37 100644
--- a/test/lisp/emacs-lisp/subr-x-tests.el
+++ b/test/lisp/emacs-lisp/subr-x-tests.el
@@ -28,13 +28,13 @@
 (require 'subr-x)
 
 
-;; `if-let' tests
+;; `if-let*' tests
 
-(ert-deftest subr-x-test-if-let-single-binding-expansion ()
+(ert-deftest subr-x-test-if-let*-single-binding-expansion ()
   "Test single bindings are expanded properly."
   (should (equal
            (macroexpand
-            '(if-let ((a 1))
+            '(if-let* ((a 1))
                  (- a)
                "no"))
            '(let* ((a (and t 1)))
@@ -43,7 +43,7 @@
                 "no"))))
   (should (equal
            (macroexpand
-            '(if-let (a)
+            '(if-let* (a)
                  (- a)
                "no"))
            '(let* ((a (and t a)))
@@ -51,11 +51,11 @@
                   (- a)
                 "no")))))
 
-(ert-deftest subr-x-test-if-let-single-symbol-expansion ()
+(ert-deftest subr-x-test-if-let*-single-symbol-expansion ()
   "Test single symbol bindings are expanded properly."
   (should (equal
            (macroexpand
-            '(if-let (a)
+            '(if-let* (a)
                  (- a)
                "no"))
            '(let* ((a (and t a)))
@@ -64,7 +64,7 @@
                 "no"))))
   (should (equal
            (macroexpand
-            '(if-let (a b c)
+            '(if-let* (a b c)
                  (- a)
                "no"))
            '(let* ((a (and t a))
@@ -75,7 +75,7 @@
                 "no"))))
   (should (equal
            (macroexpand
-            '(if-let (a (b 2) c)
+            '(if-let* (a (b 2) c)
                  (- a)
                "no"))
            '(let* ((a (and t a))
@@ -85,11 +85,11 @@
                   (- a)
                 "no")))))
 
-(ert-deftest subr-x-test-if-let-nil-related-expansion ()
+(ert-deftest subr-x-test-if-let*-nil-related-expansion ()
   "Test nil is processed properly."
   (should (equal
            (macroexpand
-            '(if-let (nil)
+            '(if-let* (nil)
                  (- a)
                "no"))
            '(let* ((nil (and t nil)))
@@ -98,7 +98,7 @@
                 "no"))))
   (should (equal
            (macroexpand
-            '(if-let ((a 1) nil (b 2))
+            '(if-let* ((a 1) nil (b 2))
                  (- a)
                "no"))
            '(let* ((a (and t 1))
@@ -108,106 +108,106 @@
                   (- a)
                 "no")))))
 
-(ert-deftest subr-x-test-if-let-malformed-binding ()
+(ert-deftest subr-x-test-if-let*-malformed-binding ()
   "Test malformed bindings trigger errors."
   (should-error (macroexpand
-                 '(if-let (_ (a 1 1) (b 2) (c 3) d)
+                 '(if-let* (_ (a 1 1) (b 2) (c 3) d)
                       (- a)
                     "no"))
                 :type 'error)
   (should-error (macroexpand
-                 '(if-let (_ (a 1) (b 2 2) (c 3) d)
+                 '(if-let* (_ (a 1) (b 2 2) (c 3) d)
                       (- a)
                     "no"))
                 :type 'error)
   (should-error (macroexpand
-                 '(if-let (_ (a 1) (b 2) (c 3 3) d)
+                 '(if-let* (_ (a 1) (b 2) (c 3 3) d)
                       (- a)
                     "no"))
                 :type 'error)
   (should-error (macroexpand
-                 '(if-let ((a 1 1))
+                 '(if-let* ((a 1 1))
                       (- a)
                     "no"))
                 :type 'error))
 
-(ert-deftest subr-x-test-if-let-true ()
+(ert-deftest subr-x-test-if-let*-true ()
   "Test `if-let' with truthy bindings."
   (should (equal
-           (if-let ((a 1))
+           (if-let* ((a 1))
                a
              "no")
            1))
   (should (equal
-           (if-let ((a 1) (b 2) (c 3))
+           (if-let* ((a 1) (b 2) (c 3))
                (list a b c)
              "no")
            (list 1 2 3))))
 
-(ert-deftest subr-x-test-if-let-false ()
+(ert-deftest subr-x-test-if-let*-false ()
   "Test `if-let' with falsie bindings."
   (should (equal
-           (if-let ((a nil))
+           (if-let* ((a nil))
                (list a b c)
              "no")
            "no"))
   (should (equal
-           (if-let ((a nil) (b 2) (c 3))
+           (if-let* ((a nil) (b 2) (c 3))
                (list a b c)
              "no")
            "no"))
   (should (equal
-           (if-let ((a 1) (b nil) (c 3))
+           (if-let* ((a 1) (b nil) (c 3))
                (list a b c)
              "no")
            "no"))
   (should (equal
-           (if-let ((a 1) (b 2) (c nil))
+           (if-let* ((a 1) (b 2) (c nil))
                (list a b c)
              "no")
            "no"))
   (should (equal
            (let (z)
-             (if-let (z (a 1) (b 2) (c 3))
+             (if-let* (z (a 1) (b 2) (c 3))
                  (list a b c)
                "no"))
            "no"))
   (should (equal
            (let (d)
-             (if-let ((a 1) (b 2) (c 3) d)
+             (if-let* ((a 1) (b 2) (c 3) d)
                  (list a b c)
                "no"))
            "no")))
 
-(ert-deftest subr-x-test-if-let-bound-references ()
+(ert-deftest subr-x-test-if-let*-bound-references ()
   "Test `if-let' bindings can refer to already bound symbols."
   (should (equal
-           (if-let ((a (1+ 0)) (b (1+ a)) (c (1+ b)))
+           (if-let* ((a (1+ 0)) (b (1+ a)) (c (1+ b)))
                (list a b c)
              "no")
            (list 1 2 3))))
 
-(ert-deftest subr-x-test-if-let-and-laziness-is-preserved ()
+(ert-deftest subr-x-test-if-let*-and-laziness-is-preserved ()
   "Test `if-let' respects `and' laziness."
   (let (a-called b-called c-called)
     (should (equal
-             (if-let ((a nil)
-                      (b (setq b-called t))
-                      (c (setq c-called t)))
+             (if-let* ((a nil)
+                       (b (setq b-called t))
+                       (c (setq c-called t)))
                  "yes"
                (list a-called b-called c-called))
              (list nil nil nil))))
   (let (a-called b-called c-called)
     (should (equal
-             (if-let ((a (setq a-called t))
-                      (b nil)
-                      (c (setq c-called t)))
+             (if-let* ((a (setq a-called t))
+                       (b nil)
+                       (c (setq c-called t)))
                  "yes"
                (list a-called b-called c-called))
              (list t nil nil))))
   (let (a-called b-called c-called)
     (should (equal
-             (if-let ((a (setq a-called t))
+             (if-let* ((a (setq a-called t))
                       (b (setq b-called t))
                       (c nil)
                       (d (setq c-called t)))
@@ -215,19 +215,14 @@
                (list a-called b-called c-called))
              (list t t nil)))))
 
-(defun if-let-single-tuple-case-test ()
-  "Test the BINDING-SPEC == (SYMBOL SOMETHING) case."
-  (should (equal (if-let (a 1) (1+ a)) 2))
-  (should (equal (let ((b 2)) (if-let (a b) a)) 2)))
-
 
-;; `when-let' tests
+;; `when-let*' tests
 
-(ert-deftest subr-x-test-when-let-body-expansion ()
+(ert-deftest subr-x-test-when-let*-body-expansion ()
   "Test body allows for multiple sexps wrapping with progn."
   (should (equal
            (macroexpand
-            '(when-let ((a 1))
+            '(when-let* ((a 1))
                (message "opposite")
                (- a)))
            '(let* ((a (and t 1)))
@@ -236,18 +231,18 @@
                     (message "opposite")
                     (- a)))))))
 
-(ert-deftest subr-x-test-when-let-single-symbol-expansion ()
+(ert-deftest subr-x-test-when-let*-single-symbol-expansion ()
   "Test single symbol bindings are expanded properly."
   (should (equal
            (macroexpand
-            '(when-let (a)
+            '(when-let* (a)
                (- a)))
            '(let* ((a (and t a)))
               (if a
                   (- a)))))
   (should (equal
            (macroexpand
-            '(when-let (a b c)
+            '(when-let* (a b c)
                (- a)))
            '(let* ((a (and t a))
                    (b (and a b))
@@ -256,7 +251,7 @@
                   (- a)))))
   (should (equal
            (macroexpand
-            '(when-let (a (b 2) c)
+            '(when-let* (a (b 2) c)
                (- a)))
            '(let* ((a (and t a))
                    (b (and a 2))
@@ -264,18 +259,18 @@
               (if c
                   (- a))))))
 
-(ert-deftest subr-x-test-when-let-nil-related-expansion ()
+(ert-deftest subr-x-test-when-let*-nil-related-expansion ()
   "Test nil is processed properly."
   (should (equal
            (macroexpand
-            '(when-let (nil)
+            '(when-let* (nil)
                (- a)))
            '(let* ((nil (and t nil)))
               (if nil
                   (- a)))))
   (should (equal
            (macroexpand
-            '(when-let ((a 1) nil (b 2))
+            '(when-let* ((a 1) nil (b 2))
                (- a)))
            '(let* ((a (and t 1))
                    (nil (and a nil))
@@ -283,178 +278,173 @@
               (if b
                   (- a))))))
 
-(ert-deftest subr-x-test-when-let-malformed-binding ()
+(ert-deftest subr-x-test-when-let*-malformed-binding ()
   "Test malformed bindings trigger errors."
   (should-error (macroexpand
-                 '(when-let (_ (a 1 1) (b 2) (c 3) d)
+                 '(when-let* (_ (a 1 1) (b 2) (c 3) d)
                     (- a)))
                 :type 'error)
   (should-error (macroexpand
-                 '(when-let (_ (a 1) (b 2 2) (c 3) d)
+                 '(when-let* (_ (a 1) (b 2 2) (c 3) d)
                     (- a)))
                 :type 'error)
   (should-error (macroexpand
-                 '(when-let (_ (a 1) (b 2) (c 3 3) d)
+                 '(when-let* (_ (a 1) (b 2) (c 3 3) d)
                     (- a)))
                 :type 'error)
   (should-error (macroexpand
-                 '(when-let ((a 1 1))
+                 '(when-let* ((a 1 1))
                     (- a)))
                 :type 'error))
 
-(ert-deftest subr-x-test-when-let-true ()
+(ert-deftest subr-x-test-when-let*-true ()
   "Test `when-let' with truthy bindings."
   (should (equal
-           (when-let ((a 1))
+           (when-let* ((a 1))
              a)
            1))
   (should (equal
-           (when-let ((a 1) (b 2) (c 3))
+           (when-let* ((a 1) (b 2) (c 3))
              (list a b c))
            (list 1 2 3))))
 
-(ert-deftest subr-x-test-when-let-false ()
+(ert-deftest subr-x-test-when-let*-false ()
   "Test `when-let' with falsie bindings."
   (should (equal
-           (when-let ((a nil))
+           (when-let* ((a nil))
              (list a b c)
              "no")
            nil))
   (should (equal
-           (when-let ((a nil) (b 2) (c 3))
+           (when-let* ((a nil) (b 2) (c 3))
              (list a b c)
              "no")
            nil))
   (should (equal
-           (when-let ((a 1) (b nil) (c 3))
+           (when-let* ((a 1) (b nil) (c 3))
              (list a b c)
              "no")
            nil))
   (should (equal
-           (when-let ((a 1) (b 2) (c nil))
+           (when-let* ((a 1) (b 2) (c nil))
              (list a b c)
              "no")
            nil))
   (should (equal
            (let (z)
-             (when-let (z (a 1) (b 2) (c 3))
+             (when-let* (z (a 1) (b 2) (c 3))
                (list a b c)
                "no"))
            nil))
   (should (equal
            (let (d)
-             (when-let ((a 1) (b 2) (c 3) d)
+             (when-let* ((a 1) (b 2) (c 3) d)
                (list a b c)
                "no"))
            nil)))
 
-(ert-deftest subr-x-test-when-let-bound-references ()
+(ert-deftest subr-x-test-when-let*-bound-references ()
   "Test `when-let' bindings can refer to already bound symbols."
   (should (equal
-           (when-let ((a (1+ 0)) (b (1+ a)) (c (1+ b)))
+           (when-let* ((a (1+ 0)) (b (1+ a)) (c (1+ b)))
              (list a b c))
            (list 1 2 3))))
 
-(ert-deftest subr-x-test-when-let-and-laziness-is-preserved ()
+(ert-deftest subr-x-test-when-let*-and-laziness-is-preserved ()
   "Test `when-let' respects `and' laziness."
   (let (a-called b-called c-called)
     (should (equal
              (progn
-               (when-let ((a nil)
-                          (b (setq b-called t))
-                          (c (setq c-called t)))
+               (when-let* ((a nil)
+                           (b (setq b-called t))
+                           (c (setq c-called t)))
                  "yes")
                (list a-called b-called c-called))
              (list nil nil nil))))
   (let (a-called b-called c-called)
     (should (equal
              (progn
-               (when-let ((a (setq a-called t))
-                          (b nil)
-                          (c (setq c-called t)))
+               (when-let* ((a (setq a-called t))
+                           (b nil)
+                           (c (setq c-called t)))
                  "yes")
                (list a-called b-called c-called))
              (list t nil nil))))
   (let (a-called b-called c-called)
     (should (equal
              (progn
-               (when-let ((a (setq a-called t))
-                          (b (setq b-called t))
-                          (c nil)
-                          (d (setq c-called t)))
+               (when-let* ((a (setq a-called t))
+                           (b (setq b-called t))
+                           (c nil)
+                           (d (setq c-called t)))
                  "yes")
                (list a-called b-called c-called))
              (list t t nil)))))
 
-(defun when-let-single-tuple-case-test ()
-  "Test the BINDING-SPEC == (SYMBOL SOMETHING) case."
-  (should (equal (when-let (a 1) (1+ a)) 2))
-  (should (equal (let ((b 2)) (when-let (a b) a)) 2)))
-
 
-;; `and-let' tests
+;; `and-let*' tests
 
 ;; Adapted from the Guile tests
 ;; https://git.savannah.gnu.org/cgit/guile.git/tree/test-suite/tests/srfi-2.test
 
-(ert-deftest subr-x-and-let-test-empty-varlist ()
-  (should (equal 1 (and-let () 1)))
-  (should (equal 2 (and-let () 1 2)))
-  (should (equal t (and-let ()))))
+(ert-deftest subr-x-and-let*-test-empty-varlist ()
+  (should (equal 1 (and-let* () 1)))
+  (should (equal 2 (and-let* () 1 2)))
+  (should (equal t (and-let* ()))))
 
-(ert-deftest subr-x-and-let-test-group-1 ()
-   (should (equal nil (let ((x nil)) (and-let (x)))))
-   (should (equal 1 (let ((x 1)) (and-let (x)))))
-   (should (equal nil (and-let ((x nil)))))
-   (should (equal 1 (and-let ((x 1)))))
+(ert-deftest subr-x-and-let*-test-group-1 ()
+   (should (equal nil (let ((x nil)) (and-let* (x)))))
+   (should (equal 1 (let ((x 1)) (and-let* (x)))))
+   (should (equal nil (and-let* ((x nil)))))
+   (should (equal 1 (and-let* ((x 1)))))
    ;; The error doesn't trigger when compiled: the compiler will give
    ;; a warning and then drop the erroneous code.  Therefore, use
    ;; `eval' to avoid compilation.
-   (should-error (eval '(and-let (nil (x 1))) lexical-binding)
+   (should-error (eval '(and-let* (nil (x 1))) lexical-binding)
                  :type 'setting-constant)
-   (should (equal nil (and-let ((nil) (x 1)))))
-   (should-error (eval '(and-let (2 (x 1))) lexical-binding)
+   (should (equal nil (and-let* ((nil) (x 1)))))
+   (should-error (eval '(and-let* (2 (x 1))) lexical-binding)
                  :type 'wrong-type-argument)
-   (should (equal 1 (and-let ((2) (x 1)))))
-   (should (equal 2 (and-let ((x 1) (2)))))
-   (should (equal nil (let ((x nil)) (and-let (x) x))))
-   (should (equal "" (let ((x "")) (and-let (x) x))))
-   (should (equal "" (let ((x "")) (and-let (x)))))
-   (should (equal 2 (let ((x 1)) (and-let (x) (+ x 1)))))
-   (should (equal nil (let ((x nil)) (and-let (x) (+ x 1)))))
-   (should (equal 2 (let ((x 1)) (and-let (((> x 0))) (+ x 1)))))
-   (should (equal t (let ((x 1)) (and-let (((> x 0)))))))
-   (should (equal nil (let ((x 0)) (and-let (((> x 0))) (+ x 1)))))
+   (should (equal 1 (and-let* ((2) (x 1)))))
+   (should (equal 2 (and-let* ((x 1) (2)))))
+   (should (equal nil (let ((x nil)) (and-let* (x) x))))
+   (should (equal "" (let ((x "")) (and-let* (x) x))))
+   (should (equal "" (let ((x "")) (and-let* (x)))))
+   (should (equal 2 (let ((x 1)) (and-let* (x) (+ x 1)))))
+   (should (equal nil (let ((x nil)) (and-let* (x) (+ x 1)))))
+   (should (equal 2 (let ((x 1)) (and-let* (((> x 0))) (+ x 1)))))
+   (should (equal t (let ((x 1)) (and-let* (((> x 0)))))))
+   (should (equal nil (let ((x 0)) (and-let* (((> x 0))) (+ x 1)))))
    (should (equal 3
-                  (let ((x 1)) (and-let (((> x 0)) (x (+ x 1))) (+ x 1))))))
+                  (let ((x 1)) (and-let* (((> x 0)) (x (+ x 1))) (+ x 1))))))
 
-(ert-deftest subr-x-and-let-test-rebind ()
+(ert-deftest subr-x-and-let*-test-rebind ()
    (should
     (equal 4
            (let ((x 1))
-             (and-let (((> x 0)) (x (+ x 1)) (x (+ x 1))) (+ x 1))))))
+             (and-let* (((> x 0)) (x (+ x 1)) (x (+ x 1))) (+ x 1))))))
 
-(ert-deftest subr-x-and-let-test-group-2 ()
+(ert-deftest subr-x-and-let*-test-group-2 ()
    (should
-    (equal 2 (let ((x 1)) (and-let (x ((> x 0))) (+ x 1)))))
+    (equal 2 (let ((x 1)) (and-let* (x ((> x 0))) (+ x 1)))))
    (should
-    (equal 2 (let ((x 1)) (and-let (((progn x)) ((> x 0))) (+ x 1)))))
-   (should (equal nil (let ((x 0)) (and-let (x ((> x 0))) (+ x 1)))))
-   (should (equal nil (let ((x nil)) (and-let (x ((> x 0))) (+ x 1)))))
+    (equal 2 (let ((x 1)) (and-let* (((progn x)) ((> x 0))) (+ x 1)))))
+   (should (equal nil (let ((x 0)) (and-let* (x ((> x 0))) (+ x 1)))))
+   (should (equal nil (let ((x nil)) (and-let* (x ((> x 0))) (+ x 1)))))
    (should
-    (equal nil (let ((x nil)) (and-let (((progn x)) ((> x 0))) (+ x 1))))))
+    (equal nil (let ((x nil)) (and-let* (((progn x)) ((> x 0))) (+ x 1))))))
 
-(ert-deftest subr-x-and-let-test-group-3 ()
+(ert-deftest subr-x-and-let*-test-group-3 ()
    (should
-    (equal nil (let ((x 1)) (and-let (x (y (- x 1)) ((> y 0))) (/ x y)))))
+    (equal nil (let ((x 1)) (and-let* (x (y (- x 1)) ((> y 0))) (/ x y)))))
    (should
-    (equal nil (let ((x 0)) (and-let (x (y (- x 1)) ((> y 0))) (/ x y)))))
+    (equal nil (let ((x 0)) (and-let* (x (y (- x 1)) ((> y 0))) (/ x y)))))
    (should
     (equal nil
-           (let ((x nil)) (and-let (x (y (- x 1)) ((> y 0))) (/ x y)))))
+           (let ((x nil)) (and-let* (x (y (- x 1)) ((> y 0))) (/ x y)))))
    (should
     (equal (/ 3.0 2)
-           (let ((x 3.0)) (and-let (x (y (- x 1)) ((> y 0))) (/ x y))))))
+           (let ((x 3.0)) (and-let* (x (y (- x 1)) ((> y 0))) (/ x y))))))
 
 
 
-- 
2.21.0


From b94ea2b0943df174af4c70b91799a5dd8387b54f Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Tue, 6 Mar 2018 15:07:15 -0500
Subject: [PATCH 114/297] Obsolete eshell-cmpl-suffix-list

* lisp/eshell/em-cmpl.el (eshell-cmpl-suffix-list):
Make obsolete, to match pcomplete-suffix-list.
---
 lisp/eshell/em-cmpl.el | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/lisp/eshell/em-cmpl.el b/lisp/eshell/em-cmpl.el
index fe34d9546a..a9b29aef4c 100644
--- a/lisp/eshell/em-cmpl.el
+++ b/lisp/eshell/em-cmpl.el
@@ -167,6 +167,9 @@ to writing a completion function."
   (eshell-cmpl--custom-variable-docstring 'pcomplete-suffix-list)
   :type (get 'pcomplete-suffix-list 'custom-type)
   :group 'pcomplete)
+;; Only labelled obsolete in 26.1, but all it does it set
+;; pcomplete-suffix-list, which is itself obsolete since 24.1.
+(make-obsolete-variable 'eshell-cmpl-suffix-list nil "24.1")
 
 (defcustom eshell-cmpl-recexact nil
   (eshell-cmpl--custom-variable-docstring 'pcomplete-recexact)
-- 
2.21.0


From f54e15a22b5e6e7df0c80a78848d7ed0d1c021c4 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Tue, 6 Mar 2018 20:13:51 -0500
Subject: [PATCH 115/297] Replace some obsolete aliases in documentation

* doc/emacs/text.texi (Nroff Mode):
* doc/misc/efaq.texi (How to add fonts):
* lisp/gnus/nnheader.el (nnheader-insert-file-contents):
* lisp/progmodes/pascal.el (pascal-outline-mode):
Doc fixes re obsolete aliases.
; * src/frame.c (do_switch_frame): Comment.
---
 doc/emacs/text.texi      | 16 ++++++++--------
 doc/misc/efaq.texi       |  2 +-
 lisp/gnus/nnheader.el    |  2 +-
 lisp/progmodes/pascal.el |  2 +-
 src/frame.c              |  2 +-
 5 files changed, 12 insertions(+), 12 deletions(-)

diff --git a/doc/emacs/text.texi b/doc/emacs/text.texi
index 8137945601..012c73d8db 100644
--- a/doc/emacs/text.texi
+++ b/doc/emacs/text.texi
@@ -2067,27 +2067,27 @@ hook @code{text-mode-hook}, then @code{nroff-mode-hook}
 separators, pages are separated by @samp{.bp} commands, and comments
 start with backslash-doublequote.  It also defines these commands:
 
-@findex forward-text-line
-@findex backward-text-line
-@findex count-text-lines
+@findex nroff-forward-text-line
+@findex nroff-backward-text-line
+@findex nroff-count-text-lines
 @kindex M-n @r{(Nroff mode)}
 @kindex M-p @r{(Nroff mode)}
 @kindex M-? @r{(Nroff mode)}
 @table @kbd
 @item M-n
 Move to the beginning of the next line that isn't an nroff command
-(@code{forward-text-line}).  An argument is a repeat count.
+(@code{nroff-forward-text-line}).  An argument is a repeat count.
 @item M-p
-Like @kbd{M-n} but move up (@code{backward-text-line}).
+Like @kbd{M-n} but move up (@code{nroff-backward-text-line}).
 @item M-?
 Displays in the echo area the number of text lines (lines that are not
-nroff commands) in the region (@code{count-text-lines}).
+nroff commands) in the region (@code{nroff-count-text-lines}).
 @end table
 
-@findex electric-nroff-mode
+@findex nroff-electric-mode
   Electric Nroff mode is a buffer-local minor mode that can be used
 with Nroff mode.  To toggle this minor mode, type @kbd{M-x
-electric-nroff-mode} (@pxref{Minor Modes}).  When the mode is on, each
+nroff-electric-mode} (@pxref{Minor Modes}).  When the mode is on, each
 time you type @key{RET} to end a line containing an nroff command that
 opens a kind of grouping, the nroff command to close that grouping is
 automatically inserted on the following line.
diff --git a/doc/misc/efaq.texi b/doc/misc/efaq.texi
index c05e2eac8a..b980e569fc 100644
--- a/doc/misc/efaq.texi
+++ b/doc/misc/efaq.texi
@@ -4288,7 +4288,7 @@ fontset, or you can select it by setting the default font in your
 @file{~/.emacs}:
 
 @lisp
-  (set-default-font "fontset-bdf")
+  (set-frame-font "fontset-bdf")
 @end lisp
 
 
diff --git a/lisp/gnus/nnheader.el b/lisp/gnus/nnheader.el
index 14bd14924f..77afb09a2a 100644
--- a/lisp/gnus/nnheader.el
+++ b/lisp/gnus/nnheader.el
@@ -945,7 +945,7 @@ first.  Otherwise, find the newest one, though it may take a time."
   "Like `insert-file-contents', q.v., but only reads in the file.
 A buffer may be modified in several ways after reading into the buffer due
 to advanced Emacs features, such as file-name-handlers, format decoding,
-find-file-hooks, etc.
+find-file-hook, etc.
   This function ensures that none of these modifications will take place."
   (let ((coding-system-for-read nnheader-file-coding-system))
     (mm-insert-file-contents filename visit beg end replace)))
diff --git a/lisp/progmodes/pascal.el b/lisp/progmodes/pascal.el
index 83f15d495b..737dd9ea8a 100644
--- a/lisp/progmodes/pascal.el
+++ b/lisp/progmodes/pascal.el
@@ -1425,7 +1425,7 @@ Pascal Outline mode provides some additional commands.
 \\[pascal-show-all]\t- Show the whole buffer.
 \\[pascal-hide-other-defuns]\
 \t- Hide everything but the current function (function under the cursor).
-\\[pascal-outline]\t- Leave Pascal Outline mode."
+\\[pascal-outline-mode]\t- Leave Pascal Outline mode."
   :init-value nil :lighter " Outl" :keymap pascal-outline-map
   (add-to-invisibility-spec '(pascal . t))
   (unless pascal-outline-mode
diff --git a/src/frame.c b/src/frame.c
index 33df48cf9d..2f0e962a30 100644
--- a/src/frame.c
+++ b/src/frame.c
@@ -1318,7 +1318,7 @@ do_switch_frame (Lisp_Object frame, int track, int for_deletion, Lisp_Object nor
   /* We want to make sure that the next event generates a frame-switch
      event to the appropriate frame.  This seems kludgy to me, but
      before you take it out, make sure that evaluating something like
-     (select-window (frame-root-window (new-frame))) doesn't end up
+     (select-window (frame-root-window (make-frame))) doesn't end up
      with your typing being interpreted in the new frame instead of
      the one you're actually typing in.  */
 #ifdef HAVE_WINDOW_SYSTEM
-- 
2.21.0


From 3085bdd17249e5b41d8d2b2dddd157008f09b7c9 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Tue, 6 Mar 2018 20:16:52 -0500
Subject: [PATCH 116/297] Replace some obsolete aliases in code

* lisp/emulation/viper.el (viper-set-hooks):
* lisp/epa-hook.el (auto-encryption-mode):
* lisp/term/pc-win.el (set-frame-font): Replace obsolete aliases.
* lisp/net/quickurl.el (quickurl--assoc-function): New.
(quickurl-assoc-function): Use it.
---
 lisp/emulation/viper.el | 2 +-
 lisp/epa-hook.el        | 2 +-
 lisp/net/quickurl.el    | 7 ++++++-
 lisp/term/pc-win.el     | 2 +-
 4 files changed, 9 insertions(+), 4 deletions(-)

diff --git a/lisp/emulation/viper.el b/lisp/emulation/viper.el
index 13a88ad11f..c8eca30e88 100644
--- a/lisp/emulation/viper.el
+++ b/lisp/emulation/viper.el
@@ -902,7 +902,7 @@ Two differences:
   (viper-setup-ESC-to-escape t)
 
   (add-hook 'change-major-mode-hook #'viper-major-mode-change-sentinel)
-  (add-hook 'find-file-hooks #'set-viper-state-in-major-mode)
+  (add-hook 'find-file-hook #'set-viper-state-in-major-mode)
 
   ;; keep this because many modes we don't know about use this hook
   (defvar text-mode-hook)
diff --git a/lisp/epa-hook.el b/lisp/epa-hook.el
index d99a3ef51a..135c956c3f 100644
--- a/lisp/epa-hook.el
+++ b/lisp/epa-hook.el
@@ -95,7 +95,7 @@ the mode if ARG is omitted or nil."
   :initialize 'custom-initialize-delay
   (setq file-name-handler-alist
 	(delq epa-file-handler file-name-handler-alist))
-  (remove-hook 'find-file-hooks 'epa-file-find-file-hook)
+  (remove-hook 'find-file-hook 'epa-file-find-file-hook)
   (setq auto-mode-alist (delq epa-file-auto-mode-alist-entry
 			      auto-mode-alist))
   (when auto-encryption-mode
diff --git a/lisp/net/quickurl.el b/lisp/net/quickurl.el
index 5321807cd6..abfca383e0 100644
--- a/lisp/net/quickurl.el
+++ b/lisp/net/quickurl.el
@@ -116,8 +116,13 @@
   :type  'function
   :group 'quickurl)
 
-(defcustom quickurl-assoc-function #'assoc-ignore-case
+(defun quickurl--assoc-function (key alist)
+  "Default function for `quickurl-assoc-function'."
+  (assoc-string key alist t))
+
+(defcustom quickurl-assoc-function #'quickurl--assoc-function
   "Function to use for alist lookup into `quickurl-urls'."
+  :version "26.1"                 ; was the obsolete assoc-ignore-case
   :type  'function
   :group 'quickurl)
 
diff --git a/lisp/term/pc-win.el b/lisp/term/pc-win.el
index 9c1b471d48..e0e412e162 100644
--- a/lisp/term/pc-win.el
+++ b/lisp/term/pc-win.el
@@ -272,7 +272,7 @@ Consult the selection.  Treat empty strings as if they were unset."
 (fset 'iconify-or-deiconify-frame 'ignore)
 
 ;; From lisp/frame.el
-(fset 'set-default-font 'ignore)
+(fset 'set-frame-font 'ignore)
 (fset 'set-mouse-color 'ignore)		; We cannot, I think.
 (fset 'set-cursor-color 'ignore)	; Hardware determined by char under.
 (fset 'set-border-color 'ignore)	; Not useful.
-- 
2.21.0


From b8cb4ab2c9578c2a535e2d5723379f548b08c41a Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Tue, 6 Mar 2018 20:18:54 -0500
Subject: [PATCH 117/297] Remove some unused spam.el variables

* lisp/gnus/spam.el (spam-ifile-path, spam-ifile-database-path)
(spam-bogofilter-path, spam-bsfilter-path)
(spam-spamassassin-path, spam-sa-learn-path):
Remove variables that are described as obsolete, but are
really completely unused, and have been for years.
---
 lisp/gnus/spam.el | 12 ------------
 1 file changed, 12 deletions(-)

diff --git a/lisp/gnus/spam.el b/lisp/gnus/spam.el
index de8aa77efc..71a69cb5f0 100644
--- a/lisp/gnus/spam.el
+++ b/lisp/gnus/spam.el
@@ -408,16 +408,12 @@ Only meaningful if you enable `spam-use-regex-body'."
   "Spam ifile configuration."
   :group 'spam)
 
-(make-obsolete-variable 'spam-ifile-path 'spam-ifile-program
-                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-ifile-program (executable-find "ifile")
   "Name of the ifile program."
   :type '(choice (file :tag "Location of ifile")
                  (const :tag "ifile is not installed"))
   :group 'spam-ifile)
 
-(make-obsolete-variable 'spam-ifile-database-path 'spam-ifile-database
-                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-ifile-database nil
   "File name of the ifile database."
   :type '(choice (file :tag "Location of the ifile database")
@@ -447,8 +443,6 @@ your main source of newsgroup names."
   "Spam bogofilter configuration."
   :group 'spam)
 
-(make-obsolete-variable 'spam-bogofilter-path 'spam-bogofilter-program
-                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-bogofilter-program (executable-find "bogofilter")
   "Name of the Bogofilter program."
   :type '(choice (file :tag "Location of bogofilter")
@@ -499,8 +493,6 @@ When nil, use the default location."
   "Spam bsfilter configuration."
   :group 'spam)
 
-(make-obsolete-variable 'spam-bsfilter-path 'spam-bsfilter-program
-                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-bsfilter-program (executable-find "bsfilter")
   "Name of the Bsfilter program."
   :type '(choice (file :tag "Location of bsfilter")
@@ -565,8 +557,6 @@ When nil, use the default spamoracle database."
   "Spam SpamAssassin configuration."
   :group 'spam)
 
-(make-obsolete-variable 'spam-spamassassin-path
-  'spam-spamassassin-program "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-assassin-program (executable-find "spamassassin")
   "Name of the spamassassin program.
 Hint: set this to \"spamc\" if you have spamd running.  See the spamc and
@@ -597,8 +587,6 @@ identification"
   :type 'string
   :group 'spam-spamassassin)
 
-(make-obsolete-variable 'spam-sa-learn-path 'spam-sa-learn-program
-                        "Gnus 5.10.9 (Emacs 22.1)")
 (defcustom spam-sa-learn-program (executable-find "sa-learn")
   "Name of the sa-learn program."
   :type '(choice (file :tag "Location of spamassassin")
-- 
2.21.0


From 8717bc90642cf8385ac50b2da741630705d22d84 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Wed, 7 Mar 2018 21:02:24 +0200
Subject: [PATCH 118/297] Minor copyedits in display.texi

* doc/emacs/display.texi (Highlight Interactively)
(Useless Whitespace, Line Truncation, Visual Line Mode): Minor
changes of wording and typo corrections.  Suggested by Michael
Albinus <michael.albinus@gmx.de> in emacs-manual-bugs@gnu.org.
---
 doc/emacs/display.texi | 21 +++++++++++----------
 1 file changed, 11 insertions(+), 10 deletions(-)

diff --git a/doc/emacs/display.texi b/doc/emacs/display.texi
index 312f70e13b..3a0116a745 100644
--- a/doc/emacs/display.texi
+++ b/doc/emacs/display.texi
@@ -971,7 +971,7 @@ version.)
 Highlight text that matches @var{regexp} using face @var{face}
 (@code{highlight-regexp}).  The highlighting will remain as long as
 the buffer is loaded.  For example, to highlight all occurrences of
-the word ``whim'' using the default face (a yellow background)
+the word ``whim'' using the default face (a yellow background), type
 @kbd{M-s h r whim @key{RET} @key{RET}}.  Any face can be used for
 highlighting, Hi Lock provides several of its own and these are
 pre-loaded into a list of default values.  While being prompted
@@ -1239,7 +1239,7 @@ and @code{newline-mark}.
 Highlight trailing whitespace.
 
 @item tabs
-Highlight tab characters.
+Highlight TAB characters.
 
 @item spaces
 Highlight space and non-breaking space characters.
@@ -1263,10 +1263,10 @@ highlighted.  To change that, customize the regular expression
 @code{whitespace-big-indent-regexp}.
 
 @item space-mark
-Draw space and non-breaking characters with a special glyph.
+Draw SPC and non-breaking characters with a special glyph.
 
 @item tab-mark
-Draw tab characters with a special glyph.
+Draw TAB characters with a special glyph.
 
 @item newline-mark
 Draw newline characters with a special glyph.
@@ -1649,8 +1649,8 @@ Emacs can display long lines by @dfn{truncation}.  This means that all
 the characters that do not fit in the width of the screen or window do
 not appear at all.  On graphical displays, a small straight arrow in
 the fringe indicates truncation at either end of the line.  On text
-terminals, this is indicated with @samp{$} signs in the leftmost
-and/or rightmost columns.
+terminals, this is indicated with @samp{$} signs in the rightmost
+and/or leftmost columns.
 
 @vindex truncate-lines
 @findex toggle-truncate-lines
@@ -1676,8 +1676,9 @@ line truncation.  @xref{Split Window}, for the variable
 @dfn{word wrap}.  Here, each long logical line is divided into two or
 more screen lines, like in ordinary line continuation.  However, Emacs
 attempts to wrap the line at word boundaries near the right window
-edge.  This makes the text easier to read, as wrapping does not occur
-in the middle of words.
+edge.  (If line's direction is right-to-left, it is wrapped at the
+left window edge instead.)  This makes the text easier to read, as
+wrapping does not occur in the middle of words.
 
 @cindex mode, Visual Line
 @cindex Visual Line mode
@@ -1688,8 +1689,8 @@ To turn on Visual Line mode in the current buffer, type @kbd{M-x
 visual-line-mode}; repeating this command turns it off.  You can also
 turn on Visual Line mode using the menu bar: in the Options menu,
 select the @samp{Line Wrapping in this Buffer} submenu, followed by
-the @samp{Word Wrap (Visual Line Mode)} menu item.  While Visual Line
-mode is enabled, the mode-line shows the string @samp{wrap} in the
+the @samp{Word Wrap (Visual Line mode)} menu item.  While Visual Line
+mode is enabled, the mode line shows the string @samp{wrap} in the
 mode display.  The command @kbd{M-x global-visual-line-mode} toggles
 Visual Line mode in all buffers.
 
-- 
2.21.0


From 519d486824f05be5d4912d738c733f4cedc47bb1 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Wed, 7 Mar 2018 21:51:59 +0200
Subject: [PATCH 119/297] Minor improvements in manuals

* doc/lispref/variables.texi (Local Variables): Make more clear
that local bindings of 'let' are in effect only within the body.
Suggested by Marcin Borkowski <mbork@mbork.pl>, see
http://lists.gnu.org/archive/html/emacs-devel/2018-03/msg00217.html
for the details.

* doc/emacs/programs.texi (Matching): Fix a typo.  Reported by
Alex Branham <alex.branham@gmail.com> in emacs-manual-bugs@gnu.org.
Improve indexing.
---
 doc/emacs/programs.texi    | 6 +++++-
 doc/lispref/variables.texi | 5 +++--
 2 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/doc/emacs/programs.texi b/doc/emacs/programs.texi
index c39df692ad..e1e4b4e295 100644
--- a/doc/emacs/programs.texi
+++ b/doc/emacs/programs.texi
@@ -814,11 +814,13 @@ options which control the operation of this mode include:
 
 @itemize @bullet
 @item
-@code{show-paren-highlight-open-paren} controls whether to highlight
+@vindex show-paren-highlight-openparen
+@code{show-paren-highlight-openparen} controls whether to highlight
 an open paren when point stands just before it, and hence its position
 is marked by the cursor anyway.  The default is non-@code{nil} (yes).
 
 @item
+@vindex show-paren-style
 @code{show-paren-style} controls whether just the two parens, or also
 the space between them get highlighted.  The valid options here are
 @code{parenthesis} (show the matching paren), @code{expression}
@@ -827,10 +829,12 @@ the space between them get highlighted.  The valid options here are
 expression otherwise).
 
 @item
+@vindex show-paren-when-point-inside-paren
 @code{show-paren-when-point-inside-paren}, when non-@code{nil}, causes
 highlighting also when point is on the inside of a parenthesis.
 
 @item
+@vindex show-paren-when-point-in-periphery
 @code{show-paren-when-point-in-periphery}, when non-@code{nil}, causes
 highlighting also when point is in whitespace at the beginning or end
 of a line, and there is a paren at, respectively, the first or last,
diff --git a/doc/lispref/variables.texi b/doc/lispref/variables.texi
index 203838d9d8..55bca5edcc 100644
--- a/doc/lispref/variables.texi
+++ b/doc/lispref/variables.texi
@@ -165,7 +165,7 @@ receive local values, which are the actual arguments supplied to the
 function call; these local bindings take effect within the body of the
 function.  To take another example, the @code{let} special form
 explicitly establishes local bindings for specific variables, which
-take effect within the body of the @code{let} form.
+take effect only within the body of the @code{let} form.
 
   We also speak of the @dfn{global binding}, which is where
 (conceptually) the global value is kept.
@@ -204,7 +204,8 @@ bindings:
 This special form sets up local bindings for a certain set of
 variables, as specified by @var{bindings}, and then evaluates all of
 the @var{forms} in textual order.  Its return value is the value of
-the last form in @var{forms}.
+the last form in @var{forms}.  The local bindings set up by @code{let}
+will be in effect only within the body of @var{forms}.
 
 Each of the @var{bindings} is either @w{(i) a} symbol, in which case
 that symbol is locally bound to @code{nil}; or @w{(ii) a} list of the
-- 
2.21.0


From 1959d6e7b915c015a2f192fea478693d0af529f3 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Wed, 7 Mar 2018 15:41:29 -0500
Subject: [PATCH 120/297] Replace some obsolete aliases in documentation

* doc/misc/efaq-w32.texi (Incoming mail with Rmail):
* doc/misc/speedbar.texi (Major Display Modes):
* lisp/mh-e/mh-folder.el (mh-restore-desktop-buffer):
Doc fixes re obsolete aliases.
; * lisp/autoinsert.el (auto-insert):
; * lisp/ffap.el (ffap-newfile-prompt):
; * lisp/woman.el (woman-insert-file-contents): Comment fixes.
---
 doc/misc/efaq-w32.texi | 4 ++--
 doc/misc/speedbar.texi | 8 ++++----
 lisp/autoinsert.el     | 2 +-
 lisp/ffap.el           | 2 +-
 lisp/mh-e/mh-folder.el | 2 +-
 lisp/woman.el          | 4 ++--
 6 files changed, 11 insertions(+), 11 deletions(-)

diff --git a/doc/misc/efaq-w32.texi b/doc/misc/efaq-w32.texi
index aef64ead7c..3a4acbc5d9 100644
--- a/doc/misc/efaq-w32.texi
+++ b/doc/misc/efaq-w32.texi
@@ -1588,7 +1588,7 @@ non-@code{nil}, you should set it to @code{nil}:
 @cindex movemail, using pop3
 @cindex MAILHOST
 @vindex rmail-primary-inbox-list
-@vindex rmail-pop-password-required
+@vindex rmail-remote-password-required
 
 For incoming mail using the Rmail package and a POP3 server, you will
 need the following configuration:
@@ -1596,7 +1596,7 @@ need the following configuration:
 @example
 (setenv "MAILHOST" "@var{domain.name.of.your.pop3.server}")
 (setq rmail-primary-inbox-list '("po:@var{your logon id}"))
-(setq rmail-pop-password-required t)
+(setq rmail-remote-password-required t)
 @end example
 
 @node Incoming mail with Gnus
diff --git a/doc/misc/speedbar.texi b/doc/misc/speedbar.texi
index 1c1b014f54..d67c4e6145 100644
--- a/doc/misc/speedbar.texi
+++ b/doc/misc/speedbar.texi
@@ -979,8 +979,8 @@ With a numeric argument (@kbd{C-u}), flush cached data before expanding.
 Contract the item under the cursor.
 @end table
 
-@cindex @code{speedbar-line-path}
-These function require that function @code{speedbar-line-path} be
+@cindex @code{speedbar-line-directory}
+These functions require that the function @code{speedbar-line-directory} be
 correctly overloaded to work.
 
 Next, register your extension like this;
@@ -1013,14 +1013,14 @@ like this:
 (speedbar-add-mode-functions-list
  '("MYEXTENSION"
    (speedbar-item-info . MyExtension-speedbar-item-info)
-   (speedbar-line-path . MyExtension-speedbar-line-path)))
+   (speedbar-line-directory . MyExtension-speedbar-line-directory)))
 @end example
 
 The first element in the list is the name of you extension.  The second
 is an alist of functions to overload.  The function to overload is
 first, followed by what you want called instead.
 
-For @code{speedbar-line-path} your function should take an optional DEPTH
+For @code{speedbar-line-directory} your function should take an optional DEPTH
 parameter.  This is the starting depth for heavily indented lines.  If
 it is not provided, you can derive it like this:
 
diff --git a/lisp/autoinsert.el b/lisp/autoinsert.el
index 53586c5418..7858041440 100644
--- a/lisp/autoinsert.el
+++ b/lisp/autoinsert.el
@@ -386,7 +386,7 @@ Matches the visited file name against the elements of `auto-insert-alist'."
 	      (not (eq this-command 'auto-insert))
 	      (set-buffer-modified-p (eq auto-insert t)))))
   ;; Return nil so that it could be used in
-  ;; `find-file-not-found-hooks', though that's probably inadvisable.
+  ;; `find-file-not-found-functions', though that's probably inadvisable.
   nil)
 
 
diff --git a/lisp/ffap.el b/lisp/ffap.el
index 4e479d1b82..22be2f8536 100644
--- a/lisp/ffap.el
+++ b/lisp/ffap.el
@@ -248,7 +248,7 @@ it passes it on to `dired'."
 
 (defcustom ffap-newfile-prompt nil
   ;; Suggestion from RHOGEE, 11 Jul 1994.  Disabled, I think this is
-  ;; better handled by `find-file-not-found-hooks'.
+  ;; better handled by `find-file-not-found-functions'.
   "Whether `find-file-at-point' prompts about a nonexistent file."
   :type 'boolean
   :group 'ffap)
diff --git a/lisp/mh-e/mh-folder.el b/lisp/mh-e/mh-folder.el
index 23cc2baab7..82e28e8741 100644
--- a/lisp/mh-e/mh-folder.el
+++ b/lisp/mh-e/mh-folder.el
@@ -88,7 +88,7 @@ the MH mail system."
 When desktop creates a buffer, DESKTOP-BUFFER-FILE-NAME holds the
 file name to visit, DESKTOP-BUFFER-NAME holds the desired buffer
 name, and DESKTOP-BUFFER-MISC holds a list of miscellaneous info
-used by the `desktop-buffer-handlers' functions."
+used by the `desktop-buffer-mode-handlers' functions."
   (mh-find-path)
   (mh-visit-folder desktop-buffer-name)
   (current-buffer))
diff --git a/lisp/woman.el b/lisp/woman.el
index 1a603dba2f..c83a04874a 100644
--- a/lisp/woman.el
+++ b/lisp/woman.el
@@ -1759,8 +1759,8 @@ Leave point at end of new text.  Return length of inserted text."
 	   (condition-case ()
 	       (insert-file-contents filename nil)
 	     (file-error
-	      ;; Run find-file-not-found-hooks until one returns non-nil.
-	      ;; (run-hook-with-args-until-success 'find-file-not-found-hooks)
+	      ;; Run find-file-not-found-functions until one returns non-nil.
+	      ;; (run-hook-with-args-until-success 'find-file-not-found-functions)
 	      (insert "\n***** File " filename " not found! *****\n\n")))))))
 
 
-- 
2.21.0


From 9e2987a507aff5fe35ef2bfe317a4c9cee2bb3a5 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Wed, 7 Mar 2018 15:44:08 -0500
Subject: [PATCH 121/297] Replace some obsolete aliases in code

* lisp/net/eudc-bob.el (eudc-bob-mail-keymap):
* lisp/textmodes/reftex-toc.el (reftex-make-separate-toc-frame):
Replace obsolete aliases.
---
 lisp/net/eudc-bob.el         | 2 +-
 lisp/textmodes/reftex-toc.el | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/lisp/net/eudc-bob.el b/lisp/net/eudc-bob.el
index 57b748b150..584d1a9d0d 100644
--- a/lisp/net/eudc-bob.el
+++ b/lisp/net/eudc-bob.el
@@ -312,7 +312,7 @@ display a button."
 	(define-key map [return] 'goto-address-at-point)
 	(define-key map (if (featurep 'xemacs)
 			    [button2]
-			  [down-mouse-2]) 'goto-address-at-mouse)
+			  [down-mouse-2]) 'goto-address-at-point)
 	map))
 
 (set-keymap-parent eudc-bob-image-keymap eudc-bob-generic-keymap)
diff --git a/lisp/textmodes/reftex-toc.el b/lisp/textmodes/reftex-toc.el
index 6637da4b14..9c158a5f56 100644
--- a/lisp/textmodes/reftex-toc.el
+++ b/lisp/textmodes/reftex-toc.el
@@ -1096,7 +1096,7 @@ always show the current section in connection with the option
       (when (eq reftex-auto-recenter-toc 'frame)
         (unless reftex-toc-auto-recenter-timer
           (reftex-toggle-auto-toc-recenter))
-        (add-hook 'delete-frame-hook 'reftex-toc-delete-frame-hook)))))
+        (add-hook 'delete-frame-functions 'reftex-toc-delete-frame-hook)))))
 
 (defun reftex-toc-delete-frame-hook (frame)
   (if (and reftex-toc-auto-recenter-timer
-- 
2.21.0


From e32573b9068aea0a113bcadda46b8d9b264da6a2 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Thu, 8 Mar 2018 17:53:09 +0200
Subject: [PATCH 122/297] More minor changes in the manual

* doc/emacs/display.texi (Useless Whitespace): Don't upcase "TAB"
and "SPC" when alluding to characters.  Suggested by Richard
Stallman <rms@gnu.org>.

* doc/emacs/buffers.texi (Misc Buffer): Clarify what "read-only"
means for buffers.
(Buffers): Define and describe "buffer contents".  Suggested by
Richard Stallman <rms@gnu.org>.  (Bug#30685)
---
 doc/emacs/buffers.texi | 22 +++++++++++++++-------
 doc/emacs/display.texi |  4 ++--
 2 files changed, 17 insertions(+), 9 deletions(-)

diff --git a/doc/emacs/buffers.texi b/doc/emacs/buffers.texi
index f8c1856058..dd7a653186 100644
--- a/doc/emacs/buffers.texi
+++ b/doc/emacs/buffers.texi
@@ -32,6 +32,13 @@ buffer.  When there is only one Emacs window, the buffer displayed in
 that window is current.  When there are multiple windows, the buffer
 displayed in the @dfn{selected window} is current.  @xref{Windows}.
 
+@cindex buffer contents
+@cindex contents of a buffer
+  A buffer's @dfn{contents} consist of a series of characters, each of
+which optionally carries a set of text properties
+(@pxref{International Chars, Text properties}) that can specify more
+information about that character.
+
   Aside from its textual contents, each buffer records several pieces
 of information, such as what file it is visiting (if any), whether it
 is modified, and what major mode and minor modes are in effect
@@ -231,13 +238,14 @@ Scroll through buffer @var{buffer}.  @xref{View Mode}.
 @kindex C-x C-q
 @vindex buffer-read-only
 @cindex read-only buffer
-  A buffer can be @dfn{read-only}, which means that commands to change
-its contents are not allowed.  The mode line indicates read-only
-buffers with @samp{%%} or @samp{%*} near the left margin.  @xref{Mode
-Line}.  Read-only buffers are usually made by subsystems such as Dired
-and Rmail that have special commands to operate on the text.  Visiting
-a file whose access control says you cannot write it also makes the
-buffer read-only.
+  A buffer can be @dfn{read-only}, which means that commands to insert
+or delete its text are not allowed.  (However, other commands, like
+@kbd{C-x @key{RET} f}, can still mark it as modified, @pxref{Text
+Coding}).  The mode line indicates read-only buffers with @samp{%%} or
+@samp{%*} near the left margin.  @xref{Mode Line}.  Read-only buffers
+are usually made by subsystems such as Dired and Rmail that have
+special commands to operate on the text.  Visiting a file whose access
+control says you cannot write it also makes the buffer read-only.
 
 @findex read-only-mode
 @vindex view-read-only
diff --git a/doc/emacs/display.texi b/doc/emacs/display.texi
index 3a0116a745..ad3221463a 100644
--- a/doc/emacs/display.texi
+++ b/doc/emacs/display.texi
@@ -1258,7 +1258,7 @@ Highlight empty lines.
 @item big-indent
 @vindex whitespace-big-indent-regexp
 Highlight too-deep indentation.  By default any sequence of at least 4
-consecutive TAB characters or 32 consecutive SPC characters is
+consecutive tab characters or 32 consecutive space characters is
 highlighted.  To change that, customize the regular expression
 @code{whitespace-big-indent-regexp}.
 
@@ -1266,7 +1266,7 @@ highlighted.  To change that, customize the regular expression
 Draw SPC and non-breaking characters with a special glyph.
 
 @item tab-mark
-Draw TAB characters with a special glyph.
+Draw tab characters with a special glyph.
 
 @item newline-mark
 Draw newline characters with a special glyph.
-- 
2.21.0


From 524a721f1fec0bcbaa1898b414b0e3d4b973e4f6 Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Thu, 8 Mar 2018 17:08:47 +0100
Subject: [PATCH 123/297] Minor change in the manual

* doc/emacs/display.texi (Useless Whitespace):
Don't upcase "TAB" and "SPC" when alluding to characters.
---
 doc/emacs/display.texi | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/doc/emacs/display.texi b/doc/emacs/display.texi
index ad3221463a..499be26004 100644
--- a/doc/emacs/display.texi
+++ b/doc/emacs/display.texi
@@ -1239,7 +1239,7 @@ and @code{newline-mark}.
 Highlight trailing whitespace.
 
 @item tabs
-Highlight TAB characters.
+Highlight tab characters.
 
 @item spaces
 Highlight space and non-breaking space characters.
@@ -1263,7 +1263,7 @@ highlighted.  To change that, customize the regular expression
 @code{whitespace-big-indent-regexp}.
 
 @item space-mark
-Draw SPC and non-breaking characters with a special glyph.
+Draw space and non-breaking characters with a special glyph.
 
 @item tab-mark
 Draw tab characters with a special glyph.
-- 
2.21.0


From 97499c9cd7de905edd91202cc41d320b10a44cbb Mon Sep 17 00:00:00 2001
From: "Charles A. Roelli" <charles@aurox.ch>
Date: Thu, 8 Mar 2018 20:45:47 +0100
Subject: [PATCH 124/297] Add to "Completion Commands" Info node

* doc/emacs/mini.texi (Completion Commands): Mention other keys
for 'next-completion' and 'previous-completion', and explain 'q'
and 'z' which are relatively new additions.
---
 doc/emacs/mini.texi | 20 ++++++++++++++++----
 1 file changed, 16 insertions(+), 4 deletions(-)

diff --git a/doc/emacs/mini.texi b/doc/emacs/mini.texi
index 8278de7f31..5d67535b6f 100644
--- a/doc/emacs/mini.texi
+++ b/doc/emacs/mini.texi
@@ -359,14 +359,26 @@ While in the completion list buffer, this chooses the completion at
 point (@code{choose-completion}).
 
 @findex next-completion
+@item @key{TAB}
 @item @key{RIGHT}
-While in the completion list buffer, this moves point to the following
-completion alternative (@code{next-completion}).
+While in the completion list buffer, these keys move point to the
+following completion alternative (@code{next-completion}).
 
 @findex previous-completion
+@item @key{S-TAB}
 @item @key{LEFT}
-While in the completion list buffer, this moves point to the previous
-completion alternative (@code{previous-completion}).
+While in the completion list buffer, these keys move point to the
+previous completion alternative (@code{previous-completion}).
+
+@findex quit-window
+@item @kbd{q}
+While in the completion list buffer, this quits the window showing it
+and selects the window showing the minibuffer (@code{quit-window}).
+
+@findex kill-current-buffer
+@item @kbd{z}
+While in the completion list buffer, kill it and delete the window
+showing it (@code{kill-current-buffer}).
 @end table
 
 @node Completion Exit
-- 
2.21.0


From 60362f51d185d14611eb0246af45f10eb39b3355 Mon Sep 17 00:00:00 2001
From: Juri Linkov <juri@linkov.net>
Date: Fri, 9 Mar 2018 00:29:04 +0200
Subject: [PATCH 125/297] * lisp/isearch.el (search-exit-option): Add option
 'append'.

(isearch-pre-command-hook): Use it.

* doc/emacs/search.texi: Replace search-exit-option option nil with append.

https://lists.gnu.org/archive/html/emacs-devel/2018-03/msg00202.html
---
 doc/emacs/search.texi |  2 +-
 lisp/isearch.el       | 13 +++++++++----
 2 files changed, 10 insertions(+), 5 deletions(-)

diff --git a/doc/emacs/search.texi b/doc/emacs/search.texi
index 0de3aee1b2..8ac9794c37 100644
--- a/doc/emacs/search.texi
+++ b/doc/emacs/search.texi
@@ -446,7 +446,7 @@ they are not themselves part of incremental search.
 search exits the search before executing the command.  Thus, the
 command operates on the buffer from which you invoked the search.
 However, if you customize the variable @code{search-exit-option} to
-@code{nil}, the characters which you type that are not interpreted by
+@code{append}, the characters which you type that are not interpreted by
 the incremental search are simply appended to the search string.  This
 is so you could include in the search string control characters, such
 as @kbd{C-a}, that would normally exit the search and invoke the
diff --git a/lisp/isearch.el b/lisp/isearch.el
index 96faa27c17..4f5f494875 100644
--- a/lisp/isearch.el
+++ b/lisp/isearch.el
@@ -77,11 +77,14 @@ If `shift-move', extend the search string by motion commands
 while holding down the shift key.
 Both `move' and `shift-move' extend the search string by yanking text
 that ends at the new position after moving point in the current buffer.
+If `append', the characters which you type that are not interpreted by
+the incremental search are simply appended to the search string.
 If nil, run the command without exiting Isearch."
   :type '(choice (const :tag "Terminate incremental search" t)
                  (const :tag "Edit the search string" edit)
                  (const :tag "Extend the search string by motion commands" move)
                  (const :tag "Extend the search string by shifted motion keys" shift-move)
+                 (const :tag "Append control characters to the search string" append)
                  (const :tag "Don't terminate incremental search" nil))
   :version "27.1")
 
@@ -2452,13 +2455,15 @@ See more for options in `search-exit-option'."
                this-command-keys-shift-translated))
       (setq this-command-keys-shift-translated nil)
       (setq isearch-pre-move-point (point)))
+     ;; Append control characters to the search string
+     ((eq search-exit-option 'append)
+      (when (cl-every #'characterp key)
+        (isearch-process-search-string key key))
+      (setq this-command 'ignore))
      ;; Other characters terminate the search and are then executed normally.
      (search-exit-option
       (isearch-done)
-      (isearch-clean-overlays))
-     ;; If search-exit-option is nil, run the command without exiting Isearch.
-     (t
-      (isearch-process-search-string key key)))))
+      (isearch-clean-overlays)))))
 
 (defun isearch-post-command-hook ()
   (cond
-- 
2.21.0


From fc7a043c5dbefab00dc7dc753461a929c705d3aa Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Thu, 8 Mar 2018 16:50:06 -0800
Subject: [PATCH 126/297] Update from Gnulib

This includes:
2018-03-08 fflush: be more paranoid about libio.h change
* lib/fpending.c: Copy from Gnulib.
---
 lib/fpending.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/lib/fpending.c b/lib/fpending.c
index 789f50e4e4..7bc235deda 100644
--- a/lib/fpending.c
+++ b/lib/fpending.c
@@ -32,7 +32,8 @@ __fpending (FILE *fp)
   /* Most systems provide FILE as a struct and the necessary bitmask in
      <stdio.h>, because they need it for implementing getc() and putc() as
      fast macros.  */
-#if defined _IO_EOF_SEEN || __GNU_LIBRARY__ == 1 /* GNU libc, BeOS, Haiku, Linux libc5 */
+#if defined _IO_EOF_SEEN || defined _IO_ftrylockfile || __GNU_LIBRARY__ == 1
+  /* GNU libc, BeOS, Haiku, Linux libc5 */
   return fp->_IO_write_ptr - fp->_IO_write_base;
 #elif defined __sferror || defined __DragonFly__ || defined __ANDROID__
   /* FreeBSD, NetBSD, OpenBSD, DragonFly, Mac OS X, Cygwin, Minix 3, Android */
-- 
2.21.0


From e51d1609525d8082ae2e49507218f238f00dbc50 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 8 Mar 2018 20:03:13 -0500
Subject: [PATCH 127/297] Replace uses of the obsolete local-write-file-hooks

* lisp/net/quickurl.el (quickurl-reread-hook-postfix):
* lisp/progmodes/ebrowse.el (ebrowse-tree-mode)
(ebrowse-write-file-hook-fn):
* lisp/progmodes/glasses.el (glasses-mode):
* lisp/progmodes/vhdl-mode.el (vhdl-write-file-hooks-init):
* lisp/vc/ediff-merg.el (ediff-set-merge-mode):
* lisp/vc/ediff-util.el (ediff-setup):
Replace local-write-file-hooks, obsolete since 22.1,
with write-file-functions.
---
 lisp/net/quickurl.el        | 2 +-
 lisp/progmodes/ebrowse.el   | 4 ++--
 lisp/progmodes/glasses.el   | 4 ++--
 lisp/progmodes/vhdl-mode.el | 4 ++--
 lisp/vc/ediff-merg.el       | 2 +-
 lisp/vc/ediff-util.el       | 2 +-
 6 files changed, 9 insertions(+), 9 deletions(-)

diff --git a/lisp/net/quickurl.el b/lisp/net/quickurl.el
index abfca383e0..a5ba26bcdc 100644
--- a/lisp/net/quickurl.el
+++ b/lisp/net/quickurl.el
@@ -155,7 +155,7 @@ could be used here."
 (defconst quickurl-reread-hook-postfix
     "
 ;; Local Variables:
-;; eval: (progn (require 'quickurl) (add-hook 'local-write-file-hooks (lambda () (quickurl-read) nil)))
+;; eval: (progn (require 'quickurl) (add-hook 'write-file-functions (lambda () (quickurl-read) nil) nil t))
 ;; End:
 "
   "Example `quickurl-postfix' text that adds a local variable to the
diff --git a/lisp/progmodes/ebrowse.el b/lisp/progmodes/ebrowse.el
index ca64af5c91..08b1acd4da 100644
--- a/lisp/progmodes/ebrowse.el
+++ b/lisp/progmodes/ebrowse.el
@@ -1107,7 +1107,7 @@ Tree mode key bindings:
          (and tree (ebrowse-build-tree-obarray tree)))
     (set (make-local-variable 'ebrowse--frozen-flag) nil)
 
-    (add-hook 'local-write-file-hooks 'ebrowse-write-file-hook-fn nil t)
+    (add-hook 'write-file-functions 'ebrowse-write-file-hook-fn nil t)
     (modify-syntax-entry ?_ (char-to-string (char-syntax ?a)))
     (when tree
       (ebrowse-redraw-tree)
@@ -4023,7 +4023,7 @@ If VIEW is non-nil, view else find source files."
 
 (defun ebrowse-write-file-hook-fn ()
   "Write current buffer as a class tree.
-Installed on `local-write-file-hooks'."
+Added to `write-file-functions'."
   (ebrowse-save-tree)
   t)
 
diff --git a/lisp/progmodes/glasses.el b/lisp/progmodes/glasses.el
index de176019a5..c3e8ac35f3 100644
--- a/lisp/progmodes/glasses.el
+++ b/lisp/progmodes/glasses.el
@@ -326,10 +326,10 @@ add virtual separators (like underscores) at places they belong to."
       (if glasses-mode
 	  (progn
 	    (jit-lock-register 'glasses-change)
-	    (add-hook 'local-write-file-hooks
+	    (add-hook 'write-file-functions
 		      'glasses-convert-to-unreadable nil t))
 	(jit-lock-unregister 'glasses-change)
-	(remove-hook 'local-write-file-hooks
+	(remove-hook 'write-file-functions
 		     'glasses-convert-to-unreadable t)))))
 
 
diff --git a/lisp/progmodes/vhdl-mode.el b/lisp/progmodes/vhdl-mode.el
index a841f87f3c..f6cb2419de 100644
--- a/lisp/progmodes/vhdl-mode.el
+++ b/lisp/progmodes/vhdl-mode.el
@@ -4953,8 +4953,8 @@ Key bindings:
 (defun vhdl-write-file-hooks-init ()
   "Add/remove hooks when buffer is saved."
   (if vhdl-modify-date-on-saving
-      (add-hook 'local-write-file-hooks 'vhdl-template-modify-noerror nil t)
-    (remove-hook 'local-write-file-hooks 'vhdl-template-modify-noerror t))
+      (add-hook 'write-file-functions 'vhdl-template-modify-noerror nil t)
+    (remove-hook 'write-file-functions 'vhdl-template-modify-noerror t))
   (if (featurep 'xemacs) (make-local-hook 'after-save-hook))
   (add-hook 'after-save-hook 'vhdl-add-modified-file nil t))
 
diff --git a/lisp/vc/ediff-merg.el b/lisp/vc/ediff-merg.el
index ad72d7570c..b67f520ca0 100644
--- a/lisp/vc/ediff-merg.el
+++ b/lisp/vc/ediff-merg.el
@@ -194,7 +194,7 @@ Buffer B."
 
 (defun ediff-set-merge-mode ()
   (normal-mode t)
-  (remove-hook 'local-write-file-hooks 'ediff-set-merge-mode))
+  (remove-hook 'write-file-functions 'ediff-set-merge-mode t))
 
 
 ;; Go over all diffs starting with DIFF-NUM and copy regions into buffer C
diff --git a/lisp/vc/ediff-util.el b/lisp/vc/ediff-util.el
index 8670ba4603..be36273592 100644
--- a/lisp/vc/ediff-util.el
+++ b/lisp/vc/ediff-util.el
@@ -347,7 +347,7 @@ to invocation.")
 	      (goto-char (point-min))
 	      (funcall (ediff-with-current-buffer buf major-mode))
 	      (widen) ; merge buffer is always widened
-	      (add-hook 'local-write-file-hooks 'ediff-set-merge-mode nil t)
+	      (add-hook 'write-file-functions 'ediff-set-merge-mode nil t)
 	      )))
       (setq buffer-read-only nil
 	    ediff-buffer-A buffer-A
-- 
2.21.0


From c2772fdfa4079f17a8f65b9a6acb8ae3bed7e3cc Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Thu, 8 Mar 2018 20:55:55 -0800
Subject: [PATCH 128/297] Avoid losing info when formatting integers

* doc/lispref/numbers.texi (Integer Basics): Clarify that
out-of-range integers are treated as floating point only when the
integers are decimal.
* etc/NEWS: Mention changes.
* src/editfns.c (styled_format): Use %.0f when formatting %d or %i
values outside machine integer range, to avoid losing info.
Signal an error for %o or %x values that are too large to be
formatted, to avoid losing info.
---
 doc/lispref/numbers.texi |  5 ++-
 etc/NEWS                 |  7 +++
 src/editfns.c            | 96 +++++++++++++++++-----------------------
 3 files changed, 51 insertions(+), 57 deletions(-)

diff --git a/doc/lispref/numbers.texi b/doc/lispref/numbers.texi
index e692ee1cc2..f1180cf754 100644
--- a/doc/lispref/numbers.texi
+++ b/doc/lispref/numbers.texi
@@ -53,8 +53,9 @@ but many machines provide a wider range.  Many examples in this
 chapter assume the minimum integer width of 30 bits.
 @cindex overflow
 
-  The Lisp reader reads an integer as a sequence of digits with optional
-initial sign and optional final period.  An integer that is out of the
+  The Lisp reader reads an integer as a nonempty sequence
+of decimal digits with optional initial sign and optional
+final period.  A decimal integer that is out of the
 Emacs range is treated as a floating-point number.
 
 @example
diff --git a/etc/NEWS b/etc/NEWS
index dc05d8abb9..6d14fa9240 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -302,6 +302,10 @@ as new-style, bind the new variable 'force-new-style-backquotes' to t.
 'cl-struct-define' whose name clashes with a builtin type (e.g.,
 'integer' or 'hash-table') now signals an error.
 
+** When formatting a floating-point number as an octal or hexadecimal
+integer, Emacs now signals an error if the number is too large for the
+implementation to format (Bug#30408).
+
 
 * Lisp Changes in Emacs 27.1
 
@@ -343,6 +347,9 @@ remote systems, which support this check.
 If the optional third argument is non-nil, 'make-string' will produce
 a multibyte string even if its second argument is an ASCII character.
 
+** (format "%d" X) no longer mishandles a floating-point number X that
+does not fit in a machine integer (Bug#30408).
+
 ** New JSON parsing and serialization functions 'json-serialize',
 'json-insert', 'json-parse-string', and 'json-parse-buffer'.  These
 are implemented in C using the Jansson library.
diff --git a/src/editfns.c b/src/editfns.c
index 21b8f6104f..4271a01fb3 100644
--- a/src/editfns.c
+++ b/src/editfns.c
@@ -2867,32 +2867,30 @@ styled_format (ptrdiff_t nargs, Lisp_Object *args, bool message)
 		 and with pM inserted for integer formats.
 		 At most two flags F can be specified at once.  */
 	      char convspec[sizeof "%FF.*d" + max (INT_AS_LDBL, pMlen)];
-	      {
-		char *f = convspec;
-		*f++ = '%';
-		/* MINUS_FLAG and ZERO_FLAG are dealt with later.  */
-		*f = '+'; f +=  plus_flag;
-		*f = ' '; f += space_flag;
-		*f = '#'; f += sharp_flag;
-                *f++ = '.';
-                *f++ = '*';
-		if (float_conversion)
-		  {
-		    if (INT_AS_LDBL)
-		      {
-			*f = 'L';
-			f += INTEGERP (arg);
-		      }
-		  }
-		else if (conversion != 'c')
-		  {
-		    memcpy (f, pMd, pMlen);
-		    f += pMlen;
-		    zero_flag &= ! precision_given;
-		  }
-		*f++ = conversion;
-		*f = '\0';
-	      }
+	      char *f = convspec;
+	      *f++ = '%';
+	      /* MINUS_FLAG and ZERO_FLAG are dealt with later.  */
+	      *f = '+'; f +=  plus_flag;
+	      *f = ' '; f += space_flag;
+	      *f = '#'; f += sharp_flag;
+	      *f++ = '.';
+	      *f++ = '*';
+	      if (float_conversion)
+		{
+		  if (INT_AS_LDBL)
+		    {
+		      *f = 'L';
+		      f += INTEGERP (arg);
+		    }
+		}
+	      else if (conversion != 'c')
+		{
+		  memcpy (f, pMd, pMlen);
+		  f += pMlen;
+		  zero_flag &= ! precision_given;
+		}
+	      *f++ = conversion;
+	      *f = '\0';
 
 	      int prec = -1;
 	      if (precision_given)
@@ -2934,29 +2932,20 @@ styled_format (ptrdiff_t nargs, Lisp_Object *args, bool message)
 		}
 	      else if (conversion == 'd' || conversion == 'i')
 		{
-		  /* For float, maybe we should use "%1.0f"
-		     instead so it also works for values outside
-		     the integer range.  */
-		  printmax_t x;
 		  if (INTEGERP (arg))
-		    x = XINT (arg);
+		    {
+		      printmax_t x = XINT (arg);
+		      sprintf_bytes = sprintf (sprintf_buf, convspec, prec, x);
+		    }
 		  else
 		    {
-		      double d = XFLOAT_DATA (arg);
-		      if (d < 0)
-			{
-			  x = TYPE_MINIMUM (printmax_t);
-			  if (x < d)
-			    x = d;
-			}
-		      else
-			{
-			  x = TYPE_MAXIMUM (printmax_t);
-			  if (d < x)
-			    x = d;
-			}
+		      strcpy (f - pMlen - 1, "f");
+		      double x = XFLOAT_DATA (arg);
+		      sprintf_bytes = sprintf (sprintf_buf, convspec, 0, x);
+		      char c0 = sprintf_buf[0];
+		      bool signedp = ! ('0' <= c0 && c0 <= '9');
+		      prec = min (precision, sprintf_bytes - signedp);
 		    }
-		  sprintf_bytes = sprintf (sprintf_buf, convspec, prec, x);
 		}
 	      else
 		{
@@ -2967,22 +2956,19 @@ styled_format (ptrdiff_t nargs, Lisp_Object *args, bool message)
 		  else
 		    {
 		      double d = XFLOAT_DATA (arg);
-		      if (d < 0)
-			x = 0;
-		      else
-			{
-			  x = TYPE_MAXIMUM (uprintmax_t);
-			  if (d < x)
-			    x = d;
-			}
+		      double uprintmax = TYPE_MAXIMUM (uprintmax_t);
+		      if (! (0 <= d && d < uprintmax + 1))
+			xsignal1 (Qoverflow_error, arg);
+		      x = d;
 		    }
 		  sprintf_bytes = sprintf (sprintf_buf, convspec, prec, x);
 		}
 
 	      /* Now the length of the formatted item is known, except it omits
 		 padding and excess precision.  Deal with excess precision
-		 first.  This happens only when the format specifies
-		 ridiculously large precision.  */
+		 first.  This happens when the format specifies ridiculously
+		 large precision, or when %d or %i formats a float that would
+		 ordinarily need fewer digits than a specified precision.  */
 	      ptrdiff_t excess_precision
 		= precision_given ? precision - prec : 0;
 	      ptrdiff_t leading_zeros = 0, trailing_zeros = 0;
-- 
2.21.0


From 2bb8466c69b0eaa2b63ee82808de40c52df7a07f Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Fri, 9 Mar 2018 15:04:59 -0500
Subject: [PATCH 129/297] Quieten compilation of some test/lisp files

* test/lisp/dired-tests.el (dired-test-bug27243-02)
(dired-test-bug27243-03, dired-test-bug27899)
(dired-test-with-temp-dirs): Remove unused local variables.
* test/lisp/hi-lock-tests.el (hi-lock-bug26666)
(hi-lock-test-set-pattern): Mark unused arguments.
* test/lisp/ses-tests.el (ses-tests-renamed-cells-row-insertion):
Remove unused global "ses-tests-trigger".
* test/lisp/simple-tests.el (line-number-at-pos-when-passing-point):
Remove unused local "pos".
* test/lisp/emacs-lisp/benchmark-tests.el (benchmark-tests):
Pacify compiler.
* test/lisp/emacs-lisp/package-tests.el (package-test-signed):
Replace obsolete function epg-configuration.
* test/lisp/ls-lisp-tests.el:
* test/lisp/eshell/em-ls-tests.el: Require dired.
* test/lisp/progmodes/ruby-mode-tests.el
(ruby-forward-sexp-skips-method-calls-with-keyword-names):
* test/lisp/vc/diff-mode-tests.el
(diff-mode-test-ignore-trailing-dashes): Replace interactive funcs.
---
 test/lisp/dired-tests.el                | 23 +++++++++++------------
 test/lisp/emacs-lisp/benchmark-tests.el | 14 ++++++++------
 test/lisp/emacs-lisp/package-tests.el   |  4 ++--
 test/lisp/eshell/em-ls-tests.el         |  1 +
 test/lisp/hi-lock-tests.el              |  4 ++--
 test/lisp/ls-lisp-tests.el              |  1 +
 test/lisp/progmodes/ruby-mode-tests.el  |  6 ++++--
 test/lisp/ses-tests.el                  |  3 ---
 test/lisp/simple-tests.el               | 13 ++++++-------
 test/lisp/vc/diff-mode-tests.el         |  2 +-
 10 files changed, 36 insertions(+), 35 deletions(-)

diff --git a/test/lisp/dired-tests.el b/test/lisp/dired-tests.el
index 0284b9f0a4..78c09c8e69 100644
--- a/test/lisp/dired-tests.el
+++ b/test/lisp/dired-tests.el
@@ -211,12 +211,12 @@
                          (concat (file-name-as-directory test-dir)
                                  (file-name-as-directory "test-subdir"))))
           (push (dired-find-file) buffers)
-          (let ((pt2 (point)))          ; Point is on test-file.
-            (switch-to-buffer buf)
-            ;; Sanity check: point should now be back on the subdirectory.
-            (should (eq (point) pt1))
-            (push (dired test-dir) buffers)
-            (should (eq (point) pt1))))
+          ;; Point is on test-file.
+          (switch-to-buffer buf)
+          ;; Sanity check: point should now be back on the subdirectory.
+          (should (eq (point) pt1))
+          (push (dired test-dir) buffers)
+          (should (eq (point) pt1)))
       (dolist (buf buffers)
         (when (buffer-live-p buf) (kill-buffer buf)))
       (delete-directory test-dir t))))
@@ -225,7 +225,7 @@
   "Test for https://debbugs.gnu.org/cgi/bugreport.cgi?bug=27243#61 ."
   (let ((test-dir (make-temp-file "test-dir-" t))
         (dired-auto-revert-buffer t)
-        test-subdir1 test-subdir2 allbufs)
+        allbufs)
     (unwind-protect
         (progn
           (with-current-buffer (find-file-noselect test-dir)
@@ -295,9 +295,9 @@
 
 (ert-deftest dired-test-bug27899 ()
   "Test for https://debbugs.gnu.org/27899 ."
-  (let* ((dir (expand-file-name "src" source-directory))
-	 (buf (dired (list dir "cygw32.c" "alloc.c" "w32xfns.c" "xdisp.c")))
-         (orig dired-hide-details-mode))
+  (dired (list (expand-file-name "src" source-directory)
+               "cygw32.c" "alloc.c" "w32xfns.c" "xdisp.c"))
+  (let ((orig dired-hide-details-mode))
     (dired-goto-file (expand-file-name "cygw32.c"))
     (forward-line 0)
     (unwind-protect
@@ -363,8 +363,7 @@
 (defmacro dired-test-with-temp-dirs (just-empty-dirs &rest body)
   "Helper macro for Bug#27940 test."
   (declare (indent 1) (debug body))
-  (let ((dir (make-symbol "dir"))
-        (ignore-funcs (make-symbol "ignore-funcs")))
+  (let ((dir (make-symbol "dir")))
     `(let* ((,dir (make-temp-file "bug27940" t))
             (dired-deletion-confirmer (lambda (_) "yes")) ; Suppress prompts.
             (inhibit-message t)
diff --git a/test/lisp/emacs-lisp/benchmark-tests.el b/test/lisp/emacs-lisp/benchmark-tests.el
index 8de7818bdb..cba53aefc9 100644
--- a/test/lisp/emacs-lisp/benchmark-tests.el
+++ b/test/lisp/emacs-lisp/benchmark-tests.el
@@ -23,9 +23,9 @@
 (require 'ert)
 
 (ert-deftest benchmark-tests ()
-  (let (str t-long t-short)
-    (should (consp (benchmark-run nil (1+ 0))))
-    (should (consp (benchmark-run 1 (1+ 0))))
+  (let (str t-long t-short m)
+    (should (consp (benchmark-run nil (setq m (1+ 0)))))
+    (should (consp (benchmark-run 1 (setq m (1+ 0)))))
     (should (stringp (benchmark nil (1+ 0))))
     (should (stringp (benchmark 1 (1+ 0))))
     (should (consp (benchmark-run-compiled nil (1+ 0))))
@@ -33,10 +33,10 @@
     ;; First test is heavier, must need longer time.
     (should (> (car (benchmark-run nil
                       (let ((n 100000)) (while (> n 1) (setq n (1- n))))))
-               (car (benchmark-run nil (1+ 0)))))
+               (car (benchmark-run nil (setq m (1+ 0))))))
     (should (> (car (benchmark-run nil
                       (let ((n 100000)) (while (> n 1) (setq n (1- n))))))
-               (car (benchmark-run nil (1+ 0)))))
+               (car (benchmark-run nil (setq m (1+ 0))))))
     (should (> (car (benchmark-run-compiled nil
                       (let ((n 100000)) (while (> n 1) (setq n (1- n))))))
                (car (benchmark-run-compiled nil (1+ 0)))))
@@ -46,6 +46,8 @@
     (setq str (benchmark nil '(1+ 0)))
     (string-match "Elapsed time: \\([0-9.]+\\)" str)
     (setq t-short (string-to-number (match-string 1 str)))
-    (should (> t-long t-short))))
+    (should (> t-long t-short))
+    ;; Silence compiler.
+    m))
 
 ;;; benchmark-tests.el ends here.
diff --git a/test/lisp/emacs-lisp/package-tests.el b/test/lisp/emacs-lisp/package-tests.el
index 83f5228488..0059c546ac 100644
--- a/test/lisp/emacs-lisp/package-tests.el
+++ b/test/lisp/emacs-lisp/package-tests.el
@@ -473,8 +473,8 @@ Must called from within a `tar-mode' buffer."
 		       (let ((process-environment
 			      (cons (format "HOME=%s" homedir)
 				    process-environment)))
-			 (epg-check-configuration (epg-configuration))
-			 (epg-find-configuration 'OpenPGP))
+			 (epg-check-configuration
+                          (epg-find-configuration 'OpenPGP)))
 		     (delete-directory homedir t)))))
   (let* ((keyring (expand-file-name "key.pub" package-test-data-dir))
 	 (package-test-data-dir
diff --git a/test/lisp/eshell/em-ls-tests.el b/test/lisp/eshell/em-ls-tests.el
index 1ce832f1dc..c5c9eac324 100644
--- a/test/lisp/eshell/em-ls-tests.el
+++ b/test/lisp/eshell/em-ls-tests.el
@@ -26,6 +26,7 @@
 
 (require 'ert)
 (require 'em-ls)
+(require 'dired)
 
 (ert-deftest em-ls-test-bug27631 ()
   "Test for https://debbugs.gnu.org/27631 ."
diff --git a/test/lisp/hi-lock-tests.el b/test/lisp/hi-lock-tests.el
index 40d76ee9de..4c639b03dc 100644
--- a/test/lisp/hi-lock-tests.el
+++ b/test/lisp/hi-lock-tests.el
@@ -29,7 +29,7 @@
     (with-temp-buffer
       (insert "a A b B\n")
       (cl-letf (((symbol-function 'completing-read)
-                   (lambda (prompt coll x y z hist defaults)
+                   (lambda (_prompt _coll _x _y _z _hist defaults)
                      (car defaults))))
         (dotimes (_ 2)
           (let ((face (hi-lock-read-face-name)))
@@ -41,7 +41,7 @@
     (with-temp-buffer
       (insert "foo bar")
       (cl-letf (((symbol-function 'completing-read)
-                 (lambda (prompt coll x y z hist defaults)
+                 (lambda (_prompt _coll _x _y _z _hist defaults)
                    (car defaults))))
         (hi-lock-set-pattern "9999" (hi-lock-read-face-name)) ; No match
         (hi-lock-set-pattern "foo" (hi-lock-read-face-name)))
diff --git a/test/lisp/ls-lisp-tests.el b/test/lisp/ls-lisp-tests.el
index d16ffa3acd..91e8b0b701 100644
--- a/test/lisp/ls-lisp-tests.el
+++ b/test/lisp/ls-lisp-tests.el
@@ -26,6 +26,7 @@
 ;;; Code:
 (require 'ert)
 (require 'ls-lisp)
+(require 'dired)
 
 (ert-deftest ls-lisp-unload ()
   "Test for https://debbugs.gnu.org/xxxxx ."
diff --git a/test/lisp/progmodes/ruby-mode-tests.el b/test/lisp/progmodes/ruby-mode-tests.el
index b16698fba1..72d83affae 100644
--- a/test/lisp/progmodes/ruby-mode-tests.el
+++ b/test/lisp/progmodes/ruby-mode-tests.el
@@ -705,13 +705,15 @@ VALUES-PLIST is a list with alternating index and value elements."
 
 (ert-deftest ruby-forward-sexp-skips-method-calls-with-keyword-names ()
   (ruby-with-temp-buffer ruby-sexp-test-example
-    (goto-line 2)
+    (goto-char (point-min))
+    (forward-line 1)
     (ruby-forward-sexp)
     (should (= 8 (line-number-at-pos)))))
 
 (ert-deftest ruby-backward-sexp-skips-method-calls-with-keyword-names ()
   (ruby-with-temp-buffer ruby-sexp-test-example
-    (goto-line 8)
+    (goto-char (point-min))
+    (forward-line 7)
     (end-of-line)
     (ruby-backward-sexp)
     (should (= 2 (line-number-at-pos)))))
diff --git a/test/lisp/ses-tests.el b/test/lisp/ses-tests.el
index c9966e237f..d08237e285 100644
--- a/test/lisp/ses-tests.el
+++ b/test/lisp/ses-tests.el
@@ -147,13 +147,10 @@ to A2 and inserting a row, makes A2 value empty, and A3 equal to
       (should-not A2)
       (should (eq A3 2)))))
 
-; (defvar ses-tests-trigger nil)
-
 (ert-deftest ses-tests-renamed-cells-row-insertion ()
   "Check that setting A1 to 1 and A2 to (1+ A1), and then renaming A1 to `foo' and A2 to `bar' jumping
 to `bar' and inserting a row, makes A2 value empty, and `bar' equal to
 2."
-  (setq ses-tests-trigger nil)
   (let ((ses-initial-size '(2 . 1)))
     (with-temp-buffer
       (ses-mode)
diff --git a/test/lisp/simple-tests.el b/test/lisp/simple-tests.el
index 91fdd5e816..64b341bd46 100644
--- a/test/lisp/simple-tests.el
+++ b/test/lisp/simple-tests.el
@@ -489,13 +489,12 @@ See Bug#21722."
       (should (equal pos (point))))))
 
 (ert-deftest line-number-at-pos-when-passing-point ()
-  (let (pos)
-    (with-temp-buffer
-      (insert "a\nb\nc\nd\n")
-      (should (equal (line-number-at-pos 1) 1))
-      (should (equal (line-number-at-pos 3) 2))
-      (should (equal (line-number-at-pos 5) 3))
-      (should (equal (line-number-at-pos 7) 4)))))
+  (with-temp-buffer
+    (insert "a\nb\nc\nd\n")
+    (should (equal (line-number-at-pos 1) 1))
+    (should (equal (line-number-at-pos 3) 2))
+    (should (equal (line-number-at-pos 5) 3))
+    (should (equal (line-number-at-pos 7) 4))))
 
 
 ;;; Auto fill.
diff --git a/test/lisp/vc/diff-mode-tests.el b/test/lisp/vc/diff-mode-tests.el
index 1e35f9f7cd..7900e41b25 100644
--- a/test/lisp/vc/diff-mode-tests.el
+++ b/test/lisp/vc/diff-mode-tests.el
@@ -182,7 +182,7 @@ youthfulness
             (with-temp-buffer
               (cd temp-dir)
               (insert patch)
-              (beginning-of-buffer)
+              (goto-char (point-min))
               (diff-apply-hunk)
               (diff-apply-hunk)
               (diff-apply-hunk))
-- 
2.21.0


From d6e44ecaad9168ac881dc5d9af31b5fb81c1c6d6 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Fri, 9 Mar 2018 12:06:05 -0800
Subject: [PATCH 130/297] Fix string-to-number C-level mishandling

* src/sysdep.c (list_system_processes):
* src/xfaces.c (Finternal_set_lisp_face_attribute_from_resource):
Defend against Fstring_to_number returning a float or a nonsense
integer.
---
 src/sysdep.c | 6 +++++-
 src/xfaces.c | 2 +-
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/src/sysdep.c b/src/sysdep.c
index 370b452fc2..b91beaedb2 100644
--- a/src/sysdep.c
+++ b/src/sysdep.c
@@ -2948,7 +2948,11 @@ list_system_processes (void)
   for (tail = proclist; CONSP (tail); tail = next)
     {
       next = XCDR (tail);
-      XSETCAR (tail, Fstring_to_number (XCAR (tail), Qnil));
+      Lisp_Object pidstring = XCAR (tail);
+      Lisp_Object pid = Fstring_to_number (pidstring, Qnil);
+      if (!INTEGERP (pid) || XINT (pid) <= 0)
+	xsignal1 (Qoverflow_error, pidstring);
+      XSETCAR (tail, pid);
     }
 
   /* directory_files_internal returns the files in reverse order; undo
diff --git a/src/xfaces.c b/src/xfaces.c
index f538f2da9e..e34e3383bc 100644
--- a/src/xfaces.c
+++ b/src/xfaces.c
@@ -3347,7 +3347,7 @@ DEFUN ("internal-set-lisp-face-attribute-from-resource",
   else if (EQ (attr, QCheight))
     {
       value = Fstring_to_number (value, make_number (10));
-      if (XINT (value) <= 0)
+      if (!INTEGERP (value) || XINT (value) <= 0)
 	signal_error ("Invalid face height from X resource", value);
     }
   else if (EQ (attr, QCbold) || EQ (attr, QCitalic))
-- 
2.21.0


From dab12093361fb3cb453320c4fa09ee1e1814d348 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Fri, 9 Mar 2018 16:36:50 -0500
Subject: [PATCH 131/297] * test/lisp/vc/vc-tests.el (w32-application-type):
 Fix declaration.

---
 test/lisp/vc/vc-tests.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/test/lisp/vc/vc-tests.el b/test/lisp/vc/vc-tests.el
index c48fd448b4..ffab0ff456 100644
--- a/test/lisp/vc/vc-tests.el
+++ b/test/lisp/vc/vc-tests.el
@@ -109,7 +109,7 @@
 (require 'ert)
 (require 'vc)
 
-(declare-function w32-application-type "w32proc")
+(declare-function w32-application-type "w32proc.c")
 
 ;; The working horses.
 
-- 
2.21.0


From 0491b854b52dcfc048a56c756b9ed5ea624f71a6 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Fri, 9 Mar 2018 16:38:02 -0500
Subject: [PATCH 132/297] Quieten --without-json compilation of json-tests.el

* test/src/json-tests.el (json-serialize, json-insert)
(json-parse-string, json-parse-buffer): Declare.
---
 test/src/json-tests.el | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/test/src/json-tests.el b/test/src/json-tests.el
index 3bbf9eb96b..09067bad8c 100644
--- a/test/src/json-tests.el
+++ b/test/src/json-tests.el
@@ -26,6 +26,11 @@
 (require 'cl-lib)
 (require 'map)
 
+(declare-function json-serialize "json.c" (object))
+(declare-function json-insert "json.c" (object))
+(declare-function json-parse-string "json.c" (string &rest args))
+(declare-function json-parse-buffer "json.c" (&rest args))
+
 (define-error 'json-tests--error "JSON test error")
 
 (ert-deftest json-serialize/roundtrip ()
-- 
2.21.0


From 342751c620b78819fd16b7ae3c0a0dafd1a844d8 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Fri, 9 Mar 2018 16:39:51 -0500
Subject: [PATCH 133/297] * test/Makefile.in (check-declare): New PHONY rule.

---
 test/Makefile.in | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/test/Makefile.in b/test/Makefile.in
index a9650fdd39..ea053095d6 100644
--- a/test/Makefile.in
+++ b/test/Makefile.in
@@ -300,3 +300,9 @@ distclean: clean
 	rm -f Makefile
 
 maintainer-clean: distclean bootstrap-clean
+
+.PHONY: check-declare
+
+check-declare:
+	$(emacs) -l check-declare \
+	  --eval '(check-declare-directory "$(srcdir)")'
-- 
2.21.0


From a26400d1a7fa3c4a51a39144f1f2f003d2cbfd88 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Fri, 9 Mar 2018 16:40:43 -0500
Subject: [PATCH 134/297] * Makefile.in (check-declare): Also check test/
 directory.

---
 Makefile.in | 1 +
 1 file changed, 1 insertion(+)

diff --git a/Makefile.in b/Makefile.in
index 7a178004cd..95771e0193 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -1180,6 +1180,7 @@ check-declare:
 	  exit 1; \
 	fi
 	$(MAKE) -C lisp $@
+	$(MAKE) -C test $@
 
 .PHONY: rustfmt
 
-- 
2.21.0


From 657978eb29b8f192d7dc6a8aa78916f24794628d Mon Sep 17 00:00:00 2001
From: Aaron Jensen <aaronjensen@gmail.com>
Date: Sat, 10 Mar 2018 13:14:28 +0200
Subject: [PATCH 135/297] Allow underline position variables be buffer-local

* src/nsterm.m (ns_draw_text_decoration):
* src/w32term.c (x_draw_glyph_string):
* src/xterm.c (x_draw_glyph_string): Allow underline-minimum-offset,
underline-at-descent-line, and x-use-underline-position-properties
be buffer local variables.  (Bug#30553)
* src/xdisp.c (syms_of_xdisp) <underline-minimum-offset>: Add DEFSYM.
---
 src/nsterm.m  | 26 ++++++++++++++++++++++----
 src/w32term.c | 36 ++++++++++++++++++++++++++++++------
 src/xdisp.c   |  1 +
 src/xterm.c   | 37 ++++++++++++++++++++++++++++++-------
 4 files changed, 83 insertions(+), 17 deletions(-)

diff --git a/src/nsterm.m b/src/nsterm.m
index c6e11eca6d..b171a37567 100644
--- a/src/nsterm.m
+++ b/src/nsterm.m
@@ -3487,23 +3487,38 @@ Note that CURSOR_WIDTH is meaningful only for (h)bar cursors.
             {
 	      struct font *font = font_for_underline_metrics (s);
               unsigned long descent = s->y + s->height - s->ybase;
+              unsigned long minimum_offset;
+              BOOL underline_at_descent_line, use_underline_position_properties;
+              Lisp_Object val = buffer_local_value (Qunderline_minimum_offset,
+                                                    s->w->contents);
+              if (INTEGERP (val))
+                minimum_offset = XFASTINT (val);
+              else
+                minimum_offset = 1;
+              val = buffer_local_value (Qx_underline_at_descent_line,
+                                        s->w->contents);
+              underline_at_descent_line = !(NILP (val) || EQ (val, Qunbound));
+              val = buffer_local_value (Qx_use_underline_position_properties,
+                                        s->w->contents);
+              use_underline_position_properties =
+		!(NILP (val) || EQ (val, Qunbound));
 
               /* Use underline thickness of font, defaulting to 1. */
               thickness = (font && font->underline_thickness > 0)
                 ? font->underline_thickness : 1;
 
               /* Determine the offset of underlining from the baseline. */
-              if (x_underline_at_descent_line)
+              if (underline_at_descent_line)
                 position = descent - thickness;
-              else if (x_use_underline_position_properties
+              else if (use_underline_position_properties
                        && font && font->underline_position >= 0)
                 position = font->underline_position;
               else if (font)
                 position = lround (font->descent / 2);
               else
-                position = underline_minimum_offset;
+                position = minimum_offset;
 
-              position = max (position, underline_minimum_offset);
+              position = max (position, minimum_offset);
 
               /* Ensure underlining is not cropped. */
               if (descent <= position)
@@ -9465,6 +9480,8 @@ Nil means use fullscreen the old (< 10.7) way.  The old way works better with
 	       x_use_underline_position_properties,
      doc: /* SKIP: real doc in xterm.c.  */);
   x_use_underline_position_properties = 0;
+  DEFSYM (Qx_use_underline_position_properties,
+	  "x-use-underline-position-properties");
 
   DEFVAR_BOOL ("x-underline-at-descent-line",
 	       x_underline_at_descent_line,
@@ -9475,6 +9492,7 @@ Nil means use fullscreen the old (< 10.7) way.  The old way works better with
 variable `x-use-underline-position-properties', which is usually at the
 baseline level.  The default value is nil.  */);
   x_underline_at_descent_line = 0;
+  DEFSYM (Qx_underline_at_descent_line, "x-underline-at-descent-line");
 
   /* Tell Emacs about this window system.  */
   Fprovide (Qns, Qnil);
diff --git a/src/w32term.c b/src/w32term.c
index 23220d6027..acbcbac220 100644
--- a/src/w32term.c
+++ b/src/w32term.c
@@ -2475,31 +2475,52 @@ x_draw_glyph_string (struct glyph_string *s)
               else
                 {
 		  struct font *font = font_for_underline_metrics (s);
+		  unsigned long minimum_offset;
+		  BOOL underline_at_descent_line;
+		  BOOL use_underline_position_properties;
+		  Lisp_Object val
+		    = buffer_local_value (Qunderline_minimum_offset,
+					s->w->contents);
+		  if (INTEGERP (val))
+		    minimum_offset = XFASTINT (val);
+		  else
+		    minimum_offset = 1;
+		  val = buffer_local_value (Qx_underline_at_descent_line,
+					    s->w->contents);
+		  underline_at_descent_line
+		    = !(NILP (val) || EQ (val, Qunbound));
+		  val
+		    = buffer_local_value (Qx_use_underline_position_properties,
+					  s->w->contents);
+		  use_underline_position_properties
+		    = !(NILP (val) || EQ (val, Qunbound));
 
                   /* Get the underline thickness.  Default is 1 pixel.  */
                   if (font && font->underline_thickness > 0)
                     thickness = font->underline_thickness;
                   else
                     thickness = 1;
-                  if (x_underline_at_descent_line || !font)
+                  if (underline_at_descent_line
+                      || !font)
                     position = (s->height - thickness) - (s->ybase - s->y);
                   else
                     {
-                      /* Get the underline position.  This is the recommended
-                         vertical offset in pixels from the baseline to the top of
-                         the underline.  This is a signed value according to the
+                      /* Get the underline position.  This is the
+                         recommended vertical offset in pixels from
+                         the baseline to the top of the underline.
+                         This is a signed value according to the
                          specs, and its default is
 
                          ROUND ((maximum_descent) / 2), with
                          ROUND (x) = floor (x + 0.5)  */
 
-                      if (x_use_underline_position_properties
+                      if (use_underline_position_properties
                           && font->underline_position >= 0)
                         position = font->underline_position;
                       else
                         position = (font->descent + 1) / 2;
                     }
-                  position = max (position, underline_minimum_offset);
+                  position = max (position, minimum_offset);
                 }
               /* Check the sanity of thickness and position.  We should
                  avoid drawing underline out of the current line area.  */
@@ -7385,6 +7406,8 @@ the cursor have no effect.  */);
 	       x_use_underline_position_properties,
      doc: /* SKIP: real doc in xterm.c.  */);
   x_use_underline_position_properties = 0;
+  DEFSYM (Qx_use_underline_position_properties,
+	  "x-use-underline-position-properties");
 
   DEFVAR_BOOL ("x-underline-at-descent-line",
 	       x_underline_at_descent_line,
@@ -7395,6 +7418,7 @@ A value of nil means to draw the underline according to the value of the
 variable `x-use-underline-position-properties', which is usually at the
 baseline level.  The default value is nil.  */);
   x_underline_at_descent_line = 0;
+  DEFSYM (Qx_underline_at_descent_line, "x-underline-at-descent-line");
 
   DEFVAR_LISP ("x-toolkit-scroll-bars", Vx_toolkit_scroll_bars,
 	       doc: /* SKIP: real doc in xterm.c.  */);
diff --git a/src/xdisp.c b/src/xdisp.c
index 4b814dae41..a47bea87d2 100644
--- a/src/xdisp.c
+++ b/src/xdisp.c
@@ -33033,6 +33033,7 @@ particularly when using variable `x-use-underline-position-properties'
 with fonts that specify an UNDERLINE_POSITION relatively close to the
 baseline.  The default value is 1.  */);
   underline_minimum_offset = 1;
+  DEFSYM (Qunderline_minimum_offset, "underline-minimum-offset");
 
   DEFVAR_BOOL ("display-hourglass", display_hourglass_p,
 	       doc: /* Non-nil means show an hourglass pointer, when Emacs is busy.
diff --git a/src/xterm.c b/src/xterm.c
index a1ea60ec58..91ec742770 100644
--- a/src/xterm.c
+++ b/src/xterm.c
@@ -3397,33 +3397,53 @@ x_draw_glyph_string (struct glyph_string *s)
               else
                 {
 		  struct font *font = font_for_underline_metrics (s);
+		  unsigned long minimum_offset;
+		  bool underline_at_descent_line;
+		  bool use_underline_position_properties;
+		  Lisp_Object val
+		    = buffer_local_value (Qunderline_minimum_offset,
+					  s->w->contents);
+		  if (INTEGERP (val))
+		    minimum_offset = XFASTINT (val);
+		  else
+		    minimum_offset = 1;
+		  val = buffer_local_value (Qx_underline_at_descent_line,
+					    s->w->contents);
+		  underline_at_descent_line
+		    = !(NILP (val) || EQ (val, Qunbound));
+		  val
+		    = buffer_local_value (Qx_use_underline_position_properties,
+					  s->w->contents);
+		  use_underline_position_properties
+		    = !(NILP (val) || EQ (val, Qunbound));
 
                   /* Get the underline thickness.  Default is 1 pixel.  */
                   if (font && font->underline_thickness > 0)
                     thickness = font->underline_thickness;
                   else
                     thickness = 1;
-                  if (x_underline_at_descent_line)
+                  if (underline_at_descent_line)
                     position = (s->height - thickness) - (s->ybase - s->y);
                   else
                     {
-                      /* Get the underline position.  This is the recommended
-                         vertical offset in pixels from the baseline to the top of
-                         the underline.  This is a signed value according to the
+                      /* Get the underline position.  This is the
+                         recommended vertical offset in pixels from
+                         the baseline to the top of the underline.
+                         This is a signed value according to the
                          specs, and its default is
 
                          ROUND ((maximum descent) / 2), with
                          ROUND(x) = floor (x + 0.5)  */
 
-                      if (x_use_underline_position_properties
+                      if (use_underline_position_properties
                           && font && font->underline_position >= 0)
                         position = font->underline_position;
                       else if (font)
                         position = (font->descent + 1) / 2;
                       else
-                        position = underline_minimum_offset;
+                        position = minimum_offset;
                     }
-                  position = max (position, underline_minimum_offset);
+                  position = max (position, minimum_offset);
                 }
               /* Check the sanity of thickness and position.  We should
                  avoid drawing underline out of the current line area.  */
@@ -10766,6 +10786,8 @@ UNDERLINE_POSITION font properties, set this to nil.  You can also use
 `underline-minimum-offset' to override the font's UNDERLINE_POSITION for
 small font display sizes.  */);
   x_use_underline_position_properties = true;
+  DEFSYM (Qx_use_underline_position_properties,
+	  "x-use-underline-position-properties");
 
   DEFVAR_BOOL ("x-underline-at-descent-line",
 	       x_underline_at_descent_line,
@@ -10776,6 +10798,7 @@ A value of nil means to draw the underline according to the value of the
 variable `x-use-underline-position-properties', which is usually at the
 baseline level.  The default value is nil.  */);
   x_underline_at_descent_line = false;
+  DEFSYM (Qx_underline_at_descent_line, "x-underline-at-descent-line");
 
   DEFVAR_BOOL ("x-mouse-click-focus-ignore-position",
 	       x_mouse_click_focus_ignore_position,
-- 
2.21.0


From dce0333a73f16850c2a756ee33f89970ea25b83b Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Sat, 10 Mar 2018 13:48:49 +0200
Subject: [PATCH 136/297] Improve support for desktop restoration in daemon
 mode

* lisp/server.el (server-after-make-frame-hook): New hook.
(server-execute): Call it after creating a new frame or before
switching to a buffer shown in a client frame.  (Bug#30421)

* doc/emacs/misc.texi (Saving Emacs Sessions): Adjust advice for
restoring desktop in daemon mode to the new hook.
* doc/lispref/frames.texi (Creating Frames, Standard Hooks):
Document server-after-make-frame-hook.

* etc/NEWS: Mention server-after-make-frame-hook.
---
 doc/emacs/misc.texi     | 2 +-
 doc/lispref/frames.texi | 6 ++++++
 doc/lispref/hooks.texi  | 1 +
 etc/NEWS                | 9 +++++++++
 lisp/server.el          | 9 +++++++++
 5 files changed, 26 insertions(+), 1 deletion(-)

diff --git a/doc/emacs/misc.texi b/doc/emacs/misc.texi
index 60986347a7..68bd308983 100644
--- a/doc/emacs/misc.texi
+++ b/doc/emacs/misc.texi
@@ -2529,7 +2529,7 @@ e.g., the daemon cannot use GUI features, so parameters such as frame
 position, size, and decorations cannot be restored.  For that reason,
 you may wish to delay restoring the desktop in daemon mode until the
 first client connects, by calling @code{desktop-read} in a hook
-function that you add to @code{after-make-frame-functions}
+function that you add to @code{server-after-make-frame-hook}
 (@pxref{Creating Frames,,, elisp, The Emacs Lisp Reference Manual}).
 
 @node Recursive Edit
diff --git a/doc/lispref/frames.texi b/doc/lispref/frames.texi
index 2f9bb39886..459f05cb1c 100644
--- a/doc/lispref/frames.texi
+++ b/doc/lispref/frames.texi
@@ -181,6 +181,12 @@ the value of that parameter in the created frame to its value in the
 selected frame.
 @end defvar
 
+@defopt server-after-make-frame-hook
+A normal hook run when the Emacs server creates a client frame.  When
+this hook is called, the created frame is the selected one.
+@xref{Emacs Server,,, emacs, The GNU Emacs Manual}.
+@end defopt
+
 
 @node Multiple Terminals
 @section Multiple Terminals
diff --git a/doc/lispref/hooks.texi b/doc/lispref/hooks.texi
index db4e413921..e374d02def 100644
--- a/doc/lispref/hooks.texi
+++ b/doc/lispref/hooks.texi
@@ -66,6 +66,7 @@ not exactly a hook, but does a similar job.
 
 @item after-make-frame-functions
 @itemx before-make-frame-hook
+@itemx server-after-make-frame-hook
 @xref{Creating Frames}.
 
 @c Not general enough?
diff --git a/etc/NEWS b/etc/NEWS
index 6d14fa9240..1b03c17627 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -83,6 +83,15 @@ Customize the option 'mode-line-default-help-echo' to restore the old
 behavior where the tooltip text is also shown when the corresponding
 action does not apply.
 
++++
+** New hook 'server-after-make-frame-hook'.
+This hook is a convenient place to perform initializations in daemon
+mode which require GUI features to be available.  One example is
+restoration of the previous session using the desktop.el package: put
+the call to 'desktop-read' in this hook, if you want the GUI settings
+to be restored, or if desktop.el needs to interact with you during
+restoration of the session.
+
 +++
 ** New function 'logcount' calculates an integer's Hamming weight.
 
diff --git a/lisp/server.el b/lisp/server.el
index a892203c24..ff03cbe622 100644
--- a/lisp/server.el
+++ b/lisp/server.el
@@ -188,6 +188,13 @@ space (this means characters from ! to ~; or from code 33 to
   :group 'server
   :type 'hook)
 
+(defcustom server-after-make-frame-hook nil
+  "Hook run when the Emacs server creates a client frame.
+The created frame is selected when the hook is called."
+  :group 'server
+  :type 'hook
+  :version "27.1")
+
 (defcustom server-done-hook nil
   "Hook run when done editing a buffer for the Emacs server."
   :group 'server
@@ -1336,9 +1343,11 @@ The following commands are accepted by the client:
            ((or isearch-mode (minibufferp))
             nil)
            ((and frame (null buffers))
+            (run-hooks 'server-after-make-frame-hook)
             (message "%s" (substitute-command-keys
                            "When done with this frame, type \\[delete-frame]")))
            ((not (null buffers))
+            (run-hooks 'server-after-make-frame-hook)
             (server-switch-buffer (car buffers) nil (cdr (car files)))
             (run-hooks 'server-switch-hook)
             (unless nowait
-- 
2.21.0


From 59002d9448a3c833ddbe89d058e278a2a60074da Mon Sep 17 00:00:00 2001
From: Dmitry Safronov <saf.dmitry@gmail.com>
Date: Mon, 22 Jan 2018 12:19:00 +0100
Subject: [PATCH 137/297] Fix wrong behavior of 'outline-headers-as-kill'
 command (Bug#30209)

* outline.el (outline-headers-as-kill): Fix heading duplication.
---
 lisp/outline.el | 42 ++++++++++++++++++++----------------------
 1 file changed, 20 insertions(+), 22 deletions(-)

diff --git a/lisp/outline.el b/lisp/outline.el
index 7cf56abd23..669935bbc1 100644
--- a/lisp/outline.el
+++ b/lisp/outline.el
@@ -1100,28 +1100,26 @@ convenient way to make a table of contents of the buffer."
     (save-restriction
       (narrow-to-region beg end)
       (goto-char (point-min))
-      (let ((buffer (current-buffer))
-	    start end)
-	(with-temp-buffer
-	  (with-current-buffer buffer
-	    ;; Boundary condition: starting on heading:
-	    (when (outline-on-heading-p)
-	      (outline-back-to-heading)
-	      (setq start (point)
-		    end (progn (outline-end-of-heading)
-			       (point)))
-	      (insert-buffer-substring buffer start end)
-	      (insert "\n\n")))
-	  (let ((temp-buffer (current-buffer)))
-	    (with-current-buffer buffer
-	      (while (outline-next-heading)
-		(unless (outline-invisible-p)
-		  (setq start (point)
-			end (progn (outline-end-of-heading) (point)))
-		  (with-current-buffer temp-buffer
-		    (insert-buffer-substring buffer start end)
-		    (insert "\n\n"))))))
-	  (kill-new (buffer-string)))))))
+      (let ((buffer (current-buffer)) start end)
+        (with-temp-buffer
+          (let ((temp-buffer (current-buffer)))
+            (with-current-buffer buffer
+              ;; Boundary condition: starting on heading:
+              (when (outline-on-heading-p)
+                (outline-back-to-heading)
+                (setq start (point)
+                      end (progn (outline-end-of-heading) (point)))
+                (with-current-buffer temp-buffer
+                  (insert-buffer-substring buffer start end)
+                  (insert "\n\n")))
+              (while (outline-next-heading)
+                (unless (outline-invisible-p)
+                  (setq start (point)
+                        end (progn (outline-end-of-heading) (point)))
+                  (with-current-buffer temp-buffer
+                    (insert-buffer-substring buffer start end)
+                    (insert "\n\n"))))))
+          (kill-new (buffer-string)))))))
 
 (provide 'outline)
 (provide 'noutline)
-- 
2.21.0


From 1813d7083fe504316d9143fc0a09d27607b45ab1 Mon Sep 17 00:00:00 2001
From: Noam Postavsky <npostavs@gmail.com>
Date: Tue, 6 Mar 2018 19:26:32 -0500
Subject: [PATCH 138/297] Let warning about (:foo) be suppressible (Bug#30499)

* lisp/emacs-lisp/bytecomp.el (byte-compile-form): Check
byte-compile-warning-enabled-p before warning about funcalling const
symbol.
---
 lisp/emacs-lisp/bytecomp.el | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/lisp/emacs-lisp/bytecomp.el b/lisp/emacs-lisp/bytecomp.el
index 1bf6d04b63..2a986f6cbb 100644
--- a/lisp/emacs-lisp/bytecomp.el
+++ b/lisp/emacs-lisp/bytecomp.el
@@ -3119,7 +3119,8 @@ for symbols generated by the byte compiler itself."
              (when (assq var byte-compile-lexical-variables)
                (byte-compile-report-error
                 (format-message "%s cannot use lexical var `%s'" fn var))))))
-        (when (macroexp--const-symbol-p fn)
+        (when (and (byte-compile-warning-enabled-p 'suspicious)
+                   (macroexp--const-symbol-p fn))
           (byte-compile-warn "`%s' called as a function" fn))
 	(when (and (byte-compile-warning-enabled-p 'interactive-only)
 		   interactive-only)
-- 
2.21.0


From f038568aabe69e1344f3d5bc4b6429b45b7af77b Mon Sep 17 00:00:00 2001
From: Noam Postavsky <npostavs@gmail.com>
Date: Sat, 10 Mar 2018 21:01:24 -0500
Subject: [PATCH 139/297] ; Revert "; Tracing for eieio-test random failure
 (Bug#24503)"

The tracing seems to prevent the bug from happening.
---
 test/Makefile.in                              |  1 -
 .../emacs-lisp/eieio-tests/eieio-tests.el     | 21 +------------------
 2 files changed, 1 insertion(+), 21 deletions(-)

diff --git a/test/Makefile.in b/test/Makefile.in
index ea053095d6..a6f6d0a3fe 100644
--- a/test/Makefile.in
+++ b/test/Makefile.in
@@ -152,7 +152,6 @@ endif
 WRITE_LOG = > $@ 2>&1 || { STAT=$$?; cat $@; exit $$STAT; }
 ifdef EMACS_HYDRA_CI
 ## On Hydra, always show logs for certain problematic tests.
-lisp/emacs-lisp/eieio-tests/eieio-tests.log \
 lisp/net/tramp-tests.log \
 : WRITE_LOG = 2>&1 | tee $@
 endif
diff --git a/test/lisp/emacs-lisp/eieio-tests/eieio-tests.el b/test/lisp/emacs-lisp/eieio-tests/eieio-tests.el
index 69dc16443f..5ba094c007 100644
--- a/test/lisp/emacs-lisp/eieio-tests/eieio-tests.el
+++ b/test/lisp/emacs-lisp/eieio-tests/eieio-tests.el
@@ -887,34 +887,15 @@ Subclasses to override slot attributes.")
   (should (= (length (eieio-build-class-alist 'opt-test1 nil)) 2))
   (should (= (length (eieio-build-class-alist 'opt-test1 t)) 1)))
 
-(mapatoms (lambda (a)
-            (when (and (fboundp a)
-                       (string-match "\\`cl--?generic"
-                                     (symbol-name a)))
-              (trace-function-background a))))
-
 (defclass eieio--testing () ())
 
 (defmethod constructor :static ((_x eieio--testing) newname &rest _args)
   (list newname 2))
 
-(defun eieio-test-dump-trace ()
-  (message "%s" (with-current-buffer "*trace-output*"
-                  (goto-char (point-min))
-                  (while (re-search-forward "[\0-\010\013-\037]" nil t)
-                    (insert (prog1 (format "\\%03o" (char-before))
-                              (delete-char -1))))
-                  (buffer-string))))
-(eieio-test-dump-trace)
-
 (ert-deftest eieio-test-37-obsolete-name-in-constructor ()
   ;; FIXME repeated intermittent failures on hydra and elsewhere (bug#24503).
   :tags '(:unstable)
-  (with-current-buffer "*trace-output*"
-    (erase-buffer))
-  (unwind-protect
-      (should (equal (eieio--testing "toto") '("toto" 2)))
-    (eieio-test-dump-trace)))
+  (should (equal (eieio--testing "toto") '("toto" 2))))
 
 (ert-deftest eieio-autoload ()
   "Tests to see whether reftex-auc has been autoloaded"
-- 
2.21.0


From 426805624e18c609876b7a9fb3b5426c5f70d360 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 8 Mar 2018 08:41:52 -0800
Subject: [PATCH 140/297] ; Tiny fix for recent doc change

---
 doc/emacs/display.texi | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/doc/emacs/display.texi b/doc/emacs/display.texi
index 499be26004..42a5227983 100644
--- a/doc/emacs/display.texi
+++ b/doc/emacs/display.texi
@@ -1676,7 +1676,7 @@ line truncation.  @xref{Split Window}, for the variable
 @dfn{word wrap}.  Here, each long logical line is divided into two or
 more screen lines, like in ordinary line continuation.  However, Emacs
 attempts to wrap the line at word boundaries near the right window
-edge.  (If line's direction is right-to-left, it is wrapped at the
+edge.  (If the line's direction is right-to-left, it is wrapped at the
 left window edge instead.)  This makes the text easier to read, as
 wrapping does not occur in the middle of words.
 
-- 
2.21.0


From d122a4fc1758524d790c04868e5ce75ce65f0e03 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 8 Mar 2018 20:18:18 -0500
Subject: [PATCH 141/297] Replace the obsolete process-kill-without-query in
 documentation

* lisp/comint.el (comint-exec-hook):
* lisp/term.el (term-exec-hook):
* lisp/eshell/esh-proc.el (eshell-exec-hook):
Doc fixes re the obsolete process-kill-without-query.
; * lisp/net/ange-ftp.el: Comment.
---
 lisp/comint.el          | 4 ++--
 lisp/eshell/esh-proc.el | 4 ++--
 lisp/net/ange-ftp.el    | 2 +-
 lisp/term.el            | 4 ++--
 4 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/lisp/comint.el b/lisp/comint.el
index 3163afeff4..838662a59a 100644
--- a/lisp/comint.el
+++ b/lisp/comint.el
@@ -454,8 +454,8 @@ This is run before the process is cranked up."
   "Hook run each time a process is exec'd by `comint-exec'.
 This is called after the process is cranked up.  It is useful for things that
 must be done each time a process is executed in a Comint mode buffer (e.g.,
-`(process-kill-without-query)').  In contrast, the `comint-mode-hook' is only
-executed once when the buffer is created."
+`set-process-query-on-exit-flag').  In contrast, `comint-mode-hook' is only
+executed once, when the buffer is created."
   :type 'hook
   :group 'comint)
 
diff --git a/lisp/eshell/esh-proc.el b/lisp/eshell/esh-proc.el
index f1380852b3..b3bd7a7245 100644
--- a/lisp/eshell/esh-proc.el
+++ b/lisp/eshell/esh-proc.el
@@ -87,8 +87,8 @@ variable's value to take effect."
   "Called each time a process is exec'd by `eshell-gather-process-output'.
 It is passed one argument, which is the process that was just started.
 It is useful for things that must be done each time a process is
-executed in an eshell mode buffer (e.g., `process-kill-without-query').
-In contrast, `eshell-mode-hook' is only executed once when the buffer
+executed in an eshell mode buffer (e.g., `set-process-query-on-exit-flag').
+In contrast, `eshell-mode-hook' is only executed once, when the buffer
 is created."
   :type 'hook
   :group 'eshell-proc)
diff --git a/lisp/net/ange-ftp.el b/lisp/net/ange-ftp.el
index b1e0bf24aa..c3650afa9a 100644
--- a/lisp/net/ange-ftp.el
+++ b/lisp/net/ange-ftp.el
@@ -3633,7 +3633,7 @@ so return the size on the remote host exactly. See RFC 3659."
 ;; 			     newname))
 ;; 	res)
 ;;     (set-process-sentinel proc 'ange-ftp-copy-file-locally-sentinel)
-;;     (process-kill-without-query proc)
+;;     (set-process-query-on-exit-flag proc nil)
 ;;     (with-current-buffer (process-buffer proc)
 ;;       (set (make-local-variable 'copy-cont) cont))))
 ;;
diff --git a/lisp/term.el b/lisp/term.el
index cf7699abc9..93da33ea5b 100644
--- a/lisp/term.el
+++ b/lisp/term.el
@@ -598,8 +598,8 @@ This is run before the process is cranked up."
   "Called each time a process is exec'd by `term-exec'.
 This is called after the process is cranked up.  It is useful for things that
 must be done each time a process is executed in a term mode buffer (e.g.,
-`process-kill-without-query').  In contrast, `term-mode-hook' is only
-executed once when the buffer is created."
+`set-process-query-on-exit-flag').  In contrast, `term-mode-hook' is only
+executed once, when the buffer is created."
   :type 'hook
   :group 'term)
 
-- 
2.21.0


From 5aa54b062f6c6c538a68a330d307a5430fda7cb5 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Fri, 9 Mar 2018 12:43:21 -0500
Subject: [PATCH 142/297] ; * lisp/org/org-table.el: Replace obsolete alias in
 comment.

---
 lisp/org/org-table.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lisp/org/org-table.el b/lisp/org/org-table.el
index 3932671e8b..4bb5c91ce8 100644
--- a/lisp/org/org-table.el
+++ b/lisp/org/org-table.el
@@ -5428,7 +5428,7 @@ which will prompt for the width."
 ;; - orgtbl-uc-draw-cont (smooth unicode)
 
 ;; This is best viewed with the "DejaVu Sans Mono" font
-;; (use M-x set-default-font).
+;; (use M-x set-frame-font).
 
 (defun orgtbl-uc-draw-grid (value min max &optional width)
   "Draw a bar in a table using block unicode characters.
-- 
2.21.0


From f8dda78921ab946a98c74489ec73cf2295d95d5c Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Fri, 9 Mar 2018 14:05:36 -0500
Subject: [PATCH 143/297] * test/lisp/international/mule-tests.el: Avoid local
 variables confusion.

---
 test/lisp/international/mule-tests.el | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/test/lisp/international/mule-tests.el b/test/lisp/international/mule-tests.el
index 3c3bae1493..59c9ff5aab 100644
--- a/test/lisp/international/mule-tests.el
+++ b/test/lisp/international/mule-tests.el
@@ -36,4 +36,7 @@
                      (find-auto-coding "" (buffer-size)))
                    '(utf-8 . :coding)))))
 
+;; Stop "Local Variables" above causing confusion when visiting this file.
+
+
 ;;; mule-tests.el ends here
-- 
2.21.0


From 3b5c09b696b384195a9a8fe5ebc40eff22fa85bd Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Sat, 10 Mar 2018 13:57:33 +0200
Subject: [PATCH 144/297] Document the "URL" keyword in library headers

* doc/lispref/tips.texi (Library Headers): "URL" is an alias for
"Homepage".  Suggested by Peter Oliver <p.d.oliver@mavit.org.uk>.
(Bug#30571)
---
 doc/lispref/tips.texi | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/doc/lispref/tips.texi b/doc/lispref/tips.texi
index 0695d9b7b1..c62cfcfa8f 100644
--- a/doc/lispref/tips.texi
+++ b/doc/lispref/tips.texi
@@ -1043,7 +1043,8 @@ the place to write arbitrary keywords that describe their package,
 rather than just the relevant Finder keywords.
 
 @item Homepage
-This line states the homepage of the library.
+@itemx URL
+These lines state the homepage of the library.
 
 @item Package-Version
 If @samp{Version} is not suitable for use by the package manager, then
-- 
2.21.0


From 254089dd1b84e9c6e4c3ca5c4fded09c7ae584c4 Mon Sep 17 00:00:00 2001
From: "Charles A. Roelli" <charles@aurox.ch>
Date: Sat, 10 Mar 2018 19:19:00 +0100
Subject: [PATCH 145/297] Improve SVG documentation

* doc/lispref/display.texi (ImageMagick Images): Remove an
outdated comment that references a fixed bug.
(SVG Images): Fix grammar, and call functions functions (there are
no commands in lisp/svg.el).
---
 doc/lispref/display.texi | 7 +++----
 1 file changed, 3 insertions(+), 4 deletions(-)

diff --git a/doc/lispref/display.texi b/doc/lispref/display.texi
index 793ede16b3..7348b1bf6b 100644
--- a/doc/lispref/display.texi
+++ b/doc/lispref/display.texi
@@ -5387,7 +5387,6 @@ hint to ImageMagick to help it detect the image type.
 Specifies a rotation angle in degrees.
 
 @item :index @var{frame}
-@c Doesn't work: https://debbugs.gnu.org/7978
 @xref{Multi-Frame Images}.
 @end table
 
@@ -5396,8 +5395,8 @@ Specifies a rotation angle in degrees.
 @cindex SVG images
 
 SVG (Scalable Vector Graphics) is an XML format for specifying images.
-If your Emacs build has with SVG support, you can create and manipulate
-these images with the following commands.
+If your Emacs build has SVG support, you can create and manipulate
+these images with the following functions.
 
 @defun svg-create width height &rest args
 Create a new, empty SVG image with the specified dimensions.
@@ -5411,7 +5410,7 @@ The default width (in pixels) of any lines created.
 The default stroke color on any lines created.
 @end table
 
-This function returns an SVG structure, and all the following commands
+This function returns an SVG structure, and all the following functions
 work on that structure.
 @end defun
 
-- 
2.21.0


From 1034f0ff55cf00c741b822fd60edf0ea5661effb Mon Sep 17 00:00:00 2001
From: Noam Postavsky <npostavs@gmail.com>
Date: Thu, 8 Mar 2018 18:48:39 -0500
Subject: [PATCH 146/297] Clarify that nil doesn't match itself as a cl-case
 clause (Bug#30749)

* lisp/emacs-lisp/cl-macs.el (cl-case): Mention that the ATOM
=> (ATOM) short form is only for non-nil ATOMs.
---
 lisp/emacs-lisp/cl-macs.el | 16 +++++++++-------
 1 file changed, 9 insertions(+), 7 deletions(-)

diff --git a/lisp/emacs-lisp/cl-macs.el b/lisp/emacs-lisp/cl-macs.el
index 4d4640cbe0..9600230c07 100644
--- a/lisp/emacs-lisp/cl-macs.el
+++ b/lisp/emacs-lisp/cl-macs.el
@@ -771,13 +771,15 @@ The result of the body appears to the compiler as a quoted constant."
 ;;;###autoload
 (defmacro cl-case (expr &rest clauses)
   "Eval EXPR and choose among clauses on that value.
-Each clause looks like (KEYLIST BODY...).  EXPR is evaluated and compared
-against each key in each KEYLIST; the corresponding BODY is evaluated.
-If no clause succeeds, cl-case returns nil.  A single atom may be used in
-place of a KEYLIST of one atom.  A KEYLIST of t or `otherwise' is
-allowed only in the final clause, and matches if no other keys match.
-Key values are compared by `eql'.
-\n(fn EXPR (KEYLIST BODY...)...)"
+Each clause looks like (KEYLIST BODY...).  EXPR is evaluated and
+compared against each key in each KEYLIST; the corresponding BODY
+is evaluated.  If no clause succeeds, cl-case returns nil.  A
+single non-nil atom may be used in place of a KEYLIST of one
+atom.  A KEYLIST of t or `otherwise' is allowed only in the final
+clause, and matches if no other keys match.  Key values are
+compared by `eql'.
+
+\(fn EXPR (KEYLIST BODY...)...)"
   (declare (indent 1) (debug (form &rest (sexp body))))
   (macroexp-let2 macroexp-copyable-p temp expr
     (let* ((head-list nil))
-- 
2.21.0


From eecef3c0ea586e084787fe0661bc6290dbcec533 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sat, 10 Mar 2018 18:26:01 -0800
Subject: [PATCH 147/297] Fix create_process bug breaking eudc-expand-inline

Problem reported by Thomas Fitzsimmons (Bug#30762).
* src/process.c (create_process) [HAVE_PTYS]:
Call setsid even if !PTY_FLAG.
---
 src/process.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/src/process.c b/src/process.c
index 17a46d3ed3..fac4374230 100644
--- a/src/process.c
+++ b/src/process.c
@@ -1734,9 +1734,9 @@ create_process (Lisp_Object process, char **new_argv, Lisp_Object current_dir)
     {
       /* Make the pty be the controlling terminal of the process.  */
 #ifdef HAVE_PTYS
-      /* First, disconnect its current controlling terminal.  */
-      if (pty_flag)
-	setsid ();
+      /* First, disconnect its current controlling terminal.
+	 Do this even if !PTY_FLAG; see Bug#30762.  */
+      setsid ();
       /* Make the pty's terminal the controlling terminal.  */
       if (pty_flag && forkin >= 0)
 	{
-- 
2.21.0


From 9f28960316cc074dd678f2bd4caeeba09245a803 Mon Sep 17 00:00:00 2001
From: Stefan Monnier <monnier@iro.umontreal.ca>
Date: Sat, 10 Mar 2018 21:49:22 -0500
Subject: [PATCH 148/297] eshell-eval-using-options: Avoid compiler warning
 differently

* lisp/eshell/em-unix.el (eshell/time):
* lisp/eshell/em-tramp.el (eshell/sudo):
* lisp/eshell/esh-var.el (eshell/env): Remove artificial use of `args'.

* lisp/eshell/esh-opt.el (eshell-eval-using-options): Silence warning
when `args' is not used by `body-forms'.
---
 lisp/eshell/em-tramp.el | 1 -
 lisp/eshell/em-unix.el  | 1 -
 lisp/eshell/esh-opt.el  | 7 ++++---
 lisp/eshell/esh-var.el  | 1 -
 4 files changed, 4 insertions(+), 6 deletions(-)

diff --git a/lisp/eshell/em-tramp.el b/lisp/eshell/em-tramp.el
index 9a72f781fc..004c495490 100644
--- a/lisp/eshell/em-tramp.el
+++ b/lisp/eshell/em-tramp.el
@@ -109,7 +109,6 @@ Uses the system sudo through TRAMP's sudo method."
        :show-usage
        :usage "[(-u | --user) USER] COMMAND
 Execute a COMMAND as the superuser or another USER.")
-     args                 ; suppress "unused lexical variable" warning
      (throw 'eshell-external
 	    (let ((user (or user "root"))
 		  (host (or (file-remote-p default-directory 'host)
diff --git a/lisp/eshell/em-unix.el b/lisp/eshell/em-unix.el
index 04c517f82a..a18fb85507 100644
--- a/lisp/eshell/em-unix.el
+++ b/lisp/eshell/em-unix.el
@@ -956,7 +956,6 @@ Summarize disk usage of each FILE, recursively for directories.")
        :show-usage
        :usage "COMMAND...
 Show wall-clock time elapsed during execution of COMMAND.")
-     args                 ; suppress "unused lexical variable" warning
      (setq eshell-time-start (float-time))
      (add-hook 'eshell-post-command-hook 'eshell-show-elapsed-time nil t)
      ;; after setting
diff --git a/lisp/eshell/esh-opt.el b/lisp/eshell/esh-opt.el
index 18852ce534..b802696306 100644
--- a/lisp/eshell/esh-opt.el
+++ b/lisp/eshell/esh-opt.el
@@ -95,8 +95,8 @@ BODY-FORMS.  If instead an external command is run (because of
 an unknown option), the tag `eshell-external' will be thrown with
 the new process for its value.
 
-Lastly, any remaining arguments will be available in a locally
-interned variable `args' (created using a `let' form)."
+Lastly, any remaining arguments will be available in the locally
+let-bound variable `args'."
   (declare (debug (form form sexp body)))
   `(let* ((temp-args
            ,(if (memq ':preserve-args (cadr options))
@@ -111,7 +111,8 @@ interned variable `args' (created using a `let' form)."
                                ;; `options' is of the form (quote OPTS).
                                (cadr options))))
           (args processed-args))
-     ;; Unused lexical variable warning if body does not use `args'.
+     ;; Silence unused lexical variable warning if body does not use `args'.
+     (ignore args)
      ,@body-forms))
 
 ;;; Internal Functions:
diff --git a/lisp/eshell/esh-var.el b/lisp/eshell/esh-var.el
index d400e0a9be..b5dce80de8 100644
--- a/lisp/eshell/esh-var.el
+++ b/lisp/eshell/esh-var.el
@@ -353,7 +353,6 @@ This function is explicit for adding to `eshell-parse-argument-hook'."
    '((?h "help" nil nil "show this usage screen")
      :external "env"
      :usage "<no arguments>")
-   args                   ; suppress "unused lexical variable" warning
    (dolist (setting (sort (eshell-environment-variables) 'string-lessp))
      (eshell-buffered-print setting "\n"))
    (eshell-flush)))
-- 
2.21.0


From f7e1e2ef88b634441c8a6ba9a6937bbc6a41a79f Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Sat, 10 Mar 2018 19:15:56 -0800
Subject: [PATCH 149/297] Remove many items obsolete since Emacs 22.1

Emacs 22.1 was five major releases and over decade ago.
In bug reporting statistics, it's been absent for around 5 years.
Ref: https://debbugs.gnu.org/stats/emacs.html
This list can be reviewed before to the next release, but for
now hopefully this motivates any needed external updates.
* lisp/arc-mode.el (archive-mouse-extract):
* lisp/bookmark.el (bookmark-exit-hooks):
* lisp/comint.el (comint-use-prompt-regexp-instead-of-fields):
* lisp/cus-edit.el (custom-face-save-command):
* lisp/descr-text.el (describe-char-after):
* lisp/desktop.el (desktop-enable, desktop-basefilename)
(desktop-buffer-modes-to-save, desktop-buffer-misc-functions)
(desktop-buffer-handlers, desktop-load-default):
* lisp/dired-x.el (dired-omit-files-p):
* lisp/frame.el (new-frame, set-default-font, delete-frame-hook)
(blink-cursor):
* lisp/generic-x.el (generic-define-mswindows-modes)
(generic-define-unix-modes):
* lisp/help.el (describe-project, view-todo):
* lisp/hilit-chg.el (highlight-changes-colours):
* lisp/ibuffer.el (ibuffer-elide-long-columns, ibuffer-hooks)
(ibuffer-mode-hooks):
* lisp/imenu.el (imenu-always-use-completion-buffer-p):
* lisp/isearch.el (isearch-lazy-highlight-cleanup)
(isearch-lazy-highlight-initial-delay)
(isearch-lazy-highlight-interval)
(isearch-lazy-highlight-max-at-a-time)
(isearch-lazy-highlight-cleanup):
* lisp/mwheel.el (mouse-wheel-down-button)
(mouse-wheel-up-button, mouse-wheel-click-button):
* lisp/novice.el (disabled-command-hook):
* lisp/recentf.el (recentf-menu-append-commands-p):
* lisp/savehist.el (savehist-load):
* lisp/speedbar.el (speedbar-ignored-path-expressions)
(speedbar-ignored-path-regexp, speedbar-add-ignored-path-regexp)
(speedbar-line-path, speedbar-buffers-line-path, speedbar-path-line):
* lisp/subr.el (assoc-ignore-case, assoc-ignore-representation)
(x-lost-selection-hooks, x-sent-selection-hooks)
(process-kill-without-query):
* lisp/calendar/icalendar.el (icalendar-convert-diary-to-ical)
(icalendar-extract-ical-from-buffer):
* lisp/emacs-lisp/autoload.el (update-autoloads-from-directories):
* lisp/emacs-lisp/derived.el (derived-mode-class):
* lisp/emacs-lisp/generic.el (generic-font-lock-defaults):
* lisp/emacs-lisp/timer.el (timer-set-time-with-usecs):
* lisp/gnus/spam.el (spam-list-of-processors):
* lisp/international/latin1-disp.el (latin1-char-displayable-p):
* lisp/mail/rmail.el (rmail-pop-password, rmail-pop-password-required):
* lisp/net/goto-addr.el (goto-address-at-mouse):
* lisp/net/net-utils.el (ipconfig-program, ipconfig-program-options):
* lisp/obsolete/iswitchb.el (iswitchb-use-fonts):
* lisp/play/dunnet.el (dungeon-mode-map):
* lisp/progmodes/compile.el (compilation-finish-function)
* lisp/progmodes/cperl-mode.el (cperl-vc-header-alist)
* lisp/progmodes/gud.el (tooltip-gud-modes, tooltip-gud-display)
(tooltip-gud-toggle-dereference):
* lisp/progmodes/pascal.el (pascal-outline):
* lisp/progmodes/perl-mode.el (electric-perl-terminator):
* lisp/textmodes/nroff-mode.el (count-text-lines)
(forward-text-line, backward-text-line, electric-nroff-newline)
(electric-nroff-mode):
* lisp/vc/log-edit.el (vc-comment-ring, vc-comment-ring-index)
(vc-previous-comment, vc-next-comment)
(vc-comment-search-reverse, vc-comment-search-forward)
(vc-comment-to-change-log):
* lisp/vc/pcvs-info.el (cvs-display-full-path)
(cvs-fileinfo->full-path):
* lisp/vc/vc.el (vc-diff-switches-list):
Remove items, obsolete since Emacs 22.1.
* lisp/ibuffer.el (ibuffer-cached-elide-long-columns):
Remove internal variable.
(ibuffer-compile-make-eliding-form, ibuffer-check-formats):
(ibuffer-mode): Remove support for ibuffer-elide-long-columns.
* lisp/cedet/semantic/sb.el (semantic-sb-token-jump):
Remove support for speedbar-line-path.
* lisp/emacs-lisp/unsafep.el (assoc-ignore-case):
Stop marking as side-effect-free.
* lisp/gnus/spam.el (spam-group-processor-p):
Remove support for spam-list-of-processors.
* lisp/progmodes/compile.el (define-compilation-mode)
(compilation-handle-exit):
Remove support for compilation-finish-function.
* lisp/progmodes/cperl-mode.el (cperl-mode):
Remove support for cperl-vc-header-alist.
; * lisp/files.el: Comments.
; * etc/NEWS: List removed items.
---
 etc/NEWS                          | 35 ++++++++++++
 lisp/arc-mode.el                  |  2 -
 lisp/bookmark.el                  |  2 -
 lisp/calendar/icalendar.el        | 10 +---
 lisp/cedet/semantic/sb.el         |  6 +-
 lisp/comint.el                    |  3 -
 lisp/cus-edit.el                  |  4 --
 lisp/descr-text.el                |  2 -
 lisp/desktop.el                   | 22 --------
 lisp/dired-x.el                   |  2 -
 lisp/emacs-lisp/autoload.el       |  3 -
 lisp/emacs-lisp/derived.el        | 13 -----
 lisp/emacs-lisp/generic.el        |  2 -
 lisp/emacs-lisp/timer.el          | 14 -----
 lisp/emacs-lisp/unsafep.el        |  2 +-
 lisp/files.el                     |  7 ++-
 lisp/frame.el                     | 11 ----
 lisp/generic-x.el                 | 25 +--------
 lisp/gnus/spam.el                 | 91 ++++++++++---------------------
 lisp/help.el                      |  5 --
 lisp/hilit-chg.el                 |  3 -
 lisp/ibuffer.el                   | 22 +-------
 lisp/imenu.el                     | 12 +---
 lisp/international/latin1-disp.el |  4 --
 lisp/isearch.el                   | 20 -------
 lisp/mail/rmail.el                |  6 --
 lisp/mwheel.el                    | 19 +------
 lisp/net/goto-addr.el             |  4 --
 lisp/net/net-utils.el             |  5 --
 lisp/novice.el                    |  3 -
 lisp/obsolete/iswitchb.el         |  2 -
 lisp/play/dunnet.el               |  1 -
 lisp/progmodes/compile.el         | 14 -----
 lisp/progmodes/cperl-mode.el      | 12 +---
 lisp/progmodes/gud.el             |  8 ---
 lisp/progmodes/pascal.el          |  1 -
 lisp/progmodes/perl-mode.el       |  2 -
 lisp/recentf.el                   |  4 --
 lisp/savehist.el                  | 23 --------
 lisp/speedbar.el                  | 23 --------
 lisp/subr.el                      | 32 -----------
 lisp/textmodes/nroff-mode.el      |  7 ---
 lisp/vc/log-edit.el               | 10 ----
 lisp/vc/pcvs-info.el              |  5 --
 lisp/vc/vc.el                     |  5 --
 45 files changed, 85 insertions(+), 423 deletions(-)

diff --git a/etc/NEWS b/etc/NEWS
index 1b03c17627..64d8cda269 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -290,6 +290,41 @@ This feature uses Tramp and works only on systems which support GVFS,
 i.e. GNU/Linux, roughly spoken.  See the chapter "(tramp) Archive file
 names" in the Tramp manual for full documentation of these facilities.
 
+** Some functions and variables obsolete since 22.1 have been removed:
+archive-mouse-extract, assoc-ignore-case, assoc-ignore-representation,
+backward-text-line, blink-cursor, bookmark-exit-hooks,
+comint-use-prompt-regexp-instead-of-fields, compilation-finish-function,
+count-text-lines, cperl-vc-header-alist, custom-face-save-command,
+cvs-display-full-path, cvs-fileinfo->full-path, delete-frame-hook,
+derived-mode-class, describe-char-after, describe-project,
+desktop-basefilename, desktop-buffer-handlers,
+desktop-buffer-misc-functions, desktop-buffer-modes-to-save,
+desktop-enable, desktop-load-default, dired-omit-files-p,
+disabled-command-hook, dungeon-mode-map, electric-nroff-mode,
+electric-nroff-newline, electric-perl-terminator, forward-text-line,
+generic-define-mswindows-modes, generic-define-unix-modes,
+generic-font-lock-defaults, goto-address-at-mouse,
+highlight-changes-colours, ibuffer-elide-long-columns, ibuffer-hooks,
+ibuffer-mode-hooks, icalendar-convert-diary-to-ical,
+icalendar-extract-ical-from-buffer, imenu-always-use-completion-buffer-p,
+ipconfig-program, ipconfig-program-options, isearch-lazy-highlight-cleanup,
+isearch-lazy-highlight-cleanup, isearch-lazy-highlight-initial-delay,
+isearch-lazy-highlight-interval, isearch-lazy-highlight-max-at-a-time,
+iswitchb-use-fonts, latin1-char-displayable-p, mouse-wheel-click-button,
+mouse-wheel-down-button, mouse-wheel-up-button, new-frame, pascal-outline,
+process-kill-without-query, recentf-menu-append-commands-p,
+rmail-pop-password, rmail-pop-password-required, savehist-load,
+set-default-font, spam-list-of-processors,
+speedbar-add-ignored-path-regexp, speedbar-buffers-line-path,
+speedbar-buffers-line-path, speedbar-ignored-path-expressions,
+speedbar-ignored-path-regexp, speedbar-line-path, speedbar-path-line,
+timer-set-time-with-usecs, tooltip-gud-display, tooltip-gud-modes,
+tooltip-gud-toggle-dereference, update-autoloads-from-directories,
+vc-comment-ring, vc-comment-ring-index, vc-comment-search-forward,
+vc-comment-search-reverse, vc-comment-to-change-log, vc-diff-switches-list,
+vc-next-comment, vc-previous-comment, view-todo, x-lost-selection-hooks,
+x-sent-selection-hooks
+
 
 * Incompatible Lisp Changes in Emacs 27.1
 
diff --git a/lisp/arc-mode.el b/lisp/arc-mode.el
index ce3ec09e28..4ddb29dcbb 100644
--- a/lisp/arc-mode.el
+++ b/lisp/arc-mode.el
@@ -1010,8 +1010,6 @@ using `make-temp-file', and the generated name is returned."
       (kill-local-variable 'buffer-file-coding-system)
       (after-insert-file-set-coding (- (point-max) (point-min))))))
 
-(define-obsolete-function-alias 'archive-mouse-extract 'archive-extract "22.1")
-
 (defun archive-extract (&optional other-window-p event)
   "In archive mode, extract this entry of the archive into its own buffer."
   (interactive (list nil last-input-event))
diff --git a/lisp/bookmark.el b/lisp/bookmark.el
index 70b63a22b8..a454ccb3ae 100644
--- a/lisp/bookmark.el
+++ b/lisp/bookmark.el
@@ -2251,8 +2251,6 @@ strings returned are not."
   "Hook run at the end of loading library `bookmark.el'.")
 
 ;; Exit Hook, called from kill-emacs-hook
-(define-obsolete-variable-alias 'bookmark-exit-hooks
-  'bookmark-exit-hook "22.1")
 (defvar bookmark-exit-hook nil
   "Hook run when Emacs exits.")
 
diff --git a/lisp/calendar/icalendar.el b/lisp/calendar/icalendar.el
index ca3adfaeeb..c1a3e0a421 100644
--- a/lisp/calendar/icalendar.el
+++ b/lisp/calendar/icalendar.el
@@ -43,13 +43,13 @@
 
 ;;  0.06:  (2004-10-06)
 ;;  - Bugfixes regarding icalendar-import-format-*.
-;;  - Fix in icalendar-convert-diary-to-ical -- thanks to Philipp Grau.
+;;  - Fix in icalendar-export-file -- thanks to Philipp Grau.
 
 ;;  0.05: (2003-06-19)
 ;;  - New import format scheme: Replaced icalendar-import-prefix-*,
 ;;    icalendar-import-ignored-properties, and
 ;;    icalendar-import-separator with icalendar-import-format(-*).
-;;  - icalendar-import-file and icalendar-convert-diary-to-ical
+;;  - icalendar-import-file and icalendar-export-file
 ;;    have an extra parameter which should prevent them from
 ;;    erasing their target files (untested!).
 ;;  - Tested with Emacs 21.3.2
@@ -996,9 +996,6 @@ Finto iCalendar file: ")
     (set-buffer (find-file diary-filename))
     (icalendar-export-region (point-min) (point-max) ical-filename)))
 
-(define-obsolete-function-alias 'icalendar-convert-diary-to-ical
-  'icalendar-export-file "22.1")
-
 (defvar icalendar--uid-count 0
   "Auxiliary counter for creating unique ids.")
 
@@ -2027,9 +2024,6 @@ buffer `*icalendar-errors*'."
       ;; return nil, i.e. import did not work
       nil)))
 
-(define-obsolete-function-alias 'icalendar-extract-ical-from-buffer
-  'icalendar-import-buffer "22.1")
-
 (defun icalendar--format-ical-event (event)
   "Create a string representation of an iCalendar EVENT."
   (if (functionp icalendar-import-format)
diff --git a/lisp/cedet/semantic/sb.el b/lisp/cedet/semantic/sb.el
index 739f674214..443c3839bb 100644
--- a/lisp/cedet/semantic/sb.el
+++ b/lisp/cedet/semantic/sb.el
@@ -298,11 +298,7 @@ TEXT TOKEN and INDENT are the details."
   "Jump to the location specified in token.
 TEXT TOKEN and INDENT are the details."
   (let ((file
-	 (or
-	  (cond ((fboundp 'speedbar-line-path)
-		 (speedbar-line-directory indent))
-		((fboundp 'speedbar-line-directory)
-		 (speedbar-line-directory indent)))
+	 (or (speedbar-line-directory indent)
 	  ;; If speedbar cannot figure this out, extract the filename from
 	  ;; the token.  True for Analysis mode.
 	  (semantic-tag-file-name token)))
diff --git a/lisp/comint.el b/lisp/comint.el
index 838662a59a..3182cba866 100644
--- a/lisp/comint.el
+++ b/lisp/comint.el
@@ -429,9 +429,6 @@ See `comint-send-input'."
   :type 'boolean
   :group 'comint)
 
-(define-obsolete-variable-alias 'comint-use-prompt-regexp-instead-of-fields
-  'comint-use-prompt-regexp "22.1")
-
 ;; Note: If it is decided to purge comint-prompt-regexp from the source
 ;; entirely, searching for uses of this variable will help to identify
 ;; places that need attention.
diff --git a/lisp/cus-edit.el b/lisp/cus-edit.el
index 816c7f7881..a12897e799 100644
--- a/lisp/cus-edit.el
+++ b/lisp/cus-edit.el
@@ -3790,10 +3790,6 @@ Optional EVENT is the location for the menu."
   (custom-save-all)
   (custom-face-state-set-and-redraw widget))
 
-;; For backward compatibility.
-(define-obsolete-function-alias 'custom-face-save-command 'custom-face-save
-  "22.1")
-
 (defun custom-face-reset-saved (widget)
   "Restore WIDGET to the face's default attributes.
 If there is a saved face, restore it; otherwise reset to the
diff --git a/lisp/descr-text.el b/lisp/descr-text.el
index ddd7d801d2..d8f8188eb1 100644
--- a/lisp/descr-text.el
+++ b/lisp/descr-text.el
@@ -835,8 +835,6 @@ relevant to POS."
           (if text-props-desc (insert text-props-desc))
           (setq buffer-read-only t))))))
 
-(define-obsolete-function-alias 'describe-char-after 'describe-char "22.1")
-
 ;;; Describe-Char-ElDoc
 
 (defun describe-char-eldoc--truncate (name width)
diff --git a/lisp/desktop.el b/lisp/desktop.el
index 8bd44658d8..0a1a4d5f23 100644
--- a/lisp/desktop.el
+++ b/lisp/desktop.el
@@ -158,8 +158,6 @@ Used at desktop read to provide backward compatibility.")
   "Save status of Emacs when you exit."
   :group 'frames)
 
-;; Maintained for backward compatibility
-(define-obsolete-variable-alias 'desktop-enable 'desktop-save-mode "22.1")
 ;;;###autoload
 (define-minor-mode desktop-save-mode
   "Toggle desktop saving (Desktop Save mode).
@@ -248,9 +246,6 @@ the normal hook `desktop-not-loaded-hook' is run."
   :group 'desktop
   :version "22.2")
 
-(define-obsolete-variable-alias 'desktop-basefilename
-                                'desktop-base-file-name "22.1")
-
 (defcustom desktop-base-file-name
   (convert-standard-filename ".emacs.desktop")
   "Name of file for Emacs desktop, excluding the directory part."
@@ -494,10 +489,6 @@ When file names are returned, they should be formatted using the call
 Later, when `desktop-read' evaluates the desktop file, auxiliary information
 is passed as the argument DESKTOP-BUFFER-MISC to functions in
 `desktop-buffer-mode-handlers'.")
-(make-obsolete-variable 'desktop-buffer-modes-to-save
-                        'desktop-save-buffer "22.1")
-(make-obsolete-variable 'desktop-buffer-misc-functions
-                        'desktop-save-buffer "22.1")
 
 ;;;###autoload
 (defvar desktop-buffer-mode-handlers nil
@@ -541,8 +532,6 @@ can guess how to load the mode's definition.")
 
 ;;;###autoload
 (put 'desktop-buffer-mode-handlers 'risky-local-variable t)
-(make-obsolete-variable 'desktop-buffer-handlers
-                        'desktop-buffer-mode-handlers "22.1")
 
 (defcustom desktop-minor-mode-table
   '((auto-fill-function auto-fill-mode)
@@ -1309,17 +1298,6 @@ Using it may cause conflicts.  Use it anyway? " owner)))))
       (message "No desktop file.")
       nil)))
 
-;; ----------------------------------------------------------------------------
-;; Maintained for backward compatibility
-;;;###autoload
-(defun desktop-load-default ()
-  "Load the `default' start-up library manually.
-Also inhibit further loading of it."
-  (declare (obsolete desktop-save-mode "22.1"))
-  (unless inhibit-default-init	        ; safety check
-    (load "default" t t)
-    (setq inhibit-default-init t)))
-
 ;; ----------------------------------------------------------------------------
 ;;;###autoload
 (defun desktop-change-dir (dirname)
diff --git a/lisp/dired-x.el b/lisp/dired-x.el
index fa36083e14..a1c2f4484c 100644
--- a/lisp/dired-x.el
+++ b/lisp/dired-x.el
@@ -137,8 +137,6 @@ folding to be used on case-insensitive filesystems only."
       (file-name-case-insensitive-p dir)
     dired-omit-case-fold))
 
-;; For backward compatibility
-(define-obsolete-variable-alias 'dired-omit-files-p 'dired-omit-mode "22.1")
 (define-minor-mode dired-omit-mode
   "Toggle omission of uninteresting files in Dired (Dired-Omit mode).
 With a prefix argument ARG, enable Dired-Omit mode if ARG is
diff --git a/lisp/emacs-lisp/autoload.el b/lisp/emacs-lisp/autoload.el
index 7b4a7d04f9..5274ec880c 100644
--- a/lisp/emacs-lisp/autoload.el
+++ b/lisp/emacs-lisp/autoload.el
@@ -1145,9 +1145,6 @@ write its autoloads into the specified file instead."
       ;; file-local autoload-generated-file settings.
       (autoload-save-buffers))))
 
-(define-obsolete-function-alias 'update-autoloads-from-directories
-    'update-directory-autoloads "22.1")
-
 ;;;###autoload
 (defun batch-update-autoloads ()
   "Update loaddefs.el autoloads in batch mode.
diff --git a/lisp/emacs-lisp/derived.el b/lisp/emacs-lisp/derived.el
index 547f5cd805..6b47ffea07 100644
--- a/lisp/emacs-lisp/derived.el
+++ b/lisp/emacs-lisp/derived.el
@@ -286,19 +286,6 @@ No problems result if this variable is not bound.
 	 ;; Run the hooks (and delayed-after-hook-functions), if any.
 	 (run-mode-hooks ',hook)))))
 
-;; PUBLIC: find the ultimate class of a derived mode.
-
-(defun derived-mode-class (mode)
-  "Find the class of a major MODE.
-A mode's class is the first ancestor which is NOT a derived mode.
-Use the `derived-mode-parent' property of the symbol to trace backwards.
-Since major-modes might all derive from `fundamental-mode', this function
-is not very useful."
-  (declare (obsolete derived-mode-p "22.1"))
-  (while (get mode 'derived-mode-parent)
-    (setq mode (get mode 'derived-mode-parent)))
-  mode)
-
 
 ;;; PRIVATE
 
diff --git a/lisp/emacs-lisp/generic.el b/lisp/emacs-lisp/generic.el
index e2009bf4c2..194fa1e1c2 100644
--- a/lisp/emacs-lisp/generic.el
+++ b/lisp/emacs-lisp/generic.el
@@ -96,8 +96,6 @@
 ;; Internal Variables
 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 
-(define-obsolete-variable-alias 'generic-font-lock-defaults
-  'generic-font-lock-keywords "22.1")
 (defvar generic-font-lock-keywords nil
   "Keywords for `font-lock-defaults' in a generic mode.")
 (make-variable-buffer-local 'generic-font-lock-keywords)
diff --git a/lisp/emacs-lisp/timer.el b/lisp/emacs-lisp/timer.el
index b1e12b1fd5..795554fec5 100644
--- a/lisp/emacs-lisp/timer.el
+++ b/lisp/emacs-lisp/timer.el
@@ -141,20 +141,6 @@ omitted, they are treated as zero."
   (setf (timer--time timer)
         (timer-relative-time (timer--time timer) secs usecs psecs)))
 
-(defun timer-set-time-with-usecs (timer time usecs &optional delta)
-  "Set the trigger time of TIMER to TIME plus USECS.
-TIME must be in the internal format returned by, e.g., `current-time'.
-The microsecond count from TIME is ignored, and USECS is used instead.
-If optional fourth argument DELTA is a positive number, make the timer
-fire repeatedly that many seconds apart."
-  (declare (obsolete "use `timer-set-time' and `timer-inc-time' instead."
-		     "22.1"))
-  (setf (timer--time timer) time)
-  (setf (timer--usecs timer) usecs)
-  (setf (timer--psecs timer) 0)
-  (setf (timer--repeat-delay timer) (and (numberp delta) (> delta 0) delta))
-  timer)
-
 (defun timer-set-function (timer function &optional args)
   "Make TIMER call FUNCTION with optional ARGS when triggering."
   (timer--check timer)
diff --git a/lisp/emacs-lisp/unsafep.el b/lisp/emacs-lisp/unsafep.el
index f6b569bc7f..03f22ebf1a 100644
--- a/lisp/emacs-lisp/unsafep.el
+++ b/lisp/emacs-lisp/unsafep.el
@@ -93,7 +93,7 @@ in the parse.")
 (put 'unsafep-vars 'risky-local-variable t)
 
 ;;Side-effect-free functions from subr.el
-(dolist (x '(assoc-default assoc-ignore-case butlast last match-string
+(dolist (x '(assoc-default butlast last match-string
 	     match-string-no-properties member-ignore-case remove remq))
   (put x 'side-effect-free t))
 
diff --git a/lisp/files.el b/lisp/files.el
index 4b67b02c38..b887a34791 100644
--- a/lisp/files.el
+++ b/lisp/files.el
@@ -473,7 +473,7 @@ location of point in the current buffer."
   :group 'find-file)
 
 ;;;It is not useful to make this a local variable.
-;;;(put 'find-file-not-found-hooks 'permanent-local t)
+;;;(put 'find-file-not-found-functions 'permanent-local t)
 (define-obsolete-variable-alias 'find-file-not-found-hooks
     'find-file-not-found-functions "22.1")
 (defvar find-file-not-found-functions nil
@@ -483,7 +483,8 @@ Variable `buffer-file-name' is already set up.
 The functions are called in the order given until one of them returns non-nil.")
 
 ;;;It is not useful to make this a local variable.
-;;;(put 'find-file-hooks 'permanent-local t)
+;;;(put 'find-file-hook 'permanent-local t)
+;; I found some external files still using the obsolete form in 2018.
 (define-obsolete-variable-alias 'find-file-hooks 'find-file-hook "22.1")
 (defcustom find-file-hook nil
   "List of functions to be called after a buffer is loaded from a file.
@@ -494,6 +495,7 @@ functions are called."
   :options '(auto-insert)
   :version "22.1")
 
+;; I found some external files still using the obsolete form in 2018.
 (define-obsolete-variable-alias 'write-file-hooks 'write-file-functions "22.1")
 (defvar write-file-functions nil
   "List of functions to be called before saving a buffer to a file.
@@ -513,6 +515,7 @@ node `(elisp)Saving Buffers'.)  To perform various checks or
 updates before the buffer is saved, use `before-save-hook'.")
 (put 'write-file-functions 'permanent-local t)
 
+;; I found some files still using the obsolete form in 2018.
 (defvar local-write-file-hooks nil)
 (make-variable-buffer-local 'local-write-file-hooks)
 (put 'local-write-file-hooks 'permanent-local t)
diff --git a/lisp/frame.el b/lisp/frame.el
index 0cf502d506..fbf2f6e773 100644
--- a/lisp/frame.el
+++ b/lisp/frame.el
@@ -614,9 +614,6 @@ frame.")
 (defvar after-setting-font-hook nil
   "Functions to run after a frame's font has been changed.")
 
-;; Alias, kept temporarily.
-(define-obsolete-function-alias 'new-frame 'make-frame "22.1")
-
 (defvar frame-inherited-parameters '()
   "Parameters `make-frame' copies from the selected to the new frame.")
 
@@ -1147,8 +1144,6 @@ FRAME defaults to the selected frame."
 (declare-function x-list-fonts "xfaces.c"
                   (pattern &optional face frame maximum width))
 
-(define-obsolete-function-alias 'set-default-font 'set-frame-font "23.1")
-
 (defun set-frame-font (font &optional keep-size frames)
   "Set the default font to FONT.
 When called interactively, prompt for the name of a font, and use
@@ -2113,10 +2108,6 @@ a live frame and defaults to the selected one."
         (delete-frame this))
       (setq this next))))
 
-;; miscellaneous obsolescence declarations
-(define-obsolete-variable-alias 'delete-frame-hook
-    'delete-frame-functions "22.1")
-
 
 ;;; Window dividers.
 (defgroup window-divider nil
@@ -2352,8 +2343,6 @@ This is done when a frame gets focus.  Blink timers may be stopped by
     (remove-hook 'post-command-hook 'blink-cursor-check)
     (blink-cursor--start-idle-timer)))
 
-(define-obsolete-variable-alias 'blink-cursor 'blink-cursor-mode "22.1")
-
 (define-minor-mode blink-cursor-mode
   "Toggle cursor blinking (Blink Cursor mode).
 With a prefix argument ARG, enable Blink Cursor mode if ARG is
diff --git a/lisp/generic-x.el b/lisp/generic-x.el
index 3e3ddc5ceb..d8a7fe3a73 100644
--- a/lisp/generic-x.el
+++ b/lisp/generic-x.el
@@ -241,30 +241,11 @@ This hook will be installed if the variable
     spice-generic-mode)
   "List of generic modes that are not defined by default.")
 
-(defcustom generic-define-mswindows-modes
-  (memq system-type '(windows-nt ms-dos))
-  "Non-nil means the modes in `generic-mswindows-modes' will be defined.
-This is a list of MS-Windows specific generic modes.  This variable
-only affects the default value of `generic-extras-enable-list'."
-  :group 'generic-x
-  :type 'boolean
-  :version "22.1")
-(make-obsolete-variable 'generic-define-mswindows-modes 'generic-extras-enable-list "22.1")
-
-(defcustom generic-define-unix-modes
-  (not (memq system-type '(windows-nt ms-dos)))
-  "Non-nil means the modes in `generic-unix-modes' will be defined.
-This is a list of Unix specific generic modes.  This variable only
-affects the default value of `generic-extras-enable-list'."
-  :group 'generic-x
-  :type 'boolean
-  :version "22.1")
-(make-obsolete-variable 'generic-define-unix-modes 'generic-extras-enable-list "22.1")
-
 (defcustom generic-extras-enable-list
   (append generic-default-modes
-	  (if generic-define-mswindows-modes generic-mswindows-modes)
-	  (if generic-define-unix-modes generic-unix-modes)
+          (if (memq system-type '(windows-nt ms-dos))
+              generic-mswindows-modes
+            generic-unix-modes)
 	  nil)
   "List of generic modes to define.
 Each entry in the list should be a symbol.  If you set this variable
diff --git a/lisp/gnus/spam.el b/lisp/gnus/spam.el
index 71a69cb5f0..97e63404c4 100644
--- a/lisp/gnus/spam.el
+++ b/lisp/gnus/spam.el
@@ -1244,73 +1244,40 @@ Will not return a nil score."
         (setq found backend)))
     found))
 
-(defvar spam-list-of-processors
-  ;; note the nil processors are not defined in gnus.el
-  '((gnus-group-spam-exit-processor-bogofilter   spam spam-use-bogofilter)
-    (gnus-group-spam-exit-processor-bsfilter     spam spam-use-bsfilter)
-    (gnus-group-spam-exit-processor-blacklist    spam spam-use-blacklist)
-    (gnus-group-spam-exit-processor-ifile        spam spam-use-ifile)
-    (gnus-group-spam-exit-processor-stat         spam spam-use-stat)
-    (gnus-group-spam-exit-processor-spamoracle   spam spam-use-spamoracle)
-    (gnus-group-spam-exit-processor-spamassassin spam spam-use-spamassassin)
-    (gnus-group-spam-exit-processor-report-gmane spam spam-use-gmane) ;; Buggy?
-    (gnus-group-ham-exit-processor-ifile         ham spam-use-ifile)
-    (gnus-group-ham-exit-processor-bogofilter    ham spam-use-bogofilter)
-    (gnus-group-ham-exit-processor-bsfilter      ham spam-use-bsfilter)
-    (gnus-group-ham-exit-processor-stat          ham spam-use-stat)
-    (gnus-group-ham-exit-processor-whitelist     ham spam-use-whitelist)
-    (gnus-group-ham-exit-processor-BBDB          ham spam-use-BBDB)
-    (gnus-group-ham-exit-processor-copy          ham spam-use-ham-copy)
-    (gnus-group-ham-exit-processor-spamassassin  ham spam-use-spamassassin)
-    (gnus-group-ham-exit-processor-spamoracle    ham spam-use-spamoracle))
-  "The OBSOLETE `spam-list-of-processors' list.
-This list contains pairs associating the obsolete ham/spam exit
-processor variables with a classification and a spam-use-*
-variable.  When the processor variable is nil, just the
-classification and spam-use-* check variable are used.  This is
-superseded by the new spam backend code, so it's only consulted
-for backwards compatibility.")
-(make-obsolete-variable 'spam-list-of-processors nil "22.1")
-
 (defun spam-group-processor-p (group backend &optional classification)
   "Checks if GROUP has a BACKEND with CLASSIFICATION registered.
-Also accepts the obsolete processors, which can be found in
-gnus.el and in spam-list-of-processors.  In the case of mover
-backends, checks the setting of `spam-summary-exit-behavior' in
-addition to the set values for the group."
+In the case of mover backends, checks the setting of
+`spam-summary-exit-behavior' in addition to the set values for the group."
   (if (and (stringp group)
            (symbolp backend))
-      (let ((old-style (assq backend spam-list-of-processors))
-            (parameters (nth 0 (gnus-parameter-spam-process group)))
+      (let ((parameters (nth 0 (gnus-parameter-spam-process group)))
             found)
-        (if old-style  ; old-style processor
-            (spam-group-processor-p group (nth 2 old-style) (nth 1 old-style))
-          ;; now search for the parameter
-          (dolist (parameter parameters)
-            (when (and (null found)
-                       (listp parameter)
-                       (eq classification (nth 0 parameter))
-                       (eq backend (nth 1 parameter)))
-              (setq found t)))
-
-          ;; now, if the parameter was not found, do the
-          ;; spam-summary-exit-behavior-logic for mover backends
-          (unless found
-            (when (spam-backend-mover-p backend)
-              (setq
-               found
-               (cond
-                ((eq spam-summary-exit-behavior 'move-all) t)
-                ((eq spam-summary-exit-behavior 'move-none) nil)
-                ((eq spam-summary-exit-behavior 'default)
-                 (or (eq classification 'spam) ;move spam out of all groups
-                     ;; move ham out of spam groups
-                     (and (eq classification 'ham)
-                          (spam-group-spam-contents-p group))))
-                (t (gnus-error 5 "Unknown spam-summary-exit-behavior: %s"
-                               spam-summary-exit-behavior))))))
-
-          found))
+        ;; now search for the parameter
+        (dolist (parameter parameters)
+          (when (and (null found)
+                     (listp parameter)
+                     (eq classification (nth 0 parameter))
+                     (eq backend (nth 1 parameter)))
+            (setq found t)))
+
+        ;; now, if the parameter was not found, do the
+        ;; spam-summary-exit-behavior-logic for mover backends
+        (unless found
+          (when (spam-backend-mover-p backend)
+            (setq
+             found
+             (cond
+              ((eq spam-summary-exit-behavior 'move-all) t)
+              ((eq spam-summary-exit-behavior 'move-none) nil)
+              ((eq spam-summary-exit-behavior 'default)
+               (or (eq classification 'spam) ;move spam out of all groups
+                   ;; move ham out of spam groups
+                   (and (eq classification 'ham)
+                        (spam-group-spam-contents-p group))))
+              (t (gnus-error 5 "Unknown spam-summary-exit-behavior: %s"
+                             spam-summary-exit-behavior))))))
+
+        found)
     nil))
 
 ;;}}}
diff --git a/lisp/help.el b/lisp/help.el
index e923546032..0830dc5d3c 100644
--- a/lisp/help.el
+++ b/lisp/help.el
@@ -308,8 +308,6 @@ If that doesn't give a function, return nil."
   (interactive)
   (browse-url "https://www.gnu.org/gnu/thegnuproject.html"))
 
-(define-obsolete-function-alias 'describe-project 'describe-gnu-project "22.2")
-
 (defun describe-no-warranty ()
   "Display info on all the kinds of warranty Emacs does NOT have."
   (interactive)
@@ -413,9 +411,6 @@ With argument, display info only for the selected version."
   (interactive "P")
   (view-help-file "TODO"))
 
-(define-obsolete-function-alias 'view-todo 'view-emacs-todo "22.2")
-
-
 (defun view-echo-area-messages ()
   "View the log of recent echo-area messages: the `*Messages*' buffer.
 The number of messages retained in that buffer
diff --git a/lisp/hilit-chg.el b/lisp/hilit-chg.el
index de1ae0d457..7c5294fa17 100644
--- a/lisp/hilit-chg.el
+++ b/lisp/hilit-chg.el
@@ -204,9 +204,6 @@
   :group 'highlight-changes)
 
 ;; A (not very good) default list of colors to rotate through.
-(define-obsolete-variable-alias 'highlight-changes-colours
-                                'highlight-changes-colors "22.1")
-
 (defcustom highlight-changes-colors
   (if (eq (frame-parameter nil 'background-mode) 'light)
       ;; defaults for light background:
diff --git a/lisp/ibuffer.el b/lisp/ibuffer.el
index 38fffcb976..0fd2971934 100644
--- a/lisp/ibuffer.el
+++ b/lisp/ibuffer.el
@@ -224,14 +224,6 @@ view of the buffers."
   :group 'ibuffer)
 (defvar ibuffer-sorting-reversep nil)
 
-(defcustom ibuffer-elide-long-columns nil
-  "If non-nil, then elide column entries which exceed their max length."
-  :type 'boolean
-  :group 'ibuffer)
-(make-obsolete-variable 'ibuffer-elide-long-columns
-                        "use the :elide argument of `ibuffer-formats'."
-                        "22.1")
-
 (defcustom ibuffer-eliding-string "..."
   "The string to use for eliding long columns."
   :type 'string
@@ -349,15 +341,11 @@ directory, like `default-directory'."
   :type 'regexp
   :group 'ibuffer)
 
-(define-obsolete-variable-alias 'ibuffer-hooks 'ibuffer-hook "22.1")
-
 (defcustom ibuffer-hook nil
   "Hook run when `ibuffer' is called."
   :type 'hook
   :group 'ibuffer)
 
-(define-obsolete-variable-alias 'ibuffer-mode-hooks 'ibuffer-mode-hook "22.1")
-
 (defcustom ibuffer-mode-hook nil
   "Hook run upon entry into `ibuffer-mode'."
   :type 'hook
@@ -952,7 +940,6 @@ directory, like `default-directory'."
 (defvar ibuffer-compiled-formats nil)
 (defvar ibuffer-cached-formats nil)
 (defvar ibuffer-cached-eliding-string nil)
-(defvar ibuffer-cached-elide-long-columns 0)
 
 (defvar ibuffer-sorting-functions-alist nil
   "An alist of functions which describe how to sort buffers.
@@ -1589,7 +1576,7 @@ If point is on a group name, this function operates on that group."
 
 (defun ibuffer-compile-make-eliding-form (strvar elide from-end-p)
   (let ((ellipsis (propertize ibuffer-eliding-string 'font-lock-face 'bold)))
-    (if (or elide (with-no-warnings ibuffer-elide-long-columns))
+    (if elide
 	`(if (> strlen 5)
 	     ,(if from-end-p
                   ;; FIXME: this should probably also be using
@@ -1789,9 +1776,6 @@ If point is on a group name, this function operates on that group."
 	      (not (eq ibuffer-cached-formats ibuffer-formats))
 	      (null ibuffer-cached-eliding-string)
 	      (not (equal ibuffer-cached-eliding-string ibuffer-eliding-string))
-	      (eql 0 ibuffer-cached-elide-long-columns)
-	      (not (eql ibuffer-cached-elide-long-columns
-			(with-no-warnings ibuffer-elide-long-columns)))
 	      (and ext-loaded
 		   (not (eq ibuffer-cached-filter-formats
 			    ibuffer-filter-format-alist))
@@ -1800,8 +1784,7 @@ If point is on a group name, this function operates on that group."
       (message "Formats have changed, recompiling...")
       (ibuffer-recompile-formats)
       (setq ibuffer-cached-formats ibuffer-formats
-	    ibuffer-cached-eliding-string ibuffer-eliding-string
-	    ibuffer-cached-elide-long-columns (with-no-warnings ibuffer-elide-long-columns))
+	    ibuffer-cached-eliding-string ibuffer-eliding-string)
       (when ext-loaded
 	(setq ibuffer-cached-filter-formats ibuffer-filter-format-alist))
       (message "Formats have changed, recompiling...done"))))
@@ -2746,7 +2729,6 @@ will be inserted before the group at point."
   (set (make-local-variable 'ibuffer-compiled-formats) nil)
   (set (make-local-variable 'ibuffer-cached-formats) nil)
   (set (make-local-variable 'ibuffer-cached-eliding-string) nil)
-  (set (make-local-variable 'ibuffer-cached-elide-long-columns) nil)
   (set (make-local-variable 'ibuffer-current-format) nil)
   (set (make-local-variable 'ibuffer-did-modification) nil)
   (set (make-local-variable 'ibuffer-tmp-hide-regexps) nil)
diff --git a/lisp/imenu.el b/lisp/imenu.el
index f56e7b5039..b4d7d90359 100644
--- a/lisp/imenu.el
+++ b/lisp/imenu.el
@@ -102,14 +102,7 @@ This variable is buffer-local."
   :type 'integer
   :group 'imenu)
 
-(defvar imenu-always-use-completion-buffer-p nil)
-(make-obsolete-variable 'imenu-always-use-completion-buffer-p
-			'imenu-use-popup-menu "22.1")
-
-(defcustom imenu-use-popup-menu
-  (if imenu-always-use-completion-buffer-p
-      (not (eq imenu-always-use-completion-buffer-p 'never))
-    'on-mouse)
+(defcustom imenu-use-popup-menu 'on-mouse
   "Use a popup menu rather than a minibuffer prompt.
 If nil, always use a minibuffer prompt.
 If t, always use a popup menu,
@@ -119,8 +112,7 @@ If `on-mouse' use a popup menu when `imenu' was invoked with the mouse."
 		 (other :tag "Always" t))
   :group 'imenu)
 
-(defcustom imenu-eager-completion-buffer
-  (not (eq imenu-always-use-completion-buffer-p 'never))
+(defcustom imenu-eager-completion-buffer t
   "If non-nil, eagerly popup the completion buffer."
   :type 'boolean
   :group 'imenu
diff --git a/lisp/international/latin1-disp.el b/lisp/international/latin1-disp.el
index 657f79097c..df2c1dc9a8 100644
--- a/lisp/international/latin1-disp.el
+++ b/lisp/international/latin1-disp.el
@@ -201,10 +201,6 @@ character set: `latin-2', `hebrew' etc."
 	 (char (and info (decode-char (car (remq 'ascii info)) ?\ ))))
     (and char (char-displayable-p char))))
 
-;; Backwards compatibility.
-(define-obsolete-function-alias 'latin1-char-displayable-p
-  'char-displayable-p "22.1")
-
 (defun latin1-display-setup (set &optional force)
   "Set up Latin-1 display for characters in the given SET.
 SET must be a member of `latin1-display-sets'.  Normally, check
diff --git a/lisp/isearch.el b/lisp/isearch.el
index 4f5f494875..84b121af9e 100644
--- a/lisp/isearch.el
+++ b/lisp/isearch.el
@@ -323,10 +323,6 @@ this variable is set to the symbol `all-windows'."
   :group 'isearch
   :group 'matching)
 
-(define-obsolete-variable-alias 'isearch-lazy-highlight-cleanup
-                                'lazy-highlight-cleanup
-                                "22.1")
-
 (defcustom lazy-highlight-cleanup t
   "Controls whether to remove extra highlighting after a search.
 If this is nil, extra highlighting can be \"manually\" removed with
@@ -334,28 +330,16 @@ If this is nil, extra highlighting can be \"manually\" removed with
   :type 'boolean
   :group 'lazy-highlight)
 
-(define-obsolete-variable-alias 'isearch-lazy-highlight-initial-delay
-                                'lazy-highlight-initial-delay
-                                "22.1")
-
 (defcustom lazy-highlight-initial-delay 0.25
   "Seconds to wait before beginning to lazily highlight all matches."
   :type 'number
   :group 'lazy-highlight)
 
-(define-obsolete-variable-alias 'isearch-lazy-highlight-interval
-                                'lazy-highlight-interval
-                                "22.1")
-
 (defcustom lazy-highlight-interval 0 ; 0.0625
   "Seconds between lazily highlighting successive matches."
   :type 'number
   :group 'lazy-highlight)
 
-(define-obsolete-variable-alias 'isearch-lazy-highlight-max-at-a-time
-                                'lazy-highlight-max-at-a-time
-                                "22.1")
-
 (defcustom lazy-highlight-max-at-a-time nil ; 20 (bug#25751)
   "Maximum matches to highlight at a time (for `lazy-highlight').
 Larger values may reduce Isearch's responsiveness to user input;
@@ -3202,10 +3186,6 @@ This function is called when exiting an incremental search if
     (cancel-timer isearch-lazy-highlight-timer)
     (setq isearch-lazy-highlight-timer nil)))
 
-(define-obsolete-function-alias 'isearch-lazy-highlight-cleanup
-                                'lazy-highlight-cleanup
-                                "22.1")
-
 (defun isearch-lazy-highlight-new-loop (&optional beg end)
   "Cleanup any previous `lazy-highlight' loop and begin a new one.
 BEG and END specify the bounds within which highlighting should occur.
diff --git a/lisp/mail/rmail.el b/lisp/mail/rmail.el
index 4e5873c06e..f2fdcb6367 100644
--- a/lisp/mail/rmail.el
+++ b/lisp/mail/rmail.el
@@ -191,9 +191,6 @@ Its name should end with a slash."
   :group 'rmail-retrieve
   :type '(choice (const nil) string))
 
-(define-obsolete-variable-alias 'rmail-pop-password
-  'rmail-remote-password "22.1")
-
 (defcustom rmail-remote-password nil
   "Password to use when reading mail from a remote server.
 This setting is ignored for mailboxes whose URL already contains a password."
@@ -202,9 +199,6 @@ This setting is ignored for mailboxes whose URL already contains a password."
   :group 'rmail-retrieve
   :version "22.1")
 
-(define-obsolete-variable-alias 'rmail-pop-password-required
-  'rmail-remote-password-required "22.1")
-
 (defcustom rmail-remote-password-required nil
   "Non-nil if a password is required when reading mail from a remote server."
   :type 'boolean
diff --git a/lisp/mwheel.el b/lisp/mwheel.el
index fdd2aba586..c7ada4dd38 100644
--- a/lisp/mwheel.el
+++ b/lisp/mwheel.el
@@ -52,38 +52,25 @@
   ;; Sync the bindings.
   (when (bound-and-true-p mouse-wheel-mode) (mouse-wheel-mode 1)))
 
-(defvar mouse-wheel-down-button 4)
-(make-obsolete-variable 'mouse-wheel-down-button
-                        'mouse-wheel-down-event
-			"22.1")
 (defcustom mouse-wheel-down-event
   (if (or (featurep 'w32-win) (featurep 'ns-win))
       'wheel-up
-    (intern (format "mouse-%s" mouse-wheel-down-button)))
+    'mouse-4)
   "Event used for scrolling down."
   :group 'mouse
   :type 'symbol
   :set 'mouse-wheel-change-button)
 
-(defvar mouse-wheel-up-button 5)
-(make-obsolete-variable 'mouse-wheel-up-button
-                        'mouse-wheel-up-event
-			"22.1")
 (defcustom mouse-wheel-up-event
   (if (or (featurep 'w32-win) (featurep 'ns-win))
       'wheel-down
-    (intern (format "mouse-%s" mouse-wheel-up-button)))
+    'mouse-5)
   "Event used for scrolling up."
   :group 'mouse
   :type 'symbol
   :set 'mouse-wheel-change-button)
 
-(defvar mouse-wheel-click-button 2)
-(make-obsolete-variable 'mouse-wheel-click-button
-                        'mouse-wheel-click-event
-			"22.1")
-(defcustom mouse-wheel-click-event
-  (intern (format "mouse-%s" mouse-wheel-click-button))
+(defcustom mouse-wheel-click-event 'mouse-2
   "Event that should be temporarily inhibited after mouse scrolling.
 The mouse wheel is typically on the mouse-2 button, so it may easily
 happen that text is accidentally yanked into the buffer when
diff --git a/lisp/net/goto-addr.el b/lisp/net/goto-addr.el
index ed615d10eb..cc1cdd1518 100644
--- a/lisp/net/goto-addr.el
+++ b/lisp/net/goto-addr.el
@@ -220,10 +220,6 @@ and `goto-address-fontify-p'."
 ;; code to find and goto addresses; much of this has been blatantly
 ;; snarfed from browse-url.el
 
-;;;###autoload
-(define-obsolete-function-alias
-  'goto-address-at-mouse 'goto-address-at-point "22.1")
-
 ;;;###autoload
 (defun goto-address-at-point (&optional event)
   "Send to the e-mail address or load the URL at point.
diff --git a/lisp/net/net-utils.el b/lisp/net/net-utils.el
index 9edd42b857..c9e80804bd 100644
--- a/lisp/net/net-utils.el
+++ b/lisp/net/net-utils.el
@@ -86,8 +86,6 @@ These options can be used to limit how many ICMP packets are emitted."
   :group 'net-utils
   :type  '(repeat string))
 
-(define-obsolete-variable-alias 'ipconfig-program 'ifconfig-program "22.2")
-
 (defcustom ifconfig-program
   (cond ((eq system-type 'windows-nt) "ipconfig")
         ((executable-find "ifconfig") "ifconfig")
@@ -99,9 +97,6 @@ These options can be used to limit how many ICMP packets are emitted."
   :group 'net-utils
   :type  'string)
 
-(define-obsolete-variable-alias 'ipconfig-program-options
-  'ifconfig-program-options "22.2")
-
 (defcustom ifconfig-program-options
   (cond ((string-match "ipconfig\\'" ifconfig-program) '("/all"))
         ((string-match "ifconfig\\'" ifconfig-program) '("-a"))
diff --git a/lisp/novice.el b/lisp/novice.el
index b9cd568ace..aaad4fabfe 100644
--- a/lisp/novice.el
+++ b/lisp/novice.el
@@ -34,9 +34,6 @@
 ;; The command is found in this-command
 ;; and the keys are returned by (this-command-keys).
 
-;;;###autoload
-(define-obsolete-variable-alias 'disabled-command-hook
-  'disabled-command-function "22.1")
 ;;;###autoload
 (defvar disabled-command-function 'disabled-command-function
   "Function to call to handle disabled commands.
diff --git a/lisp/obsolete/iswitchb.el b/lisp/obsolete/iswitchb.el
index 55e81d08d1..d03621df3c 100644
--- a/lisp/obsolete/iswitchb.el
+++ b/lisp/obsolete/iswitchb.el
@@ -353,8 +353,6 @@ See also `iswitchb-newbuffer'."
   :type 'boolean
   :group 'iswitchb)
 
-(define-obsolete-variable-alias 'iswitchb-use-fonts 'iswitchb-use-faces "22.1")
-
 (defcustom iswitchb-use-faces t
   "Non-nil means use font-lock faces for showing first match."
   :type 'boolean
diff --git a/lisp/play/dunnet.el b/lisp/play/dunnet.el
index f22cc240c0..2b8bd9d6b8 100644
--- a/lisp/play/dunnet.el
+++ b/lisp/play/dunnet.el
@@ -2349,7 +2349,6 @@ for a moment, then straighten yourself up.\n")
 ;;;; This section sets up the keymaps for interactive and batch dunnet.
 ;;;;
 
-(define-obsolete-variable-alias 'dungeon-mode-map 'dun-mode-map "22.1")
 (define-key dun-mode-map "\r" 'dun-parse)
 (defvar dungeon-batch-map (make-keymap))
 (if (string= (substring emacs-version 0 2) "18")
diff --git a/lisp/progmodes/compile.el b/lisp/progmodes/compile.el
index 422974379b..15503ee0b2 100644
--- a/lisp/progmodes/compile.el
+++ b/lisp/progmodes/compile.el
@@ -99,16 +99,6 @@ The function receives one argument, the name of the major mode of the
 compilation buffer.  It should return a string.
 If nil, compute the name with `(concat \"*\" (downcase major-mode) \"*\")'.")
 
-;;;###autoload
-(defvar compilation-finish-function nil
-  "Function to call when a compilation process finishes.
-It is called with two arguments: the compilation buffer, and a string
-describing how the process finished.")
-
-(make-obsolete-variable 'compilation-finish-function
-  "use `compilation-finish-functions', but it works a little differently."
-  "22.1")
-
 ;;;###autoload
 (defvar compilation-finish-functions nil
   "Functions to call when a compilation process finishes.
@@ -2101,7 +2091,6 @@ by replacing the first word, e.g., `compilation-scroll-output' from
 		   compilation-error-regexp-alist
 		   compilation-error-regexp-alist-alist
 		   compilation-error-screen-columns
-		   compilation-finish-function
 		   compilation-finish-functions
 		   compilation-first-column
 		   compilation-mode-font-lock-keywords
@@ -2245,9 +2234,6 @@ commands of Compilation major mode are available.  See
     (force-mode-line-update)
     (if (and opoint (< opoint omax))
 	(goto-char opoint))
-    (with-no-warnings
-      (if compilation-finish-function
-	  (funcall compilation-finish-function cur-buffer msg)))
     (run-hook-with-args 'compilation-finish-functions cur-buffer msg)))
 
 ;; Called when compilation process changes state.
diff --git a/lisp/progmodes/cperl-mode.el b/lisp/progmodes/cperl-mode.el
index 8c0682ac1c..09a26ddbe0 100644
--- a/lisp/progmodes/cperl-mode.el
+++ b/lisp/progmodes/cperl-mode.el
@@ -390,13 +390,6 @@ Affects: `cperl-font-lock', `cperl-electric-lbrace-space',
   :type '(repeat string)
      :group 'cperl)
 
-;; This became obsolete...
-(defvar cperl-vc-header-alist nil)
-(make-obsolete-variable
- 'cperl-vc-header-alist
- "use cperl-vc-rcs-header or cperl-vc-sccs-header instead."
- "22.1")
-
 ;; (defcustom cperl-clobber-mode-lists
 ;;   (not
 ;;    (and
@@ -1727,9 +1720,8 @@ or as help on variables `cperl-tips', `cperl-problems',
   (when (featurep 'xemacs)
     ;; This one is obsolete...
     (set (make-local-variable 'vc-header-alist)
-         (or cperl-vc-header-alist      ; Avoid warning
-	     `((SCCS ,(car cperl-vc-sccs-header))
-	       (RCS ,(car cperl-vc-rcs-header))))))
+	 `((SCCS ,(car cperl-vc-sccs-header))
+	   (RCS ,(car cperl-vc-rcs-header)))))
   (cond ((boundp 'compilation-error-regexp-alist-alist);; xemacs 20.x
 	 (set (make-local-variable 'compilation-error-regexp-alist-alist)
 	      (cons (cons 'cperl (car cperl-compilation-error-regexp-alist))
diff --git a/lisp/progmodes/gud.el b/lisp/progmodes/gud.el
index 6aa9a7e4d4..2664d03e72 100644
--- a/lisp/progmodes/gud.el
+++ b/lisp/progmodes/gud.el
@@ -3397,9 +3397,6 @@ it if ARG is omitted or nil."
 	(kill-local-variable 'gdb-define-alist)
 	(remove-hook 'after-save-hook 'gdb-create-define-alist t))))
 
-(define-obsolete-variable-alias 'tooltip-gud-modes
-                                'gud-tooltip-modes "22.1")
-
 (defcustom gud-tooltip-modes '(gud-mode c-mode c++-mode fortran-mode
 					python-mode)
   "List of modes for which to enable GUD tooltips."
@@ -3407,9 +3404,6 @@ it if ARG is omitted or nil."
   :group 'gud
   :group 'tooltip)
 
-(define-obsolete-variable-alias 'tooltip-gud-display
-                                'gud-tooltip-display "22.1")
-
 (defcustom gud-tooltip-display
   '((eq (tooltip-event-buffer gud-tooltip-event)
 	(marker-buffer gud-overlay-arrow-position)))
@@ -3501,8 +3495,6 @@ With arg, dereference expr if ARG is positive, otherwise do not dereference."
   (message "Dereferencing is now %s."
 	   (if gud-tooltip-dereference "on" "off")))
 
-(define-obsolete-function-alias 'tooltip-gud-toggle-dereference
-                                'gud-tooltip-dereference "22.1")
 (defvar tooltip-use-echo-area)
 (declare-function tooltip-show "tooltip" (text &optional use-echo-area))
 (declare-function tooltip-strip-prompt "tooltip" (process output))
diff --git a/lisp/progmodes/pascal.el b/lisp/progmodes/pascal.el
index 737dd9ea8a..58dc213d8a 100644
--- a/lisp/progmodes/pascal.el
+++ b/lisp/progmodes/pascal.el
@@ -1403,7 +1403,6 @@ The default is a name found in the buffer around point."
     map)
   "Keymap used in Pascal Outline mode.")
 
-(define-obsolete-function-alias 'pascal-outline 'pascal-outline-mode "22.1")
 (define-minor-mode pascal-outline-mode
   "Outline-line minor mode for Pascal mode.
 With a prefix argument ARG, enable the mode if ARG is positive,
diff --git a/lisp/progmodes/perl-mode.el b/lisp/progmodes/perl-mode.el
index c1d94acfa5..e667a97015 100644
--- a/lisp/progmodes/perl-mode.el
+++ b/lisp/progmodes/perl-mode.el
@@ -745,8 +745,6 @@ Turning on Perl mode runs the normal hook `perl-mode-hook'."
       0					;Existing comment at bol stays there.
     comment-column))
 
-(define-obsolete-function-alias 'electric-perl-terminator
-  'perl-electric-terminator "22.1")
 (defun perl-electric-noindent-p (_char)
   ;; To reproduce the old behavior, ;, {, }, and : are made electric, but
   ;; we only want them to be electric at EOL.
diff --git a/lisp/recentf.el b/lisp/recentf.el
index b33f22d959..c3c4e45922 100644
--- a/lisp/recentf.el
+++ b/lisp/recentf.el
@@ -228,10 +228,6 @@ This item will replace the \"More...\" item."
   :group 'recentf
   :type 'boolean)
 
-(define-obsolete-variable-alias 'recentf-menu-append-commands-p
-                                'recentf-menu-append-commands-flag
-                                "22.1")
-
 (defcustom recentf-menu-append-commands-flag t
   "Non-nil means to append command items to the menu."
   :group 'recentf
diff --git a/lisp/savehist.el b/lisp/savehist.el
index fbb5f53390..0a261b0b0c 100644
--- a/lisp/savehist.el
+++ b/lisp/savehist.el
@@ -204,29 +204,6 @@ histories, which is probably undesirable."
 	 (signal (car errvar) (cdr errvar)))))
     (savehist-install)))
 
-(defun savehist-load ()
-  "Load the variables stored in `savehist-file' and turn on Savehist mode.
-If `savehist-file' is in the old format that doesn't record
-the value of `savehist-minibuffer-history-variables', that
-value is deducted from the contents of the file."
-  (declare (obsolete savehist-mode "22.1"))
-  (savehist-mode 1)
-  ;; Old versions of savehist distributed with XEmacs didn't save
-  ;; savehist-minibuffer-history-variables.  If that variable is nil
-  ;; after loading the file, try to intuit the intended value.
-  (when (null savehist-minibuffer-history-variables)
-    (setq savehist-minibuffer-history-variables
-          (with-temp-buffer
-	    (ignore-errors
-	      (insert-file-contents savehist-file))
-            (let ((vars ()) form)
-              (while (setq form (condition-case nil
-				    (read (current-buffer)) (error nil)))
-		;; Each form read is of the form (setq VAR VALUE).
-		;; Collect VAR, i.e. (nth form 1).
-                (push (nth 1 form) vars))
-              vars)))))
-
 (defun savehist-install ()
   "Hook Savehist into Emacs.
 Normally invoked by calling `savehist-mode' to set the minor mode.
diff --git a/lisp/speedbar.el b/lisp/speedbar.el
index 7915a52df3..a231163715 100644
--- a/lisp/speedbar.el
+++ b/lisp/speedbar.el
@@ -637,9 +637,6 @@ Created from `speedbar-ignored-directory-expressions' with the function
 Use the function `speedbar-add-ignored-directory-regexp', or customize the
 variable `speedbar-ignored-directory-expressions' to modify this variable.")
 
-(define-obsolete-variable-alias 'speedbar-ignored-path-expressions
-  'speedbar-ignored-directory-expressions "22.1")
-
 (defcustom speedbar-ignored-directory-expressions
   '("[/\\]logs?[/\\]\\'")
   "List of regular expressions matching directories speedbar will ignore.
@@ -4077,26 +4074,6 @@ TEXT is the buffer's name, TOKEN and INDENT are unused."
 	 (setq font-lock-global-modes (delq 'speedbar-mode
 					    font-lock-global-modes)))))
 
-;;; Obsolete variables and functions
-
-(define-obsolete-variable-alias
-  'speedbar-ignored-path-regexp 'speedbar-ignored-directory-regexp "22.1")
-
-(define-obsolete-function-alias 'speedbar-add-ignored-path-regexp
-  'speedbar-add-ignored-directory-regexp "22.1")
-
-(define-obsolete-function-alias 'speedbar-line-path
-  'speedbar-line-directory "22.1")
-
-(define-obsolete-function-alias 'speedbar-buffers-line-path
-  'speedbar-buffers-line-directory "22.1")
-
-(define-obsolete-function-alias 'speedbar-path-line
-  'speedbar-directory-line "22.1")
-
-(define-obsolete-function-alias 'speedbar-buffers-line-path
-  'speedbar-buffers-line-directory "22.1")
-
 (provide 'speedbar)
 
 ;; run load-time hooks
diff --git a/lisp/subr.el b/lisp/subr.el
index 056392a926..b621042c23 100644
--- a/lisp/subr.el
+++ b/lisp/subr.el
@@ -680,20 +680,6 @@ If TEST is omitted or nil, `equal' is used."
       (setq tail (cdr tail)))
     value))
 
-(defun assoc-ignore-case (key alist)
-  "Like `assoc', but ignores differences in case and text representation.
-KEY must be a string.  Upper-case and lower-case letters are treated as equal.
-Unibyte strings are converted to multibyte for comparison."
-  (declare (obsolete assoc-string "22.1"))
-  (assoc-string key alist t))
-
-(defun assoc-ignore-representation (key alist)
-  "Like `assoc', but ignores differences in text representation.
-KEY must be a string.
-Unibyte strings are converted to multibyte for comparison."
-  (declare (obsolete assoc-string "22.1"))
-  (assoc-string key alist nil))
-
 (defun member-ignore-case (elt list)
   "Like `member', but ignore differences in case and text representation.
 ELT must be a string.  Upper-case and lower-case letters are treated as equal.
@@ -1491,11 +1477,6 @@ be a list of the form returned by `event-start' and `event-end'."
 (make-obsolete-variable 'command-debug-status
                         "expect it to be removed in a future version." "25.2")
 
-(define-obsolete-variable-alias 'x-lost-selection-hooks
-  'x-lost-selection-functions "22.1")
-(define-obsolete-variable-alias 'x-sent-selection-hooks
-  'x-sent-selection-functions "22.1")
-
 ;; This was introduced in 21.4 for pre-unicode unification.  That
 ;; usage was rendered obsolete in 23.1 which uses Unicode internally.
 ;; Other uses are possible, so this variable is not _really_ obsolete,
@@ -2173,19 +2154,6 @@ process."
        (memq (process-status process)
 	     '(run open listen connect stop))))
 
-;; compatibility
-
-(defun process-kill-without-query (process &optional _flag)
-  "Say no query needed if PROCESS is running when Emacs is exited.
-Optional second argument if non-nil says to require a query.
-Value is t if a query was formerly required."
-  (declare (obsolete
-            "use `process-query-on-exit-flag' or `set-process-query-on-exit-flag'."
-            "22.1"))
-  (let ((old (process-query-on-exit-flag process)))
-    (set-process-query-on-exit-flag process nil)
-    old))
-
 (defun process-kill-buffer-query-function ()
   "Ask before killing a buffer that has a running process."
   (let ((process (get-buffer-process (current-buffer))))
diff --git a/lisp/textmodes/nroff-mode.el b/lisp/textmodes/nroff-mode.el
index 9c846292f1..6955ed25e1 100644
--- a/lisp/textmodes/nroff-mode.el
+++ b/lisp/textmodes/nroff-mode.el
@@ -328,13 +328,6 @@ otherwise off."
 	(kill-buffer viewbuf))
     (Man-getpage-in-background file)))
 
-;; Old names that were not namespace clean.
-(define-obsolete-function-alias 'count-text-lines 'nroff-count-text-lines "22.1")
-(define-obsolete-function-alias 'forward-text-line 'nroff-forward-text-line "22.1")
-(define-obsolete-function-alias 'backward-text-line 'nroff-backward-text-line "22.1")
-(define-obsolete-function-alias 'electric-nroff-newline 'nroff-electric-newline "22.1")
-(define-obsolete-function-alias 'electric-nroff-mode 'nroff-electric-mode "22.1")
-
 (provide 'nroff-mode)
 
 ;;; nroff-mode.el ends here
diff --git a/lisp/vc/log-edit.el b/lisp/vc/log-edit.el
index 89b6201bab..6ff782a606 100644
--- a/lisp/vc/log-edit.el
+++ b/lisp/vc/log-edit.el
@@ -203,10 +203,7 @@ when this variable is set to nil.")
 
 (defconst log-edit-maximum-comment-ring-size 32
   "Maximum number of saved comments in the comment ring.")
-(define-obsolete-variable-alias 'vc-comment-ring 'log-edit-comment-ring "22.1")
 (defvar log-edit-comment-ring (make-ring log-edit-maximum-comment-ring-size))
-(define-obsolete-variable-alias 'vc-comment-ring-index
-  'log-edit-comment-ring-index "22.1")
 (defvar log-edit-comment-ring-index nil)
 (defvar log-edit-last-comment-match "")
 
@@ -311,13 +308,6 @@ automatically."
     (or (eobp) (looking-at "\n\n")
 	(insert "\n"))))
 
-;; Compatibility with old names.
-(define-obsolete-function-alias 'vc-previous-comment 'log-edit-previous-comment "22.1")
-(define-obsolete-function-alias 'vc-next-comment 'log-edit-next-comment "22.1")
-(define-obsolete-function-alias 'vc-comment-search-reverse 'log-edit-comment-search-backward "22.1")
-(define-obsolete-function-alias 'vc-comment-search-forward 'log-edit-comment-search-forward "22.1")
-(define-obsolete-function-alias 'vc-comment-to-change-log 'log-edit-comment-to-change-log "22.1")
-
 ;;;
 ;;; Actual code
 ;;;
diff --git a/lisp/vc/pcvs-info.el b/lisp/vc/pcvs-info.el
index 7e72767055..edcfc6e6c4 100644
--- a/lisp/vc/pcvs-info.el
+++ b/lisp/vc/pcvs-info.el
@@ -39,9 +39,6 @@
 ;;;; config variables
 ;;;;
 
-(define-obsolete-variable-alias 'cvs-display-full-path
-    'cvs-display-full-name "22.1")
-
 (defcustom cvs-display-full-name t
   "Specifies how the filenames should be displayed in the listing.
 If non-nil, their full filename name will be displayed, else only the
@@ -211,8 +208,6 @@ to confuse some users sometimes."
       ;; Here, I use `concat' rather than `expand-file-name' because I want
       ;; the resulting path to stay relative if `dir' is relative.
       (concat dir (cvs-fileinfo->file fileinfo)))))
-(define-obsolete-function-alias 'cvs-fileinfo->full-path
-    'cvs-fileinfo->full-name "22.1")
 
 (defun cvs-fileinfo->pp-name (fi)
   "Return the filename of FI as it should be displayed."
diff --git a/lisp/vc/vc.el b/lisp/vc/vc.el
index 01dc47e808..7646af075f 100644
--- a/lisp/vc/vc.el
+++ b/lisp/vc/vc.el
@@ -1649,11 +1649,6 @@ to override the value of `vc-diff-switches' and `diff-switches'."
       ;; any switches in diff-switches.
       (when (listp switches) switches))))
 
-;; Old def for compatibility with Emacs-21.[123].
-(defmacro vc-diff-switches-list (backend)
-  (declare (obsolete vc-switches "22.1"))
-  `(vc-switches ',backend 'diff))
-
 (defun vc-diff-finish (buffer messages)
   ;; The empty sync output case has already been handled, so the only
   ;; possibility of an empty output is for an async process.
-- 
2.21.0


From 79ba41e9089ca86fbfb71c0f38ec2a10f34a2722 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Sun, 11 Mar 2018 00:18:34 -0800
Subject: [PATCH 150/297] Port to NetBSD tzalloc

Problem reported by Valery Ushakov (Bug#30738).
* src/editfns.c (xtzalloc): Remove.
(invalid_time_zone_specification): New function.
(tzlookup): Port to NetBSD, where tzalloc can fail when the TZ
string has an invalid value.
---
 src/editfns.c | 22 ++++++++++++----------
 1 file changed, 12 insertions(+), 10 deletions(-)

diff --git a/src/editfns.c b/src/editfns.c
index 4271a01fb3..015b3c2191 100644
--- a/src/editfns.c
+++ b/src/editfns.c
@@ -118,14 +118,10 @@ emacs_mktime_z (timezone_t tz, struct tm *tm)
   return t;
 }
 
-/* Allocate a timezone, signaling on failure.  */
-static timezone_t
-xtzalloc (char const *name)
+static _Noreturn void
+invalid_time_zone_specification (Lisp_Object zone)
 {
-  timezone_t tz = tzalloc (name);
-  if (!tz)
-    memory_full (SIZE_MAX);
-  return tz;
+  xsignal2 (Qerror, build_string ("Invalid time zone specification"), zone);
 }
 
 /* Free a timezone, except do not free the time zone for local time.
@@ -206,9 +202,15 @@ tzlookup (Lisp_Object zone, bool settz)
 	    }
 	}
       else
-	xsignal2 (Qerror, build_string ("Invalid time zone specification"),
-		  zone);
-      new_tz = xtzalloc (zone_string);
+	invalid_time_zone_specification (zone);
+
+      new_tz = tzalloc (zone_string);
+      if (!new_tz)
+	{
+	  if (errno == ENOMEM)
+	    memory_full (SIZE_MAX);
+	  invalid_time_zone_specification (zone);
+	}
     }
 
   if (settz)
-- 
2.21.0


From bfc995759966e3ab48720a63532714dec36f5ff5 Mon Sep 17 00:00:00 2001
From: "Charles A. Roelli" <charles@aurox.ch>
Date: Sun, 11 Mar 2018 11:13:47 +0100
Subject: [PATCH 151/297] Improve and make use of 'image--get-image'

* lisp/image.el (image--get-image): Add documentation, and
check overlays for images too (since function 'put-image' from
the same library uses overlays to insert images).
(image-save): Use 'image--get-image'.
---
 lisp/image.el | 8 +++-----
 1 file changed, 3 insertions(+), 5 deletions(-)

diff --git a/lisp/image.el b/lisp/image.el
index b69bf93054..ab868f7db3 100644
--- a/lisp/image.el
+++ b/lisp/image.el
@@ -971,7 +971,8 @@ default is 20%."
                         0.8)))
 
 (defun image--get-image ()
-  (let ((image (get-text-property (point) 'display)))
+  "Return the image at point."
+  (let ((image (get-char-property (point) 'display)))
     (unless (eq (car-safe image) 'image)
       (error "No image under point"))
     image))
@@ -1026,10 +1027,7 @@ default is 20%."
 (defun image-save ()
   "Save the image under point."
   (interactive)
-  (let ((image (get-text-property (point) 'display)))
-    (when (or (not (consp image))
-              (not (eq (car image) 'image)))
-      (error "No image under point"))
+  (let ((image (image--get-image)))
     (with-temp-buffer
       (let ((file (plist-get (cdr image) :file)))
         (if file
-- 
2.21.0


From 5b5c21f3c2416800f5e846d51b7767b743a7efc2 Mon Sep 17 00:00:00 2001
From: "Charles A. Roelli" <charles@aurox.ch>
Date: Sun, 11 Mar 2018 11:25:01 +0100
Subject: [PATCH 152/297] * lisp/simple.el (mark-whole-buffer): Clarify its
 behavior.

---
 lisp/simple.el | 1 +
 1 file changed, 1 insertion(+)

diff --git a/lisp/simple.el b/lisp/simple.el
index 60a00286f8..fa93cf87c7 100644
--- a/lisp/simple.el
+++ b/lisp/simple.el
@@ -1130,6 +1130,7 @@ the actual saved text might be different from what was killed."
 
 (defun mark-whole-buffer ()
   "Put point at beginning and mark at end of buffer.
+Also push mark at point before pushing mark at end of buffer.
 If narrowing is in effect, only uses the accessible part of the buffer.
 You probably should not use this function in Lisp programs;
 it is usually a mistake for a Lisp function to use any subroutine
-- 
2.21.0


From 7a4e29f652102190ff59d8744c93b44d8c56e23c Mon Sep 17 00:00:00 2001
From: "Charles A. Roelli" <charles@aurox.ch>
Date: Sun, 11 Mar 2018 11:48:08 +0100
Subject: [PATCH 153/297] Unify documentation on 'save-some-buffers'

* doc/emacs/files.texi (Save Commands): Include some more keys
that can be used in 'save-some-buffers'.

* lisp/files.el (save-some-buffers): Include the same keys as
above, and document all missing ones.
---
 doc/emacs/files.texi |  3 +++
 lisp/files.el        | 11 ++++++++---
 2 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/doc/emacs/files.texi b/doc/emacs/files.texi
index 6594f38e88..034a4edfd6 100644
--- a/doc/emacs/files.texi
+++ b/doc/emacs/files.texi
@@ -400,11 +400,14 @@ possible responses are analogous to those of @code{query-replace}:
 
 @table @kbd
 @item y
+@item @key{SPC}
 Save this buffer and ask about the rest of the buffers.
 @item n
+@item @key{DEL}
 Don't save this buffer, but ask about the rest of the buffers.
 @item !
 Save this buffer and all the rest with no more questions.
+@item q
 @c following generates acceptable underfull hbox
 @item @key{RET}
 Terminate @code{save-some-buffers} without any more saving.
diff --git a/lisp/files.el b/lisp/files.el
index b887a34791..fbd3425cbb 100644
--- a/lisp/files.el
+++ b/lisp/files.el
@@ -5209,9 +5209,14 @@ about certain files that you'd usually rather not save."
 
 (defun save-some-buffers (&optional arg pred)
   "Save some modified file-visiting buffers.  Asks user about each one.
-You can answer `y' to save, `n' not to save, `C-r' to look at the
-buffer in question with `view-buffer' before deciding or `d' to
-view the differences using `diff-buffer-with-file'.
+You can answer `y' or SPC to save, `n' or DEL not to save, `C-r'
+to look at the buffer in question with `view-buffer' before
+deciding, `d' to view the differences using
+`diff-buffer-with-file', `!' to save the buffer and all remaining
+buffers without any further querying, `.' to save only the
+current buffer and skip the remaining ones and `q' or RET to exit
+the function without saving any more buffers.  `C-h' displays a
+help message describing these options.
 
 This command first saves any buffers where `buffer-save-without-query' is
 non-nil, without asking.
-- 
2.21.0


From 7b730d1aaf9a9270cbbb37704bf088c6447bef29 Mon Sep 17 00:00:00 2001
From: "Charles A. Roelli" <charles@aurox.ch>
Date: Sun, 11 Mar 2018 11:59:01 +0100
Subject: [PATCH 154/297] Make transpose-regions interactive (Bug#30343)

* doc/emacs/fixit.texi (Transpose): Mention and explain the new
command.
* editfns.c (Ftranspose_regions): Add an interactive calling
specification, and add documentation for it.
---
 doc/emacs/fixit.texi | 11 +++++++++++
 src/editfns.c        | 20 ++++++++++++++++++--
 2 files changed, 29 insertions(+), 2 deletions(-)

diff --git a/doc/emacs/fixit.texi b/doc/emacs/fixit.texi
index 7cacac4240..eb783d175c 100644
--- a/doc/emacs/fixit.texi
+++ b/doc/emacs/fixit.texi
@@ -149,6 +149,8 @@ Transpose two words (@code{transpose-words}).
 Transpose two balanced expressions (@code{transpose-sexps}).
 @item C-x C-t
 Transpose two lines (@code{transpose-lines}).
+@item M-x transpose-regions
+Transpose two regions.
 @end table
 
 @kindex C-t
@@ -204,6 +206,15 @@ otherwise a command with a repeat count of zero would do nothing): to
 transpose the character (or word or expression or line) ending after
 point with the one ending after the mark.
 
+@findex transpose-regions
+  @kbd{M-x transpose-regions} transposes the text between point and
+mark with the text between the last two marks pushed to the mark ring
+(@pxref{Setting Mark}).  With a numeric prefix argument, it transposes
+the text between point and mark with the text between two successive
+marks that many entries back in the mark ring.  This command is best
+used for transposing multiple characters (or words or sentences or
+paragraphs) in one go.
+
 @node Fixing Case
 @section Case Conversion
 
diff --git a/src/editfns.c b/src/editfns.c
index 015b3c2191..85d5bf4679 100644
--- a/src/editfns.c
+++ b/src/editfns.c
@@ -3367,7 +3367,16 @@ transpose_markers (ptrdiff_t start1, ptrdiff_t end1,
     }
 }
 
-DEFUN ("transpose-regions", Ftranspose_regions, Stranspose_regions, 4, 5, 0,
+DEFUN ("transpose-regions", Ftranspose_regions, Stranspose_regions, 4, 5,
+       "(if (< (length mark-ring) 2)\
+	    (error \"Other region must be marked before transposing two regions\")\
+	  (let* ((num (if current-prefix-arg\
+			 (prefix-numeric-value current-prefix-arg)\
+			0))\
+		 (ring-length (length mark-ring))\
+		 (eltnum (mod num ring-length))\
+		 (eltnum2 (mod (1+ num) ring-length)))\
+	    (list (point) (mark) (elt mark-ring eltnum) (elt mark-ring eltnum2))))",
        doc: /* Transpose region STARTR1 to ENDR1 with STARTR2 to ENDR2.
 The regions should not be overlapping, because the size of the buffer is
 never changed in a transposition.
@@ -3375,7 +3384,14 @@ never changed in a transposition.
 Optional fifth arg LEAVE-MARKERS, if non-nil, means don't update
 any markers that happen to be located in the regions.
 
-Transposing beyond buffer boundaries is an error.  */)
+Transposing beyond buffer boundaries is an error.
+
+Interactively, STARTR1 and ENDR1 are point and mark; STARTR2 and ENDR2
+are the last two marks pushed to the mark ring; LEAVE-MARKERS is nil.
+If a prefix argument N is given, STARTR2 and ENDR2 are the two
+successive marks N entries back in the mark ring.  A negative prefix
+argument instead counts forward from the oldest mark in the mark
+ring.  */)
   (Lisp_Object startr1, Lisp_Object endr1, Lisp_Object startr2, Lisp_Object endr2, Lisp_Object leave_markers)
 {
   register ptrdiff_t start1, end1, start2, end2;
-- 
2.21.0


From ee345431040aaaf283498c2616cd8753e9e80f1c Mon Sep 17 00:00:00 2001
From: "Charles A. Roelli" <charles@aurox.ch>
Date: Sun, 11 Mar 2018 12:25:21 +0100
Subject: [PATCH 155/297] Document 'transpose-sentences' and
 'transpose-paragraphs'

* doc/emacs/fixit.texi (Transpose): Add documentation and index
entries for 'transpose-sentences' and 'transpose-paragraphs'
(Bug#30343 in passing).
---
 doc/emacs/fixit.texi | 12 ++++++++++--
 1 file changed, 10 insertions(+), 2 deletions(-)

diff --git a/doc/emacs/fixit.texi b/doc/emacs/fixit.texi
index eb783d175c..0cb8565c6a 100644
--- a/doc/emacs/fixit.texi
+++ b/doc/emacs/fixit.texi
@@ -149,6 +149,10 @@ Transpose two words (@code{transpose-words}).
 Transpose two balanced expressions (@code{transpose-sexps}).
 @item C-x C-t
 Transpose two lines (@code{transpose-lines}).
+@item M-x transpose-sentences
+Transpose two sentences (@code{transpose-sentences}).
+@item M-x transpose-paragraphs
+Transpose two paragraphs (@code{transpose-paragraphs}).
 @item M-x transpose-regions
 Transpose two regions.
 @end table
@@ -185,10 +189,14 @@ punctuation characters between the words do not move.  For example,
 @samp{@w{BAR FOO,}}.  When point is at the end of the line, it will
 transpose the word before point with the first word on the next line.
 
+@findex transpose-sentences
+@findex transpose-paragraphs
   @kbd{C-M-t} (@code{transpose-sexps}) is a similar command for
 transposing two expressions (@pxref{Expressions}), and @kbd{C-x C-t}
-(@code{transpose-lines}) exchanges lines.  They work like @kbd{M-t}
-except as regards the units of text they transpose.
+(@code{transpose-lines}) exchanges lines.  @kbd{M-x
+transpose-sentences} and @kbd{M-x transpose-paragraphs} transpose
+sentences and paragraphs, respectively.  These commands work like
+@kbd{M-t} except as regards the units of text they transpose.
 
   A numeric argument to a transpose command serves as a repeat count: it
 tells the transpose command to move the character (or word or
-- 
2.21.0


From ae2e7d9e75253c5f02e1892168174b16344c95be Mon Sep 17 00:00:00 2001
From: "Charles A. Roelli" <charles@aurox.ch>
Date: Sun, 11 Mar 2018 14:56:00 +0100
Subject: [PATCH 156/297] Allow toggling Grep command abbreviation, and rename
 related symbols

* lisp/progmodes/grep.el (grep-find-hide): Rename 'grep-find-hide'
to 'grep-find-abbreviate'.
(grep-find-hide-properties): Rename to
'grep-find-abbreviate-properties'.
(grep-mode-font-lock-keywords): Even when 'grep-find-abbreviate'
is nil, fontify the verbose command options with property
'abbreviated-command', so that the toggling command can later find
these parts without refontifying.
(grep-find-show): Rename to 'grep-find-toggle-abbreviation',
simplify the code, and permit toggling the hidden command options.
(grep-mode-map): Add a menu-bar item and new separator for
'grep-find-toggle-abbreviation', and fix the incumbent separators
in the "Grep" menu-bar, of which only one was showing before this
commit, even though two were specified.
* etc/NEWS (grep):
* doc/emacs/building.texi (Grep Searching): Document these
changes, and mention 'grep-find-toggle-abbreviation'.
---
 doc/emacs/building.texi | 11 ++++++---
 etc/NEWS                |  6 +++--
 lisp/progmodes/grep.el  | 55 ++++++++++++++++++++++-------------------
 3 files changed, 41 insertions(+), 31 deletions(-)

diff --git a/doc/emacs/building.texi b/doc/emacs/building.texi
index c38b007f24..d751cb4c48 100644
--- a/doc/emacs/building.texi
+++ b/doc/emacs/building.texi
@@ -427,14 +427,17 @@ the variable @code{grep-files-aliases}.
 @kbd{M-x rgrep}.  The default value includes the data directories used
 by various version control systems.
 
-@vindex grep-find-hide
+@vindex grep-find-abbreviate
+@findex grep-find-toggle-abbreviation
   By default, the shell commands constructed for @code{lgrep},
 @code{rgrep}, and @code{zgrep} are abbreviated for display by
 concealing the part that contains a long list of files and directories
 to ignore.  You can reveal the concealed part by clicking on the
-button with ellipsis, which represents them.  To disable this
-abbreviation of the shell commands, customize the option
-@code{grep-find-hide} to a @code{nil} value.
+button with ellipsis, which represents them.  You can also
+interactively toggle viewing the concealed part by typing @kbd{M-x
+grep-find-toggle-abbreviation}.  To disable this abbreviation of the
+shell commands, customize the option @code{grep-find-abbreviate} to a
+@code{nil} value.
 
 @node Flymake
 @section Finding Syntax Errors On The Fly
diff --git a/etc/NEWS b/etc/NEWS
index 64d8cda269..825a3f9020 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -228,8 +228,10 @@ by default.
 
 *** rgrep, lgrep and zrgrep now hide part of the command line
 that contains a list of ignored directories and files.
-Clicking on the button with ellipsis unhides the truncated part.
-This truncation can be disabled by the new option 'grep-find-hide'.
+Clicking on the button with ellipsis unhides it.
+The abbreviation can be disabled by the new option
+'grep-find-abbreviate'.  The new command
+'grep-find-toggle-abbreviation' toggles it interactively.
 
 ** ERT
 
diff --git a/lisp/progmodes/grep.el b/lisp/progmodes/grep.el
index dc74ad2de5..8c0e46f35a 100644
--- a/lisp/progmodes/grep.el
+++ b/lisp/progmodes/grep.el
@@ -286,6 +286,11 @@ See `compilation-error-screen-columns'"
     (define-key map [menu-bar grep]
       (cons "Grep" (make-sparse-keymap "Grep")))
 
+    (define-key map [menu-bar grep grep-find-toggle-abbreviation]
+      '(menu-item "Toggle command abbreviation"
+                  grep-find-toggle-abbreviation
+                  :help "Toggle showing verbose command options"))
+    (define-key map [menu-bar grep compilation-separator3] '("----"))
     (define-key map [menu-bar grep compilation-kill-compilation]
       '(menu-item "Kill Grep" kill-compilation
 		  :help "Kill the currently running grep process"))
@@ -308,7 +313,7 @@ See `compilation-error-screen-columns'"
     (define-key map [menu-bar grep compilation-recompile]
       '(menu-item "Repeat grep" recompile
 		  :help "Run grep again"))
-    (define-key map [menu-bar grep compilation-separator2] '("----"))
+    (define-key map [menu-bar grep compilation-separator1] '("----"))
     (define-key map [menu-bar grep compilation-first-error]
       '(menu-item "First Match" first-error
 		  :help "Restart at the first match, visit corresponding location"))
@@ -433,24 +438,26 @@ See `compilation-error-regexp-alist' for format details.")
                       help-echo "Number of matches so far")
     "]"))
 
-(defcustom grep-find-hide t
+(defcustom grep-find-abbreviate t
   "If non-nil, hide part of rgrep/lgrep/zrgrep command line.
 The hidden part contains a list of ignored directories and files.
 Clicking on the button-like ellipsis unhides the abbreviated part
-and reveals the entire command line."
+and reveals the entire command line.  The visibility of the
+abbreviated part can also be toggled with
+`grep-find-toggle-abbreviation'."
   :type 'boolean
   :version "27.1"
   :group 'grep)
 
-(defvar grep-find-hide-properties
+(defvar grep-find-abbreviate-properties
   (let ((ellipsis (if (char-displayable-p ?…) "[…]" "[...]"))
         (map (make-sparse-keymap)))
     (define-key map [down-mouse-2] 'mouse-set-point)
-    (define-key map [mouse-2] 'grep-find-show)
-    (define-key map "\C-m" 'grep-find-show)
+    (define-key map [mouse-2] 'grep-find-toggle-abbreviation)
+    (define-key map "\C-m" 'grep-find-toggle-abbreviation)
     `(face nil display ,ellipsis mouse-face highlight
       help-echo "RET, mouse-2: show unabbreviated command"
-      keymap ,map))
+      keymap ,map abbreviated-command t))
   "Properties of button-like ellipsis on part of rgrep command line.")
 
 (defvar grep-mode-font-lock-keywords
@@ -476,10 +483,12 @@ and reveals the entire command line."
              `(face nil display ,(match-string 2)))))
      ;; Hide excessive part of rgrep command
      ("^find \\(\\. -type d .*\\\\)\\)"
-      (1 (when grep-find-hide grep-find-hide-properties)))
+      (1 (if grep-find-abbreviate grep-find-abbreviate-properties
+           '(face nil abbreviated-command t))))
      ;; Hide excessive part of lgrep command
      ("^grep \\( *--exclude.*--exclude[^ ]+\\)"
-      (1 (when grep-find-hide grep-find-hide-properties))))
+      (1 (if grep-find-abbreviate grep-find-abbreviate-properties
+           '(face nil abbreviated-command t)))))
    "Additional things to highlight in grep output.
 This gets tacked on the end of the generated expressions.")
 
@@ -1195,23 +1204,19 @@ to specify a command to run."
                  (shell-quote-argument ")")
                  " -prune -o ")))))
 
-(defun grep-find-show ()
-  "Show the hidden part of rgrep/lgrep/zrgrep command line."
+(defun grep-find-toggle-abbreviation ()
+  "Toggle showing the hidden part of rgrep/lgrep/zrgrep command line."
   (interactive)
-  (when (get-text-property (point) 'display)
-    (let ((beg (or (previous-single-property-change
-                    (min (point-max) (1+ (point))) 'display)
-                   (point)))
-          (end (or (next-single-property-change
-                    (point) 'display)
-                   (point)))
-          (inhibit-modification-hooks t)
-          (inhibit-read-only t)
-	  (buffer-undo-list t)
-	  (modified (buffer-modified-p)))
-      (remove-list-of-text-properties
-       beg end '(display help-echo mouse-face help-echo keymap))
-      (set-buffer-modified-p modified))))
+  (with-silent-modifications
+    (let* ((beg (next-single-property-change (point-min) 'abbreviated-command))
+           (end (when beg
+                  (next-single-property-change beg 'abbreviated-command))))
+      (if end
+          (if (get-text-property beg 'display)
+              (remove-list-of-text-properties
+               beg end '(display help-echo mouse-face help-echo keymap))
+            (add-text-properties beg end grep-find-abbreviate-properties))
+        (user-error "No abbreviated part to hide/show")))))
 
 ;;;###autoload
 (defun zrgrep (regexp &optional files dir confirm template)
-- 
2.21.0


From 981cfbfef18073aefd5e224993c7a272fd653c35 Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Mon, 12 Mar 2018 10:35:25 -0700
Subject: [PATCH 157/297] Revert overenthusiastic procfs fixup

Also, be more systematic in calls to string_to_number.
* src/sysdep.c (list_system_processes) [HAVE_PROCFS]: Allow pids
to be floating-point if they exceed fixnum range.  This partially
reverts my patch 2018-03-09T20:06:05Z!eggert@cs.ucla.edu, which
went too far in fixing string-to-number mishandling.
---
 src/data.c    | 2 +-
 src/lread.c   | 4 ++--
 src/process.c | 2 +-
 src/sysdep.c  | 6 +-----
 src/xfaces.c  | 2 +-
 5 files changed, 6 insertions(+), 10 deletions(-)

diff --git a/src/data.c b/src/data.c
index 1bb48722fa..06604faaae 100644
--- a/src/data.c
+++ b/src/data.c
@@ -1290,7 +1290,7 @@ If the base used is not 10, STRING is always parsed as an integer.  */)
   while (*p == ' ' || *p == '\t')
     p++;
 
-  val = string_to_number (p, b, 1);
+  val = string_to_number (p, b, true);
   return NILP (val) ? make_number (0) : val;
 }
 
diff --git a/src/lread.c b/src/lread.c
index 1f91947422..49a1bfe54d 100644
--- a/src/lread.c
+++ b/src/lread.c
@@ -2603,7 +2603,7 @@ read_integer (Lisp_Object readcharfun, EMACS_INT radix)
       invalid_syntax (buf);
     }
 
-  return string_to_number (buf, radix, 0);
+  return string_to_number (buf, radix, false);
 }
 
 
@@ -3412,7 +3412,7 @@ read1 (Lisp_Object readcharfun, int *pch, bool first_in_list)
 
 	if (!quoted && !uninterned_symbol)
 	  {
-	    Lisp_Object result = string_to_number (read_buffer, 10, 0);
+	    Lisp_Object result = string_to_number (read_buffer, 10, false);
 	    if (! NILP (result))
 	      return unbind_to (count, result);
 	  }
diff --git a/src/process.c b/src/process.c
index fac4374230..1f0565ef65 100644
--- a/src/process.c
+++ b/src/process.c
@@ -6434,7 +6434,7 @@ SIGCODE may be an integer, or a symbol whose name is a signal name.  */)
       if (NILP (tem))
 	{
 	  Lisp_Object process_number
-	    = string_to_number (SSDATA (process), 10, 1);
+	    = string_to_number (SSDATA (process), 10, true);
 	  if (NUMBERP (process_number))
 	    tem = process_number;
 	}
diff --git a/src/sysdep.c b/src/sysdep.c
index b91beaedb2..370b452fc2 100644
--- a/src/sysdep.c
+++ b/src/sysdep.c
@@ -2948,11 +2948,7 @@ list_system_processes (void)
   for (tail = proclist; CONSP (tail); tail = next)
     {
       next = XCDR (tail);
-      Lisp_Object pidstring = XCAR (tail);
-      Lisp_Object pid = Fstring_to_number (pidstring, Qnil);
-      if (!INTEGERP (pid) || XINT (pid) <= 0)
-	xsignal1 (Qoverflow_error, pidstring);
-      XSETCAR (tail, pid);
+      XSETCAR (tail, Fstring_to_number (XCAR (tail), Qnil));
     }
 
   /* directory_files_internal returns the files in reverse order; undo
diff --git a/src/xfaces.c b/src/xfaces.c
index e34e3383bc..9b527bddc4 100644
--- a/src/xfaces.c
+++ b/src/xfaces.c
@@ -3346,7 +3346,7 @@ DEFUN ("internal-set-lisp-face-attribute-from-resource",
     value = Qunspecified;
   else if (EQ (attr, QCheight))
     {
-      value = Fstring_to_number (value, make_number (10));
+      value = Fstring_to_number (value, Qnil);
       if (!INTEGERP (value) || XINT (value) <= 0)
 	signal_error ("Invalid face height from X resource", value);
     }
-- 
2.21.0


From a9ee20834544630afa970a0fc42ca01801e081e2 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 12 Mar 2018 11:25:40 -0700
Subject: [PATCH 158/297] Replace use of the obsolete write-contents-hooks

* lisp/play/gametree.el (gametree-mode):
Replace write-contents-hooks, obsolete since 22.1,
with write-contents-functions.
; * lisp/files.el: Related comment.
---
 lisp/files.el         | 1 +
 lisp/play/gametree.el | 3 +--
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/lisp/files.el b/lisp/files.el
index fbd3425cbb..8ec2bde588 100644
--- a/lisp/files.el
+++ b/lisp/files.el
@@ -521,6 +521,7 @@ updates before the buffer is saved, use `before-save-hook'.")
 (put 'local-write-file-hooks 'permanent-local t)
 (make-obsolete-variable 'local-write-file-hooks 'write-file-functions "22.1")
 
+;; I found some files still using the obsolete form in 2018.
 (define-obsolete-variable-alias 'write-contents-hooks
     'write-contents-functions "22.1")
 (defvar write-contents-functions nil
diff --git a/lisp/play/gametree.el b/lisp/play/gametree.el
index de8abd7abe..5b05ae13e2 100644
--- a/lisp/play/gametree.el
+++ b/lisp/play/gametree.el
@@ -586,8 +586,7 @@ shogi, etc.) players, it is a slightly modified version of Outline mode.
 
 \\{gametree-mode-map}"
   (auto-fill-mode 0)
-  (make-local-variable 'write-contents-hooks)
-  (add-hook 'write-contents-hooks 'gametree-save-and-hack-layout))
+  (add-hook 'write-contents-functions 'gametree-save-and-hack-layout nil t))
 
 ;;;; Goodies for mousing users
 (defun gametree-mouse-break-line-here (event)
-- 
2.21.0


From 6e8816d331cdaef2160095a0e3d278046155014c Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 12 Mar 2018 11:29:01 -0700
Subject: [PATCH 159/297] Make compiler warn about use of obsolete hooks

* lisp/emacs-lisp/bytecomp.el (byte-compile-form):
Warn about using obsolete hooks.
---
 lisp/emacs-lisp/bytecomp.el | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/lisp/emacs-lisp/bytecomp.el b/lisp/emacs-lisp/bytecomp.el
index 2a986f6cbb..b3ea9300b0 100644
--- a/lisp/emacs-lisp/bytecomp.el
+++ b/lisp/emacs-lisp/bytecomp.el
@@ -3119,6 +3119,11 @@ for symbols generated by the byte compiler itself."
              (when (assq var byte-compile-lexical-variables)
                (byte-compile-report-error
                 (format-message "%s cannot use lexical var `%s'" fn var))))))
+        ;; Warn about using obsolete hooks.
+        (if (memq fn '(add-hook remove-hook))
+            (let ((hook (car-safe (cdr form))))
+              (if (eq (car-safe hook) 'quote)
+                  (byte-compile-check-variable (cadr hook) nil))))
         (when (and (byte-compile-warning-enabled-p 'suspicious)
                    (macroexp--const-symbol-p fn))
           (byte-compile-warn "`%s' called as a function" fn))
-- 
2.21.0


From 844dcbcdb7fc97d85c50b049d393bf3ada1c5a40 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 12 Mar 2018 20:58:38 -0400
Subject: [PATCH 160/297] * lisp/loadhist.el (unload-hook-features-list):
 Remove obsolete alias.

---
 etc/NEWS         | 10 +++++-----
 lisp/loadhist.el |  2 --
 2 files changed, 5 insertions(+), 7 deletions(-)

diff --git a/etc/NEWS b/etc/NEWS
index 825a3f9020..1d6e3d2bba 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -321,11 +321,11 @@ speedbar-add-ignored-path-regexp, speedbar-buffers-line-path,
 speedbar-buffers-line-path, speedbar-ignored-path-expressions,
 speedbar-ignored-path-regexp, speedbar-line-path, speedbar-path-line,
 timer-set-time-with-usecs, tooltip-gud-display, tooltip-gud-modes,
-tooltip-gud-toggle-dereference, update-autoloads-from-directories,
-vc-comment-ring, vc-comment-ring-index, vc-comment-search-forward,
-vc-comment-search-reverse, vc-comment-to-change-log, vc-diff-switches-list,
-vc-next-comment, vc-previous-comment, view-todo, x-lost-selection-hooks,
-x-sent-selection-hooks
+tooltip-gud-toggle-dereference, unload-hook-features-list,
+update-autoloads-from-directories, vc-comment-ring, vc-comment-ring-index,
+vc-comment-search-forward, vc-comment-search-reverse, vc-comment-to-change-log,
+vc-diff-switches-list, vc-next-comment, vc-previous-comment, view-todo,
+x-lost-selection-hooks, x-sent-selection-hooks
 
 
 * Incompatible Lisp Changes in Emacs 27.1
diff --git a/lisp/loadhist.el b/lisp/loadhist.el
index e2b2ccd510..b8d9e2de0d 100644
--- a/lisp/loadhist.el
+++ b/lisp/loadhist.el
@@ -141,8 +141,6 @@ These are symbols with hooklike values whose names don't end in
 `-hook' or `-hooks', from which `unload-feature' should try to remove
 pertinent symbols.")
 
-(define-obsolete-variable-alias 'unload-hook-features-list
-    'unload-function-defs-list "22.2")
 (defvar unload-function-defs-list nil
   "List of definitions in the Lisp library being unloaded.
 
-- 
2.21.0


From 720f35981645a8ec210beff4269d9a8cfdc7fc70 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 12 Mar 2018 23:28:36 -0700
Subject: [PATCH 161/297] ; tiny NEWS fix

---
 etc/NEWS | 52 ++++++++++++++++++++++++++--------------------------
 1 file changed, 26 insertions(+), 26 deletions(-)

diff --git a/etc/NEWS b/etc/NEWS
index 1d6e3d2bba..e0368bfd12 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -292,7 +292,32 @@ This feature uses Tramp and works only on systems which support GVFS,
 i.e. GNU/Linux, roughly spoken.  See the chapter "(tramp) Archive file
 names" in the Tramp manual for full documentation of these facilities.
 
-** Some functions and variables obsolete since 22.1 have been removed:
+
+* Incompatible Lisp Changes in Emacs 27.1
+
+** The FILENAME argument to 'file-name-base' is now mandatory and no
+longer defaults to 'buffer-file-name'.
+
+---
+** The function 'eldoc-message' now accepts a single argument.
+Programs that called it with multiple arguments before should pass
+them through 'format' first.  Even that is discouraged: for ElDoc
+support, you should set 'eldoc-documentation-function' instead of
+calling 'eldoc-message' directly.
+
+** Old-style backquotes now generate an error.  They have been
+generating warnings for a decade.  To interpret old-style backquotes
+as new-style, bind the new variable 'force-new-style-backquotes' to t.
+
+** Defining a Common Lisp structure using 'cl-defstruct' or
+'cl-struct-define' whose name clashes with a builtin type (e.g.,
+'integer' or 'hash-table') now signals an error.
+
+** When formatting a floating-point number as an octal or hexadecimal
+integer, Emacs now signals an error if the number is too large for the
+implementation to format (Bug#30408).
+
+** Some functions and variables obsolete since Emacs 22 have been removed:
 archive-mouse-extract, assoc-ignore-case, assoc-ignore-representation,
 backward-text-line, blink-cursor, bookmark-exit-hooks,
 comint-use-prompt-regexp-instead-of-fields, compilation-finish-function,
@@ -328,31 +353,6 @@ vc-diff-switches-list, vc-next-comment, vc-previous-comment, view-todo,
 x-lost-selection-hooks, x-sent-selection-hooks
 
 
-* Incompatible Lisp Changes in Emacs 27.1
-
-** The FILENAME argument to 'file-name-base' is now mandatory and no
-longer defaults to 'buffer-file-name'.
-
----
-** The function 'eldoc-message' now accepts a single argument.
-Programs that called it with multiple arguments before should pass
-them through 'format' first.  Even that is discouraged: for ElDoc
-support, you should set 'eldoc-documentation-function' instead of
-calling 'eldoc-message' directly.
-
-** Old-style backquotes now generate an error.  They have been
-generating warnings for a decade.  To interpret old-style backquotes
-as new-style, bind the new variable 'force-new-style-backquotes' to t.
-
-** Defining a Common Lisp structure using 'cl-defstruct' or
-'cl-struct-define' whose name clashes with a builtin type (e.g.,
-'integer' or 'hash-table') now signals an error.
-
-** When formatting a floating-point number as an octal or hexadecimal
-integer, Emacs now signals an error if the number is too large for the
-implementation to format (Bug#30408).
-
-
 * Lisp Changes in Emacs 27.1
 
 +++
-- 
2.21.0


From 850932d98331441e2e28089bfb71b3ede679d36c Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 12 Mar 2018 23:33:12 -0700
Subject: [PATCH 162/297] * lisp/obsolete/options.el: Remove file.

; etc/NEWS: Mention this.
---
 etc/NEWS                 |   5 ++
 lisp/obsolete/options.el | 140 ---------------------------------------
 2 files changed, 5 insertions(+), 140 deletions(-)
 delete mode 100644 lisp/obsolete/options.el

diff --git a/etc/NEWS b/etc/NEWS
index e0368bfd12..934c0abc0b 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -283,6 +283,10 @@ To restore the old behavior, use
 *** New connection method "owncloud", which allows to access OwnCloud
 or NextCloud hosted files and directories.
 
+---
+** The options.el library has been removed.
+It was obsolete since Emacs 22.1, replaced by customize.
+
 
 * New Modes and Packages in Emacs 27.1
 
@@ -317,6 +321,7 @@ as new-style, bind the new variable 'force-new-style-backquotes' to t.
 integer, Emacs now signals an error if the number is too large for the
 implementation to format (Bug#30408).
 
+---
 ** Some functions and variables obsolete since Emacs 22 have been removed:
 archive-mouse-extract, assoc-ignore-case, assoc-ignore-representation,
 backward-text-line, blink-cursor, bookmark-exit-hooks,
diff --git a/lisp/obsolete/options.el b/lisp/obsolete/options.el
deleted file mode 100644
index 41637a6ecf..0000000000
--- a/lisp/obsolete/options.el
+++ /dev/null
@@ -1,140 +0,0 @@
-;;; options.el --- edit Options command for Emacs
-
-;; Copyright (C) 1985, 2001-2018 Free Software Foundation, Inc.
-
-;; Maintainer: emacs-devel@gnu.org
-;; Obsolete-since: 22.1
-
-;; This file is part of GNU Emacs.
-
-;; GNU Emacs is free software: you can redistribute it and/or modify
-;; it under the terms of the GNU General Public License as published by
-;; the Free Software Foundation, either version 3 of the License, or
-;; (at your option) any later version.
-
-;; GNU Emacs is distributed in the hope that it will be useful,
-;; but WITHOUT ANY WARRANTY; without even the implied warranty of
-;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-;; GNU General Public License for more details.
-
-;; You should have received a copy of the GNU General Public License
-;; along with GNU Emacs.  If not, see <https://www.gnu.org/licenses/>.
-
-;;; Commentary:
-
-;; This code provides functions to list and edit the values of all global
-;; option variables known to loaded Emacs Lisp code.  There are two entry
-;; points, `list-options' and `edit' options'.  The latter enters a major
-;; mode specifically for editing option values.  Do `M-x describe-mode' in
-;; that context for more details.
-
-;; The customization buffer feature is intended to make this obsolete.
-
-;;; Code:
-
-;;;###autoload
-(defun list-options ()
-  "Display a list of Emacs user options, with values and documentation.
-It is now better to use Customize instead."
-  (interactive)
-  (with-output-to-temp-buffer "*List Options*"
-    (let (vars)
-      (princ "This facility is obsolete; we recommend using M-x customize instead.")
-
-      (mapatoms (function (lambda (sym)
-			    (if (custom-variable-p sym)
-				(setq vars (cons sym vars))))))
-      (setq vars (sort vars 'string-lessp))
-      (while vars
-	(let ((sym (car vars)))
-	  (when (boundp sym)
-	    (princ ";; ")
-	    (prin1 sym)
-	    (princ ":\n\t")
-	    (prin1 (symbol-value sym))
-	    (terpri)
-	    (princ (substitute-command-keys
-		    (documentation-property sym 'variable-documentation)))
-	    (princ "\n;;\n"))
-	  (setq vars (cdr vars))))
-      (with-current-buffer "*List Options*"
-	(Edit-options-mode)
-	(setq buffer-read-only t)))))
-
-;;;###autoload
-(defun edit-options ()
-  "Edit a list of Emacs user option values.
-Selects a buffer containing such a list,
-in which there are commands to set the option values.
-Type \\[describe-mode] in that buffer for a list of commands.
-
-The Custom feature is intended to make this obsolete."
-  (interactive)
-  (list-options)
-  (pop-to-buffer "*List Options*"))
-
-(defvar Edit-options-mode-map
-  (let ((map (make-keymap)))
-    (define-key map "s" 'Edit-options-set)
-    (define-key map "x" 'Edit-options-toggle)
-    (define-key map "1" 'Edit-options-t)
-    (define-key map "0" 'Edit-options-nil)
-    (define-key map "p" 'backward-paragraph)
-    (define-key map " " 'forward-paragraph)
-    (define-key map "n" 'forward-paragraph)
-    map)
-  "")
-
-;; Edit Options mode is suitable only for specially formatted data.
-(put 'Edit-options-mode 'mode-class 'special)
-
-(define-derived-mode Edit-options-mode emacs-lisp-mode "Options"
-  "\\<Edit-options-mode-map>\
-Major mode for editing Emacs user option settings.
-Special commands are:
-\\[Edit-options-set] -- set variable point points at.  New value read using minibuffer.
-\\[Edit-options-toggle] -- toggle variable, t -> nil, nil -> t.
-\\[Edit-options-t] -- set variable to t.
-\\[Edit-options-nil] -- set variable to nil.
-Changed values made by these commands take effect immediately.
-
-Each variable description is a paragraph.
-For convenience, the characters \\[backward-paragraph] and \\[forward-paragraph] move back and forward by paragraphs."
-  (setq-local paragraph-separate "[^\^@-\^?]")
-  (setq-local paragraph-start "\t")
-  (setq-local truncate-lines t))
-
-(defun Edit-options-set () (interactive)
-  (Edit-options-modify
-   (lambda (var) (eval-minibuffer (concat "New " (symbol-name var) ": ")))))
-
-(defun Edit-options-toggle () (interactive)
-  (Edit-options-modify (lambda (var) (not (symbol-value var)))))
-
-(defun Edit-options-t () (interactive)
-  (Edit-options-modify (lambda (var) t)))
-
-(defun Edit-options-nil () (interactive)
-  (Edit-options-modify (lambda (var) nil)))
-
-(defun Edit-options-modify (modfun)
-  (save-excursion
-   (let ((buffer-read-only nil) var pos)
-     (re-search-backward "^;; \\|\\`")
-     (forward-char 3)
-     (setq pos (point))
-     (save-restriction
-       (narrow-to-region pos (progn (end-of-line) (1- (point))))
-       (goto-char pos)
-       (setq var (read (current-buffer))))
-     (goto-char pos)
-     (forward-line 1)
-     (forward-char 1)
-     (save-excursion
-       (set var (funcall modfun var)))
-     (kill-sexp 1)
-     (prin1 (symbol-value var) (current-buffer)))))
-
-(provide 'options)
-
-;;; options.el ends here
-- 
2.21.0


From 1789a8ae9dd96531174fbf98a477593d3b0f2ef7 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 12 Mar 2018 23:42:17 -0700
Subject: [PATCH 163/297] * lisp/subr.el (focus-frame, unfocus-frame): Remove
 obsolete no-ops.

* lisp/vc/ediff-util.el (ediff-recenter):
Don't try focus-frame on Emacs.
; * etc/NEWS: Mention this.
; Comments in subr.el mention VM as a user, however this is untrue since
; 2010-07.  Ref https://bazaar.launchpad.net/~vm/vm/trunk/revision/840
; and 853.
---
 etc/NEWS              | 6 +++---
 lisp/subr.el          | 6 ------
 lisp/vc/ediff-util.el | 4 ++--
 3 files changed, 5 insertions(+), 11 deletions(-)

diff --git a/etc/NEWS b/etc/NEWS
index 934c0abc0b..6c836fd9fb 100644
--- a/etc/NEWS
+++ b/etc/NEWS
@@ -333,8 +333,8 @@ desktop-basefilename, desktop-buffer-handlers,
 desktop-buffer-misc-functions, desktop-buffer-modes-to-save,
 desktop-enable, desktop-load-default, dired-omit-files-p,
 disabled-command-hook, dungeon-mode-map, electric-nroff-mode,
-electric-nroff-newline, electric-perl-terminator, forward-text-line,
-generic-define-mswindows-modes, generic-define-unix-modes,
+electric-nroff-newline, electric-perl-terminator, focus-frame,
+forward-text-line, generic-define-mswindows-modes, generic-define-unix-modes,
 generic-font-lock-defaults, goto-address-at-mouse,
 highlight-changes-colours, ibuffer-elide-long-columns, ibuffer-hooks,
 ibuffer-mode-hooks, icalendar-convert-diary-to-ical,
@@ -351,7 +351,7 @@ speedbar-add-ignored-path-regexp, speedbar-buffers-line-path,
 speedbar-buffers-line-path, speedbar-ignored-path-expressions,
 speedbar-ignored-path-regexp, speedbar-line-path, speedbar-path-line,
 timer-set-time-with-usecs, tooltip-gud-display, tooltip-gud-modes,
-tooltip-gud-toggle-dereference, unload-hook-features-list,
+tooltip-gud-toggle-dereference, unfocus-frame, unload-hook-features-list,
 update-autoloads-from-directories, vc-comment-ring, vc-comment-ring-index,
 vc-comment-search-forward, vc-comment-search-reverse, vc-comment-to-change-log,
 vc-diff-switches-list, vc-next-comment, vc-previous-comment, view-todo,
diff --git a/lisp/subr.el b/lisp/subr.el
index b621042c23..113bd978b6 100644
--- a/lisp/subr.el
+++ b/lisp/subr.el
@@ -1449,12 +1449,6 @@ be a list of the form returned by `event-start' and `event-end'."
   (declare (obsolete log "24.4"))
   (log x 10))
 
-;; These are used by VM and some old programs
-(defalias 'focus-frame 'ignore "")
-(make-obsolete 'focus-frame "it does nothing." "22.1")
-(defalias 'unfocus-frame 'ignore "")
-(make-obsolete 'unfocus-frame "it does nothing." "22.1")
-
 (set-advertised-calling-convention
  'all-completions '(string collection &optional predicate) "23.1")
 (set-advertised-calling-convention 'unintern '(name obarray) "23.3")
diff --git a/lisp/vc/ediff-util.el b/lisp/vc/ediff-util.el
index be36273592..1158b7146e 100644
--- a/lisp/vc/ediff-util.el
+++ b/lisp/vc/ediff-util.el
@@ -778,8 +778,8 @@ Reestablish the default window display."
 	  (select-frame-set-input-focus ediff-control-frame)
 	(raise-frame ediff-control-frame)
 	(select-frame ediff-control-frame)
-	(if (fboundp 'focus-frame)
-	    (focus-frame ediff-control-frame))))
+	(and (featurep 'xemacs) (fboundp 'focus-frame)
+	     (focus-frame ediff-control-frame))))
 
   ;; Redisplay whatever buffers are showing, if there is a selected difference
   (let ((control-frame ediff-control-frame)
-- 
2.21.0


From fa066d2d7214523dc8bd023e69e6dceafe7ba189 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Tue, 13 Mar 2018 20:00:54 +0200
Subject: [PATCH 164/297] * src/xdisp.c (Fwindow_text_pixel_size): Fix last
 change.

---
 src/xdisp.c | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/src/xdisp.c b/src/xdisp.c
index a47bea87d2..f778ebe53a 100644
--- a/src/xdisp.c
+++ b/src/xdisp.c
@@ -10143,14 +10143,12 @@ include the height of both, if present, in the return value.  */)
      directionality, and regions that begin and end in text of the
      same directionality.  */
   it.bidi_p = false;
-  void *it2data = NULL;
-  struct it it2;
-  SAVE_IT (it2, it, it2data);
 
   int move_op = MOVE_TO_POS | MOVE_TO_Y;
   int to_x = -1;
   if (!NILP (x_limit))
     {
+      it.last_visible_x = max_x;
       /* Actually, we never want move_it_to stop at to_x.  But to make
 	 sure that move_it_in_display_line_to always moves far enough,
 	 we set to_x to INT_MAX and specify MOVE_TO_X.  */
@@ -10158,6 +10156,10 @@ include the height of both, if present, in the return value.  */)
       to_x = INT_MAX;
     }
 
+  void *it2data = NULL;
+  struct it it2;
+  SAVE_IT (it2, it, it2data);
+
   x = move_it_to (&it, end, to_x, max_y, -1, move_op);
 
   /* We could have a display property at END, in which case asking
-- 
2.21.0


From ea63c2eb477c5f6e61bbe554984c3099d96c0e60 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Tue, 13 Mar 2018 18:45:38 -0400
Subject: [PATCH 165/297] Try to stop tramp test hangs on hydra

* test/lisp/net/tramp-tests.el (tramp-test41-asynchronous-requests):
Use fewer processes on hydra.
---
 test/lisp/net/tramp-tests.el | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/test/lisp/net/tramp-tests.el b/test/lisp/net/tramp-tests.el
index d11bf46fd6..193d3c9a4b 100644
--- a/test/lisp/net/tramp-tests.el
+++ b/test/lisp/net/tramp-tests.el
@@ -4722,6 +4722,8 @@ process sentinels.  They shall not disturb each other."
 
   ;; This test could be blocked on hydra.  So we set a timeout of 300
   ;; seconds, and we send a SIGUSR1 signal after 300 seconds.
+  ;; This clearly doesn't work though, because the test not
+  ;; infrequently hangs for hours until killed by the infrastructure.
   (with-timeout (300 (tramp--test-timeout-handler))
     (define-key special-event-map [sigusr1] 'tramp--test-timeout-handler)
     (tramp--test-instrument-test-case (if (getenv "EMACS_HYDRA_CI") 10 0)
@@ -4746,6 +4748,7 @@ process sentinels.  They shall not disturb each other."
             (or
              (ignore-errors
                (string-to-number (getenv "REMOTE_PARALLEL_PROCESSES")))
+	     (if (getenv "EMACS_HYDRA_CI") 5)
              10))
            ;; On hydra, timings are bad.
            (timer-repeat
-- 
2.21.0


From 64b2e2181017e0e996a6ed4ce41f3b22068fd022 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Sun, 11 Mar 2018 19:38:48 +0200
Subject: [PATCH 166/297] Improve documentation of Xref

* doc/emacs/maintaining.texi (Looking Up Identifiers): Document
xref-etags-mode.
---
 doc/emacs/maintaining.texi | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/doc/emacs/maintaining.texi b/doc/emacs/maintaining.texi
index a400b2d628..806c90b11e 100644
--- a/doc/emacs/maintaining.texi
+++ b/doc/emacs/maintaining.texi
@@ -1812,6 +1812,8 @@ Find definition of identifier, and display it in a new frame
 @item M-,
 Go back to where you previously invoked @kbd{M-.} and friends
 (@code{xref-pop-marker-stack}).
+@item M-x xref-etags-mode
+Switch @code{xref} to use the @code{etags} backend.
 @end table
 
 @kindex M-.
@@ -1871,6 +1873,18 @@ where you were with @kbd{M-,}.  @kbd{M-,} allows you to retrace your
 steps to a depth determined by the variable
 @code{xref-marker-ring-length}, which defaults to 16.
 
+@findex xref-etags-mode
+  Some major modes install @code{xref} support facilities that might
+fail to find certain identifiers.  For example, in Emacs Lisp mode
+(@pxref{Lisp Eval}) @kbd{M-.} will by default find only functions and
+variables from Lisp packages that are loaded into the current Emacs
+session.  To find more identifiers, turn on the Xref Etags minor mode
+with @w{@kbd{M-x xref-etags-mode}}.  This command forces @code{xref}
+to use the @code{etags} backend (@pxref{Xref}).  (For this to work,
+you should first run @command{etags} to create the tags table, see
+@ref{Create Tags Table}.)
+
+
 @node Xref Commands
 @subsubsection Commands Available in the @file{*xref*} Buffer
 @cindex commands in @file{*xref*} buffers
-- 
2.21.0


From 5e84f54dd911adf1bd9294d2c0f7f2bd5c2a777a Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Sun, 11 Mar 2018 20:07:38 +0200
Subject: [PATCH 167/297] More changes in the Emacs manual

* doc/emacs/text.texi (Words, Foldout, Table Conversion): Clarify
text.  Reported by Gijs Hillenius <gijs@hillenius.net> in
emacs-manual-bugs@gnu.org.

* doc/emacs/msdos.texi (Windows Keyboard):
* doc/emacs/msdos-xtra.texi (MS-DOS Keyboard):
* doc/emacs/macos.texi (Mac / GNUstep Basics):
* doc/emacs/glossary.texi (Glossary):
* doc/emacs/custom.texi (Function Keys, Init Syntax):
* doc/emacs/commands.texi (User Input):
* doc/emacs/basic.texi (Arguments): Fix capitalization of "Meta".
* doc/emacs/msdos.texi (Windows Keyboard):
* doc/emacs/dired.texi (Dired Updating):
* doc/emacs/custom.texi (Init Rebinding): Fix misuses of @key.
Suggested by Richard Stallman <rms@gnu.org>.
---
 doc/emacs/basic.texi    |  4 ++--
 doc/emacs/commands.texi | 12 ++++++------
 doc/emacs/custom.texi   | 19 ++++++++++---------
 doc/emacs/dired.texi    |  2 +-
 doc/emacs/glossary.texi | 14 +++++++-------
 doc/emacs/macos.texi    |  2 +-
 doc/emacs/msdos.texi    | 12 ++++++------
 doc/emacs/text.texi     |  7 +++----
 8 files changed, 36 insertions(+), 36 deletions(-)

diff --git a/doc/emacs/basic.texi b/doc/emacs/basic.texi
index b9e0ce4404..3fec5f44de 100644
--- a/doc/emacs/basic.texi
+++ b/doc/emacs/basic.texi
@@ -728,7 +728,7 @@ direction.
 @findex digit-argument
 @findex negative-argument
   The easiest way to specify a numeric argument is to type a digit
-and/or a minus sign while holding down the @key{META} key.  For
+and/or a minus sign while holding down the @key{Meta} key.  For
 example,
 
 @example
@@ -742,7 +742,7 @@ well as @kbd{M--}, are bound to commands (@code{digit-argument} and
 command.  @kbd{M--} without digits normally means @minus{}1.
 
 If you enter more than one digit, you need not hold down the
-@key{META} key for the second and subsequent digits.  Thus, to move
+@key{Meta} key for the second and subsequent digits.  Thus, to move
 down fifty lines, type
 
 @example
diff --git a/doc/emacs/commands.texi b/doc/emacs/commands.texi
index 8b8b0c7aad..a992dedc92 100644
--- a/doc/emacs/commands.texi
+++ b/doc/emacs/commands.texi
@@ -44,25 +44,25 @@ are certain characters found on non-English keyboards
 @cindex M-
   Emacs also recognizes control characters that are entered using
 @dfn{modifier keys}.  Two commonly-used modifier keys are
-@key{Control} (usually labeled @key{Ctrl}), and @key{META} (usually
-labeled @key{Alt})@footnote{We refer to @key{Alt} as @key{META} for
+@key{Control} (usually labeled @key{Ctrl}), and @key{Meta} (usually
+labeled @key{Alt})@footnote{We refer to @key{Alt} as @key{Meta} for
 historical reasons.}.  For example, @kbd{Control-a} is entered by
 holding down the @key{Ctrl} key while pressing @kbd{a}; we will refer
-to this as @kbd{C-a} for short.  Similarly, @kbd{@key{META}-a}, or @kbd{M-a}
+to this as @kbd{C-a} for short.  Similarly, @kbd{@key{Meta}-a}, or @kbd{M-a}
 for short, is entered by holding down the @key{Alt} key and pressing
 @kbd{a}.  Modifier keys can also be applied to non-alphanumerical
 characters, e.g., @kbd{C-@key{F1}} or @kbd{M-@key{LEFT}}.
 
-@cindex @key{ESC} replacing @key{META} key
+@cindex @key{ESC} replacing @key{Meta} key
   You can also type Meta characters using two-character sequences
 starting with @key{ESC}.  Thus, you can enter @kbd{M-a} by typing
 @kbd{@key{ESC} a}.  You can enter @kbd{C-M-a} (holding down both
 @key{Ctrl} and @key{Alt}, then pressing @kbd{a}) by typing
-@kbd{@key{ESC} C-a}.  Unlike @key{META}, @key{ESC} is entered as a
+@kbd{@key{ESC} C-a}.  Unlike @key{Meta}, @key{ESC} is entered as a
 separate character.  You don't hold down @key{ESC} while typing the
 next character; instead, press @key{ESC} and release it, then enter
 the next character.  This feature is useful on certain text terminals
-where the @key{META} key does not function reliably.
+where the @key{Meta} key does not function reliably.
 
 @cindex keys stolen by window manager
 @cindex window manager, keys stolen by
diff --git a/doc/emacs/custom.texi b/doc/emacs/custom.texi
index d28259c3df..a5ce85440a 100644
--- a/doc/emacs/custom.texi
+++ b/doc/emacs/custom.texi
@@ -1742,10 +1742,11 @@ characters.  For example, here's how to bind @kbd{C-x M-l} to
 (global-set-key "\C-x\M-l" 'make-symbolic-link)
 @end example
 
-  To put @key{TAB}, @key{RET}, @key{ESC}, or @key{DEL} in the string,
-use the Emacs Lisp escape sequences @samp{\t}, @samp{\r}, @samp{\e},
-and @samp{\d} respectively.  Here is an example which binds @kbd{C-x
-@key{TAB}} to @code{indent-rigidly} (@pxref{Indentation}):
+  To bind a key sequence including @key{TAB}, @key{RET}, @key{ESC}, or
+@key{DEL}, the string should contain the Emacs Lisp escape sequence
+@samp{\t}, @samp{\r}, @samp{\e}, or @samp{\d} respectively.  Here is
+an example which binds @kbd{C-x @key{TAB}} to @code{indent-rigidly}
+(@pxref{Indentation}):
 
 @example
 (global-set-key "\C-x\t" 'indent-rigidly)
@@ -1819,11 +1820,11 @@ historical.
 characters case-sensitive when you customize Emacs.  For instance, you
 could make @kbd{M-a} and @kbd{M-A} run different commands.
 
-  Although only the @key{Control} and @key{META} modifier keys are
+  Although only the @key{Control} and @key{Meta} modifier keys are
 commonly used, Emacs supports three other modifier keys.  These are
 called @key{Super}, @key{Hyper}, and @key{Alt}.  Few terminals provide
 ways to use these modifiers; the key labeled @key{Alt} on most
-keyboards usually issues the @key{META} modifier, not @key{Alt}.  The
+keyboards usually issues the @key{Meta} modifier, not @key{Alt}.  The
 standard key bindings in Emacs do not include any characters with
 these modifiers.  However, you can customize Emacs to assign meanings
 to them.  The modifier bits are labeled as @samp{s-}, @samp{H-} and
@@ -1893,7 +1894,7 @@ the numeric keypad produces @code{kp-8}, which is translated to
 such as @kbd{8} or @key{UP}, it affects the equivalent keypad key too.
 However, if you rebind a @samp{kp-} key directly, that won't affect
 its non-keypad equivalent.  Note that the modified keys are not
-translated: for instance, if you hold down the @key{META} key while
+translated: for instance, if you hold down the @key{Meta} key while
 pressing the @samp{8} key on the numeric keypad, that generates
 @kbd{M-@key{kp-8}}.
 
@@ -2239,8 +2240,8 @@ sequences are mandatory.
 
 @samp{\C-} can be used as a prefix for a control character, as in
 @samp{\C-s} for @acronym{ASCII} control-S, and @samp{\M-} can be used as a prefix for
-a Meta character, as in @samp{\M-a} for @kbd{@key{META}-A} or
-@samp{\M-\C-a} for @kbd{@key{Ctrl}-@key{META}-A}.
+a Meta character, as in @samp{\M-a} for @kbd{@key{Meta}-A} or
+@samp{\M-\C-a} for @kbd{@key{Ctrl}-@key{Meta}-A}.
 
 @xref{Init Non-ASCII}, for information about including
 non-@acronym{ASCII} in your init file.
diff --git a/doc/emacs/dired.texi b/doc/emacs/dired.texi
index 14d5243387..f99377d1f7 100644
--- a/doc/emacs/dired.texi
+++ b/doc/emacs/dired.texi
@@ -1240,7 +1240,7 @@ contents of the corresponding subdirectory.
   If you use @kbd{C-x d} or some other Dired command to visit a
 directory that is already being shown in a Dired buffer, Dired
 switches to that buffer but does not update it.  If the buffer is not
-up-to-date, Dired displays a warning telling you to type @key{g} to
+up-to-date, Dired displays a warning telling you to type @kbd{g} to
 update it.  You can also tell Emacs to revert each Dired buffer
 automatically when you revisit it, by setting the variable
 @code{dired-auto-revert-buffer} to a non-@code{nil} value.
diff --git a/doc/emacs/glossary.texi b/doc/emacs/glossary.texi
index 4ad574156a..2d2f14efda 100644
--- a/doc/emacs/glossary.texi
+++ b/doc/emacs/glossary.texi
@@ -29,7 +29,7 @@ Alt is the name of a modifier bit that a keyboard input character may
 have.  To make a character Alt, type it while holding down the @key{Alt}
 key.  Such characters are given names that start with @kbd{@key{Alt}-}
 (usually written @kbd{A-} for short).  (Note that many terminals have a
-key labeled @key{Alt} that is really a @key{META} key.)  @xref{User
+key labeled @key{Alt} that is really a @key{Meta} key.)  @xref{User
 Input, Alt}.
 
 @item Argument
@@ -174,7 +174,7 @@ misspelling.
 
 @item @kbd{C-M-}
 @kbd{C-M-} in the name of a character is an abbreviation for
-Control-Meta.  If your terminal lacks a real @key{META} key, you type
+Control-Meta.  If your terminal lacks a real @key{Meta} key, you type
 a Control-Meta character by typing @key{ESC} and then typing the
 corresponding Control character.  @xref{User Input,C-M-}.
 
@@ -507,7 +507,7 @@ Such messages appear in the echo area, accompanied by a beep.
 
 @item @key{ESC}
 @key{ESC} is a character used as a prefix for typing Meta characters on
-keyboards lacking a @key{META} key.  Unlike the @key{META} key (which,
+keyboards lacking a @key{Meta} key.  Unlike the @key{Meta} key (which,
 like the @key{SHIFT} key, is held down while another character is
 typed), you press the @key{ESC} key as you would press a letter key, and
 it applies to the next character you type.
@@ -881,7 +881,7 @@ A local value of a variable (q.v.@:) applies to only one buffer.
 @xref{Locals}.
 
 @item @kbd{M-}
-@kbd{M-} in the name of a character is an abbreviation for @key{META},
+@kbd{M-} in the name of a character is an abbreviation for @key{Meta},
 one of the modifier keys that can accompany any character.
 @xref{User Input,M-}.
 
@@ -939,15 +939,15 @@ a keyboard interface to navigate it.  @xref{Menu Bars}.
 
 @item Meta
 Meta is the name of a modifier bit which you can use in a command
-character.  To enter a meta character, you hold down the @key{META}
+character.  To enter a meta character, you hold down the @key{Meta}
 key while typing the character.  We refer to such characters with
 names that start with @kbd{Meta-} (usually written @kbd{M-} for
-short).  For example, @kbd{M-<} is typed by holding down @key{META}
+short).  For example, @kbd{M-<} is typed by holding down @key{Meta}
 and at the same time typing @kbd{<} (which itself is done, on most
 terminals, by holding down @key{SHIFT} and typing @kbd{,}).
 @xref{User Input,Meta}.
 
-On some terminals, the @key{META} key is actually labeled @key{Alt}
+On some terminals, the @key{Meta} key is actually labeled @key{Alt}
 or @key{Edit}.
 
 @item Meta Character
diff --git a/doc/emacs/macos.texi b/doc/emacs/macos.texi
index bf37d67b64..4982c78f2e 100644
--- a/doc/emacs/macos.texi
+++ b/doc/emacs/macos.texi
@@ -35,7 +35,7 @@ Support}), but we hope to improve it in the future.
 @section Basic Emacs usage under macOS and GNUstep
 
   By default, the @key{Alt} and @key{Option} keys are the same as
-@key{META}.  The Mac @key{Cmd} key is the same as @key{Super}, and
+@key{Meta}.  The Mac @key{Cmd} key is the same as @key{Super}, and
 Emacs provides a set of key bindings using this modifier key that mimic
 other Mac / GNUstep applications (@pxref{Mac / GNUstep Events}).  You
 can change these bindings in the usual way (@pxref{Key Bindings}).
diff --git a/doc/emacs/msdos.texi b/doc/emacs/msdos.texi
index c1bcb2bb6e..dc282e18d5 100644
--- a/doc/emacs/msdos.texi
+++ b/doc/emacs/msdos.texi
@@ -533,7 +533,7 @@ Windows-specific variables in this category.
 @ifnottex
 @vindex w32-alt-is-meta
 @cindex @code{Alt} key (MS-Windows)
-  By default, the key labeled @key{Alt} is mapped as the @key{META}
+  By default, the key labeled @key{Alt} is mapped as the @key{Meta}
 key.  If you wish it to produce the @code{Alt} modifier instead, set
 the variable @code{w32-alt-is-meta} to a @code{nil} value.
 
@@ -591,8 +591,8 @@ Windows key and @key{R} opens the Windows @code{Run} dialog.
 
   The hotkey registrations always also include all the shift and
 control modifier combinations for the given hotkey; that is,
-registering @kbd{s-@key{a}} as a hotkey gives you @kbd{S-s-@key{a}},
-@kbd{C-s-@key{a}} and @kbd{C-S-s-@key{a}} as well.
+registering @kbd{s-a} as a hotkey gives you @kbd{S-s-a},
+@kbd{C-s-a} and @kbd{C-S-s-a} as well.
 
   On Windows 98 and ME, the hotkey registration is more restricted.
 The desired hotkey must always be fully specified, and
@@ -656,8 +656,8 @@ value other than the above modifier symbols.
 @cindex @code{Alt} key invokes menu (Windows)
   Emacs compiled as a native Windows application normally turns off
 the Windows feature that tapping the @key{Alt} key invokes the Windows
-menu.  The reason is that the @key{Alt} serves as @key{META} in Emacs.
-When using Emacs, users often press the @key{META} key temporarily and
+menu.  The reason is that the @key{Alt} serves as @key{Meta} in Emacs.
+When using Emacs, users often press the @key{Meta} key temporarily and
 then change their minds; if this has the effect of bringing up the
 Windows menu, it alters the meaning of subsequent commands.  Many
 users find this frustrating.
@@ -687,7 +687,7 @@ the combination of the right @key{Alt} and left @key{Ctrl} keys
 pressed together, is recognized as the @key{AltGr} key.  The default
 is @code{t}, which means these keys produce @code{AltGr}; setting it
 to @code{nil} causes @key{AltGr} or the equivalent key combination to
-be interpreted as the combination of @key{Ctrl} and @key{META}
+be interpreted as the combination of @key{Ctrl} and @key{Meta}
 modifiers.
 @end ifnottex
 
diff --git a/doc/emacs/text.texi b/doc/emacs/text.texi
index 012c73d8db..6a5fc7c6f6 100644
--- a/doc/emacs/text.texi
+++ b/doc/emacs/text.texi
@@ -117,7 +117,7 @@ cognate to @kbd{C-@@}, which is an alias for @kbd{C-@key{SPC}}.
 @findex backward-word
   The commands @kbd{M-f} (@code{forward-word}) and @kbd{M-b}
 (@code{backward-word}) move forward and backward over words.  These
-@key{META}-based key sequences are analogous to the key sequences
+@key{Meta}-based key sequences are analogous to the key sequences
 @kbd{C-f} and @kbd{C-b}, which move over single characters.  The
 analogy extends to numeric arguments, which serve as repeat counts.
 @kbd{M-f} with a negative argument moves backward, and @kbd{M-b} with
@@ -1331,7 +1331,7 @@ quad click: exit all folds and hide text.
 @c FIXME not marked as a user variable
 @vindex foldout-mouse-modifiers
   You can specify different modifier keys (instead of
-@kbd{@key{Ctrl}-@key{META}-}) by setting @code{foldout-mouse-modifiers}; but if
+@kbd{@key{Ctrl}-@key{Meta}-}) by setting @code{foldout-mouse-modifiers}; but if
 you have already loaded the @file{foldout.el} library, you must reload
 it in order for this to take effect.
 
@@ -2765,8 +2765,7 @@ Invoking @kbd{M-x table-capture} on that text produces this table:
 to plain text, removing its cell borders.
 
   One application of this pair of commands is to edit a text in
-layout.  Look at the following three paragraphs (the latter two are
-indented with header lines):
+layout.  Look at the following three paragraphs:
 
 @example
 table-capture is a powerful command.
-- 
2.21.0


From 4acc17edbce087693d6b1e4261b40a486443a436 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Mon, 12 Mar 2018 18:02:15 +0200
Subject: [PATCH 168/297] Fix last change in Xref documentation

* doc/emacs/maintaining.texi (Looking Up Identifiers): More
accurate wording for the description of xref-etags-mode.
---
 doc/emacs/maintaining.texi | 20 +++++++++++---------
 1 file changed, 11 insertions(+), 9 deletions(-)

diff --git a/doc/emacs/maintaining.texi b/doc/emacs/maintaining.texi
index 806c90b11e..e420ca0c6f 100644
--- a/doc/emacs/maintaining.texi
+++ b/doc/emacs/maintaining.texi
@@ -1875,15 +1875,17 @@ steps to a depth determined by the variable
 
 @findex xref-etags-mode
   Some major modes install @code{xref} support facilities that might
-fail to find certain identifiers.  For example, in Emacs Lisp mode
-(@pxref{Lisp Eval}) @kbd{M-.} will by default find only functions and
-variables from Lisp packages that are loaded into the current Emacs
-session.  To find more identifiers, turn on the Xref Etags minor mode
-with @w{@kbd{M-x xref-etags-mode}}.  This command forces @code{xref}
-to use the @code{etags} backend (@pxref{Xref}).  (For this to work,
-you should first run @command{etags} to create the tags table, see
-@ref{Create Tags Table}.)
-
+sometimes fail to find certain identifiers.  For example, in Emacs
+Lisp mode (@pxref{Lisp Eval}) @kbd{M-.} will by default find only
+functions and variables from Lisp packages which are loaded into the
+current Emacs session or are auto-loaded (@pxref{Autoload,,, elisp,
+The Emacs Lisp Reference Manual}).  If @kbd{M-.} fails to find some
+identifiers, you can try forcing @code{xref} to use the @code{etags}
+backend (@pxref{Xref}).  To this end, turn on the Xref Etags minor
+mode with @w{@kbd{M-x xref-etags-mode}}, then invoke @kbd{M-.} again.
+(For this to work, be sure to run @command{etags} to create the tags
+table in the directory tree of the source files, see @ref{Create Tags
+Table}.)
 
 @node Xref Commands
 @subsubsection Commands Available in the @file{*xref*} Buffer
-- 
2.21.0


From 8ed5769360c631dd4dedb96d20a7ebbb7a1b9fd3 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Mon, 12 Mar 2018 19:25:10 +0200
Subject: [PATCH 169/297] * lisp/minibuffer.el (completion-cycle-threshold):
 Doc fix.

---
 lisp/minibuffer.el | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/lisp/minibuffer.el b/lisp/minibuffer.el
index 9b6f043b57..fc3d1243eb 100644
--- a/lisp/minibuffer.el
+++ b/lisp/minibuffer.el
@@ -987,7 +987,8 @@ Moves point to the end of the new text."
 (defcustom completion-cycle-threshold nil
   "Number of completion candidates below which cycling is used.
 Depending on this setting `completion-in-region' may use cycling,
-like `minibuffer-force-complete'.
+whereby invoking a completion command several times in a row
+completes to each of the candidates in turn, in cyclic manner.
 If nil, cycling is never used.
 If t, cycling is always used.
 If an integer, cycling is used so long as there are not more
-- 
2.21.0


From 531be2e4ea695dd9803cc02c0eff067c0b9e3d21 Mon Sep 17 00:00:00 2001
From: "Charles A. Roelli" <charles@aurox.ch>
Date: Mon, 12 Mar 2018 20:16:53 +0100
Subject: [PATCH 170/297] * lisp/vc/vc-dir.el (vc-dir-unmark): Fix
 documentation.

---
 lisp/vc/vc-dir.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lisp/vc/vc-dir.el b/lisp/vc/vc-dir.el
index db595331bb..18da6e3357 100644
--- a/lisp/vc/vc-dir.el
+++ b/lisp/vc/vc-dir.el
@@ -697,7 +697,7 @@ share the same state."
 (defun vc-dir-unmark ()
   "Unmark the current file or all files in the region.
 If the region is active, unmark all the files in the region.
-Otherwise mark the file on the current line and move to the next
+Otherwise unmark the file on the current line and move to the next
 line."
   (interactive)
   (vc-dir-mark-unmark 'vc-dir-unmark-file))
-- 
2.21.0


From ad05a76d8ac42d0069e173bc98f217f007b34141 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Mon, 12 Mar 2018 22:08:54 +0200
Subject: [PATCH 171/297] ; * lisp/minibuffer.el (completion-cycle-threshold):
 Fix last change.

---
 lisp/minibuffer.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lisp/minibuffer.el b/lisp/minibuffer.el
index fc3d1243eb..3227917494 100644
--- a/lisp/minibuffer.el
+++ b/lisp/minibuffer.el
@@ -988,7 +988,7 @@ Moves point to the end of the new text."
   "Number of completion candidates below which cycling is used.
 Depending on this setting `completion-in-region' may use cycling,
 whereby invoking a completion command several times in a row
-completes to each of the candidates in turn, in cyclic manner.
+completes to each of the candidates in turn, in a cyclic manner.
 If nil, cycling is never used.
 If t, cycling is always used.
 If an integer, cycling is used so long as there are not more
-- 
2.21.0


From af93782d139d162048033cfe0b22f8c124bef3cf Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Mon, 12 Mar 2018 21:09:36 -0400
Subject: [PATCH 172/297] Stop mentioning options.el in doc

* doc/misc/calc.texi (Customizing Embedded Mode):
Remove mentions of the obsolete (since 22.1) options.el.
* lisp/progmodes/meta-mode.el: Comment fix.
---
 doc/misc/calc.texi          | 7 +++----
 lisp/progmodes/meta-mode.el | 4 ++--
 2 files changed, 5 insertions(+), 6 deletions(-)

diff --git a/doc/misc/calc.texi b/doc/misc/calc.texi
index 1fe7948ab8..be78a53ed6 100644
--- a/doc/misc/calc.texi
+++ b/doc/misc/calc.texi
@@ -31292,7 +31292,7 @@ for @code{Save} have no effect.
 You can modify Embedded mode's behavior by setting various Lisp
 variables described here.  These variables are customizable
 (@pxref{Customizing Calc}), or you can use @kbd{M-x set-variable}
-or @kbd{M-x edit-options} to adjust a variable on the fly.
+to adjust a variable on the fly.
 (Another possibility would be to use a file-local variable annotation at
 the end of the file;
 @pxref{File Variables, , Local Variables in Files, emacs, the Emacs manual}.)
@@ -31311,9 +31311,8 @@ regular expression is not completely plain, let's go through it
 in detail.
 
 The surrounding @samp{" "} marks quote the text between them as a
-Lisp string.  If you left them off, @code{set-variable} or
-@code{edit-options} would try to read the regular expression as a
-Lisp program.
+Lisp string.  If you left them off, @code{set-variable} (for example)
+would try to read the regular expression as a Lisp program.
 
 The most obvious property of this regular expression is that it
 contains indecently many backslashes.  There are actually two levels
diff --git a/lisp/progmodes/meta-mode.el b/lisp/progmodes/meta-mode.el
index 7d20e02d80..e207d22ff4 100644
--- a/lisp/progmodes/meta-mode.el
+++ b/lisp/progmodes/meta-mode.el
@@ -47,8 +47,8 @@
 ;; `metafont-mode-hook' and `metapost-mode-hook' which apply to the
 ;; individual modes.  In addition, there are several variables and
 ;; regexps controlling e.g. the behavior of the indentation function,
-;; which may be customized via `edit-options'.  Please refer to the
-;; docstrings in the code below for details.
+;; which may be customized.  Please refer to the docstrings in the code
+;; below for details.
 
 ;; Availability:
 ;;
-- 
2.21.0


From 01704572b8b07f8c1db21b3b82d50305d8e721d9 Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Tue, 13 Mar 2018 18:00:23 +0200
Subject: [PATCH 173/297] Avoid assertion violation under
 visual-order-cursor-movement

* src/xdisp.c (Fmove_point_visually): Don't let point exceed the
BEGV..ZV range.  Signal Beginning of buffer error when there's a
before-string at BEGV.  (Bug#30787)
---
 src/xdisp.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/src/xdisp.c b/src/xdisp.c
index f778ebe53a..dfca2a1e11 100644
--- a/src/xdisp.c
+++ b/src/xdisp.c
@@ -22488,6 +22488,11 @@ Value is the new character position of point.  */)
 		    new_pos += (row->reversed_p ? -dir : dir);
 		  else
 		    new_pos -= (row->reversed_p ? -dir : dir);
+		  new_pos = clip_to_bounds (BEGV, new_pos, ZV);
+		  /* If we didn't move, we've hit BEGV or ZV, so we
+		     need to signal a suitable error.  */
+		  if (new_pos == PT)
+		    break;
 		}
 	      else if (BUFFERP (g->object))
 		new_pos = g->charpos;
-- 
2.21.0


From 5425659ec6d75ce7cfd60b6c76c2275909deff3f Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Tue, 13 Mar 2018 19:40:24 +0200
Subject: [PATCH 174/297] Minor changes in mule.texi

* doc/emacs/mule.texi (International, Coding Systems)
(Bidirectional Editing): Minor wording changes and typo fixes.
Suggested by Michael Albinus <michael.albinus@gmx.de> in
emacs-manual-bugs@gnu.org.
---
 doc/emacs/mule.texi | 25 +++++++++++++------------
 1 file changed, 13 insertions(+), 12 deletions(-)

diff --git a/doc/emacs/mule.texi b/doc/emacs/mule.texi
index 01184e2ae1..d05ec1afee 100644
--- a/doc/emacs/mule.texi
+++ b/doc/emacs/mule.texi
@@ -51,7 +51,7 @@ others.
 @item
 You can insert non-@acronym{ASCII} characters or search for them.  To do that,
 you can specify an input method (@pxref{Select Input Method}) suitable
-for your language, or use the default input method set up when you chose
+for your language, or use the default input method set up when you choose
 your language environment.  If
 your keyboard can produce non-@acronym{ASCII} characters, you can select an
 appropriate keyboard coding system (@pxref{Terminal Coding}), and Emacs
@@ -698,7 +698,7 @@ carriage-return (Mac).
 Describe coding system @var{coding} (@code{describe-coding-system}).
 
 @item C-h C @key{RET}
-Describe the coding systems currently in use.
+Describe the coding systems currently in use (@code{describe-coding-system}).
 
 @item M-x list-coding-systems
 Display a list of all the supported coding systems.
@@ -935,7 +935,7 @@ or a local variables list at the end (@pxref{File Variables}).  You do
 this by defining a value for the ``variable'' named @code{coding}.
 Emacs does not really have a variable @code{coding}; instead of
 setting a variable, this uses the specified coding system for the
-file.  For example, @samp{-*-mode: C; coding: latin-1;-*-} specifies
+file.  For example, @w{@samp{-*-mode: C; coding: latin-1; -*-}} specifies
 use of the Latin-1 coding system, as well as C mode.  When you specify
 the coding explicitly in the file, that overrides
 @code{file-coding-system-alist}.
@@ -1206,13 +1206,13 @@ using the internal Emacs representation.
 @cindex file-name encoding, MS-Windows
 @vindex w32-unicode-filenames
   When Emacs runs on MS-Windows versions that are descendants of the
-NT family (Windows 2000, XP, Vista, Windows 7, and all the later
-versions), the value of @code{file-name-coding-system} is largely
-ignored, as Emacs by default uses APIs that allow passing Unicode file
-names directly.  By contrast, on Windows 9X, file names are encoded
-using @code{file-name-coding-system}, which should be set to the
-codepage (@pxref{Coding Systems, codepage}) pertinent for the current
-system locale.  The value of the variable @code{w32-unicode-filenames}
+NT family (Windows 2000, XP, and all the later versions), the value of
+@code{file-name-coding-system} is largely ignored, as Emacs by default
+uses APIs that allow passing Unicode file names directly.  By
+contrast, on Windows 9X, file names are encoded using
+@code{file-name-coding-system}, which should be set to the codepage
+(@pxref{Coding Systems, codepage}) pertinent for the current system
+locale.  The value of the variable @code{w32-unicode-filenames}
 controls whether Emacs uses the Unicode APIs when it calls OS
 functions that accept file names.  This variable is set by the startup
 code to @code{nil} on Windows 9X, and to @code{t} on newer versions of
@@ -1778,8 +1778,9 @@ of the first character you read precedes that of the next character.
 Reordering of bidirectional text into the @dfn{visual} order happens
 at display time.  As a result, character positions no longer increase
 monotonically with their positions on display.  Emacs implements the
-Unicode Bidirectional Algorithm (UBA) described in the Unicode
-Standard Annex #9, for reordering of bidirectional text for display.
+Unicode Bidirectional Algorithm (UBA) described in the
+@uref{http://unicode.org/reports/tr9/, Unicode Standard Annex #9}, for
+reordering of bidirectional text for display.
 It deviates from the UBA only in how continuation lines are displayed
 when text direction is opposite to the base paragraph direction,
 e.g., when a long line of English text appears in a right-to-left
-- 
2.21.0


From f7f1163bbafb9b89e5a780315ca04beb61a44887 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Tue, 13 Mar 2018 13:49:05 -0400
Subject: [PATCH 175/297] Doc fixes re obsolete items

* doc/emacs/maintaining.texi (VC Undo):
* doc/misc/efaq-w32.texi (Font names): Replace obsolete aliases.
* doc/misc/url.texi (Customization):
Don't mention url-temporary-directory, it essentially does nothing.
* lisp/hilit-chg.el
(highlight-changes-global-changes-existing-buffers): Doc fix.
; * lisp/w32-fns.el: Comment.
; * etc/TODO: Remove obsolete ffap mention.
---
 doc/emacs/maintaining.texi |  2 +-
 doc/misc/efaq-w32.texi     |  4 ++--
 doc/misc/url.texi          | 13 -------------
 etc/TODO                   |  1 -
 lisp/hilit-chg.el          |  4 ++--
 5 files changed, 5 insertions(+), 19 deletions(-)

diff --git a/doc/emacs/maintaining.texi b/doc/emacs/maintaining.texi
index e420ca0c6f..824f1b0f7f 100644
--- a/doc/emacs/maintaining.texi
+++ b/doc/emacs/maintaining.texi
@@ -1078,7 +1078,7 @@ Revert the work file(s) in the current VC fileset to the last revision
 @findex vc-revert
 @vindex vc-revert-show-diff
   If you want to discard all the changes you have made to the current
-VC fileset, type @kbd{C-x v u} (@code{vc-revert-buffer}).  This shows
+VC fileset, type @kbd{C-x v u} (@code{vc-revert}).  This shows
 you a diff between the work file(s) and the revision from which you
 started editing, and asks for confirmation for discarding the changes.
 If you agree, the fileset is reverted.  If you don't want @kbd{C-x v
diff --git a/doc/misc/efaq-w32.texi b/doc/misc/efaq-w32.texi
index 3a4acbc5d9..df75002bf2 100644
--- a/doc/misc/efaq-w32.texi
+++ b/doc/misc/efaq-w32.texi
@@ -899,7 +899,7 @@ The doc string contains a list of the system sounds you can use.
 @cindex font XLFD name format
 @cindex fontconfig font names in Emacs 23
 @cindex font dialog, using to find font names
-@findex w32-select-font
+@findex x-select-font
 @findex x-list-fonts
 
 Fonts in Emacs 22 and earlier are named using the X Logical Font
@@ -930,7 +930,7 @@ Fontconfig: Courier New-13
 To find the XFLD name for a font, you can execute the following in the
 @file{*scratch*} buffer by pressing C-j at the end of the line:
 @example
-(w32-select-font nil t)
+(x-select-font nil t)
 @end example
 
 To see a complete list of fonts, execute the following in the
diff --git a/doc/misc/url.texi b/doc/misc/url.texi
index ed39aab2a3..1acf5f2319 100644
--- a/doc/misc/url.texi
+++ b/doc/misc/url.texi
@@ -1263,19 +1263,6 @@ You can use this function to do completion of URLs from the history.
 @node Customization
 @chapter Customization
 
-@cindex environment variables
-  The following environment variables affect the @code{url} library's
-operation at startup.
-
-@table @code
-@item TMPDIR
-@vindex TMPDIR
-@vindex url-temporary-directory
-If this is defined, @code{url-temporary-directory} is initialized from
-it.  This variable was obsoleted in 23.1, please use
-@code{temporary-file-directory} instead.
-@end table
-
   The following user options affect the general operation of
 @code{url} library.
 
diff --git a/etc/TODO b/etc/TODO
index a6ab8787f7..de579746ac 100644
--- a/etc/TODO
+++ b/etc/TODO
@@ -216,7 +216,6 @@ Change them to use report-emacs-bug.
 **** lm-report-bug
 **** tramp-bug
 **** c-submit-bug-report
-**** ffap-bug and ffap-submit-bug (obsoleted)
 [Do all of them need changing?]
 
 ** Allow fringe indicators to display a tooltip (provide a help-echo property?)
diff --git a/lisp/hilit-chg.el b/lisp/hilit-chg.el
index 7c5294fa17..9d4d2d8b38 100644
--- a/lisp/hilit-chg.el
+++ b/lisp/hilit-chg.el
@@ -297,9 +297,9 @@ modes only."
 
 (defcustom highlight-changes-global-changes-existing-buffers nil
   "If non-nil, toggling global Highlight Changes mode affects existing buffers.
-Normally, `global-highlight-changes' affects only new buffers (to be
+Normally, `global-highlight-changes-mode' affects only new buffers (to be
 created).  However, if `highlight-changes-global-changes-existing-buffers'
-is non-nil, then turning on `global-highlight-changes' will turn on
+is non-nil, then turning on `global-highlight-changes-mode' will turn on
 Highlight Changes mode in suitable buffers, and turning the mode off will
 remove it from existing buffers."
   :type 'boolean
-- 
2.21.0


From d5d02ea69be21737fe42652c3354d132bec4c1e0 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Tue, 13 Mar 2018 13:49:53 -0400
Subject: [PATCH 176/297] Replace an obsolete alias in tpu-mapper

* lisp/obsolete/tpu-mapper.el (tpu-map-key, tpu-mapper):
Replace obsolete alias.
---
 lisp/obsolete/tpu-mapper.el | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/lisp/obsolete/tpu-mapper.el b/lisp/obsolete/tpu-mapper.el
index 6a5a83c888..4cc2404e4e 100644
--- a/lisp/obsolete/tpu-mapper.el
+++ b/lisp/obsolete/tpu-mapper.el
@@ -56,7 +56,7 @@
           (set-buffer "Keys")
           (insert (format"(global-set-key %s %s)\n" tpu-key func))
           (set-buffer "Gold-Keys")
-          (insert (format "(define-key GOLD-map %s %s)\n" tpu-key gold-func))))
+          (insert (format "(define-key tpu-gold-map %s %s)\n" tpu-key gold-func))))
     (message "Press %s%s: " ident descrip)
     (setq tpu-key-seq (read-event)
           tpu-key (format "[%s]" tpu-key-seq))
@@ -203,7 +203,7 @@ your local X guru can try to figure out why the key is being ignored."
 ")
   (set-buffer "Directions")
 
-  (tpu-map-key "PF1"  " - The GOLD key"               "GOLD-map"                 "'keyboard-quit")
+  (tpu-map-key "PF1"  " - The GOLD key"               "tpu-gold-map"              "'keyboard-quit")
   (tpu-map-key "PF2"  " - The Keypad Help key"        "'tpu-help"                 "'help-for-help")
   (tpu-map-key "PF3"  " - The Find/Find-Next key"     "'tpu-search-again"         "'tpu-search")
   (tpu-map-key "PF4"  " - The Del/Undelete Line key"  "'tpu-delete-current-line"  "'tpu-undelete-lines")
-- 
2.21.0


From 41dc236070c1b751beabb2130d753baab47fb873 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Tue, 13 Mar 2018 14:47:41 -0400
Subject: [PATCH 177/297] Doc fixes re obsolete items

* doc/emacs/mini.texi (Completion Commands): Small update re mouse.
* doc/misc/htmlfontify.texi (Customization): Replace obsolete alias.
---
 doc/emacs/mini.texi       | 8 ++------
 doc/misc/htmlfontify.texi | 6 +++---
 2 files changed, 5 insertions(+), 9 deletions(-)

diff --git a/doc/emacs/mini.texi b/doc/emacs/mini.texi
index 5d67535b6f..0dd7cde6cf 100644
--- a/doc/emacs/mini.texi
+++ b/doc/emacs/mini.texi
@@ -337,12 +337,6 @@ window.  You can display the same list with @kbd{?}
 used with the completion list:
 
 @table @kbd
-@findex mouse-choose-completion
-@item mouse-1
-@itemx mouse-2
-Clicking mouse button 1 or 2 on a completion alternative chooses it
-(@code{mouse-choose-completion}).
-
 @findex switch-to-completions
 @item M-v
 @itemx @key{PageUp}
@@ -355,6 +349,8 @@ the same.  You can also select the window in other ways
 
 @findex choose-completion
 @item @key{RET}
+@itemx mouse-1
+@itemx mouse-2
 While in the completion list buffer, this chooses the completion at
 point (@code{choose-completion}).
 
diff --git a/doc/misc/htmlfontify.texi b/doc/misc/htmlfontify.texi
index 6bc57daf62..c4cf7dac0a 100644
--- a/doc/misc/htmlfontify.texi
+++ b/doc/misc/htmlfontify.texi
@@ -1379,9 +1379,9 @@ For example, I customize this to:
 ((t :background "black" :foreground "white" :family "misc-fixed"))
 @end lisp
 
-@item hfy-init-kludge-hooks
-@vindex hfy-init-kludge-hooks
-@anchor{hfy-init-kludge-hooks}
+@item hfy-init-kludge-hook
+@vindex hfy-init-kludge-hook
+@anchor{hfy-init-kludge-hook}
 
 List of functions to call when starting htmlfontify-buffer to do any
 kludging necessary to get highlighting modes to behave as you want, even
-- 
2.21.0


From 590ab1560fcab0631134fa236be61e2abf9925ff Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Tue, 13 Mar 2018 14:48:02 -0400
Subject: [PATCH 178/297] * lisp/progmodes/ada-mode.el
 (ada-clean-buffer-before-saving): Doc fix.

---
 lisp/progmodes/ada-mode.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lisp/progmodes/ada-mode.el b/lisp/progmodes/ada-mode.el
index 2d3f6e22a6..76c9be93d0 100644
--- a/lisp/progmodes/ada-mode.el
+++ b/lisp/progmodes/ada-mode.el
@@ -231,7 +231,7 @@ It may be `downcase-word', `upcase-word', `ada-loose-case-word' or
   "Non-nil means remove trailing spaces and untabify the buffer before saving."
   :type 'boolean :group 'ada)
 (make-obsolete-variable 'ada-clean-buffer-before-saving
-			"use the `write-file-functions' hook."
+			"it has no effect - use `write-file-functions' hook."
 			"23.2")
 
 
-- 
2.21.0


From 362f2a86d450dff78a5e7fc2e75424dde5ad9b91 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Tue, 13 Mar 2018 14:48:37 -0400
Subject: [PATCH 179/297] Fix some allout.el aliases

* lisp/allout.el (allout-passphrase-verifier-string)
(allout-passphrase-hint-string): Fix alias.
---
 lisp/allout.el | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/lisp/allout.el b/lisp/allout.el
index a0456d5bd2..af71ea75ce 100644
--- a/lisp/allout.el
+++ b/lisp/allout.el
@@ -1522,7 +1522,7 @@ the Emacs buffer state, if file variable adjustments are enabled.  See
 `allout-enable-file-variable-adjustment' for details about that.")
 (make-variable-buffer-local 'allout-passphrase-verifier-string)
 (make-obsolete-variable 'allout-passphrase-verifier-string
-			'allout-passphrase-verifier-string "23.3")
+			"it is no longer used." "23.3")
 ;;;###autoload
 (put 'allout-passphrase-verifier-string 'safe-local-variable 'stringp)
 ;;;_   = allout-passphrase-hint-string
@@ -1538,7 +1538,7 @@ state, if file variable adjustments are enabled.  See
 (make-variable-buffer-local 'allout-passphrase-hint-string)
 (setq-default allout-passphrase-hint-string "")
 (make-obsolete-variable 'allout-passphrase-hint-string
-			'allout-passphrase-hint-string "23.3")
+			"it is no longer used." "23.3")
 ;;;###autoload
 (put 'allout-passphrase-hint-string 'safe-local-variable 'stringp)
 ;;;_   = allout-after-save-decrypt
-- 
2.21.0


From b95db482a7e1e35c631b6e364292468bb8257d0b Mon Sep 17 00:00:00 2001
From: Noam Postavsky <npostavs@gmail.com>
Date: Sun, 11 Mar 2018 20:47:12 -0400
Subject: [PATCH 180/297] Fix line-wrapping for term.el (Bug#30775)

* lisp/term.el (term-emulate-terminal): Leave line-wrapping state if
point was moved after we entered it.
* test/lisp/term-tests.el (term-line-wrapping-then-motion): New test.
---
 lisp/term.el            | 11 ++++++++---
 test/lisp/term-tests.el | 12 ++++++++++++
 2 files changed, 20 insertions(+), 3 deletions(-)

diff --git a/lisp/term.el b/lisp/term.el
index 93da33ea5b..91eab771cf 100644
--- a/lisp/term.el
+++ b/lisp/term.el
@@ -2891,9 +2891,11 @@ See `term-prompt-regexp'."
                 ;; If the last char was written in last column,
                 ;; back up one column, but remember we did so.
                 ;; Thus we emulate xterm/vt100-style line-wrapping.
-                (cond ((eq (term-current-column) term-width)
-                       (term-move-columns -1)
-                       (setq term-do-line-wrapping t)))
+                (when (eq (term-current-column) term-width)
+                  (term-move-columns -1)
+                  ;; We check after ctrl sequence handling if point
+                  ;; was moved (and leave line-wrapping state if so).
+                  (setq term-do-line-wrapping (point)))
                 (setq term-current-column nil)
                 (setq i funny))
               (pcase-exhaustive (and (<= ctl-end str-length) (aref str i))
@@ -2993,6 +2995,9 @@ See `term-prompt-regexp'."
                      (substring str i ctl-end)))))
                 ;; Ignore NUL, Shift Out, Shift In.
                 ((or ?\0 #xE #xF 'nil) nil))
+              ;; Leave line-wrapping state if point was moved.
+              (unless (eq term-do-line-wrapping (point))
+                (setq term-do-line-wrapping nil))
               (if (term-handling-pager)
                   (progn
                     ;; Finish stuff to get ready to handle PAGER.
diff --git a/test/lisp/term-tests.el b/test/lisp/term-tests.el
index 234dfa1f0d..8aaa61a210 100644
--- a/test/lisp/term-tests.el
+++ b/test/lisp/term-tests.el
@@ -124,6 +124,18 @@ line6\r
                     40 12 (list "\eAnSiTc /f" "oo/\n") 'default-directory)
                    "/foo/"))))
 
+(ert-deftest term-line-wrapping-then-motion ()
+  "Make sure we reset the line-wrapping state after moving cursor.
+A real-life example is the default zsh prompt which writes spaces
+to the end of line (triggering line-wrapping state), and then
+sends a carriage return followed by another space to overwrite
+the first character of the line."
+  (let* ((width 10)
+         (strs (list "x" (make-string (1- width) ?_)
+                     "\r_")))
+    (should (equal (term-test-screen-from-input width 12 strs)
+                   (make-string width ?_)))))
+
 (provide 'term-tests)
 
 ;;; term-tests.el ends here
-- 
2.21.0


From b6bda1953f205cb91c2c5fb0cb0c6b3acaa9c5e1 Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Wed, 14 Mar 2018 16:21:06 +0100
Subject: [PATCH 181/297] Extend ert to print duration of single tests
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

* lisp/emacs-lisp/ert.el (ert-test-result): New slot ´duration'.
(ert-run-or-rerun-test): Set it.
(ert-batch-print-duration): New defvar.
(ert-run-tests-batch): Print duration if needed.

* test/Makefile.in (TEST_PRINT_TEST_DURATION): New variable.

* test/README: Explain TEST_PRINT_TEST_DURATION.
---
 lisp/emacs-lisp/ert.el | 17 +++++++++++++++--
 test/Makefile.in       | 14 ++++++++++----
 test/README            |  5 +++++
 3 files changed, 30 insertions(+), 6 deletions(-)

diff --git a/lisp/emacs-lisp/ert.el b/lisp/emacs-lisp/ert.el
index a47108545d..7d8d0a50e4 100644
--- a/lisp/emacs-lisp/ert.el
+++ b/lisp/emacs-lisp/ert.el
@@ -676,6 +676,7 @@ and is displayed in front of the value of MESSAGE-FORM."
 (cl-defstruct ert-test-result
   (messages nil)
   (should-forms nil)
+  (duration 0)
   )
 (cl-defstruct (ert-test-passed (:include ert-test-result)))
 (cl-defstruct (ert-test-result-with-condition (:include ert-test-result))
@@ -1230,6 +1231,11 @@ SELECTOR is the selector that was used to select TESTS."
         (ert-run-test test)
       (setf (aref (ert--stats-test-end-times stats) pos) (current-time))
       (let ((result (ert-test-most-recent-result test)))
+        (setf (ert-test-result-duration result)
+              (float-time
+               (time-subtract
+                (aref (ert--stats-test-end-times stats) pos)
+                (aref (ert--stats-test-start-times stats) pos))))
         (ert--stats-set-test-and-result stats pos test result)
         (funcall listener 'test-ended stats test result))
       (setf (ert--stats-current-test stats) nil))))
@@ -1336,6 +1342,9 @@ RESULT must be an `ert-test-result-with-condition'."
 (defvar ert-quiet nil
   "Non-nil makes ERT only print important information in batch mode.")
 
+(defvar ert-batch-print-duration nil
+  "Non-nil makes ERT print duration time of single tests in batch mode.")
+
 ;;;###autoload
 (defun ert-run-tests-batch (&optional selector)
   "Run the tests specified by SELECTOR, printing results to the terminal.
@@ -1446,13 +1455,17 @@ Returns the stats object."
             (let* ((max (prin1-to-string (length (ert--stats-tests stats))))
                    (format-string (concat "%9s  %"
                                           (prin1-to-string (length max))
-                                          "s/" max "  %S")))
+                                          "s/" max "  %S"
+                                          (if ert-batch-print-duration
+                                              " (%f sec)"))))
               (message format-string
                        (ert-string-for-test-result result
                                                    (ert-test-result-expected-p
                                                     test result))
                        (1+ (ert--stats-test-pos stats test))
-                       (ert-test-name test))))))))
+                       (ert-test-name test)
+                       (if ert-batch-print-duration
+                           (ert-test-result-duration result)))))))))
    nil))
 
 ;;;###autoload
diff --git a/test/Makefile.in b/test/Makefile.in
index a6f6d0a3fe..dd9e519c42 100644
--- a/test/Makefile.in
+++ b/test/Makefile.in
@@ -99,14 +99,20 @@ TEST_LOCALE = C
 # If you just want a pass/fail, setting this to no is much faster.
 TEST_LOAD_EL ?= yes
 
+# Additional settings for ert.
+ert_opts =
+
 # Maximum length of lines in ert backtraces; nil for no limit.
 # (if empty, use the default ert-batch-backtrace-right-margin).
 TEST_BACKTRACE_LINE_LENGTH =
 
-ifeq (${TEST_BACKTRACE_LINE_LENGTH},)
-ert_opts =
-else
-ert_opts = --eval '(setq ert-batch-backtrace-right-margin ${TEST_BACKTRACE_LINE_LENGTH})'
+ifneq (${TEST_BACKTRACE_LINE_LENGTH},)
+ert_opts += --eval '(setq ert-batch-backtrace-right-margin ${TEST_BACKTRACE_LINE_LENGTH})'
+endif
+
+# Whether the tests shall also report their duration.
+ifdef TEST_PRINT_TEST_DURATION
+ert_opts += --eval '(setq ert-batch-print-duration t)'
 endif
 
 ifeq (@HAVE_MODULES@, yes)
diff --git a/test/README b/test/README
index 1cd9db3bb8..11a25fb524 100644
--- a/test/README
+++ b/test/README
@@ -50,6 +50,11 @@ nicer backtraces.  To run the compiled version of a test use
 
     make TEST_LOAD_EL=no ...
 
+Sometimes, it is ncessary to trace the duration time for single tests.
+This is controlled by the environment variable TEST_PRINT_TEST_DURATION
+
+    make TEST_PRINT_TEST_DURATION=1 ...
+
 
 (Also, see etc/compilation.txt for compilation mode font lock tests.)
 
-- 
2.21.0


From 51f6474da3fc5ac402856c7e1f6f950dd993ecf2 Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Wed, 14 Mar 2018 16:45:45 +0100
Subject: [PATCH 182/297] ; * test/README: Fix typo

---
 test/README | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/test/README b/test/README
index 11a25fb524..17135a0274 100644
--- a/test/README
+++ b/test/README
@@ -50,7 +50,7 @@ nicer backtraces.  To run the compiled version of a test use
 
     make TEST_LOAD_EL=no ...
 
-Sometimes, it is ncessary to trace the duration time for single tests.
+Sometimes, it is necessary to trace the duration time for single tests.
 This is controlled by the environment variable TEST_PRINT_TEST_DURATION
 
     make TEST_PRINT_TEST_DURATION=1 ...
-- 
2.21.0


From d546716e1c0f6ec31f8e17171f958d714ecc8c7b Mon Sep 17 00:00:00 2001
From: Stefan Monnier <monnier@iro.umontreal.ca>
Date: Wed, 14 Mar 2018 12:14:01 -0400
Subject: [PATCH 183/297] * lisp/desktop.el: Make use some "new" functionality

(desktop-files-not-to-save, desktop-clear):
Use \` and \' when we don't intend to match newlines.
(desktop-minor-mode-table): Remove auto-fill-function entry.
(desktop-buffer-info): Use :minor-mode-function instead.
(desktop--v2s): Use a closure rather than a backquoted lambda.
(desktop-save): Set 'lexical-binding' in the saved file.
Use 'utf-8-emacs' encoding rather than the old 'emacs-mule'.
(desktop-read): Use 'default-value' to get the global part of a hook.
---
 lisp/desktop.el | 42 +++++++++++++++++++++---------------------
 1 file changed, 21 insertions(+), 21 deletions(-)

diff --git a/lisp/desktop.el b/lisp/desktop.el
index 0a1a4d5f23..55ec71c1b9 100644
--- a/lisp/desktop.el
+++ b/lisp/desktop.el
@@ -387,7 +387,7 @@ or `desktop-modes-not-to-save'."
 
 ;; Skip tramp and ange-ftp files
 (defcustom desktop-files-not-to-save
-  "\\(^/[^/:]*:\\|(ftp)$\\)"
+  "\\(\\`/[^/:]*:\\|(ftp)\\'\\)"
   "Regexp identifying files whose buffers are to be excluded from saving.
 The default value excludes buffers visiting remote files."
   :type '(choice (const :tag "None" nil)
@@ -534,8 +534,7 @@ can guess how to load the mode's definition.")
 (put 'desktop-buffer-mode-handlers 'risky-local-variable t)
 
 (defcustom desktop-minor-mode-table
-  '((auto-fill-function auto-fill-mode)
-    (defining-kbd-macro nil)
+  '((defining-kbd-macro nil)
     (isearch-mode nil)
     (vc-mode nil)
     (vc-dired-mode nil)
@@ -702,12 +701,12 @@ if different)."
     (if (symbolp var)
 	(set-default var nil)
       (set-default var (eval (cdr var)))))
-  (let ((preserve-regexp (concat "^\\("
+  (let ((preserve-regexp (concat "\\`\\("
                                  (mapconcat (lambda (regexp)
                                               (concat "\\(" regexp "\\)"))
                                             desktop-clear-preserve-buffers
                                             "\\|")
-                                 "\\)$")))
+                                 "\\)\\'")))
     (dolist (buffer (buffer-list))
       (let ((bufname (buffer-name buffer)))
 	(unless (or (eq (aref bufname 0) ?\s) ;; Don't kill internal buffers
@@ -735,7 +734,7 @@ if different)."
 
 ;; ----------------------------------------------------------------------------
 (unless noninteractive
-  (add-hook 'kill-emacs-hook 'desktop-kill))
+  (add-hook 'kill-emacs-hook #'desktop-kill))
 
 (defun desktop-kill ()
   "If `desktop-save-mode' is non-nil, do what `desktop-save' says to do.
@@ -804,6 +803,7 @@ buffer, which is (in order):
               (symbol-value minor-mode)
               (let* ((special (assq minor-mode desktop-minor-mode-table))
                      (value (cond (special (cadr special))
+                                  ((get minor-mode :minor-mode-function))
                                   ((functionp minor-mode) minor-mode))))
                 (when value (cl-pushnew value ret))))))
     ;; point and mark, and read-only status
@@ -889,8 +889,8 @@ QUOTE may be `may' (value may be quoted),
        (cons nil
              `(let ((mk (make-marker)))
                 (add-hook 'desktop-delay-hook
-                          `(lambda ()
-                             (set-marker ,mk ,,pos (get-buffer ,,buf))))
+                          (lambda ()
+                            (set-marker mk ,pos (get-buffer ,buf))))
                 mk))))
     (t                                  ; Save as text.
      (cons 'may "Unprintable entity"))))
@@ -1074,7 +1074,7 @@ without further confirmation."
 
 	(with-temp-buffer
 	  (insert
-	   ";; -*- mode: emacs-lisp; coding: emacs-mule; -*-\n"
+	   ";; -*- mode: emacs-lisp; lexical-binding:t; coding: utf-8-emacs; -*-\n"
 	   desktop-header
 	   ";; Created " (current-time-string) "\n"
 	   ";; Desktop file format version " (format "%d" desktop-io-file-version) "\n"
@@ -1087,7 +1087,7 @@ without further confirmation."
 	  (desktop-save-frameset)
 	  (unless (memq 'desktop-saved-frameset desktop-globals-to-save)
 	    (desktop-outvar 'desktop-saved-frameset))
-	  (mapc (function desktop-outvar) desktop-globals-to-save)
+	  (mapc #'desktop-outvar desktop-globals-to-save)
 	  (setq desktop-saved-frameset nil) ; after saving desktop-globals-to-save
 	  (when (memq 'kill-ring desktop-globals-to-save)
 	    (insert
@@ -1096,9 +1096,9 @@ without further confirmation."
 	     " kill-ring))\n"))
 
 	  (insert "\n;; Buffer section -- buffers listed in same order as in buffer list:\n")
-	  (dolist (l (mapcar 'desktop-buffer-info (buffer-list)))
+	  (dolist (l (mapcar #'desktop-buffer-info (buffer-list)))
 	    (let ((base (pop l)))
-	      (when (apply 'desktop-save-buffer-p l)
+	      (when (apply #'desktop-save-buffer-p l)
 		(insert "("
 			(if (or (not (integerp eager))
 				(if (zerop eager)
@@ -1129,9 +1129,9 @@ without further confirmation."
 				  ;; This is saved after the timestamp
 				  (search-forward (format "%S" desktop--app-id) nil t))
 			     (point))))
-		 (checksum (and beg (md5 (current-buffer) beg (point-max) 'emacs-mule))))
+		 (checksum (and beg (md5 (current-buffer) beg (point-max) 'utf-8-emacs))))
 	    (unless (and checksum (equal checksum desktop-file-checksum))
-	      (let ((coding-system-for-write 'emacs-mule))
+	      (let ((coding-system-for-write 'utf-8-emacs))
 		(write-region (point-min) (point-max) (desktop-full-file-name) nil 'nomessage))
 	      (setq desktop-file-checksum checksum)
 	      ;; We remember when it was modified (which is presumably just now).
@@ -1230,12 +1230,12 @@ Using it may cause conflicts.  Use it anyway? " owner)))))
 	    ;; disabled when loading the desktop fails with errors,
 	    ;; thus not overwriting the desktop with broken contents.
 	    (setq desktop-autosave-was-enabled
-		  (memq 'desktop-auto-save-set-timer
-                        ;; Use the toplevel value of the hook, in case some
+		  (memq #'desktop-auto-save-set-timer
+                        ;; Use the global value of the hook, in case some
                         ;; feature makes window-configuration-change-hook
                         ;; buffer-local, and puts there stuff which
                         ;; doesn't include our timer.
-                        (default-toplevel-value
+                        (default-value
                           'window-configuration-change-hook)))
 	    (desktop-auto-save-disable)
 	    ;; Evaluate desktop buffer and remember when it was modified.
@@ -1254,7 +1254,7 @@ Using it may cause conflicts.  Use it anyway? " owner)))))
 	      ;; We want buffers existing prior to evaluating the desktop (and
 	      ;; not reused) to be placed at the end of the buffer list, so we
 	      ;; move them here.
-	      (mapc 'bury-buffer
+	      (mapc #'bury-buffer
 		    (nreverse (cdr (memq desktop-first-buffer (nreverse (buffer-list))))))
 	      (switch-to-buffer (car (buffer-list))))
 	    (run-hooks 'desktop-delay-hook)
@@ -1328,10 +1328,10 @@ directory DIRNAME."
 (defun desktop-auto-save-enable (&optional timeout)
   (when (and (integerp (or timeout desktop-auto-save-timeout))
 	     (> (or timeout desktop-auto-save-timeout) 0))
-    (add-hook 'window-configuration-change-hook 'desktop-auto-save-set-timer)))
+    (add-hook 'window-configuration-change-hook #'desktop-auto-save-set-timer)))
 
 (defun desktop-auto-save-disable ()
-  (remove-hook 'window-configuration-change-hook 'desktop-auto-save-set-timer)
+  (remove-hook 'window-configuration-change-hook #'desktop-auto-save-set-timer)
   (desktop-auto-save-cancel-timer))
 
 (defun desktop-auto-save ()
@@ -1586,7 +1586,7 @@ ARGS must be an argument list for `desktop-create-buffer'."
       (let ((desktop-first-buffer nil)
             (desktop-buffer-ok-count 0)
             (desktop-buffer-fail-count 0))
-        (apply 'desktop-create-buffer args)
+        (apply #'desktop-create-buffer args)
         (run-hooks 'desktop-delay-hook)
         (setq desktop-delay-hook nil)
         (bury-buffer (get-buffer buffer-name))
-- 
2.21.0


From 8b5c5070dabbf35801e511e3c175c20c7620c043 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Wed, 14 Mar 2018 14:30:39 -0400
Subject: [PATCH 184/297] More hydra.nixos.org logging for unfinished tests

* lisp/emacs-lisp/ert.el (ert-summarize-tests-batch-and-exit):
Dump contents of any unfinished log files on hydra.nixos.org.
---
 lisp/emacs-lisp/ert.el | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/lisp/emacs-lisp/ert.el b/lisp/emacs-lisp/ert.el
index 7d8d0a50e4..3beb8a070f 100644
--- a/lisp/emacs-lisp/ert.el
+++ b/lisp/emacs-lisp/ert.el
@@ -1548,7 +1548,14 @@ Ran \\([0-9]+\\) tests, \\([0-9]+\\) results as expected\
       (mapc (lambda (l) (message "  %s" l)) notests))
     (when badtests
       (message "%d files did not finish:" (length badtests))
-      (mapc (lambda (l) (message "  %s" l)) badtests))
+      (mapc (lambda (l) (message "  %s" l)) badtests)
+      (if (getenv "EMACS_HYDRA_CI")
+          (with-temp-buffer
+            (dolist (f badtests)
+              (erase-buffer)
+              (insert-file-contents f)
+              (message "Contents of unfinished file %s:" f)
+              (message "-----\n%s\n-----" (buffer-string))))))
     (when unexpected
       (message "%d files contained unexpected results:" (length unexpected))
       (mapc (lambda (l) (message "  %s" l)) unexpected))
-- 
2.21.0


From d6aca30bf323045236325ab223a60f24457fc71d Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Thu, 15 Mar 2018 11:32:50 +0100
Subject: [PATCH 185/297] Fix an error in tramp-archive-test42-auto-load

* test/lisp/net/tramp-archive-tests.el (tramp-archive-test42-auto-load):
Do not use "/ssh::" as test directory, it could harm.  (Bug#30807)
---
 test/lisp/net/tramp-archive-tests.el | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/test/lisp/net/tramp-archive-tests.el b/test/lisp/net/tramp-archive-tests.el
index 33916f82da..a3201bdba4 100644
--- a/test/lisp/net/tramp-archive-tests.el
+++ b/test/lisp/net/tramp-archive-tests.el
@@ -809,7 +809,7 @@ This tests also `file-executable-p', `file-writable-p' and `set-file-modes'."
   (skip-unless (tramp-archive--test-emacs27-p))
 
   ;; tramp-archive is neither loaded at Emacs startup, nor when
-  ;; loading a file like "/ssh::" (which loads Tramp).
+  ;; loading a file like "/mock::foo" (which loads Tramp).
   (let ((default-directory (expand-file-name temporary-file-directory))
 	(code
 	 "(progn \
@@ -818,7 +818,7 @@ This tests also `file-executable-p', `file-writable-p' and `set-file-modes'."
 	    (file-attributes %S \"/\") \
 	    (message \"tramp-archive loaded: %%s %%s\" \
               (featurep 'tramp) (featurep 'tramp-archive)))"))
-    (dolist (file `("/ssh::foo" ,(concat tramp-archive-test-archive "foo")))
+    (dolist (file `("/mock::foo" ,(concat tramp-archive-test-archive "foo")))
       (should
        (string-match
 	(format
-- 
2.21.0


From fb1a9855d8d0578482890e7a1fdaeff013a93caf Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Thu, 15 Mar 2018 15:13:50 +0200
Subject: [PATCH 186/297] Fix mouse-set-point when line numbers are displayed

* src/xdisp.c (move_it_to): Initialize the line_number_produced_p
flag before iterating on a new line.  (Bug#30818)
---
 src/xdisp.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/src/xdisp.c b/src/xdisp.c
index dfca2a1e11..4e7ee0b8fb 100644
--- a/src/xdisp.c
+++ b/src/xdisp.c
@@ -9598,6 +9598,7 @@ move_it_to (struct it *it, ptrdiff_t to_charpos, int to_x, int to_y, int to_vpos
       it->current_x = line_start_x;
       line_start_x = 0;
       it->hpos = 0;
+      it->line_number_produced_p = false;
       it->current_y += it->max_ascent + it->max_descent;
       ++it->vpos;
       last_height = it->max_ascent + it->max_descent;
-- 
2.21.0


From bc7cde0c658e5a99f8fd96baa9adbcc80a16938d Mon Sep 17 00:00:00 2001
From: Eli Zaretskii <eliz@gnu.org>
Date: Thu, 15 Mar 2018 15:23:01 +0200
Subject: [PATCH 187/297] Support variable-unquoting syntax in bat-mode
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

* lisp/progmodes/bat-mode.el (bat-font-lock-keywords): Fontify
argument numbers in %~n.  Suggested by Jostein Kjønigsen
<jostein@secure.kjonigsen.net> in emacs-devel.

* test/lisp/progmodes/bat-mode-tests.el
(bat-test-fontification-iter-var-1): Update the test to check also
the %~n construct.
---
 lisp/progmodes/bat-mode.el            | 2 ++
 test/lisp/progmodes/bat-mode-tests.el | 5 +++--
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/lisp/progmodes/bat-mode.el b/lisp/progmodes/bat-mode.el
index 2910a7a104..51acc6a949 100644
--- a/lisp/progmodes/bat-mode.el
+++ b/lisp/progmodes/bat-mode.el
@@ -84,6 +84,8 @@
          . 'bat-label-face)
         ("\\_<\\(defined\\|set\\)\\_>[ \t]*\\(\\(\\sw\\|\\s_\\)+\\)"
          (2 font-lock-variable-name-face))
+        ("%~\\([0-9]\\)"
+         (1 font-lock-variable-name-face))
         ("%\\([^%~ \n]+\\)%?"
          (1 font-lock-variable-name-face))
         ("!\\([^!%~ \n]+\\)!?"  ; delayed-expansion !variable!
diff --git a/test/lisp/progmodes/bat-mode-tests.el b/test/lisp/progmodes/bat-mode-tests.el
index 4fa8de10c6..5b824841d4 100644
--- a/test/lisp/progmodes/bat-mode-tests.el
+++ b/test/lisp/progmodes/bat-mode-tests.el
@@ -63,10 +63,11 @@
   "Test fontification of iteration variables."
   (should
    (equal
-    (bat-test-fontify "echo %%a\necho %%~dp1\necho %%~$PATH:I")
+    (bat-test-fontify "echo %%a\necho %%~dp1\necho %%~$PATH:I\necho %%~1")
     "<span class=\"builtin\">echo</span> %%<span class=\"variable-name\">a</span>
 <span class=\"builtin\">echo</span> %%~dp<span class=\"variable-name\">1</span>
-<span class=\"builtin\">echo</span> %%~$<span class=\"variable-name\">PATH</span>:<span class=\"variable-name\">I</span>")))
+<span class=\"builtin\">echo</span> %%~$<span class=\"variable-name\">PATH</span>:<span class=\"variable-name\">I</span>
+<span class=\"builtin\">echo</span> %%~<span class=\"variable-name\">1</span>")))
 
 (defun bat-test-fill-paragraph (str)
   "Return the result of invoking `fill-paragraph' on STR in a `bat-mode' buffer."
-- 
2.21.0


From bf1c6493a4b1d891d8d25999cba9c0857c7342c9 Mon Sep 17 00:00:00 2001
From: Michael Albinus <michael.albinus@gmx.de>
Date: Thu, 15 Mar 2018 16:11:14 +0100
Subject: [PATCH 188/297] Improve robustness in tramp-sh.el

* lisp/net/tramp-sh.el (tramp-open-connection-setup-interactive-shell):
Wrap both echo calls in parentheses, in order to avoid double prompt.
---
 lisp/net/tramp-sh.el | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lisp/net/tramp-sh.el b/lisp/net/tramp-sh.el
index f619ac3063..0cdf42de68 100644
--- a/lisp/net/tramp-sh.el
+++ b/lisp/net/tramp-sh.el
@@ -4175,7 +4175,7 @@ process to set up.  VEC specifies the connection."
 	      cs-encode
 	      (coding-system-change-eol-conversion
 	       cs-encode (if (string-match "^Darwin" uname) 'mac 'unix)))
-	(tramp-send-command vec "echo foo ; echo bar" t)
+	(tramp-send-command vec "(echo foo ; echo bar)" t)
 	(goto-char (point-min))
 	(when (search-forward "\r" nil t)
 	  (setq cs-decode (coding-system-change-eol-conversion cs-decode 'dos)))
-- 
2.21.0


From 9b7256626eb9cd2170781475c407f6a56821d915 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 15 Mar 2018 12:32:22 -0400
Subject: [PATCH 189/297] * lisp/pcomplete.el (pcomplete-here): Move before
 first reference.

---
 lisp/pcomplete.el | 66 +++++++++++++++++++++++------------------------
 1 file changed, 33 insertions(+), 33 deletions(-)

diff --git a/lisp/pcomplete.el b/lisp/pcomplete.el
index e7d12c6341..6bdea68c0b 100644
--- a/lisp/pcomplete.el
+++ b/lisp/pcomplete.el
@@ -272,6 +272,39 @@ to all arguments, such as variable names after a $."
   "Complete amongst a list of directories and executables."
   (pcomplete-entries regexp 'file-executable-p))
 
+(defmacro pcomplete-here (&optional form stub paring form-only)
+  "Complete against the current argument, if at the end.
+If completion is to be done here, evaluate FORM to generate the completion
+table which will be used for completion purposes.  If STUB is a
+string, use it as the completion stub instead of the default (which is
+the entire text of the current argument).
+
+For an example of when you might want to use STUB: if the current
+argument text is `long-path-name/', you don't want the completions
+list display to be cluttered by `long-path-name/' appearing at the
+beginning of every alternative.  Not only does this make things less
+intelligible, but it is also inefficient.  Yet, if the completion list
+does not begin with this string for every entry, the current argument
+won't complete correctly.
+
+The solution is to specify a relative stub.  It allows you to
+substitute a different argument from the current argument, almost
+always for the sake of efficiency.
+
+If PARING is nil, this argument will be pared against previous
+arguments using the function `file-truename' to normalize them.
+PARING may be a function, in which case that function is used for
+normalization.  If PARING is t, the argument dealt with by this
+call will not participate in argument paring.  If it is the
+integer 0, all previous arguments that have been seen will be
+cleared.
+
+If FORM-ONLY is non-nil, only the result of FORM will be used to
+generate the completions list.  This means that the hook
+`pcomplete-try-first-hook' will not be run."
+  (declare (debug t))
+  `(pcomplete--here (lambda () ,form) ,stub ,paring ,form-only))
+
 (defcustom pcomplete-command-completion-function
   (function
    (lambda ()
@@ -1014,39 +1047,6 @@ See the documentation for `pcomplete-here'."
              ;; byte-compiled with the older code.
              (eval form)))))
 
-(defmacro pcomplete-here (&optional form stub paring form-only)
-  "Complete against the current argument, if at the end.
-If completion is to be done here, evaluate FORM to generate the completion
-table which will be used for completion purposes.  If STUB is a
-string, use it as the completion stub instead of the default (which is
-the entire text of the current argument).
-
-For an example of when you might want to use STUB: if the current
-argument text is `long-path-name/', you don't want the completions
-list display to be cluttered by `long-path-name/' appearing at the
-beginning of every alternative.  Not only does this make things less
-intelligible, but it is also inefficient.  Yet, if the completion list
-does not begin with this string for every entry, the current argument
-won't complete correctly.
-
-The solution is to specify a relative stub.  It allows you to
-substitute a different argument from the current argument, almost
-always for the sake of efficiency.
-
-If PARING is nil, this argument will be pared against previous
-arguments using the function `file-truename' to normalize them.
-PARING may be a function, in which case that function is used for
-normalization.  If PARING is t, the argument dealt with by this
-call will not participate in argument paring.  If it is the
-integer 0, all previous arguments that have been seen will be
-cleared.
-
-If FORM-ONLY is non-nil, only the result of FORM will be used to
-generate the completions list.  This means that the hook
-`pcomplete-try-first-hook' will not be run."
-  (declare (debug t))
-  `(pcomplete--here (lambda () ,form) ,stub ,paring ,form-only))
-
 
 (defmacro pcomplete-here* (&optional form stub form-only)
   "An alternate form which does not participate in argument paring."
-- 
2.21.0


From 13fb6bb928fa728e8554aab972ab53ca0ce2a334 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 15 Mar 2018 12:32:50 -0400
Subject: [PATCH 190/297] * test/lisp/ses-tests.el: Quieten compilation.

---
 test/lisp/ses-tests.el | 79 ++++++++++++++++++++++--------------------
 1 file changed, 42 insertions(+), 37 deletions(-)

diff --git a/test/lisp/ses-tests.el b/test/lisp/ses-tests.el
index d08237e285..c773c9b396 100644
--- a/test/lisp/ses-tests.el
+++ b/test/lisp/ses-tests.el
@@ -38,7 +38,7 @@ interactively."
       (dolist (c '((0 0 1) (1 0 (1+ A1))))
         (apply 'ses-cell-set-formula c)
         (apply 'ses-calculate-cell (list (car c) (cadr c) nil)))
-      (should (eq A2 2)))))
+      (should (eq (bound-and-true-p A2) 2)))))
 
 (ert-deftest ses-tests-plain-formula ()
   "Check that setting A1 to 1 and A2 to (1+ A1), makes A2 value
@@ -49,13 +49,16 @@ equal to 2. This is done  using interactive calls."
       (dolist (c '((0 0 1) (1 0 (1+ A1))))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook)
-      (should (eq A2 2)))))
+      (should (eq (bound-and-true-p A2) 2)))))
 
 ;; PLAIN CELL RENAMING TESTS
 ;; ======================================================================
 
+(defvar ses--foo)
+(defvar ses--cells)
+
 (ert-deftest ses-tests-lowlevel-renamed-cell ()
-  "Check that renaming A1 to `foo' and setting `foo' to 1 and A2 to (1+ foo), makes A2 value equal to 2.
+  "Check that renaming A1 to `ses--foo' and setting `ses--foo' to 1 and A2 to (1+ ses--foo), makes A2 value equal to 2.
 This is done using low level functions, `ses-rename-cell' is not
 called but instead we use text replacement in the buffer
 previously passed in text mode."
@@ -69,63 +72,63 @@ previously passed in text mode."
       (text-mode)
       (goto-char (point-min))
       (while (re-search-forward "\\<A1\\>" nil t)
-        (replace-match "foo" t t))
+        (replace-match "ses--foo" t t))
       (ses-mode)
       (should-not  (local-variable-p 'A1))
-      (should (eq foo 1))
-      (should (equal (ses-cell-formula 1 0) '(ses-safe-formula (1+ foo))))
-      (should (eq A2 2)))))
+      (should (eq ses--foo 1))
+      (should (equal (ses-cell-formula 1 0) '(ses-safe-formula (1+ ses--foo))))
+      (should (eq (bound-and-true-p A2) 2)))))
 
 (ert-deftest ses-tests-renamed-cell ()
-  "Check that renaming A1 to `foo' and setting `foo' to 1 and A2
-to (1+ foo), makes A2 value equal to 2."
+  "Check that renaming A1 to `ses--foo' and setting `ses--foo' to 1 and A2
+to (1+ ses--foo), makes A2 value equal to 2."
   (let ((ses-initial-size '(2 . 1)))
     (with-temp-buffer
       (ses-mode)
-      (ses-rename-cell 'foo (ses-get-cell 0 0))
-      (dolist (c '((0 0 1) (1 0 (1+ foo))))
+      (ses-rename-cell 'ses--foo (ses-get-cell 0 0))
+      (dolist (c '((0 0 1) (1 0 (1+ ses--foo))))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook)
       (should-not  (local-variable-p 'A1))
-      (should (eq foo 1))
-      (should (equal (ses-cell-formula 1 0) '(1+ foo)))
-      (should (eq A2 2)))))
+      (should (eq ses--foo 1))
+      (should (equal (ses-cell-formula 1 0) '(1+ ses--foo)))
+      (should (eq (bound-and-true-p A2) 2)))))
 
 (ert-deftest ses-tests-renamed-cell-after-setting ()
   "Check that setting A1 to 1 and A2 to (1+ A1), and then
-renaming A1 to `foo' makes `foo' value equal to 2."
+renaming A1 to `ses--foo' makes `ses--foo' value equal to 2."
   (let ((ses-initial-size '(2 . 1)))
     (with-temp-buffer
       (ses-mode)
       (dolist (c '((0 0 1) (1 0 (1+ A1))))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook); deferred recalc
-      (ses-rename-cell 'foo (ses-get-cell 0 0))
+      (ses-rename-cell 'ses--foo (ses-get-cell 0 0))
       (should-not  (local-variable-p 'A1))
-      (should (eq foo 1))
-      (should (equal (ses-cell-formula 1 0) '(1+ foo)))
-      (should (eq A2 2)))))
+      (should (eq ses--foo 1))
+      (should (equal (ses-cell-formula 1 0) '(1+ ses--foo)))
+      (should (eq (bound-and-true-p A2) 2)))))
 
 (ert-deftest ses-tests-renaming-cell-with-one-symbol-formula ()
   "Check that setting A1 to 1 and A2 to A1, and then renaming A1
-to `foo' makes `foo' value equal to 1. Then set A1 to 2 and check
-that `foo' becomes 2."
+to `ses--foo' makes `ses--foo' value equal to 1. Then set A1 to 2 and check
+that `ses--foo' becomes 2."
   (let ((ses-initial-size '(3 . 1)))
     (with-temp-buffer
       (ses-mode)
       (dolist (c '((0 0 1) (1 0 A1)))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook); deferred recalc
-      (ses-rename-cell 'foo (ses-get-cell 0 0))
+      (ses-rename-cell 'ses--foo (ses-get-cell 0 0))
       (ses-command-hook); deferred recalc
       (should-not  (local-variable-p 'A1))
-      (should (eq foo 1))
-      (should (equal (ses-cell-formula 1 0) 'foo))
-      (should (eq A2 1))
+      (should (eq ses--foo 1))
+      (should (equal (ses-cell-formula 1 0) 'ses--foo))
+      (should (eq (bound-and-true-p A2) 1))
       (funcall-interactively 'ses-edit-cell 0 0 2)
       (ses-command-hook); deferred recalc
-      (should (eq A2 2))
-      (should (eq foo 2)))))
+      (should (eq (bound-and-true-p A2) 2))
+      (should (eq ses--foo 2)))))
 
 
 ;; ROW INSERTION TESTS
@@ -144,12 +147,14 @@ to A2 and inserting a row, makes A2 value empty, and A3 equal to
       (ses-jump 'A2)
       (ses-insert-row 1)
       (ses-command-hook)
-      (should-not A2)
-      (should (eq A3 2)))))
+      (should-not (bound-and-true-p A2))
+      (should (eq (bound-and-true-p A3) 2)))))
+
+(defvar ses--bar)
 
 (ert-deftest ses-tests-renamed-cells-row-insertion ()
-  "Check that setting A1 to 1 and A2 to (1+ A1), and then renaming A1 to `foo' and A2 to `bar' jumping
-to `bar' and inserting a row, makes A2 value empty, and `bar' equal to
+  "Check that setting A1 to 1 and A2 to (1+ A1), and then renaming A1 to `ses--foo' and A2 to `ses--bar' jumping
+to `ses--bar' and inserting a row, makes A2 value empty, and `ses--bar' equal to
 2."
   (let ((ses-initial-size '(2 . 1)))
     (with-temp-buffer
@@ -157,16 +162,16 @@ to `bar' and inserting a row, makes A2 value empty, and `bar' equal to
       (dolist (c '((0 0 1) (1 0 (1+ A1))))
         (apply 'funcall-interactively 'ses-edit-cell c))
       (ses-command-hook)
-      (ses-rename-cell 'foo (ses-get-cell 0 0))
+      (ses-rename-cell 'ses--foo (ses-get-cell 0 0))
       (ses-command-hook)
-      (ses-rename-cell 'bar (ses-get-cell 1 0))
+      (ses-rename-cell 'ses--bar (ses-get-cell 1 0))
       (ses-command-hook)
-      (should (eq bar 2))
-      (ses-jump 'bar)
+      (should (eq ses--bar 2))
+      (ses-jump 'ses--bar)
       (ses-insert-row 1)
       (ses-command-hook)
-      (should-not A2)
-      (should (eq bar 2)))))
+      (should-not (bound-and-true-p A2))
+      (should (eq ses--bar 2)))))
 
 
 (provide 'ses-tests)
-- 
2.21.0


From b7706c4f1e549437453a1a8a359e0505e4e01e3d Mon Sep 17 00:00:00 2001
From: Paul Eggert <eggert@cs.ucla.edu>
Date: Thu, 15 Mar 2018 09:35:33 -0700
Subject: [PATCH 191/297] Improve port to NetBSD tzalloc
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Problem reported by Valery Ushakov (Bug#30738#13).
* src/editfns.c (tzlookup) [__NetBSD_Version__ < 700000000]:
If tzalloc fails for any reason other than memory exhaustion,
assume it’s because NetBSD 6 does not support tzalloc on
POSIX-format TZ strings, and fall back on tzdb if possible.
---
 src/editfns.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/src/editfns.c b/src/editfns.c
index 85d5bf4679..041af87acd 100644
--- a/src/editfns.c
+++ b/src/editfns.c
@@ -205,6 +205,18 @@ tzlookup (Lisp_Object zone, bool settz)
 	invalid_time_zone_specification (zone);
 
       new_tz = tzalloc (zone_string);
+
+#if defined __NetBSD_Version__ && __NetBSD_Version__ < 700000000
+      /* NetBSD 6 tzalloc mishandles POSIX TZ strings (Bug#30738).
+	 If possible, fall back on tzdb.  */
+      if (!new_tz && errno != ENOMEM && plain_integer
+	  && XINT (zone) % (60 * 60) == 0)
+	{
+	  sprintf (tzbuf, "Etc/GMT%+"pI"d", - (XINT (zone) / (60 * 60)));
+	  new_tz = tzalloc (zone_string);
+	}
+#endif
+
       if (!new_tz)
 	{
 	  if (errno == ENOMEM)
-- 
2.21.0


From f619aefd44020c338aa2fa9e2f972c5aff0d83f8 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 15 Mar 2018 13:29:30 -0400
Subject: [PATCH 192/297] * lisp/progmodes/verilog-mode.el (verilog-mode):
 Quieten compilation.

---
 lisp/progmodes/verilog-mode.el | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/lisp/progmodes/verilog-mode.el b/lisp/progmodes/verilog-mode.el
index 48dee4bef3..6657761902 100644
--- a/lisp/progmodes/verilog-mode.el
+++ b/lisp/progmodes/verilog-mode.el
@@ -3966,7 +3966,9 @@ Key bindings specific to `verilog-mode-map' are:
             #'verilog-completion-at-point nil 'local)
 
   ;; Stuff for autos
-  (add-hook 'write-contents-hooks 'verilog-auto-save-check nil 'local)
+  (add-hook (if (boundp 'write-contents-hooks) 'write-contents-hooks
+	      'write-contents-functions) ; Emacs >= 22.1
+	    'verilog-auto-save-check nil 'local)
   ;; verilog-mode-hook call added by define-derived-mode
   )
 
-- 
2.21.0


From aaa4ca8cf7e45614419e5128cd0ad3b2f96b3158 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 15 Mar 2018 20:20:24 -0400
Subject: [PATCH 193/297] * lisp/emulation/cua-base.el (cua-paste): Quieten
 compilation.

---
 lisp/emulation/cua-base.el | 8 ++------
 1 file changed, 2 insertions(+), 6 deletions(-)

diff --git a/lisp/emulation/cua-base.el b/lisp/emulation/cua-base.el
index a737bb6c11..ff23484dd0 100644
--- a/lisp/emulation/cua-base.el
+++ b/lisp/emulation/cua-base.el
@@ -852,8 +852,6 @@ With numeric prefix arg, copy to register 0-9 instead."
   (if (fboundp 'cua--cancel-rectangle)
       (cua--cancel-rectangle)))
 
-(declare-function x-clipboard-yank "../term/x-win" ())
-
 (put 'cua-paste 'delete-selection 'yank)
 (defun cua-paste (arg)
   "Paste last cut or copied region or rectangle.
@@ -884,10 +882,8 @@ If global mark is active, copy from register or one character."
 	 ((consp regtxt) (cua--insert-rectangle regtxt))
 	 ((stringp regtxt) (insert-for-yank regtxt))
 	 (t (message "Unknown data in register %c" cua--register))))
-       ((eq this-original-command 'clipboard-yank)
-	(clipboard-yank))
-       ((eq this-original-command 'x-clipboard-yank)
-	(x-clipboard-yank))
+       ((memq this-original-command '(clipboard-yank x-clipboard-yank))
+        (funcall this-original-command))
        (t (yank arg)))))))
 
 
-- 
2.21.0


From 69dfd6d0f349d6413adeb7351ec4677b2968feb2 Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 15 Mar 2018 20:22:06 -0400
Subject: [PATCH 194/297] * lisp/gnus/nnmaildir.el (nnmaildir-close-server):
 Remove unused locals.

; By inspection, these were leftovers rather than dynamic bindings.
; See eg a very old version of nnmaildir.el such as
; https://web.archive.org/web/20020531235353/http://multivac.cwru.edu:80/nnmaildir/releases/nnmaildir-2001.12.19.el.bz2
---
 lisp/gnus/nnmaildir.el | 13 +++++--------
 1 file changed, 5 insertions(+), 8 deletions(-)

diff --git a/lisp/gnus/nnmaildir.el b/lisp/gnus/nnmaildir.el
index 3e4a87cee7..dc97b32f0b 100644
--- a/lisp/gnus/nnmaildir.el
+++ b/lisp/gnus/nnmaildir.el
@@ -1779,14 +1779,11 @@ This variable is set by `nnmaildir-request-article'.")
       t)))
 
 (defun nnmaildir-close-server (&optional server)
-  (defvar flist) (defvar ls) (defvar dirs) (defvar dir)
-  (defvar files) (defvar file) (defvar x)
-  (let (flist ls dirs dir files file x)
-    (nnmaildir--prepare server nil)
-    (when nnmaildir--cur-server
-      (setq server nnmaildir--cur-server
-	    nnmaildir--cur-server nil)
-      (unintern (nnmaildir--srv-address server) nnmaildir--servers)))
+  (nnmaildir--prepare server nil)
+  (when nnmaildir--cur-server
+    (setq server nnmaildir--cur-server
+	  nnmaildir--cur-server nil)
+    (unintern (nnmaildir--srv-address server) nnmaildir--servers))
   t)
 
 (defun nnmaildir-request-close ()
-- 
2.21.0


From 09a6314e63e980ec659c7141aea334a7325486af Mon Sep 17 00:00:00 2001
From: Glenn Morris <rgm@gnu.org>
Date: Thu, 15 Mar 2018 20:23:09 -0400
Subject: [PATCH 195/297] Replace some obsolete uses of
 filter-buffer-substring-functions

* lisp/org/org-agenda.el (org-agenda-mode):
* lisp/org/org-indent.el (org-indent-mode):
Replace filter-buffer-substring-functions, obsolete since 24.4.
---
 lisp/org/org-agenda.el | 12 ++++++++----
 lisp/org/org-indent.el | 25 ++++++++++++++++---------
 2 files changed, 24 insertions(+), 13 deletions(-)

diff --git a/lisp/org/org-agenda.el b/lisp/org/org-agenda.el
index 9aaec33070..3d4379b022 100644
--- a/lisp/org/org-agenda.el
+++ b/lisp/org/org-agenda.el
@@ -2201,10 +2201,14 @@ The following commands are available:
   (add-hook 'post-command-hook 'org-agenda-update-agenda-type nil 'local)
   (add-hook 'pre-command-hook 'org-unhighlight nil 'local)
   ;; Make sure properties are removed when copying text
-  (add-hook 'filter-buffer-substring-functions
-	    (lambda (fun start end delete)
-	      (substring-no-properties (funcall fun start end delete)))
-	    nil t)
+  (if (boundp 'filter-buffer-substring-functions)
+      (add-hook 'filter-buffer-substring-functions
+                (lambda (fun start end delete)
+                  (substring-no-properties (funcall fun start end delete)))
+                nil t)
+    ;; Emacs >= 24.4.
+    (add-function :filter-return (local 'filter-buffer-substring-function)
+                  #'substring-no-properties))
   (unless org-agenda-keep-modes
     (setq org-agenda-follow-mode org-agenda-start-with-follow-mode
 	  org-agenda-entry-text-mode org-agenda-start-with-entry-text-mode))
diff --git a/lisp/org/org-indent.el b/lisp/org/org-indent.el
index ef68c3c4fa..f2cd6a66fb 100644
--- a/lisp/org/org-indent.el
+++ b/lisp/org/org-indent.el
@@ -183,11 +183,15 @@ during idle time."
 		  org-hide-leading-stars)
       (setq-local org-hide-leading-stars t))
     (org-indent--compute-prefixes)
-    (add-hook 'filter-buffer-substring-functions
-	      (lambda (fun start end delete)
-		(org-indent-remove-properties-from-string
-		 (funcall fun start end delete)))
-	      nil t)
+    (if (boundp 'filter-buffer-substring-functions)
+	(add-hook 'filter-buffer-substring-functions
+		  (lambda (fun start end delete)
+		    (org-indent-remove-properties-from-string
+		     (funcall fun start end delete)))
+		  nil t)
+      ;; Emacs >= 24.4.
+      (add-function :filter-return (local 'filter-buffer-substring-function)
+		    #'org-indent-remove-properties-from-string))
     (add-hook 'after-change-functions 'org-indent-refresh-maybe nil 'local)
     (add-hook 'before-change-functions
 	      'org-indent-notify-modified-headline nil 'local)
@@ -211,10 +215,13 @@ during idle time."
     (when (boundp 'org-hide-leading-stars-before-indent-mode)
       (setq-local org-hide-leading-stars
 		  org-hide-leading-stars-before-indent-mode))
-    (remove-hook 'filter-buffer-substring-functions
-		 (lambda (fun start end delete)
-		   (org-indent-remove-properties-from-string
-		    (funcall fun start end delete))))
+    (if (boundp 'filter-buffer-substring-functions)
+	(remove-hook 'filter-buffer-substring-functions
+		     (lambda (fun start end delete)
+		       (org-indent-remove-properties-from-string
+			(funcall fun start end delete))))
+      (remove-function (local 'filter-buffer-substring-function)
+		       #'org-indent-remove-properties-from-string))
     (remove-hook 'after-change-functions 'org-indent-refresh-maybe 'local)
     (remove-hook 'before-change-functions
 		 'org-indent-notify-modified-headline 'local)
-- 
2.21.0


From 2b313f7bac37c0deb59ff79612f9135bc128bc11 Mon Sep 17 00:00:00 2001
From: Sean Perry <shaleh@speakeasy.net>
Date: Sun, 6 Jan 2019 23:04:06 -0800
Subject: [PATCH 196/297] Restore remacs over emacs in Makefile.

---
 src/Makefile.in | 4 ----
 1 file changed, 4 deletions(-)

diff --git a/src/Makefile.in b/src/Makefile.in
index 04e03e7557..0e345c4f3f 100644
--- a/src/Makefile.in
+++ b/src/Makefile.in
@@ -453,10 +453,6 @@ ALLOBJS = $(FIRSTFILE_OBJ) $(VMLIMIT_OBJ) $(obj) -lremacs $(otherobj)
 all: remacs$(EXEEXT) $(OTHER_FILES)
 .PHONY: all
 
-# Must be first, before dep inclusion!
-all: emacs$(EXEEXT) $(OTHER_FILES)
-.PHONY: all
-
 AUTO_DEPEND = @AUTO_DEPEND@
 DEPDIR = deps
 ifeq ($(AUTO_DEPEND),yes)
-- 
2.21.0


From 6f42432cbf2fde91357c424239a16fb61043cec1 Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Tue, 8 Jan 2019 19:53:02 -0800
Subject: [PATCH 197/297] Break up implementation of Debug trait. (#1158)

To facilitate this, introduce `force_foo` methods which are analogous to `XFOO` in the C code. These can replace some of our usage of `as_foo_or_error()` when we are certain of the type of the object.

What I'd like to see is a bit of bikeshedding over the naming I used. is `force_foo` clear enough? I wanted the name to be short so it did not use up too much space in code and detract from the real work. The C `XFOO` is fairly perfect in that regard.
---
 rust_src/src/floatfns.rs  |  4 ++
 rust_src/src/lib.rs       |  9 ++--
 rust_src/src/lisp.rs      | 93 ++++++++++++---------------------------
 rust_src/src/lists.rs     | 30 ++++++++++++-
 rust_src/src/multibyte.rs | 14 +++++-
 rust_src/src/numbers.rs   |  4 ++
 rust_src/src/symbols.rs   | 13 ++++++
 rust_src/src/vectors.rs   | 36 +++++++++++++--
 8 files changed, 129 insertions(+), 74 deletions(-)

diff --git a/rust_src/src/floatfns.rs b/rust_src/src/floatfns.rs
index 146d710242..a7c8164c52 100644
--- a/rust_src/src/floatfns.rs
+++ b/rust_src/src/floatfns.rs
@@ -41,6 +41,10 @@ impl LispObject {
         *self.to_float_unchecked().as_data()
     }
 
+    pub fn force_float(self) -> EmacsDouble {
+        unsafe { self.get_float_data_unchecked() }
+    }
+
     pub fn as_float(self) -> Option<EmacsDouble> {
         if self.is_float() {
             Some(unsafe { self.get_float_data_unchecked() })
diff --git a/rust_src/src/lib.rs b/rust_src/src/lib.rs
index f4f3d80ae4..119144f0a7 100644
--- a/rust_src/src/lib.rs
+++ b/rust_src/src/lib.rs
@@ -2,7 +2,6 @@
 #![allow(clippy::wrong_self_convention)]
 #![allow(clippy::too_many_arguments)]
 #![allow(clippy::not_unsafe_ptr_arg_deref)]
-#![feature(const_fn)]
 #![allow(non_upper_case_globals)]
 #![allow(non_snake_case)]
 #![allow(non_camel_case_types, non_snake_case, non_upper_case_globals)]
@@ -12,13 +11,15 @@
 #![cfg_attr(test, allow(unused))]
 #![cfg_attr(feature = "strict", deny(warnings))]
 #![feature(concat_idents)]
-#![feature(stmt_expr_attributes)]
-#![feature(untagged_unions)]
-#![feature(never_type)]
+#![feature(const_fn)]
 #![feature(const_fn_union)]
+#![feature(never_type)]
 #![feature(ptr_offset_from)]
 #![feature(self_struct_ctor)]
+#![feature(slice_patterns)]
 #![feature(specialization)]
+#![feature(stmt_expr_attributes)]
+#![feature(untagged_unions)]
 
 extern crate errno;
 #[macro_use]
diff --git a/rust_src/src/lisp.rs b/rust_src/src/lisp.rs
index b062300ed7..21a93ed4c1 100644
--- a/rust_src/src/lisp.rs
+++ b/rust_src/src/lisp.rs
@@ -1,14 +1,13 @@
 //! This module contains Rust definitions whose C equivalents live in
 //! lisp.h.
 
-use libc::{c_char, c_void, intptr_t, uintptr_t};
-use std::ffi::CString;
-
 use std::convert::From;
+use std::ffi::CString;
 use std::fmt::{Debug, Error, Formatter};
 use std::mem;
 use std::ops::{Deref, DerefMut};
-use std::slice;
+
+use libc::{c_char, c_void, intptr_t, uintptr_t};
 
 use crate::{
     buffers::LispBufferRef,
@@ -91,7 +90,6 @@ where
 // ExternalPtr
 
 #[repr(transparent)]
-#[derive(Debug)]
 pub struct ExternalPtr<T>(*mut T);
 
 impl<T> Copy for ExternalPtr<T> {}
@@ -183,6 +181,10 @@ impl LispObject {
         self.get_type() == Lisp_Type::Lisp_Misc
     }
 
+    pub fn force_misc(self) -> LispMiscRef {
+        unsafe { self.to_misc_unchecked() }
+    }
+
     pub fn as_misc(self) -> Option<LispMiscRef> {
         if self.is_misc() {
             unsafe { Some(self.to_misc_unchecked()) }
@@ -196,6 +198,17 @@ impl LispObject {
     }
 }
 
+impl Debug for LispMiscRef {
+    fn fmt(&self, f: &mut Formatter) -> Result<(), Error> {
+        write!(
+            f,
+            "#<MISC @ {:p}: VAL({:#X})>",
+            self.as_ptr(),
+            LispObject::tag_ptr(*self, Lisp_Type::Lisp_Misc).to_C()
+        )
+    }
+}
+
 // Lisp_Subr support
 
 pub type LispSubrRef = ExternalPtr<Lisp_Subr>;
@@ -595,78 +608,30 @@ impl LispObject {
 /// of arguments.
 pub const MANY: i16 = -2;
 
-/// Internal function to get a displayable string out of a Lisp string.
-fn display_string(obj: LispObject) -> String {
-    let s = obj.as_string().unwrap();
-    let slice = unsafe { slice::from_raw_parts(s.const_data_ptr(), s.len_bytes() as usize) };
-    String::from_utf8_lossy(slice).into_owned()
-}
-
 impl Debug for LispObject {
     fn fmt(&self, f: &mut Formatter) -> Result<(), Error> {
         let ty = self.get_type();
-        let self_ptr = &self as *const _ as usize;
+        let self_ptr = &self as *const _;
         if ty as u8 >= 8 {
-            write!(
+            return write!(
                 f,
-                "#<INVALID-OBJECT @ {:#X}: VAL({:#X})>",
+                "#<INVALID-OBJECT @ {:p}: VAL({:#X})>",
                 self_ptr,
                 self.to_C()
-            )?;
-            return Ok(());
+            );
         }
         if self.is_nil() {
             return write!(f, "nil");
         }
         match ty {
-            Lisp_Type::Lisp_Symbol => {
-                let name = self.as_symbol_or_error().symbol_name();
-                write!(f, "'{}", display_string(name))?;
-            }
-            Lisp_Type::Lisp_Cons => {
-                let mut cdr = *self;
-                write!(f, "'(")?;
-                while let Some((a, d)) = cdr.into() {
-                    write!(f, "{:?} ", a)?;
-                    cdr = d;
-                }
-                if cdr.is_nil() {
-                    write!(f, ")")?;
-                } else {
-                    write!(f, ". {:?}", cdr)?;
-                }
-            }
-            Lisp_Type::Lisp_Float => {
-                write!(f, "{}", self.as_float().unwrap())?;
-            }
-            Lisp_Type::Lisp_Vectorlike => {
-                let vl = self.as_vectorlike().unwrap();
-                if vl.is_vector() {
-                    write!(f, "[")?;
-                    for el in vl.as_vector().unwrap().as_slice() {
-                        write!(f, "{:?} ", el)?;
-                    }
-                    write!(f, "]")?;
-                } else {
-                    write!(
-                        f,
-                        "#<VECTOR-LIKE @ {:#X}: VAL({:#X})>",
-                        self_ptr,
-                        self.to_C()
-                    )?;
-                }
-            }
-            Lisp_Type::Lisp_Int0 | Lisp_Type::Lisp_Int1 => {
-                write!(f, "{}", self.as_fixnum().unwrap())?;
-            }
-            Lisp_Type::Lisp_Misc => {
-                write!(f, "#<MISC @ {:#X}: VAL({:#X})>", self_ptr, self.to_C())?;
-            }
-            Lisp_Type::Lisp_String => {
-                write!(f, "{:?}", display_string(*self))?;
-            }
+            Lisp_Type::Lisp_Symbol => write!(f, "{:?}", self.force_symbol()),
+            Lisp_Type::Lisp_Cons => write!(f, "{:?}", self.force_cons()),
+            Lisp_Type::Lisp_Float => write!(f, "{}", self.force_float()),
+            Lisp_Type::Lisp_Vectorlike => write!(f, "{:?}", self.force_vectorlike()),
+            Lisp_Type::Lisp_Int0 | Lisp_Type::Lisp_Int1 => write!(f, "{}", self.force_fixnum()),
+            Lisp_Type::Lisp_Misc => write!(f, "{:?}", self.force_misc()),
+            Lisp_Type::Lisp_String => write!(f, "{:?}", self.force_string()),
         }
-        Ok(())
     }
 }
 
diff --git a/rust_src/src/lists.rs b/rust_src/src/lists.rs
index ec7aec73e7..3667944ad0 100644
--- a/rust_src/src/lists.rs
+++ b/rust_src/src/lists.rs
@@ -1,5 +1,8 @@
 //! Operations on lists.
 
+use std::fmt;
+use std::fmt::{Debug, Formatter};
+
 use libc::c_void;
 
 use remacs_macros::lisp_fn;
@@ -18,7 +21,7 @@ use crate::{
 
 /// A newtype for objects we know are conses.
 #[repr(transparent)]
-#[derive(Clone, Copy, Debug)]
+#[derive(Clone, Copy)]
 pub struct LispCons(LispObject);
 
 impl LispObject {
@@ -32,6 +35,10 @@ impl LispObject {
         self.get_type() == Lisp_Type::Lisp_Cons
     }
 
+    pub fn force_cons(self) -> LispCons {
+        LispCons(self)
+    }
+
     pub fn as_cons(self) -> Option<LispCons> {
         if self.is_cons() {
             Some(LispCons(self))
@@ -41,6 +48,27 @@ impl LispObject {
     }
 }
 
+impl Debug for LispCons {
+    fn fmt(&self, f: &mut Formatter) -> Result<(), fmt::Error> {
+        write!(f, "'(")?;
+        let mut first = true;
+        let mut it = self.iter_cars(LispConsEndChecks::off, LispConsCircularChecks::on);
+        while let Some(car) = it.next() {
+            if first {
+                first = false;
+            } else {
+                write!(f, " ")?;
+            }
+            write!(f, "{:?}", car)?;
+        }
+        let last = it.rest();
+        if !last.is_nil() {
+            write!(f, ". {:?}", last)?;
+        }
+        write!(f, ")")
+    }
+}
+
 impl LispObject {
     pub fn cons<A: Into<LispObject>, D: Into<LispObject>>(car: A, cdr: D) -> Self {
         unsafe { Fcons(car.into(), cdr.into()) }
diff --git a/rust_src/src/multibyte.rs b/rust_src/src/multibyte.rs
index 0c169c321d..550b7849e7 100644
--- a/rust_src/src/multibyte.rs
+++ b/rust_src/src/multibyte.rs
@@ -197,6 +197,12 @@ impl fmt::Display for LispStringRef {
     }
 }
 
+impl fmt::Debug for LispStringRef {
+    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {
+        write!(f, "{}", self)
+    }
+}
+
 pub struct LispStringRefIterator<'a> {
     string_ref: &'a LispStringRef,
     cur: usize,
@@ -266,7 +272,7 @@ impl From<LispObject> for LispStringRef {
 impl From<LispObject> for Option<LispStringRef> {
     fn from(o: LispObject) -> Self {
         if o.is_string() {
-            Some(unsafe { o.as_string_unchecked() })
+            Some(o.force_string())
         } else {
             None
         }
@@ -284,6 +290,10 @@ impl LispObject {
         self.get_type() == Lisp_Type::Lisp_String
     }
 
+    pub fn force_string(self) -> LispStringRef {
+        unsafe { self.to_string_unchecked() }
+    }
+
     pub fn as_string(self) -> Option<LispStringRef> {
         self.into()
     }
@@ -292,7 +302,7 @@ impl LispObject {
         self.into()
     }
 
-    pub unsafe fn as_string_unchecked(self) -> LispStringRef {
+    pub unsafe fn to_string_unchecked(self) -> LispStringRef {
         LispStringRef::new(self.get_untaggedptr() as *mut Lisp_String)
     }
 
diff --git a/rust_src/src/numbers.rs b/rust_src/src/numbers.rs
index f2cd951ea8..34b2fc15f0 100644
--- a/rust_src/src/numbers.rs
+++ b/rust_src/src/numbers.rs
@@ -54,6 +54,10 @@ impl LispObject {
             == Lisp_Type::Lisp_Int0 as u8
     }
 
+    pub fn force_fixnum(self) -> EmacsInt {
+        unsafe { self.to_fixnum_unchecked() }
+    }
+
     pub fn as_fixnum(self) -> Option<EmacsInt> {
         if self.is_fixnum() {
             Some(unsafe { self.to_fixnum_unchecked() })
diff --git a/rust_src/src/symbols.rs b/rust_src/src/symbols.rs
index 58b88acd0d..0715775dfc 100644
--- a/rust_src/src/symbols.rs
+++ b/rust_src/src/symbols.rs
@@ -1,5 +1,8 @@
 //! symbols support
 
+use std::fmt;
+use std::fmt::{Debug, Formatter};
+
 use remacs_macros::lisp_fn;
 
 use crate::{
@@ -183,6 +186,10 @@ impl LispObject {
         self.get_type() == Lisp_Type::Lisp_Symbol
     }
 
+    pub fn force_symbol(self) -> LispSymbolRef {
+        LispSymbolRef::new(self.symbol_ptr_value() as *mut Lisp_Symbol)
+    }
+
     pub fn as_symbol(self) -> Option<LispSymbolRef> {
         self.into()
     }
@@ -213,6 +220,12 @@ impl LispObject {
     }
 }
 
+impl Debug for LispSymbolRef {
+    fn fmt(&self, f: &mut Formatter) -> Result<(), fmt::Error> {
+        write!(f, "'{:?}", self.symbol_name())
+    }
+}
+
 pub struct LispSymbolIter {
     current: LispSymbolRef,
 }
diff --git a/rust_src/src/vectors.rs b/rust_src/src/vectors.rs
index 3c7eaf2503..e1f5645bc0 100644
--- a/rust_src/src/vectors.rs
+++ b/rust_src/src/vectors.rs
@@ -1,6 +1,8 @@
 //! Functions operating on vector(like)s, and general sequences.
 
 use std::cmp::Ordering;
+use std::fmt;
+use std::fmt::{Debug, Formatter};
 use std::mem;
 use std::ptr;
 
@@ -46,11 +48,13 @@ impl LispObject {
         self.as_vectorlike().map_or(false, |v| v.is_vector())
     }
 
+    pub fn force_vectorlike(self) -> LispVectorlikeRef {
+        unsafe { self.as_vectorlike_unchecked() }
+    }
+
     pub fn as_vectorlike(self) -> Option<LispVectorlikeRef> {
         if self.is_vectorlike() {
-            Some(LispVectorlikeRef::new(
-                self.get_untaggedptr() as *mut Lisp_Vectorlike
-            ))
+            Some(unsafe { self.as_vectorlike_unchecked() })
         } else {
             None
         }
@@ -96,6 +100,32 @@ impl LispObject {
     }
 }
 
+impl Debug for LispVectorlikeRef {
+    fn fmt(&self, f: &mut Formatter) -> Result<(), fmt::Error> {
+        match self.as_vector() {
+            Some(v) => {
+                write!(f, "[")?;
+                match v.as_slice() {
+                    [] => {}
+                    [first, rest..] => {
+                        write!(f, "{:?}", first)?;
+                        for elt in rest {
+                            write!(f, " {:?}", elt)?;
+                        }
+                    }
+                }
+                write!(f, "]")
+            }
+            None => write!(
+                f,
+                "#<VECTOR-LIKE @ {:p}: VAL({:#X})>",
+                self.as_ptr(),
+                LispObject::tag_ptr(*self, Lisp_Type::Lisp_Vectorlike).to_C()
+            ),
+        }
+    }
+}
+
 impl LispVectorlikeRef {
     pub fn equal(self, other: Self, kind: equal_kind::Type, depth: i32, ht: LispObject) -> bool {
         // Pseudovectors have the type encoded in the size field, so this test
-- 
2.21.0


From 36c1ac4c16778fd0e28f0487fb22959a2180a451 Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Wed, 9 Jan 2019 21:32:02 +0100
Subject: [PATCH 198/297] port terminal-name (#871)

Implement LispLiveTerminal.
---
 rust_src/src/remacs_sys.rs |   1 +
 rust_src/src/terminal.rs   | 118 ++++++++++++++++++++++++++++++++++++-
 src/lisp.h                 |   4 ++
 src/terminal.c             |  47 ---------------
 4 files changed, 121 insertions(+), 49 deletions(-)

diff --git a/rust_src/src/remacs_sys.rs b/rust_src/src/remacs_sys.rs
index f7cd71dc05..a04afeeac1 100755
--- a/rust_src/src/remacs_sys.rs
+++ b/rust_src/src/remacs_sys.rs
@@ -143,6 +143,7 @@ unsafe impl Sync for Lisp_Subr {}
 pub type Lisp_Buffer = buffer;
 pub type Lisp_Frame = frame;
 pub type Lisp_Glyph = glyph;
+pub type Lisp_Terminal = terminal;
 pub type Lisp_Window = window;
 
 #[repr(C)]
diff --git a/rust_src/src/terminal.rs b/rust_src/src/terminal.rs
index 78ecb20a1f..63550cd31f 100644
--- a/rust_src/src/terminal.rs
+++ b/rust_src/src/terminal.rs
@@ -1,6 +1,91 @@
-use libc::c_int;
+//! Functions related to terminal devices.
 
-use crate::{dispnew::LispGlyphRef, frames::LispFrameRef};
+use std::{mem, ptr};
+
+use libc::{c_int, c_void};
+
+use remacs_macros::lisp_fn;
+
+use crate::{
+    dispnew::LispGlyphRef,
+    frames::Fselected_frame,
+    frames::LispFrameRef,
+    lisp::defsubr,
+    lisp::{ExternalPtr, LispObject},
+    remacs_sys::build_string,
+    remacs_sys::{pvec_type, Lisp_Terminal},
+    remacs_sys::{Qnil, Qterminal_live_p},
+    vectors::LispVectorlikeRef,
+};
+
+pub type LispTerminalRef = ExternalPtr<Lisp_Terminal>;
+
+impl LispTerminalRef {
+    pub fn is_live(self) -> bool {
+        !self.name.is_null()
+    }
+
+    pub fn name(self) -> LispObject {
+        if self.name.is_null() {
+            Qnil
+        } else {
+            unsafe { build_string(self.name) }
+        }
+    }
+}
+
+impl LispVectorlikeRef {
+    pub fn as_terminal(self) -> Option<LispTerminalRef> {
+        if self.is_pseudovector(pvec_type::PVEC_TERMINAL) {
+            Some(unsafe { mem::transmute(self) })
+        } else {
+            None
+        }
+    }
+}
+
+impl LispObject {
+    pub fn is_terminal(self) -> bool {
+        self.as_vectorlike()
+            .map_or(false, |v| v.is_pseudovector(pvec_type::PVEC_TERMINAL))
+    }
+
+    pub fn as_terminal(self) -> Option<LispTerminalRef> {
+        self.as_vectorlike().and_then(|v| v.as_terminal())
+    }
+}
+
+#[repr(transparent)]
+pub struct LispLiveTerminal(LispTerminalRef);
+
+impl From<LispObject> for Option<LispLiveTerminal> {
+    fn from(obj: LispObject) -> Self {
+        let obj = if obj.is_nil() { Fselected_frame() } else { obj };
+
+        let term = if let Some(frame) = obj.as_frame() {
+            frame.terminal
+        } else if let Some(mut terminal) = obj.as_terminal() {
+            terminal.as_mut()
+        } else {
+            ptr::null_mut()
+        };
+
+        if let Some(term_ref) = LispTerminalRef::from_ptr(term as *mut c_void) {
+            if term_ref.is_live() {
+                return Some(LispLiveTerminal(term_ref));
+            }
+        }
+
+        None
+    }
+}
+
+impl From<LispObject> for LispLiveTerminal {
+    fn from(obj: LispObject) -> Self {
+        let value: Option<LispLiveTerminal> = obj.into();
+        value.unwrap_or_else(|| wrong_type!(Qterminal_live_p, obj))
+    }
+}
 
 #[no_mangle]
 pub unsafe extern "C" fn update_begin(mut f: LispFrameRef) {
@@ -82,3 +167,32 @@ pub unsafe extern "C" fn ins_del_lines(mut f: LispFrameRef, vpos: c_int, n: c_in
         hook(f.as_mut(), vpos, n)
     }
 }
+
+/// Return the terminal object specified by TERMINAL.  TERMINAL may
+/// be a terminal object, a frame, or nil for the terminal device of
+/// the current frame.  If TERMINAL is neither from the above or the
+/// resulting terminal object is deleted, return NULL.
+#[no_mangle]
+pub extern "C" fn decode_terminal(terminal: LispObject) -> *mut Lisp_Terminal {
+    let term: Option<LispLiveTerminal> = terminal.into();
+    term.map_or_else(ptr::null_mut, |mut term| term.0.as_mut())
+}
+
+/// Like decode_terminal, but throw an error if TERMINAL is not valid or deleted.
+#[no_mangle]
+pub extern "C" fn decode_live_terminal(terminal: LispObject) -> *mut Lisp_Terminal {
+    let mut term: LispLiveTerminal = terminal.into();
+    term.0.as_mut()
+}
+
+/// Return the name of the terminal device TERMINAL.
+/// It is not guaranteed that the returned value is unique among opened devices.
+///
+/// TERMINAL may be a terminal object, a frame, or nil (meaning the
+/// selected frame's terminal).
+#[lisp_fn(min = "0")]
+pub fn terminal_name(terminal: LispLiveTerminal) -> LispObject {
+    terminal.0.name()
+}
+
+include!(concat!(env!("OUT_DIR"), "/terminal_exports.rs"));
diff --git a/src/lisp.h b/src/lisp.h
index ef040e7584..5147224da8 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -4507,6 +4507,10 @@ extern _Noreturn void fatal (const char *msgid, ...)
   ATTRIBUTE_FORMAT_PRINTF (1, 2);
 
 /* Defined in terminal.c.  */
+extern struct terminal *
+decode_terminal (Lisp_Object terminal);
+extern struct terminal *
+decode_live_terminal (Lisp_Object terminal);
 extern void syms_of_terminal (void);
 
 /* Defined in font.c.  */
diff --git a/src/terminal.c b/src/terminal.c
index 47e03f42cd..32dc37a3dd 100644
--- a/src/terminal.c
+++ b/src/terminal.c
@@ -110,36 +110,6 @@ raw_cursor_to (struct frame *f, int row, int col)
     (*FRAME_TERMINAL (f)->raw_cursor_to_hook) (f, row, col);
 }
 
-/* Return the terminal object specified by TERMINAL.  TERMINAL may
-   be a terminal object, a frame, or nil for the terminal device of
-   the current frame.  If TERMINAL is neither from the above or the
-   resulting terminal object is deleted, return NULL.  */
-
-static struct terminal *
-decode_terminal (Lisp_Object terminal)
-{
-  struct terminal *t;
-
-  if (NILP (terminal))
-    terminal = selected_frame;
-  t = (TERMINALP (terminal)
-       ? XTERMINAL (terminal)
-       : FRAMEP (terminal) ? FRAME_TERMINAL (XFRAME (terminal)) : NULL);
-  return t && t->name ? t : NULL;
-}
-
-/* Like above, but throw an error if TERMINAL is not valid or deleted.  */
-
-struct terminal *
-decode_live_terminal (Lisp_Object terminal)
-{
-  struct terminal *t = decode_terminal (terminal);
-
-  if (!t)
-    wrong_type_argument (Qterminal_live_p, terminal);
-  return t;
-}
-
 /* Like decode_terminal, but ensure that the resulting terminal object refers
    to a text-based terminal device.  */
 
@@ -373,21 +343,6 @@ DEFUN ("terminal-list", Fterminal_list, Sterminal_list, 0, 0, 0,
 
   return terminals;
 }
-
-DEFUN ("terminal-name", Fterminal_name, Sterminal_name, 0, 1, 0,
-       doc: /* Return the name of the terminal device TERMINAL.
-It is not guaranteed that the returned value is unique among opened devices.
-
-TERMINAL may be a terminal object, a frame, or nil (meaning the
-selected frame's terminal). */)
-  (Lisp_Object terminal)
-{
-  struct terminal *t = decode_live_terminal (terminal);
-
-  return t->name ? build_string (t->name) : Qnil;
-}
-
-
 
 /* Set the value of terminal parameter PARAMETER in terminal D to VALUE.
    Return the previous value.  */
@@ -409,7 +364,6 @@ store_terminal_param (struct terminal *t, Lisp_Object parameter, Lisp_Object val
     }
 }
 
-
 DEFUN ("terminal-parameters", Fterminal_parameters, Sterminal_parameters, 0, 1, 0,
        doc: /* Return the parameter-alist of terminal TERMINAL.
 The value is a list of elements of the form (PARM . VALUE), where PARM
@@ -572,7 +526,6 @@ or some time later.  */);
   defsubr (&Sframe_terminal);
   defsubr (&Sterminal_live_p);
   defsubr (&Sterminal_list);
-  defsubr (&Sterminal_name);
   defsubr (&Sterminal_parameters);
   defsubr (&Sterminal_parameter);
   defsubr (&Sset_terminal_parameter);
-- 
2.21.0


From ed7c4faedd9e5d02e80384e6487aa7e1b9998c6f Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Wed, 9 Jan 2019 21:37:45 +0100
Subject: [PATCH 199/297] Port move-to-column (#1198)

Port move-to-column
---
 rust_src/src/indent.rs            | 82 ++++++++++++++++++++++++++++--
 src/indent.c                      | 83 ++-----------------------------
 src/indent.h                      | 10 ++++
 test/rust_src/src/indent-tests.el | 33 ++++++++++++
 4 files changed, 124 insertions(+), 84 deletions(-)

diff --git a/rust_src/src/indent.rs b/rust_src/src/indent.rs
index 6855df9f6c..2d8b473b40 100644
--- a/rust_src/src/indent.rs
+++ b/rust_src/src/indent.rs
@@ -7,10 +7,12 @@ use remacs_macros::lisp_fn;
 use crate::{
     buffers::{point_byte, point_min_byte},
     editfns::{point, point_min},
-    lisp::defsubr,
-    remacs_sys::last_known_column_point,
-    remacs_sys::EmacsInt,
-    remacs_sys::{self, find_newline, position_indentation},
+    lisp::{defsubr, LispObject},
+    remacs_sys::EmacsUint,
+    remacs_sys::{self, find_newline, position_indentation, scan_for_column, set_point, EmacsInt},
+    remacs_sys::{del_range, last_known_column, Findent_to, Finsert_char, Qnil, Qt},
+    remacs_sys::{last_known_column_modified, last_known_column_point, set_point_both},
+    threads::ThreadState,
 };
 
 /// Return the indentation of the current line.  This is the
@@ -54,6 +56,78 @@ pub fn current_column() -> EmacsInt {
     column as EmacsInt
 }
 
+/// Move point to column COLUMN in the current line.
+/// Interactively, COLUMN is the value of prefix numeric argument.
+/// The column of a character is calculated by adding together the widths
+/// as displayed of the previous characters in the line.
+/// This function ignores line-continuation;
+/// there is no upper limit on the column number a character can have
+/// and horizontal scrolling has no effect.
+///
+/// If specified column is within a character, point goes after that character.
+/// If it's past end of line, point goes to end of line.
+///
+/// Optional second argument FORCE non-nil means if COLUMN is in the
+/// middle of a tab character, change it to spaces.
+/// In addition, if FORCE is t, and the line is too short to reach
+/// COLUMN, add spaces/tabs to get there.
+///
+/// The return value is the current column.
+#[lisp_fn(min = "1", intspec = "NMove to column")]
+pub fn move_to_column(column: EmacsUint, force: LispObject) -> EmacsUint {
+    let buffer = &mut ThreadState::current_buffer_unchecked();
+    let goal = column;
+
+    let mut col = goal as i64;
+    let mut pos = buffer.zv as isize;
+    let mut prev_col = 0;
+
+    unsafe {
+        scan_for_column(&mut pos, &mut col, &mut prev_col);
+        set_point(pos);
+    }
+
+    let mut col = col as u64;
+    let prev_col = prev_col as u64;
+
+    // If a tab char made us overshoot, change it to spaces and scan through it again
+    if !force.is_nil() && col > goal {
+        let pos_byte = buffer.dec_pos(buffer.pt_byte);
+        let c = buffer.fetch_char(pos_byte);
+
+        if c == '\t' as i32 && prev_col < goal {
+            unsafe {
+                // Insert spaces in front of the tab
+                set_point_both(buffer.pt - 1, buffer.pt_byte - 1);
+                Finsert_char(b' '.into(), (goal - prev_col).into(), Qt);
+
+                // Delete the tab and indent to COL
+                del_range(buffer.pt, buffer.pt + 1);
+                let goal_pt = buffer.pt;
+                let goal_pt_byte = buffer.pt_byte;
+                Findent_to(col.into(), Qnil);
+                set_point_both(goal_pt, goal_pt_byte);
+            }
+
+            // Set the last_known... vars consistently.
+            col = goal;
+        }
+    }
+
+    // If line ends prematurely, add space to the end.
+    if col < goal && force == Qt {
+        col = goal;
+        unsafe { Findent_to(col.into(), Qnil) };
+    }
+
+    unsafe {
+        last_known_column = col as isize;
+        last_known_column_point = buffer.pt;
+        last_known_column_modified = buffer.modifications();
+    }
+    col.into()
+}
+
 // Cancel any recorded value of the horizontal position.
 #[no_mangle]
 pub extern "C" fn invalidate_current_column() {
diff --git a/src/indent.c b/src/indent.c
index 1072c1051f..f9e2d21a84 100644
--- a/src/indent.c
+++ b/src/indent.c
@@ -41,7 +41,7 @@ along with GNU Emacs.  If not, see <https://www.gnu.org/licenses/>.  */
    Some things in set last_known_column_point to -1
    to mark the memorized value as invalid.  */
 
-static ptrdiff_t last_known_column;
+ptrdiff_t last_known_column;
 
 /* Value of point when current_column was called.  */
 
@@ -49,7 +49,7 @@ ptrdiff_t last_known_column_point;
 
 /* Value of MODIFF when current_column was called.  */
 
-static EMACS_INT last_known_column_modified;
+EMACS_INT last_known_column_modified;
 
 static ptrdiff_t current_column_1 (void);
 
@@ -499,7 +499,7 @@ check_display_width (ptrdiff_t pos, ptrdiff_t col, ptrdiff_t *endpos)
    Return the resulting buffer position and column in ENDPOS and GOALCOL.
    PREVCOL gets set to the column of the previous position (it's always
    strictly smaller than the goal column).  */
-static void
+void
 scan_for_column (ptrdiff_t *endpos, EMACS_INT *goalcol, ptrdiff_t *prevcol)
 {
   int tab_width = SANE_TAB_WIDTH (current_buffer);
@@ -927,82 +927,6 @@ indented_beyond_p (ptrdiff_t pos, ptrdiff_t pos_byte, EMACS_INT column)
   return position_indentation (pos_byte) >= column;
 }
 
-DEFUN ("move-to-column", Fmove_to_column, Smove_to_column, 1, 2,
-       "NMove to column: ",
-       doc: /* Move point to column COLUMN in the current line.
-Interactively, COLUMN is the value of prefix numeric argument.
-The column of a character is calculated by adding together the widths
-as displayed of the previous characters in the line.
-This function ignores line-continuation;
-there is no upper limit on the column number a character can have
-and horizontal scrolling has no effect.
-
-If specified column is within a character, point goes after that character.
-If it's past end of line, point goes to end of line.
-
-Optional second argument FORCE non-nil means if COLUMN is in the
-middle of a tab character, change it to spaces.
-In addition, if FORCE is t, and the line is too short to reach
-COLUMN, add spaces/tabs to get there.
-
-The return value is the current column.  */)
-  (Lisp_Object column, Lisp_Object force)
-{
-  ptrdiff_t pos, prev_col;
-  EMACS_INT col;
-  EMACS_INT goal;
-
-  CHECK_NATNUM (column);
-  goal = XINT (column);
-
-  col = goal;
-  pos = ZV;
-  scan_for_column (&pos, &col, &prev_col);
-
-  SET_PT (pos);
-
-  /* If a tab char made us overshoot, change it to spaces
-     and scan through it again.  */
-  if (!NILP (force) && col > goal)
-    {
-      int c;
-      ptrdiff_t pos_byte = PT_BYTE;
-
-      DEC_POS (pos_byte);
-      c = FETCH_CHAR (pos_byte);
-      if (c == '\t' && prev_col < goal)
-	{
-	  ptrdiff_t goal_pt, goal_pt_byte;
-
-	  /* Insert spaces in front of the tab to reach GOAL.  Do this
-	     first so that a marker at the end of the tab gets
-	     adjusted.  */
-	  SET_PT_BOTH (PT - 1, PT_BYTE - 1);
-	  Finsert_char (make_number (' '), make_number (goal - prev_col), Qt);
-
-	  /* Now delete the tab, and indent to COL.  */
-	  del_range (PT, PT + 1);
-	  goal_pt = PT;
-	  goal_pt_byte = PT_BYTE;
-	  Findent_to (make_number (col), Qnil);
-	  SET_PT_BOTH (goal_pt, goal_pt_byte);
-
-	  /* Set the last_known... vars consistently.  */
-	  col = goal;
-	}
-    }
-
-  /* If line ends prematurely, add space to the end.  */
-  if (col < goal && EQ (force, Qt))
-    Findent_to (make_number (col = goal), Qnil);
-
-  last_known_column = col;
-  last_known_column_point = PT;
-  last_known_column_modified = MODIFF;
-
-  return make_number (col);
-}
-
 /* compute_motion: compute buffer posn given screen posn and vice versa */
 
 static struct position val_compute_motion;
@@ -2338,7 +2262,6 @@ syms_of_indent (void)
   DEFSYM (Qcolumns, "columns");
 
   defsubr (&Sindent_to);
-  defsubr (&Smove_to_column);
   defsubr (&Sline_number_display_width);
   defsubr (&Svertical_motion);
   defsubr (&Scompute_motion);
diff --git a/src/indent.h b/src/indent.h
index 4a2d02f2fc..8a433fec08 100644
--- a/src/indent.h
+++ b/src/indent.h
@@ -42,9 +42,17 @@ struct position *vmotion (ptrdiff_t from, ptrdiff_t from_byte,
 ptrdiff_t skip_invisible (ptrdiff_t pos, ptrdiff_t *next_boundary_p,
                           ptrdiff_t to, Lisp_Object window);
 
+/* Last value returned by current_column.
+   Some things in set last_known_column_point to -1
+   to mark the memorized value as invalid.  */
+extern ptrdiff_t last_known_column;
+
 /* Value of point when current_column was called */
 extern ptrdiff_t last_known_column_point;
 
+/* Value of MODIFF when current_column was called.  */
+extern EMACS_INT last_known_column_modified;
+
 /* Functions for dealing with the column cache.  */
 
 /* Return true if the display table DISPTAB specifies the same widths
@@ -60,4 +68,6 @@ void recompute_width_table (struct buffer *buf,
 /* Return the current indentation at a given byte offset */
 ptrdiff_t position_indentation (ptrdiff_t pos_byte);
 
+void scan_for_column (ptrdiff_t *endpos, EMACS_INT *goalcol, ptrdiff_t *prevcol);
+
 #endif /* EMACS_INDENT_H */
diff --git a/test/rust_src/src/indent-tests.el b/test/rust_src/src/indent-tests.el
index 975e4e672a..5ea9645b32 100644
--- a/test/rust_src/src/indent-tests.el
+++ b/test/rust_src/src/indent-tests.el
@@ -4,6 +4,39 @@
 
 (require 'ert)
 
+(ert-deftest move-to-column-basic ()
+  (insert "some text")
+  (move-to-column 6)
+  (should (eq (current-column) 6))
+  (should (eq (point) 7)))
+
+(ert-deftest move-to-column-tabs ()
+  ;; Test move to end of character
+  (insert "\ttext")
+  (move-to-column 4)
+  (should (eq (current-column) 8))
+  (should (eq (point) 2))
+  ;; Test FORCE with tabs
+  (move-to-column 4 t)
+  (should (eq (current-column) 4))
+  (should (eq (point) 5))
+  ;; character after point should still be a tab
+  (should (eq (char-after) 9)))
+
+(ert-deftest move-to-column-eol ()
+  ;; Test move to end of line
+  (insert "some text")
+  (move-to-column 30)
+  (should (eq (current-column) 9))
+  (should (eq (point) 10))
+  ;; Test adding spaces/tabs to end of line only happens when FORCE is t
+  (move-to-column 30 1)
+  (should (eq (current-column) 9))
+  (should (eq (point) 10))
+  (move-to-column 30 t)
+  (should (eq (current-column) 30))
+  (should (eq (point) 18)))
+
 (ert-deftest test-current-indentation-spaces ()
   (insert "     some text")
   (should (equal (current-indentation) 5))
-- 
2.21.0


From e520ad260798e7c719ad86afb5eb0a84b36860df Mon Sep 17 00:00:00 2001
From: Nick Drozd <nicholasdrozd@gmail.com>
Date: Wed, 9 Jan 2019 17:01:03 -0600
Subject: [PATCH 200/297] More casting / conversion simplifications (#1226)

* Convert some instances of as_type_or_error to from/into

In particular, cut as_symbol_or_error and as_marker_or_error entirely.

* Add LispWindowRef::get_frame, cut as_frame_or_error

* Convert some instances of LispObject::from to into
---
 rust_src/src/buffers.rs              | 24 ++++++-------
 rust_src/src/casefiddle.rs           | 10 ++----
 rust_src/src/character.rs            |  6 ++--
 rust_src/src/cmds.rs                 | 31 +++++------------
 rust_src/src/crypto/mod.rs           | 50 ++++++++++++----------------
 rust_src/src/data.rs                 | 33 ++++++++----------
 rust_src/src/dired_unix.rs           | 18 ++++------
 rust_src/src/dispnew.rs              |  4 +--
 rust_src/src/editfns.rs              |  9 ++---
 rust_src/src/eval.rs                 | 10 +++---
 rust_src/src/ffi.rs                  |  3 +-
 rust_src/src/floatfns.rs             |  2 +-
 rust_src/src/fns.rs                  |  7 ++--
 rust_src/src/fonts.rs                |  2 +-
 rust_src/src/frames.rs               | 25 ++++++--------
 rust_src/src/hashtable.rs            |  2 +-
 rust_src/src/keyboard.rs             |  2 +-
 rust_src/src/keymap.rs               | 17 ++++------
 rust_src/src/lisp.rs                 |  4 +--
 rust_src/src/lread.rs                | 25 +++++++-------
 rust_src/src/marker.rs               | 18 ++++------
 rust_src/src/math.rs                 | 17 +++-------
 rust_src/src/minibuf.rs              | 13 ++++----
 rust_src/src/multibyte.rs            |  4 +--
 rust_src/src/numbers.rs              |  2 +-
 rust_src/src/obarray.rs              | 13 ++++----
 rust_src/src/process.rs              | 46 ++++++++++++-------------
 rust_src/src/symbols.rs              | 10 ++----
 rust_src/src/textprop.rs             |  4 +--
 rust_src/src/time.rs                 |  8 +----
 rust_src/src/window_configuration.rs |  2 +-
 rust_src/src/windows.rs              | 22 +++++++-----
 32 files changed, 181 insertions(+), 262 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index b550f52ec2..87da2a5967 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -198,7 +198,7 @@ impl LispBufferRef {
     }
 
     pub fn set_syntax_table(&mut self, table: LispCharTableRef) {
-        self.syntax_table_ = LispObject::from(table);
+        self.syntax_table_ = table.into();
     }
 
     pub fn value_p(self, idx: isize) -> bool {
@@ -844,7 +844,7 @@ pub fn barf_if_buffer_read_only(position: Option<EmacsInt>) {
     let pos = position.unwrap_or_else(point);
 
     let inhibit_read_only: bool = unsafe { globals.Vinhibit_read_only.into() };
-    let prop = unsafe { Fget_text_property(LispObject::from(pos), Qinhibit_read_only, Qnil) };
+    let prop = unsafe { Fget_text_property(pos.into(), Qinhibit_read_only, Qnil) };
 
     if ThreadState::current_buffer_unchecked().is_read_only() && !inhibit_read_only && prop.is_nil()
     {
@@ -927,9 +927,9 @@ pub extern "C" fn fetch_buffer_markers(buffer: *mut Lisp_Buffer) {
         assert!(buffer_ref.begv_marker().is_not_nil());
         assert!(buffer_ref.zv_marker().is_not_nil());
 
-        let pt_marker = buffer_ref.pt_marker().as_marker_or_error();
-        let begv_marker = buffer_ref.begv_marker().as_marker_or_error();
-        let zv_marker = buffer_ref.zv_marker().as_marker_or_error();
+        let pt_marker: LispMarkerRef = buffer_ref.pt_marker().into();
+        let begv_marker: LispMarkerRef = buffer_ref.begv_marker().into();
+        let zv_marker: LispMarkerRef = buffer_ref.zv_marker().into();
 
         buffer_ref.set_pt_both(pt_marker.charpos_or_error(), pt_marker.bytepos_or_error());
         buffer_ref.set_begv_both(
@@ -1037,8 +1037,8 @@ pub fn overlay_get(overlay: LispOverlayRef, prop: LispObject) -> LispObject {
 // Mark OV as no longer associated with BUF.
 #[no_mangle]
 pub extern "C" fn drop_overlay(mut buf: LispBufferRef, ov: LispOverlayRef) {
-    let mut start = ov.start.as_marker_or_error();
-    let mut end = ov.end.as_marker_or_error();
+    let mut start: LispMarkerRef = ov.start.into();
+    let mut end: LispMarkerRef = ov.end.into();
     assert!(buf == marker_buffer(start).unwrap());
     unsafe {
         modify_overlay(
@@ -1054,7 +1054,7 @@ pub extern "C" fn drop_overlay(mut buf: LispBufferRef, ov: LispOverlayRef) {
 /// Delete the overlay OVERLAY from its buffer.
 #[lisp_fn]
 pub fn delete_overlay(overlay: LispOverlayRef) {
-    let mut buf_ref = match marker_buffer(overlay.start.as_marker_or_error()) {
+    let mut buf_ref = match marker_buffer(LispMarkerRef::from(overlay.start)) {
         Some(b) => b,
         None => return,
     };
@@ -1107,7 +1107,7 @@ pub fn erase_buffer() {
         // Prevent warnings, or suspension of auto saving, that would happen
         // if future size is less than past size.  Use of erase-buffer
         // implies that the future text is not really related to the past text.
-        cur_buf.save_length_ = LispObject::from(0);
+        cur_buf.save_length_ = 0.into();
     }
 }
 
@@ -1187,11 +1187,9 @@ pub unsafe extern "C" fn copy_overlays(
         .iter();
 
     let duplicate_marker = |marker_obj: LispObject| -> LispObject {
-        let mkr = marker_obj.as_marker_or_error();
+        let mkr: LispMarkerRef = marker_obj.into();
         let new_mkr = build_marker(buffer, mkr.charpos_or_error(), mkr.bytepos_or_error());
-        new_mkr
-            .as_marker_or_error()
-            .set_insertion_type(mkr.insertion_type());
+        LispMarkerRef::from(new_mkr).set_insertion_type(mkr.insertion_type());
         new_mkr
     };
 
diff --git a/rust_src/src/casefiddle.rs b/rust_src/src/casefiddle.rs
index f374f4cb82..2926dd59ad 100644
--- a/rust_src/src/casefiddle.rs
+++ b/rust_src/src/casefiddle.rs
@@ -32,13 +32,7 @@ fn casify_word(flag: case_action, words: EmacsInt) {
         n => n,
     };
 
-    let new_pos = unsafe {
-        casify_region(
-            flag,
-            LispObject::from(buffer_ref.pt),
-            LispObject::from(far_end),
-        )
-    };
+    let new_pos = unsafe { casify_region(flag, buffer_ref.pt.into(), far_end.into()) };
 
     unsafe { set_point(new_pos) };
 }
@@ -185,7 +179,7 @@ fn casefiddle_region(
     } else {
         let bounds = call!(
             symbol_value(intern("region-extract-function")),
-            LispObject::from(intern("bounds"))
+            intern("bounds").into()
         );
 
         for elt in bounds.iter_cars(LispConsEndChecks::off, LispConsCircularChecks::off) {
diff --git a/rust_src/src/character.rs b/rust_src/src/character.rs
index 0088749407..3509538038 100644
--- a/rust_src/src/character.rs
+++ b/rust_src/src/character.rs
@@ -63,7 +63,7 @@ pub unsafe fn dec_pos(pos_byte: ptrdiff_t) -> ptrdiff_t {
 /// Return the character of the maximum code.
 #[lisp_fn]
 pub fn max_char() -> LispObject {
-    LispObject::from(MAX_CHAR)
+    MAX_CHAR.into()
 }
 
 /// Return non-nil if OBJECT is a character.
@@ -89,7 +89,7 @@ pub fn unibyte_char_to_multibyte(ch: LispObject) -> LispObject {
     if c >= 0x100 {
         error!("Not a unibyte character: {}", c);
     }
-    LispObject::from(make_char_multibyte(c))
+    make_char_multibyte(c).into()
 }
 
 /// Convert the multibyte character CH to a byte.
@@ -102,7 +102,7 @@ pub fn multibyte_char_to_unibyte(ch: LispObject) -> LispObject {
         // a latin1 char, so let's let it slide.
         ch
     } else {
-        LispObject::from(raw_byte_from_codepoint_safe(c))
+        raw_byte_from_codepoint_safe(c).into()
     }
 }
 
diff --git a/rust_src/src/cmds.rs b/rust_src/src/cmds.rs
index 470ec47adf..563fb4c045 100644
--- a/rust_src/src/cmds.rs
+++ b/rust_src/src/cmds.rs
@@ -225,7 +225,7 @@ pub fn delete_char(n: EmacsInt, killflag: bool) {
     let buffer = ThreadState::current_buffer_unchecked();
     let pos = buffer.pt + n as isize;
     if killflag {
-        call!(Qkill_forward_chars, LispObject::from(n));
+        call!(Qkill_forward_chars, n.into());
     } else if n < 0 {
         if pos < buffer.begv {
             xsignal!(Qbeginning_of_buffer);
@@ -273,10 +273,7 @@ pub fn self_insert_command(n: EmacsInt) {
         };
         let val = internal_self_insert(character as Codepoint, n as usize);
         if val == 2 {
-            set(
-                Qundo_auto__this_command_amalgamating.as_symbol_or_error(),
-                Qnil,
-            );
+            set(Qundo_auto__this_command_amalgamating.into(), Qnil);
         }
         unsafe { frame_make_pointer_invisible(selected_frame().as_mut()) };
     }
@@ -346,7 +343,7 @@ fn internal_self_insert(mut c: Codepoint, n: usize) -> EmacsInt {
         if overwrite == Qoverwrite_mode_binary {
             chars_to_delete = n as usize;
         } else if c != '\n' as Codepoint && c2 != '\n' as Codepoint {
-            let cwidth = unsafe { Fchar_width(LispObject::from(c)) }.as_fixnum_or_error() as usize;
+            let cwidth = unsafe { Fchar_width(c.into()) }.as_fixnum_or_error() as usize;
             if cwidth > 0 {
                 let pos = current_buffer.pt;
                 let pos_byte = current_buffer.pt_byte;
@@ -362,7 +359,7 @@ fn internal_self_insert(mut c: Codepoint, n: usize) -> EmacsInt {
                     // if the TARGET_CLM is middle of multi-column
                     // character.  In that case, the new point is set after
                     // that character.
-                    let actual_clm = unsafe { Fmove_to_column(LispObject::from(target_clm), Qnil) }
+                    let actual_clm = unsafe { Fmove_to_column(target_clm.into(), Qnil) }
                         .as_fixnum_or_error() as usize;
                     chars_to_delete = (current_buffer.pt - pos) as usize;
                     if actual_clm > target_clm {
@@ -404,12 +401,7 @@ fn internal_self_insert(mut c: Codepoint, n: usize) -> EmacsInt {
         // return right away--don't really self-insert.  */
         if let Some(s) = sym.as_symbol() {
             if let Some(f) = s.get_function().as_symbol() {
-                let prop = unsafe {
-                    Fget(
-                        LispObject::from(f),
-                        LispObject::from(intern("no-self-insert")),
-                    )
-                };
+                let prop = unsafe { Fget(f.into(), intern("no-self-insert").into()) };
                 if prop.is_not_nil() {
                     return 1;
                 }
@@ -427,15 +419,10 @@ fn internal_self_insert(mut c: Codepoint, n: usize) -> EmacsInt {
         } else {
             c
         };
-        let mut string = unsafe { Fmake_string(LispObject::from(n), LispObject::from(mc), Qnil) };
+        let mut string = unsafe { Fmake_string(n.into(), mc.into(), Qnil) };
         if spaces_to_insert > 0 {
-            let tem = unsafe {
-                Fmake_string(
-                    LispObject::from(spaces_to_insert),
-                    LispObject::from(' ' as Codepoint),
-                    Qnil,
-                )
-            };
+            let tem =
+                unsafe { Fmake_string(spaces_to_insert.into(), (' ' as Codepoint).into(), Qnil) };
             string = unsafe { concat2(string, tem) };
         }
 
@@ -450,7 +437,7 @@ fn internal_self_insert(mut c: Codepoint, n: usize) -> EmacsInt {
                 false,
             )
         };
-        forward_char(LispObject::from(n));
+        forward_char(n.into());
     } else if n > 1 {
         let mut strn: Vec<libc::c_uchar> = match n.checked_mul(len) {
             Some(size_bytes) => Vec::with_capacity(size_bytes),
diff --git a/rust_src/src/crypto/mod.rs b/rust_src/src/crypto/mod.rs
index 3897fc8bbe..608917fc85 100755
--- a/rust_src/src/crypto/mod.rs
+++ b/rust_src/src/crypto/mod.rs
@@ -27,7 +27,7 @@ use crate::{
         Qbuffer_file_coding_system, Qcoding_system_error, Qmd5, Qnil, Qraw_text, Qsha1, Qsha224,
         Qsha256, Qsha384, Qsha512, Qstringp, Qwrite_region,
     },
-    symbols::{fboundp, symbol_name},
+    symbols::{fboundp, symbol_name, LispSymbolRef},
     threads::ThreadState,
 };
 
@@ -48,23 +48,18 @@ static SHA256_DIGEST_LEN: usize = 256 / 8;
 static SHA384_DIGEST_LEN: usize = 384 / 8;
 static SHA512_DIGEST_LEN: usize = 512 / 8;
 
-fn hash_alg(algorithm: LispObject) -> HashAlg {
-    algorithm.as_symbol_or_error();
-    if algorithm == Qmd5 {
-        HashAlg::MD5
-    } else if algorithm == Qsha1 {
-        HashAlg::SHA1
-    } else if algorithm == Qsha224 {
-        HashAlg::SHA224
-    } else if algorithm == Qsha256 {
-        HashAlg::SHA256
-    } else if algorithm == Qsha384 {
-        HashAlg::SHA384
-    } else if algorithm == Qsha512 {
-        HashAlg::SHA512
-    } else {
-        let name = symbol_name(algorithm.as_symbol_or_error()).as_string_or_error();
-        error!("Invalid algorithm arg: {:?}\0", &name.as_slice());
+fn hash_alg(algorithm: LispSymbolRef) -> HashAlg {
+    match LispObject::from(algorithm) {
+        Qmd5 => HashAlg::MD5,
+        Qsha1 => HashAlg::SHA1,
+        Qsha224 => HashAlg::SHA224,
+        Qsha256 => HashAlg::SHA256,
+        Qsha384 => HashAlg::SHA384,
+        Qsha512 => HashAlg::SHA512,
+        _ => {
+            let name = symbol_name(algorithm).as_string_or_error();
+            error!("Invalid algorithm arg: {:?}\0", &name.as_slice());
+        }
     }
 }
 
@@ -135,12 +130,12 @@ fn get_coding_system_for_buffer(
         return buffer.buffer_file_coding_system_;
     }
     let sscsf = unsafe { globals.Vselect_safe_coding_system_function };
-    if fboundp(sscsf.as_symbol_or_error()) {
+    if fboundp(sscsf.into()) {
         /* Confirm that VAL can surely encode the current region. */
         return call!(
             sscsf,
-            LispObject::from(start_byte),
-            LispObject::from(end_byte),
+            start_byte.into(),
+            end_byte.into(),
             coding_system,
             Qnil
         );
@@ -236,15 +231,15 @@ fn get_input(
             );
             *string = Some(
                 unsafe { code_convert_string(object, coding_system, Qnil, true, false, true) }
-                    .as_string_or_error(),
+                    .into(),
             )
         }
-        get_input_from_string(object, string.unwrap(), start, end).as_string_or_error()
+        get_input_from_string(object, string.unwrap(), start, end).into()
     } else if object.is_buffer() {
         let mut start_byte: ptrdiff_t = 0;
         let mut end_byte: ptrdiff_t = 0;
         let s = get_input_from_buffer(buffer.unwrap(), start, end, &mut start_byte, &mut end_byte);
-        let ss = s.as_string_or_error();
+        let ss: LispStringRef = s.into();
         if ss.is_multibyte() {
             let coding_system = check_coding_system_or_error(
                 get_coding_system_for_buffer(
@@ -258,8 +253,7 @@ fn get_input(
                 ),
                 noerror,
             );
-            unsafe { code_convert_string(s, coding_system, Qnil, true, false, false) }
-                .as_string_or_error()
+            unsafe { code_convert_string(s, coding_system, Qnil, true, false, false) }.into()
         } else {
             ss
         }
@@ -326,7 +320,7 @@ pub fn md5(
 /// If BINARY is non-nil, returns a string in binary form.
 #[lisp_fn(min = "2")]
 pub fn secure_hash(
-    algorithm: LispObject,
+    algorithm: LispSymbolRef,
     object: LispObject,
     start: LispObject,
     end: LispObject,
@@ -377,7 +371,7 @@ fn _secure_hash(
         digest_size as EmacsInt
     };
     let digest = unsafe { make_uninit_string(buffer_size as EmacsInt) };
-    let mut digest_str = digest.as_string_or_error();
+    let mut digest_str: LispStringRef = digest.into();
     hash_func(input_slice, digest_str.as_mut_slice());
     if binary.is_nil() {
         hexify_digest_string(digest_str.as_mut_slice(), digest_size);
diff --git a/rust_src/src/data.rs b/rust_src/src/data.rs
index 04afcb8a7a..0607a7b0e3 100644
--- a/rust_src/src/data.rs
+++ b/rust_src/src/data.rs
@@ -65,12 +65,12 @@ pub fn indirect_function(object: LispObject) -> LispObject {
         if !hare.is_symbol() || hare.is_nil() {
             return hare;
         }
-        hare = hare.as_symbol_or_error().get_function();
+        hare = LispSymbolRef::from(hare).get_function();
         if !hare.is_symbol() || hare.is_nil() {
             return hare;
         }
-        hare = hare.as_symbol_or_error().get_function();
-        tortoise = tortoise.as_symbol_or_error().get_function();
+        hare = LispSymbolRef::from(hare).get_function();
+        tortoise = LispSymbolRef::from(tortoise).get_function();
         if hare == tortoise {
             xsignal!(Qcyclic_function_indirection, object);
         }
@@ -161,9 +161,9 @@ pub fn type_of(object: LispObject) -> LispObject {
 #[lisp_fn]
 pub fn subr_lang(subr: LispSubrRef) -> LispObject {
     if subr.lang == Lisp_Subr_Lang::Lisp_Subr_Lang_C {
-        LispObject::from("C")
+        "C".into()
     } else if subr.lang == Lisp_Subr_Lang::Lisp_Subr_Lang_Rust {
-        LispObject::from("Rust")
+        "Rust".into()
     } else {
         unreachable!()
     }
@@ -327,7 +327,7 @@ pub fn subr_arity(subr: LispSubrRef) -> (EmacsInt, LispObject) {
     } else if subr.is_unevalled() {
         Qunevalled
     } else {
-        LispObject::from(EmacsInt::from(subr.max_args()))
+        EmacsInt::from(subr.max_args()).into()
     };
 
     (EmacsInt::from(minargs), maxargs)
@@ -673,7 +673,7 @@ pub fn bool_vector_subsetp(a: LispObject, b: LispObject) -> LispObject {
 pub fn set(symbol: LispSymbolRef, newval: LispObject) -> LispObject {
     unsafe {
         set_internal(
-            LispObject::from(symbol),
+            symbol.into(),
             newval,
             Qnil,
             Set_Internal_Bind::SET_INTERNAL_SET,
@@ -687,23 +687,16 @@ pub fn set(symbol: LispSymbolRef, newval: LispObject) -> LispObject {
 /// values for this variable.
 #[lisp_fn]
 pub fn set_default(symbol: LispSymbolRef, value: LispObject) -> LispObject {
-    unsafe {
-        set_default_internal(
-            LispObject::from(symbol),
-            value,
-            Set_Internal_Bind::SET_INTERNAL_SET,
-        )
-    };
+    unsafe { set_default_internal(symbol.into(), value, Set_Internal_Bind::SET_INTERNAL_SET) };
     value
 }
 
 extern "C" fn harmonize_variable_watchers(alias: LispObject, base_variable: LispObject) {
-    if !base_variable.eq(alias)
-        && base_variable.eq(alias.as_symbol_or_error().get_indirect_variable())
-    {
-        alias
-            .as_symbol_or_error()
-            .set_trapped_write(base_variable.as_symbol_or_error().get_trapped_write());
+    let alias_sym: LispSymbolRef = alias.into();
+    let base_variable_sym: LispSymbolRef = base_variable.into();
+
+    if !base_variable.eq(alias) && base_variable.eq(alias_sym.get_indirect_variable()) {
+        alias_sym.set_trapped_write(base_variable_sym.get_trapped_write());
     }
 }
 
diff --git a/rust_src/src/dired_unix.rs b/rust_src/src/dired_unix.rs
index 2db7343ec6..1b7d267535 100644
--- a/rust_src/src/dired_unix.rs
+++ b/rust_src/src/dired_unix.rs
@@ -208,10 +208,7 @@ fn fattrs_from_os(
     id_format: LispObject,
 ) {
     for f in fnames {
-        let fa = file_attributes_core(
-            LispObject::from(f.to_full(dname.to_owned()).as_str()),
-            id_format,
-        );
+        let fa = file_attributes_core(f.to_full(dname.to_owned()).as_str().into(), id_format);
         fattrs.push(fa);
     }
 }
@@ -610,9 +607,9 @@ impl FileAttrs {
             return unsafe {
                 file_attributes_c_internal(
                     name.as_ptr(),
-                    LispObject::from(dir.as_str()),
-                    LispObject::from(f.as_str()),
-                    LispObject::from(self.id_format.as_str()),
+                    dir.as_str().into(),
+                    f.as_str().into(),
+                    self.id_format.as_str().into(),
                 )
             };
         }
@@ -671,9 +668,8 @@ impl FileAttrs {
         attrs.push(LispObject::from_natnum(self.size));
 
         //  8. File modes, as a string of ten letters or dashes as in ls -l.
-        let fpath_lo = LispObject::from(self.fpath.as_str());
         //  Punt back to C until the filemode_string code is ported to Rust.
-        attrs.push(unsafe { filemode_string(fpath_lo) });
+        attrs.push(unsafe { filemode_string(self.fpath.as_str().into()) });
 
         //  9. An unspecified value, present only for backward compatibility.
         attrs.push(Qt);
@@ -715,9 +711,7 @@ pub extern "C" fn file_attributes_rust_internal(
     id_format: LispObject,
 ) -> LispObject {
     let fpath_s = dirname.to_stdstring() + "/" + &filename.to_stdstring();
-    let fpath = LispObject::from(fpath_s.as_str());
-
-    file_attributes_core(fpath, id_format)
+    file_attributes_core(fpath_s.as_str().into(), id_format)
 }
 
 fn file_attributes_core(fpath: LispObject, id_format: LispObject) -> LispObject {
diff --git a/rust_src/src/dispnew.rs b/rust_src/src/dispnew.rs
index a415aa9714..313a5cc771 100644
--- a/rust_src/src/dispnew.rs
+++ b/rust_src/src/dispnew.rs
@@ -75,7 +75,7 @@ pub extern "C" fn redraw_frame(mut frame: LispFrameRef) {
         // Mark all windows as inaccurate, so that every window will have
         // its redisplay done.
         mark_window_display_accurate(frame.root_window, false);
-        set_window_update_flags(frame.root_window.as_window_or_error(), true);
+        set_window_update_flags(frame.root_window.into(), true);
         frame.set_garbaged(false);
     }
 }
@@ -114,7 +114,7 @@ pub extern "C" fn set_window_update_flags(w: LispWindowRef, on_p: bool) {
         w = if next.is_nil() {
             None
         } else {
-            Some(next.as_window_or_error())
+            Some(next.into())
         };
     }
 }
diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index 5b187ed15c..5e61172fbe 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -382,7 +382,7 @@ pub fn char_before(pos: LispObject) -> Option<EmacsInt> {
 pub fn char_after(mut pos: LispObject) -> Option<EmacsInt> {
     let mut buffer_ref = ThreadState::current_buffer_unchecked();
     if pos.is_nil() {
-        pos = LispObject::from(point());
+        pos = point().into();
     }
     if let Some(m) = pos.as_marker() {
         let pos_byte = m.bytepos_or_error();
@@ -432,12 +432,7 @@ pub fn propertize(args: &[LispObject]) -> LispObject {
     }
 
     unsafe {
-        Fadd_text_properties(
-            LispObject::from(0),
-            LispObject::from(orig_string.len_chars()),
-            properties,
-            copy,
-        );
+        Fadd_text_properties(0.into(), orig_string.len_chars().into(), properties, copy);
     };
 
     copy
diff --git a/rust_src/src/eval.rs b/rust_src/src/eval.rs
index 326f884571..6ce07e4e09 100644
--- a/rust_src/src/eval.rs
+++ b/rust_src/src/eval.rs
@@ -195,7 +195,7 @@ pub fn setq(args: LispObject) -> LispObject {
         }
 
         if !lexical {
-            set(sym.as_symbol_or_error(), val); /* SYM is dynamically bound. */
+            set(sym.into(), val); /* SYM is dynamically bound. */
         }
     }
 
@@ -300,7 +300,7 @@ pub fn defconst(args: LispCons) -> LispSymbolRef {
     if unsafe { globals.Vpurify_flag } != Qnil {
         tem = unsafe { Fpurecopy(tem) };
     }
-    let sym_ref = sym.as_symbol_or_error();
+    let sym_ref: LispSymbolRef = sym.into();
     set_default(sym_ref, tem);
     sym_ref.set_declared_special(true);
     if docstring.is_not_nil() {
@@ -682,7 +682,7 @@ pub fn autoload(
         // and assumed the docstring will be provided by Snarf-documentation, so it
         // passed us 0 instead.  But that leads to accidental sharing in purecopy's
         // hash-consing, so we use a (hopefully) unique integer instead.
-        docstring = LispObject::from(unsafe { LispObject::from(function).to_fixnum_unchecked() });
+        docstring = unsafe { LispObject::from(function).to_fixnum_unchecked() }.into();
     }
 
     defalias(
@@ -752,7 +752,7 @@ pub unsafe extern "C" fn un_autoload(oldqueue: LispObject) {
         if first.eq(0) {
             globals.Vfeatures = second;
         } else {
-            fset(first.as_symbol_or_error(), second);
+            fset(first.into(), second);
         }
     }
 }
@@ -783,7 +783,7 @@ pub fn autoload_do_load(
         return fundef;
     }
 
-    let sym = funname.as_symbol_or_error();
+    let sym: LispSymbolRef = funname.into();
 
     unsafe {
         // This is to make sure that loadup.el gives a clear picture
diff --git a/rust_src/src/ffi.rs b/rust_src/src/ffi.rs
index 8fe387baf4..fb6e9e0c96 100644
--- a/rust_src/src/ffi.rs
+++ b/rust_src/src/ffi.rs
@@ -22,8 +22,7 @@ pub extern "C" fn arithcompare(
     obj2: LispObject,
     comparison: math::ArithComparison,
 ) -> LispObject {
-    let result = math::arithcompare(obj1, obj2, comparison);
-    LispObject::from(result)
+    math::arithcompare(obj1, obj2, comparison).into()
 }
 
 #[no_mangle]
diff --git a/rust_src/src/floatfns.rs b/rust_src/src/floatfns.rs
index a7c8164c52..293539e4f4 100644
--- a/rust_src/src/floatfns.rs
+++ b/rust_src/src/floatfns.rs
@@ -291,7 +291,7 @@ pub fn ldexp(significand: EmacsDouble, exponent: EmacsInt) -> EmacsDouble {
 pub fn expt(arg1: LispObject, arg2: LispObject) -> LispObject {
     if let (Some(x), Some(y)) = (arg1.as_fixnum(), arg2.as_fixnum()) {
         if y >= 0 && y <= EmacsInt::from(u32::max_value()) {
-            return LispObject::from(x.pow(y as u32));
+            return x.pow(y as u32).into();
         }
     }
     let b = arg1.any_to_float_or_error();
diff --git a/rust_src/src/fns.rs b/rust_src/src/fns.rs
index 6dbcb0b29e..1368fae0fe 100644
--- a/rust_src/src/fns.rs
+++ b/rust_src/src/fns.rs
@@ -12,6 +12,7 @@ use crate::{
     lisp::LispObject,
     lists::{assq, car, get, mapcar1, member, memq, put},
     lists::{LispCons, LispConsCircularChecks, LispConsEndChecks},
+    multibyte::LispStringRef,
     numbers::LispNumber,
     obarray::loadhist_attach,
     objects::equal,
@@ -135,7 +136,7 @@ unsafe extern "C" fn require_unwind(old_value: LispObject) {
 /// suppressed.
 #[lisp_fn(min = "1")]
 pub fn require(feature: LispObject, filename: LispObject, noerror: LispObject) -> LispObject {
-    let feature_sym = feature.as_symbol_or_error();
+    let feature_sym: LispSymbolRef = feature.into();
     let current_load_list = unsafe { globals.Vcurrent_load_list };
 
     // Record the presence of `require' in this file
@@ -295,8 +296,8 @@ pub extern "C" fn internal_equal_string(
     depth: i32,
     ht: LispObject,
 ) -> bool {
-    let s1 = o1.as_string_or_error();
-    let s2 = o2.as_string_or_error();
+    let s1: LispStringRef = o1.into();
+    let s2: LispStringRef = o2.into();
 
     s1.equal(s2, kind, depth, ht)
 }
diff --git a/rust_src/src/fonts.rs b/rust_src/src/fonts.rs
index 2d2ecf345e..2eed06b1c1 100644
--- a/rust_src/src/fonts.rs
+++ b/rust_src/src/fonts.rs
@@ -136,7 +136,7 @@ pub fn font_match_p(spec: LispObject, font: LispObject) -> bool {
 /// Optional 2nd argument FRAME, if non-nil, specifies the target frame.
 #[lisp_fn(min = "1")]
 pub fn find_font(spec: LispObject, frame: LispObject) -> LispObject {
-    let val = unsafe { Flist_fonts(spec, frame, LispObject::from(1), Qnil) };
+    let val = unsafe { Flist_fonts(spec, frame, 1.into(), Qnil) };
     match val.into() {
         Some((a, _)) => a,
         None => val,
diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index a30d992c30..0885033dc1 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -64,11 +64,6 @@ impl LispObject {
         self.into()
     }
 
-    // Same as CHECK_FRAME
-    pub fn as_frame_or_error(self) -> LispFrameRef {
-        self.into()
-    }
-
     pub fn as_live_frame(self) -> Option<LispFrameRef> {
         self.as_frame()
             .and_then(|f| if f.is_live() { Some(f) } else { None })
@@ -85,7 +80,7 @@ macro_rules! for_each_frame {
     ($name:ident => $action:block) => {
         let frame_it = unsafe { Vframe_list.iter_cars(LispConsEndChecks::off,
                                                       LispConsCircularChecks::off) };
-        for $name in frame_it.map(|f| f.as_frame_or_error())
+        for $name in frame_it.map(LispFrameRef::from)
             $action
     };
 }
@@ -99,7 +94,7 @@ pub enum LispFrameOrSelected {
 impl From<LispObject> for LispFrameOrSelected {
     fn from(obj: LispObject) -> Self {
         obj.map_or(LispFrameOrSelected::Selected, |o| {
-            LispFrameOrSelected::Frame(o.as_frame_or_error())
+            LispFrameOrSelected::Frame(o.into())
         })
     }
 }
@@ -114,7 +109,7 @@ impl From<LispFrameOrSelected> for LispFrameRef {
     fn from(frame: LispFrameOrSelected) -> Self {
         match frame {
             LispFrameOrSelected::Frame(f) => f,
-            LispFrameOrSelected::Selected => unsafe { current_frame }.as_frame_or_error(),
+            LispFrameOrSelected::Selected => unsafe { current_frame }.into(),
         }
     }
 }
@@ -137,7 +132,7 @@ pub fn window_frame_live_or_selected(object: LispObject) -> LispFrameRef {
         selected_frame()
     } else if let Some(win) = object.as_valid_window() {
         // the window's frame does not need a live check
-        win.frame.as_frame_or_error()
+        win.frame.into()
     } else {
         object.as_live_frame_or_error()
     }
@@ -166,7 +161,7 @@ pub fn window_frame_live_or_selected_with_action<W: FnMut(LispWindowRef) -> ()>(
 /// Return the frame that is now selected.
 #[lisp_fn]
 pub fn selected_frame() -> LispFrameRef {
-    unsafe { current_frame }.as_frame_or_error()
+    unsafe { current_frame }.into()
 }
 
 /// Return non-nil if OBJECT is a frame.
@@ -209,7 +204,7 @@ fn framep_1(frame: LispFrameRef) -> LispObject {
 #[lisp_fn(min = "0")]
 pub fn frame_selected_window(frame_or_window: LispObject) -> LispWindowRef {
     let frame = window_frame_live_or_selected(frame_or_window);
-    frame.selected_window.as_window_or_error()
+    frame.selected_window.into()
 }
 
 /// Set selected window of FRAME to WINDOW.
@@ -231,10 +226,10 @@ pub fn set_frame_selected_window(
         error!("In `set-frame-selected-window', WINDOW is not on FRAME")
     }
     if frame_ref == selected_frame() {
-        select_window_lisp(window, norecord).as_window_or_error()
+        select_window_lisp(window, norecord).into()
     } else {
         frame_ref.selected_window = window;
-        window.as_window_or_error()
+        window.into()
     }
 }
 
@@ -484,7 +479,7 @@ pub fn previous_frame(frame: LispFrameOrSelected, miniframe: LispObject) -> Lisp
     for_each_frame!(f => {
         if frame_ref == f && !prev.is_nil() {
             // frames match and there is a previous frame, return it.
-            return prev.as_frame_or_error();
+            return prev.into();
         }
         let tmp = unsafe { candidate_frame(f.into(), frame_obj, miniframe) };
         if !tmp.is_nil() {
@@ -502,7 +497,7 @@ pub fn previous_frame(frame: LispFrameOrSelected, miniframe: LispObject) -> Lisp
         // There were no acceptable frames in the list before FRAME; otherwise,
         // we would have returned directly from the loop.  Since PREV is the last
         // acceptable frame in the list, return it.
-        prev.as_frame_or_error()
+        prev.into()
     }
 }
 
diff --git a/rust_src/src/hashtable.rs b/rust_src/src/hashtable.rs
index 0f170b7486..56fa7d9726 100644
--- a/rust_src/src/hashtable.rs
+++ b/rust_src/src/hashtable.rs
@@ -128,7 +128,7 @@ impl LispHashTableRef {
     }
 
     pub fn check_impure(self, object: LispHashTableRef) {
-        unsafe { CHECK_IMPURE(LispObject::from(object), self.as_ptr() as *mut c_void) };
+        unsafe { CHECK_IMPURE(object.into(), self.as_ptr() as *mut c_void) };
     }
 }
 
diff --git a/rust_src/src/keyboard.rs b/rust_src/src/keyboard.rs
index 9eab09c418..096e2d2a4a 100644
--- a/rust_src/src/keyboard.rs
+++ b/rust_src/src/keyboard.rs
@@ -96,7 +96,7 @@ pub fn posn_at_x_y(
         y = w.frame_pixel_y(y);
     });
 
-    unsafe { make_lispy_position(frame.as_mut(), LispObject::from(x), LispObject::from(y), 0) }
+    unsafe { make_lispy_position(frame.as_mut(), x.into(), y.into(), 0) }
 }
 
 /// Return true if EVENT is a list whose elements are all integers or symbols.
diff --git a/rust_src/src/keymap.rs b/rust_src/src/keymap.rs
index 5c082a25af..9f38a48522 100644
--- a/rust_src/src/keymap.rs
+++ b/rust_src/src/keymap.rs
@@ -314,11 +314,7 @@ pub unsafe extern "C" fn map_keymap(
 #[lisp_fn(name = "map-keymap", c_name = "map_keymap", min = "2")]
 pub fn map_keymap_lisp(function: LispObject, keymap: LispObject, sort_first: bool) -> LispObject {
     if sort_first {
-        return call!(
-            LispObject::from(intern("map-keymap-sorted")),
-            function,
-            keymap
-        );
+        return call!(intern("map-keymap-sorted").into(), function, keymap);
     }
     unsafe {
         map_keymap(
@@ -369,8 +365,7 @@ pub unsafe extern "C" fn map_keymap_internal(
             } else if binding.is_vector() {
                 if let Some(binding_vec) = binding.as_vectorlike() {
                     for c in 0..binding_vec.pseudovector_size() {
-                        let character = LispObject::from(c);
-                        map_keymap_item(fun, args, character, aref(binding, c), data);
+                        map_keymap_item(fun, args, c.into(), aref(binding, c), data);
                     }
                 }
             } else if binding.is_char_table() {
@@ -503,7 +498,7 @@ pub fn lookup_key(keymap: LispObject, key: LispObject, accept_default: LispObjec
             if let Some(x) = c.as_fixnum() {
                 let x = x as u32;
                 if x & 0x80 != 0 && !k.is_multibyte() {
-                    c = LispObject::from((x | char_bits::CHAR_META) & !0x80);
+                    c = ((x | char_bits::CHAR_META) & !0x80).into();
                 }
             }
         }
@@ -521,7 +516,7 @@ pub fn lookup_key(keymap: LispObject, key: LispObject, accept_default: LispObjec
 
         keymap = get_keymap(cmd, false, true);
         if !keymap.is_cons() {
-            return LispObject::from(idx);
+            return idx.into();
         }
 
         unsafe {
@@ -549,7 +544,7 @@ pub fn define_prefix_command(
     let map = make_sparse_keymap(name);
     fset(command, map);
     if mapvar.is_not_nil() {
-        set(mapvar.as_symbol_or_error(), map);
+        set(mapvar.into(), map);
     } else {
         set(command, map);
     }
@@ -591,7 +586,7 @@ pub extern "C" fn describe_vector_princ(elt: LispObject, fun: LispObject) {
 #[lisp_fn(min = "1", name = "describe-vector", c_name = "describe_vector")]
 pub fn describe_vector_lisp(vector: LispObject, mut describer: LispObject) {
     if describer.is_nil() {
-        describer = LispObject::from(intern("princ"));
+        describer = intern("princ").into();
     }
     unsafe { specbind(Qstandard_output, current_buffer()) };
     if !(vector.is_vector() || vector.is_char_table()) {
diff --git a/rust_src/src/lisp.rs b/rust_src/src/lisp.rs
index 21a93ed4c1..cf345e6821 100644
--- a/rust_src/src/lisp.rs
+++ b/rust_src/src/lisp.rs
@@ -82,7 +82,7 @@ where
     fn from(v: Option<T>) -> Self {
         match v {
             None => Qnil,
-            Some(v) => LispObject::from(v),
+            Some(v) => v.into(),
         }
     }
 }
@@ -551,7 +551,7 @@ impl LispObject {
     where
         LispObject: From<T>,
     {
-        self == LispObject::from(other)
+        self == other.into()
     }
 
     pub fn eql<T>(self, other: T) -> bool
diff --git a/rust_src/src/lread.rs b/rust_src/src/lread.rs
index ae3d373cc8..dca2e55a28 100644
--- a/rust_src/src/lread.rs
+++ b/rust_src/src/lread.rs
@@ -22,6 +22,7 @@ use crate::{
     },
     remacs_sys::{globals, EmacsInt},
     remacs_sys::{Qeval_buffer_list, Qnil, Qread_char, Qstandard_output, Qsymbolp},
+    symbols::LispSymbolRef,
     threads::{c_specpdl_index, ThreadState},
 };
 
@@ -36,8 +37,8 @@ pub unsafe extern "C" fn defvar_int(
 ) {
     (*i_fwd).ty = Lisp_Fwd_Int;
     (*i_fwd).intvar = address;
-    let sym = intern_c_string_1(namestring, libc::strlen(namestring) as libc::ptrdiff_t)
-        .as_symbol_or_error();
+    let sym: LispSymbolRef =
+        intern_c_string_1(namestring, libc::strlen(namestring) as libc::ptrdiff_t).into();
     sym.set_declared_special(true);
     sym.set_redirect(symbol_redirect::SYMBOL_FORWARDED);
     sym.set_fwd(i_fwd as *mut Lisp_Fwd);
@@ -53,8 +54,8 @@ pub unsafe extern "C" fn defvar_bool(
 ) {
     (*b_fwd).ty = Lisp_Fwd_Bool;
     (*b_fwd).boolvar = address;
-    let sym = intern_c_string_1(namestring, libc::strlen(namestring) as libc::ptrdiff_t)
-        .as_symbol_or_error();
+    let sym: LispSymbolRef =
+        intern_c_string_1(namestring, libc::strlen(namestring) as libc::ptrdiff_t).into();
     sym.set_declared_special(true);
     sym.set_redirect(symbol_redirect::SYMBOL_FORWARDED);
     sym.set_fwd(b_fwd as *mut Lisp_Fwd);
@@ -73,8 +74,8 @@ pub unsafe extern "C" fn defvar_lisp_nopro(
 ) {
     (*o_fwd).ty = Lisp_Fwd_Obj;
     (*o_fwd).objvar = address;
-    let sym = intern_c_string_1(namestring, libc::strlen(namestring) as libc::ptrdiff_t)
-        .as_symbol_or_error();
+    let sym: LispSymbolRef =
+        intern_c_string_1(namestring, libc::strlen(namestring) as libc::ptrdiff_t).into();
     sym.set_declared_special(true);
     sym.set_redirect(symbol_redirect::SYMBOL_FORWARDED);
     sym.set_fwd(o_fwd as *mut Lisp_Fwd);
@@ -112,8 +113,8 @@ pub unsafe fn defvar_kboard_offset(
 ) {
     (*ko_fwd).ty = Lisp_Fwd_Kboard_Obj;
     (*ko_fwd).offset = offset;
-    let sym = intern_c_string_1(namestring, libc::strlen(namestring) as libc::ptrdiff_t)
-        .as_symbol_or_error();
+    let sym: LispSymbolRef =
+        intern_c_string_1(namestring, libc::strlen(namestring) as libc::ptrdiff_t).into();
     sym.set_declared_special(true);
     sym.set_redirect(symbol_redirect::SYMBOL_FORWARDED);
     sym.set_fwd(ko_fwd as *mut Lisp_Fwd);
@@ -138,13 +139,13 @@ pub unsafe fn defvar_per_buffer_offset(
     (*bo_fwd).ty = Lisp_Fwd_Buffer_Obj;
     (*bo_fwd).offset = offset;
     (*bo_fwd).predicate = predicate;
-    let sym = intern_c_string_1(namestring, libc::strlen(namestring) as libc::ptrdiff_t)
-        .as_symbol_or_error();
+    let sym: LispSymbolRef =
+        intern_c_string_1(namestring, libc::strlen(namestring) as libc::ptrdiff_t).into();
     sym.set_declared_special(true);
     sym.set_redirect(symbol_redirect::SYMBOL_FORWARDED);
     sym.set_fwd(bo_fwd as *mut Lisp_Fwd);
     let local = offset.apply_mut(&mut remacs_sys::buffer_local_symbols);
-    *local = LispObject::from(sym);
+    *local = sym.into();
     let flags = offset.apply(&remacs_sys::buffer_local_flags);
     if flags.is_nil() {
         panic!(
@@ -183,7 +184,7 @@ pub fn read(stream: LispObject) -> LispObject {
 
     if input.is_t() || input.eq(Qread_char) {
         let cs = CString::new("Lisp expression: ").unwrap();
-        call!(LispObject::from(intern("read-minibuffer")), unsafe {
+        call!(intern("read-minibuffer").into(), unsafe {
             build_string(cs.as_ptr())
         })
     } else {
diff --git a/rust_src/src/marker.rs b/rust_src/src/marker.rs
index 50c04e0648..dda85647a8 100644
--- a/rust_src/src/marker.rs
+++ b/rust_src/src/marker.rs
@@ -128,10 +128,6 @@ impl LispObject {
     pub fn as_marker(self) -> Option<LispMarkerRef> {
         self.into()
     }
-
-    pub fn as_marker_or_error(self) -> LispMarkerRef {
-        self.into()
-    }
 }
 
 impl LispMiscRef {
@@ -198,7 +194,7 @@ pub extern "C" fn build_marker(
     debug_assert!(charpos <= bytepos);
 
     let obj = unsafe { allocate_misc(Lisp_Misc_Type::Lisp_Misc_Marker) };
-    let mut m = obj.as_marker_or_error();
+    let mut m: LispMarkerRef = obj.into();
 
     m.set_buffer(buf);
     m.set_charpos(charpos);
@@ -244,7 +240,7 @@ pub fn point_max_marker() -> LispObject {
 /// Set PT from MARKER's clipped position.
 #[no_mangle]
 pub extern "C" fn set_point_from_marker(marker: LispObject) {
-    let marker = marker.as_marker_or_error();
+    let marker: LispMarkerRef = marker.into();
     let mut cur_buf = ThreadState::current_buffer_unchecked();
     let charpos = clip_to_bounds(
         cur_buf.begv,
@@ -438,7 +434,7 @@ pub extern "C" fn set_marker_both(
     charpos: ptrdiff_t,
     bytepos: ptrdiff_t,
 ) -> LispObject {
-    let mut m = marker.as_marker_or_error();
+    let mut m: LispMarkerRef = marker.into();
     if let Some(mut b) = buffer
         .as_live_buffer()
         .or_else(|| current_buffer().as_live_buffer())
@@ -458,7 +454,7 @@ pub extern "C" fn set_marker_restricted_both(
     charpos: ptrdiff_t,
     bytepos: ptrdiff_t,
 ) -> LispObject {
-    let mut m = marker.as_marker_or_error();
+    let mut m: LispMarkerRef = marker.into();
 
     if let Some(mut b) = buffer
         .as_live_buffer()
@@ -480,14 +476,14 @@ pub extern "C" fn set_marker_restricted_both(
 /// Return the char position of marker MARKER, as a C integer.
 #[no_mangle]
 pub extern "C" fn marker_position(marker: LispObject) -> ptrdiff_t {
-    let m = marker.as_marker_or_error();
+    let m: LispMarkerRef = marker.into();
     m.charpos_or_error()
 }
 
 /// Return the byte position of marker MARKER, as a C integer.
 #[no_mangle]
 pub extern "C" fn marker_byte_position(marker: LispObject) -> ptrdiff_t {
-    let m = marker.as_marker_or_error();
+    let m: LispMarkerRef = marker.into();
     m.bytepos_or_error()
 }
 
@@ -516,7 +512,7 @@ fn set_marker_internal(
     // Optimize the special case where we are copying the position of
     // an existing marker, and MARKER is already in the same buffer.
     } else if position.as_marker().map_or(false, |p| p.buffer() == buf) && marker.buffer() == buf {
-        let pos = position.as_marker_or_error();
+        let pos: LispMarkerRef = position.into();
         marker.charpos = pos.charpos_or_error();
         marker.bytepos = pos.bytepos_or_error();
     } else {
diff --git a/rust_src/src/math.rs b/rust_src/src/math.rs
index 8ab9c46856..2219fbaf75 100644
--- a/rust_src/src/math.rs
+++ b/rust_src/src/math.rs
@@ -29,17 +29,15 @@ pub fn lisp_mod(x: LispNumber, y: LispNumber) -> LispObject {
                 i1 += i2;
             }
 
-            LispObject::from(i1)
+            i1.into()
         }
         (LispNumber::Fixnum(i1), LispNumber::Float(f2)) => {
-            LispObject::from(floatfns::fmod_float(i1 as f64, f2))
+            floatfns::fmod_float(i1 as f64, f2).into()
         }
         (LispNumber::Float(f1), LispNumber::Fixnum(i2)) => {
-            LispObject::from(floatfns::fmod_float(f1, i2 as f64))
-        }
-        (LispNumber::Float(f1), LispNumber::Float(f2)) => {
-            LispObject::from(floatfns::fmod_float(f1, f2))
+            floatfns::fmod_float(f1, i2 as f64).into()
         }
+        (LispNumber::Float(f1), LispNumber::Float(f2)) => floatfns::fmod_float(f1, f2).into(),
     }
 }
 
@@ -82,12 +80,7 @@ fn arith_driver(code: ArithOp, args: &[LispObject]) -> LispObject {
 
         match val.as_number_coerce_marker_or_error() {
             LispNumber::Float(_) => {
-                return LispObject::from(floatfns::float_arith_driver(
-                    ok_accum as f64,
-                    ok_args,
-                    code,
-                    args,
-                ));
+                return floatfns::float_arith_driver(ok_accum as f64, ok_args, code, args).into();
             }
             LispNumber::Fixnum(next) => {
                 match code {
diff --git a/rust_src/src/minibuf.rs b/rust_src/src/minibuf.rs
index 63d246bf16..9f664f7a0a 100644
--- a/rust_src/src/minibuf.rs
+++ b/rust_src/src/minibuf.rs
@@ -10,6 +10,7 @@ use crate::{
     lisp::defsubr,
     lisp::LispObject,
     lists::{car_safe, cdr_safe, memq},
+    multibyte::LispStringRef,
     obarray::{intern, lisp_intern},
     remacs_sys::{
         globals, Qcommandp, Qcustom_variable_p, Qfield, Qminibuffer_completion_table,
@@ -165,7 +166,7 @@ pub fn minibuffer_contents_no_properties() -> LispObject {
 /// and some related functions, which use zero-indexing for POSITION.
 #[lisp_fn(min = "1")]
 pub fn read_from_minibuffer(
-    prompt: LispObject,
+    prompt: LispStringRef,
     initial_contents: LispObject,
     mut keymap: LispObject,
     read: LispObject,
@@ -173,7 +174,6 @@ pub fn read_from_minibuffer(
     default_value: LispObject,
     inherit_input_method: LispObject,
 ) -> LispObject {
-    prompt.as_string_or_error();
     keymap = if keymap.is_nil() {
         unsafe { globals.Vminibuffer_local_map }
     } else {
@@ -197,7 +197,7 @@ pub fn read_from_minibuffer(
         read_minibuf(
             keymap,
             initial_contents,
-            prompt,
+            prompt.into(),
             read.is_not_nil(),
             histvar,
             histpos,
@@ -309,7 +309,7 @@ pub fn completing_read(
 ///  the current input method and the setting of `enable-multibyte-characters'.
 #[lisp_fn(min = "1")]
 pub fn read_string(
-    prompt: LispObject,
+    prompt: LispStringRef,
     initial_input: LispObject,
     history: LispObject,
     default_value: LispObject,
@@ -406,16 +406,15 @@ pub fn read_variable(prompt: LispObject, default_value: LispObject) -> LispObjec
 /// the current input method and the setting of`enable-multibyte-characters'.
 #[lisp_fn(min = "1")]
 pub fn read_no_blanks_input(
-    prompt: LispObject,
+    prompt: LispStringRef,
     initial: LispObject,
     inherit_input_method: LispObject,
 ) -> LispObject {
-    prompt.as_string_or_error();
     unsafe {
         read_minibuf(
             globals.Vminibuffer_local_ns_map,
             initial,
-            prompt,
+            prompt.into(),
             false,
             Qminibuffer_history,
             LispObject::from_fixnum(0),
diff --git a/rust_src/src/multibyte.rs b/rust_src/src/multibyte.rs
index 550b7849e7..e7dfedf271 100644
--- a/rust_src/src/multibyte.rs
+++ b/rust_src/src/multibyte.rs
@@ -89,9 +89,7 @@ impl LispStringRef {
     /// considered; the validity of the following bytes is not checked.  Tabs in
     /// STRING are always taken to occupy `tab-width' columns.
     pub fn width(self) -> usize {
-        unsafe {
-            lisp_string_width(LispObject::from(self), -1, ptr::null_mut(), ptr::null_mut()) as usize
-        }
+        unsafe { lisp_string_width(self.into(), -1, ptr::null_mut(), ptr::null_mut()) as usize }
     }
 
     pub fn is_multibyte(self) -> bool {
diff --git a/rust_src/src/numbers.rs b/rust_src/src/numbers.rs
index 34b2fc15f0..af01f17d89 100644
--- a/rust_src/src/numbers.rs
+++ b/rust_src/src/numbers.rs
@@ -295,7 +295,7 @@ pub fn random(limit: LispObject) -> LispObject {
             let val: EmacsInt = rng.gen();
             let remainder = val.abs() % limit;
             if val - remainder <= INTMASK - limit + 1 {
-                return LispObject::from(remainder);
+                return remainder.into();
             }
         }
     } else {
diff --git a/rust_src/src/obarray.rs b/rust_src/src/obarray.rs
index 3c9eeadd5f..31f24c26db 100644
--- a/rust_src/src/obarray.rs
+++ b/rust_src/src/obarray.rs
@@ -47,10 +47,9 @@ impl LispObarrayRef {
     /// symbol would be if it were present.
     pub fn lookup(&self, name: LispObject) -> LispObject {
         let string = name.symbol_or_string_as_string();
-        let obj = LispObject::from(self);
         unsafe {
             oblookup(
-                obj,
+                self.into(),
                 string.const_sdata_ptr(),
                 string.len_chars(),
                 string.len_bytes(),
@@ -65,15 +64,14 @@ impl LispObarrayRef {
     pub fn intern(&self, string: LispStringRef) -> LispObject {
         let string = string.into();
         let tem = self.lookup(string);
-        let obj = LispObject::from(self);
         if tem.is_symbol() {
             tem
         } else if unsafe { globals.Vpurify_flag }.is_not_nil() {
             // When Emacs is running lisp code to dump to an executable, make
             // use of pure storage.
-            intern_driver(unsafe { Fpurecopy(string) }, obj, tem)
+            intern_driver(unsafe { Fpurecopy(string) }, self.into(), tem)
         } else {
-            intern_driver(string, obj, tem)
+            intern_driver(string, self.into(), tem)
         }
     }
 }
@@ -97,12 +95,13 @@ impl From<LispObject> for Option<LispObarrayRef> {
 /// Intern (e.g. create a symbol from) a string.
 pub fn intern<T: AsRef<str>>(string: T) -> LispSymbolRef {
     let s = string.as_ref();
-    LispSymbolRef::from(unsafe {
+    unsafe {
         intern_1(
             s.as_ptr() as *const libc::c_char,
             s.len() as libc::ptrdiff_t,
         )
-    })
+    }
+    .into()
 }
 
 #[no_mangle]
diff --git a/rust_src/src/process.rs b/rust_src/src/process.rs
index 8f80a27e9f..6ce9c43bbe 100644
--- a/rust_src/src/process.rs
+++ b/rust_src/src/process.rs
@@ -33,8 +33,8 @@ impl LispProcessRef {
         self.plist = plist;
     }
 
-    fn set_buffer(&mut self, buffer: LispObject) {
-        self.buffer = buffer;
+    fn set_buffer(&mut self, buffer: Option<LispBufferRef>) {
+        self.buffer = buffer.into();
     }
 
     fn set_childp(&mut self, childp: LispObject) {
@@ -239,10 +239,9 @@ pub fn process_plist(process: LispProcessRef) -> LispObject {
 
 /// Replace the plist of PROCESS with PLIST.  Return PLIST.
 #[lisp_fn]
-pub fn set_process_plist(process: LispObject, plist: LispObject) -> LispObject {
+pub fn set_process_plist(mut process: LispProcessRef, plist: LispObject) -> LispObject {
     if plist.is_list() {
-        let mut p = process.as_process_or_error();
-        p.set_plist(plist);
+        process.set_plist(plist);
         plist
     } else {
         wrong_type!(Qlistp, plist)
@@ -321,23 +320,22 @@ pub fn process_type(process: LispObject) -> LispObject {
 /// Set buffer associated with PROCESS to BUFFER (a buffer, or nil).
 /// Return BUFFER.
 #[lisp_fn]
-pub fn set_process_buffer(process: LispObject, buffer: LispObject) -> LispObject {
-    let mut p_ref = process.as_process_or_error();
-    if buffer.is_not_nil() {
-        buffer.as_buffer_or_error();
-    }
-    p_ref.set_buffer(buffer);
-    let process_type = p_ref.ptype();
+pub fn set_process_buffer(
+    mut process: LispProcessRef,
+    buffer: Option<LispBufferRef>,
+) -> LispObject {
+    process.set_buffer(buffer);
+    let process_type = process.ptype();
     let netconn1_p = process_type.eq(Qnetwork);
     let serialconn1_p = process_type.eq(Qserial);
     let pipeconn1_p = process_type.eq(Qpipe);
 
     if netconn1_p || serialconn1_p || pipeconn1_p {
-        let childp = p_ref.childp;
-        p_ref.set_childp(plist_put(childp, QCbuffer, buffer));
+        let childp = process.childp;
+        process.set_childp(plist_put(childp, QCbuffer, buffer.into()));
     }
-    unsafe { setup_process_coding_systems(process) };
-    buffer
+    unsafe { setup_process_coding_systems(process.into()) };
+    buffer.into()
 }
 
 /// Give PROCESS the filter function FILTER; nil means default.
@@ -352,9 +350,7 @@ pub fn set_process_buffer(process: LispObject, buffer: LispObject) -> LispObject
 /// - if the process's input coding system is no-conversion or raw-text,
 ///   it is a unibyte string (the non-converted input).
 #[lisp_fn]
-pub fn set_process_filter(process: LispObject, mut filter: LispObject) -> LispObject {
-    let mut p_ref = process.as_process_or_error();
-
+pub fn set_process_filter(mut process: LispProcessRef, mut filter: LispObject) -> LispObject {
     // Don't signal an error if the process's input file descriptor
     // is closed.  This could make debugging Lisp more difficult,
     // for example when doing something like
@@ -362,19 +358,19 @@ pub fn set_process_filter(process: LispObject, mut filter: LispObject) -> LispOb
     // (setq process (start-process ...))
     // (debug)
     // (set-process-filter process ...)
-    filter = pset_filter(p_ref, filter);
-    set_process_filter_masks(p_ref);
+    filter = pset_filter(process, filter);
+    set_process_filter_masks(process);
 
-    let process_type = p_ref.ptype();
+    let process_type = process.ptype();
     let netconn1_p = process_type.eq(Qnetwork);
     let serialconn1_p = process_type.eq(Qserial);
     let pipeconn1_p = process_type.eq(Qpipe);
 
     if netconn1_p || serialconn1_p || pipeconn1_p {
-        let childp = p_ref.childp;
-        p_ref.set_childp(plist_put(childp, QCfilter, filter));
+        let childp = process.childp;
+        process.set_childp(plist_put(childp, QCfilter, filter));
     }
-    unsafe { setup_process_coding_systems(process) };
+    unsafe { setup_process_coding_systems(process.into()) };
     filter
 }
 
diff --git a/rust_src/src/symbols.rs b/rust_src/src/symbols.rs
index 0715775dfc..805b6cbc2f 100644
--- a/rust_src/src/symbols.rs
+++ b/rust_src/src/symbols.rs
@@ -194,17 +194,13 @@ impl LispObject {
         self.into()
     }
 
-    pub fn as_symbol_or_error(self) -> LispSymbolRef {
-        self.into()
-    }
-
     pub fn symbol_or_string_as_string(self) -> LispStringRef {
         match self.as_symbol() {
             Some(sym) => sym
                 .symbol_name()
                 .as_string()
                 .expect("Expected a symbol name?"),
-            None => self.as_string_or_error(),
+            None => self.into(),
         }
     }
 
@@ -333,7 +329,7 @@ pub fn setplist(mut symbol: LispSymbolRef, newplist: LispObject) -> LispObject {
 /// Return SYMBOL.
 #[lisp_fn]
 pub fn fmakunbound(symbol: LispObject) -> LispSymbolRef {
-    let mut sym = symbol.as_symbol_or_error();
+    let mut sym: LispSymbolRef = symbol.into();
     if symbol.is_nil() || symbol.is_t() {
         setting_constant!(symbol);
     }
@@ -350,7 +346,7 @@ pub fn fmakunbound(symbol: LispObject) -> LispSymbolRef {
 #[lisp_fn]
 pub fn keywordp(object: LispObject) -> bool {
     if let Some(sym) = object.as_symbol() {
-        let name = sym.symbol_name().as_string_or_error();
+        let name: LispStringRef = sym.symbol_name().into();
         name.byte_at(0) == b':' && sym.is_interned_in_initial_obarray()
     } else {
         false
diff --git a/rust_src/src/textprop.rs b/rust_src/src/textprop.rs
index c85a1c72be..810895354a 100644
--- a/rust_src/src/textprop.rs
+++ b/rust_src/src/textprop.rs
@@ -20,9 +20,7 @@ use crate::{
 /// overlays are considered only if they are associated with OBJECT.
 #[lisp_fn(min = "2")]
 pub fn get_char_property(position: EmacsInt, prop: LispObject, object: LispObject) -> LispObject {
-    unsafe {
-        get_char_property_and_overlay(LispObject::from(position), prop, object, ptr::null_mut())
-    }
+    unsafe { get_char_property_and_overlay(position.into(), prop, object, ptr::null_mut()) }
 }
 
 include!(concat!(env!("OUT_DIR"), "/textprop_exports.rs"));
diff --git a/rust_src/src/time.rs b/rust_src/src/time.rs
index cc954646bf..5e3d910cee 100644
--- a/rust_src/src/time.rs
+++ b/rust_src/src/time.rs
@@ -13,7 +13,6 @@ use remacs_macros::lisp_fn;
 use crate::{
     lisp::defsubr,
     lisp::LispObject,
-    lists::list,
     numbers::MOST_NEGATIVE_FIXNUM,
     remacs_sys::{lisp_time, EmacsDouble, EmacsInt},
 };
@@ -148,12 +147,7 @@ pub extern "C" fn make_lisp_time(t: c_timespec) -> LispObject {
 fn make_lisp_time_1(t: c_timespec) -> LispObject {
     let s = t.tv_sec;
     let ns = t.tv_nsec;
-    list(&[
-        LispObject::from(hi_time(s)),
-        LispObject::from(lo_time(s)),
-        LispObject::from(ns / 1_000),
-        LispObject::from(ns % 1_000 * 1_000),
-    ])
+    list!(hi_time(s), lo_time(s), ns / 1_000, ns % 1_000 * 1_000)
 }
 
 /// Decode a Lisp list `SPECIFIED_TIME` that represents a time.
diff --git a/rust_src/src/window_configuration.rs b/rust_src/src/window_configuration.rs
index 145c4c4602..1a8715a84e 100644
--- a/rust_src/src/window_configuration.rs
+++ b/rust_src/src/window_configuration.rs
@@ -127,7 +127,7 @@ pub fn window_configuration_frame(config: SaveWindowDataRef) -> LispFrameRef {
     let saved_windows = config.saved_windows.as_vector().unwrap();
     let obj = saved_windows.get(0);
     let saved = SavedWindowRef::new(obj.as_vector().unwrap().as_mut() as *mut saved_window);
-    saved.window.as_window_or_error().frame.as_frame_or_error()
+    saved.window.as_window_or_error().frame.into()
 }
 
 // Return true if window configurations CONFIGURATION1 and CONFIGURATION2
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 36294e47bc..59f52989b1 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -50,6 +50,10 @@ impl LispWindowRef {
         self.contents.is_not_nil()
     }
 
+    pub fn get_frame(self) -> LispFrameRef {
+        self.frame.into()
+    }
+
     /// Return the current height of the mode line of window W. If not known
     /// from W->mode_line_height, look at W's current glyph matrix, or return
     /// a default based on the height of the font of the face `mode-line'.
@@ -64,7 +68,7 @@ impl LispWindowRef {
             self.mode_line_height = matrix_mode_line_height;
             matrix_mode_line_height
         } else {
-            let mut frame = self.frame.as_frame_or_error();
+            let mut frame = self.get_frame();
             let window = selected_window().as_window_or_error();
             let mode_line_height = unsafe {
                 estimate_mode_line_height(frame.as_mut(), CURRENT_MODE_LINE_FACE_ID(window))
@@ -101,7 +105,7 @@ impl LispWindowRef {
         if !(round == qfloor || round == qceiling) {
             self.total_cols
         } else {
-            let frame = self.frame.as_frame_or_error();
+            let frame = self.get_frame();
             let unit = frame.column_width;
 
             if round == qceiling {
@@ -119,7 +123,7 @@ impl LispWindowRef {
         if !(round == qfloor || round == qceiling) {
             self.total_lines
         } else {
-            let frame = self.frame.as_frame_or_error();
+            let frame = self.get_frame();
             let unit = frame.line_height;
 
             if round == qceiling {
@@ -134,14 +138,14 @@ impl LispWindowRef {
     /// window starts. This does not include a left-hand scroll bar
     /// if any.
     pub fn left_edge_x(self) -> i32 {
-        self.frame.as_frame_or_error().internal_border_width() + self.left_pixel_edge()
+        self.get_frame().internal_border_width() + self.left_pixel_edge()
     }
 
     /// The frame y-position at which the window starts.
     pub fn top_edge_y(self) -> i32 {
         let mut y = self.top_pixel_edge();
         if !(self.is_menu_bar() || self.is_tool_bar()) {
-            y += self.frame.as_frame_or_error().internal_border_width();
+            y += self.get_frame().internal_border_width();
         }
         y
     }
@@ -183,7 +187,7 @@ impl LispWindowRef {
                     .as_buffer_or_error()
                     .mode_line_format_
                     .is_not_nil())
-            && self.pixel_height > self.frame.as_frame_or_error().line_height
+            && self.pixel_height > self.get_frame().line_height
     }
 
     /// True if window wants a header line and is high enough to
@@ -198,7 +202,7 @@ impl LispWindowRef {
     pub fn wants_header_line(self) -> bool {
         let window_header_line_format = self.get_parameter(Qheader_line_format);
 
-        let mut height = self.frame.as_frame_or_error().line_height;
+        let mut height = self.get_frame().line_height;
         if self.wants_mode_line() {
             height *= 2;
         }
@@ -479,7 +483,7 @@ pub fn window_margins(window: LispWindowLiveOrSelected) -> (LispObject, LispObje
         if margin == 0 {
             Qnil
         } else {
-            LispObject::from(margin)
+            margin.into()
         }
     }
     let win: LispWindowRef = window.into();
@@ -1105,7 +1109,7 @@ pub extern "C" fn wset_update_mode_line(mut w: LispWindowRef) {
     // If this window is the selected window on its frame, set the
     // global variable update_mode_lines, so that x_consider_frame_title
     // will consider this frame's title for redisplay.
-    let fselected_window = w.frame.as_frame_or_error().selected_window;
+    let fselected_window = w.get_frame().selected_window;
 
     if let Some(win) = fselected_window.as_window() {
         if win == w {
-- 
2.21.0


From f9ea93309dce7e61db1a3413602d1d42d1eb61ad Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Carlos=20Mart=C3=ADn=20Nieto?= <cmn@dwim.me>
Date: Sun, 23 Dec 2018 17:54:26 +0000
Subject: [PATCH 201/297] Port insert, insert-before-markers,
 insert-and-inherit, insert-and-inherit-before-markers

---
 rust_src/src/editfns.rs    | 102 ++++++++++++++++++++++++++++++++++++-
 rust_src/src/remacs_sys.rs |  14 +++++
 src/editfns.c              |  89 --------------------------------
 3 files changed, 114 insertions(+), 91 deletions(-)

diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index 5e61172fbe..07c770d799 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -30,8 +30,10 @@ use crate::{
     remacs_sys::EmacsInt,
     remacs_sys::{
         buffer_overflow, build_string, current_message, del_range, del_range_1, downcase,
-        find_before_next_newline, find_newline, get_char_property_and_overlay, globals, insert,
-        insert_and_inherit, insert_from_buffer, make_buffer_string, make_buffer_string_both,
+        find_before_next_newline, find_newline, general_insert_function,
+        get_char_property_and_overlay, globals, insert, insert_and_inherit, insert_before_markers,
+        insert_before_markers_and_inherit, insert_from_buffer, insert_from_string,
+        insert_from_string_before_markers, make_buffer_string, make_buffer_string_both,
         make_save_obj_obj_obj_obj, make_string_from_bytes, maybe_quit, message1, message3,
         record_unwind_current_buffer, record_unwind_protect, save_excursion_restore,
         save_restriction_restore, save_restriction_save, scan_newline_from_point,
@@ -1447,4 +1449,100 @@ pub fn widen() {
     invalidate_current_column();
 }
 
+/// Insert the arguments, either strings or characters, at point.
+/// Point and after-insertion markers move forward to end up after the inserted text.
+/// Any other markers at the point of insertion remain before the text.
+///
+/// If the current buffer is multibyte, unibyte strings are converted to multibyte for insertion
+/// (see `string-make-multibyte').  If the current buffer is unibyte, multibyte strings are
+/// converted to unibyte for insertion (see `string-make-unibyte').
+///
+/// When operating on binary data, it may be necessary to preserve the original bytes of a unibyte
+/// string when inserting it into a multibyte buffer; to accomplish this, apply
+/// `string-as-multibyte' to the string and insert the result.
+///
+/// usage: (insert &rest ARGS)
+#[lisp_fn(name = "insert", c_name = "insert")]
+pub fn insert_lisp(args: &[LispObject]) {
+    unsafe {
+        general_insert_function(
+            insert,
+            insert_from_string,
+            false,
+            args.len() as isize,
+            args.as_ptr(),
+        )
+    };
+}
+
+/// Insert the arguments at point, inheriting properties from adjoining text.  Point and
+/// after-insertion markers move forward to end up after the inserted text.  Any other markers at
+/// the point of insertion remain before the text.
+///
+/// If the current buffer is multibyte, unibyte strings are converted to multibyte for insertion
+/// (see `unibyte-char-to-multibyte').  If the current buffer is unibyte, multibyte strings are
+/// converted to unibyte for insertion.
+///
+/// usage: (insert-and-inherit &rest ARGS)
+#[lisp_fn(name = "insert-and-inherit", c_name = "insert_and_inherit")]
+pub fn insert_and_inherit_lisp(args: &[LispObject]) {
+    unsafe {
+        general_insert_function(
+            insert_and_inherit,
+            insert_from_string,
+            true,
+            args.len() as isize,
+            args.as_ptr(),
+        )
+    };
+}
+
+/// Insert strings or characters at point, relocating markers after the text.  Point and markers
+/// move forward to end up after the inserted text.
+///
+/// If the current buffer is multibyte, unibyte strings are converted to multibyte for insertion
+/// (see `unibyte-char-to-multibyte').  If the current buffer is unibyte, multibyte strings are
+/// converted to unibyte for insertion.
+///
+/// If an overlay begins at the insertion point, the inserted text falls outside the overlay; if a
+/// nonempty overlay ends at the insertion point, the inserted text falls inside that overlay.
+///
+/// usage: (insert-before-markers &rest ARGS)
+#[lisp_fn(name = "insert-before-markers", c_name = "insert_before_markers")]
+pub fn insert_before_markers_lisp(args: &[LispObject]) {
+    unsafe {
+        general_insert_function(
+            insert_before_markers,
+            insert_from_string_before_markers,
+            false,
+            args.len() as isize,
+            args.as_ptr(),
+        )
+    };
+}
+
+/// Insert text at point, relocating markers and inheriting properties.  Point and markers move
+/// forward to end up after the inserted text.
+///
+/// If the current buffer is multibyte, unibyte strings are converted to multibyte for insertion
+/// (see `unibyte-char-to-multibyte').  If the current buffer is unibyte, multibyte strings are
+/// converted to unibyte for insertion.
+///
+/// usage: (insert-before-markers-and-inherit &rest ARGS)
+#[lisp_fn(
+    name = "insert-before-markers-and-inherit",
+    c_name = "insert_and_inherit_before_markers"
+)]
+pub fn insert_and_inherit_before_markers_lisp(args: &[LispObject]) {
+    unsafe {
+        general_insert_function(
+            insert_before_markers_and_inherit,
+            insert_from_string_before_markers,
+            true,
+            args.len() as isize,
+            args.as_ptr(),
+        )
+    };
+}
+
 include!(concat!(env!("OUT_DIR"), "/editfns_exports.rs"));
diff --git a/rust_src/src/remacs_sys.rs b/rust_src/src/remacs_sys.rs
index a04afeeac1..8008be0eb2 100755
--- a/rust_src/src/remacs_sys.rs
+++ b/rust_src/src/remacs_sys.rs
@@ -127,6 +127,20 @@ extern "C" {
         dest: Lisp_Object,
         op: BoolVectorOp,
     ) -> Lisp_Object;
+    pub fn general_insert_function(
+        insert_func: unsafe extern "C" fn(*const c_char, ptrdiff_t),
+        insert_from_string_func: unsafe extern "C" fn(
+            LispObject,
+            ptrdiff_t,
+            ptrdiff_t,
+            ptrdiff_t,
+            ptrdiff_t,
+            bool,
+        ),
+        inherit: bool,
+        nargs: ptrdiff_t,
+        args: *const LispObject,
+    );
 }
 
 // Max value for the first argument of wait_reading_process_output.
diff --git a/src/editfns.c b/src/editfns.c
index 041af87acd..e8b19aa319 100644
--- a/src/editfns.c
+++ b/src/editfns.c
@@ -1343,90 +1343,6 @@ insert1 (Lisp_Object arg)
   Finsert (1, &arg);
 }
 
-
-DEFUN ("insert", Finsert, Sinsert, 0, MANY, 0,
-       doc: /* Insert the arguments, either strings or characters, at point.
-Point and after-insertion markers move forward to end up
- after the inserted text.
-Any other markers at the point of insertion remain before the text.
-
-If the current buffer is multibyte, unibyte strings are converted
-to multibyte for insertion (see `string-make-multibyte').
-If the current buffer is unibyte, multibyte strings are converted
-to unibyte for insertion (see `string-make-unibyte').
-
-When operating on binary data, it may be necessary to preserve the
-original bytes of a unibyte string when inserting it into a multibyte
-buffer; to accomplish this, apply `string-as-multibyte' to the string
-and insert the result.
-
-usage: (insert &rest ARGS)  */)
-  (ptrdiff_t nargs, Lisp_Object *args)
-{
-  general_insert_function (insert, insert_from_string, 0, nargs, args);
-  return Qnil;
-}
-
-DEFUN ("insert-and-inherit", Finsert_and_inherit, Sinsert_and_inherit,
-   0, MANY, 0,
-       doc: /* Insert the arguments at point, inheriting properties from adjoining text.
-Point and after-insertion markers move forward to end up
- after the inserted text.
-Any other markers at the point of insertion remain before the text.
-
-If the current buffer is multibyte, unibyte strings are converted
-to multibyte for insertion (see `unibyte-char-to-multibyte').
-If the current buffer is unibyte, multibyte strings are converted
-to unibyte for insertion.
-
-usage: (insert-and-inherit &rest ARGS)  */)
-  (ptrdiff_t nargs, Lisp_Object *args)
-{
-  general_insert_function (insert_and_inherit, insert_from_string, 1,
-			   nargs, args);
-  return Qnil;
-}
-
-DEFUN ("insert-before-markers", Finsert_before_markers, Sinsert_before_markers, 0, MANY, 0,
-       doc: /* Insert strings or characters at point, relocating markers after the text.
-Point and markers move forward to end up after the inserted text.
-
-If the current buffer is multibyte, unibyte strings are converted
-to multibyte for insertion (see `unibyte-char-to-multibyte').
-If the current buffer is unibyte, multibyte strings are converted
-to unibyte for insertion.
-
-If an overlay begins at the insertion point, the inserted text falls
-outside the overlay; if a nonempty overlay ends at the insertion
-point, the inserted text falls inside that overlay.
-
-usage: (insert-before-markers &rest ARGS)  */)
-  (ptrdiff_t nargs, Lisp_Object *args)
-{
-  general_insert_function (insert_before_markers,
-			   insert_from_string_before_markers, 0,
-			   nargs, args);
-  return Qnil;
-}
-
-DEFUN ("insert-before-markers-and-inherit", Finsert_and_inherit_before_markers,
-  Sinsert_and_inherit_before_markers, 0, MANY, 0,
-       doc: /* Insert text at point, relocating markers and inheriting properties.
-Point and markers move forward to end up after the inserted text.
-
-If the current buffer is multibyte, unibyte strings are converted
-to multibyte for insertion (see `unibyte-char-to-multibyte').
-If the current buffer is unibyte, multibyte strings are converted
-to unibyte for insertion.
-
-usage: (insert-before-markers-and-inherit &rest ARGS)  */)
-  (ptrdiff_t nargs, Lisp_Object *args)
-{
-  general_insert_function (insert_before_markers_and_inherit,
-			   insert_from_string_before_markers, 1,
-			   nargs, args);
-  return Qnil;
-}
 
 /* Making strings from buffer contents.  */
 
@@ -3757,11 +3673,6 @@ functions if all the text being accessed has this property.  */);
   /* A special value for Qfield properties.  */
   DEFSYM (Qboundary, "boundary");
 
-  defsubr (&Sinsert);
-  defsubr (&Sinsert_before_markers);
-  defsubr (&Sinsert_and_inherit);
-  defsubr (&Sinsert_and_inherit_before_markers);
-
   defsubr (&Suser_login_name);
   defsubr (&Suser_real_login_name);
   defsubr (&Suser_full_name);
-- 
2.21.0


From 8f223efd0f7f8f0d5738ff98a9bf031b9434edea Mon Sep 17 00:00:00 2001
From: Nick Drozd <nicholasdrozd@gmail.com>
Date: Thu, 10 Jan 2019 18:35:55 -0600
Subject: [PATCH 202/297] Add Rust wrappers around unported C file-handling
 functions

This allows for using more precise types.
---
 rust_src/src/buffers.rs    | 15 +++++-----
 rust_src/src/callproc.rs   | 25 +++++++++++------
 rust_src/src/coding.rs     |  7 +++++
 rust_src/src/dired.rs      |  7 +++--
 rust_src/src/dired_unix.rs | 42 ++++++++++++++++------------
 rust_src/src/fileio.rs     | 56 ++++++++++++++++++++------------------
 6 files changed, 89 insertions(+), 63 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 87da2a5967..544bfc44b1 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -15,6 +15,7 @@ use crate::{
     data::Lisp_Fwd,
     editfns::point,
     eval::unbind_to,
+    fileio::{expand_file_name, find_file_name_handler},
     frames::LispFrameRef,
     lisp::defsubr,
     lisp::{ExternalPtr, LispMiscRef, LispObject, LiveBufferIter},
@@ -35,8 +36,7 @@ use crate::{
         Lisp_Misc_Type, Lisp_Overlay, Lisp_Type, Vbuffer_alist,
     },
     remacs_sys::{
-        windows_or_buffers_changed, Fcopy_sequence, Fexpand_file_name, Ffind_file_name_handler,
-        Fget_text_property, Fnconc, Fnreverse, Fwiden,
+        windows_or_buffers_changed, Fcopy_sequence, Fget_text_property, Fnconc, Fnreverse, Fwiden,
     },
     remacs_sys::{
         Qafter_string, Qbefore_string, Qbuffer_read_only, Qbufferp, Qget_file_buffer,
@@ -945,21 +945,20 @@ pub extern "C" fn fetch_buffer_markers(buffer: *mut Lisp_Buffer) {
 /// If there is no such live buffer, return nil.
 /// See also `find-buffer-visiting'.
 #[lisp_fn]
-pub fn get_file_buffer(filename: LispObject) -> Option<LispBufferRef> {
-    verify_lisp_type!(filename, Qstringp);
-    let filename = unsafe { Fexpand_file_name(filename, Qnil) };
+pub fn get_file_buffer(filename: LispStringRef) -> Option<LispBufferRef> {
+    let filename = expand_file_name(filename, None);
 
     // If the file name has special constructs in it,
     // call the corresponding file handler.
-    let handler = unsafe { Ffind_file_name_handler(filename, Qget_file_buffer) };
+    let handler = find_file_name_handler(filename, Qget_file_buffer);
 
     if handler.is_not_nil() {
-        let handled_buf = call!(handler, Qget_file_buffer, filename);
+        let handled_buf = call!(handler, Qget_file_buffer, filename.into());
         handled_buf.as_buffer()
     } else {
         LiveBufferIter::new().find(|buf| {
             let buf_filename = buf.filename();
-            buf_filename.is_string() && string_equal(buf_filename, filename)
+            buf_filename.is_string() && string_equal(buf_filename, filename.into())
         })
     }
 }
diff --git a/rust_src/src/callproc.rs b/rust_src/src/callproc.rs
index f759ea6a29..4a1c268f68 100644
--- a/rust_src/src/callproc.rs
+++ b/rust_src/src/callproc.rs
@@ -1,14 +1,15 @@
 //! Synchronous subprocess invocation for GNU Emacs.
 
 use crate::{
+    coding::encode_file_name,
     eval::unbind_to,
+    fileio::expand_file_name,
     lisp::{defsubr, LispObject},
     remacs_macros::lisp_fn,
-    remacs_sys::Fexpand_file_name,
     remacs_sys::NULL_DEVICE,
     remacs_sys::{
-        build_string, call_process, close_file_unwind, emacs_open, encode_file_name,
-        record_unwind_protect_int, report_file_error,
+        build_string, call_process, close_file_unwind, emacs_open, record_unwind_protect_int,
+        report_file_error,
     },
     threads::{c_specpdl_index, ThreadState},
 };
@@ -48,23 +49,31 @@ pub fn call_process_lisp(args: &mut [LispObject]) -> LispObject {
     let count = c_specpdl_index();
 
     let infile = if args.len() >= 2 && args[1].is_not_nil() {
-        unsafe { Fexpand_file_name(args[1], ThreadState::current_buffer_unchecked().directory_) }
+        expand_file_name(
+            args[1].into(),
+            ThreadState::current_buffer_unchecked().directory_.into(),
+        )
     } else {
-        unsafe { build_string(NULL_DEVICE.as_ptr() as *const i8) }
+        unsafe { build_string(NULL_DEVICE.as_ptr() as *const i8) }.into()
     };
 
-    let encoded_file = unsafe { encode_file_name(infile) };
+    let encoded_file = encode_file_name(infile);
 
     let filefd = unsafe {
         emacs_open(
-            encoded_file.as_string_or_error().const_data_ptr() as *const i8,
+            encoded_file.const_data_ptr() as *const i8,
             libc::O_RDONLY,
             0,
         )
     };
 
     if filefd < 0 {
-        unsafe { report_file_error("Opening process input file".as_ptr() as *const i8, infile) };
+        unsafe {
+            report_file_error(
+                "Opening process input file".as_ptr() as *const i8,
+                infile.into(),
+            )
+        };
     }
 
     unsafe { record_unwind_protect_int(Some(close_file_unwind), filefd) };
diff --git a/rust_src/src/coding.rs b/rust_src/src/coding.rs
index 1493a68bc4..b64542c38a 100644
--- a/rust_src/src/coding.rs
+++ b/rust_src/src/coding.rs
@@ -12,6 +12,8 @@ use crate::{
     lisp::defsubr,
     lisp::LispObject,
     lists::{get, put},
+    multibyte::LispStringRef,
+    remacs_sys::encode_file_name as c_encode_file_name,
     remacs_sys::{
         safe_eval, Fget, Qcoding_system_define_form, Qcoding_system_error, Qcoding_system_p, Qnil,
         Qno_conversion, Vcoding_system_hash_table,
@@ -92,4 +94,9 @@ pub fn coding_system_aliases(coding_system: LispObject) -> LispObject {
     aref(spec, 1)
 }
 
+/// Wrapper for encode_file_name (NOT PORTED)
+pub fn encode_file_name(fname: LispStringRef) -> LispStringRef {
+    unsafe { c_encode_file_name(fname.into()) }.into()
+}
+
 include!(concat!(env!("OUT_DIR"), "/coding_exports.rs"));
diff --git a/rust_src/src/dired.rs b/rust_src/src/dired.rs
index 8844369e04..4d4513d368 100644
--- a/rust_src/src/dired.rs
+++ b/rust_src/src/dired.rs
@@ -12,6 +12,7 @@ use dired_windows::{file_attributes_intro, get_users};
 use crate::{
     lisp::{defsubr, LispObject},
     lists::car,
+    multibyte::LispStringRef,
     strings::string_lessp,
 };
 
@@ -25,7 +26,7 @@ use crate::{
 ///  NOSORT is useful if you plan to sort the result yourself.
 #[lisp_fn(min = "1")]
 pub fn directory_files(
-    directory: LispObject,
+    directory: LispStringRef,
     full: LispObject,
     match_re: LispObject,
     nosort: LispObject,
@@ -46,7 +47,7 @@ pub fn directory_files(
 /// which see.
 #[lisp_fn(min = "1")]
 pub fn directory_files_and_attributes(
-    directory: LispObject,
+    directory: LispStringRef,
     full: LispObject,
     match_re: LispObject,
     nosort: LispObject,
@@ -105,7 +106,7 @@ pub fn directory_files_and_attributes(
 /// On some FAT-based filesystems, only the date of last access is recorded,
 /// so last access time will always be midnight of that day.
 #[lisp_fn(min = "1")]
-pub fn file_attributes(filename: LispObject, id_format: LispObject) -> LispObject {
+pub fn file_attributes(filename: LispStringRef, id_format: LispObject) -> LispObject {
     file_attributes_intro(filename, id_format)
 }
 
diff --git a/rust_src/src/dired_unix.rs b/rust_src/src/dired_unix.rs
index 1b7d267535..6e3bc85a2f 100644
--- a/rust_src/src/dired_unix.rs
+++ b/rust_src/src/dired_unix.rs
@@ -12,13 +12,14 @@ use std::ptr::null_mut;
 use std::slice;
 
 use crate::{
+    fileio::{expand_file_name, find_file_name_handler},
     lisp::LispObject,
     lists::list,
+    multibyte::LispStringRef,
     remacs_sys::{
         build_string, compile_pattern, decode_file_name, file_attributes_c_internal,
         filemode_string, globals, re_pattern_buffer, re_search,
     },
-    remacs_sys::{Fexpand_file_name, Ffind_file_name_handler},
     remacs_sys::{
         Qdirectory_files, Qdirectory_files_and_attributes, Qfile_attributes, Qfile_missing, Qnil,
         Qt,
@@ -316,20 +317,27 @@ fn directory_files_core(dr: &DirReq, dd: &mut DirData) -> LispObject {
 }
 
 pub fn directory_files_intro(
-    directory: LispObject,
+    directory: LispStringRef,
     full: LispObject,
     match_re: LispObject,
     nosort: LispObject,
 ) -> LispObject {
-    let dnexp = unsafe { Fexpand_file_name(directory, Qnil) };
+    let dnexp = expand_file_name(directory, None);
 
-    let handler = unsafe { Ffind_file_name_handler(dnexp, Qdirectory_files) };
+    let handler = find_file_name_handler(dnexp, Qdirectory_files);
     if handler.is_not_nil() {
-        return call!(handler, Qdirectory_files, dnexp, full, match_re, nosort);
+        return call!(
+            handler,
+            Qdirectory_files,
+            dnexp.into(),
+            full,
+            match_re,
+            nosort
+        );
     }
 
     let dr = DirReq::new(
-        dnexp.to_stdstring(),
+        LispObject::from(dnexp).to_stdstring(),
         if full.is_nil() {
             FullPath::No
         } else {
@@ -353,20 +361,20 @@ pub fn directory_files_intro(
 }
 
 pub fn directory_files_and_attributes_intro(
-    directory: LispObject,
+    directory: LispStringRef,
     full: LispObject,
     match_re: LispObject,
     nosort: LispObject,
     id_format: LispObject,
 ) -> LispObject {
-    let dnexp = unsafe { Fexpand_file_name(directory, Qnil) };
+    let dnexp = expand_file_name(directory, None);
 
-    let handler = unsafe { Ffind_file_name_handler(dnexp, Qdirectory_files_and_attributes) };
+    let handler = find_file_name_handler(dnexp, Qdirectory_files_and_attributes);
     if handler.is_not_nil() {
         return call!(
             handler,
             Qdirectory_files_and_attributes,
-            dnexp,
+            dnexp.into(),
             full,
             match_re,
             nosort,
@@ -375,7 +383,7 @@ pub fn directory_files_and_attributes_intro(
     }
 
     let dr = DirReq::new(
-        dnexp.to_stdstring(),
+        LispObject::from(dnexp).to_stdstring(),
         if full.is_nil() {
             FullPath::No
         } else {
@@ -689,18 +697,18 @@ impl FileAttrs {
     }
 }
 
-pub fn file_attributes_intro(filename: LispObject, id_format: LispObject) -> LispObject {
-    let fnexp = unsafe { Fexpand_file_name(filename, Qnil) };
-    let handler = unsafe { Ffind_file_name_handler(fnexp, Qfile_attributes) };
+pub fn file_attributes_intro(filename: LispStringRef, id_format: LispObject) -> LispObject {
+    let fnexp = expand_file_name(filename, None);
+    let handler = find_file_name_handler(fnexp, Qfile_attributes);
     if handler.is_not_nil() {
         if id_format.is_not_nil() {
-            return call!(handler, Qfile_attributes, fnexp, id_format);
+            return call!(handler, Qfile_attributes, fnexp.into(), id_format);
         } else {
-            return call!(handler, Qfile_attributes, fnexp);
+            return call!(handler, Qfile_attributes, fnexp.into());
         }
     }
 
-    file_attributes_core(fnexp, id_format)
+    file_attributes_core(fnexp.into(), id_format)
 }
 
 // Used by directory-files-and-attributes
diff --git a/rust_src/src/fileio.rs b/rust_src/src/fileio.rs
index 44cf06d7c7..0d752ba837 100644
--- a/rust_src/src/fileio.rs
+++ b/rust_src/src/fileio.rs
@@ -6,16 +6,17 @@ use std::path;
 use remacs_macros::lisp_fn;
 
 use crate::{
+    coding::encode_file_name,
     lisp::defsubr,
+    lisp::LispObject,
     lists::LispCons,
     math::{arithcompare, ArithComparison},
     multibyte::LispStringRef,
     remacs_sys::{
-        check_executable, check_existing, encode_file_name, file_name_absolute_p,
-        file_name_case_insensitive_p,
+        check_executable, check_existing, file_name_absolute_p, file_name_case_insensitive_p,
     },
     remacs_sys::{Fexpand_file_name, Ffind_file_name_handler},
-    remacs_sys::{Qfile_executable_p, Qfile_exists_p, Qfile_name_case_insensitive_p, Qnil},
+    remacs_sys::{Qfile_executable_p, Qfile_exists_p, Qfile_name_case_insensitive_p},
     threads::ThreadState,
 };
 
@@ -64,20 +65,16 @@ pub fn recent_auto_save_p() -> bool {
     c_name = "file_name_case_insensitive_p"
 )]
 pub fn file_name_case_insensitive_p_lisp(filename: LispStringRef) -> bool {
-    let absname = unsafe { Fexpand_file_name(filename.into(), Qnil) };
+    let absname = expand_file_name(filename, None);
 
     // If the file name has special constructs in it,
     // call the corresponding file handler.
-    let handler = unsafe { Ffind_file_name_handler(absname, Qfile_name_case_insensitive_p) };
+    let handler = find_file_name_handler(absname, Qfile_name_case_insensitive_p);
     if handler.is_not_nil() {
-        call!(handler, Qfile_name_case_insensitive_p, absname).into()
+        call!(handler, Qfile_name_case_insensitive_p, absname.into()).into()
     } else {
         unsafe {
-            file_name_case_insensitive_p(
-                encode_file_name(absname)
-                    .as_string_or_error()
-                    .const_data_ptr() as *const i8,
-            )
+            file_name_case_insensitive_p(encode_file_name(absname).const_data_ptr() as *const i8)
         }
     }
 }
@@ -95,24 +92,18 @@ pub fn file_name_absolute_p_lisp(filename: LispStringRef) -> bool {
 /// Use `file-symlink-p' to test for such links.
 #[lisp_fn]
 pub fn file_exists_p(filename: LispStringRef) -> bool {
-    let absname = unsafe { Fexpand_file_name(filename.into(), Qnil) };
+    let absname = expand_file_name(filename, None);
 
     // If the file name has special constructs in it,
     // call the corresponding file handler.
-    let handler = unsafe { Ffind_file_name_handler(absname, Qfile_exists_p) };
+    let handler = find_file_name_handler(absname, Qfile_exists_p);
 
     if handler.is_not_nil() {
-        let result = call!(handler, Qfile_exists_p, absname);
+        let result = call!(handler, Qfile_exists_p, absname.into());
         set_errno(Errno(0));
         result.into()
     } else {
-        unsafe {
-            check_existing(
-                encode_file_name(absname)
-                    .as_string_or_error()
-                    .const_data_ptr() as *const i8,
-            )
-        }
+        unsafe { check_existing(encode_file_name(absname).const_data_ptr() as *const i8) }
     }
 }
 
@@ -121,19 +112,30 @@ pub fn file_exists_p(filename: LispStringRef) -> bool {
 /// (It is generally better to use `file-accessible-directory-p' for that purpose, though.)
 #[lisp_fn]
 pub fn file_executable_p(filename: LispStringRef) -> bool {
-    let absname = unsafe { Fexpand_file_name(filename.into(), Qnil) };
+    let absname = expand_file_name(filename, None);
 
     // If the file name has special constructs in it,
     // call the corresponding file handler.
-    let handler = unsafe { Ffind_file_name_handler(absname, Qfile_executable_p) };
+    let handler = find_file_name_handler(absname, Qfile_executable_p);
 
     if handler.is_not_nil() {
-        call!(handler, Qfile_executable_p, absname).into()
+        call!(handler, Qfile_executable_p, absname.into()).into()
     } else {
-        unsafe {
-            check_executable(encode_file_name(absname).as_string_or_error().data_ptr() as *mut i8)
-        }
+        unsafe { check_executable(encode_file_name(absname).data_ptr() as *mut i8) }
     }
 }
 
+/// Wrapper for Fexpand_file_name (NOT PORTED)
+pub fn expand_file_name(
+    name: LispStringRef,
+    default_directory: Option<LispStringRef>,
+) -> LispStringRef {
+    unsafe { Fexpand_file_name(name.into(), default_directory.into()) }.into()
+}
+
+/// Wrapper for Ffind_file_name_handler (NOT PORTED)
+pub fn find_file_name_handler(filename: LispStringRef, operation: LispObject) -> LispObject {
+    unsafe { Ffind_file_name_handler(filename.into(), operation) }
+}
+
 include!(concat!(env!("OUT_DIR"), "/fileio_exports.rs"));
-- 
2.21.0


From b00ce5ccc9a5c8d1776e8ff75537924e58f9dc86 Mon Sep 17 00:00:00 2001
From: Nick Drozd <nicholasdrozd@gmail.com>
Date: Thu, 10 Jan 2019 18:36:54 -0600
Subject: [PATCH 203/297] Use ported functions

These functions have already been ported, so we might as well use them.
---
 rust_src/src/buffers.rs |  7 +++----
 rust_src/src/cmds.rs    |  5 +++--
 rust_src/src/coding.rs  |  4 ++--
 rust_src/src/data.rs    | 17 +++++++++--------
 rust_src/src/eval.rs    |  8 ++++----
 5 files changed, 21 insertions(+), 20 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 544bfc44b1..f7cd47e33e 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -13,7 +13,7 @@ use crate::{
     character::char_head_p,
     chartable::LispCharTableRef,
     data::Lisp_Fwd,
-    editfns::point,
+    editfns::{point, widen},
     eval::unbind_to,
     fileio::{expand_file_name, find_file_name_handler},
     frames::LispFrameRef,
@@ -36,7 +36,7 @@ use crate::{
         Lisp_Misc_Type, Lisp_Overlay, Lisp_Type, Vbuffer_alist,
     },
     remacs_sys::{
-        windows_or_buffers_changed, Fcopy_sequence, Fget_text_property, Fnconc, Fnreverse, Fwiden,
+        windows_or_buffers_changed, Fcopy_sequence, Fget_text_property, Fnconc, Fnreverse,
     },
     remacs_sys::{
         Qafter_string, Qbefore_string, Qbuffer_read_only, Qbufferp, Qget_file_buffer,
@@ -1095,9 +1095,8 @@ pub fn delete_all_overlays_lisp(buffer: LispBufferOrCurrent) {
 /// so the buffer is truly empty after this.
 #[lisp_fn(intspec = "*")]
 pub fn erase_buffer() {
+    widen();
     unsafe {
-        Fwiden();
-
         let mut cur_buf = ThreadState::current_buffer_unchecked();
         del_range(cur_buf.beg(), cur_buf.z());
 
diff --git a/rust_src/src/cmds.rs b/rust_src/src/cmds.rs
index 563fb4c045..0d308c6f98 100644
--- a/rust_src/src/cmds.rs
+++ b/rust_src/src/cmds.rs
@@ -15,6 +15,7 @@ use crate::{
     keymap::{current_global_map, Ctl},
     lisp::defsubr,
     lisp::LispObject,
+    lists::get,
     multibyte::{
         char_to_byte8, single_byte_charp, unibyte_to_char, write_codepoint, Codepoint,
         MAX_MULTIBYTE_LENGTH,
@@ -28,7 +29,7 @@ use crate::{
         scan_newline_from_point, set_point, set_point_both, syntax_property, syntaxcode,
         translate_char,
     },
-    remacs_sys::{Fchar_width, Fget, Fmake_string, Fmove_to_column},
+    remacs_sys::{Fchar_width, Fmake_string, Fmove_to_column},
     remacs_sys::{
         Qbeginning_of_buffer, Qend_of_buffer, Qexpand_abbrev, Qinternal_auto_fill,
         Qkill_forward_chars, Qnil, Qoverwrite_mode_binary, Qpost_self_insert_hook,
@@ -401,7 +402,7 @@ fn internal_self_insert(mut c: Codepoint, n: usize) -> EmacsInt {
         // return right away--don't really self-insert.  */
         if let Some(s) = sym.as_symbol() {
             if let Some(f) = s.get_function().as_symbol() {
-                let prop = unsafe { Fget(f.into(), intern("no-self-insert").into()) };
+                let prop = get(f, intern("no-self-insert").into());
                 if prop.is_not_nil() {
                     return 1;
                 }
diff --git a/rust_src/src/coding.rs b/rust_src/src/coding.rs
index b64542c38a..2f36469a27 100644
--- a/rust_src/src/coding.rs
+++ b/rust_src/src/coding.rs
@@ -15,7 +15,7 @@ use crate::{
     multibyte::LispStringRef,
     remacs_sys::encode_file_name as c_encode_file_name,
     remacs_sys::{
-        safe_eval, Fget, Qcoding_system_define_form, Qcoding_system_error, Qcoding_system_p, Qnil,
+        safe_eval, Qcoding_system_define_form, Qcoding_system_error, Qcoding_system_p, Qnil,
         Qno_conversion, Vcoding_system_hash_table,
     },
 };
@@ -63,7 +63,7 @@ fn check_coding_system_get_spec(x: LispObject) -> LispObject {
 pub fn coding_system_p(object: LispObject) -> bool {
     object.is_nil()
         || coding_system_id(object) >= 0
-        || (object.is_symbol() && unsafe { Fget(object, Qcoding_system_define_form) }.is_not_nil())
+        || object.is_symbol() && get(object.into(), Qcoding_system_define_form).into()
 }
 
 /// Check validity of CODING-SYSTEM.
diff --git a/rust_src/src/data.rs b/rust_src/src/data.rs
index 0607a7b0e3..adc0670bba 100644
--- a/rust_src/src/data.rs
+++ b/rust_src/src/data.rs
@@ -24,7 +24,7 @@ use crate::{
     },
     remacs_sys::{buffer_local_flags, per_buffer_default, symbol_redirect},
     remacs_sys::{pvec_type, BoolVectorOp, EmacsInt, Lisp_Misc_Type, Lisp_Type, Set_Internal_Bind},
-    remacs_sys::{Fdelete, Fget, Fpurecopy},
+    remacs_sys::{Fdelete, Fpurecopy},
     remacs_sys::{Lisp_Buffer, Lisp_Subr_Lang},
     remacs_sys::{
         Qarrayp, Qautoload, Qbool_vector, Qbuffer, Qchar_table, Qchoice, Qcompiled_function,
@@ -567,13 +567,14 @@ pub unsafe extern "C" fn store_symval_forwarding(
             let predicate = (*valcontents).u_buffer_objfwd.predicate;
 
             if newval.is_not_nil() && predicate.is_symbol() {
-                let mut prop = Fget(predicate, Qchoice);
+                let pred_sym: LispSymbolRef = predicate.into();
+                let mut prop = get(pred_sym, Qchoice);
                 if prop.is_not_nil() {
                     if memq(newval, prop).is_nil() {
                         wrong_choice(prop, newval);
                     }
                 } else {
-                    prop = Fget(predicate, Qrange);
+                    prop = get(pred_sym, Qrange);
                     if let Some((min, max)) = prop.into() {
                         let args = [min, newval, max];
                         if !newval.is_number() || leq(&args) {
@@ -723,7 +724,7 @@ pub fn add_variable_watcher(symbol: LispSymbolRef, watch_function: LispObject) {
         symbol.into(),
     );
 
-    let watchers = unsafe { Fget(symbol.into(), Qwatchers) };
+    let watchers = get(symbol, Qwatchers);
     let mem = member(watch_function, watchers);
 
     if mem.is_nil() {
@@ -738,7 +739,7 @@ pub fn add_variable_watcher(symbol: LispSymbolRef, watch_function: LispObject) {
 pub fn remove_variable_watcher(symbol: LispSymbolRef, watch_function: LispObject) {
     let symbol = symbol.get_indirect_variable();
 
-    let watchers = unsafe { Fget(symbol.into(), Qwatchers) };
+    let watchers = get(symbol, Qwatchers);
     let watchers = unsafe { Fdelete(watch_function, watchers) };
 
     if watchers.is_nil() {
@@ -758,9 +759,9 @@ pub fn remove_variable_watcher(symbol: LispSymbolRef, watch_function: LispObject
 #[lisp_fn]
 pub fn get_variable_watchers(symbol: LispSymbolRef) -> LispObject {
     match symbol.get_trapped_write() {
-        symbol_trapped_write::SYMBOL_TRAPPED_WRITE => unsafe {
-            Fget(symbol.get_indirect_variable().into(), Qwatchers)
-        },
+        symbol_trapped_write::SYMBOL_TRAPPED_WRITE => {
+            get(symbol.get_indirect_variable(), Qwatchers)
+        }
         _ => Qnil,
     }
 }
diff --git a/rust_src/src/eval.rs b/rust_src/src/eval.rs
index 6ce07e4e09..6ba1593bb9 100644
--- a/rust_src/src/eval.rs
+++ b/rust_src/src/eval.rs
@@ -8,7 +8,7 @@ use crate::{
     data::{defalias, fset, indirect_function, indirect_function_lisp, set, set_default},
     lisp::{defsubr, is_autoload},
     lisp::{LispObject, LispSubrRef},
-    lists::{assq, car, cdr, get, memq, nth, put, Fcar, Fcdr},
+    lists::{assq, car, cdr, get, memq, nth, put},
     lists::{LispCons, LispConsCircularChecks, LispConsEndChecks},
     multibyte::LispStringRef,
     obarray::loadhist_attach,
@@ -398,7 +398,7 @@ pub fn letX(args: LispCons) -> LispObject {
     }
 
     // The symbols are bound. Now evaluate the body
-    let val = Fprogn(body);
+    let val = progn(body);
 
     unbind_to(count, val)
 }
@@ -453,7 +453,7 @@ pub fn lisp_let(args: LispCons) -> LispObject {
     }
 
     // The symbols are bound. Now evaluate the body
-    let val = Fprogn(body);
+    let val = progn(body);
 
     unbind_to(count, val)
 }
@@ -821,7 +821,7 @@ pub fn autoload_do_load(
     };
 
     unsafe {
-        Fload(Fcar(Fcdr(fundef)), ignore_errors, Qt, Qnil, Qt);
+        Fload(car(cdr(fundef)), ignore_errors, Qt, Qnil, Qt);
 
         // Once loading finishes, don't undo it.
         Vautoload_queue = Qt;
-- 
2.21.0


From 389338ef8b25489306a9228344d0a9f21541707f Mon Sep 17 00:00:00 2001
From: Nick Drozd <nicholasdrozd@gmail.com>
Date: Thu, 10 Jan 2019 18:37:13 -0600
Subject: [PATCH 204/297] Cut some uses of Qnil

Eventually all uses of Qnil should get replaced by native Rust
types (None, false, etc).
---
 rust_src/src/buffers.rs |  4 ++--
 rust_src/src/cmds.rs    |  2 +-
 rust_src/src/data.rs    |  6 +++---
 rust_src/src/editfns.rs |  4 ++--
 rust_src/src/eval.rs    | 26 +++++++++++++-------------
 rust_src/src/fns.rs     |  6 +++---
 rust_src/src/marker.rs  |  9 +++------
 7 files changed, 27 insertions(+), 30 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index f7cd47e33e..7507e35fbb 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -683,7 +683,7 @@ pub fn buffer_list(frame: Option<LispFrameRef>) -> LispObject {
             let prevlist = unsafe { Fnreverse(Fcopy_sequence(frame.buried_buffer_list)) };
 
             // Remove any buffer that duplicates one in FRAMELIST or PREVLIST.
-            buffers.retain(|e| member(*e, framelist) == Qnil && member(*e, prevlist) == Qnil);
+            buffers.retain(|e| member(*e, framelist).is_nil() && member(*e, prevlist).is_nil());
 
             callN_raw!(Fnconc, framelist, list(&buffers), prevlist)
         }
@@ -1125,7 +1125,7 @@ pub fn erase_buffer() {
 /// is first appended to NAME, to speed up finding a non-existent buffer.
 #[lisp_fn(min = "1")]
 pub fn generate_new_buffer_name(name: LispStringRef, ignore: LispObject) -> LispStringRef {
-    if (ignore != Qnil && string_equal(name.into(), ignore))
+    if (ignore.is_not_nil() && string_equal(name.into(), ignore))
         || get_buffer(LispBufferOrName::Name(name.into())).is_none()
     {
         return name;
diff --git a/rust_src/src/cmds.rs b/rust_src/src/cmds.rs
index 0d308c6f98..eea475b932 100644
--- a/rust_src/src/cmds.rs
+++ b/rust_src/src/cmds.rs
@@ -70,7 +70,7 @@ fn move_point(n: LispObject, forward: bool) {
     }
 
     unsafe { set_point(new_point) };
-    if signal != Qnil {
+    if signal.is_not_nil() {
         xsignal!(signal);
     }
 }
diff --git a/rust_src/src/data.rs b/rust_src/src/data.rs
index adc0670bba..1540006b1a 100644
--- a/rust_src/src/data.rs
+++ b/rust_src/src/data.rs
@@ -276,16 +276,16 @@ pub fn defalias(
     let sym = LispObject::from(symbol);
 
     unsafe {
-        if globals.Vpurify_flag != Qnil
+        if globals.Vpurify_flag.is_not_nil()
             // If `definition' is a keymap, immutable (and copying) is wrong.
-            && get_keymap(definition, false, false) == Qnil
+            && get_keymap(definition, false, false).is_nil()
         {
             definition = Fpurecopy(definition);
         }
     }
 
     let autoload = is_autoload(definition);
-    if unsafe { globals.Vpurify_flag == Qnil } || !autoload {
+    if unsafe { globals.Vpurify_flag.is_nil() } || !autoload {
         // Only add autoload entries after dumping, because the ones before are
         // not useful and else we get loads of them from the loaddefs.el.
 
diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index 5e61172fbe..f7025252d4 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -636,7 +636,7 @@ pub fn constrain_to_field(
     let prev_new = new_pos - 1;
     let begv = ThreadState::current_buffer_unchecked().begv as EmacsInt;
 
-    if unsafe { globals.Vinhibit_field_text_motion == Qnil }
+    if unsafe { globals.Vinhibit_field_text_motion.is_nil() }
         && new_pos != old_pos
         && (get_char_property(
             new_pos,
@@ -665,7 +665,7 @@ pub fn constrain_to_field(
                 Fget_pos_property(
                     LispObject::from(old_pos),
                     inhibit_capture_property,
-                    Qnil) == Qnil
+                    Qnil).is_nil()
             }
                 && (old_pos <= begv
                     || get_char_property(
diff --git a/rust_src/src/eval.rs b/rust_src/src/eval.rs
index 6ba1593bb9..52b4767959 100644
--- a/rust_src/src/eval.rs
+++ b/rust_src/src/eval.rs
@@ -107,7 +107,7 @@ pub fn cond(args: LispObject) -> LispObject {
     for clause in args.iter_cars(LispConsEndChecks::off, LispConsCircularChecks::off) {
         let (head, tail) = clause.into();
         val = unsafe { eval_sub(head) };
-        if val != Qnil {
+        if val.is_not_nil() {
             if tail.is_not_nil() {
                 val = progn(tail);
             }
@@ -186,7 +186,7 @@ pub fn setq(args: LispObject) -> LispObject {
         // Like for eval_sub, we do not check declared_special here since
         // it's been done when let-binding.
         // N.B. the check against nil is a mere optimization!
-        if unsafe { globals.Vinternal_interpreter_environment != Qnil } && sym.is_symbol() {
+        if unsafe { globals.Vinternal_interpreter_environment.is_not_nil() } && sym.is_symbol() {
             let binding = assq(sym, unsafe { globals.Vinternal_interpreter_environment });
             if let Some(binding) = binding.as_cons() {
                 lexical = true;
@@ -215,7 +215,7 @@ pub fn function(args: LispCons) -> LispObject {
         wrong_number_of_arguments!(Qfunction, length(args.into()));
     }
 
-    if unsafe { globals.Vinternal_interpreter_environment != Qnil } {
+    if unsafe { globals.Vinternal_interpreter_environment.is_not_nil() } {
         if let Some((first, mut cdr)) = quoted.into() {
             if first.eq(Qlambda) {
                 // This is a lambda expression within a lexical environment;
@@ -297,14 +297,14 @@ pub fn defconst(args: LispCons) -> LispSymbolRef {
     };
 
     let mut tem = unsafe { eval_sub(car(tail)) };
-    if unsafe { globals.Vpurify_flag } != Qnil {
+    if unsafe { globals.Vpurify_flag }.is_not_nil() {
         tem = unsafe { Fpurecopy(tem) };
     }
     let sym_ref: LispSymbolRef = sym.into();
     set_default(sym_ref, tem);
     sym_ref.set_declared_special(true);
     if docstring.is_not_nil() {
-        if unsafe { globals.Vpurify_flag } != Qnil {
+        if unsafe { globals.Vpurify_flag }.is_not_nil() {
             docstring = unsafe { Fpurecopy(docstring) };
         }
 
@@ -362,7 +362,7 @@ pub fn letX(args: LispCons) -> LispObject {
 
         let mut needs_bind = true;
 
-        if lexenv != Qnil {
+        if lexenv.is_not_nil() {
             if let Some(sym) = var.as_symbol() {
                 if !sym.get_declared_special() {
                     let bound = memq(var, unsafe { globals.Vinternal_interpreter_environment })
@@ -423,7 +423,7 @@ pub fn lisp_let(args: LispCons) -> LispObject {
 
         let mut dyn_bind = true;
 
-        if lexenv != Qnil {
+        if lexenv.is_not_nil() {
             if let Some(sym) = var.as_symbol() {
                 if !sym.get_declared_special() {
                     let bound = memq(var, unsafe { globals.Vinternal_interpreter_environment })
@@ -466,7 +466,7 @@ pub fn lisp_let(args: LispCons) -> LispObject {
 pub fn lisp_while(args: LispCons) {
     let (test, body) = args.into();
 
-    while unsafe { eval_sub(test) } != Qnil {
+    while unsafe { eval_sub(test) }.is_not_nil() {
         unsafe { maybe_quit() };
 
         prog_ignore(body);
@@ -565,7 +565,7 @@ pub fn eval(form: LispObject, lexical: LispObject) -> LispObject {
 /// Apply fn to arg.
 #[no_mangle]
 pub extern "C" fn apply1(func: LispObject, arg: LispObject) -> LispObject {
-    if arg == Qnil {
+    if arg.is_nil() {
         call!(func)
     } else {
         callN_raw!(Fapply, func, arg)
@@ -673,11 +673,11 @@ pub fn autoload(
     ty: LispObject,
 ) -> LispObject {
     // If function is defined and not as an autoload, don't override.
-    if function.get_function() != Qnil && !is_autoload(function.get_function()) {
+    if function.get_function().is_not_nil() && !is_autoload(function.get_function()) {
         return Qnil;
     }
 
-    if unsafe { globals.Vpurify_flag != Qnil } && docstring.eq(0) {
+    if unsafe { globals.Vpurify_flag.is_not_nil() } && docstring.eq(0) {
         // `read1' in lread.c has found the docstring starting with "\
         // and assumed the docstring will be provided by Snarf-documentation, so it
         // passed us 0 instead.  But that leads to accidental sharing in purecopy's
@@ -788,7 +788,7 @@ pub fn autoload_do_load(
     unsafe {
         // This is to make sure that loadup.el gives a clear picture
         // of what files are preloaded and when.
-        if globals.Vpurify_flag != Qnil {
+        if globals.Vpurify_flag.is_not_nil() {
             error!(
                 "Attempt to autoload {} while preparing to dump",
                 sym.symbol_name().as_string_or_error()
@@ -961,7 +961,7 @@ fn run_hook_with_args_internal(
 ) -> LispObject {
     // If we are dying or still initializing,
     // don't do anything -- it would probably crash if we tried.
-    if unsafe { Vrun_hooks == Qnil } {
+    if unsafe { Vrun_hooks.is_nil() } {
         return Qnil;
     }
 
diff --git a/rust_src/src/fns.rs b/rust_src/src/fns.rs
index 1368fae0fe..f293d9c762 100644
--- a/rust_src/src/fns.rs
+++ b/rust_src/src/fns.rs
@@ -163,7 +163,7 @@ pub fn require(feature: LispObject, filename: LispObject, noerror: LispObject) -
 
     // This is to make sure that loadup.el gives a clear picture
     // of what files are preloaded and when.
-    if unsafe { globals.Vpurify_flag != Qnil } {
+    if unsafe { globals.Vpurify_flag.is_not_nil() } {
         error!(
             "(require {}) while preparing to dump",
             feature_sym.symbol_name().as_string_or_error()
@@ -204,11 +204,11 @@ pub fn require(feature: LispObject, filename: LispObject, noerror: LispObject) -
             noerror,
             Qt,
             Qnil,
-            if filename.is_nil() { Qt } else { Qnil },
+            filename.is_nil().into(),
         );
 
         // If load failed entirely, return nil.
-        if tem == Qnil {
+        if tem.is_nil() {
             return unbind_to(count, Qnil);
         }
     }
diff --git a/rust_src/src/marker.rs b/rust_src/src/marker.rs
index dda85647a8..1ce25cf2dc 100644
--- a/rust_src/src/marker.rs
+++ b/rust_src/src/marker.rs
@@ -12,7 +12,7 @@ use crate::{
     multibyte::multibyte_chars_in_text,
     remacs_sys::{allocate_misc, set_point_both, Fmake_marker},
     remacs_sys::{equal_kind, EmacsInt, Lisp_Buffer, Lisp_Marker, Lisp_Misc_Type, Lisp_Type},
-    remacs_sys::{Qinteger_or_marker_p, Qmarkerp, Qnil},
+    remacs_sys::{Qinteger_or_marker_p, Qmarkerp},
     threads::ThreadState,
     util::clip_to_bounds,
 };
@@ -299,12 +299,9 @@ pub fn copy_marker(marker: LispObject, itype: LispObject) -> LispObject {
         marker.as_fixnum_coerce_marker_or_error();
     }
     let new = unsafe { Fmake_marker() };
-    let buffer_or_nil = marker
-        .as_marker()
-        .and_then(|m| m.buffer())
-        .map_or(Qnil, LispObject::from);
+    let buffer_or_nil = marker.as_marker().and_then(|m| m.buffer());
 
-    set_marker(new.into(), marker, buffer_or_nil);
+    set_marker(new.into(), marker, buffer_or_nil.into());
 
     if let Some(mut m) = new.as_marker() {
         m.set_insertion_type(itype.is_not_nil())
-- 
2.21.0


From c8231bbe46592305de0cc5c917f14bc2bea4c826 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Carlos=20Mart=C3=ADn=20Nieto?= <cmn@dwim.me>
Date: Mon, 24 Dec 2018 00:29:30 +0000
Subject: [PATCH 205/297] Port insert_from_string and
 insert_from_string_before_markers

---
 rust_src/src/editfns.rs | 67 ++++++++++++++++++++++++++++++++++++-----
 src/insdel.c            | 48 ++---------------------------
 src/lisp.h              |  2 ++
 3 files changed, 64 insertions(+), 53 deletions(-)

diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index 07c770d799..0abf16aa1c 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -32,13 +32,13 @@ use crate::{
         buffer_overflow, build_string, current_message, del_range, del_range_1, downcase,
         find_before_next_newline, find_newline, general_insert_function,
         get_char_property_and_overlay, globals, insert, insert_and_inherit, insert_before_markers,
-        insert_before_markers_and_inherit, insert_from_buffer, insert_from_string,
-        insert_from_string_before_markers, make_buffer_string, make_buffer_string_both,
-        make_save_obj_obj_obj_obj, make_string_from_bytes, maybe_quit, message1, message3,
-        record_unwind_current_buffer, record_unwind_protect, save_excursion_restore,
-        save_restriction_restore, save_restriction_save, scan_newline_from_point,
-        set_buffer_internal_1, set_point, set_point_both, styled_format, update_buffer_properties,
-        STRING_BYTES,
+        insert_before_markers_and_inherit, insert_from_buffer, insert_from_string_1,
+        make_buffer_string, make_buffer_string_both, make_save_obj_obj_obj_obj,
+        make_string_from_bytes, maybe_quit, message1, message3, record_unwind_current_buffer,
+        record_unwind_protect, save_excursion_restore, save_restriction_restore,
+        save_restriction_save, scan_newline_from_point, set_buffer_internal_1, set_point,
+        set_point_both, signal_after_change, styled_format, update_buffer_properties,
+        update_compositions, CHECK_BORDER, STRING_BYTES,
     },
     remacs_sys::{
         Fadd_text_properties, Fcopy_sequence, Fget_pos_property, Fnext_single_char_property_change,
@@ -1545,4 +1545,57 @@ pub fn insert_and_inherit_before_markers_lisp(args: &[LispObject]) {
     };
 }
 
+/// Insert the part of the text of STRING, a Lisp object assumed to be of type string, consisting
+/// of the LENGTH characters (LENGTH_BYTE bytes) starting at position POS / POS_BYTE.  If the text
+/// of STRING has properties,
+///copy them into the buffer.
+///
+/// It does not work to use `insert' for this, because a GC could happen before we copy the stuff
+/// into the buffer, and relocate the string without insert noticing.
+#[no_mangle]
+pub unsafe extern "C" fn insert_from_string(
+    string: LispObject,
+    pos: ptrdiff_t,
+    pos_byte: ptrdiff_t,
+    length: ptrdiff_t,
+    length_byte: ptrdiff_t,
+    inherit: bool,
+) {
+    let current_buffer = ThreadState::current_buffer_unchecked();
+    let opoint = current_buffer.pt;
+
+    let s: LispStringRef = string.into();
+    if s.len_chars() == 0 {
+        return;
+    }
+
+    insert_from_string_1(string, pos, pos_byte, length, length_byte, inherit, false);
+    signal_after_change(opoint, 0, current_buffer.pt - opoint);
+    update_compositions(opoint, current_buffer.pt, CHECK_BORDER as i32);
+}
+
+/// Like `insert_from_string' except that all markers pointing at the place where the insertion
+/// happens are adjusted to point after it.
+#[no_mangle]
+pub unsafe extern "C" fn insert_from_string_before_markers(
+    string: LispObject,
+    pos: ptrdiff_t,
+    pos_byte: ptrdiff_t,
+    length: ptrdiff_t,
+    length_byte: ptrdiff_t,
+    inherit: bool,
+) {
+    let current_buffer = ThreadState::current_buffer_unchecked();
+    let opoint = current_buffer.pt;
+
+    let s: LispStringRef = string.into();
+    if s.len_chars() == 0 {
+        return;
+    }
+
+    insert_from_string_1(string, pos, pos_byte, length, length_byte, inherit, true);
+    signal_after_change(opoint, 0, current_buffer.pt - opoint);
+    update_compositions(opoint, current_buffer.pt, CHECK_BORDER as i32);
+}
+
 include!(concat!(env!("OUT_DIR"), "/editfns_exports.rs"));
diff --git a/src/insdel.c b/src/insdel.c
index 02e3f41bc9..47d0fd8e08 100644
--- a/src/insdel.c
+++ b/src/insdel.c
@@ -30,8 +30,7 @@ along with GNU Emacs.  If not, see <https://www.gnu.org/licenses/>.  */
 #include "window.h"
 #include "region-cache.h"
 
-static void insert_from_string_1 (Lisp_Object, ptrdiff_t, ptrdiff_t, ptrdiff_t,
-				  ptrdiff_t, bool, bool);
+
 static void insert_from_buffer_1 (struct buffer *, ptrdiff_t, ptrdiff_t, bool);
 static void gap_left (ptrdiff_t, ptrdiff_t, bool);
 static void gap_right (ptrdiff_t, ptrdiff_t);
@@ -938,53 +937,10 @@ insert_1_both (const char *string,
   check_markers ();
 }
 
-/* Insert the part of the text of STRING, a Lisp object assumed to be
-   of type string, consisting of the LENGTH characters (LENGTH_BYTE bytes)
-   starting at position POS / POS_BYTE.  If the text of STRING has properties,
-   copy them into the buffer.
-
-   It does not work to use `insert' for this, because a GC could happen
-   before we copy the stuff into the buffer, and relocate the string
-   without insert noticing.  */
-
-void
-insert_from_string (Lisp_Object string, ptrdiff_t pos, ptrdiff_t pos_byte,
-		    ptrdiff_t length, ptrdiff_t length_byte, bool inherit)
-{
-  ptrdiff_t opoint = PT;
-
-  if (SCHARS (string) == 0)
-    return;
-
-  insert_from_string_1 (string, pos, pos_byte, length, length_byte,
-			inherit, 0);
-  signal_after_change (opoint, 0, PT - opoint);
-  update_compositions (opoint, PT, CHECK_BORDER);
-}
-
-/* Like `insert_from_string' except that all markers pointing
-   at the place where the insertion happens are adjusted to point after it.  */
-
-void
-insert_from_string_before_markers (Lisp_Object string,
-				   ptrdiff_t pos, ptrdiff_t pos_byte,
-				   ptrdiff_t length, ptrdiff_t length_byte,
-				   bool inherit)
-{
-  ptrdiff_t opoint = PT;
-
-  if (SCHARS (string) == 0)
-    return;
-
-  insert_from_string_1 (string, pos, pos_byte, length, length_byte,
-			inherit, 1);
-  signal_after_change (opoint, 0, PT - opoint);
-  update_compositions (opoint, PT, CHECK_BORDER);
-}
 
 /* Subroutine of the insertion functions above.  */
 
-static void
+void
 insert_from_string_1 (Lisp_Object string, ptrdiff_t pos, ptrdiff_t pos_byte,
 		      ptrdiff_t nchars, ptrdiff_t nbytes,
 		      bool inherit, bool before_markers)
diff --git a/src/lisp.h b/src/lisp.h
index 5147224da8..881499b792 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -3600,6 +3600,8 @@ extern void insert_1_both (const char *, ptrdiff_t, ptrdiff_t,
 extern void insert_from_gap (ptrdiff_t, ptrdiff_t, bool text_at_gap_tail);
 extern void insert_from_string (Lisp_Object, ptrdiff_t, ptrdiff_t,
 				ptrdiff_t, ptrdiff_t, bool);
+extern void insert_from_string_1 (Lisp_Object, ptrdiff_t, ptrdiff_t, ptrdiff_t,
+				  ptrdiff_t, bool, bool);
 extern void insert_from_buffer (struct buffer *, ptrdiff_t, ptrdiff_t, bool);
 extern void insert_char (int);
 extern void insert_string (const char *);
-- 
2.21.0


From 6f587b21ba421eeea7d48afda2272a6d4270ccb0 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Carlos=20Mart=C3=ADn=20Nieto?= <cmn@dwim.me>
Date: Mon, 24 Dec 2018 01:06:24 +0000
Subject: [PATCH 206/297] Port general_insert_function

This is now only used by Rust functions so we can pass the array
better. This is still an unsafe function as it calls unsafe code.
---
 rust_src/src/editfns.rs    | 89 +++++++++++++++++++++++---------------
 rust_src/src/remacs_sys.rs | 14 ------
 src/editfns.c              | 46 --------------------
 3 files changed, 54 insertions(+), 95 deletions(-)

diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index 0abf16aa1c..8a2efa1d09 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -6,7 +6,7 @@ use std::ops::{Add, Sub};
 use std::ptr;
 
 use libc;
-use libc::{c_int, c_uchar, ptrdiff_t};
+use libc::{c_char, c_int, c_uchar, ptrdiff_t};
 
 use remacs_macros::lisp_fn;
 
@@ -22,29 +22,30 @@ use crate::{
         set_point_from_marker,
     },
     multibyte::{
-        is_single_byte_char, multibyte_char_at, raw_byte_codepoint, unibyte_to_char,
-        write_codepoint, MAX_MULTIBYTE_LENGTH,
+        is_single_byte_char, multibyte_char_at, raw_byte_codepoint, raw_byte_from_codepoint,
+        unibyte_to_char, write_codepoint, MAX_MULTIBYTE_LENGTH,
     },
     multibyte::{Codepoint, LispStringRef},
     numbers::LispNumber,
     remacs_sys::EmacsInt,
     remacs_sys::{
         buffer_overflow, build_string, current_message, del_range, del_range_1, downcase,
-        find_before_next_newline, find_newline, general_insert_function,
-        get_char_property_and_overlay, globals, insert, insert_and_inherit, insert_before_markers,
-        insert_before_markers_and_inherit, insert_from_buffer, insert_from_string_1,
-        make_buffer_string, make_buffer_string_both, make_save_obj_obj_obj_obj,
-        make_string_from_bytes, maybe_quit, message1, message3, record_unwind_current_buffer,
-        record_unwind_protect, save_excursion_restore, save_restriction_restore,
-        save_restriction_save, scan_newline_from_point, set_buffer_internal_1, set_point,
-        set_point_both, signal_after_change, styled_format, update_buffer_properties,
-        update_compositions, CHECK_BORDER, STRING_BYTES,
+        find_before_next_newline, find_newline, get_char_property_and_overlay, globals, insert,
+        insert_and_inherit, insert_before_markers, insert_before_markers_and_inherit,
+        insert_from_buffer, insert_from_string_1, make_buffer_string, make_buffer_string_both,
+        make_save_obj_obj_obj_obj, make_string_from_bytes, maybe_quit, message1, message3,
+        record_unwind_current_buffer, record_unwind_protect, save_excursion_restore,
+        save_restriction_restore, save_restriction_save, scan_newline_from_point,
+        set_buffer_internal_1, set_point, set_point_both, signal_after_change, styled_format,
+        update_buffer_properties, update_compositions, CHECK_BORDER, STRING_BYTES,
     },
     remacs_sys::{
         Fadd_text_properties, Fcopy_sequence, Fget_pos_property, Fnext_single_char_property_change,
         Fprevious_single_char_property_change, Fx_popup_dialog,
     },
-    remacs_sys::{Qboundary, Qfield, Qinteger_or_marker_p, Qmark_inactive, Qnil, Qt},
+    remacs_sys::{
+        Qboundary, Qchar_or_string_p, Qfield, Qinteger_or_marker_p, Qmark_inactive, Qnil, Qt,
+    },
     textprop::get_char_property,
     threads::{c_specpdl_index, ThreadState},
     time::{lisp_time_struct, time_overflow, LispTime},
@@ -1464,15 +1465,7 @@ pub fn widen() {
 /// usage: (insert &rest ARGS)
 #[lisp_fn(name = "insert", c_name = "insert")]
 pub fn insert_lisp(args: &[LispObject]) {
-    unsafe {
-        general_insert_function(
-            insert,
-            insert_from_string,
-            false,
-            args.len() as isize,
-            args.as_ptr(),
-        )
-    };
+    unsafe { general_insert_function(insert, insert_from_string, false, args) };
 }
 
 /// Insert the arguments at point, inheriting properties from adjoining text.  Point and
@@ -1486,15 +1479,7 @@ pub fn insert_lisp(args: &[LispObject]) {
 /// usage: (insert-and-inherit &rest ARGS)
 #[lisp_fn(name = "insert-and-inherit", c_name = "insert_and_inherit")]
 pub fn insert_and_inherit_lisp(args: &[LispObject]) {
-    unsafe {
-        general_insert_function(
-            insert_and_inherit,
-            insert_from_string,
-            true,
-            args.len() as isize,
-            args.as_ptr(),
-        )
-    };
+    unsafe { general_insert_function(insert_and_inherit, insert_from_string, true, args) };
 }
 
 /// Insert strings or characters at point, relocating markers after the text.  Point and markers
@@ -1515,8 +1500,7 @@ pub fn insert_before_markers_lisp(args: &[LispObject]) {
             insert_before_markers,
             insert_from_string_before_markers,
             false,
-            args.len() as isize,
-            args.as_ptr(),
+            args,
         )
     };
 }
@@ -1539,8 +1523,7 @@ pub fn insert_and_inherit_before_markers_lisp(args: &[LispObject]) {
             insert_before_markers_and_inherit,
             insert_from_string_before_markers,
             true,
-            args.len() as isize,
-            args.as_ptr(),
+            args,
         )
     };
 }
@@ -1598,4 +1581,40 @@ pub unsafe extern "C" fn insert_from_string_before_markers(
     update_compositions(opoint, current_buffer.pt, CHECK_BORDER as i32);
 }
 
+/// Insert NARGS Lisp objects in the array ARGS by calling INSERT_FUNC (if a type of object is
+/// Lisp_Int) or INSERT_FROM_STRING_FUNC (if a type of object is Lisp_String).  INHERIT is passed
+/// to INSERT_FROM_STRING_FUNC as the last argument
+unsafe fn general_insert_function(
+    insert_func: unsafe extern "C" fn(*const c_char, ptrdiff_t),
+    insert_from_string_func: unsafe extern "C" fn(
+        LispObject,
+        ptrdiff_t,
+        ptrdiff_t,
+        ptrdiff_t,
+        ptrdiff_t,
+        bool,
+    ),
+    inherit: bool,
+    args: &[LispObject],
+) {
+    for &val in args {
+        if val.is_character() {
+            let c = val.as_natnum_or_error() as Codepoint;
+            let mut s = [0 as c_uchar; MAX_MULTIBYTE_LENGTH];
+            let multibyte = ThreadState::current_buffer_unchecked().multibyte_characters_enabled();
+            let len = if multibyte {
+                write_codepoint(&mut s, c)
+            } else {
+                s[0] = raw_byte_from_codepoint(c);
+                1
+            };
+            insert_func(s.as_ptr() as *const c_char, len as isize);
+        } else if let Some(string) = val.as_string() {
+            insert_from_string_func(val, 0, 0, string.len_chars(), string.len_bytes(), inherit);
+        } else {
+            wrong_type!(Qchar_or_string_p, val);
+        }
+    }
+}
+
 include!(concat!(env!("OUT_DIR"), "/editfns_exports.rs"));
diff --git a/rust_src/src/remacs_sys.rs b/rust_src/src/remacs_sys.rs
index 8008be0eb2..a04afeeac1 100755
--- a/rust_src/src/remacs_sys.rs
+++ b/rust_src/src/remacs_sys.rs
@@ -127,20 +127,6 @@ extern "C" {
         dest: Lisp_Object,
         op: BoolVectorOp,
     ) -> Lisp_Object;
-    pub fn general_insert_function(
-        insert_func: unsafe extern "C" fn(*const c_char, ptrdiff_t),
-        insert_from_string_func: unsafe extern "C" fn(
-            LispObject,
-            ptrdiff_t,
-            ptrdiff_t,
-            ptrdiff_t,
-            ptrdiff_t,
-            bool,
-        ),
-        inherit: bool,
-        nargs: ptrdiff_t,
-        args: *const LispObject,
-    );
 }
 
 // Max value for the first argument of wait_reading_process_output.
diff --git a/src/editfns.c b/src/editfns.c
index e8b19aa319..d95b03cdd0 100644
--- a/src/editfns.c
+++ b/src/editfns.c
@@ -1291,52 +1291,6 @@ emacs_setenv_TZ (const char *tzstring)
   return 0;
 }
 
-/* Insert NARGS Lisp objects in the array ARGS by calling INSERT_FUNC
-   (if a type of object is Lisp_Int) or INSERT_FROM_STRING_FUNC (if a
-   type of object is Lisp_String).  INHERIT is passed to
-   INSERT_FROM_STRING_FUNC as the last argument.  */
-
-void
-general_insert_function (void (*insert_func)
-			      (const char *, ptrdiff_t),
-			 void (*insert_from_string_func)
-			      (Lisp_Object, ptrdiff_t, ptrdiff_t,
-			       ptrdiff_t, ptrdiff_t, bool),
-			 bool inherit, ptrdiff_t nargs, Lisp_Object *args)
-{
-  ptrdiff_t argnum;
-  Lisp_Object val;
-
-  for (argnum = 0; argnum < nargs; argnum++)
-    {
-      val = args[argnum];
-      if (CHARACTERP (val))
-	{
-	  int c = XFASTINT (val);
-	  unsigned char str[MAX_MULTIBYTE_LENGTH];
-	  int len;
-
-	  if (!NILP (BVAR (current_buffer, enable_multibyte_characters)))
-	    len = CHAR_STRING (c, str);
-	  else
-	    {
-	      str[0] = CHAR_TO_BYTE8 (c);
-	      len = 1;
-	    }
-	  (*insert_func) ((char *) str, len);
-	}
-      else if (STRINGP (val))
-	{
-	  (*insert_from_string_func) (val, 0, 0,
-				      SCHARS (val),
-				      SBYTES (val),
-				      inherit);
-	}
-      else
-	wrong_type_argument (Qchar_or_string_p, val);
-    }
-}
-
 void
 insert1 (Lisp_Object arg)
 {
-- 
2.21.0


From 3cd5867534e149d1a7116fc4235f01ada0eb9adc Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Carlos=20Mart=C3=ADn=20Nieto?= <cmn@dwim.me>
Date: Mon, 24 Dec 2018 11:09:03 +0000
Subject: [PATCH 207/297] Port insert callback functions

Only one of them is still used from C so convert them to safe
functions which take a slice. Introduce `insert_slice` as a safe
version of `insert` for use within the Rust code and so the callback
signatures match.
---
 rust_src/src/cmds.rs    |  16 ++---
 rust_src/src/editfns.rs | 141 +++++++++++++++++++++++++++++++++-------
 src/insdel.c            |  70 --------------------
 src/lisp.h              |   2 -
 4 files changed, 124 insertions(+), 105 deletions(-)

diff --git a/rust_src/src/cmds.rs b/rust_src/src/cmds.rs
index 563fb4c045..ec5f912f10 100644
--- a/rust_src/src/cmds.rs
+++ b/rust_src/src/cmds.rs
@@ -10,7 +10,7 @@ use crate::{
     character::{self, characterp},
     data::set,
     dispnew::ding_internal,
-    editfns::{line_beginning_position, line_end_position, preceding_char},
+    editfns::{insert_and_inherit, line_beginning_position, line_end_position, preceding_char},
     frames::selected_frame,
     keymap::{current_global_map, Ctl},
     lisp::defsubr,
@@ -24,9 +24,8 @@ use crate::{
     remacs_sys::EmacsInt,
     remacs_sys::{
         concat2, current_column, del_range, frame_make_pointer_invisible, globals,
-        initial_define_key, insert_and_inherit, memory_full, replace_range, run_hook,
-        scan_newline_from_point, set_point, set_point_both, syntax_property, syntaxcode,
-        translate_char,
+        initial_define_key, memory_full, replace_range, run_hook, scan_newline_from_point,
+        set_point, set_point_both, syntax_property, syntaxcode, translate_char,
     },
     remacs_sys::{Fchar_width, Fget, Fmake_string, Fmove_to_column},
     remacs_sys::{
@@ -446,14 +445,9 @@ fn internal_self_insert(mut c: Codepoint, n: usize) -> EmacsInt {
         for _ in 0..n {
             strn.extend_from_slice(&str[0..len]);
         }
-        unsafe {
-            insert_and_inherit(
-                strn.as_mut_slice().as_mut_ptr() as *mut i8,
-                strn.len() as isize,
-            )
-        };
+        insert_and_inherit(strn.as_slice());
     } else if n > 0 {
-        unsafe { insert_and_inherit(str.as_mut_ptr() as *mut i8, len as isize) };
+        insert_and_inherit(&str[..len]);
     }
 
     if let Some(t) = unsafe { globals.Vauto_fill_chars }.as_char_table() {
diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index 8a2efa1d09..eacdfe2094 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -29,15 +29,15 @@ use crate::{
     numbers::LispNumber,
     remacs_sys::EmacsInt,
     remacs_sys::{
-        buffer_overflow, build_string, current_message, del_range, del_range_1, downcase,
-        find_before_next_newline, find_newline, get_char_property_and_overlay, globals, insert,
-        insert_and_inherit, insert_before_markers, insert_before_markers_and_inherit,
-        insert_from_buffer, insert_from_string_1, make_buffer_string, make_buffer_string_both,
-        make_save_obj_obj_obj_obj, make_string_from_bytes, maybe_quit, message1, message3,
-        record_unwind_current_buffer, record_unwind_protect, save_excursion_restore,
-        save_restriction_restore, save_restriction_save, scan_newline_from_point,
-        set_buffer_internal_1, set_point, set_point_both, signal_after_change, styled_format,
-        update_buffer_properties, update_compositions, CHECK_BORDER, STRING_BYTES,
+        buffer_overflow, build_string, chars_in_text, current_message, del_range, del_range_1,
+        downcase, find_before_next_newline, find_newline, get_char_property_and_overlay, globals,
+        insert_1_both, insert_from_buffer, insert_from_string_1, make_buffer_string,
+        make_buffer_string_both, make_save_obj_obj_obj_obj, make_string_from_bytes, maybe_quit,
+        message1, message3, record_unwind_current_buffer, record_unwind_protect,
+        save_excursion_restore, save_restriction_restore, save_restriction_save,
+        scan_newline_from_point, set_buffer_internal_1, set_point, set_point_both,
+        signal_after_change, styled_format, update_buffer_properties, update_compositions,
+        CHECK_BORDER, STRING_BYTES,
     },
     remacs_sys::{
         Fadd_text_properties, Fcopy_sequence, Fget_pos_property, Fnext_single_char_property_change,
@@ -286,27 +286,27 @@ pub fn insert_char(character: Codepoint, count: Option<EmacsInt>, inherit: bool)
     if BUF_BYTES_MAX / (len as isize) < (count as isize) {
         unsafe { buffer_overflow() };
     }
-    let mut n: ptrdiff_t = (count * (len as EmacsInt)) as ptrdiff_t;
-    let mut buffer = [0_i8; BUFSIZE];
+    let mut n = (count as usize) * len;
+    let mut buffer = [0_u8; BUFSIZE];
     // bufferlen is the number of bytes used when filling the buffer
     // with as many copies of str as possible, without overflowing it.
-    let bufferlen: ptrdiff_t = std::cmp::min(n, (BUFSIZE - (BUFSIZE % len)) as isize);
+    let bufferlen = std::cmp::min(n, BUFSIZE - (BUFSIZE % len));
     for i in 0..bufferlen {
-        buffer[i as usize] = str[(i % len as isize) as usize] as i8;
+        buffer[i] = str[i % len];
     }
     while n > bufferlen {
         unsafe { maybe_quit() };
         if inherit {
-            unsafe { insert_and_inherit(buffer.as_ptr(), bufferlen) };
+            insert_and_inherit(&buffer[..bufferlen]);
         } else {
-            unsafe { insert(buffer.as_ptr(), bufferlen) };
+            insert_slice(&buffer[..bufferlen]);
         }
         n -= bufferlen;
     }
     if inherit {
-        unsafe { insert_and_inherit(buffer.as_ptr(), n) };
+        insert_and_inherit(&buffer[..n]);
     } else {
-        unsafe { insert(buffer.as_ptr(), n) };
+        insert_slice(&buffer[..n]);
     }
 }
 
@@ -1465,7 +1465,7 @@ pub fn widen() {
 /// usage: (insert &rest ARGS)
 #[lisp_fn(name = "insert", c_name = "insert")]
 pub fn insert_lisp(args: &[LispObject]) {
-    unsafe { general_insert_function(insert, insert_from_string, false, args) };
+    unsafe { general_insert_function(insert_slice, insert_from_string, false, args) };
 }
 
 /// Insert the arguments at point, inheriting properties from adjoining text.  Point and
@@ -1584,8 +1584,8 @@ pub unsafe extern "C" fn insert_from_string_before_markers(
 /// Insert NARGS Lisp objects in the array ARGS by calling INSERT_FUNC (if a type of object is
 /// Lisp_Int) or INSERT_FROM_STRING_FUNC (if a type of object is Lisp_String).  INHERIT is passed
 /// to INSERT_FROM_STRING_FUNC as the last argument
-unsafe fn general_insert_function(
-    insert_func: unsafe extern "C" fn(*const c_char, ptrdiff_t),
+unsafe fn general_insert_function<IF>(
+    insert_func: IF,
     insert_from_string_func: unsafe extern "C" fn(
         LispObject,
         ptrdiff_t,
@@ -1596,7 +1596,9 @@ unsafe fn general_insert_function(
     ),
     inherit: bool,
     args: &[LispObject],
-) {
+) where
+    IF: Fn(&[u8]),
+{
     for &val in args {
         if val.is_character() {
             let c = val.as_natnum_or_error() as Codepoint;
@@ -1608,7 +1610,7 @@ unsafe fn general_insert_function(
                 s[0] = raw_byte_from_codepoint(c);
                 1
             };
-            insert_func(s.as_ptr() as *const c_char, len as isize);
+            insert_func(&s[..len]);
         } else if let Some(string) = val.as_string() {
             insert_from_string_func(val, 0, 0, string.len_chars(), string.len_bytes(), inherit);
         } else {
@@ -1617,4 +1619,99 @@ unsafe fn general_insert_function(
     }
 }
 
+/// Insert a string of specified length before point.  This function judges multibyteness based on
+/// enable_multibyte_characters in the current buffer; it never converts between single-byte and
+/// multibyte.
+///
+/// DO NOT use this for the contents of a Lisp string or a Lisp buffer!  prepare_to_modify_buffer
+/// could relocate the text.
+#[no_mangle]
+pub unsafe extern "C" fn insert(string: *const c_char, nbytes: ptrdiff_t) {
+    if nbytes > 0 {
+        let len = chars_in_text(string as *const c_uchar, nbytes);
+        insert_1_both(string, len, nbytes, false, true, false);
+
+        let pt = point() as isize;
+        let opoint = pt - len;
+        signal_after_change(opoint, 0, len);
+        update_compositions(opoint, pt, CHECK_BORDER as i32);
+    }
+}
+
+/// A version of inset that takes a slice instead of pointer and length
+pub fn insert_slice(string: &[u8]) {
+    unsafe { insert(string.as_ptr() as *const c_char, string.len() as isize) }
+}
+
+/// Likewise, but inherit text properties from neighboring characters.
+pub fn insert_and_inherit(string: &[u8]) {
+    let nbytes = string.len() as isize;
+    if nbytes > 0 {
+        unsafe {
+            let len = chars_in_text(string.as_ptr(), nbytes);
+            insert_1_both(
+                string.as_ptr() as *const c_char,
+                len,
+                nbytes,
+                true,
+                true,
+                false,
+            );
+
+            let pt = point() as isize;
+            let opoint = pt - len;
+            signal_after_change(opoint, 0, len);
+            update_compositions(opoint, pt, CHECK_BORDER as i32);
+        }
+    }
+}
+
+/// Like `insert' except that all markers pointing at the place where the insertion happens are
+/// adjusted to point after it.  Don't use this function to insert part of a Lisp string, since gc
+/// could happen and relocate it.
+pub fn insert_before_markers(string: &[u8]) {
+    let nbytes = string.len() as isize;
+    if nbytes > 0 {
+        unsafe {
+            let len = chars_in_text(string.as_ptr(), nbytes);
+            insert_1_both(
+                string.as_ptr() as *const c_char,
+                len,
+                nbytes,
+                false,
+                true,
+                true,
+            );
+
+            let pt = point() as isize;
+            let opoint = pt - len;
+            signal_after_change(opoint, 0, len);
+            update_compositions(opoint, pt, CHECK_BORDER as i32);
+        }
+    }
+}
+
+/// Likewise, but inherit text properties from neighboring characters.
+pub fn insert_before_markers_and_inherit(string: &[u8]) {
+    let nbytes = string.len() as isize;
+    if nbytes > 0 {
+        unsafe {
+            let len = chars_in_text(string.as_ptr(), nbytes);
+            insert_1_both(
+                string.as_ptr() as *const c_char,
+                len,
+                nbytes,
+                true,
+                true,
+                true,
+            );
+
+            let pt = point() as isize;
+            let opoint = pt - len;
+            signal_after_change(opoint, 0, len);
+            update_compositions(opoint, pt, CHECK_BORDER as i32);
+        }
+    }
+}
+
 include!(concat!(env!("OUT_DIR"), "/editfns_exports.rs"));
diff --git a/src/insdel.c b/src/insdel.c
index 47d0fd8e08..789fa176c4 100644
--- a/src/insdel.c
+++ b/src/insdel.c
@@ -651,42 +651,6 @@ copy_text (const unsigned char *from_addr, unsigned char *to_addr,
     }
 }
 
-/* Insert a string of specified length before point.
-   This function judges multibyteness based on
-   enable_multibyte_characters in the current buffer;
-   it never converts between single-byte and multibyte.
-
-   DO NOT use this for the contents of a Lisp string or a Lisp buffer!
-   prepare_to_modify_buffer could relocate the text.  */
-
-void
-insert (const char *string, ptrdiff_t nbytes)
-{
-  if (nbytes > 0)
-    {
-      ptrdiff_t len = chars_in_text ((unsigned char *) string, nbytes), opoint;
-      insert_1_both (string, len, nbytes, 0, 1, 0);
-      opoint = PT - len;
-      signal_after_change (opoint, 0, len);
-      update_compositions (opoint, PT, CHECK_BORDER);
-    }
-}
-
-/* Likewise, but inherit text properties from neighboring characters.  */
-
-void
-insert_and_inherit (const char *string, ptrdiff_t nbytes)
-{
-  if (nbytes > 0)
-    {
-      ptrdiff_t len = chars_in_text ((unsigned char *) string, nbytes), opoint;
-      insert_1_both (string, len, nbytes, 1, 1, 0);
-      opoint = PT - len;
-      signal_after_change (opoint, 0, len);
-      update_compositions (opoint, PT, CHECK_BORDER);
-    }
-}
-
 /* Insert the character C before point.  Do not inherit text properties.  */
 
 void
@@ -714,40 +678,6 @@ insert_string (const char *s)
   insert (s, strlen (s));
 }
 
-/* Like `insert' except that all markers pointing at the place where
-   the insertion happens are adjusted to point after it.
-   Don't use this function to insert part of a Lisp string,
-   since gc could happen and relocate it.  */
-
-void
-insert_before_markers (const char *string, ptrdiff_t nbytes)
-{
-  if (nbytes > 0)
-    {
-      ptrdiff_t len = chars_in_text ((unsigned char *) string, nbytes), opoint;
-      insert_1_both (string, len, nbytes, 0, 1, 1);
-      opoint = PT - len;
-      signal_after_change (opoint, 0, len);
-      update_compositions (opoint, PT, CHECK_BORDER);
-    }
-}
-
-/* Likewise, but inherit text properties from neighboring characters.  */
-
-void
-insert_before_markers_and_inherit (const char *string,
-				   ptrdiff_t nbytes)
-{
-  if (nbytes > 0)
-    {
-      ptrdiff_t len = chars_in_text ((unsigned char *) string, nbytes), opoint;
-      insert_1_both (string, len, nbytes, 1, 1, 1);
-      opoint = PT - len;
-      signal_after_change (opoint, 0, len);
-      update_compositions (opoint, PT, CHECK_BORDER);
-    }
-}
-
 #ifdef BYTE_COMBINING_DEBUG
 
 /* See if the bytes before POS/POS_BYTE combine with bytes
diff --git a/src/lisp.h b/src/lisp.h
index 881499b792..94836fc57b 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -3594,7 +3594,6 @@ extern int count_combining_before (const unsigned char *,
 extern int count_combining_after (const unsigned char *,
 				  ptrdiff_t, ptrdiff_t, ptrdiff_t);
 extern void insert (const char *, ptrdiff_t);
-extern void insert_and_inherit (const char *, ptrdiff_t);
 extern void insert_1_both (const char *, ptrdiff_t, ptrdiff_t,
 			   bool, bool, bool);
 extern void insert_from_gap (ptrdiff_t, ptrdiff_t, bool text_at_gap_tail);
@@ -3606,7 +3605,6 @@ extern void insert_from_buffer (struct buffer *, ptrdiff_t, ptrdiff_t, bool);
 extern void insert_char (int);
 extern void insert_string (const char *);
 extern void insert_before_markers (const char *, ptrdiff_t);
-extern void insert_before_markers_and_inherit (const char *, ptrdiff_t);
 extern void insert_from_string_before_markers (Lisp_Object, ptrdiff_t,
 					       ptrdiff_t, ptrdiff_t,
 					       ptrdiff_t, bool);
-- 
2.21.0


From 2128dfd23797cd1597ea60d5ba3424f5a04f8ee7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Carlos=20Mart=C3=ADn=20Nieto?= <cmn@dwim.me>
Date: Mon, 24 Dec 2018 12:00:38 +0000
Subject: [PATCH 208/297] Remove some unsafety from insert functions

Provide safe-marked wrappers for `insret_from_string` and
`insert_from_string_before_markers` so that `general_insert_function`
can be safe and use `Fn` for both kinds of callbacks, removing some
`unsafe` blocks from our lisp functions.
---
 rust_src/src/editfns.rs | 70 +++++++++++++++++++++++++----------------
 1 file changed, 43 insertions(+), 27 deletions(-)

diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index eacdfe2094..e4646d5f27 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -1465,7 +1465,7 @@ pub fn widen() {
 /// usage: (insert &rest ARGS)
 #[lisp_fn(name = "insert", c_name = "insert")]
 pub fn insert_lisp(args: &[LispObject]) {
-    unsafe { general_insert_function(insert_slice, insert_from_string, false, args) };
+    general_insert_function(insert_slice, insert_from_string_safe, false, args);
 }
 
 /// Insert the arguments at point, inheriting properties from adjoining text.  Point and
@@ -1479,7 +1479,7 @@ pub fn insert_lisp(args: &[LispObject]) {
 /// usage: (insert-and-inherit &rest ARGS)
 #[lisp_fn(name = "insert-and-inherit", c_name = "insert_and_inherit")]
 pub fn insert_and_inherit_lisp(args: &[LispObject]) {
-    unsafe { general_insert_function(insert_and_inherit, insert_from_string, true, args) };
+    general_insert_function(insert_and_inherit, insert_from_string_safe, true, args);
 }
 
 /// Insert strings or characters at point, relocating markers after the text.  Point and markers
@@ -1495,14 +1495,12 @@ pub fn insert_and_inherit_lisp(args: &[LispObject]) {
 /// usage: (insert-before-markers &rest ARGS)
 #[lisp_fn(name = "insert-before-markers", c_name = "insert_before_markers")]
 pub fn insert_before_markers_lisp(args: &[LispObject]) {
-    unsafe {
-        general_insert_function(
-            insert_before_markers,
-            insert_from_string_before_markers,
-            false,
-            args,
-        )
-    };
+    general_insert_function(
+        insert_before_markers,
+        insert_from_string_before_markers_safe,
+        false,
+        args,
+    );
 }
 
 /// Insert text at point, relocating markers and inheriting properties.  Point and markers move
@@ -1518,14 +1516,12 @@ pub fn insert_before_markers_lisp(args: &[LispObject]) {
     c_name = "insert_and_inherit_before_markers"
 )]
 pub fn insert_and_inherit_before_markers_lisp(args: &[LispObject]) {
-    unsafe {
-        general_insert_function(
-            insert_before_markers_and_inherit,
-            insert_from_string_before_markers,
-            true,
-            args,
-        )
-    };
+    general_insert_function(
+        insert_before_markers_and_inherit,
+        insert_from_string_before_markers_safe,
+        true,
+        args,
+    );
 }
 
 /// Insert the part of the text of STRING, a Lisp object assumed to be of type string, consisting
@@ -1557,6 +1553,18 @@ pub unsafe extern "C" fn insert_from_string(
     update_compositions(opoint, current_buffer.pt, CHECK_BORDER as i32);
 }
 
+/// A safe-marked version of insert_from_string
+fn insert_from_string_safe(
+    string: LispObject,
+    pos: ptrdiff_t,
+    pos_byte: ptrdiff_t,
+    length: ptrdiff_t,
+    length_byte: ptrdiff_t,
+    inherit: bool,
+) {
+    unsafe { insert_from_string(string, pos, pos_byte, length, length_byte, inherit) };
+}
+
 /// Like `insert_from_string' except that all markers pointing at the place where the insertion
 /// happens are adjusted to point after it.
 #[no_mangle]
@@ -1581,23 +1589,31 @@ pub unsafe extern "C" fn insert_from_string_before_markers(
     update_compositions(opoint, current_buffer.pt, CHECK_BORDER as i32);
 }
 
+/// A safe-marked version of insert_from_string_before_markers
+fn insert_from_string_before_markers_safe(
+    string: LispObject,
+    pos: ptrdiff_t,
+    pos_byte: ptrdiff_t,
+    length: ptrdiff_t,
+    length_byte: ptrdiff_t,
+    inherit: bool,
+) {
+    unsafe {
+        insert_from_string_before_markers(string, pos, pos_byte, length, length_byte, inherit)
+    };
+}
+
 /// Insert NARGS Lisp objects in the array ARGS by calling INSERT_FUNC (if a type of object is
 /// Lisp_Int) or INSERT_FROM_STRING_FUNC (if a type of object is Lisp_String).  INHERIT is passed
 /// to INSERT_FROM_STRING_FUNC as the last argument
-unsafe fn general_insert_function<IF>(
+fn general_insert_function<IF, IFSF>(
     insert_func: IF,
-    insert_from_string_func: unsafe extern "C" fn(
-        LispObject,
-        ptrdiff_t,
-        ptrdiff_t,
-        ptrdiff_t,
-        ptrdiff_t,
-        bool,
-    ),
+    insert_from_string_func: IFSF,
     inherit: bool,
     args: &[LispObject],
 ) where
     IF: Fn(&[u8]),
+    IFSF: Fn(LispObject, ptrdiff_t, ptrdiff_t, ptrdiff_t, ptrdiff_t, bool),
 {
     for &val in args {
         if val.is_character() {
-- 
2.21.0


From 37ecb3c26d74f4d3d2b12d163eed7f22ec6613ec Mon Sep 17 00:00:00 2001
From: Nick Drozd <nicholasdrozd@gmail.com>
Date: Thu, 10 Jan 2019 18:37:24 -0600
Subject: [PATCH 209/297] Address some Clippy complaints

This doesn't take care of everything.
---
 rust_src/src/editfns.rs | 10 ++++++----
 rust_src/src/lists.rs   |  2 +-
 rust_src/src/marker.rs  | 13 +++++--------
 rust_src/src/windows.rs |  6 +++---
 4 files changed, 15 insertions(+), 16 deletions(-)

diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index f7025252d4..2e1657408a 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -896,13 +896,15 @@ pub fn insert_buffer_substring(
 /// usage: (message FORMAT-STRING &rest ARGS)
 #[lisp_fn(min = "1")]
 pub fn message(args: &mut [LispObject]) -> LispObject {
-    if args[0].is_nil()
-        || args[0]
+    let format_string = args[0];
+
+    if format_string.is_nil()
+        || format_string
             .as_string()
-            .map_or(false, |mut s| unsafe { STRING_BYTES(s.as_mut()) == 0 })
+            .map_or(false, |mut s| unsafe { STRING_BYTES(s.as_mut()) } == 0)
     {
         unsafe { message1(ptr::null_mut()) };
-        args[0]
+        format_string
     } else {
         let val = format_message(args);
         unsafe { message3(val) };
diff --git a/rust_src/src/lists.rs b/rust_src/src/lists.rs
index 3667944ad0..9e066cc422 100644
--- a/rust_src/src/lists.rs
+++ b/rust_src/src/lists.rs
@@ -955,7 +955,7 @@ pub extern "C" fn mapcar1(
             output,
             fun,
             s.char_indices()
-                .map(|(_, c)| LispObject::from_fixnum(c as EmacsInt)),
+                .map(|(_, c)| LispObject::from_fixnum(EmacsInt::from(c))),
         );
     }
 
diff --git a/rust_src/src/marker.rs b/rust_src/src/marker.rs
index 1ce25cf2dc..7bfe4b37a9 100644
--- a/rust_src/src/marker.rs
+++ b/rust_src/src/marker.rs
@@ -316,14 +316,11 @@ pub fn buffer_has_markers_at(position: EmacsInt) -> bool {
     let cur_buf = ThreadState::current_buffer_unchecked();
     let position = clip_to_bounds(cur_buf.begv, position, cur_buf.zv);
 
-    if let Some(marker) = cur_buf.markers() {
-        for m in marker.iter() {
-            if m.charpos().map_or(false, |p| p == position) {
-                return true;
-            }
-        }
-    }
-    false
+    cur_buf.markers().map_or(false, |marker| {
+        marker
+            .iter()
+            .any(|m| m.charpos().map_or(false, |p| p == position))
+    })
 }
 
 /// Change M so it points to B at CHARPOS and BYTEPOS.
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 59f52989b1..bba2036783 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -1095,10 +1095,10 @@ pub fn set_window_new_total(
 ) -> LispObject {
     let mut win: LispWindowRef = window.into();
 
-    let new_total = if !add {
-        size
-    } else {
+    let new_total = if add {
         EmacsInt::from(win.new_total) + size
+    } else {
+        size
     };
     win.new_total = new_total.into();
     win.new_total
-- 
2.21.0


From 817af4c1febba0d27c7267b8a1364d1fd8755ad9 Mon Sep 17 00:00:00 2001
From: Nick Drozd <nicholasdrozd@gmail.com>
Date: Thu, 10 Jan 2019 18:39:19 -0600
Subject: [PATCH 210/297] Fix C compiler warnings

Unused function, unused label, missing / duplicate declarations
---
 src/chartab.c | 1 -
 src/editfns.c | 2 ++
 src/fns.c     | 1 -
 src/keymap.c  | 6 ------
 src/lisp.h    | 2 --
 5 files changed, 2 insertions(+), 10 deletions(-)

diff --git a/src/chartab.c b/src/chartab.c
index 23ffc1a374..c10d9dd685 100644
--- a/src/chartab.c
+++ b/src/chartab.c
@@ -60,7 +60,6 @@ static const int chartab_bits[4] =
 typedef Lisp_Object (*uniprop_decoder_t) (Lisp_Object, Lisp_Object);
 typedef Lisp_Object (*uniprop_encoder_t) (Lisp_Object, Lisp_Object);
 
-Lisp_Object uniprop_table_uncompress (Lisp_Object, int);
 static uniprop_decoder_t uniprop_get_decoder (Lisp_Object);
 
 /* 1 iff TABLE is a uniprop table.  */
diff --git a/src/editfns.c b/src/editfns.c
index 041af87acd..b0b9527f9a 100644
--- a/src/editfns.c
+++ b/src/editfns.c
@@ -78,6 +78,8 @@ void update_buffer_properties (ptrdiff_t, ptrdiff_t);
 
 void find_field (Lisp_Object, Lisp_Object, Lisp_Object, ptrdiff_t *, Lisp_Object, ptrdiff_t *);
 
+void general_insert_function (void (*) (const char *, ptrdiff_t), void (*) (Lisp_Object, ptrdiff_t, ptrdiff_t, ptrdiff_t, ptrdiff_t, bool), bool, ptrdiff_t, Lisp_Object *);
+
 #ifndef HAVE_TM_GMTOFF
 # define HAVE_TM_GMTOFF false
 #endif
diff --git a/src/fns.c b/src/fns.c
index b9854768a2..5fc4057725 100644
--- a/src/fns.c
+++ b/src/fns.c
@@ -1340,7 +1340,6 @@ bool
 internal_equal (Lisp_Object o1, Lisp_Object o2, enum equal_kind equal_kind,
 		int depth, Lisp_Object ht)
 {
- tail_recurse:
   if (depth > 10)
     {
       eassert (equal_kind != EQUAL_NO_QUIT);
diff --git a/src/keymap.c b/src/keymap.c
index 982cccea71..460f5ae069 100644
--- a/src/keymap.c
+++ b/src/keymap.c
@@ -93,12 +93,6 @@ static Lisp_Object get_keyelt (Lisp_Object, bool);
 
 void map_keymap_item (map_keymap_function_t, Lisp_Object, Lisp_Object, Lisp_Object, void *);
 void map_keymap_char_table_item (Lisp_Object, Lisp_Object, Lisp_Object);
-
-static void
-CHECK_VECTOR_OR_CHAR_TABLE (Lisp_Object x)
-{
-  CHECK_TYPE (VECTORP (x) || CHAR_TABLE_P (x), Qvector_or_char_table_p, x);
-}
 
 
 /* This function is used for installing the standard key bindings
diff --git a/src/lisp.h b/src/lisp.h
index 5147224da8..ec623464ab 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -4509,8 +4509,6 @@ extern _Noreturn void fatal (const char *msgid, ...)
 /* Defined in terminal.c.  */
 extern struct terminal *
 decode_terminal (Lisp_Object terminal);
-extern struct terminal *
-decode_live_terminal (Lisp_Object terminal);
 extern void syms_of_terminal (void);
 
 /* Defined in font.c.  */
-- 
2.21.0


From 79c95b3a6fc82ad26ed513b19a034bd641da16f5 Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Tue, 15 Jan 2019 13:54:43 +0100
Subject: [PATCH 211/297] Port close-font (#1161)

Port the lisp function close-font, solving #1013. To achieve this, the
LispFrameLiveOrSelected and FontObjectRef types were added.
---
 configure.ac               | 15 +++++++-
 rust_src/Cargo.toml.in     |  8 ++++
 rust_src/src/fonts.rs      | 75 +++++++++++++++++++++++++++++++++++++-
 rust_src/src/frames.rs     | 15 ++++++++
 rust_src/src/remacs_sys.rs |  1 +
 src/font.c                 | 29 ---------------
 6 files changed, 112 insertions(+), 31 deletions(-)

diff --git a/configure.ac b/configure.ac
index 9310a70a40..5899c0f0a3 100644
--- a/configure.ac
+++ b/configure.ac
@@ -5465,7 +5465,20 @@ if test "$CANNOT_DUMP" != "yes"; then
         CARGO_DEFAULT_FEATURES="${CARGO_DEFAULT_FEATURES}\"unexec\", "
     fi
 fi
-
+if test "$window_system" != "none"; then
+    CARGO_DEFAULT_FEATURES="${CARGO_DEFAULT_FEATURES}\"window-system\", "
+fi
+case "$window_system" in
+    x11)
+        CARGO_DEFAULT_FEATURES="${CARGO_DEFAULT_FEATURES}\"window-system-x11\", "
+    ;;
+    nextstep)
+	CARGO_DEFAULT_FEATURES="${CARGO_DEFAULT_FEATURES}\"window-system-nextstep\", "
+    ;;
+    w32)
+        CARGO_DEFAULT_FEATURES="${CARGO_DEFAULT_FEATURES}\"window-system-w32\", "
+    ;;
+esac
 AC_SUBST(CARGO_DEFAULT_FEATURES)
 AC_CONFIG_FILES([rust_src/Cargo.toml])
 
diff --git a/rust_src/Cargo.toml.in b/rust_src/Cargo.toml.in
index 9910812578..588853b2a4 100644
--- a/rust_src/Cargo.toml.in
+++ b/rust_src/Cargo.toml.in
@@ -54,6 +54,14 @@ unexecmacosx = ["alloc_unexecmacosx"]
 unexec = []
 # Compile with C xml2 library support.
 use-xml2 = []
+# Use a window system
+window-system = []
+# Use the x11 window system
+window-system-x11 = []
+# Use the nextstep window system
+window-system-nextstep = []
+# Use the w32 window system
+window-system-w32 = []
 compile-errors = []
 # Treat warnings as a build error on Travis.
 strict = []
diff --git a/rust_src/src/fonts.rs b/rust_src/src/fonts.rs
index 2eed06b1c1..bce1e105eb 100644
--- a/rust_src/src/fonts.rs
+++ b/rust_src/src/fonts.rs
@@ -2,12 +2,18 @@
 
 use remacs_macros::lisp_fn;
 
+use std::{ffi::CString, mem};
+
 use crate::{
+    data,
+    frames::{LispFrameLiveOrSelected, LispFrameRef},
     lisp::defsubr,
-    lisp::LispObject,
+    lisp::{ExternalPtr, LispObject},
     obarray::intern,
     remacs_sys::font_match_p as c_font_match_p,
+    remacs_sys::font_property_index::FONT_TYPE_INDEX,
     remacs_sys::Flist_fonts,
+    remacs_sys::{font_add_log, Lisp_Font_Object, Lisp_Type},
     remacs_sys::{pvec_type, FONT_ENTITY_MAX, FONT_OBJECT_MAX, FONT_SPEC_MAX},
     remacs_sys::{EmacsInt, Qfont, Qfont_entity, Qfont_object, Qfont_spec, Qnil},
     vectors::LispVectorlikeRef,
@@ -97,6 +103,66 @@ impl FontExtraType {
     }
 }
 
+pub type LispFontObjectRef = ExternalPtr<Lisp_Font_Object>;
+
+impl LispFontObjectRef {
+    pub fn add_log(self, action: &str, result: LispObject) {
+        let c_str = CString::new(action).unwrap();
+        unsafe { font_add_log(c_str.as_ptr(), self.into(), result) }
+    }
+
+    pub fn close(mut self, mut _frame: LispFrameRef) {
+        if data::aref(self.into(), FONT_TYPE_INDEX.into()).is_nil() {
+            // Already closed
+            return;
+        }
+        self.add_log("close", LispObject::from(false));
+        unsafe {
+            if let Some(f) = (*self.driver).close {
+                f(self.as_mut())
+            }
+            #[cfg(feature = "window-system")]
+            {
+                #[cfg(feature = "window-system-x11")]
+                let mut display_info = &mut *(*_frame.output_data.x).display_info;
+                #[cfg(feature = "window-system-nextstep")]
+                let mut display_info = &mut *(*_frame.output_data.ns).display_info;
+                #[cfg(feature = "window-system-w32")]
+                let mut display_info = &mut *(*_frame.output_data.w32).display_info;
+                debug_assert!(display_info.n_fonts > 0);
+                display_info.n_fonts -= 1;
+            }
+        }
+    }
+}
+
+impl From<LispFontObjectRef> for LispObject {
+    fn from(f: LispFontObjectRef) -> Self {
+        LispObject::tag_ptr(f, Lisp_Type::Lisp_Vectorlike)
+    }
+}
+
+impl From<LispObject> for LispFontObjectRef {
+    fn from(o: LispObject) -> Self {
+        match o.into() {
+            Some(font) => font,
+            None => wrong_type!(Qfont_object, o),
+        }
+    }
+}
+
+impl From<LispObject> for Option<LispFontObjectRef> {
+    fn from(o: LispObject) -> Self {
+        o.as_vectorlike().and_then(|v| {
+            if v.is_pseudovector(pvec_type::PVEC_FONT) && o.is_font_object() {
+                Some(unsafe { mem::transmute(o) })
+            } else {
+                None
+            }
+        })
+    }
+}
+
 /// Return t if OBJECT is a font-spec, font-entity, or font-object.
 /// Return nil otherwise.
 /// Optional 2nd argument EXTRA-TYPE, if non-nil, specifies to check
@@ -143,4 +209,11 @@ pub fn find_font(spec: LispObject, frame: LispObject) -> LispObject {
     }
 }
 
+/// Close FONT-OBJECT
+#[lisp_fn(min = "1")]
+pub fn close_font(font_object: LispFontObjectRef, frame: LispFrameLiveOrSelected) {
+    let frame: LispFrameRef = frame.into();
+    font_object.close(frame)
+}
+
 include!(concat!(env!("OUT_DIR"), "/fonts_exports.rs"));
diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index 0885033dc1..aeda08c278 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -125,6 +125,21 @@ impl LispFrameOrSelected {
     }
 }
 
+#[derive(Clone, Copy)]
+pub struct LispFrameLiveOrSelected(LispFrameRef);
+
+impl From<LispObject> for LispFrameLiveOrSelected {
+    fn from(obj: LispObject) -> Self {
+        LispFrameLiveOrSelected(obj.map_or_else(selected_frame, |f| f.as_live_frame_or_error()))
+    }
+}
+
+impl From<LispFrameLiveOrSelected> for LispFrameRef {
+    fn from(f: LispFrameLiveOrSelected) -> Self {
+        f.0
+    }
+}
+
 pub fn window_frame_live_or_selected(object: LispObject) -> LispFrameRef {
     // Cannot use LispFrameOrSelected because the selected frame is not
     // checked for live.
diff --git a/rust_src/src/remacs_sys.rs b/rust_src/src/remacs_sys.rs
index a04afeeac1..fc8560cfc1 100755
--- a/rust_src/src/remacs_sys.rs
+++ b/rust_src/src/remacs_sys.rs
@@ -141,6 +141,7 @@ pub const WAIT_READING_MAX: i64 = std::i64::MAX;
 unsafe impl Sync for Lisp_Subr {}
 
 pub type Lisp_Buffer = buffer;
+pub type Lisp_Font_Object = font;
 pub type Lisp_Frame = frame;
 pub type Lisp_Glyph = glyph;
 pub type Lisp_Terminal = terminal;
diff --git a/src/font.c b/src/font.c
index 4561ea7bc0..3797546dda 100644
--- a/src/font.c
+++ b/src/font.c
@@ -2946,25 +2946,6 @@ font_open_entity (struct frame *f, Lisp_Object entity, int pixel_size)
 }
 
 
-/* Close FONT_OBJECT that is opened on frame F.  */
-
-static void
-font_close_object (struct frame *f, Lisp_Object font_object)
-{
-  struct font *font = XFONT_OBJECT (font_object);
-
-  if (NILP (AREF (font_object, FONT_TYPE_INDEX)))
-    /* Already closed.  */
-    return;
-  FONT_ADD_LOG ("close", font_object, Qnil);
-  font->driver->close (font);
-#ifdef HAVE_WINDOW_SYSTEM
-  eassert (FRAME_DISPLAY_INFO (f)->n_fonts);
-  FRAME_DISPLAY_INFO (f)->n_fonts--;
-#endif
-}
-
-
 /* Return 1 if FONT on F has a glyph for character C, 0 if not, -1 if
    FONT is a font-entity and it must be opened to check.  */
 
@@ -4724,15 +4705,6 @@ DEFUN ("open-font", Fopen_font, Sopen_font, 1, 3, 0,
   return font_open_entity (f, font_entity, isize);
 }
 
-DEFUN ("close-font", Fclose_font, Sclose_font, 1, 2, 0,
-       doc: /* Close FONT-OBJECT.  */)
-  (Lisp_Object font_object, Lisp_Object frame)
-{
-  CHECK_FONT_OBJECT (font_object);
-  font_close_object (decode_live_frame (frame), font_object);
-  return Qnil;
-}
-
 DEFUN ("query-font", Fquery_font, Squery_font, 1, 1, 0,
        doc: /* Return information about FONT-OBJECT.
 The value is a vector:
@@ -5339,7 +5311,6 @@ syms_of_font (void)
 
 #ifdef FONT_DEBUG
   defsubr (&Sopen_font);
-  defsubr (&Sclose_font);
   defsubr (&Squery_font);
   defsubr (&Sfont_get_glyphs);
   defsubr (&Sfont_at);
-- 
2.21.0


From b19b27a1d4c9704c9a2eb259480c92ebe9ab047b Mon Sep 17 00:00:00 2001
From: Nick Drozd <nicholasdrozd@gmail.com>
Date: Tue, 15 Jan 2019 07:22:27 -0600
Subject: [PATCH 212/297] impl Display for LispObject, cut as_string_or_error
 (#1237)

---
 rust_src/src/crypto/mod.rs  |  2 +-
 rust_src/src/editfns.rs     |  2 +-
 rust_src/src/eval.rs        |  9 ++++-----
 rust_src/src/eval_macros.rs |  8 ++++----
 rust_src/src/fns.rs         | 12 ++++--------
 rust_src/src/lisp.rs        | 10 +++++++++-
 rust_src/src/multibyte.rs   |  4 ----
 rust_src/src/process.rs     | 14 ++++----------
 8 files changed, 27 insertions(+), 34 deletions(-)

diff --git a/rust_src/src/crypto/mod.rs b/rust_src/src/crypto/mod.rs
index 608917fc85..189bcc727a 100755
--- a/rust_src/src/crypto/mod.rs
+++ b/rust_src/src/crypto/mod.rs
@@ -57,7 +57,7 @@ fn hash_alg(algorithm: LispSymbolRef) -> HashAlg {
         Qsha384 => HashAlg::SHA384,
         Qsha512 => HashAlg::SHA512,
         _ => {
-            let name = symbol_name(algorithm).as_string_or_error();
+            let name: LispStringRef = symbol_name(algorithm).into();
             error!("Invalid algorithm arg: {:?}\0", &name.as_slice());
         }
     }
diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index 2e1657408a..c16e36f271 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -420,7 +420,7 @@ pub fn propertize(args: &[LispObject]) -> LispObject {
 
     // the unwrap call is safe, the number of args has already been checked
     let first = it.next().unwrap();
-    let orig_string = first.as_string_or_error();
+    let orig_string = LispStringRef::from(*first);
 
     let copy = unsafe { Fcopy_sequence(*first) };
 
diff --git a/rust_src/src/eval.rs b/rust_src/src/eval.rs
index 52b4767959..d209daa87b 100644
--- a/rust_src/src/eval.rs
+++ b/rust_src/src/eval.rs
@@ -231,8 +231,7 @@ pub fn function(args: LispCons) -> LispObject {
                         // Handle the special (:documentation <form>) to build the docstring
                         // dynamically.
 
-                        let docstring = unsafe { eval_sub(car(tail)) };
-                        docstring.as_string_or_error();
+                        let docstring: LispStringRef = unsafe { eval_sub(car(tail)) }.into();
                         let (a, b) = cdr.into();
                         let (_, bd) = b.into();
                         cdr = (a, (docstring, bd)).into();
@@ -791,7 +790,7 @@ pub fn autoload_do_load(
         if globals.Vpurify_flag.is_not_nil() {
             error!(
                 "Attempt to autoload {} while preparing to dump",
-                sym.symbol_name().as_string_or_error()
+                sym.symbol_name()
             );
         }
 
@@ -837,8 +836,8 @@ pub fn autoload_do_load(
         if equal(fun, fundef) {
             error!(
                 "Autoloading file {} failed to define function {}",
-                car(car(unsafe { globals.Vload_history })).as_string_or_error(),
-                sym.symbol_name().as_string_or_error()
+                car(car(unsafe { globals.Vload_history })),
+                sym.symbol_name()
             );
         } else {
             fun
diff --git a/rust_src/src/eval_macros.rs b/rust_src/src/eval_macros.rs
index 05503a6fa1..8ceafce3c3 100644
--- a/rust_src/src/eval_macros.rs
+++ b/rust_src/src/eval_macros.rs
@@ -343,10 +343,10 @@ macro_rules! local_unibyte_string {
 pub fn test_local_unibyte_string() {
     let mut s = String::from("abc");
     local_unibyte_string!(a, s);
-    assert_eq!(a.as_string_or_error().byte_at(0), b'a');
-    assert_eq!(a.as_string_or_error().len_chars(), 3);
+    assert_eq!(crate::multibyte::LispStringRef::from(a).byte_at(0), b'a');
+    assert_eq!(crate::multibyte::LispStringRef::from(a).len_chars(), 3);
     s = String::from("defg");
     local_unibyte_string!(a, s);
-    assert_eq!(a.as_string_or_error().byte_at(0), b'd');
-    assert_eq!(a.as_string_or_error().len_chars(), 4);
+    assert_eq!(crate::multibyte::LispStringRef::from(a).byte_at(0), b'd');
+    assert_eq!(crate::multibyte::LispStringRef::from(a).len_chars(), 4);
 }
diff --git a/rust_src/src/fns.rs b/rust_src/src/fns.rs
index f293d9c762..5126aa4fbf 100644
--- a/rust_src/src/fns.rs
+++ b/rust_src/src/fns.rs
@@ -166,7 +166,7 @@ pub fn require(feature: LispObject, filename: LispObject, noerror: LispObject) -
     if unsafe { globals.Vpurify_flag.is_not_nil() } {
         error!(
             "(require {}) while preparing to dump",
-            feature_sym.symbol_name().as_string_or_error()
+            feature_sym.symbol_name()
         );
     }
 
@@ -181,7 +181,7 @@ pub fn require(feature: LispObject, filename: LispObject, noerror: LispObject) -
     if nesting > 3 {
         error!(
             "Recursive `require' for feature `{}'",
-            feature_sym.symbol_name().as_string_or_error()
+            feature_sym.symbol_name()
         );
     }
 
@@ -218,16 +218,12 @@ pub fn require(feature: LispObject, filename: LispObject, noerror: LispObject) -
         let tem3 = car(car(unsafe { globals.Vload_history }));
 
         if tem3.is_nil() {
-            error!(
-                "Required feature `{}' was not provided",
-                feature.as_string_or_error()
-            );
+            error!("Required feature `{}' was not provided", feature);
         } else {
             // Cf autoload-do-load.
             error!(
                 "Loading file {} failed to provide feature `{}'",
-                tem3.as_string_or_error(),
-                feature.as_string_or_error()
+                tem3, feature
             );
         }
     }
diff --git a/rust_src/src/lisp.rs b/rust_src/src/lisp.rs
index cf345e6821..e969cf60b2 100644
--- a/rust_src/src/lisp.rs
+++ b/rust_src/src/lisp.rs
@@ -3,7 +3,8 @@
 
 use std::convert::From;
 use std::ffi::CString;
-use std::fmt::{Debug, Error, Formatter};
+use std::fmt;
+use std::fmt::{Debug, Display, Error, Formatter};
 use std::mem;
 use std::ops::{Deref, DerefMut};
 
@@ -13,6 +14,7 @@ use crate::{
     buffers::LispBufferRef,
     eval::FUNCTIONP,
     lists::{list, CarIter, LispConsCircularChecks, LispConsEndChecks},
+    multibyte::LispStringRef,
     process::LispProcessRef,
     remacs_sys::{build_string, internal_equal, make_float},
     remacs_sys::{
@@ -608,6 +610,12 @@ impl LispObject {
 /// of arguments.
 pub const MANY: i16 = -2;
 
+impl Display for LispObject {
+    fn fmt(&self, f: &mut Formatter) -> fmt::Result {
+        write!(f, "{}", LispStringRef::from(*self))
+    }
+}
+
 impl Debug for LispObject {
     fn fmt(&self, f: &mut Formatter) -> Result<(), Error> {
         let ty = self.get_type();
diff --git a/rust_src/src/multibyte.rs b/rust_src/src/multibyte.rs
index e7dfedf271..36be421040 100644
--- a/rust_src/src/multibyte.rs
+++ b/rust_src/src/multibyte.rs
@@ -296,10 +296,6 @@ impl LispObject {
         self.into()
     }
 
-    pub fn as_string_or_error(self) -> LispStringRef {
-        self.into()
-    }
-
     pub unsafe fn to_string_unchecked(self) -> LispStringRef {
         LispStringRef::new(self.get_untaggedptr() as *mut Lisp_String)
     }
diff --git a/rust_src/src/process.rs b/rust_src/src/process.rs
index 6ce9c43bbe..305dac42bd 100644
--- a/rust_src/src/process.rs
+++ b/rust_src/src/process.rs
@@ -93,7 +93,7 @@ pub extern "C" fn get_process(name: LispObject) -> LispObject {
 
         if obj.is_nil() {
             obj = get_buffer(LispBufferOrName::from(name)).map_or_else(
-                || error!("Process {} does not exist", name.as_string_or_error()),
+                || error!("Process {} does not exist", name),
                 LispObject::from,
             );
         }
@@ -134,7 +134,7 @@ pub fn get_process_lisp(name: LispObject) -> LispObject {
     if name.is_process() {
         name
     } else {
-        name.as_string_or_error();
+        LispStringRef::from(name);
         cdr(assoc(name, unsafe { Vprocess_alist }, Qnil))
     }
 }
@@ -501,16 +501,10 @@ pub fn process_running_child_p(mut process: LispObject) -> LispObject {
     let mut proc_ref = process.as_process_or_error();
 
     if !proc_ref.ptype().eq(Qreal) {
-        error!(
-            "Process {} is not a subprocess.",
-            proc_ref.name.as_string_or_error()
-        );
+        error!("Process {} is not a subprocess.", proc_ref.name);
     }
     if proc_ref.infd < 0 {
-        error!(
-            "Process {} is not active.",
-            proc_ref.name.as_string_or_error()
-        );
+        error!("Process {} is not active.", proc_ref.name);
     }
 
     let gid = unsafe { emacs_get_tty_pgrp(proc_ref.as_mut()) };
-- 
2.21.0


From 8139f451aff4e43620c0b2771148d44d70321ecb Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Mon, 24 Dec 2018 15:52:08 +0100
Subject: [PATCH 213/297] port font-at

---
 rust_src/src/fonts.rs | 56 ++++++++++++++++++++++++++++++++++++++++---
 src/font.c            | 32 +------------------------
 src/font.h            |  2 ++
 3 files changed, 56 insertions(+), 34 deletions(-)

diff --git a/rust_src/src/fonts.rs b/rust_src/src/fonts.rs
index bce1e105eb..21e96b5ad1 100644
--- a/rust_src/src/fonts.rs
+++ b/rust_src/src/fonts.rs
@@ -1,5 +1,7 @@
 //! font support
 
+use std::ptr;
+
 use remacs_macros::lisp_fn;
 
 use std::{ffi::CString, mem};
@@ -12,11 +14,14 @@ use crate::{
     obarray::intern,
     remacs_sys::font_match_p as c_font_match_p,
     remacs_sys::font_property_index::FONT_TYPE_INDEX,
-    remacs_sys::Flist_fonts,
-    remacs_sys::{font_add_log, Lisp_Font_Object, Lisp_Type},
-    remacs_sys::{pvec_type, FONT_ENTITY_MAX, FONT_OBJECT_MAX, FONT_SPEC_MAX},
+    remacs_sys::{font_add_log, font_at, Flist_fonts},
+    remacs_sys::{
+        pvec_type, Lisp_Font_Object, Lisp_Type, FONT_ENTITY_MAX, FONT_OBJECT_MAX, FONT_SPEC_MAX,
+    },
     remacs_sys::{EmacsInt, Qfont, Qfont_entity, Qfont_object, Qfont_spec, Qnil},
+    threads::ThreadState,
     vectors::LispVectorlikeRef,
+    windows::{LispWindowLiveOrSelected, LispWindowRef},
 };
 
 // A font is not a type in and of itself, it's just a group of three kinds of
@@ -216,4 +221,49 @@ pub fn close_font(font_object: LispFontObjectRef, frame: LispFrameLiveOrSelected
     font_object.close(frame)
 }
 
+/// Return a font-object for displaying a character at POSITION.
+/// Optional second arg WINDOW, if non-nil, is a window displaying
+/// the current buffer.  It defaults to the currently selected window.
+/// Optional third arg STRING, if non-nil, is a string containing the target
+/// character at index specified by POSITION.
+#[lisp_fn(min = "1", c_name = "font_at", name = "font-at")]
+pub fn font_at_lisp(
+    position: LispObject,
+    window: LispWindowLiveOrSelected,
+    string: LispObject,
+) -> LispObject {
+    let mut w: LispWindowRef = window.into();
+    let cur_buf = ThreadState::current_buffer_unchecked();
+
+    let pos = match string.as_string() {
+        Some(s) => {
+            let pos = EmacsInt::from(position) as isize;
+            if !(0 <= pos && pos < s.len_bytes()) {
+                args_out_of_range!(string, position);
+            }
+            pos
+        }
+
+        _ => {
+            if w.contents != cur_buf.into() {
+                error!("Specified window is not displaying the current buffer");
+            }
+            position.as_number_coerce_marker_or_error();
+            let pos = EmacsInt::from(position) as isize;
+
+            let begv = cur_buf.begv;
+            let zv = cur_buf.zv;
+            if !(begv <= pos && pos < zv) {
+                args_out_of_range!(
+                    position,
+                    LispObject::from(begv as EmacsInt),
+                    LispObject::from(zv as EmacsInt)
+                );
+            }
+            pos
+        }
+    };
+    unsafe { font_at(-1, pos, ptr::null_mut(), w.as_mut(), string) }
+}
+
 include!(concat!(env!("OUT_DIR"), "/fonts_exports.rs"));
diff --git a/src/font.c b/src/font.c
index 3797546dda..6e60f1267e 100644
--- a/src/font.c
+++ b/src/font.c
@@ -3684,7 +3684,7 @@ font_filter_properties (Lisp_Object font,
    at index POS.  If C is negative, get C from the current buffer or
    STRING.  */
 
-static Lisp_Object
+Lisp_Object
 font_at (int c, ptrdiff_t pos, struct face *face, struct window *w,
 	 Lisp_Object string)
 {
@@ -4892,35 +4892,6 @@ the corresponding element is nil.  */)
   return vec;
 }
 
-DEFUN ("font-at", Ffont_at, Sfont_at, 1, 3, 0,
-       doc: /* Return a font-object for displaying a character at POSITION.
-Optional second arg WINDOW, if non-nil, is a window displaying
-the current buffer.  It defaults to the currently selected window.
-Optional third arg STRING, if non-nil, is a string containing the target
-character at index specified by POSITION.  */)
-  (Lisp_Object position, Lisp_Object window, Lisp_Object string)
-{
-  struct window *w = decode_live_window (window);
-
-  if (NILP (string))
-    {
-      if (XBUFFER (w->contents) != current_buffer)
-	error ("Specified window is not displaying the current buffer");
-      CHECK_NUMBER_COERCE_MARKER (position);
-      if (! (BEGV <= XINT (position) && XINT (position) < ZV))
-	args_out_of_range_3 (position, make_number (BEGV), make_number (ZV));
-    }
-  else
-    {
-      CHECK_NUMBER (position);
-      CHECK_STRING (string);
-      if (! (0 <= XINT (position) && XINT (position) < SCHARS (string)))
-	args_out_of_range (string, position);
-    }
-
-  return font_at (-1, XINT (position), NULL, w, string);
-}
-
 #if 0
 DEFUN ("draw-string", Fdraw_string, Sdraw_string, 2, 2, 0,
        doc: /*  Draw STRING by FONT-OBJECT on the top left corner of the current frame.
@@ -5313,7 +5284,6 @@ syms_of_font (void)
   defsubr (&Sopen_font);
   defsubr (&Squery_font);
   defsubr (&Sfont_get_glyphs);
-  defsubr (&Sfont_at);
 #if 0
   defsubr (&Sdraw_string);
 #endif
diff --git a/src/font.h b/src/font.h
index 55f9851e8c..fe3a178bfc 100644
--- a/src/font.h
+++ b/src/font.h
@@ -928,6 +928,8 @@ extern void syms_of_ftcrfont (void);
 
 extern void font_add_log (const char *, Lisp_Object, Lisp_Object);
 extern void font_deferred_log (const char *, Lisp_Object, Lisp_Object);
+extern Lisp_Object font_at (int c, ptrdiff_t pos, struct face *face,
+                            struct window *w, Lisp_Object string);
 
 #define FONT_ADD_LOG(ACTION, ARG, RESULT)	\
   do {						\
-- 
2.21.0


From 23ce6d9403301762226c2afff07d60753d083719 Mon Sep 17 00:00:00 2001
From: Daichi Mukai <mukai.daichi.37e@kyoto-u.jp>
Date: Thu, 17 Jan 2019 13:36:26 +0900
Subject: [PATCH 214/297] Update to latest base64 crate (0.10.0) (#1249)

From version 0.10.0, base64 crate does not provide the function to
wrap encoded string in the expected line length and delete whitespaces
from the string to be decoded. The former has pulled into the
line-wrap crate and the latter can be achived by a short code.

Closes #1241.
---
 rust_src/Cargo.lock    | 27 ++++++++++++++++---------
 rust_src/Cargo.toml.in |  3 ++-
 rust_src/src/base64.rs | 45 +++++++++++++++++++++++++++++-------------
 3 files changed, 51 insertions(+), 24 deletions(-)

diff --git a/rust_src/Cargo.lock b/rust_src/Cargo.lock
index dae54aa0e2..376fcdc129 100644
--- a/rust_src/Cargo.lock
+++ b/rust_src/Cargo.lock
@@ -49,11 +49,10 @@ dependencies = [
 
 [[package]]
 name = "base64"
-version = "0.9.2"
+version = "0.10.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "byteorder 1.2.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "safemem 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -78,7 +77,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "byteorder"
-version = "1.2.3"
+version = "1.2.7"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -323,6 +322,14 @@ name = "libc"
 version = "0.2.42"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
+[[package]]
+name = "line-wrap"
+version = "0.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "safemem 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
 [[package]]
 name = "matches"
 version = "0.1.6"
@@ -482,7 +489,7 @@ name = "remacs"
 version = "0.1.0"
 dependencies = [
  "alloc_unexecmacosx 0.1.0",
- "base64 0.9.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "base64 0.10.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "clippy 0.0.206 (registry+https://github.com/rust-lang/crates.io-index)",
  "errno 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)",
  "field-offset 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -490,6 +497,7 @@ dependencies = [
  "if_chain 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
  "lazy_static 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)",
  "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
+ "line-wrap 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
  "md5 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)",
  "rand 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)",
  "regex 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -551,7 +559,7 @@ dependencies = [
 
 [[package]]
 name = "safemem"
-version = "0.2.0"
+version = "0.3.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -771,12 +779,12 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 "checksum ansi_term 0.11.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ee49baf6cb617b853aa8d93bf420db2383fab46d314482ca2803b40d5fde979b"
 "checksum backtrace 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)" = "dbdd17cd962b570302f5297aea8648d5923e22e555c2ed2d8b2e34eca646bf6d"
 "checksum backtrace-sys 0.1.23 (registry+https://github.com/rust-lang/crates.io-index)" = "bff67d0c06556c0b8e6b5f090f0eac52d950d9dfd1d35ba04e4ca3543eaf6a7e"
-"checksum base64 0.9.2 (registry+https://github.com/rust-lang/crates.io-index)" = "85415d2594767338a74a30c1d370b2f3262ec1b4ed2d7bba5b3faf4de40467d9"
+"checksum base64 0.10.0 (registry+https://github.com/rust-lang/crates.io-index)" = "621fc7ecb8008f86d7fb9b95356cd692ce9514b80a86d85b397f32a22da7b9e2"
 "checksum bitflags 0.9.1 (registry+https://github.com/rust-lang/crates.io-index)" = "4efd02e230a02e18f92fc2735f44597385ed02ad8f831e7c1c1156ee5e1ab3a5"
 "checksum bitflags 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)" = "d0c54bb8f454c567f21197eefcdbf5679d0bd99f2ddbe52e84c77061952e6789"
 "checksum build_const 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)" = "39092a32794787acd8525ee150305ff051b0aa6cc2abaf193924f5ab05425f39"
 "checksum byte-tools 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "0919189ba800c7ffe8778278116b7e0de3905ab81c72abb69c85cbfef7991279"
-"checksum byteorder 1.2.3 (registry+https://github.com/rust-lang/crates.io-index)" = "74c0b906e9446b0a2e4f760cdb3fa4b2c48cdc6db8766a845c54b6ff063fd2e9"
+"checksum byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)" = "94f88df23a25417badc922ab0f5716cc1330e87f71ddd9203b3a3ccd9cedf75d"
 "checksum cargo_metadata 0.5.5 (registry+https://github.com/rust-lang/crates.io-index)" = "692a7aaca96b85973d7d92c5f633d75a399760ee61977db480ffdeadd497cbd2"
 "checksum cc 1.0.17 (registry+https://github.com/rust-lang/crates.io-index)" = "49ec142f5768efb5b7622aebc3fdbdbb8950a4b9ba996393cb76ef7466e8747d"
 "checksum cfg-if 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "405216fd8fe65f718daa7102ea808a946b6ce40c742998fbfd3463645552de18"
@@ -808,6 +816,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 "checksum lazy_static 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)" = "76f033c7ad61445c5b347c7382dd1237847eb1bce590fe50365dcb33d546be73"
 "checksum lazy_static 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)" = "e6412c5e2ad9584b0b8e979393122026cdd6d2a80b933f890dcd694ddbe73739"
 "checksum libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)" = "b685088df2b950fccadf07a7187c8ef846a959c142338a48f9dc0b94517eb5f1"
+"checksum line-wrap 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "f30344350a2a51da54c1d53be93fade8a237e545dbcc4bdbe635413f2117cab9"
 "checksum matches 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)" = "100aabe6b8ff4e4a7e32c1c13523379802df0772b82466207ac25b013f193376"
 "checksum md5 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)" = "daa1004633f76cdcd5a9d83ffcfe615e30ca7a2a638fcc8b8039a2dac21289d7"
 "checksum memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)" = "796fba70e76612589ed2ce7f45282f5af869e0fdd7cc6199fa1aa1f1d591ba9d"
@@ -830,7 +839,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 "checksum regex-syntax 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)" = "8f1ac0f60d675cc6cf13a20ec076568254472551051ad5dd050364d70671bf6b"
 "checksum rustc-demangle 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)" = "76d7ba1feafada44f2d38eed812bd2489a03c0f5abb975799251518b68848649"
 "checksum rustc_version 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "a54aa04a10c68c1c4eacb4337fd883b435997ede17a9385784b990777686b09a"
-"checksum safemem 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "e27a8b19b835f7aea908818e871f5cc3a5a186550c30773be987e155e8163d8f"
+"checksum safemem 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)" = "8dca453248a96cb0749e36ccdfe2b0b4e54a61bfef89fb97ec621eb8e0a93dd9"
 "checksum semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)" = "1d7eb9ef2c18661902cc47e535f9bc51b78acd254da71d375c2f6720d9a40403"
 "checksum semver-parser 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)" = "388a1df253eca08550bef6c72392cfe7c30914bf41df5269b68cbd6ff8f570a3"
 "checksum serde 1.0.65 (registry+https://github.com/rust-lang/crates.io-index)" = "5d47469df098fe8701d4da22680da5145e83801bdaaafea0cf91a180436fc343"
diff --git a/rust_src/Cargo.toml.in b/rust_src/Cargo.toml.in
index 588853b2a4..14eb621a49 100644
--- a/rust_src/Cargo.toml.in
+++ b/rust_src/Cargo.toml.in
@@ -12,11 +12,12 @@ edition = "2018"
 [dependencies]
 remacs-lib = { version = "0.1.0", path = "remacs-lib" }
 remacs-macros = { version = "0.1.0", path = "remacs-macros" }
-base64 = "0.9"
+base64 = "0.10.0"
 clippy = { version = "*", optional = true }
 errno = "0.2.3"
 lazy_static = "0.2.2"
 libc = "0.2"
+line-wrap = "0.1.1"
 md5 = "0.3.5"
 rand = "0.4.3"
 sha1 = "0.2.0"
diff --git a/rust_src/src/base64.rs b/rust_src/src/base64.rs
index 659264ef57..b89497cbe5 100644
--- a/rust_src/src/base64.rs
+++ b/rust_src/src/base64.rs
@@ -2,6 +2,8 @@
 use std::{cmp::max, slice};
 
 use libc::{c_char, c_uchar};
+use line_wrap::LineEnding;
+
 use remacs_macros::lisp_fn;
 
 use crate::{
@@ -20,19 +22,9 @@ use crate::{
 };
 
 fn base64_encode_1(bytes: &[u8], line_break: bool, multibyte: bool) -> Result<String, ()> {
-    let config = if line_break {
-        // base64_crate::MIME, but with LF instead of CRLF
-        base64_crate::Config::new(
-            base64_crate::CharacterSet::Standard,
-            true, // pad
-            true, // strip whitespace
-            base64_crate::LineWrap::Wrap(76, base64_crate::LineEnding::LF),
-        )
-    } else {
-        base64_crate::STANDARD
-    };
+    let config = base64_crate::STANDARD;
 
-    let encoded_string = if multibyte {
+    let mut encoded_string = if multibyte {
         // Transform non-ASCII characters in multibyte string to Latin1,
         // erroring out for non-Latin1 codepoints, and resolve raw 8-bit bytes.
         let mut input = Vec::with_capacity(bytes.len());
@@ -54,14 +46,39 @@ fn base64_encode_1(bytes: &[u8], line_break: bool, multibyte: bool) -> Result<St
         base64_crate::encode_config(bytes, config)
     };
 
+    if line_break {
+        line_wrap(&mut encoded_string, 76, &line_wrap::lf());
+    }
+
     Ok(encoded_string)
 }
 
+/// Insert LINE_ENDING into the STRING per LINE_LEN bytes.
+fn line_wrap<L: LineEnding>(string: &mut String, line_len: usize, line_ending: &L) {
+    let capacity = string.capacity();
+    let input_len = string.len();
+    // This overestimating of the number of lines with ending possibly result in allocating
+    // `line_ending.len()` bytes more than needed, but leave it as is for now.
+    let lines_with_ending = input_len / line_len + 1;
+
+    let mut raw_vec = unsafe { string.as_mut_vec() };
+
+    if let Some(adding) = (lines_with_ending * (line_len + line_ending.len())).checked_sub(capacity)
+    {
+        raw_vec.resize(input_len + adding, 0);
+    }
+    let added = line_wrap::line_wrap(&mut raw_vec, input_len, line_len, line_ending);
+    raw_vec.truncate(input_len + added);
+}
+
 /// Base64-decode the data in ENCODED. If MULTIBYTE, the decoded result should be in multibyte
 /// form. It returns the decoded data and the number of bytes in the original decoded string.
 fn base64_decode_1(encoded: &[u8], multibyte: bool) -> Result<(Vec<u8>, usize), ()> {
-    // Use the MIME config to allow embedded newlines.
-    match base64_crate::decode_config(encoded, base64_crate::MIME) {
+    // Input string is allowed to have emmbed newlines, delete before decoding.
+    let mut buf: Vec<u8> = Vec::with_capacity(encoded.len());
+    buf.extend(encoded.iter().filter(|b| !b"\n\t\r\x0b\x0c".contains(b)));
+
+    match base64_crate::decode_config(&buf, base64_crate::STANDARD) {
         Ok(decoded) => {
             if multibyte {
                 // Decode non-ASCII bytes into UTF-8 pairs.
-- 
2.21.0


From f51f865d4bb7967d150f4d6a465e7b29ea3df5a0 Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Thu, 17 Jan 2019 08:13:57 +0100
Subject: [PATCH 215/297] port string-to-number (#1111)

port string-to-number
---
 rust_src/src/data.rs            | 41 +++++++++++++++++++++++++++++----
 src/data.c                      | 36 -----------------------------
 test/rust_src/src/data-tests.el | 10 ++++++++
 3 files changed, 47 insertions(+), 40 deletions(-)

diff --git a/rust_src/src/data.rs b/rust_src/src/data.rs
index 1540006b1a..1daba69fef 100644
--- a/rust_src/src/data.rs
+++ b/rust_src/src/data.rs
@@ -1,7 +1,7 @@
 //! data helpers
 
 use field_offset::FieldOffset;
-use libc::c_int;
+use libc::{c_char, c_int};
 
 use remacs_macros::lisp_fn;
 
@@ -13,14 +13,15 @@ use crate::{
     lisp::{LispObject, LispSubrRef, LiveBufferIter},
     lists::{get, member, memq, put},
     math::leq,
-    multibyte::{is_ascii, is_single_byte_char},
+    multibyte::{is_ascii, is_single_byte_char, LispStringRef},
     obarray::{loadhist_attach, map_obarray},
     remacs_sys,
     remacs_sys::Vautoload_queue,
     remacs_sys::{
         aset_multibyte_string, bool_vector_binop_driver, buffer_defaults, build_string, globals,
-        rust_count_one_bits, set_default_internal, set_internal, symbol_trapped_write,
-        valid_lisp_object_p, wrong_choice, wrong_range, CHAR_TABLE_SET, CHECK_IMPURE,
+        rust_count_one_bits, set_default_internal, set_internal, string_to_number,
+        symbol_trapped_write, valid_lisp_object_p, wrong_choice, wrong_range, CHAR_TABLE_SET,
+        CHECK_IMPURE,
     },
     remacs_sys::{buffer_local_flags, per_buffer_default, symbol_redirect},
     remacs_sys::{pvec_type, BoolVectorOp, EmacsInt, Lisp_Misc_Type, Lisp_Type, Set_Internal_Bind},
@@ -811,4 +812,36 @@ pub fn fset(mut symbol: LispSymbolRef, definition: LispObject) -> LispObject {
     definition
 }
 
+/// Parse STRING as a decimal number and return the number.
+/// Ignore leading spaces and tabs, and all trailing chars.  Return 0 if
+/// STRING cannot be parsed as an integer or floating point number.
+///
+/// If BASE, interpret STRING as a number in that base.  If BASE isn't
+/// present, base 10 is used.  BASE must be between 2 and 16 (inclusive).
+/// If the base used is not 10, STRING is always parsed as an integer.
+#[lisp_fn(min = "1", name = "string-to-number", c_name = "string_to_number")]
+pub fn string_to_number_lisp(mut string: LispStringRef, base: Option<EmacsInt>) -> LispObject {
+    let b = match base {
+        None => 10,
+        Some(n) => {
+            if n < 2 || n > 16 {
+                args_out_of_range!(base, 2, 16)
+            }
+            n
+        }
+    };
+
+    let mut p = string.sdata_ptr();
+    unsafe {
+        while *p == ' ' as c_char || *p == '\t' as c_char {
+            p = p.offset(1);
+        }
+    }
+
+    match unsafe { string_to_number(p, b as i32, true) } {
+        Qnil => LispObject::from(0),
+        n => n,
+    }
+}
+
 include!(concat!(env!("OUT_DIR"), "/data_exports.rs"));
diff --git a/src/data.c b/src/data.c
index 06604faaae..738fc0958f 100644
--- a/src/data.c
+++ b/src/data.c
@@ -1260,41 +1260,6 @@ NUMBER may be an integer or a floating point number.  */)
   return make_unibyte_string (buffer, len);
 }
 
-DEFUN ("string-to-number", Fstring_to_number, Sstring_to_number, 1, 2, 0,
-       doc: /* Parse STRING as a decimal number and return the number.
-Ignore leading spaces and tabs, and all trailing chars.  Return 0 if
-STRING cannot be parsed as an integer or floating point number.
-
-If BASE, interpret STRING as a number in that base.  If BASE isn't
-present, base 10 is used.  BASE must be between 2 and 16 (inclusive).
-If the base used is not 10, STRING is always parsed as an integer.  */)
-  (register Lisp_Object string, Lisp_Object base)
-{
-  register char *p;
-  register int b;
-  Lisp_Object val;
-
-  CHECK_STRING (string);
-
-  if (NILP (base))
-    b = 10;
-  else
-    {
-      CHECK_NUMBER (base);
-      if (! (XINT (base) >= 2 && XINT (base) <= 16))
-	xsignal1 (Qargs_out_of_range, base);
-      b = XINT (base);
-    }
-
-  p = SSDATA (string);
-  while (*p == ' ' || *p == '\t')
-    p++;
-
-  val = string_to_number (p, b, true);
-  return NILP (val) ? make_number (0) : val;
-}
-
-
 static Lisp_Object
 ash_lsh_impl (Lisp_Object value, Lisp_Object count, bool lsh)
 {
@@ -1817,7 +1782,6 @@ syms_of_data (void)
   defsubr (&Sset_terminal_local_value);
 #endif
   defsubr (&Snumber_to_string);
-  defsubr (&Sstring_to_number);
   defsubr (&Slsh);
   defsubr (&Sash);
 #ifdef HAVE_MODULES
diff --git a/test/rust_src/src/data-tests.el b/test/rust_src/src/data-tests.el
index 9f40704152..17ffe8738b 100644
--- a/test/rust_src/src/data-tests.el
+++ b/test/rust_src/src/data-tests.el
@@ -136,5 +136,15 @@
   ;; Defined in Rust
   (should (consp (find-definition-noselect 'post-self-insert-hook 'defvar))))
 
+(ert-deftest test-string-to-number ()
+  (should (= (string-to-number "aaa1") 0))
+  (should (= (string-to-number "1aaa1") 1))
+  (should (= (string-to-number "1") 1))
+  (should (= (string-to-number "-1") -1))
+  (should (= (string-to-number "0.1") 0.1))
+  (should (= (string-to-number "-0.1") -0.1))
+  (should (= (string-to-number "1111" 2) 15))
+  (should (= (string-to-number "FF" 16) 255)))
+
 (provide 'data-tests)
 ;;; data-tests.el ends here
-- 
2.21.0


From 40fb634835089516119896ed061e457c7d9aa011 Mon Sep 17 00:00:00 2001
From: Sanchayan Maity <maitysanchayan@gmail.com>
Date: Thu, 17 Jan 2019 12:51:54 +0530
Subject: [PATCH 216/297] Port interrupt-process (#1214)

Port interrupt-process
---
 rust_src/src/process.rs | 25 +++++++++++++++++++++++--
 src/process.c           | 23 -----------------------
 2 files changed, 23 insertions(+), 25 deletions(-)

diff --git a/rust_src/src/process.rs b/rust_src/src/process.rs
index 305dac42bd..f5af22ea0b 100644
--- a/rust_src/src/process.rs
+++ b/rust_src/src/process.rs
@@ -5,6 +5,7 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     buffers::{current_buffer, get_buffer, LispBufferOrName, LispBufferRef},
+    eval::run_hook_with_args_until_success,
     lisp::defsubr,
     lisp::{ExternalPtr, LispObject, ProcessIter},
     lists::{assoc, car, cdr, plist_put},
@@ -17,8 +18,8 @@ use crate::{
     remacs_sys::{pvec_type, EmacsInt, Lisp_Process, Lisp_Type, Vprocess_alist},
     remacs_sys::{
         QCbuffer, QCfilter, QCsentinel, Qcdr, Qclosed, Qexit, Qinternal_default_process_filter,
-        Qinternal_default_process_sentinel, Qlisten, Qlistp, Qnetwork, Qnil, Qopen, Qpipe,
-        Qprocessp, Qreal, Qrun, Qserial, Qstop, Qt,
+        Qinternal_default_process_sentinel, Qinterrupt_process_functions, Qlisten, Qlistp,
+        Qnetwork, Qnil, Qopen, Qpipe, Qprocessp, Qreal, Qrun, Qserial, Qstop, Qt,
     },
 };
 
@@ -527,4 +528,24 @@ pub fn list_system_processes_lisp() -> LispObject {
     unsafe { list_system_processes() }
 }
 
+/// Interrupt process PROCESS
+/// PROCESS may be a process, a buffer, or the name of a process or buffer.
+/// No arg or nil means current buffer's process.
+/// Second arg CURRENT-GROUP non-nil means send signal to
+/// the current process-group of the process's controlling terminal
+/// rather than to the process's own process group.
+/// If the process is a shell, this means interrupt current subjob
+/// rather than the shell.
+///
+/// If CURRENT-GROUP is `lambda', and if the shell owns the terminal,
+/// don't send the signal.
+///
+/// This function calls the functions of `interrupt-process-functions' in
+/// the order of the list, until one of them returns non-`nil'.
+#[lisp_fn(min = "0")]
+pub fn interrupt_process(process: LispObject, current_group: LispObject) -> LispObject {
+    run_hook_with_args_until_success(&mut [Qinterrupt_process_functions, process, current_group])
+}
+def_lisp_sym!(Qinterrupt_process_functions, "interrupt-process-functions");
+
 include!(concat!(env!("OUT_DIR"), "/process_exports.rs"));
diff --git a/src/process.c b/src/process.c
index 1f0565ef65..e20b06a85b 100644
--- a/src/process.c
+++ b/src/process.c
@@ -6293,27 +6293,6 @@ See function `interrupt-process' for more details on usage.  */)
   return process;
 }
 
-DEFUN ("interrupt-process", Finterrupt_process, Sinterrupt_process, 0, 2, 0,
-       doc: /* Interrupt process PROCESS.
-PROCESS may be a process, a buffer, or the name of a process or buffer.
-No arg or nil means current buffer's process.
-Second arg CURRENT-GROUP non-nil means send signal to
-the current process-group of the process's controlling terminal
-rather than to the process's own process group.
-If the process is a shell, this means interrupt current subjob
-rather than the shell.
-
-If CURRENT-GROUP is `lambda', and if the shell owns the terminal,
-don't send the signal.
-
-This function calls the functions of `interrupt-process-functions' in
-the order of the list, until one of them returns non-`nil'.  */)
-  (Lisp_Object process, Lisp_Object current_group)
-{
-  return CALLN (Frun_hook_with_args_until_success, Qinterrupt_process_functions,
-		process, current_group);
-}
-
 DEFUN ("kill-process", Fkill_process, Skill_process, 0, 2, 0,
        doc: /* Kill process PROCESS.  May be process or name of one.
 See function `interrupt-process' for more details on usage.  */)
@@ -7509,7 +7488,6 @@ returns non-`nil'.  */);
 
   DEFSYM (Qinternal_default_interrupt_process,
 	  "internal-default-interrupt-process");
-  DEFSYM (Qinterrupt_process_functions, "interrupt-process-functions");
 
   defsubr (&Sdelete_process);
   defsubr (&Sset_process_thread);
@@ -7532,7 +7510,6 @@ returns non-`nil'.  */);
   defsubr (&Saccept_process_output);
   defsubr (&Sprocess_send_region);
   defsubr (&Sinternal_default_interrupt_process);
-  defsubr (&Sinterrupt_process);
   defsubr (&Skill_process);
   defsubr (&Squit_process);
   defsubr (&Sstop_process);
-- 
2.21.0


From 016a3d82af2ed8947a0afe798a44a13011d52e4a Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Thu, 17 Jan 2019 11:36:56 +0100
Subject: [PATCH 217/297] Port record_unwind_protect functions (#1248)

Port record_unwind_protect functions
---
 rust_src/src/editfns.rs |  9 +++----
 rust_src/src/eval.rs    | 59 ++++++++++++++++++++++++++++++++++++++++-
 rust_src/src/fns.rs     |  4 +--
 src/eval.c              | 39 +--------------------------
 src/lisp.h              |  1 +
 5 files changed, 66 insertions(+), 46 deletions(-)

diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index c16e36f271..136d362898 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -14,7 +14,7 @@ use crate::{
     buffers::{current_buffer, validate_region},
     buffers::{LispBufferOrCurrent, LispBufferOrName, LispBufferRef, BUF_BYTES_MAX},
     character::{char_head_p, dec_pos},
-    eval::{progn, unbind_to},
+    eval::{progn, record_unwind_protect, unbind_to},
     indent::invalidate_current_column,
     lisp::{defsubr, LispObject},
     marker::{
@@ -33,10 +33,9 @@ use crate::{
         find_before_next_newline, find_newline, get_char_property_and_overlay, globals, insert,
         insert_and_inherit, insert_from_buffer, make_buffer_string, make_buffer_string_both,
         make_save_obj_obj_obj_obj, make_string_from_bytes, maybe_quit, message1, message3,
-        record_unwind_current_buffer, record_unwind_protect, save_excursion_restore,
-        save_restriction_restore, save_restriction_save, scan_newline_from_point,
-        set_buffer_internal_1, set_point, set_point_both, styled_format, update_buffer_properties,
-        STRING_BYTES,
+        record_unwind_current_buffer, save_excursion_restore, save_restriction_restore,
+        save_restriction_save, scan_newline_from_point, set_buffer_internal_1, set_point,
+        set_point_both, styled_format, update_buffer_properties, STRING_BYTES,
     },
     remacs_sys::{
         Fadd_text_properties, Fcopy_sequence, Fget_pos_property, Fnext_single_char_property_change,
diff --git a/rust_src/src/eval.rs b/rust_src/src/eval.rs
index d209daa87b..e5a8050de9 100644
--- a/rust_src/src/eval.rs
+++ b/rust_src/src/eval.rs
@@ -2,6 +2,8 @@
 
 use std::ptr;
 
+use libc::c_void;
+
 use remacs_macros::lisp_fn;
 
 use crate::{
@@ -13,10 +15,13 @@ use crate::{
     multibyte::LispStringRef,
     obarray::loadhist_attach,
     objects::equal,
+    remacs_sys::specbind_tag::{
+        SPECPDL_UNWIND, SPECPDL_UNWIND_INT, SPECPDL_UNWIND_PTR, SPECPDL_UNWIND_VOID,
+    },
     remacs_sys::{
         backtrace_debug_on_exit, build_string, call_debugger, check_cons_list, do_debug_on_call,
         do_one_unbind, eval_sub, find_symbol_value, funcall_lambda, funcall_subr, globals,
-        internal_catch, list2, maybe_gc, maybe_quit, record_in_backtrace, record_unwind_protect,
+        grow_specpdl, internal_catch, list2, maybe_gc, maybe_quit, record_in_backtrace,
         record_unwind_save_match_data, specbind, COMPILEDP, MODULE_FUNCTIONP,
     },
     remacs_sys::{pvec_type, EmacsInt, Lisp_Compiled, Set_Internal_Bind},
@@ -37,6 +42,58 @@ use crate::{
  *   and temporaries from garbage collection while it needs them.      *
  * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */
 
+#[no_mangle]
+pub unsafe extern "C" fn record_unwind_protect(
+    function: Option<unsafe extern "C" fn(LispObject)>,
+    arg: LispObject,
+) {
+    let unwind = (*ThreadState::current_thread().m_specpdl_ptr)
+        .unwind
+        .as_mut();
+    unwind.set_kind(SPECPDL_UNWIND);
+    unwind.func = function;
+    unwind.arg = arg;
+    grow_specpdl();
+}
+
+#[no_mangle]
+pub unsafe extern "C" fn record_unwind_protect_ptr(
+    function: Option<unsafe extern "C" fn(*mut c_void)>,
+    arg: *mut c_void,
+) {
+    let unwind = (*ThreadState::current_thread().m_specpdl_ptr)
+        .unwind_ptr
+        .as_mut();
+    unwind.set_kind(SPECPDL_UNWIND_PTR);
+    unwind.func = function;
+    unwind.arg = arg;
+    grow_specpdl();
+}
+
+#[no_mangle]
+pub unsafe extern "C" fn record_unwind_protect_int(
+    function: Option<unsafe extern "C" fn(i32)>,
+    arg: i32,
+) {
+    let unwind = (*ThreadState::current_thread().m_specpdl_ptr)
+        .unwind_int
+        .as_mut();
+    unwind.set_kind(SPECPDL_UNWIND_INT);
+    unwind.func = function;
+    unwind.arg = arg;
+    grow_specpdl();
+}
+
+#[no_mangle]
+pub unsafe extern "C" fn record_unwind_protect_void(function: Option<unsafe extern "C" fn()>) {
+    let unwind = (*ThreadState::current_thread().m_specpdl_ptr)
+        .unwind_void
+        .as_mut();
+    unwind.set_kind(SPECPDL_UNWIND_VOID);
+    unwind.func = function;
+    grow_specpdl();
+}
+
 /// Eval args until one of them yields non-nil, then return that value.
 /// The remaining args are not evalled at all.
 /// If all args return nil, return nil.
diff --git a/rust_src/src/fns.rs b/rust_src/src/fns.rs
index 5126aa4fbf..4c53fc8896 100644
--- a/rust_src/src/fns.rs
+++ b/rust_src/src/fns.rs
@@ -7,7 +7,7 @@ use libc;
 use remacs_macros::lisp_fn;
 
 use crate::{
-    eval::{un_autoload, unbind_to},
+    eval::{record_unwind_protect, un_autoload, unbind_to},
     lisp::defsubr,
     lisp::LispObject,
     lists::{assq, car, get, mapcar1, member, memq, put},
@@ -18,7 +18,7 @@ use crate::{
     objects::equal,
     remacs_sys::Fload,
     remacs_sys::Vautoload_queue,
-    remacs_sys::{concat as lisp_concat, globals, record_unwind_protect},
+    remacs_sys::{concat as lisp_concat, globals},
     remacs_sys::{equal_kind, EmacsInt, Lisp_Type},
     remacs_sys::{Qfuncall, Qlistp, Qnil, Qprovide, Qquote, Qrequire, Qsubfeatures, Qt},
     symbols::LispSymbolRef,
diff --git a/src/eval.c b/src/eval.c
index 1b9233c62f..8bdf5aaa4f 100644
--- a/src/eval.c
+++ b/src/eval.c
@@ -267,8 +267,6 @@ restore_stack_limits (Lisp_Object data)
   max_lisp_eval_depth = XINT (XCDR (data));
 }
 
-static void grow_specpdl (void);
-
 /* Call the Lisp debugger, giving it argument ARG.  */
 
 Lisp_Object
@@ -1373,7 +1371,7 @@ error (const char *m, ...)
    never-used entry just before the bottom of the stack; sometimes its
    address is taken.  */
 
-static void
+void
 grow_specpdl (void)
 {
   specpdl_ptr++;
@@ -2398,41 +2396,6 @@ specbind (Lisp_Object symbol, Lisp_Object value)
 
 /* Push unwind-protect entries of various types.  */
 
-void
-record_unwind_protect (void (*function) (Lisp_Object), Lisp_Object arg)
-{
-  specpdl_ptr->unwind.kind = SPECPDL_UNWIND;
-  specpdl_ptr->unwind.func = function;
-  specpdl_ptr->unwind.arg = arg;
-  grow_specpdl ();
-}
-
-void
-record_unwind_protect_ptr (void (*function) (void *), void *arg)
-{
-  specpdl_ptr->unwind_ptr.kind = SPECPDL_UNWIND_PTR;
-  specpdl_ptr->unwind_ptr.func = function;
-  specpdl_ptr->unwind_ptr.arg = arg;
-  grow_specpdl ();
-}
-
-void
-record_unwind_protect_int (void (*function) (int), int arg)
-{
-  specpdl_ptr->unwind_int.kind = SPECPDL_UNWIND_INT;
-  specpdl_ptr->unwind_int.func = function;
-  specpdl_ptr->unwind_int.arg = arg;
-  grow_specpdl ();
-}
-
-void
-record_unwind_protect_void (void (*function) (void))
-{
-  specpdl_ptr->unwind_void.kind = SPECPDL_UNWIND_VOID;
-  specpdl_ptr->unwind_void.func = function;
-  grow_specpdl ();
-}
-
 void
 rebind_for_thread_switch (void)
 {
diff --git a/src/lisp.h b/src/lisp.h
index ec623464ab..13f4038b54 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -4046,6 +4046,7 @@ extern void syms_of_eval (void);
 extern void prog_ignore (Lisp_Object);
 extern ptrdiff_t record_in_backtrace (Lisp_Object, Lisp_Object *, ptrdiff_t);
 extern void mark_specpdl (union specbinding *first, union specbinding *ptr);
+extern void grow_specpdl (void);
 extern void get_backtrace (Lisp_Object array);
 Lisp_Object backtrace_top_function (void);
 extern bool let_shadows_buffer_binding_p (struct Lisp_Symbol *symbol);
-- 
2.21.0


From 4f1d20448d078ca127e77ea04065926f5d21932d Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Fri, 28 Dec 2018 13:39:47 +0100
Subject: [PATCH 218/297] replace types in methods with Self

---
 rust_src/src/buffers.rs | 20 ++++++++++----------
 rust_src/src/frames.rs  |  2 +-
 rust_src/src/marker.rs  |  2 +-
 rust_src/src/windows.rs | 22 +++++++++++-----------
 4 files changed, 23 insertions(+), 23 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 58c6f23276..45fef9644f 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -413,7 +413,7 @@ impl From<LispObject> for LispBufferRef {
 
 impl From<LispBufferRef> for LispObject {
     fn from(b: LispBufferRef) -> Self {
-        LispObject::tag_ptr(b, Lisp_Type::Lisp_Vectorlike)
+        Self::tag_ptr(b, Lisp_Type::Lisp_Vectorlike)
     }
 }
 
@@ -447,7 +447,7 @@ impl From<LispObject> for LispOverlayRef {
 
 impl From<LispOverlayRef> for LispObject {
     fn from(o: LispOverlayRef) -> Self {
-        LispObject::tag_ptr(o, Lisp_Type::Lisp_Misc)
+        Self::tag_ptr(o, Lisp_Type::Lisp_Misc)
     }
 }
 
@@ -534,7 +534,7 @@ impl LispBufferOrName {
 }
 
 impl From<LispBufferOrName> for LispObject {
-    fn from(buffer_or_name: LispBufferOrName) -> LispObject {
+    fn from(buffer_or_name: LispBufferOrName) -> Self {
         match buffer_or_name {
             LispBufferOrName::Buffer(b) => b,
             LispBufferOrName::Name(n) => n,
@@ -543,7 +543,7 @@ impl From<LispBufferOrName> for LispObject {
 }
 
 impl From<LispObject> for LispBufferOrName {
-    fn from(v: LispObject) -> LispBufferOrName {
+    fn from(v: LispObject) -> Self {
         if v.is_string() {
             LispBufferOrName::Name(v)
         } else {
@@ -554,7 +554,7 @@ impl From<LispObject> for LispBufferOrName {
 }
 
 impl From<LispObject> for Option<LispBufferOrName> {
-    fn from(v: LispObject) -> Option<LispBufferOrName> {
+    fn from(v: LispObject) -> Self {
         if v.is_nil() {
             None
         } else if v.is_string() {
@@ -568,7 +568,7 @@ impl From<LispObject> for Option<LispBufferOrName> {
 }
 
 impl From<LispBufferOrName> for Option<LispBufferRef> {
-    fn from(v: LispBufferOrName) -> Option<LispBufferRef> {
+    fn from(v: LispBufferOrName) -> Self {
         let buffer = match v {
             LispBufferOrName::Buffer(b) => b,
             LispBufferOrName::Name(name) => {
@@ -584,7 +584,7 @@ impl From<LispBufferOrName> for Option<LispBufferRef> {
 }
 
 impl From<LispBufferOrName> for LispBufferRef {
-    fn from(v: LispBufferOrName) -> LispBufferRef {
+    fn from(v: LispBufferOrName) -> Self {
         Option::<LispBufferRef>::from(v).unwrap_or_else(|| nsberror(v.into()))
     }
 }
@@ -595,7 +595,7 @@ pub enum LispBufferOrCurrent {
 }
 
 impl From<LispObject> for LispBufferOrCurrent {
-    fn from(obj: LispObject) -> LispBufferOrCurrent {
+    fn from(obj: LispObject) -> Self {
         match obj.as_buffer() {
             None => LispBufferOrCurrent::Current,
             Some(buf) => LispBufferOrCurrent::Buffer(buf),
@@ -604,7 +604,7 @@ impl From<LispObject> for LispBufferOrCurrent {
 }
 
 impl From<LispBufferOrCurrent> for LispObject {
-    fn from(buffer: LispBufferOrCurrent) -> LispObject {
+    fn from(buffer: LispBufferOrCurrent) -> Self {
         match buffer {
             LispBufferOrCurrent::Current => Qnil,
             LispBufferOrCurrent::Buffer(buf) => buf.into(),
@@ -613,7 +613,7 @@ impl From<LispBufferOrCurrent> for LispObject {
 }
 
 impl From<LispBufferOrCurrent> for LispBufferRef {
-    fn from(buffer: LispBufferOrCurrent) -> LispBufferRef {
+    fn from(buffer: LispBufferOrCurrent) -> Self {
         match buffer {
             LispBufferOrCurrent::Buffer(buf) => buf,
             LispBufferOrCurrent::Current => ThreadState::current_buffer(),
diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index b002852648..22b7d92e52 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -42,7 +42,7 @@ impl From<LispObject> for LispFrameRef {
 
 impl From<LispFrameRef> for LispObject {
     fn from(f: LispFrameRef) -> Self {
-        LispObject::tag_ptr(f, Lisp_Type::Lisp_Vectorlike)
+        Self::tag_ptr(f, Lisp_Type::Lisp_Vectorlike)
     }
 }
 
diff --git a/rust_src/src/marker.rs b/rust_src/src/marker.rs
index debfc365aa..6b94c49b43 100644
--- a/rust_src/src/marker.rs
+++ b/rust_src/src/marker.rs
@@ -109,7 +109,7 @@ impl From<LispObject> for LispMarkerRef {
 
 impl From<LispMarkerRef> for LispObject {
     fn from(m: LispMarkerRef) -> Self {
-        LispObject::tag_ptr(m, Lisp_Type::Lisp_Misc)
+        Self::tag_ptr(m, Lisp_Type::Lisp_Misc)
     }
 }
 
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index a5b529078d..4da33daded 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -231,7 +231,7 @@ impl From<LispObject> for LispWindowRef {
 
 impl From<LispWindowRef> for LispObject {
     fn from(w: LispWindowRef) -> Self {
-        LispObject::tag_ptr(w, Lisp_Type::Lisp_Vectorlike)
+        Self::tag_ptr(w, Lisp_Type::Lisp_Vectorlike)
     }
 }
 
@@ -302,19 +302,19 @@ impl LispGlyphMatrixRef {
 pub struct LispWindowOrSelected(LispObject);
 
 impl From<LispObject> for LispWindowOrSelected {
-    fn from(obj: LispObject) -> LispWindowOrSelected {
-        LispWindowOrSelected(obj.map_or_else(selected_window, |w| w))
+    fn from(obj: LispObject) -> Self {
+        Self(obj.map_or_else(selected_window, |w| w))
     }
 }
 
 impl From<LispWindowOrSelected> for LispObject {
-    fn from(w: LispWindowOrSelected) -> LispObject {
+    fn from(w: LispWindowOrSelected) -> Self {
         w.0
     }
 }
 
 impl From<LispWindowOrSelected> for LispWindowRef {
-    fn from(w: LispWindowOrSelected) -> LispWindowRef {
+    fn from(w: LispWindowOrSelected) -> Self {
         w.0.as_window_or_error()
     }
 }
@@ -323,8 +323,8 @@ pub struct LispWindowLiveOrSelected(LispWindowRef);
 
 impl From<LispObject> for LispWindowLiveOrSelected {
     /// Same as the `decode_live_window` function
-    fn from(obj: LispObject) -> LispWindowLiveOrSelected {
-        LispWindowLiveOrSelected(obj.map_or_else(
+    fn from(obj: LispObject) -> Self {
+        Self(obj.map_or_else(
             || selected_window().as_window_or_error(),
             |w| w.as_live_window_or_error(),
         ))
@@ -332,7 +332,7 @@ impl From<LispObject> for LispWindowLiveOrSelected {
 }
 
 impl From<LispWindowLiveOrSelected> for LispWindowRef {
-    fn from(w: LispWindowLiveOrSelected) -> LispWindowRef {
+    fn from(w: LispWindowLiveOrSelected) -> Self {
         w.0
     }
 }
@@ -341,8 +341,8 @@ pub struct LispWindowValidOrSelected(LispWindowRef);
 
 impl From<LispObject> for LispWindowValidOrSelected {
     /// Same as the `decode_valid_window` function
-    fn from(obj: LispObject) -> LispWindowValidOrSelected {
-        LispWindowValidOrSelected(obj.map_or_else(
+    fn from(obj: LispObject) -> Self {
+        Self(obj.map_or_else(
             || selected_window().as_window_or_error(),
             |w| w.as_valid_window_or_error(),
         ))
@@ -350,7 +350,7 @@ impl From<LispObject> for LispWindowValidOrSelected {
 }
 
 impl From<LispWindowValidOrSelected> for LispWindowRef {
-    fn from(w: LispWindowValidOrSelected) -> LispWindowRef {
+    fn from(w: LispWindowValidOrSelected) -> Self {
         w.0
     }
 }
-- 
2.21.0


From 007ec7a6a7973399fd05fd027beb5a5ec947a737 Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Thu, 17 Jan 2019 19:01:25 +0100
Subject: [PATCH 219/297] port more frame functions (#946)

port frame_scroll_bar_width and frame_scroll_bar_height
---
 rust_src/src/frames.rs | 49 ++++++++++++++++++++++++++++++++++++++++++
 src/frame.c            | 15 -------------
 2 files changed, 49 insertions(+), 15 deletions(-)

diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index 753efc3ef3..e5e59a7a44 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -15,6 +15,9 @@ use crate::{
     windows::{select_window_lisp, selected_window, LispWindowRef},
 };
 
+#[cfg(feature = "window-system")]
+use crate::remacs_sys::vertical_scroll_bar_type;
+
 pub type LispFrameRef = ExternalPtr<Lisp_Frame>;
 
 impl LispFrameRef {
@@ -34,6 +37,38 @@ impl LispFrameRef {
     pub fn total_fringe_width(self) -> i32 {
         self.left_fringe_width + self.right_fringe_width
     }
+
+    pub fn scroll_bar_area_width(self) -> i32 {
+        #[cfg(feature = "window-system")]
+        {
+            match self.vertical_scroll_bar_type() {
+                vertical_scroll_bar_type::vertical_scroll_bar_left
+                | vertical_scroll_bar_type::vertical_scroll_bar_right => {
+                    return self.config_scroll_bar_width
+                }
+                _ => return 0,
+            }
+        }
+        #[cfg(not(feature = "window-system"))]
+        {
+            return 0;
+        }
+    }
+
+    pub fn horizontal_scroll_bar_height(self) -> i32 {
+        #[cfg(feature = "window-system")]
+        {
+            if self.horizontal_scroll_bars() {
+                self.config_scroll_bar_height
+            } else {
+                0
+            }
+        }
+        #[cfg(not(feature = "window-system"))]
+        {
+            return 0;
+        }
+    }
 }
 
 impl From<LispObject> for LispFrameRef {
@@ -410,6 +445,20 @@ pub fn frame_bottom_divider_width(frame: LispFrameOrSelected) -> i32 {
     frame.bottom_divider_width
 }
 
+/// Return scroll bar width of FRAME in pixels.
+#[lisp_fn(min = "0")]
+pub fn frame_scroll_bar_width(frame: LispFrameOrSelected) -> i32 {
+    let frame: LispFrameRef = frame.into();
+    frame.scroll_bar_area_width()
+}
+
+/// Return scroll bar height of FRAME in pixels.
+#[lisp_fn(min = "0")]
+pub fn frame_scroll_bar_height(frame: LispFrameOrSelected) -> i32 {
+    let frame: LispFrameRef = frame.into();
+    frame.horizontal_scroll_bar_height()
+}
+
 /// Delete FRAME, permanently eliminating it from use.
 ///
 /// FRAME must be a live frame and defaults to the selected one.
diff --git a/src/frame.c b/src/frame.c
index 2f0e962a30..e4720a667c 100644
--- a/src/frame.c
+++ b/src/frame.c
@@ -3036,19 +3036,6 @@ is used.  */)
   return make_number (0);
 }
 
-DEFUN ("frame-scroll-bar-width", Fscroll_bar_width, Sscroll_bar_width, 0, 1, 0,
-       doc: /* Return scroll bar width of FRAME in pixels.  */)
-  (Lisp_Object frame)
-{
-  return make_number (FRAME_SCROLL_BAR_AREA_WIDTH (decode_any_frame (frame)));
-}
-
-DEFUN ("frame-scroll-bar-height", Fscroll_bar_height, Sscroll_bar_height, 0, 1, 0,
-       doc: /* Return scroll bar height of FRAME in pixels.  */)
-  (Lisp_Object frame)
-{
-  return make_number (FRAME_SCROLL_BAR_AREA_HEIGHT (decode_any_frame (frame)));
-}
 DEFUN ("set-frame-height", Fset_frame_height, Sset_frame_height, 2, 4, 0,
        doc: /* Set text height of frame FRAME to HEIGHT lines.
 Optional third arg PRETEND non-nil means that redisplay should use
@@ -5706,8 +5693,6 @@ iconify the top level frame instead.  */);
   defsubr (&Sframe_char_width);
   defsubr (&Sframe_native_height);
   defsubr (&Sframe_native_width);
-  defsubr (&Sscroll_bar_width);
-  defsubr (&Sscroll_bar_height);
   defsubr (&Stool_bar_pixel_width);
   defsubr (&Sset_frame_height);
   defsubr (&Sset_frame_width);
-- 
2.21.0


From e89bda9327cdb2ec3927ab68ce44b69e79ec01fb Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Thu, 3 Jan 2019 20:50:26 +0100
Subject: [PATCH 220/297] respect our naming conventions

---
 rust_src/src/process.rs | 18 +++++++-----------
 1 file changed, 7 insertions(+), 11 deletions(-)

diff --git a/rust_src/src/process.rs b/rust_src/src/process.rs
index f5af22ea0b..18722b3946 100644
--- a/rust_src/src/process.rs
+++ b/rust_src/src/process.rs
@@ -12,8 +12,8 @@ use crate::{
     multibyte::LispStringRef,
     remacs_sys::{
         add_process_read_fd, current_thread, delete_read_fd, emacs_get_tty_pgrp,
-        get_process as cget_process, list_system_processes, send_process,
-        setup_process_coding_systems, update_status, Fmapcar, STRING_BYTES,
+        list_system_processes, send_process, setup_process_coding_systems, update_status, Fmapcar,
+        STRING_BYTES,
     },
     remacs_sys::{pvec_type, EmacsInt, Lisp_Process, Lisp_Type, Vprocess_alist},
     remacs_sys::{
@@ -265,15 +265,11 @@ pub fn set_process_plist(mut process: LispProcessRef, plist: LispObject) -> Lisp
 /// nil, indicating the current buffer's process.
 #[lisp_fn]
 pub fn process_status(process: LispObject) -> LispObject {
-    let p = if process.is_string() {
-        get_process(process)
-    } else {
-        unsafe { cget_process(process) }
+    let mut process = match get_process(process) {
+        Qnil => return process,
+        p => LispProcessRef::from(p),
     };
-    if p.is_nil() {
-        return p;
-    }
-    let mut process = p.as_process_or_error();
+
     if process.raw_status_new() {
         unsafe { update_status(process.as_mut()) };
     }
@@ -437,7 +433,7 @@ fn pset_sentinel(mut process: LispProcessRef, val: LispObject) -> LispObject {
 pub fn process_send_string(process: LispObject, mut string: LispStringRef) {
     unsafe {
         send_process(
-            cget_process(process),
+            get_process(process),
             string.u.s.data as *mut libc::c_char,
             STRING_BYTES(string.as_mut()),
             string.into(),
-- 
2.21.0


From e336888228fe09cd1761e5a4f80294752d1e7935 Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Fri, 18 Jan 2019 10:40:38 +0100
Subject: [PATCH 221/297] Port call-process-region (#1233)

---
 rust_src/src/callproc.rs | 88 +++++++++++++++++++++++++++++++++++++++-
 rust_src/src/fileio.rs   | 14 ++++++-
 rust_src/src/keyboard.rs |  5 +--
 src/callproc.c           | 85 +-------------------------------------
 src/fileio.c             | 10 -----
 src/lisp.h               |  1 +
 6 files changed, 102 insertions(+), 101 deletions(-)

diff --git a/rust_src/src/callproc.rs b/rust_src/src/callproc.rs
index 4a1c268f68..8097d10a6a 100644
--- a/rust_src/src/callproc.rs
+++ b/rust_src/src/callproc.rs
@@ -1,16 +1,21 @@
 //! Synchronous subprocess invocation for GNU Emacs.
 
+use libc::O_RDONLY;
+
 use crate::{
+    buffers,
     coding::encode_file_name,
-    eval::unbind_to,
+    eval::{record_unwind_protect_int, unbind_to},
     fileio::expand_file_name,
     lisp::{defsubr, LispObject},
     remacs_macros::lisp_fn,
+    remacs_sys::Fdelete_region,
     remacs_sys::NULL_DEVICE,
     remacs_sys::{
-        build_string, call_process, close_file_unwind, emacs_open, record_unwind_protect_int,
+        build_string, call_process, close_file_unwind, create_temp_file, emacs_open,
         report_file_error,
     },
+    remacs_sys::{EmacsInt, Qnil},
     threads::{c_specpdl_index, ThreadState},
 };
 
@@ -88,4 +93,83 @@ pub fn call_process_lisp(args: &mut [LispObject]) -> LispObject {
     })
 }
 
+/// Send text from START to END to a synchronous process running PROGRAM.
+///
+/// START and END are normally buffer positions specifying the part of the
+/// buffer to send to the process.
+/// If START is nil, that means to use the entire buffer contents; END is
+/// ignored.
+/// If START is a string, then send that string to the process
+/// instead of any buffer contents; END is ignored.
+/// The remaining arguments are optional.
+/// Delete the text if fourth arg DELETE is non-nil.
+///
+/// Insert output in BUFFER before point; t means current buffer; nil for
+/// BUFFER means discard it; 0 means discard and don't wait; and `(:file
+/// FILE)', where FILE is a file name string, means that it should be
+/// written to that file (if the file already exists it is overwritten).
+/// BUFFER can also have the form (REAL-BUFFER STDERR-FILE); in that case,
+/// REAL-BUFFER says what to do with standard output, as above,
+/// while STDERR-FILE says what to do with standard error in the child.
+/// STDERR-FILE may be nil (discard standard error output),
+/// t (mix it with ordinary output), or a file name string.
+///
+/// Sixth arg DISPLAY non-nil means redisplay buffer as output is inserted.
+/// Remaining args are passed to PROGRAM at startup as command args.
+///
+/// If BUFFER is 0, `call-process-region' returns immediately with value nil.
+/// Otherwise it waits for PROGRAM to terminate
+/// and returns a numeric exit status or a signal description string.
+/// If you quit, the process is killed with SIGINT, or SIGKILL if you quit again.
+///
+/// usage: (call-process-region START END PROGRAM &optional DELETE BUFFER DISPLAY &rest ARGS)
+#[lisp_fn(min = "3")]
+pub fn call_process_region(args: &mut [LispObject]) -> LispObject {
+    let mut start = args[0];
+    let mut end = args[1];
+    let mut infile = Qnil;
+    let spec = c_specpdl_index();
+
+    let empty_input = if let Some(string) = start.as_string() {
+        string.len_chars() == 0
+    } else if start.is_nil() {
+        let buffer = ThreadState::current_buffer_unchecked();
+        buffer.beg() == buffer.z()
+    } else {
+        unsafe { buffers::validate_region(&mut args[0], &mut args[1]) };
+        start = args[0];
+        end = args[1];
+        EmacsInt::from(start) == EmacsInt::from(end)
+    };
+
+    let fd = unsafe {
+        if !empty_input {
+            create_temp_file(args.len() as isize, args.as_mut_ptr(), &mut infile)
+        } else {
+            let fd = emacs_open(NULL_DEVICE.as_ptr() as *const i8, O_RDONLY, 0);
+            if fd < 0 {
+                report_file_error("opening null device".as_ptr() as *const i8, Qnil);
+            }
+            record_unwind_protect_int(Some(close_file_unwind), fd);
+            fd
+        }
+    };
+
+    if args.len() > 3 && args[3].is_not_nil() {
+        unsafe { Fdelete_region(start, end) };
+    }
+
+    let args = if args.len() > 3 {
+        &mut args[2..]
+    } else {
+        args[0] = args[2];
+        &mut args[..2]
+    };
+    args[1] = infile;
+
+    let count = if empty_input { -1 } else { spec };
+    let exit = unsafe { call_process(args.len() as isize, args.as_mut_ptr(), fd, count) };
+    unbind_to(spec, exit)
+}
+
 include!(concat!(env!("OUT_DIR"), "/callproc_exports.rs"));
diff --git a/rust_src/src/fileio.rs b/rust_src/src/fileio.rs
index 0d752ba837..8662d1148e 100644
--- a/rust_src/src/fileio.rs
+++ b/rust_src/src/fileio.rs
@@ -7,19 +7,29 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     coding::encode_file_name,
-    lisp::defsubr,
-    lisp::LispObject,
+    errno::errno,
+    lisp::{defsubr, LispObject},
     lists::LispCons,
     math::{arithcompare, ArithComparison},
     multibyte::LispStringRef,
     remacs_sys::{
         check_executable, check_existing, file_name_absolute_p, file_name_case_insensitive_p,
+        report_file_errno,
     },
     remacs_sys::{Fexpand_file_name, Ffind_file_name_handler},
     remacs_sys::{Qfile_executable_p, Qfile_exists_p, Qfile_name_case_insensitive_p},
     threads::ThreadState,
 };
 
+/// Signal a file-access failure that set errno.  STRING describes the
+/// failure, NAME the file involved.  When invoking this function, take
+/// care to not use arguments such as build_string ("foo") that involve
+/// side effects that may set errno.
+#[no_mangle]
+pub unsafe extern "C" fn report_file_error(string: *const i8, name: LispObject) {
+    report_file_errno(string, name, errno().0);
+}
+
 /// Return t if (car A) is numerically less than (car B).
 #[lisp_fn]
 pub fn car_less_than_car(a: LispCons, b: LispCons) -> bool {
diff --git a/rust_src/src/keyboard.rs b/rust_src/src/keyboard.rs
index 096e2d2a4a..639dae16a3 100644
--- a/rust_src/src/keyboard.rs
+++ b/rust_src/src/keyboard.rs
@@ -4,7 +4,7 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     buffers::current_buffer,
-    eval::unbind_to,
+    eval::{record_unwind_protect, unbind_to},
     frames::{selected_frame, window_frame_live_or_selected_with_action},
     lisp::defsubr,
     lisp::LispObject,
@@ -15,8 +15,7 @@ use crate::{
         recursive_edit_1, recursive_edit_unwind, update_mode_lines,
     },
     remacs_sys::{
-        make_lispy_position, record_unwind_protect, temporarily_switch_to_single_kboard,
-        window_box_left_offset,
+        make_lispy_position, temporarily_switch_to_single_kboard, window_box_left_offset,
     },
     remacs_sys::{Fpos_visible_in_window_p, Fthrow},
     remacs_sys::{Qexit, Qheader_line, Qhelp_echo, Qmode_line, Qnil, Qt, Qvertical_line},
diff --git a/src/callproc.c b/src/callproc.c
index 78be85825e..79769c13a6 100644
--- a/src/callproc.c
+++ b/src/callproc.c
@@ -770,7 +770,7 @@ call_process (ptrdiff_t nargs, Lisp_Object *args, int filefd,
    Unwind-protect the file, so that the file descriptor will be closed
    and the file removed when the caller unwinds the specpdl stack.  */
 
-static int
+int
 create_temp_file (ptrdiff_t nargs, Lisp_Object *args,
 		  Lisp_Object *filename_string_ptr)
 {
@@ -873,88 +873,6 @@ create_temp_file (ptrdiff_t nargs, Lisp_Object *args,
   return fd;
 }
 
-DEFUN ("call-process-region", Fcall_process_region, Scall_process_region,
-       3, MANY, 0,
-       doc: /* Send text from START to END to a synchronous process running PROGRAM.
-
-START and END are normally buffer positions specifying the part of the
-buffer to send to the process.
-If START is nil, that means to use the entire buffer contents; END is
-ignored.
-If START is a string, then send that string to the process
-instead of any buffer contents; END is ignored.
-The remaining arguments are optional.
-Delete the text if fourth arg DELETE is non-nil.
-
-Insert output in BUFFER before point; t means current buffer; nil for
- BUFFER means discard it; 0 means discard and don't wait; and `(:file
- FILE)', where FILE is a file name string, means that it should be
- written to that file (if the file already exists it is overwritten).
-BUFFER can also have the form (REAL-BUFFER STDERR-FILE); in that case,
-REAL-BUFFER says what to do with standard output, as above,
-while STDERR-FILE says what to do with standard error in the child.
-STDERR-FILE may be nil (discard standard error output),
-t (mix it with ordinary output), or a file name string.
-
-Sixth arg DISPLAY non-nil means redisplay buffer as output is inserted.
-Remaining args are passed to PROGRAM at startup as command args.
-
-If BUFFER is 0, `call-process-region' returns immediately with value nil.
-Otherwise it waits for PROGRAM to terminate
-and returns a numeric exit status or a signal description string.
-If you quit, the process is killed with SIGINT, or SIGKILL if you quit again.
-
-usage: (call-process-region START END PROGRAM &optional DELETE BUFFER DISPLAY &rest ARGS)  */)
-  (ptrdiff_t nargs, Lisp_Object *args)
-{
-  Lisp_Object infile, val;
-  ptrdiff_t count = SPECPDL_INDEX ();
-  Lisp_Object start = args[0];
-  Lisp_Object end = args[1];
-  bool empty_input;
-  int fd;
-
-  if (STRINGP (start))
-    empty_input = SCHARS (start) == 0;
-  else if (NILP (start))
-    empty_input = BEG == Z;
-  else
-    {
-      validate_region (&args[0], &args[1]);
-      start = args[0];
-      end = args[1];
-      empty_input = XINT (start) == XINT (end);
-    }
-
-  if (!empty_input)
-    fd = create_temp_file (nargs, args, &infile);
-  else
-    {
-      infile = Qnil;
-      fd = emacs_open (NULL_DEVICE, O_RDONLY, 0);
-      if (fd < 0)
-	report_file_error ("Opening null device", Qnil);
-      record_unwind_protect_int (close_file_unwind, fd);
-    }
-
-  if (nargs > 3 && !NILP (args[3]))
-    Fdelete_region (start, end);
-
-  if (nargs > 3)
-    {
-      args += 2;
-      nargs -= 2;
-    }
-  else
-    {
-      args[0] = args[2];
-      nargs = 2;
-    }
-  args[1] = infile;
-
-  val = call_process (nargs, args, fd, empty_input ? -1 : count);
-  return unbind_to (count, val);
-}
 
 static char **
 add_env (char **env, char **new_env, char *string)
@@ -1553,5 +1471,4 @@ See `setenv' and `getenv'.  */);
   Vprocess_environment = Qnil;
 
   defsubr (&Sgetenv_internal);
-  defsubr (&Scall_process_region);
 }
diff --git a/src/fileio.c b/src/fileio.c
index a10fdfb8e4..da39fe526a 100644
--- a/src/fileio.c
+++ b/src/fileio.c
@@ -198,16 +198,6 @@ report_file_errno (char const *string, Lisp_Object name, int errorno)
 	     Fcons (build_string (string), errdata));
 }
 
-/* Signal a file-access failure that set errno.  STRING describes the
-   failure, NAME the file involved.  When invoking this function, take
-   care to not use arguments such as build_string ("foo") that involve
-   side effects that may set errno.  */
-
-void
-report_file_error (char const *string, Lisp_Object name)
-{
-  report_file_errno (string, name, errno);
-}
 
 /* Like report_file_error, but reports a file-notify-error instead.  */
 
diff --git a/src/lisp.h b/src/lisp.h
index 13f4038b54..bc956635be 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -4387,6 +4387,7 @@ extern void init_callproc (void);
 extern void set_initial_environment (void);
 extern void syms_of_callproc (void);
 extern Lisp_Object call_process (ptrdiff_t, Lisp_Object *, int, ptrdiff_t);
+extern int create_temp_file (ptrdiff_t, Lisp_Object *, Lisp_Object *);
 
 /* Defined in doc.c.  */
 enum text_quoting_style
-- 
2.21.0


From f2c45d888f5aaf0b87e456f338066a769eeb8098 Mon Sep 17 00:00:00 2001
From: Johannes Altmanninger <aclopte@gmail.com>
Date: Sat, 19 Jan 2019 11:06:36 +0100
Subject: [PATCH 222/297] Port signal (#1220)

Port signal
---
 rust_src/src/eval.rs        | 30 ++++++++++++++++++++++++++++--
 rust_src/src/eval_macros.rs |  4 ++--
 rust_src/src/functions.rs   |  8 --------
 rust_src/src/lib.rs         |  2 +-
 rust_src/src/remacs_sys.rs  |  1 -
 src/alloc.c                 |  2 +-
 src/bytecode.c              |  6 +++---
 src/charset.c               |  6 +++---
 src/coding.c                |  6 +++---
 src/eval.c                  | 27 ++-------------------------
 src/fontset.c               |  2 +-
 src/lisp.h                  |  2 ++
 src/lread.c                 |  4 ++--
 src/nsfns.m                 |  2 +-
 src/thread.c                |  4 ++--
 src/w32select.c             |  8 ++++----
 16 files changed, 55 insertions(+), 59 deletions(-)

diff --git a/rust_src/src/eval.rs b/rust_src/src/eval.rs
index e5a8050de9..f9db81125b 100644
--- a/rust_src/src/eval.rs
+++ b/rust_src/src/eval.rs
@@ -1,6 +1,6 @@
 //! Generic Lisp eval functions
 
-use std::ptr;
+use std::{ptr, unreachable};
 
 use libc::c_void;
 
@@ -22,7 +22,7 @@ use crate::{
         backtrace_debug_on_exit, build_string, call_debugger, check_cons_list, do_debug_on_call,
         do_one_unbind, eval_sub, find_symbol_value, funcall_lambda, funcall_subr, globals,
         grow_specpdl, internal_catch, list2, maybe_gc, maybe_quit, record_in_backtrace,
-        record_unwind_save_match_data, specbind, COMPILEDP, MODULE_FUNCTIONP,
+        record_unwind_save_match_data, signal_or_quit, specbind, COMPILEDP, MODULE_FUNCTIONP,
     },
     remacs_sys::{pvec_type, EmacsInt, Lisp_Compiled, Set_Internal_Bind},
     remacs_sys::{Fapply, Fdefault_value, Fload, Fpurecopy},
@@ -1274,4 +1274,30 @@ pub fn catch(args: LispCons) -> LispObject {
     unsafe { internal_catch(val, Some(Fprogn), body) }
 }
 
+/// Signal an error.  Args are ERROR-SYMBOL and associated DATA. This
+/// function does not return.
+///
+/// An error symbol is a symbol with an `error-conditions' property
+/// that is a list of condition names.  A handler for any of those
+/// names will get to handle this signal.  The symbol `error' should
+/// normally be one of them.
+///
+/// DATA should be a list.  Its elements are printed as part of the
+/// error message.  See Info anchor `(elisp)Definition of signal' for
+/// some details on how this error message is constructed.
+/// If the signal is handled, DATA is made available to the handler.
+/// See also the function `condition-case'.
+#[lisp_fn]
+pub fn signal(error_symbol: LispObject, data: LispObject) -> ! {
+    #[cfg(test)]
+    {
+        panic!("Fsignal called during tests.");
+    }
+    #[cfg(not(test))]
+    {
+        unsafe { signal_or_quit(error_symbol, data, false) };
+        unreachable!();
+    }
+}
+
 include!(concat!(env!("OUT_DIR"), "/eval_exports.rs"));
diff --git a/rust_src/src/eval_macros.rs b/rust_src/src/eval_macros.rs
index 8ceafce3c3..b25c5bdac3 100644
--- a/rust_src/src/eval_macros.rs
+++ b/rust_src/src/eval_macros.rs
@@ -17,13 +17,13 @@ macro_rules! xsignal {
     ($symbol:expr) => {
         #[allow(unused_unsafe)]
         unsafe {
-            crate::remacs_sys::Fsignal($symbol, crate::remacs_sys::Qnil);
+            crate::eval::signal($symbol, crate::remacs_sys::Qnil);
         }
     };
     ($symbol:expr, $($tt:tt)+) => {
         #[allow(unused_unsafe)]
         unsafe {
-            crate::remacs_sys::Fsignal($symbol, list!($($tt)+));
+            crate::eval::signal($symbol, list!($($tt)+));
         }
     };
 }
diff --git a/rust_src/src/functions.rs b/rust_src/src/functions.rs
index dd361ef382..5b2167ebb7 100644
--- a/rust_src/src/functions.rs
+++ b/rust_src/src/functions.rs
@@ -107,14 +107,6 @@ pub extern "C" fn Fcons(car: LispObject, cdr: LispObject) -> LispObject {
     return Qnil;
 }
 
-#[cfg(test)]
-#[allow(unused_variables)]
-#[allow(dead_code)]
-#[no_mangle]
-pub extern "C" fn Fsignal(error_symbol: LispObject, data: LispObject) -> ! {
-    panic!("Fsignal called during tests");
-}
-
 #[cfg(test)]
 #[allow(unused_variables)]
 #[allow(dead_code)]
diff --git a/rust_src/src/lib.rs b/rust_src/src/lib.rs
index 119144f0a7..8463e3fd29 100644
--- a/rust_src/src/lib.rs
+++ b/rust_src/src/lib.rs
@@ -137,7 +137,7 @@ static ALLOCATOR: OsxUnexecAlloc = OsxUnexecAlloc;
 include!(concat!(env!("OUT_DIR"), "/c_exports.rs"));
 
 #[cfg(test)]
-pub use crate::functions::{lispsym, make_string, make_unibyte_string, Fcons, Fsignal};
+pub use crate::functions::{lispsym, make_string, make_unibyte_string, Fcons};
 
 #[cfg(feature = "compile-errors")]
 mod compile_errors {
diff --git a/rust_src/src/remacs_sys.rs b/rust_src/src/remacs_sys.rs
index fc8560cfc1..848b19e7a8 100755
--- a/rust_src/src/remacs_sys.rs
+++ b/rust_src/src/remacs_sys.rs
@@ -48,7 +48,6 @@ extern "C" {
     // number of arguments.
     // TODO: define a Rust version of this that uses Rust strings.
     pub fn error(m: *const u8, ...) -> !;
-    pub fn Fsignal(error_symbol: Lisp_Object, data: Lisp_Object) -> !;
     pub fn memory_full(nbytes: libc::size_t) -> !;
     pub fn wrong_choice(choice: LispObject, wrong: LispObject) -> !;
     pub fn wrong_range(min: LispObject, max: LispObject, wrong: LispObject) -> !;
diff --git a/src/alloc.c b/src/alloc.c
index cc52d66b32..2660754b0b 100644
--- a/src/alloc.c
+++ b/src/alloc.c
@@ -5568,7 +5568,7 @@ purecopy (Lisp_Object obj)
   else
     {
       AUTO_STRING (fmt, "Don't know how to purify: %S");
-      Fsignal (Qerror, list1 (CALLN (Fformat, fmt, obj)));
+      xsignal1 (Qerror, CALLN (Fformat, fmt, obj));
     }
 
   if (HASH_TABLE_P (Vpurify_flag)) /* Hash consing.  */
diff --git a/src/bytecode.c b/src/bytecode.c
index e01cd58b93..c621a2af81 100644
--- a/src/bytecode.c
+++ b/src/bytecode.c
@@ -374,9 +374,9 @@ exec_byte_code (Lisp_Object bytestr, Lisp_Object vector, Lisp_Object maxdepth,
       ptrdiff_t nonrest = at >> 8;
       ptrdiff_t maxargs = rest ? PTRDIFF_MAX : nonrest;
       if (! (mandatory <= nargs && nargs <= maxargs))
-	Fsignal (Qwrong_number_of_arguments,
-		 list2 (Fcons (make_number (mandatory), make_number (nonrest)),
-			make_number (nargs)));
+        xsignal2 (Qwrong_number_of_arguments,
+                  Fcons (make_number (mandatory), make_number (nonrest)),
+                  make_number (nargs));
       ptrdiff_t pushedargs = min (nonrest, nargs);
       for (ptrdiff_t i = 0; i < pushedargs; i++, args++)
 	PUSH (*args);
diff --git a/src/charset.c b/src/charset.c
index 40c00850d2..c9e2325a22 100644
--- a/src/charset.c
+++ b/src/charset.c
@@ -843,9 +843,9 @@ usage: (define-charset-internal ...)  */)
   int nchars;
 
   if (nargs != charset_arg_max)
-    Fsignal (Qwrong_number_of_arguments,
-	     Fcons (intern ("define-charset-internal"),
-		    make_number (nargs)));
+    xsignal2 (Qwrong_number_of_arguments,
+              intern ("define-charset-internal"),
+              make_number (nargs));
 
   attrs = Fmake_vector (make_number (charset_attr_max), Qnil);
 
diff --git a/src/coding.c b/src/coding.c
index 1d2156d33b..5f800d4799 100644
--- a/src/coding.c
+++ b/src/coding.c
@@ -10560,9 +10560,9 @@ usage: (define-coding-system-internal ...)  */)
   return Qnil;
 
  short_args:
-  Fsignal (Qwrong_number_of_arguments,
-	   Fcons (intern ("define-coding-system-internal"),
-		  make_number (nargs)));
+  xsignal2(Qwrong_number_of_arguments,
+           intern ("define-coding-system-internal"),
+           make_number (nargs));
 }
 
 
diff --git a/src/eval.c b/src/eval.c
index 8bdf5aaa4f..89cb43e0d7 100644
--- a/src/eval.c
+++ b/src/eval.c
@@ -897,7 +897,7 @@ internal_catch_all_1 (Lisp_Object (*function) (void *), void *argument)
       eassert (handlerlist == c);
       Lisp_Object val = c->val;
       handlerlist = c->next;
-      Fsignal (Qno_catch, val);
+      xsignal (Qno_catch, val);
     }
 }
 
@@ -965,7 +965,6 @@ push_handler_nosignal (Lisp_Object tag_ch_val, enum handlertype handlertype)
 }
 
 
-static Lisp_Object signal_or_quit (Lisp_Object, Lisp_Object, bool);
 static Lisp_Object find_handler_clause (Lisp_Object, Lisp_Object);
 static bool maybe_call_debugger (Lisp_Object conditions, Lisp_Object sig,
 				 Lisp_Object data);
@@ -1007,27 +1006,6 @@ maybe_quit (void)
     process_pending_signals ();
 }
 
-DEFUN ("signal", Fsignal, Ssignal, 2, 2, 0,
-       doc: /* Signal an error.  Args are ERROR-SYMBOL and associated DATA.
-This function does not return.
-
-An error symbol is a symbol with an `error-conditions' property
-that is a list of condition names.
-A handler for any of those names will get to handle this signal.
-The symbol `error' should normally be one of them.
-
-DATA should be a list.  Its elements are printed as part of the error message.
-See Info anchor `(elisp)Definition of signal' for some details on how this
-error message is constructed.
-If the signal is handled, DATA is made available to the handler.
-See also the function `condition-case'.  */
-       attributes: noreturn)
-  (Lisp_Object error_symbol, Lisp_Object data)
-{
-  signal_or_quit (error_symbol, data, false);
-  eassume (false);
-}
-
 /* Quit, in response to a keyboard quit request.  */
 Lisp_Object
 quit (void)
@@ -1040,7 +1018,7 @@ quit (void)
    Qquit and DATA should be Qnil, and this function may return.
    Otherwise this function is like Fsignal and does not return.  */
 
-static Lisp_Object
+Lisp_Object
 signal_or_quit (Lisp_Object error_symbol, Lisp_Object data, bool keyboard_quit)
 {
   /* When memory is full, ERROR-SYMBOL is nil,
@@ -3060,7 +3038,6 @@ alist of active lexical bindings.  */);
   DEFSYM (Qdefvaralias, "defvaralias");
   defsubr (&Sthrow);
   defsubr (&Scondition_case);
-  defsubr (&Ssignal);
   defsubr (&Sapply);
   defsubr (&Sfunc_arity);
   defsubr (&Sfetch_bytecode);
diff --git a/src/fontset.c b/src/fontset.c
index 6ca6406871..fd697775b4 100644
--- a/src/fontset.c
+++ b/src/fontset.c
@@ -1503,7 +1503,7 @@ appended.  By default, FONT-SPEC overrides the previous settings.  */)
   else if (FONT_SPEC_P (font_spec))
     fontname = Ffont_xlfd_name (font_spec, Qnil);
   else if (! NILP (font_spec))
-    Fsignal (Qfont, list2 (build_string ("Invalid font-spec"), font_spec));
+    xsignal2 (Qfont, build_string ("Invalid font-spec"), font_spec);
 
   if (! NILP (font_spec))
     {
diff --git a/src/lisp.h b/src/lisp.h
index bc956635be..fc350fa719 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -3983,10 +3983,12 @@ extern Lisp_Object run_hook_with_args (ptrdiff_t nargs, Lisp_Object *args,
 				       Lisp_Object (*funcall)
 				       (ptrdiff_t nargs, Lisp_Object *args));
 extern Lisp_Object quit (void);
+extern Lisp_Object signal_or_quit (Lisp_Object, Lisp_Object, bool);
 INLINE _Noreturn void
 xsignal (Lisp_Object error_symbol, Lisp_Object data)
 {
   Fsignal (error_symbol, data);
+  eassume(false);
 }
 extern _Noreturn void xsignal0 (Lisp_Object);
 extern _Noreturn void xsignal1 (Lisp_Object, Lisp_Object);
diff --git a/src/lread.c b/src/lread.c
index 49a1bfe54d..5b1bbc9394 100644
--- a/src/lread.c
+++ b/src/lread.c
@@ -564,8 +564,8 @@ read_emacs_mule_char (int c, int (*readbyte) (int, Lisp_Object), Lisp_Object rea
     }
   c = DECODE_CHAR (charset, code);
   if (c < 0)
-    Fsignal (Qinvalid_read_syntax,
-	     list1 (build_string ("invalid multibyte form")));
+    xsignal1 (Qinvalid_read_syntax,
+              build_string ("invalid multibyte form"));
   return c;
 }
 
diff --git a/src/nsfns.m b/src/nsfns.m
index 6407560d89..cf1f939929 100644
--- a/src/nsfns.m
+++ b/src/nsfns.m
@@ -2035,7 +2035,7 @@ and GNUstep implementations ("distributor-specific release
   ns_string_to_pasteboard (pb, send);
 
   if (NSPerformService (svcName, pb) == NO)
-    Fsignal (Qquit, list1 (build_string ("service not available")));
+    xsignal1 (Qquit, build_string ("service not available"));
 
   if ([[pb types] count] == 0)
     return build_string ("");
diff --git a/src/thread.c b/src/thread.c
index 2c86dd1b63..c6e6d602f4 100644
--- a/src/thread.c
+++ b/src/thread.c
@@ -90,7 +90,7 @@ post_acquire_global_lock (struct thread_state *self)
 
       current_thread->error_symbol = Qnil;
       current_thread->error_data = Qnil;
-      Fsignal (sym, data);
+      xsignal (sym, data);
     }
 }
 
@@ -849,7 +849,7 @@ or `thread-join' in the target thread.  */)
   tstate = XTHREAD (thread);
 
   if (tstate == current_thread)
-    Fsignal (error_symbol, data);
+    xsignal (error_symbol, data);
 
   /* What to do if thread is already signaled?  */
   /* What if error_symbol is Qnil?  */
diff --git a/src/w32select.c b/src/w32select.c
index a9df3f770b..063d214362 100644
--- a/src/w32select.c
+++ b/src/w32select.c
@@ -494,10 +494,10 @@ setup_config (void)
 
   dos_coding_system = validate_coding_system (coding_system);
   if (NILP (dos_coding_system))
-    Fsignal (Qerror,
-	     list2 (build_string ("Coding system is invalid or doesn't have "
-				  "an eol variant for dos line ends"),
-		    coding_system));
+    xsignal2 (Qerror,
+              build_string ("Coding system is invalid or doesn't have "
+                            "an eol variant for dos line ends"),
+              coding_system);
 
   /* Check if we have it cached */
   if (!NILP (cfg_coding_system)
-- 
2.21.0


From b9b5127ca53ad2d336f4d8f7500ecee1cfefc43c Mon Sep 17 00:00:00 2001
From: Johannes Altmanninger <aclopte@gmail.com>
Date: Sat, 19 Jan 2019 14:10:25 +0100
Subject: [PATCH 223/297] Port indent-to (#1259)

Port indent-to
---
 rust_src/src/indent.rs | 60 ++++++++++++++++++++++++++++++++++++------
 rust_src/src/keymap.rs |  7 ++---
 src/indent.c           | 49 ----------------------------------
 3 files changed, 56 insertions(+), 60 deletions(-)

diff --git a/rust_src/src/indent.rs b/rust_src/src/indent.rs
index 2d8b473b40..80e6432b56 100644
--- a/rust_src/src/indent.rs
+++ b/rust_src/src/indent.rs
@@ -1,17 +1,24 @@
 //! Indentation functions
 
-use std::ptr;
+use std::{cmp::max, ptr};
 
 use remacs_macros::lisp_fn;
 
 use crate::{
     buffers::{point_byte, point_min_byte},
-    editfns::{point, point_min},
+    editfns::{insert_char, point, point_min},
     lisp::{defsubr, LispObject},
+    multibyte::Codepoint,
+    remacs_sys::globals,
     remacs_sys::EmacsUint,
-    remacs_sys::{self, find_newline, position_indentation, scan_for_column, set_point, EmacsInt},
-    remacs_sys::{del_range, last_known_column, Findent_to, Finsert_char, Qnil, Qt},
-    remacs_sys::{last_known_column_modified, last_known_column_point, set_point_both},
+    remacs_sys::{
+        self, find_newline, position_indentation, sanitize_tab_width, scan_for_column, set_point,
+        EmacsInt,
+    },
+    remacs_sys::{del_range, Qt},
+    remacs_sys::{
+        last_known_column, last_known_column_modified, last_known_column_point, set_point_both,
+    },
     threads::ThreadState,
 };
 
@@ -99,13 +106,13 @@ pub fn move_to_column(column: EmacsUint, force: LispObject) -> EmacsUint {
             unsafe {
                 // Insert spaces in front of the tab
                 set_point_both(buffer.pt - 1, buffer.pt_byte - 1);
-                Finsert_char(b' '.into(), (goal - prev_col).into(), Qt);
+                insert_char(' ' as Codepoint, Some((goal - prev_col) as EmacsInt), true);
 
                 // Delete the tab and indent to COL
                 del_range(buffer.pt, buffer.pt + 1);
                 let goal_pt = buffer.pt;
                 let goal_pt_byte = buffer.pt_byte;
-                Findent_to(col.into(), Qnil);
+                indent_to(col as EmacsInt, None);
                 set_point_both(goal_pt, goal_pt_byte);
             }
 
@@ -117,7 +124,7 @@ pub fn move_to_column(column: EmacsUint, force: LispObject) -> EmacsUint {
     // If line ends prematurely, add space to the end.
     if col < goal && force == Qt {
         col = goal;
-        unsafe { Findent_to(col.into(), Qnil) };
+        indent_to(col as EmacsInt, None);
     }
 
     unsafe {
@@ -134,4 +141,41 @@ pub extern "C" fn invalidate_current_column() {
     unsafe { last_known_column_point = 0 };
 }
 
+/// Indent from point with tabs and spaces until COLUMN is reached.
+/// Optional second argument MINIMUM says always do at least MINIMUM
+/// spaces even if that goes past COLUMN; by default, MINIMUM is zero.
+///
+/// The return value is the column where the insertion ends.
+#[lisp_fn(min = "1", intspec = "NIndent to column: ")]
+pub fn indent_to(column: EmacsInt, minimum: Option<EmacsInt>) -> EmacsInt {
+    let buffer = ThreadState::current_buffer_unchecked();
+    let tab_width = unsafe { sanitize_tab_width(buffer.tab_width_.force_fixnum()) } as EmacsInt;
+    let arg_minimum = minimum.unwrap_or(0);
+    let mut fromcol = current_column();
+    let mincol = max(fromcol + arg_minimum, column);
+
+    if fromcol == mincol {
+        return mincol;
+    }
+
+    if unsafe { globals.indent_tabs_mode } {
+        let n = mincol / tab_width - fromcol / tab_width;
+        if n != 0 {
+            insert_char('\t' as Codepoint, Some(n), true);
+            fromcol = (mincol / tab_width) * tab_width;
+        }
+    }
+
+    let missing = mincol - fromcol;
+    insert_char(' ' as Codepoint, Some(missing), true);
+
+    unsafe {
+        last_known_column = mincol as isize;
+        last_known_column_point = buffer.pt;
+        last_known_column_modified = buffer.modifications();
+    }
+
+    mincol
+}
+
 include!(concat!(env!("OUT_DIR"), "/indent_exports.rs"));
diff --git a/rust_src/src/keymap.rs b/rust_src/src/keymap.rs
index 9f38a48522..b1733fa85e 100644
--- a/rust_src/src/keymap.rs
+++ b/rust_src/src/keymap.rs
@@ -11,6 +11,7 @@ use crate::{
     buffers::current_buffer,
     data::{aref, fset, indirect_function, set},
     eval::{autoload_do_load, unbind_to},
+    indent::indent_to,
     keyboard::lucid_event_type_list_p,
     lisp::{defsubr, LispObject},
     lists::{nth, setcdr},
@@ -23,8 +24,8 @@ use crate::{
     },
     remacs_sys::{char_bits, current_global_map as _current_global_map, globals, EmacsInt},
     remacs_sys::{
-        Fcopy_sequence, Fevent_convert_list, Findent_to, Fmake_char_table, Fpurecopy,
-        Fset_char_table_range, Fterpri,
+        Fcopy_sequence, Fevent_convert_list, Fmake_char_table, Fpurecopy, Fset_char_table_range,
+        Fterpri,
     },
     remacs_sys::{
         Qautoload, Qkeymap, Qkeymapp, Qnil, Qstandard_output, Qt, Qvector_or_char_table_p,
@@ -575,7 +576,7 @@ pub fn make_sparse_keymap(string: LispObject) -> LispObject {
 
 #[no_mangle]
 pub extern "C" fn describe_vector_princ(elt: LispObject, fun: LispObject) {
-    unsafe { Findent_to(LispObject::from_fixnum(16), LispObject::from_fixnum(1)) };
+    indent_to(16, 1.into());
     call!(fun, elt);
     unsafe { Fterpri(Qnil, Qnil) };
 }
diff --git a/src/indent.c b/src/indent.c
index f9e2d21a84..58b6f182be 100644
--- a/src/indent.c
+++ b/src/indent.c
@@ -779,54 +779,6 @@ string_display_width (Lisp_Object string, Lisp_Object beg, Lisp_Object end)
 #endif /* 0 */
 
 
-DEFUN ("indent-to", Findent_to, Sindent_to, 1, 2, "NIndent to column: ",
-       doc: /* Indent from point with tabs and spaces until COLUMN is reached.
-Optional second argument MINIMUM says always do at least MINIMUM spaces
-even if that goes past COLUMN; by default, MINIMUM is zero.
-
-The return value is the column where the insertion ends.  */)
-  (Lisp_Object column, Lisp_Object minimum)
-{
-  EMACS_INT mincol;
-  register ptrdiff_t fromcol;
-  int tab_width = SANE_TAB_WIDTH (current_buffer);
-
-  CHECK_NUMBER (column);
-  if (NILP (minimum))
-    XSETFASTINT (minimum, 0);
-  CHECK_NUMBER (minimum);
-
-  fromcol = current_column ();
-  mincol = fromcol + XINT (minimum);
-  if (mincol < XINT (column)) mincol = XINT (column);
-
-  if (fromcol == mincol)
-    return make_number (mincol);
-
-  if (indent_tabs_mode)
-    {
-      Lisp_Object n;
-      XSETFASTINT (n, mincol / tab_width - fromcol / tab_width);
-      if (XFASTINT (n) != 0)
-	{
-	  Finsert_char (make_number ('\t'), n, Qt);
-
-	  fromcol = (mincol / tab_width) * tab_width;
-	}
-    }
-
-  XSETFASTINT (column, mincol - fromcol);
-  Finsert_char (make_number (' '), column, Qt);
-
-  last_known_column = mincol;
-  last_known_column_point = PT;
-  last_known_column_modified = MODIFF;
-
-  XSETINT (column, mincol);
-  return column;
-}
-
-
 ptrdiff_t
 position_indentation (ptrdiff_t pos_byte)
 {
@@ -2261,7 +2213,6 @@ syms_of_indent (void)
 
   DEFSYM (Qcolumns, "columns");
 
-  defsubr (&Sindent_to);
   defsubr (&Sline_number_display_width);
   defsubr (&Svertical_motion);
   defsubr (&Scompute_motion);
-- 
2.21.0


From a80f63647a8bf4d24ec3b06cc734fada2b775463 Mon Sep 17 00:00:00 2001
From: Nick Drozd <nicholasdrozd@gmail.com>
Date: Sat, 19 Jan 2019 18:05:08 -0600
Subject: [PATCH 224/297] Cut more type_or_error methods (#1257)

* Cut LispObject::from_bool

* Cut as_subr_or_error

* Cut as_buffer_or_error

* Cut as_process_or_error

* Cut as_overlay_or_error

* Cut as_window_or_error

* Cut as_thread_or_error
---
 rust_src/src/buffers.rs              | 19 +++++----------
 rust_src/src/editfns.rs              |  4 ++--
 rust_src/src/frames.rs               |  2 +-
 rust_src/src/keyboard.rs             |  2 +-
 rust_src/src/lisp.rs                 | 12 ----------
 rust_src/src/process.rs              | 10 +++-----
 rust_src/src/threads.rs              |  4 ----
 rust_src/src/vectors.rs              |  6 ++---
 rust_src/src/window_configuration.rs |  3 ++-
 rust_src/src/windows.rs              | 35 +++++++++++++---------------
 10 files changed, 33 insertions(+), 64 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index c4cf49f7d6..676b2f3a74 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -439,10 +439,6 @@ impl LispObject {
     pub fn as_live_buffer(self) -> Option<LispBufferRef> {
         self.as_buffer().and_then(|b| b.as_live())
     }
-
-    pub fn as_buffer_or_error(self) -> LispBufferRef {
-        self.into()
-    }
 }
 
 impl From<LispObject> for LispBufferRef {
@@ -472,10 +468,6 @@ impl LispObject {
     pub fn as_overlay(self) -> Option<LispOverlayRef> {
         self.into()
     }
-
-    pub fn as_overlay_or_error(self) -> LispOverlayRef {
-        self.into()
-    }
 }
 
 impl From<LispObject> for LispOverlayRef {
@@ -589,9 +581,10 @@ impl From<LispObject> for LispBufferOrName {
     fn from(v: LispObject) -> Self {
         if v.is_string() {
             LispBufferOrName::Name(v)
-        } else {
-            v.as_buffer_or_error();
+        } else if v.is_buffer() {
             LispBufferOrName::Buffer(v)
+        } else {
+            wrong_type!(Qbufferp, v);
         }
     }
 }
@@ -1017,7 +1010,7 @@ pub extern "C" fn build_overlay(
 ) -> LispObject {
     unsafe {
         let obj = allocate_misc(Lisp_Misc_Type::Lisp_Misc_Overlay);
-        let mut overlay = obj.as_overlay_or_error();
+        let mut overlay: LispOverlayRef = obj.into();
         overlay.start = start;
         overlay.end = end;
         overlay.plist = plist;
@@ -1195,8 +1188,8 @@ pub unsafe extern "C" fn copy_overlays(
         let start = duplicate_marker(overlay.start);
         let end = duplicate_marker(overlay.end);
 
-        let mut overlay_new =
-            build_overlay(start, end, Fcopy_sequence(overlay.plist)).as_overlay_or_error();
+        let mut overlay_new: LispOverlayRef =
+            build_overlay(start, end, Fcopy_sequence(overlay.plist)).into();
 
         match tail {
             Some(mut tail_ref) => tail_ref.next = overlay_new.as_mut(),
diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index 136d362898..e3cfb8f00f 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -46,7 +46,7 @@ use crate::{
     threads::{c_specpdl_index, ThreadState},
     time::{lisp_time_struct, time_overflow, LispTime},
     util::clip_to_bounds,
-    windows::selected_window,
+    windows::{selected_window, LispWindowRef},
 };
 
 /// Return value of point, as an integer.
@@ -1113,7 +1113,7 @@ pub fn buffer_substring_no_properties(mut beg: LispObject, mut end: LispObject)
 // offload some work from GC.
 #[no_mangle]
 pub extern "C" fn save_excursion_save() -> LispObject {
-    let window = selected_window().as_window_or_error();
+    let window: LispWindowRef = selected_window().into();
 
     unsafe {
         make_save_obj_obj_obj_obj(
diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index e5e59a7a44..4d19c04138 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -366,7 +366,7 @@ pub fn frame_root_window(frame_or_window: LispObject) -> LispObject {
 /// the first window of that frame.
 #[lisp_fn(min = "0")]
 pub fn frame_first_window(frame_or_window: LispObject) -> LispWindowRef {
-    let mut window = frame_root_window(frame_or_window).as_window_or_error();
+    let mut window: LispWindowRef = frame_root_window(frame_or_window).into();
 
     while let Some(win) = window.contents.as_window() {
         window = win;
diff --git a/rust_src/src/keyboard.rs b/rust_src/src/keyboard.rs
index 639dae16a3..3c0d7591e9 100644
--- a/rust_src/src/keyboard.rs
+++ b/rust_src/src/keyboard.rs
@@ -125,7 +125,7 @@ pub fn lucid_event_type_list_p(event: Option<LispCons>) -> bool {
 pub fn quit_recursive_edit(val: bool) -> ! {
     unsafe {
         if command_loop_level > 0 || minibuf_level > 0 {
-            Fthrow(Qexit, LispObject::from_bool(val));
+            Fthrow(Qexit, val.into());
         }
 
         user_error!("No recursive edit is in progress");
diff --git a/rust_src/src/lisp.rs b/rust_src/src/lisp.rs
index e969cf60b2..8d2dc4d3ec 100644
--- a/rust_src/src/lisp.rs
+++ b/rust_src/src/lisp.rs
@@ -64,14 +64,6 @@ impl LispObject {
         self.0 as EmacsUint
     }
 
-    pub fn from_bool(v: bool) -> Self {
-        if v {
-            Qt
-        } else {
-            Qnil
-        }
-    }
-
     pub fn from_float(v: EmacsDouble) -> Self {
         unsafe { make_float(v) }
     }
@@ -247,10 +239,6 @@ impl LispObject {
     pub fn as_subr(self) -> Option<LispSubrRef> {
         self.into()
     }
-
-    pub fn as_subr_or_error(self) -> LispSubrRef {
-        self.into()
-    }
 }
 
 impl From<LispObject> for LispSubrRef {
diff --git a/rust_src/src/process.rs b/rust_src/src/process.rs
index 18722b3946..9387a6eb7f 100644
--- a/rust_src/src/process.rs
+++ b/rust_src/src/process.rs
@@ -52,10 +52,6 @@ impl LispObject {
     pub fn as_process(self) -> Option<LispProcessRef> {
         self.into()
     }
-
-    pub fn as_process_or_error(self) -> LispProcessRef {
-        self.into()
-    }
 }
 
 impl From<LispObject> for LispProcessRef {
@@ -119,7 +115,7 @@ pub extern "C" fn get_process(name: LispObject) -> LispObject {
                 Some(proc) => proc.into(),
             }
         }
-        None => proc_or_buf.as_process_or_error().into(),
+        None => LispProcessRef::from(proc_or_buf).into(),
     }
 }
 
@@ -310,7 +306,7 @@ pub fn process_thread(process: LispProcessRef) -> LispObject {
 /// nil, indicating the current buffer's process.
 #[lisp_fn]
 pub fn process_type(process: LispObject) -> LispObject {
-    let p_ref = get_process(process).as_process_or_error();
+    let p_ref: LispProcessRef = get_process(process).into();
     p_ref.ptype()
 }
 
@@ -495,7 +491,7 @@ pub fn process_running_child_p(mut process: LispObject) -> LispObject {
     // Initialize in case ioctl doesn't exist or gives an error,
     // in a way that will cause returning t.
     process = get_process(process);
-    let mut proc_ref = process.as_process_or_error();
+    let mut proc_ref: LispProcessRef = process.into();
 
     if !proc_ref.ptype().eq(Qreal) {
         error!("Process {} is not a subprocess.", proc_ref.name);
diff --git a/rust_src/src/threads.rs b/rust_src/src/threads.rs
index f2d67d73e1..3d02878555 100644
--- a/rust_src/src/threads.rs
+++ b/rust_src/src/threads.rs
@@ -67,10 +67,6 @@ impl LispObject {
     pub fn as_thread(self) -> Option<ThreadStateRef> {
         self.as_vectorlike().and_then(|v| v.as_thread())
     }
-
-    pub fn as_thread_or_error(self) -> ThreadStateRef {
-        self.into()
-    }
 }
 
 // FIXME: The right thing to do is start indexing thread.m_specpdl as
diff --git a/rust_src/src/vectors.rs b/rust_src/src/vectors.rs
index e1f5645bc0..5d72f50eb9 100644
--- a/rust_src/src/vectors.rs
+++ b/rust_src/src/vectors.rs
@@ -544,12 +544,10 @@ impl<'a> Iterator for LispBoolVecIterator<'a> {
             if self.cur % BITS_PER_BITS_WORD as usize == 0 {
                 self.limb = self.bvec_slice[self.cur / BITS_PER_BITS_WORD as usize];
             }
-            let res = LispObject::from_bool(
-                self.limb & (1 << (self.cur % BITS_PER_BITS_WORD as usize)) != 0,
-            );
+            let res = self.limb & (1 << (self.cur % BITS_PER_BITS_WORD as usize)) != 0;
 
             self.cur += 1;
-            Some(res)
+            Some(res.into())
         }
     }
 
diff --git a/rust_src/src/window_configuration.rs b/rust_src/src/window_configuration.rs
index 1a8715a84e..3acbfcc670 100644
--- a/rust_src/src/window_configuration.rs
+++ b/rust_src/src/window_configuration.rs
@@ -9,6 +9,7 @@ use crate::{
     objects::equal,
     remacs_sys::Qwindow_configuration_p,
     remacs_sys::{save_window_data, saved_window},
+    windows::LispWindowRef,
 };
 
 pub type SaveWindowDataRef = ExternalPtr<save_window_data>;
@@ -127,7 +128,7 @@ pub fn window_configuration_frame(config: SaveWindowDataRef) -> LispFrameRef {
     let saved_windows = config.saved_windows.as_vector().unwrap();
     let obj = saved_windows.get(0);
     let saved = SavedWindowRef::new(obj.as_vector().unwrap().as_mut() as *mut saved_window);
-    saved.window.as_window_or_error().frame.into()
+    LispWindowRef::from(saved.window).frame.into()
 }
 
 // Return true if window configurations CONFIGURATION1 and CONFIGURATION2
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 39e68d545b..58580b613f 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -7,6 +7,7 @@ use libc::c_int;
 use remacs_macros::lisp_fn;
 
 use crate::{
+    buffers::LispBufferRef,
     editfns::{goto_char, point},
     frames::{LispFrameOrSelected, LispFrameRef},
     interactive::prefix_numeric_value,
@@ -69,7 +70,7 @@ impl LispWindowRef {
             matrix_mode_line_height
         } else {
             let mut frame = self.get_frame();
-            let window = selected_window().as_window_or_error();
+            let window: LispWindowRef = selected_window().into();
             let mode_line_height = unsafe {
                 estimate_mode_line_height(frame.as_mut(), CURRENT_MODE_LINE_FACE_ID(window))
             };
@@ -166,6 +167,10 @@ impl LispWindowRef {
         y + self.top_edge_y()
     }
 
+    pub fn contents_as_buffer(self) -> LispBufferRef {
+        self.contents.into()
+    }
+
     /// True if window wants a mode line and is high enough to
     /// accommodate it, false otherwise.
     ///
@@ -182,11 +187,7 @@ impl LispWindowRef {
             && !self.is_pseudo()
             && !window_mode_line_format.eq(Qnone)
             && (window_mode_line_format.is_not_nil()
-                || self
-                    .contents
-                    .as_buffer_or_error()
-                    .mode_line_format_
-                    .is_not_nil())
+                || self.contents_as_buffer().mode_line_format_.is_not_nil())
             && self.pixel_height > self.get_frame().line_height
     }
 
@@ -212,7 +213,7 @@ impl LispWindowRef {
             && !self.is_pseudo()
             && !window_header_line_format.eq(Qnone)
             && (window_header_line_format.is_not_nil()
-                || (self.contents.as_buffer_or_error().header_line_format_).is_not_nil())
+                || (self.contents_as_buffer().header_line_format_).is_not_nil())
             && self.pixel_height > height
     }
 
@@ -257,10 +258,6 @@ impl LispObject {
         self.into()
     }
 
-    pub fn as_window_or_error(self) -> LispWindowRef {
-        self.into()
-    }
-
     pub fn as_minibuffer_or_error(self) -> LispWindowRef {
         let w = self
             .as_window()
@@ -320,7 +317,7 @@ impl From<LispWindowOrSelected> for LispObject {
 
 impl From<LispWindowOrSelected> for LispWindowRef {
     fn from(w: LispWindowOrSelected) -> Self {
-        w.0.as_window_or_error()
+        w.0.into()
     }
 }
 
@@ -330,7 +327,7 @@ impl From<LispObject> for LispWindowLiveOrSelected {
     /// Same as the `decode_live_window` function
     fn from(obj: LispObject) -> Self {
         Self(obj.map_or_else(
-            || selected_window().as_window_or_error(),
+            || LispWindowRef::from(selected_window()),
             |w| w.as_live_window_or_error(),
         ))
     }
@@ -348,7 +345,7 @@ impl From<LispObject> for LispWindowValidOrSelected {
     /// Same as the `decode_valid_window` function
     fn from(obj: LispObject) -> Self {
         Self(obj.map_or_else(
-            || selected_window().as_window_or_error(),
+            || LispWindowRef::from(selected_window()),
             |w| w.as_valid_window_or_error(),
         ))
     }
@@ -393,7 +390,7 @@ pub fn window_live_p(object: Option<LispWindowRef>) -> bool {
 #[lisp_fn(min = "0")]
 pub fn window_point(window: LispWindowLiveOrSelected) -> Option<EmacsInt> {
     let win: LispWindowRef = window.into();
-    if win == selected_window().as_window_or_error() {
+    if win == LispWindowRef::from(selected_window()) {
         Some(point())
     } else {
         marker_position_lisp(win.pointm.into())
@@ -532,7 +529,7 @@ pub fn minibuffer_selected_window() -> LispObject {
     let level = unsafe { minibuf_level };
     let current_minibuf = unsafe { current_minibuf_window };
     if level > 0
-        && selected_window().as_window_or_error().is_minibuffer()
+        && LispWindowRef::from(selected_window()).is_minibuffer()
         && current_minibuf.as_window().unwrap().is_live()
     {
         current_minibuf
@@ -912,7 +909,7 @@ pub fn set_window_point(window: LispWindowLiveOrSelected, pos: LispObject) -> Li
     let mut win: LispWindowRef = window.into();
 
     // Type of POS is checked by Fgoto_char or set_marker_restricted ...
-    if win == selected_window().as_window_or_error() {
+    if win == LispWindowRef::from(selected_window()) {
         let mut current_buffer = ThreadState::current_buffer_unchecked();
 
         if win
@@ -925,7 +922,7 @@ pub fn set_window_point(window: LispWindowLiveOrSelected, pos: LispObject) -> Li
             // ... but here we want to catch type error before buffer change.
             pos.as_number_coerce_marker_or_error();
             unsafe {
-                set_buffer_internal(win.contents.as_buffer_or_error().as_mut());
+                set_buffer_internal(win.contents_as_buffer().as_mut());
             }
             goto_char(pos);
             unsafe {
@@ -983,7 +980,7 @@ pub fn window_top_child(window: LispWindowValidOrSelected) -> Option<LispWindowR
 }
 
 pub fn scroll_horizontally(arg: LispObject, set_minimum: LispObject, left: bool) -> LispObject {
-    let mut w = selected_window().as_window_or_error();
+    let mut w: LispWindowRef = selected_window().into();
     let requested_arg = if arg.is_nil() {
         unsafe { EmacsInt::from(window_body_width(w.as_mut(), false)) - 2 }
     } else if left {
-- 
2.21.0


From c3a6ef4f1eed1c128f38d380c76510596e6e7355 Mon Sep 17 00:00:00 2001
From: Georgy Komarov <jubnzv@gmail.com>
Date: Sun, 20 Jan 2019 22:18:53 +0300
Subject: [PATCH 225/297] Port frame-focus (#1255)

Port focus-frame
---
 rust_src/src/frames.rs | 10 ++++++++++
 src/frame.c            | 11 -----------
 2 files changed, 10 insertions(+), 11 deletions(-)

diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index 4d19c04138..9b24321607 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -583,4 +583,14 @@ pub fn frame_after_make_frame(frame: LispFrameOrSelected, made: LispObject) -> L
     made
 }
 
+/// Return the frame to which FRAME's keystrokes are currently being sent.
+/// If FRAME is omitted or nil, the selected frame is used.
+/// Return nil if FRAME's focus is not redirected.
+/// See `redirect-frame-focus'.
+#[lisp_fn(min = "0")]
+pub fn frame_focus(frame: LispFrameLiveOrSelected) -> LispObject {
+    let frame_ref: LispFrameRef = frame.into();
+    frame_ref.focus_frame
+}
+
 include!(concat!(env!("OUT_DIR"), "/frames_exports.rs"));
diff --git a/src/frame.c b/src/frame.c
index e4720a667c..35ea4a2740 100644
--- a/src/frame.c
+++ b/src/frame.c
@@ -2478,16 +2478,6 @@ The redirection lasts until `redirect-frame-focus' is called to change it.  */)
 }
 
 
-DEFUN ("frame-focus", Fframe_focus, Sframe_focus, 0, 1, 0,
-       doc: /* Return the frame to which FRAME's keystrokes are currently being sent.
-If FRAME is omitted or nil, the selected frame is used.
-Return nil if FRAME's focus is not redirected.
-See `redirect-frame-focus'.  */)
-  (Lisp_Object frame)
-{
-  return FRAME_FOCUS_FRAME (decode_live_frame (frame));
-}
-
 DEFUN ("x-focus-frame", Fx_focus_frame, Sx_focus_frame, 1, 2, 0,
        doc: /* Set the input focus to FRAME.
 FRAME nil means use the selected frame.  Optional argument NOACTIVATE
@@ -5685,7 +5675,6 @@ iconify the top level frame instead.  */);
   defsubr (&Slower_frame);
   defsubr (&Sx_focus_frame);
   defsubr (&Sredirect_frame_focus);
-  defsubr (&Sframe_focus);
   defsubr (&Sframe_parameters);
   defsubr (&Sframe_parameter);
   defsubr (&Smodify_frame_parameters);
-- 
2.21.0


From dc1e7de2caa5eb0e1b50ab868f52594678494379 Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Mon, 21 Jan 2019 08:51:36 +0100
Subject: [PATCH 226/297] add is_empty predicate to strings (#1265)

---
 rust_src/src/callproc.rs  | 2 +-
 rust_src/src/fileio.rs    | 2 +-
 rust_src/src/minibuf.rs   | 2 +-
 rust_src/src/multibyte.rs | 4 ++++
 4 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/rust_src/src/callproc.rs b/rust_src/src/callproc.rs
index 8097d10a6a..5d0ddef635 100644
--- a/rust_src/src/callproc.rs
+++ b/rust_src/src/callproc.rs
@@ -131,7 +131,7 @@ pub fn call_process_region(args: &mut [LispObject]) -> LispObject {
     let spec = c_specpdl_index();
 
     let empty_input = if let Some(string) = start.as_string() {
-        string.len_chars() == 0
+        string.is_empty()
     } else if start.is_nil() {
         let buffer = ThreadState::current_buffer_unchecked();
         buffer.beg() == buffer.z()
diff --git a/rust_src/src/fileio.rs b/rust_src/src/fileio.rs
index 8662d1148e..f9157cf4de 100644
--- a/rust_src/src/fileio.rs
+++ b/rust_src/src/fileio.rs
@@ -41,7 +41,7 @@ def_lisp_sym!(Qcar_less_than_car, "car-less-than-car");
 /// Return non-nil if NAME ends with a directory separator character.
 #[lisp_fn]
 pub fn directory_name_p(name: LispStringRef) -> bool {
-    if name.len_bytes() == 0 {
+    if name.is_empty() {
         return false;
     }
 
diff --git a/rust_src/src/minibuf.rs b/rust_src/src/minibuf.rs
index 9f664f7a0a..2b12b91f59 100644
--- a/rust_src/src/minibuf.rs
+++ b/rust_src/src/minibuf.rs
@@ -335,7 +335,7 @@ pub fn read_string(
     );
 
     if let Some(s) = val.as_string() {
-        if s.len_chars() == 0 && default_value.is_not_nil() {
+        if s.is_empty() && default_value.is_not_nil() {
             val = match default_value.into() {
                 None => default_value,
                 Some((a, _)) => a,
diff --git a/rust_src/src/multibyte.rs b/rust_src/src/multibyte.rs
index 36be421040..ac6d51a2f8 100644
--- a/rust_src/src/multibyte.rs
+++ b/rust_src/src/multibyte.rs
@@ -92,6 +92,10 @@ impl LispStringRef {
         unsafe { lisp_string_width(self.into(), -1, ptr::null_mut(), ptr::null_mut()) as usize }
     }
 
+    pub fn is_empty(self) -> bool {
+        self.len_chars() == 0
+    }
+
     pub fn is_multibyte(self) -> bool {
         let s = unsafe { self.u.s };
         s.size_byte >= 0
-- 
2.21.0


From 501c21608ba031d9b3f7a30670ac5b94ec1b99bf Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Mon, 21 Jan 2019 13:57:41 +0100
Subject: [PATCH 227/297] Add missing is_empty usages (#1271)

---
 rust_src/src/chartable.rs | 2 +-
 rust_src/src/editfns.rs   | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/rust_src/src/chartable.rs b/rust_src/src/chartable.rs
index 718c1154c9..ac708ebdd0 100644
--- a/rust_src/src/chartable.rs
+++ b/rust_src/src/chartable.rs
@@ -99,7 +99,7 @@ fn chartab_idx(c: isize, depth: i32, min_char: i32) -> usize {
 /// starting with '\001' nor '\002'.
 fn uniprop_compressed_form_p(obj: LispObject) -> bool {
     match obj.as_string() {
-        Some(s) => s.len_bytes() > 0 && (s.byte_at(0) == 1 || s.byte_at(0) == 2),
+        Some(s) => !s.is_empty() && (s.byte_at(0) == 1 || s.byte_at(0) == 2),
         None => false,
     }
 }
diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index e3cfb8f00f..0d0eccdcb0 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -462,7 +462,7 @@ pub fn byte_to_string(byte: EmacsInt) -> LispObject {
 /// Return the first character in STRING.
 #[lisp_fn]
 pub fn string_to_char(string: LispStringRef) -> EmacsInt {
-    if string.len_chars() > 0 {
+    if !string.is_empty() {
         if string.is_multibyte() {
             let (cp, _) = multibyte_char_at(string.as_slice());
             EmacsInt::from(cp)
-- 
2.21.0


From b06402ab6ba6308df7c9a23d0b0395ec242349d0 Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Mon, 21 Jan 2019 16:11:20 +0100
Subject: [PATCH 228/297] Port record and make-record (#1258)

---
 rust_src/src/alloc.rs            | 44 +++++++++++++++++++++++++++++---
 src/alloc.c                      | 35 +------------------------
 src/lisp.h                       |  1 +
 test/rust_src/src/alloc-tests.el |  8 ++++++
 4 files changed, 51 insertions(+), 37 deletions(-)

diff --git a/rust_src/src/alloc.rs b/rust_src/src/alloc.rs
index 1336d47fb7..94b69f2843 100644
--- a/rust_src/src/alloc.rs
+++ b/rust_src/src/alloc.rs
@@ -3,10 +3,13 @@
 use remacs_macros::lisp_fn;
 
 use crate::{
-    lisp::{defsubr, LispObject},
+    lisp::{defsubr, ExternalPtr, LispObject},
     remacs_sys::globals,
-    remacs_sys::EmacsInt,
-    remacs_sys::{bool_vector_fill, bool_vector_set, bounded_number, make_uninit_bool_vector},
+    remacs_sys::Lisp_Type::Lisp_Vectorlike,
+    remacs_sys::{
+        allocate_record, bool_vector_fill, bool_vector_set, bounded_number, make_uninit_bool_vector,
+    },
+    remacs_sys::{EmacsInt, EmacsUint},
 };
 
 /// Return a list of counters that measure how much consing there has been.
@@ -57,4 +60,39 @@ pub fn bool_vector(args: &mut [LispObject]) -> LispObject {
     vector
 }
 
+/// Create a new record.
+/// TYPE is its type as returned by `type-of'; it should be either a
+/// symbol or a type descriptor.  SLOTS is the number of non-type slots,
+/// each initialized to INIT.
+#[lisp_fn]
+pub fn make_record(r#type: LispObject, slots: EmacsUint, init: LispObject) -> LispObject {
+    let size = slots + 1;
+    unsafe {
+        let ptr = allocate_record(size as i64);
+        let contents = (*ptr).contents.as_mut_slice(size as usize);
+        contents[0] = r#type;
+        for rec in contents.iter_mut().skip(1) {
+            *rec = init;
+        }
+        LispObject::tag_ptr(ExternalPtr::new(ptr), Lisp_Vectorlike)
+    }
+}
+
+/// Create a new record.
+/// TYPE is its type as returned by `type-of'; it should be either a
+/// symbol or a type descriptor.  SLOTS is used to initialize the record
+/// slots with shallow copies of the arguments.
+/// usage: (record TYPE &rest SLOTS)
+#[lisp_fn]
+pub fn record(args: &mut [LispObject]) -> LispObject {
+    unsafe {
+        let ptr = allocate_record(args.len() as i64);
+        (*ptr)
+            .contents
+            .as_mut_slice(args.len())
+            .copy_from_slice(args);
+        LispObject::tag_ptr(ExternalPtr::new(ptr), Lisp_Vectorlike)
+    }
+}
+
 include!(concat!(env!("OUT_DIR"), "/alloc_exports.rs"));
diff --git a/src/alloc.c b/src/alloc.c
index 2660754b0b..007ed87df5 100644
--- a/src/alloc.c
+++ b/src/alloc.c
@@ -3344,7 +3344,7 @@ allocate_buffer (void)
 /* Allocate a record with COUNT slots.  COUNT must be positive, and
    includes the type slot.  */
 
-static struct Lisp_Vector *
+struct Lisp_Vector *
 allocate_record (EMACS_INT count)
 {
   if (count > PSEUDOVECTOR_SIZE_MASK)
@@ -3357,37 +3357,6 @@ allocate_record (EMACS_INT count)
 }
 
 
-DEFUN ("make-record", Fmake_record, Smake_record, 3, 3, 0,
-       doc: /* Create a new record.
-TYPE is its type as returned by `type-of'; it should be either a
-symbol or a type descriptor.  SLOTS is the number of non-type slots,
-each initialized to INIT.  */)
-  (Lisp_Object type, Lisp_Object slots, Lisp_Object init)
-{
-  CHECK_NATNUM (slots);
-  EMACS_INT size = XFASTINT (slots) + 1;
-  struct Lisp_Vector *p = allocate_record (size);
-  p->contents[0] = type;
-  for (ptrdiff_t i = 1; i < size; i++)
-    p->contents[i] = init;
-  return make_lisp_ptr (p, Lisp_Vectorlike);
-}
-
-
-DEFUN ("record", Frecord, Srecord, 1, MANY, 0,
-       doc: /* Create a new record.
-TYPE is its type as returned by `type-of'; it should be either a
-symbol or a type descriptor.  SLOTS is used to initialize the record
-slots with shallow copies of the arguments.
-usage: (record TYPE &rest SLOTS) */)
-  (ptrdiff_t nargs, Lisp_Object *args)
-{
-  struct Lisp_Vector *p = allocate_record (nargs);
-  memcpy (p->contents, args, nargs * sizeof *args);
-  return make_lisp_ptr (p, Lisp_Vectorlike);
-}
-
-
 DEFUN ("make-vector", Fmake_vector, Smake_vector, 2, 2, 0,
        doc: /* Return a newly created vector of length LENGTH, with each element being INIT.
 See also the function `vector'.  */)
@@ -7451,10 +7420,8 @@ The time is in seconds as a floating point value.  */);
 
   defsubr (&Scons);
   defsubr (&Svector);
-  defsubr (&Srecord);
   defsubr (&Smake_byte_code);
   defsubr (&Smake_vector);
-  defsubr (&Smake_record);
   defsubr (&Smake_string);
   defsubr (&Smake_symbol);
   defsubr (&Smake_marker);
diff --git a/src/lisp.h b/src/lisp.h
index fc350fa719..931090aad4 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -3783,6 +3783,7 @@ build_string (const char *str)
 extern Lisp_Object pure_cons (Lisp_Object, Lisp_Object);
 extern void make_byte_code (struct Lisp_Vector *);
 extern struct Lisp_Vector *allocate_vector (EMACS_INT);
+extern struct Lisp_Vector *allocate_record (EMACS_INT);
 
 /* Make an uninitialized vector for SIZE objects.  NOTE: you must
    be sure that GC cannot happen until the vector is completely
diff --git a/test/rust_src/src/alloc-tests.el b/test/rust_src/src/alloc-tests.el
index f9f08af87c..2771fe5537 100644
--- a/test/rust_src/src/alloc-tests.el
+++ b/test/rust_src/src/alloc-tests.el
@@ -11,5 +11,13 @@
 (ert-deftest bool-vector ()
   (should (bool-vector)))
 
+(ert-deftest make-record ()
+  (should (recordp (make-record 'foo 1 'A)))
+  (should (equal (make-record 'foo 3 'Z) #s(foo Z Z Z))))
+
+(ert-deftest record ()
+  (should (recordp (record 'foo)))
+  (should (equal (record 'foo 23 [bar baz] "rats") #s(foo 23 [bar baz] "rats"))))
+
 (provide 'alloc-tests)
 ;;; alloc-tests.el ends here
-- 
2.21.0


From 3316277f48bf26c2cee1f0dc3c797a57081d3819 Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Mon, 21 Jan 2019 17:25:41 -0800
Subject: [PATCH 229/297] Final transformation from C internal_equal. (#1190)

This PR moves to having the core types implement LispStructuralEqual.
---
 rust_src/src/buffers.rs              |  30 +++---
 rust_src/src/chartable.rs            | 139 ++++++++++++++++-----------
 rust_src/src/floatfns.rs             |  37 ++++++-
 rust_src/src/fns.rs                  |  63 ++----------
 rust_src/src/hashtable.rs            |   4 +
 rust_src/src/lisp.rs                 | 136 +++++++++++++++++++++++---
 rust_src/src/lists.rs                |  84 +++++++++-------
 rust_src/src/marker.rs               |  13 ++-
 rust_src/src/multibyte.rs            |  13 ++-
 rust_src/src/numbers.rs              |  18 +++-
 rust_src/src/objects.rs              |   6 +-
 rust_src/src/symbols.rs              |  17 +++-
 rust_src/src/vectors.rs              | 116 ++++++++++++----------
 src/fns.c                            |  90 -----------------
 src/lisp.h                           |   5 -
 test/lisp/net/tramp-archive-tests.el |  18 ++--
 test/rust_src/src/fns-tests.el       |  36 +++++++
 17 files changed, 476 insertions(+), 349 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 676b2f3a74..486252dd93 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -17,8 +17,9 @@ use crate::{
     eval::unbind_to,
     fileio::{expand_file_name, find_file_name_handler},
     frames::LispFrameRef,
+    hashtable::LispHashTableRef,
     lisp::defsubr,
-    lisp::{ExternalPtr, LispMiscRef, LispObject, LiveBufferIter},
+    lisp::{ExternalPtr, LispMiscRef, LispObject, LispStructuralEqual, LiveBufferIter},
     lists::{car, cdr, list, member},
     lists::{LispConsCircularChecks, LispConsEndChecks},
     marker::{build_marker, marker_buffer, marker_position_lisp, set_marker_both, LispMarkerRef},
@@ -27,17 +28,16 @@ use crate::{
     numbers::MOST_POSITIVE_FIXNUM,
     remacs_sys::{
         allocate_misc, bset_update_mode_line, buffer_local_flags, buffer_local_value,
-        buffer_window_count, concat2, del_range, delete_all_overlays, globals, internal_equal,
-        last_per_buffer_idx, lookup_char_property, make_timespec, marker_position, modify_overlay,
+        buffer_window_count, concat2, del_range, delete_all_overlays, globals, last_per_buffer_idx,
+        lookup_char_property, make_timespec, marker_position, modify_overlay,
         set_buffer_internal_1, specbind, unchain_both, unchain_marker, update_mode_lines,
+        windows_or_buffers_changed,
     },
     remacs_sys::{
         buffer_defaults, equal_kind, pvec_type, EmacsInt, Lisp_Buffer, Lisp_Buffer_Local_Value,
         Lisp_Misc_Type, Lisp_Overlay, Lisp_Type, Vbuffer_alist,
     },
-    remacs_sys::{
-        windows_or_buffers_changed, Fcopy_sequence, Fget_text_property, Fnconc, Fnreverse,
-    },
+    remacs_sys::{Fcopy_sequence, Fget_text_property, Fnconc, Fnreverse},
     remacs_sys::{
         Qafter_string, Qbefore_string, Qbuffer_read_only, Qbufferp, Qget_file_buffer,
         Qinhibit_quit, Qinhibit_read_only, Qnil, Qoverlayp, Qt, Qunbound, UNKNOWN_MODTIME_NSECS,
@@ -504,19 +504,19 @@ impl LispOverlayRef {
             current: Some(self),
         }
     }
+}
 
-    pub fn equal(
-        self,
-        other: LispOverlayRef,
+impl LispStructuralEqual for LispOverlayRef {
+    fn equal(
+        &self,
+        other: Self,
         kind: equal_kind::Type,
         depth: i32,
-        ht: LispObject,
+        ht: &mut LispHashTableRef,
     ) -> bool {
-        unsafe {
-            let overlays_equal = internal_equal(self.start, other.start, kind, depth + 1, ht)
-                && internal_equal(self.end, other.end, kind, depth + 1, ht);
-            overlays_equal && internal_equal(self.plist, other.plist, kind, depth + 1, ht)
-        }
+        let overlays_equal = self.start.equal_internal(other.start, kind, depth + 1, ht)
+            && self.end.equal_internal(other.end, kind, depth + 1, ht);
+        overlays_equal && self.plist.equal_internal(other.plist, kind, depth + 1, ht)
     }
 }
 
diff --git a/rust_src/src/chartable.rs b/rust_src/src/chartable.rs
index ac708ebdd0..85df4a9914 100644
--- a/rust_src/src/chartable.rs
+++ b/rust_src/src/chartable.rs
@@ -5,13 +5,14 @@ use libc;
 use remacs_macros::lisp_fn;
 
 use crate::{
+    hashtable::LispHashTableRef,
     lisp::defsubr,
-    lisp::{ExternalPtr, LispObject},
+    lisp::{ExternalPtr, LispObject, LispStructuralEqual},
+    remacs_sys::uniprop_table_uncompress,
     remacs_sys::{
         char_table_specials, equal_kind, pvec_type, Lisp_Char_Table, Lisp_Sub_Char_Table,
         Lisp_Type, More_Lisp_Bits, CHARTAB_SIZE_BITS,
     },
-    remacs_sys::{internal_equal, uniprop_table_uncompress},
     remacs_sys::{Qchar_code_property_table, Qchar_table_p},
 };
 
@@ -145,8 +146,16 @@ impl LispCharTableRef {
 
         val
     }
+}
 
-    pub fn equal(self, other: Self, kind: equal_kind::Type, depth: i32, ht: LispObject) -> bool {
+impl LispStructuralEqual for LispCharTableRef {
+    fn equal(
+        &self,
+        other: Self,
+        kind: equal_kind::Type,
+        depth: i32,
+        ht: &mut LispHashTableRef,
+    ) -> bool {
         let mut size1 = (unsafe { self.header.size }
             & More_Lisp_Bits::PSEUDOVECTOR_SIZE_MASK as isize) as usize;
         let size2 = (unsafe { other.header.size } & More_Lisp_Bits::PSEUDOVECTOR_SIZE_MASK as isize)
@@ -166,41 +175,48 @@ impl LispCharTableRef {
         // char table is 4 LispObjects + an array
         size1 -= 4;
 
-        unsafe {
-            if !internal_equal(self.defalt, other.defalt, kind, depth + 1, ht) {
-                return false;
-            }
-            if !internal_equal(self.parent, other.parent, kind, depth + 1, ht) {
-                return false;
-            }
-            if !internal_equal(self.purpose, other.purpose, kind, depth + 1, ht) {
-                return false;
-            }
-            if !internal_equal(self.ascii, other.ascii, kind, depth + 1, ht) {
-                return false;
-            }
+        if !self
+            .defalt
+            .equal_internal(other.defalt, kind, depth + 1, ht)
+        {
+            return false;
+        }
+        if !self
+            .parent
+            .equal_internal(other.parent, kind, depth + 1, ht)
+        {
+            return false;
         }
-        for i in 0..size1 {
+        if !self
+            .purpose
+            .equal_internal(other.purpose, kind, depth + 1, ht)
+        {
+            return false;
+        }
+        if !self.ascii.equal_internal(other.ascii, kind, depth + 1, ht) {
+            return false;
+        }
+
+        let all_equal = (0..size1).all(|i| {
             let v1 = self.contents[i];
             let v2 = other.contents[i];
-            if !unsafe { internal_equal(v1, v2, kind, depth + 1, ht) } {
-                return false;
-            }
+            v1.equal_internal(v2, kind, depth + 1, ht)
+        });
+        if !all_equal {
+            return false;
         }
-        if extras > 0 {
+        if extras == 0 {
+            true
+        } else {
             let self_extras = unsafe { self.extras.as_slice(extras) };
             let other_extras = unsafe { other.extras.as_slice(extras) };
 
-            for i in 0..extras {
+            (0..extras).all(|i| {
                 let v1 = self_extras[i];
                 let v2 = other_extras[i];
-                if !unsafe { internal_equal(v1, v2, kind, depth + 1, ht) } {
-                    return false;
-                }
-            }
+                v1.equal_internal(v2, kind, depth + 1, ht)
+            })
         }
-
-        true
     }
 }
 
@@ -214,8 +230,16 @@ impl LispSubCharTableAsciiRef {
         let m = self.0.min_char;
         self._get(chartab_idx(c, d, m))
     }
+}
 
-    pub fn equal(self, other: Self, kind: equal_kind::Type, depth: i32, ht: LispObject) -> bool {
+impl LispStructuralEqual for LispSubCharTableAsciiRef {
+    fn equal(
+        &self,
+        other: Self,
+        kind: equal_kind::Type,
+        depth: i32,
+        ht: &mut LispHashTableRef,
+    ) -> bool {
         self.0.equal(other.0, kind, depth, ht)
     }
 }
@@ -255,36 +279,39 @@ impl LispSubCharTableRef {
 
         val
     }
+}
 
-    pub fn equal(self, other: Self, kind: equal_kind::Type, depth: i32, ht: LispObject) -> bool {
-        unsafe {
-            let mut size1 =
-                self.header.size as usize & More_Lisp_Bits::PSEUDOVECTOR_SIZE_MASK as usize;
-            let size2 =
-                other.header.size as usize & More_Lisp_Bits::PSEUDOVECTOR_SIZE_MASK as usize;
-            if size1 != size2 {
-                return false;
-            }
-
-            size1 -= 2; // account for depth and min_char
-            if self.depth != other.depth {
-                return false;
-            }
-            if self.min_char != other.min_char {
-                return false;
-            }
+impl LispStructuralEqual for LispSubCharTableRef {
+    fn equal(
+        &self,
+        other: Self,
+        kind: equal_kind::Type,
+        depth: i32,
+        ht: &mut LispHashTableRef,
+    ) -> bool {
+        let mut size1 =
+            unsafe { self.header.size as usize & More_Lisp_Bits::PSEUDOVECTOR_SIZE_MASK as usize };
+        let size2 =
+            unsafe { other.header.size as usize & More_Lisp_Bits::PSEUDOVECTOR_SIZE_MASK as usize };
+        if size1 != size2 {
+            return false;
+        }
 
-            let slice1 = self.contents.as_slice(size1);
-            let slice2 = other.contents.as_slice(size1);
-            for i in 0..size1 {
-                let v1 = slice1[i];
-                let v2 = slice2[i];
-                if !internal_equal(v1, v2, kind, depth + 1, ht) {
-                    return false;
-                }
-            }
+        size1 -= 2; // account for depth and min_char
+        if self.depth != other.depth {
+            return false;
+        }
+        if self.min_char != other.min_char {
+            return false;
         }
-        true
+
+        let slice1 = unsafe { self.contents.as_slice(size1) };
+        let slice2 = unsafe { other.contents.as_slice(size1) };
+        (0..size1).all(|i| {
+            let v1 = slice1[i];
+            let v2 = slice2[i];
+            v1.equal_internal(v2, kind, depth + 1, ht)
+        })
     }
 }
 
diff --git a/rust_src/src/floatfns.rs b/rust_src/src/floatfns.rs
index 293539e4f4..bce8172f5c 100644
--- a/rust_src/src/floatfns.rs
+++ b/rust_src/src/floatfns.rs
@@ -8,12 +8,13 @@ use std::mem;
 use remacs_macros::lisp_fn;
 
 use crate::{
+    hashtable::LispHashTableRef,
     libm,
     lisp::defsubr,
-    lisp::{ExternalPtr, LispObject},
+    lisp::{ExternalPtr, LispObject, LispStructuralEqual},
     math::ArithOp,
     numbers::{LispNumber, MOST_NEGATIVE_FIXNUM, MOST_POSITIVE_FIXNUM},
-    remacs_sys::{EmacsDouble, EmacsInt, EmacsUint, Lisp_Float, Lisp_Type},
+    remacs_sys::{equal_kind, EmacsDouble, EmacsInt, EmacsUint, Lisp_Float, Lisp_Type},
     remacs_sys::{Qfloatp, Qinteger_or_marker_p, Qnumberp, Qrange_error},
 };
 
@@ -25,6 +26,26 @@ impl LispFloatRef {
     pub fn as_data(&self) -> &EmacsDouble {
         unsafe { &*(&self.u.data as *const EmacsDouble) }
     }
+
+    fn to_float(self) -> EmacsDouble {
+        *self.as_data()
+    }
+}
+
+impl LispStructuralEqual for LispFloatRef {
+    fn equal(
+        &self,
+        other: Self,
+        _kind: equal_kind::Type,
+        _depth: i32,
+        _ht: &mut LispHashTableRef,
+    ) -> bool {
+        let d1 = self.to_float();
+        let d2 = other.to_float();
+
+        // Two NaNs should be `equal' even though they are not =.
+        d1 == d2 || (d1.is_nan() && d2.is_nan())
+    }
 }
 
 impl LispObject {
@@ -45,6 +66,18 @@ impl LispObject {
         unsafe { self.get_float_data_unchecked() }
     }
 
+    pub fn as_floatref(self) -> Option<LispFloatRef> {
+        if self.is_float() {
+            Some(unsafe { self.to_float_unchecked() })
+        } else {
+            None
+        }
+    }
+
+    pub fn force_floatref(self) -> LispFloatRef {
+        unsafe { self.to_float_unchecked() }
+    }
+
     pub fn as_float(self) -> Option<EmacsDouble> {
         if self.is_float() {
             Some(unsafe { self.get_float_data_unchecked() })
diff --git a/rust_src/src/fns.rs b/rust_src/src/fns.rs
index 4c53fc8896..1f4cd17a21 100644
--- a/rust_src/src/fns.rs
+++ b/rust_src/src/fns.rs
@@ -1,4 +1,4 @@
-//* Random utility Lisp functions.
+//! Random utility Lisp functions.
 
 use std::ptr;
 
@@ -12,14 +12,13 @@ use crate::{
     lisp::LispObject,
     lists::{assq, car, get, mapcar1, member, memq, put},
     lists::{LispCons, LispConsCircularChecks, LispConsEndChecks},
-    multibyte::LispStringRef,
     numbers::LispNumber,
     obarray::loadhist_attach,
     objects::equal,
     remacs_sys::Fload,
     remacs_sys::Vautoload_queue,
     remacs_sys::{concat as lisp_concat, globals},
-    remacs_sys::{equal_kind, EmacsInt, Lisp_Type},
+    remacs_sys::{EmacsInt, Lisp_Type},
     remacs_sys::{Qfuncall, Qlistp, Qnil, Qprovide, Qquote, Qrequire, Qsubfeatures, Qt},
     symbols::LispSymbolRef,
     threads::c_specpdl_index,
@@ -270,60 +269,12 @@ pub fn concat(args: &mut [LispObject]) -> LispObject {
     }
 }
 
+// Return true if O1 and O2 are equal.  Do not quit or check for cycles.
+// Use this only on arguments that are cycle-free and not too large and
+// are not window configurations.
 #[no_mangle]
-pub extern "C" fn internal_equal_cons(
-    o1: LispObject,
-    o2: LispObject,
-    kind: equal_kind::Type,
-    depth: i32,
-    ht: LispObject,
-) -> bool {
-    match (o1.as_cons(), o2.as_cons()) {
-        (Some(cons1), Some(cons2)) => cons1.equal(cons2, kind, depth, ht),
-        _ => false,
-    }
-}
-
-#[no_mangle]
-pub extern "C" fn internal_equal_string(
-    o1: LispObject,
-    o2: LispObject,
-    kind: equal_kind::Type,
-    depth: i32,
-    ht: LispObject,
-) -> bool {
-    let s1: LispStringRef = o1.into();
-    let s2: LispStringRef = o2.into();
-
-    s1.equal(s2, kind, depth, ht)
-}
-
-#[no_mangle]
-pub extern "C" fn internal_equal_misc(
-    o1: LispObject,
-    o2: LispObject,
-    kind: equal_kind::Type,
-    depth: i32,
-    ht: LispObject,
-) -> bool {
-    match (o1.as_misc(), o2.as_misc()) {
-        (Some(m1), Some(m2)) => m1.equal(m2, kind, depth, ht),
-        _ => false,
-    }
-}
-
-#[no_mangle]
-pub extern "C" fn internal_equal_vectorlike(
-    o1: LispObject,
-    o2: LispObject,
-    kind: equal_kind::Type,
-    depth: i32,
-    ht: LispObject,
-) -> bool {
-    match (o1.as_vectorlike(), o2.as_vectorlike()) {
-        (Some(v1), Some(v2)) => v1.equal(v2, kind, depth, ht),
-        _ => false,
-    }
+pub extern "C" fn equal_no_quit(o1: LispObject, o2: LispObject) -> bool {
+    o1.equal_no_quit(o2)
 }
 
 #[cfg(windows)]
diff --git a/rust_src/src/hashtable.rs b/rust_src/src/hashtable.rs
index 56fa7d9726..3dd86bb52a 100644
--- a/rust_src/src/hashtable.rs
+++ b/rust_src/src/hashtable.rs
@@ -30,6 +30,10 @@ pub enum HashLookupResult {
 use self::HashLookupResult::{Found, Missing};
 
 impl LispHashTableRef {
+    pub fn empty() -> Self {
+        Self::new(ptr::null_mut())
+    }
+
     pub fn allocate() -> LispHashTableRef {
         let vec_ptr = allocate_pseudovector!(Lisp_Hash_Table, count, pvec_type::PVEC_HASH_TABLE);
         LispHashTableRef::new(vec_ptr)
diff --git a/rust_src/src/lisp.rs b/rust_src/src/lisp.rs
index 8d2dc4d3ec..558872ce9f 100644
--- a/rust_src/src/lisp.rs
+++ b/rust_src/src/lisp.rs
@@ -13,15 +13,20 @@ use libc::{c_char, c_void, intptr_t, uintptr_t};
 use crate::{
     buffers::LispBufferRef,
     eval::FUNCTIONP,
-    lists::{list, CarIter, LispConsCircularChecks, LispConsEndChecks},
+    hashtable::{
+        HashLookupResult::{Found, Missing},
+        LispHashTableRef,
+    },
+    lists::{list, memq, CarIter, LispConsCircularChecks, LispConsEndChecks},
     multibyte::LispStringRef,
     process::LispProcessRef,
-    remacs_sys::{build_string, internal_equal, make_float},
+    remacs_sys::{build_string, make_float, Fmake_hash_table},
     remacs_sys::{
         equal_kind, pvec_type, EmacsDouble, EmacsInt, EmacsUint, Lisp_Bits, USE_LSB_TAG, VALMASK,
     },
     remacs_sys::{Lisp_Misc_Any, Lisp_Misc_Type, Lisp_Subr, Lisp_Type},
-    remacs_sys::{Qautoload, Qnil, Qsubrp, Qt, Vbuffer_alist, Vprocess_alist},
+    remacs_sys::{QCtest, Qautoload, Qeq, Qnil, Qsubrp, Qt},
+    remacs_sys::{Vbuffer_alist, Vprocess_alist},
 };
 
 // TODO: tweak Makefile to rebuild C files if this changes.
@@ -115,6 +120,10 @@ impl<T> ExternalPtr<T> {
     pub fn from_ptr(ptr: *mut c_void) -> Option<Self> {
         unsafe { ptr.as_ref().map(|p| mem::transmute(p)) }
     }
+
+    pub fn replace_ptr(&mut self, ptr: *mut T) {
+        self.0 = ptr;
+    }
 }
 
 impl<T> Deref for ExternalPtr<T> {
@@ -150,13 +159,15 @@ impl LispMiscRef {
     pub fn get_type(self) -> Lisp_Misc_Type {
         self.type_()
     }
+}
 
-    pub fn equal(
-        self,
-        other: LispMiscRef,
+impl LispStructuralEqual for LispMiscRef {
+    fn equal(
+        &self,
+        other: Self,
         kind: equal_kind::Type,
         depth: i32,
-        ht: LispObject,
+        ht: &mut LispHashTableRef,
     ) -> bool {
         if self.get_type() != other.get_type() {
             false
@@ -522,6 +533,16 @@ pub fn is_autoload(function: LispObject) -> bool {
     }
 }
 
+pub trait LispStructuralEqual {
+    fn equal(
+        &self,
+        other: Self,
+        equal_kind: equal_kind::Type,
+        depth: i32,
+        ht: &mut LispHashTableRef,
+    ) -> bool;
+}
+
 impl LispObject {
     pub fn is_nil(self) -> bool {
         self == Qnil
@@ -539,14 +560,14 @@ impl LispObject {
 
     pub fn eq<T>(self, other: T) -> bool
     where
-        LispObject: From<T>,
+        T: Into<LispObject>,
     {
         self == other.into()
     }
 
     pub fn eql<T>(self, other: T) -> bool
     where
-        LispObject: From<T>,
+        T: Into<LispObject>,
     {
         if self.is_float() {
             self.equal_no_quit(other)
@@ -557,16 +578,105 @@ impl LispObject {
 
     pub fn equal<T>(self, other: T) -> bool
     where
-        LispObject: From<T>,
+        T: Into<LispObject>,
     {
-        unsafe { internal_equal(self, other.into(), equal_kind::EQUAL_PLAIN, 0, Qnil) }
+        let mut ht = LispHashTableRef::empty();
+        self.equal_internal(other.into(), equal_kind::EQUAL_PLAIN, 0, &mut ht)
+    }
+
+    // Return true if O1 and O2 are equal.  EQUAL_KIND specifies what kind
+    // of equality test to use: if it is EQUAL_NO_QUIT, do not check for
+    // cycles or large arguments or quits; if EQUAL_PLAIN, do ordinary
+    // Lisp equality; and if EQUAL_INCLUDING_PROPERTIES, do
+    // equal-including-properties.
+    //
+    // If DEPTH is the current depth of recursion; signal an error if it
+    // gets too deep.  HT is a hash table used to detect cycles; if nil,
+    // it has not been allocated yet.  But ignore the last two arguments
+    // if EQUAL_KIND == EQUAL_NO_QUIT.
+    //
+    pub fn equal_internal(
+        self,
+        other: Self,
+        equal_kind: equal_kind::Type,
+        depth: i32,
+        ht: &mut LispHashTableRef,
+    ) -> bool {
+        if depth > 10 {
+            assert!(equal_kind != equal_kind::EQUAL_NO_QUIT);
+            if depth > 200 {
+                error!("Stack overflow in equal");
+            }
+            if ht.is_null() {
+                let mut new_ht: LispHashTableRef = callN_raw!(Fmake_hash_table, QCtest, Qeq).into();
+                ht.replace_ptr(new_ht.as_mut());
+            }
+            match self.get_type() {
+                Lisp_Type::Lisp_Cons | Lisp_Type::Lisp_Misc | Lisp_Type::Lisp_Vectorlike => {
+                    match ht.lookup(self) {
+                        Found(idx) => {
+                            // `self' was seen already.
+                            let o2s = ht.get_hash_value(idx);
+                            if memq(other, o2s).is_nil() {
+                                ht.set_hash_value(idx, LispObject::cons(other, o2s));
+                            } else {
+                                return true;
+                            }
+                        }
+                        Missing(hash) => {
+                            ht.put(self, LispObject::cons(other, Qnil), hash);
+                        }
+                    }
+                }
+                _ => {}
+            }
+        }
+
+        if self.eq(other) {
+            return true;
+        }
+        if self.get_type() != other.get_type() {
+            return false;
+        }
+
+        match self.get_type() {
+            Lisp_Type::Lisp_Int0 | Lisp_Type::Lisp_Int1 => {
+                self.force_fixnum()
+                    .equal(other.force_fixnum(), equal_kind, depth, ht)
+            }
+            Lisp_Type::Lisp_Symbol => {
+                self.force_symbol()
+                    .equal(other.force_symbol(), equal_kind, depth, ht)
+            }
+            Lisp_Type::Lisp_Cons => {
+                self.force_cons()
+                    .equal(other.force_cons(), equal_kind, depth, ht)
+            }
+            Lisp_Type::Lisp_Float => {
+                self.force_floatref()
+                    .equal(other.force_floatref(), equal_kind, depth, ht)
+            }
+            Lisp_Type::Lisp_Misc => {
+                self.force_misc()
+                    .equal(other.force_misc(), equal_kind, depth, ht)
+            }
+            Lisp_Type::Lisp_String => {
+                self.force_string()
+                    .equal(other.force_string(), equal_kind, depth, ht)
+            }
+            Lisp_Type::Lisp_Vectorlike => {
+                self.force_vectorlike()
+                    .equal(other.force_vectorlike(), equal_kind, depth, ht)
+            }
+        }
     }
 
     pub fn equal_no_quit<T>(self, other: T) -> bool
     where
-        LispObject: From<T>,
+        T: Into<LispObject>,
     {
-        unsafe { internal_equal(self, other.into(), equal_kind::EQUAL_NO_QUIT, 0, Qnil) }
+        let mut ht = LispHashTableRef::empty();
+        self.equal_internal(other.into(), equal_kind::EQUAL_NO_QUIT, 0, &mut ht)
     }
 
     pub fn is_function(self) -> bool {
diff --git a/rust_src/src/lists.rs b/rust_src/src/lists.rs
index 9e066cc422..6ec2b1753c 100644
--- a/rust_src/src/lists.rs
+++ b/rust_src/src/lists.rs
@@ -8,11 +8,12 @@ use libc::c_void;
 use remacs_macros::lisp_fn;
 
 use crate::{
+    hashtable::LispHashTableRef,
     lisp::defsubr,
-    lisp::LispObject,
+    lisp::{LispObject, LispStructuralEqual},
     numbers::MOST_POSITIVE_FIXNUM,
     remacs_sys::{equal_kind, globals, EmacsInt, EmacsUint, Lisp_Cons, Lisp_Type},
-    remacs_sys::{internal_equal, Fcons, CHECK_IMPURE},
+    remacs_sys::{Fcons, CHECK_IMPURE},
     remacs_sys::{Qcircular_list, Qconsp, Qlistp, Qnil, Qplistp},
     symbols::LispSymbolRef,
 };
@@ -344,40 +345,6 @@ impl LispCons {
         }
     }
 
-    pub fn equal(
-        self,
-        other: LispCons,
-        kind: equal_kind::Type,
-        depth: i32,
-        ht: LispObject,
-    ) -> bool {
-        let (circular_checks, item_depth, item_ht) = if kind == equal_kind::EQUAL_NO_QUIT {
-            (LispConsCircularChecks::off, 0, Qnil)
-        } else {
-            (LispConsCircularChecks::on, depth + 1, ht)
-        };
-
-        let mut it1 = self.iter_tails(LispConsEndChecks::off, circular_checks);
-        let mut it2 = other.iter_tails(LispConsEndChecks::off, circular_checks);
-        loop {
-            match (it1.next(), it2.next()) {
-                (Some(cons1), Some(cons2)) => {
-                    let (item1, tail1) = cons1.into();
-                    let (item2, tail2) = cons2.into();
-                    if !unsafe { internal_equal(item1, item2, kind, item_depth, item_ht) } {
-                        return false;
-                    } else if tail1.eq(tail2) {
-                        return true;
-                    }
-                }
-                (None, None) => break,
-                _ => return false,
-            }
-        }
-
-        unsafe { internal_equal(it1.rest(), it2.rest(), kind, depth + 1, ht) }
-    }
-
     pub fn length(self) -> usize {
         let len = self
             .0
@@ -406,6 +373,51 @@ impl LispCons {
     }
 }
 
+impl LispStructuralEqual for LispCons {
+    fn equal(
+        &self,
+        other: Self,
+        kind: equal_kind::Type,
+        depth: i32,
+        ht: &mut LispHashTableRef,
+    ) -> bool {
+        let (circular_checks, item_depth) = if kind == equal_kind::EQUAL_NO_QUIT {
+            (LispConsCircularChecks::off, 0)
+        } else {
+            (LispConsCircularChecks::on, depth + 1)
+        };
+
+        // This is essentially a zip. However, one cons can end earlier than the other.
+        // Which requires that the iterators are available to call `rest()` on.
+        // Had `.zip()` been used this would not be possible as it consumes them.
+        let mut it1 = self.iter_tails(LispConsEndChecks::off, circular_checks);
+        let mut it2 = other.iter_tails(LispConsEndChecks::off, circular_checks);
+        loop {
+            match (it1.next(), it2.next()) {
+                (Some(cons1), Some(cons2)) => {
+                    let (item1, tail1) = cons1.into();
+                    let (item2, tail2) = cons2.into();
+                    if item1.equal_internal(item2, kind, item_depth, ht) {
+                        if tail1.eq(tail2) {
+                            return true;
+                        }
+                    } else {
+                        return false;
+                    }
+                }
+                (None, None) => break,
+                _ => return false,
+            }
+        }
+
+        // The two iterators contain what is left of the lists after the loop exits.
+        // If the loop completely consumes the lists this will end being nil `equal` nil.
+        // Either iterator could also still have data if the list is "improper" (a . b)
+        // style. Or as the comment above says, the two lists might be a different length.
+        it1.rest().equal_internal(it2.rest(), kind, depth + 1, ht)
+    }
+}
+
 /// Return t if OBJECT is not a cons cell.  This includes nil.
 #[lisp_fn]
 pub fn atom(object: LispObject) -> bool {
diff --git a/rust_src/src/marker.rs b/rust_src/src/marker.rs
index b0605ef710..dbdb118941 100644
--- a/rust_src/src/marker.rs
+++ b/rust_src/src/marker.rs
@@ -8,7 +8,8 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     buffers::{current_buffer, LispBufferRef},
-    lisp::{defsubr, ExternalPtr, LispMiscRef, LispObject},
+    hashtable::LispHashTableRef,
+    lisp::{defsubr, ExternalPtr, LispMiscRef, LispObject, LispStructuralEqual},
     multibyte::multibyte_chars_in_text,
     remacs_sys::{allocate_misc, set_point_both, Fmake_marker},
     remacs_sys::{equal_kind, EmacsInt, Lisp_Buffer, Lisp_Marker, Lisp_Misc_Type, Lisp_Type},
@@ -83,13 +84,15 @@ impl LispMarkerRef {
     pub fn set_next(mut self, m: *mut Lisp_Marker) {
         self.next = m;
     }
+}
 
-    pub fn equal(
-        self,
-        other: LispMarkerRef,
+impl LispStructuralEqual for LispMarkerRef {
+    fn equal(
+        &self,
+        other: Self,
         _kind: equal_kind::Type,
         _depth: i32,
-        _ht: LispObject,
+        _ht: &mut LispHashTableRef,
     ) -> bool {
         if self.buffer != other.buffer {
             false
diff --git a/rust_src/src/multibyte.rs b/rust_src/src/multibyte.rs
index ac6d51a2f8..791ceec017 100644
--- a/rust_src/src/multibyte.rs
+++ b/rust_src/src/multibyte.rs
@@ -39,7 +39,8 @@ use std::slice;
 use libc::{c_char, c_int, c_uchar, c_uint, c_void, memset, ptrdiff_t, size_t};
 
 use crate::{
-    lisp::{ExternalPtr, LispObject},
+    hashtable::LispHashTableRef,
+    lisp::{ExternalPtr, LispObject, LispStructuralEqual},
     remacs_sys::Qstringp,
     remacs_sys::{char_bits, equal_kind, EmacsDouble, EmacsInt, Lisp_String, Lisp_Type},
     remacs_sys::{compare_string_intervals, empty_unibyte_string, lisp_string_width},
@@ -175,19 +176,21 @@ impl LispStringRef {
     pub fn set_byte(&mut self, idx: ptrdiff_t, elt: c_uchar) {
         unsafe { ptr::write(self.data_ptr().offset(idx), elt) };
     }
+}
 
-    pub fn equal(
-        self,
+impl LispStructuralEqual for LispStringRef {
+    fn equal(
+        &self,
         other: LispStringRef,
         kind: equal_kind::Type,
         _depth: i32,
-        _ht: LispObject,
+        _ht: &mut LispHashTableRef,
     ) -> bool {
         self.len_chars() == other.len_chars()
             && self.len_bytes() == other.len_bytes()
             && self.as_slice() == other.as_slice()
             && (kind != equal_kind::EQUAL_INCLUDING_PROPERTIES
-                || unsafe { compare_string_intervals(self.into(), other.into()) })
+                || unsafe { compare_string_intervals((*self).into(), other.into()) })
     }
 }
 
diff --git a/rust_src/src/numbers.rs b/rust_src/src/numbers.rs
index af01f17d89..ec08f33196 100644
--- a/rust_src/src/numbers.rs
+++ b/rust_src/src/numbers.rs
@@ -6,10 +6,12 @@ use std::sync::Mutex;
 use remacs_macros::lisp_fn;
 
 use crate::{
+    hashtable::LispHashTableRef,
     lisp::defsubr,
-    lisp::LispObject,
+    lisp::{LispObject, LispStructuralEqual},
     remacs_sys::{
-        EmacsDouble, EmacsInt, EmacsUint, Lisp_Bits, Lisp_Type, EMACS_INT_MAX, INTMASK, USE_LSB_TAG,
+        equal_kind, EmacsDouble, EmacsInt, EmacsUint, Lisp_Bits, Lisp_Type, EMACS_INT_MAX, INTMASK,
+        USE_LSB_TAG,
     },
     remacs_sys::{Qinteger_or_marker_p, Qintegerp, Qnumber_or_marker_p, Qwholenump},
 };
@@ -166,6 +168,18 @@ impl LispNumber {
     }
 }
 
+impl LispStructuralEqual for EmacsInt {
+    fn equal(
+        &self,
+        other: Self,
+        _equal_kind: equal_kind::Type,
+        _depth: i32,
+        _ht: &mut LispHashTableRef,
+    ) -> bool {
+        *self == other
+    }
+}
+
 impl From<EmacsInt> for LispNumber {
     fn from(n: EmacsInt) -> Self {
         LispNumber::Fixnum(n)
diff --git a/rust_src/src/objects.rs b/rust_src/src/objects.rs
index 2897afc166..bf22194da8 100644
--- a/rust_src/src/objects.rs
+++ b/rust_src/src/objects.rs
@@ -3,8 +3,9 @@
 use remacs_macros::lisp_fn;
 
 use crate::{
+    hashtable::LispHashTableRef,
     lisp::{defsubr, LispObject},
-    remacs_sys::{equal_kind, internal_equal, Qnil},
+    remacs_sys::equal_kind,
 };
 
 /// Return t if OBJECT is nil, and return nil otherwise.
@@ -43,7 +44,8 @@ pub fn equal(o1: LispObject, o2: LispObject) -> bool {
 /// of strings.  (`equal' ignores text properties.)
 #[lisp_fn]
 pub fn equal_including_properties(o1: LispObject, o2: LispObject) -> bool {
-    unsafe { internal_equal(o1, o2, equal_kind::EQUAL_INCLUDING_PROPERTIES, 0, Qnil) }
+    let mut ht = LispHashTableRef::empty();
+    o1.equal_internal(o2, equal_kind::EQUAL_INCLUDING_PROPERTIES, 0, &mut ht)
 }
 
 /// Return the argument unchanged.
diff --git a/rust_src/src/symbols.rs b/rust_src/src/symbols.rs
index 805b6cbc2f..718fb46aae 100644
--- a/rust_src/src/symbols.rs
+++ b/rust_src/src/symbols.rs
@@ -9,15 +9,16 @@ use crate::{
     buffers::LispBufferLocalValueRef,
     data::Lisp_Fwd,
     data::{indirect_function, set},
+    hashtable::LispHashTableRef,
     lisp::defsubr,
-    lisp::{ExternalPtr, LispObject},
+    lisp::{ExternalPtr, LispObject, LispStructuralEqual},
     multibyte::LispStringRef,
+    remacs_sys::{equal_kind, lispsym, EmacsInt, Lisp_Symbol, Lisp_Type, USE_LSB_TAG},
     remacs_sys::{
         find_symbol_value, get_symbol_declared_special, get_symbol_redirect, make_lisp_symbol,
         set_symbol_declared_special, set_symbol_redirect, swap_in_symval_forwarding,
         symbol_interned, symbol_redirect, symbol_trapped_write,
     },
-    remacs_sys::{lispsym, EmacsInt, Lisp_Symbol, Lisp_Type, USE_LSB_TAG},
     remacs_sys::{Qcyclic_variable_indirection, Qnil, Qsymbolp, Qunbound},
 };
 
@@ -154,6 +155,18 @@ impl LispSymbolRef {
     }
 }
 
+impl LispStructuralEqual for LispSymbolRef {
+    fn equal(
+        &self,
+        other: Self,
+        _equal_kind: equal_kind::Type,
+        _depth: i32,
+        _ht: &mut LispHashTableRef,
+    ) -> bool {
+        LispObject::from(*self).eq(LispObject::from(other))
+    }
+}
+
 impl From<LispObject> for LispSymbolRef {
     fn from(o: LispObject) -> Self {
         if let Some(sym) = o.as_symbol() {
diff --git a/rust_src/src/vectors.rs b/rust_src/src/vectors.rs
index 5d72f50eb9..036d06e71f 100644
--- a/rust_src/src/vectors.rs
+++ b/rust_src/src/vectors.rs
@@ -15,12 +15,12 @@ use crate::{
     chartable::{LispCharTableRef, LispSubCharTableAsciiRef, LispSubCharTableRef},
     data::aref,
     frames::LispFrameRef,
+    hashtable::LispHashTableRef,
     lisp::defsubr,
-    lisp::{ExternalPtr, LispObject, LispSubrRef},
+    lisp::{ExternalPtr, LispObject, LispStructuralEqual, LispSubrRef},
     lists::{inorder, nth, sort_list},
     multibyte::MAX_CHAR,
     process::LispProcessRef,
-    remacs_sys::internal_equal,
     remacs_sys::{
         equal_kind, pvec_type, EmacsInt, Lisp_Bool_Vector, Lisp_Char_Table, Lisp_Type, Lisp_Vector,
         Lisp_Vectorlike, Lisp_Vectorlike_With_Slots, More_Lisp_Bits, BITS_PER_BITS_WORD,
@@ -127,44 +127,6 @@ impl Debug for LispVectorlikeRef {
 }
 
 impl LispVectorlikeRef {
-    pub fn equal(self, other: Self, kind: equal_kind::Type, depth: i32, ht: LispObject) -> bool {
-        // Pseudovectors have the type encoded in the size field, so this test
-        // actually checks that the objects have the same type as well as the
-        // same size.
-        if unsafe { self.header.size != other.header.size } {
-            false
-        } else if let (Some(bv1), Some(bv2)) = (self.as_bool_vector(), other.as_bool_vector()) {
-            bv1.equal(bv2, kind, depth, ht)
-        } else if let (Some(cf1), Some(cf2)) = (
-            self.as_window_configuration(),
-            other.as_window_configuration(),
-        ) {
-            assert!(kind != equal_kind::EQUAL_NO_QUIT);
-            cf1.equal(cf2, false)
-        } else if let (Some(vec1), Some(vec2)) = (self.as_vector(), other.as_vector()) {
-            vec1.equal(vec2, kind, depth, ht)
-        } else if let (Some(fn1), Some(fn2)) = (self.as_compiled(), other.as_compiled()) {
-            fn1.equal(fn2, kind, depth, ht)
-        } else if let (Some(rec1), Some(rec2)) = (self.as_record(), other.as_record()) {
-            rec1.equal(rec2, kind, depth, ht)
-        } else if let (Some(font1), Some(font2)) = (self.as_font(), other.as_font()) {
-            font1.equal(font2, kind, depth, ht)
-        } else if let (Some(ct1), Some(ct2)) = (self.as_char_table(), other.as_char_table()) {
-            ct1.equal(ct2, kind, depth, ht)
-        } else if let (Some(ct1), Some(ct2)) = (self.as_sub_char_table(), other.as_sub_char_table())
-        {
-            ct1.equal(ct2, kind, depth, ht)
-        } else if let (Some(ct1), Some(ct2)) = (
-            self.as_sub_char_table_ascii(),
-            other.as_sub_char_table_ascii(),
-        ) {
-            ct1.equal(ct2, kind, depth, ht)
-        } else {
-            // All of the other vector likes are not readily comparable.
-            false
-        }
-    }
-
     pub fn is_vector(self) -> bool {
         unsafe { self.header.size & (PSEUDOVECTOR_FLAG as isize) == 0 }
     }
@@ -317,6 +279,52 @@ impl LispVectorlikeRef {
     }
 }
 
+impl LispStructuralEqual for LispVectorlikeRef {
+    fn equal(
+        &self,
+        other: Self,
+        kind: equal_kind::Type,
+        depth: i32,
+        ht: &mut LispHashTableRef,
+    ) -> bool {
+        // Pseudovectors have the type encoded in the size field, so this test
+        // actually checks that the objects have the same type as well as the
+        // same size.
+        if unsafe { self.header.size != other.header.size } {
+            false
+        } else if let (Some(bv1), Some(bv2)) = (self.as_bool_vector(), other.as_bool_vector()) {
+            bv1.equal(bv2, kind, depth, ht)
+        } else if let (Some(cf1), Some(cf2)) = (
+            self.as_window_configuration(),
+            other.as_window_configuration(),
+        ) {
+            assert!(kind != equal_kind::EQUAL_NO_QUIT);
+            cf1.equal(cf2, false)
+        } else if let (Some(vec1), Some(vec2)) = (self.as_vector(), other.as_vector()) {
+            vec1.equal(vec2, kind, depth, ht)
+        } else if let (Some(fn1), Some(fn2)) = (self.as_compiled(), other.as_compiled()) {
+            fn1.equal(fn2, kind, depth, ht)
+        } else if let (Some(rec1), Some(rec2)) = (self.as_record(), other.as_record()) {
+            rec1.equal(rec2, kind, depth, ht)
+        } else if let (Some(font1), Some(font2)) = (self.as_font(), other.as_font()) {
+            font1.equal(font2, kind, depth, ht)
+        } else if let (Some(ct1), Some(ct2)) = (self.as_char_table(), other.as_char_table()) {
+            ct1.equal(ct2, kind, depth, ht)
+        } else if let (Some(ct1), Some(ct2)) = (self.as_sub_char_table(), other.as_sub_char_table())
+        {
+            ct1.equal(ct2, kind, depth, ht)
+        } else if let (Some(ct1), Some(ct2)) = (
+            self.as_sub_char_table_ascii(),
+            other.as_sub_char_table_ascii(),
+        ) {
+            ct1.equal(ct2, kind, depth, ht)
+        } else {
+            // All of the other vector likes are not readily comparable.
+            false
+        }
+    }
+}
+
 macro_rules! impl_vectorlike_ref {
     ($type:ident, $itertype:ident, $size_mask:expr) => {
         impl From<$type> for LispObject {
@@ -369,23 +377,21 @@ macro_rules! impl_vectorlike_ref {
             pub fn iter(&self) -> $itertype {
                 $itertype::new(self)
             }
+        }
 
-            pub fn equal(
-                self,
+        impl LispStructuralEqual for $type {
+            fn equal(
+                &self,
                 other: Self,
                 kind: equal_kind::Type,
                 depth: i32,
-                ht: LispObject,
+                ht: &mut LispHashTableRef,
             ) -> bool {
-                for i in 0..self.len() {
+                (0..self.len()).all(|i| {
                     let v1 = self.get(i as usize);
                     let v2 = other.get(i as usize);
-                    if !unsafe { internal_equal(v1, v2, kind, depth + 1, ht) } {
-                        return false;
-                    }
-                }
-
-                true
+                    v1.equal_internal(v2, kind, depth + 1, ht)
+                })
             }
         }
 
@@ -501,8 +507,16 @@ impl LispBoolVecRef {
             cur: 0,
         }
     }
+}
 
-    pub fn equal(self, other: Self, _kind: equal_kind::Type, _depth: i32, _ht: LispObject) -> bool {
+impl LispStructuralEqual for LispBoolVecRef {
+    fn equal(
+        &self,
+        other: Self,
+        _kind: equal_kind::Type,
+        _depth: i32,
+        _ht: &mut LispHashTableRef,
+    ) -> bool {
         let bits_per = BOOL_VECTOR_BITS_PER_CHAR as usize;
         // Bool vectors are compared much like strings.
         self.len() == other.len()
diff --git a/src/fns.c b/src/fns.c
index 5fc4057725..6af08e7e5b 100644
--- a/src/fns.c
+++ b/src/fns.c
@@ -1313,96 +1313,6 @@ See also the function `nreverse', which is used more often.  */)
     wrong_type_argument (Qsequencep, seq);
   return new;
 }
-
-/* Return true if O1 and O2 are equal.  Do not quit or check for cycles.
-   Use this only on arguments that are cycle-free and not too large and
-   are not window configurations.  */
-
-bool
-equal_no_quit (Lisp_Object o1, Lisp_Object o2)
-{
-  return internal_equal (o1, o2, EQUAL_NO_QUIT, 0, Qnil);
-}
-
-/* Return true if O1 and O2 are equal.  EQUAL_KIND specifies what kind
-   of equality test to use: if it is EQUAL_NO_QUIT, do not check for
-   cycles or large arguments or quits; if EQUAL_PLAIN, do ordinary
-   Lisp equality; and if EQUAL_INCLUDING_PROPERTIES, do
-   equal-including-properties.
-
-   If DEPTH is the current depth of recursion; signal an error if it
-   gets too deep.  HT is a hash table used to detect cycles; if nil,
-   it has not been allocated yet.  But ignore the last two arguments
-   if EQUAL_KIND == EQUAL_NO_QUIT.  */
-
-/* NOTE: made this non-static to call it from Rust. */
-bool
-internal_equal (Lisp_Object o1, Lisp_Object o2, enum equal_kind equal_kind,
-		int depth, Lisp_Object ht)
-{
-  if (depth > 10)
-    {
-      eassert (equal_kind != EQUAL_NO_QUIT);
-      if (depth > 200)
-	error ("Stack overflow in equal");
-      if (NILP (ht))
-	ht = CALLN (Fmake_hash_table, QCtest, Qeq);
-      switch (XTYPE (o1))
-	{
-	case Lisp_Cons: case Lisp_Misc: case Lisp_Vectorlike:
-	  {
-	    struct Lisp_Hash_Table *h = XHASH_TABLE (ht);
-	    EMACS_UINT hash;
-	    ptrdiff_t i = hash_lookup (h, o1, &hash);
-	    if (i >= 0)
-	      { /* `o1' was seen already.  */
-		Lisp_Object o2s = HASH_VALUE (h, i);
-		if (!NILP (Fmemq (o2, o2s)))
-		  return true;
-		else
-		  set_hash_value_slot (h, i, Fcons (o2, o2s));
-	      }
-	    else
-	      hash_put (h, o1, Fcons (o2, Qnil), hash);
-	  }
-	default: ;
-	}
-    }
-
-  if (EQ (o1, o2))
-    return true;
-  if (XTYPE (o1) != XTYPE (o2))
-    return false;
-
-  switch (XTYPE (o1))
-    {
-    case Lisp_Float:
-      {
-	double d1 = XFLOAT_DATA (o1);
-	double d2 = XFLOAT_DATA (o2);
-	/* If d is a NaN, then d != d. Two NaNs should be `equal' even
-	   though they are not =.  */
-	return d1 == d2 || (d1 != d1 && d2 != d2);
-      }
-
-    case Lisp_Cons:
-      return internal_equal_cons(o1, o2, equal_kind, depth, ht);
-
-    case Lisp_Misc:
-      return internal_equal_misc(o1, o2,  equal_kind, depth, ht);
-
-    case Lisp_Vectorlike:
-      return internal_equal_vectorlike(o1, o2, equal_kind, depth, ht);
-
-    case Lisp_String:
-      return internal_equal_string(o1, o2, equal_kind, depth, ht);
-
-    default:
-      break;
-    }
-
-  return false;
-}
 
 
 DEFUN ("fillarray", Ffillarray, Sfillarray, 2, 2, 0,
diff --git a/src/lisp.h b/src/lisp.h
index 931090aad4..66d769cc94 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -4912,11 +4912,6 @@ bool backtrace_debug_on_exit (union specbinding *pdl);
 void do_debug_on_call (Lisp_Object code, ptrdiff_t count);
 
 enum equal_kind { EQUAL_NO_QUIT, EQUAL_PLAIN, EQUAL_INCLUDING_PROPERTIES };
-extern bool internal_equal (Lisp_Object, Lisp_Object, enum equal_kind, int, Lisp_Object);
-extern bool internal_equal_cons (Lisp_Object, Lisp_Object, enum equal_kind, int, Lisp_Object);
-extern bool internal_equal_misc (Lisp_Object, Lisp_Object, enum equal_kind, int, Lisp_Object);
-extern bool internal_equal_string (Lisp_Object, Lisp_Object, enum equal_kind, int, Lisp_Object);
-extern bool internal_equal_vectorlike (Lisp_Object, Lisp_Object, enum equal_kind, int, Lisp_Object);
 
 INLINE_HEADER_END
 
diff --git a/test/lisp/net/tramp-archive-tests.el b/test/lisp/net/tramp-archive-tests.el
index a3201bdba4..2d0620110f 100644
--- a/test/lisp/net/tramp-archive-tests.el
+++ b/test/lisp/net/tramp-archive-tests.el
@@ -815,22 +815,22 @@ This tests also `file-executable-p', `file-writable-p' and `set-file-modes'."
 	 "(progn \
 	    (message \"tramp-archive loaded: %%s %%s\" \
               (featurep 'tramp) (featurep 'tramp-archive)) \
-	    (file-attributes %S \"/\") \
+            (file-attributes %S \"/\") \
 	    (message \"tramp-archive loaded: %%s %%s\" \
               (featurep 'tramp) (featurep 'tramp-archive)))"))
     (dolist (file `("/mock::foo" ,(concat tramp-archive-test-archive "foo")))
       (should
        (string-match
-	(format
+        (format
 	 "tramp-archive loaded: nil nil[[:ascii:]]+tramp-archive loaded: t %s"
 	 (tramp-archive-file-name-p file))
-	(shell-command-to-string
-	 (format
-	  "%s -batch -Q -L %s --eval %s"
-	  (shell-quote-argument
-	   (expand-file-name invocation-name invocation-directory))
-	  (mapconcat 'shell-quote-argument load-path " -L ")
-	  (shell-quote-argument (format code file)))))))))
+        (shell-command-to-string
+         (format
+	   "%s -batch -Q -L %s --eval %s"
+           (shell-quote-argument
+            (expand-file-name invocation-name invocation-directory))
+           (mapconcat 'shell-quote-argument load-path " -L ")
+           (shell-quote-argument (format code file)))))))))
 
 (ert-deftest tramp-archive-test42-delay-load ()
   "Check that `tramp-archive' is loaded lazily, only when needed."
diff --git a/test/rust_src/src/fns-tests.el b/test/rust_src/src/fns-tests.el
index fe05388bb7..f8e68533c9 100644
--- a/test/rust_src/src/fns-tests.el
+++ b/test/rust_src/src/fns-tests.el
@@ -4,6 +4,42 @@
 
 (require 'ert)
 
+(ert-deftest test-equal-string ()
+  (should (equal "Test 1.2.3." "Test 1.2.3."))
+  (should (equal "Rust" "Rust"))
+  (should-not (equal "Remacs" "Emacs")))
+
+(ert-deftest test-equal-float ()
+  (should (equal 2.0 2.0))
+  (should (equal 1.5 1.5)))
+
+(ert-deftest test-equal-cons ()
+  (should (equal '(1 . 3) '(1 . 3)))
+  (should (equal '(1 (1 (1 (1 (1 (1 (1 (1 (1 (1 (1 nil)))))))))))
+                 '(1 (1 (1 (1 (1 (1 (1 (1 (1 (1 (1 nil)))))))))))))
+  (should-not (equal '(1 (1 (1 (1 (1 (1 (1 (1 (1 (1 (1 nil)))))))))))
+                     '(1 (1 (1 (1 (1 (1 (1 (1 (1 (1 (2 nil))))))))))))))
+
+(ert-deftest test-equal-marker ()
+  (should (equal (make-marker) (make-marker)))
+  (should (equal (point-marker) (point-marker))))
+
+(ert-deftest test-equal-overlay ()
+  (should (equal (make-overlay (buffer-end 0) (buffer-end 1))
+                 (make-overlay (buffer-end 0) (buffer-end 1)))))
+
+(ert-deftest test-equal-bool-vector ()
+  (should (equal (bool-vector t nil t nil t nil)
+                 (bool-vector t nil t nil t nil))))
+
+(ert-deftest test-equal-char-table ()
+  (should (equal (make-char-table 'syntax-table '(3))
+                 (make-char-table 'syntax-table '(3)))))
+
+(ert-deftest test-equal-vector ()
+  (should (equal [1 two '(three) "four" [five]]
+                 [1 two '(three) "four" [five]])))
+
 (ert-deftest test-load-average ()
   (should (integerp (car (load-average))))
   (should (integerp (car (load-average nil))))
-- 
2.21.0


From 1aeddfaba0c4f76c70521430fd61031adad47898 Mon Sep 17 00:00:00 2001
From: Nick Drozd <nicholasdrozd@gmail.com>
Date: Tue, 22 Jan 2019 08:58:11 -0600
Subject: [PATCH 230/297] Make LispCons::set_c<ad>r generic (#1262)

---
 rust_src/src/lists.rs | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

diff --git a/rust_src/src/lists.rs b/rust_src/src/lists.rs
index 6ec2b1753c..c985f12f6a 100644
--- a/rust_src/src/lists.rs
+++ b/rust_src/src/lists.rs
@@ -325,16 +325,16 @@ impl LispCons {
     }
 
     /// Set the car of the cons cell.
-    pub fn set_car(self, n: LispObject) {
+    pub fn set_car<T: Into<LispObject>>(self, n: T) {
         unsafe {
-            (*self._extract()).u.s.as_mut().car = n;
+            (*self._extract()).u.s.as_mut().car = n.into();
         }
     }
 
     /// Set the car of the cons cell.
-    pub fn set_cdr(self, n: LispObject) {
+    pub fn set_cdr<T: Into<LispObject>>(self, n: T) {
         unsafe {
-            (*self._extract()).u.s.as_mut().u.cdr = n;
+            (*self._extract()).u.s.as_mut().u.cdr = n.into();
         }
     }
 
@@ -765,7 +765,7 @@ where
             let (_, last_cons_cdr) = last_cons.into();
             let last_cons_cdr = LispCons::from(last_cons_cdr);
             let (_, lcc_cdr) = last_cons_cdr.into();
-            last_cons_cdr.set_cdr((prop, (val, lcc_cdr)).into());
+            last_cons_cdr.set_cdr((prop, (val, lcc_cdr)));
             plist
         }
     }
-- 
2.21.0


From c35f97ae0dc3f36a931c88f7e003b3a0a5260079 Mon Sep 17 00:00:00 2001
From: Johannes Altmanninger <aclopte@gmail.com>
Date: Wed, 23 Jan 2019 06:36:42 +0100
Subject: [PATCH 231/297] Port command-error-or-default-function (#1268)

---
 rust_src/Cargo.lock      |  7 +++--
 rust_src/Cargo.toml.in   |  1 +
 rust_src/src/emacs.rs    | 17 +++++++++++
 rust_src/src/keyboard.rs | 62 ++++++++++++++++++++++++++++++++++++----
 src/keyboard.c           | 44 ----------------------------
 5 files changed, 79 insertions(+), 52 deletions(-)

diff --git a/rust_src/Cargo.lock b/rust_src/Cargo.lock
index 376fcdc129..f2e956f035 100644
--- a/rust_src/Cargo.lock
+++ b/rust_src/Cargo.lock
@@ -32,7 +32,7 @@ version = "0.3.8"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "backtrace-sys 0.1.23 (registry+https://github.com/rust-lang/crates.io-index)",
- "cfg-if 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
  "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
  "rustc-demangle 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)",
  "winapi 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -99,7 +99,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "cfg-if"
-version = "0.1.3"
+version = "0.1.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -490,6 +490,7 @@ version = "0.1.0"
 dependencies = [
  "alloc_unexecmacosx 0.1.0",
  "base64 0.10.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
  "clippy 0.0.206 (registry+https://github.com/rust-lang/crates.io-index)",
  "errno 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)",
  "field-offset 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -787,7 +788,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 "checksum byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)" = "94f88df23a25417badc922ab0f5716cc1330e87f71ddd9203b3a3ccd9cedf75d"
 "checksum cargo_metadata 0.5.5 (registry+https://github.com/rust-lang/crates.io-index)" = "692a7aaca96b85973d7d92c5f633d75a399760ee61977db480ffdeadd497cbd2"
 "checksum cc 1.0.17 (registry+https://github.com/rust-lang/crates.io-index)" = "49ec142f5768efb5b7622aebc3fdbdbb8950a4b9ba996393cb76ef7466e8747d"
-"checksum cfg-if 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "405216fd8fe65f718daa7102ea808a946b6ce40c742998fbfd3463645552de18"
+"checksum cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)" = "082bb9b28e00d3c9d39cc03e64ce4cea0f1bb9b3fde493f0cbc008472d22bdf4"
 "checksum clippy 0.0.206 (registry+https://github.com/rust-lang/crates.io-index)" = "f4ee3a52bb1a86cbd575205449951cb425c14afcebc4f1cb7a423cee1e9f7f1f"
 "checksum clippy_lints 0.0.206 (registry+https://github.com/rust-lang/crates.io-index)" = "9d936ee2f2a30d1421d57d653dba488f806f25e46e24a8fe667bcbfb9fa7cfee"
 "checksum crc 1.8.1 (registry+https://github.com/rust-lang/crates.io-index)" = "d663548de7f5cca343f1e0a48d14dcfb0e9eb4e079ec58883b7251539fa10aeb"
diff --git a/rust_src/Cargo.toml.in b/rust_src/Cargo.toml.in
index 14eb621a49..8d19c51e4b 100644
--- a/rust_src/Cargo.toml.in
+++ b/rust_src/Cargo.toml.in
@@ -25,6 +25,7 @@ sha2 = "0.4.2"
 field-offset = "0.1.1"
 flate2 = { version = "1.0.1", features = ["rust_backend"], default-features = false }
 if_chain = "0.1.3"
+cfg-if = "0.1.6"
 
 # Only want this local crate as dependency on Mac OS X
 [target.'cfg(target_os = "macos")'.dependencies]
diff --git a/rust_src/src/emacs.rs b/rust_src/src/emacs.rs
index ee27c4330b..6b140df9b4 100644
--- a/rust_src/src/emacs.rs
+++ b/rust_src/src/emacs.rs
@@ -1,5 +1,7 @@
 //! Emacs!
 
+use cfg_if::cfg_if;
+
 use remacs_macros::lisp_fn;
 
 use crate::{
@@ -8,6 +10,21 @@ use crate::{
     remacs_sys::Fcopy_sequence,
 };
 
+/// Replaces IS_DAEMON
+cfg_if! {
+    if #[cfg(windows)] {
+        use crate::remacs_sys::w32_daemon_event;
+        pub fn is_daemon() -> bool {
+            unsafe { w32_daemon_event != std::ptr::null_mut() }
+        }
+    } else {
+        use crate::remacs_sys::daemon_type;
+        pub fn is_daemon() -> bool {
+            unsafe { daemon_type != 0 }
+        }
+    }
+}
+
 /// Return the program name that was used to run Emacs.
 /// Any directory names are omitted.
 #[lisp_fn]
diff --git a/rust_src/src/keyboard.rs b/rust_src/src/keyboard.rs
index 3c0d7591e9..51d8c698f1 100644
--- a/rust_src/src/keyboard.rs
+++ b/rust_src/src/keyboard.rs
@@ -4,21 +4,27 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     buffers::current_buffer,
+    dispnew::ding_internal,
+    emacs::is_daemon,
     eval::{record_unwind_protect, unbind_to},
     frames::{selected_frame, window_frame_live_or_selected_with_action},
     lisp::defsubr,
     lisp::LispObject,
     lists::{LispCons, LispConsCircularChecks, LispConsEndChecks},
+    multibyte::LispStringRef,
     numbers::IsLispNatnum,
+    remacs_sys::globals,
     remacs_sys::{
-        command_loop_level, glyph_row_area, interrupt_input_blocked, minibuf_level,
-        recursive_edit_1, recursive_edit_unwind, update_mode_lines,
+        clear_message, command_loop_level, glyph_row_area, interrupt_input_blocked,
+        make_lispy_position, message_log_maybe_newline, minibuf_level, output_method,
+        print_error_message, recursive_edit_1, recursive_edit_unwind,
+        temporarily_switch_to_single_kboard, update_mode_lines, window_box_left_offset,
     },
+    remacs_sys::{Fdiscard_input, Fkill_emacs, Fpos_visible_in_window_p, Fterpri, Fthrow},
     remacs_sys::{
-        make_lispy_position, temporarily_switch_to_single_kboard, window_box_left_offset,
+        Qexit, Qexternal_debugging_output, Qheader_line, Qhelp_echo, Qmode_line, Qnil, Qt,
+        Qvertical_line,
     },
-    remacs_sys::{Fpos_visible_in_window_p, Fthrow},
-    remacs_sys::{Qexit, Qheader_line, Qhelp_echo, Qmode_line, Qnil, Qt, Qvertical_line},
     threads::c_specpdl_index,
     windows::{selected_window, LispWindowOrSelected},
 };
@@ -220,4 +226,50 @@ pub extern "C" fn rust_syms_of_keyboard() {
     defvar_kboard!(Vlast_repeatable_command_, "last-repeatable-command");
 }
 
+/// Produce default output for unhandled error message.
+/// Default value of `command-error-function'.
+#[lisp_fn]
+pub fn command_error_default_function(
+    data: LispObject,
+    context: LispStringRef,
+    signal: LispObject,
+) {
+    let selected_frame = selected_frame();
+    // If the window system or terminal frame hasn't been initialized
+    // yet, or we're not interactive, write the message to stderr and
+    // exit.
+    if selected_frame.glyphs_initialized_p()
+        // The initial frame is a special non-displaying frame. It
+        // will be current in daemon mode when there are no frames to
+        // display, and in non-daemon mode before the real frame has
+        // finished initializing.  If an error is thrown in the latter
+        // case while creating the frame, then the frame will never be
+        // displayed, so the safest thing to do is write to stderr and
+        // quit.  In daemon mode, there are many other potential
+        // errors that do not prevent frames from being created, so
+        // continuing as normal is better in that case.
+        || (!is_daemon() && selected_frame.output_method() == output_method::output_initial)
+        || unsafe {globals.noninteractive1 }
+    {
+        unsafe {
+            print_error_message(
+                data,
+                Qexternal_debugging_output,
+                context.const_sdata_ptr(),
+                signal,
+            );
+            Fterpri(Qexternal_debugging_output, Qnil);
+            Fkill_emacs(LispObject::from(-1));
+        }
+    } else {
+        unsafe {
+            clear_message(true, false);
+            Fdiscard_input();
+            message_log_maybe_newline();
+            ding_internal(true);
+            print_error_message(data, Qt, context.const_sdata_ptr(), signal);
+        }
+    }
+}
+
 include!(concat!(env!("OUT_DIR"), "/keyboard_exports.rs"));
diff --git a/src/keyboard.c b/src/keyboard.c
index 285a5c80b6..3f3cf2bf09 100644
--- a/src/keyboard.c
+++ b/src/keyboard.c
@@ -959,49 +959,6 @@ cmd_error_internal (Lisp_Object data, const char *context)
   Vsignaling_function = Qnil;
 }
 
-DEFUN ("command-error-default-function", Fcommand_error_default_function,
-       Scommand_error_default_function, 3, 3, 0,
-       doc: /* Produce default output for unhandled error message.
-Default value of `command-error-function'.  */)
-  (Lisp_Object data, Lisp_Object context, Lisp_Object signal)
-{
-  struct frame *sf = SELECTED_FRAME ();
-
-  CHECK_STRING (context);
-
-  /* If the window system or terminal frame hasn't been initialized
-     yet, or we're not interactive, write the message to stderr and exit.  */
-  if (!sf->glyphs_initialized_p
-	   /* The initial frame is a special non-displaying frame. It
-	      will be current in daemon mode when there are no frames
-	      to display, and in non-daemon mode before the real frame
-	      has finished initializing.  If an error is thrown in the
-	      latter case while creating the frame, then the frame
-	      will never be displayed, so the safest thing to do is
-	      write to stderr and quit.  In daemon mode, there are
-	      many other potential errors that do not prevent frames
-	      from being created, so continuing as normal is better in
-	      that case.  */
-	   || (!IS_DAEMON && FRAME_INITIAL_P (sf))
-	   || noninteractive)
-    {
-      print_error_message (data, Qexternal_debugging_output,
-			   SSDATA (context), signal);
-      Fterpri (Qexternal_debugging_output, Qnil);
-      Fkill_emacs (make_number (-1));
-    }
-  else
-    {
-      clear_message (1, 0);
-      Fdiscard_input ();
-      message_log_maybe_newline ();
-      ding_internal (true);
-
-      print_error_message (data, Qt, SSDATA (context), signal);
-    }
-  return Qnil;
-}
-
 static Lisp_Object command_loop_2 (Lisp_Object);
 static Lisp_Object top_level_1 (Lisp_Object);
 
@@ -11061,7 +11018,6 @@ syms_of_keyboard (void)
   defsubr (&Sclear_this_command_keys);
   defsubr (&Ssuspend_emacs);
   defsubr (&Srecursion_depth);
-  defsubr (&Scommand_error_default_function);
   defsubr (&Stop_level);
   defsubr (&Sdiscard_input);
   defsubr (&Sopen_dribble_file);
-- 
2.21.0


From 1d2fdb23efcdac3985002d529476b519fb74726e Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Wed, 23 Jan 2019 01:14:26 -0800
Subject: [PATCH 232/297] Drop the cerrors test. (#1280)

This has been working for a while. The test costs us 12+ minutes of
CI time for each PR. Also, it is no longer playing nice with the
defaults in Cargo.toml.
---
 .travis-cerrors.sh     | 19 -------------------
 .travis.yml            |  9 ---------
 rust_src/Cargo.toml.in |  1 -
 rust_src/src/lib.rs    | 11 -----------
 4 files changed, 40 deletions(-)
 delete mode 100755 .travis-cerrors.sh

diff --git a/.travis-cerrors.sh b/.travis-cerrors.sh
deleted file mode 100755
index afa1ddfd0c..0000000000
--- a/.travis-cerrors.sh
+++ /dev/null
@@ -1,19 +0,0 @@
-#!/bin/bash
-
-DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
-
-# This is a standalone script so we terminate as soon as anything
-# errors. See https://github.com/travis-ci/travis-ci/issues/1066
-set -e
-set -x
-
-export PATH=$PATH:~/.cargo/bin
-
-RUSTFMT_CONFIG_DIR=$DIR/rust_src
-
-echo "Checking compile errors"
-SKIP_BINDINGS=yes make -C "$DIR/src" generated-bindings
-cd "$DIR/rust_src"
-cargo build --features compile-errors 2> err.out || true
-cat err.out
-grep -q 'compile_error!("error 001");' err.out
diff --git a/.travis.yml b/.travis.yml
index 5205a6ceaa..c1cf1757a1 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -23,7 +23,6 @@ addons:
 stages:
   - rustfmt
   - clippy
-  - cerrors
   - test
 
 jobs:
@@ -38,14 +37,6 @@ jobs:
         - travis_wait rustup component add rustfmt-preview
         - ./autogen.sh && ./configure --without-makeinfo --with-x=no --with-ns=no --without-gconf --without-gsettings
       script: ./.travis-format.sh
-    - stage: cerrors
-      os: linux  # No need to run this everywhere
-      before_script:
-        - travis_wait rustup install $(cat rust-toolchain)
-        - ./autogen.sh && ./configure --without-makeinfo --with-x=no --with-ns=no --without-gconf --without-gsettings --with-gif=no
-        - make -C src globals.h
-      script:
-        - ./.travis-cerrors.sh
     - stage: clippy
       os: linux  # No need to run this everywhere
       before_script:
diff --git a/rust_src/Cargo.toml.in b/rust_src/Cargo.toml.in
index 8d19c51e4b..5cc89feb3e 100644
--- a/rust_src/Cargo.toml.in
+++ b/rust_src/Cargo.toml.in
@@ -64,6 +64,5 @@ window-system-x11 = []
 window-system-nextstep = []
 # Use the w32 window system
 window-system-w32 = []
-compile-errors = []
 # Treat warnings as a build error on Travis.
 strict = []
diff --git a/rust_src/src/lib.rs b/rust_src/src/lib.rs
index 8463e3fd29..1c0d6b3a44 100644
--- a/rust_src/src/lib.rs
+++ b/rust_src/src/lib.rs
@@ -139,17 +139,6 @@ include!(concat!(env!("OUT_DIR"), "/c_exports.rs"));
 #[cfg(test)]
 pub use crate::functions::{lispsym, make_string, make_unibyte_string, Fcons};
 
-#[cfg(feature = "compile-errors")]
-mod compile_errors {
-    use lisp::LispObject;
-    use remacs_macros::lisp_fn;
-
-    #[lisp_fn]
-    fn dummy(x: LispObject) -> LispObject {
-        compile_error!("error 001");
-    }
-}
-
 mod hacks {
     use core::mem::ManuallyDrop;
 
-- 
2.21.0


From 84f7af9d51758ab3bac3a79994c34fa99b0dc35e Mon Sep 17 00:00:00 2001
From: Nick Drozd <nicholasdrozd@gmail.com>
Date: Wed, 23 Jan 2019 05:53:25 -0600
Subject: [PATCH 233/297] Add min args to record (#1276)

---
 rust_src/src/alloc.rs            | 2 +-
 test/rust_src/src/alloc-tests.el | 3 ++-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/rust_src/src/alloc.rs b/rust_src/src/alloc.rs
index 94b69f2843..f997afd0eb 100644
--- a/rust_src/src/alloc.rs
+++ b/rust_src/src/alloc.rs
@@ -83,7 +83,7 @@ pub fn make_record(r#type: LispObject, slots: EmacsUint, init: LispObject) -> Li
 /// symbol or a type descriptor.  SLOTS is used to initialize the record
 /// slots with shallow copies of the arguments.
 /// usage: (record TYPE &rest SLOTS)
-#[lisp_fn]
+#[lisp_fn(min = "1")]
 pub fn record(args: &mut [LispObject]) -> LispObject {
     unsafe {
         let ptr = allocate_record(args.len() as i64);
diff --git a/test/rust_src/src/alloc-tests.el b/test/rust_src/src/alloc-tests.el
index 2771fe5537..88e2784e9e 100644
--- a/test/rust_src/src/alloc-tests.el
+++ b/test/rust_src/src/alloc-tests.el
@@ -17,7 +17,8 @@
 
 (ert-deftest record ()
   (should (recordp (record 'foo)))
-  (should (equal (record 'foo 23 [bar baz] "rats") #s(foo 23 [bar baz] "rats"))))
+  (should (equal (record 'foo 23 [bar baz] "rats") #s(foo 23 [bar baz] "rats")))
+  (should-error (record)))
 
 (provide 'alloc-tests)
 ;;; alloc-tests.el ends here
-- 
2.21.0


From 087f4691eed5a37a82a01b51064b5a94ef57bbfa Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Wed, 23 Jan 2019 08:26:47 -0800
Subject: [PATCH 234/297] Update to new 2019-01-19 nightly. (#1240)

Update external crate versions where possible.
Uses official bindgen 0.46 instead of git repo hash.
Use full path in call to `defsubr` in the macro so it does not need to be imported everywhere.
Fix clippy and rustfmt complaints.
Remove some dead code.
---
 lib-src/hashdir/Cargo.lock             | 435 ++++++++++++++----
 lib-src/hashdir/Cargo.toml             |   6 +-
 rust-toolchain                         |   2 +-
 rust_src/Cargo.lock                    | 601 +++++++------------------
 rust_src/Cargo.toml.in                 |  24 +-
 rust_src/alloc_unexecmacosx/Cargo.toml |   2 +-
 rust_src/build.rs                      |   2 +-
 rust_src/remacs-bindings/Cargo.lock    | 163 ++++---
 rust_src/remacs-bindings/Cargo.toml    |   4 +-
 rust_src/remacs-lib/Cargo.lock         | 214 ++++-----
 rust_src/remacs-lib/Cargo.toml         |  10 +-
 rust_src/remacs-lib/docfile.rs         |   6 +-
 rust_src/remacs-macros/Cargo.lock      | 303 -------------
 rust_src/remacs-macros/lib.rs          |   9 +-
 rust_src/remacs-util/Cargo.lock        | 104 ++---
 rust_src/remacs-util/Cargo.toml        |   3 +-
 rust_src/remacs-util/lib.rs            |   2 -
 rust_src/src/alloc.rs                  |   2 +-
 rust_src/src/base64.rs                 |   1 -
 rust_src/src/buffers.rs                |   1 -
 rust_src/src/bytecode.rs               |   6 +-
 rust_src/src/callint.rs                |   2 +-
 rust_src/src/callproc.rs               |   2 +-
 rust_src/src/casefiddle.rs             |   1 -
 rust_src/src/casetab.rs                |   2 +-
 rust_src/src/category.rs               |   4 +-
 rust_src/src/character.rs              |   1 -
 rust_src/src/charset.rs                |   2 +-
 rust_src/src/chartable.rs              |   1 -
 rust_src/src/cmds.rs                   |   3 +-
 rust_src/src/coding.rs                 |   1 -
 rust_src/src/crypto/mod.rs             | 230 +---------
 rust_src/src/data.rs                   |   2 +-
 rust_src/src/decompress.rs             |   1 -
 rust_src/src/dired.rs                  |   7 +-
 rust_src/src/dispnew.rs                |   5 +-
 rust_src/src/editfns.rs                |   2 +-
 rust_src/src/emacs.rs                  |   6 +-
 rust_src/src/eval.rs                   |   2 +-
 rust_src/src/fileio.rs                 |   2 +-
 rust_src/src/fns.rs                    |   1 -
 rust_src/src/fonts.rs                  |   1 -
 rust_src/src/frames.rs                 |  19 +-
 rust_src/src/hashtable.rs              |   1 -
 rust_src/src/indent.rs                 |   7 +-
 rust_src/src/interactive.rs            |   1 -
 rust_src/src/keyboard.rs               |   1 -
 rust_src/src/keymap.rs                 |   2 +-
 rust_src/src/lib.rs                    |   1 -
 rust_src/src/lisp.rs                   |   2 +-
 rust_src/src/lists.rs                  |   1 -
 rust_src/src/lread.rs                  |   2 +-
 rust_src/src/marker.rs                 |   2 +-
 rust_src/src/math.rs                   |   6 +-
 rust_src/src/minibuf.rs                |   1 -
 rust_src/src/numbers.rs                |   1 -
 rust_src/src/obarray.rs                |   1 -
 rust_src/src/objects.rs                |   6 +-
 rust_src/src/process.rs                |   1 -
 rust_src/src/profiler.rs               |   2 +-
 rust_src/src/search.rs                 |   1 -
 rust_src/src/strings.rs                |   1 -
 rust_src/src/symbols.rs                |   1 -
 rust_src/src/syntax.rs                 |   1 -
 rust_src/src/terminal.rs               |   1 -
 rust_src/src/textprop.rs               |   6 +-
 rust_src/src/threads.rs                |   1 -
 rust_src/src/time.rs                   |   1 -
 rust_src/src/vectors.rs                |   1 -
 rust_src/src/window_configuration.rs   |   1 -
 rust_src/src/windows.rs                |   1 -
 rust_src/src/xfaces.rs                 |   5 +-
 rust_src/src/xml.rs                    |   2 +-
 73 files changed, 854 insertions(+), 1404 deletions(-)
 delete mode 100644 rust_src/remacs-macros/Cargo.lock

diff --git a/lib-src/hashdir/Cargo.lock b/lib-src/hashdir/Cargo.lock
index d2b04b5ea0..14a4ce327e 100644
--- a/lib-src/hashdir/Cargo.lock
+++ b/lib-src/hashdir/Cargo.lock
@@ -1,14 +1,14 @@
 [[package]]
 name = "aho-corasick"
-version = "0.6.4"
+version = "0.6.9"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "arrayref"
-version = "0.3.4"
+name = "autocfg"
+version = "0.1.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -16,36 +16,78 @@ name = "base16"
 version = "0.1.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
+[[package]]
+name = "bitflags"
+version = "1.0.4"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
 [[package]]
 name = "block-buffer"
-version = "0.3.3"
+version = "0.7.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "arrayref 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "byte-tools 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "block-padding 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "byte-tools 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)",
+ "generic-array 0.12.0 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "block-padding"
+version = "0.1.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "byte-tools 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "byte-tools"
-version = "0.2.0"
+version = "0.3.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
+[[package]]
+name = "byteorder"
+version = "1.2.7"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "cfg-if"
-version = "0.1.3"
+version = "0.1.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
-name = "crossbeam"
-version = "0.3.2"
+name = "cloudabi"
+version = "0.0.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "crossbeam-channel"
+version = "0.3.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "crossbeam-utils 0.6.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "parking_lot 0.7.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "smallvec 0.6.7 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "crossbeam-utils"
+version = "0.6.3"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
+]
 
 [[package]]
 name = "digest"
-version = "0.7.2"
+version = "0.8.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "generic-array 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "generic-array 0.12.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -58,9 +100,23 @@ name = "fnv"
 version = "1.0.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
+[[package]]
+name = "fuchsia-zircon"
+version = "0.3.3"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "fuchsia-zircon-sys"
+version = "0.3.3"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
 [[package]]
 name = "generic-array"
-version = "0.9.0"
+version = "0.12.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "typenum 1.10.0 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -68,14 +124,14 @@ dependencies = [
 
 [[package]]
 name = "globset"
-version = "0.4.0"
+version = "0.4.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "aho-corasick 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)",
  "fnv 1.0.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "log 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)",
+ "log 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -83,101 +139,269 @@ name = "hashdir"
 version = "0.1.0"
 dependencies = [
  "base16 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "ignore 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "sha2 0.7.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "ignore 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "sha2 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "ignore"
-version = "0.4.2"
+version = "0.4.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "crossbeam 0.3.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "globset 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "lazy_static 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "log 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)",
- "same-file 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "thread_local 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
- "walkdir 2.1.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "crossbeam-channel 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "globset 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "log 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "same-file 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "walkdir 2.2.7 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi-util 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "lazy_static"
-version = "1.0.1"
+version = "1.2.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "libc"
-version = "0.2.42"
+version = "0.2.47"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
+[[package]]
+name = "lock_api"
+version = "0.1.5"
 source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "owning_ref 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "scopeguard 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
+]
 
 [[package]]
 name = "log"
-version = "0.4.2"
+version = "0.4.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "cfg-if 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "memchr"
-version = "2.0.1"
+version = "2.1.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "version_check 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "opaque-debug"
+version = "0.2.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
+[[package]]
+name = "owning_ref"
+version = "0.4.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "stable_deref_trait 1.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "parking_lot"
+version = "0.7.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "lock_api 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "parking_lot_core 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "parking_lot_core"
+version = "0.4.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rustc_version 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "smallvec 0.6.7 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand"
+version = "0.6.4"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "autocfg 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_chacha 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_hc 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_isaac 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_os 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_pcg 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_xorshift 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_chacha"
+version = "0.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "autocfg 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_core"
+version = "0.3.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
+[[package]]
+name = "rand_hc"
+version = "0.1.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_isaac"
+version = "0.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_os"
+version = "0.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "cloudabi 0.0.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rdrand 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_pcg"
+version = "0.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rustc_version 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_xorshift"
+version = "0.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rdrand"
+version = "0.4.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "regex"
-version = "0.2.11"
+version = "1.1.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "aho-corasick 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex-syntax 0.5.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "thread_local 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
- "utf8-ranges 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)",
+ "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "regex-syntax 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "regex-syntax"
-version = "0.5.6"
+version = "0.6.4"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "ucd-util 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rustc_version"
+version = "0.2.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "ucd-util 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "same-file"
-version = "1.0.2"
+version = "1.0.4"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "winapi 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi-util 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
+[[package]]
+name = "scopeguard"
+version = "0.3.3"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
+[[package]]
+name = "semver"
+version = "0.9.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "semver-parser 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "semver-parser"
+version = "0.7.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
 [[package]]
 name = "sha2"
-version = "0.7.1"
+version = "0.8.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "block-buffer 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "byte-tools 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "digest 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "block-buffer 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "digest 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "fake-simd 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "opaque-debug 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "thread_local"
-version = "0.3.5"
+name = "smallvec"
+version = "0.6.7"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "lazy_static 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
  "unreachable 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
+[[package]]
+name = "stable_deref_trait"
+version = "1.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
+[[package]]
+name = "thread_local"
+version = "0.3.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
 [[package]]
 name = "typenum"
 version = "1.10.0"
@@ -185,7 +409,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "ucd-util"
-version = "0.1.1"
+version = "0.1.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -198,7 +422,12 @@ dependencies = [
 
 [[package]]
 name = "utf8-ranges"
-version = "1.0.0"
+version = "1.0.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
+[[package]]
+name = "version_check"
+version = "0.1.5"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -208,16 +437,17 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "walkdir"
-version = "2.1.4"
+version = "2.2.7"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "same-file 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "same-file 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi-util 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "winapi"
-version = "0.3.5"
+version = "0.3.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -229,40 +459,77 @@ name = "winapi-i686-pc-windows-gnu"
 version = "0.4.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
+[[package]]
+name = "winapi-util"
+version = "0.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
 [[package]]
 name = "winapi-x86_64-pc-windows-gnu"
 version = "0.4.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [metadata]
-"checksum aho-corasick 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)" = "d6531d44de723825aa81398a6415283229725a00fa30713812ab9323faa82fc4"
-"checksum arrayref 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)" = "0fd1479b7c29641adbd35ff3b5c293922d696a92f25c8c975da3e0acbc87258f"
+"checksum aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)" = "1e9a933f4e58658d7b12defcf96dc5c720f20832deebe3e0a19efd3b6aaeeb9e"
+"checksum autocfg 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "4e5f34df7a019573fb8bdc7e24a2bfebe51a2a1d6bfdbaeccedb3c41fc574727"
 "checksum base16 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "a7fd4a4949666bf485542a06de6795ccba71eeabc1f5e9db7a2d82edc3573f6a"
-"checksum block-buffer 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "a076c298b9ecdb530ed9d967e74a6027d6a7478924520acddcddc24c1c8ab3ab"
-"checksum byte-tools 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "560c32574a12a89ecd91f5e742165893f86e3ab98d21f8ea548658eb9eef5f40"
-"checksum cfg-if 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "405216fd8fe65f718daa7102ea808a946b6ce40c742998fbfd3463645552de18"
-"checksum crossbeam 0.3.2 (registry+https://github.com/rust-lang/crates.io-index)" = "24ce9782d4d5c53674646a6a4c1863a21a8fc0cb649b3c94dfc16e45071dea19"
-"checksum digest 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)" = "00a49051fef47a72c9623101b19bd71924a45cca838826caae3eaa4d00772603"
+"checksum bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "228047a76f468627ca71776ecdebd732a3423081fcf5125585bcd7c49886ce12"
+"checksum block-buffer 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)" = "49665c62e0e700857531fa5d3763e91b539ff1abeebd56808d378b495870d60d"
+"checksum block-padding 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "4fc4358306e344bf9775d0197fd00d2603e5afb0771bb353538630f022068ea3"
+"checksum byte-tools 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)" = "980479e6fde23246dfb54d47580d66b4e99202e7579c5eaa9fe10ecb5ebd2182"
+"checksum byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)" = "94f88df23a25417badc922ab0f5716cc1330e87f71ddd9203b3a3ccd9cedf75d"
+"checksum cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)" = "082bb9b28e00d3c9d39cc03e64ce4cea0f1bb9b3fde493f0cbc008472d22bdf4"
+"checksum cloudabi 0.0.3 (registry+https://github.com/rust-lang/crates.io-index)" = "ddfc5b9aa5d4507acaf872de71051dfd0e309860e88966e1051e462a077aac4f"
+"checksum crossbeam-channel 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "137bc235f622ffaa0428e3854e24acb53291fc0b3ff6fb2cb75a8be6fb02f06b"
+"checksum crossbeam-utils 0.6.3 (registry+https://github.com/rust-lang/crates.io-index)" = "41ee4864f4797060e52044376f7d107429ce1fb43460021b126424b7180ee21a"
+"checksum digest 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)" = "05f47366984d3ad862010e22c7ce81a7dbcaebbdfb37241a620f8b6596ee135c"
 "checksum fake-simd 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "e88a8acf291dafb59c2d96e8f59828f3838bb1a70398823ade51a84de6a6deed"
 "checksum fnv 1.0.6 (registry+https://github.com/rust-lang/crates.io-index)" = "2fad85553e09a6f881f739c29f0b00b0f01357c743266d478b68951ce23285f3"
-"checksum generic-array 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ef25c5683767570c2bbd7deba372926a55eaae9982d7726ee2a1050239d45b9d"
-"checksum globset 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "142754da2c9b3722affd909f9e27f2a6700a7a303f362971e0a74c652005a43d"
-"checksum ignore 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)" = "787a5940ab88e0f2f3b2cad3687060bddcf67520f3b761abc31065c9c495d088"
-"checksum lazy_static 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)" = "e6412c5e2ad9584b0b8e979393122026cdd6d2a80b933f890dcd694ddbe73739"
-"checksum libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)" = "b685088df2b950fccadf07a7187c8ef846a959c142338a48f9dc0b94517eb5f1"
-"checksum log 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)" = "6fddaa003a65722a7fb9e26b0ce95921fe4ba590542ced664d8ce2fa26f9f3ac"
-"checksum memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)" = "796fba70e76612589ed2ce7f45282f5af869e0fdd7cc6199fa1aa1f1d591ba9d"
-"checksum regex 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)" = "9329abc99e39129fcceabd24cf5d85b4671ef7c29c50e972bc5afe32438ec384"
-"checksum regex-syntax 0.5.6 (registry+https://github.com/rust-lang/crates.io-index)" = "7d707a4fa2637f2dca2ef9fd02225ec7661fe01a53623c1e6515b6916511f7a7"
-"checksum same-file 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)" = "cfb6eded0b06a0b512c8ddbcf04089138c9b4362c2f696f3c3d76039d68f3637"
-"checksum sha2 0.7.1 (registry+https://github.com/rust-lang/crates.io-index)" = "9eb6be24e4c23a84d7184280d2722f7f2731fcdd4a9d886efbfe4413e4847ea0"
-"checksum thread_local 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)" = "279ef31c19ededf577bfd12dfae728040a21f635b06a24cd670ff510edd38963"
+"checksum fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "2e9763c69ebaae630ba35f74888db465e49e259ba1bc0eda7d06f4a067615d82"
+"checksum fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "3dcaa9ae7725d12cdb85b3ad99a434db70b468c09ded17e012d86b5c1010f7a7"
+"checksum generic-array 0.12.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3c0f28c2f5bfb5960175af447a2da7c18900693738343dc896ffbcabd9839592"
+"checksum globset 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)" = "4743617a7464bbda3c8aec8558ff2f9429047e025771037df561d383337ff865"
+"checksum ignore 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)" = "ad03ca67dc12474ecd91fdb94d758cbd20cb4e7a78ebe831df26a9b7511e1162"
+"checksum lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "a374c89b9db55895453a74c1e38861d9deec0b01b405a82516e9d5de4820dea1"
+"checksum libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)" = "48450664a984b25d5b479554c29cc04e3150c97aa4c01da5604a2d4ed9151476"
+"checksum lock_api 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)" = "62ebf1391f6acad60e5c8b43706dde4582df75c06698ab44511d15016bc2442c"
+"checksum log 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)" = "c84ec4b527950aa83a329754b01dbe3f58361d1c5efacd1f6d68c494d08a17c6"
+"checksum memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "db4c41318937f6e76648f42826b1d9ade5c09cafb5aef7e351240a70f39206e9"
+"checksum opaque-debug 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)" = "51ecbcb821e1bd256d456fe858aaa7f380b63863eab2eb86eee1bd9f33dd6682"
+"checksum owning_ref 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "49a4b8ea2179e6a2e27411d3bca09ca6dd630821cf6894c6c7c8467a8ee7ef13"
+"checksum parking_lot 0.7.1 (registry+https://github.com/rust-lang/crates.io-index)" = "ab41b4aed082705d1056416ae4468b6ea99d52599ecf3169b00088d43113e337"
+"checksum parking_lot_core 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "94c8c7923936b28d546dfd14d4472eaf34c99b14e1c973a32b3e6d4eb04298c9"
+"checksum rand 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)" = "3906503e80ac6cbcacb2c2973fa8e473f24d7e2747c8c92bb230c2441cad96b5"
+"checksum rand_chacha 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "556d3a1ca6600bfcbab7c7c91ccb085ac7fbbcd70e008a98742e7847f4f7bcef"
+"checksum rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)" = "0905b6b7079ec73b314d4c748701f6931eb79fd97c668caa3f1899b22b32c6db"
+"checksum rand_hc 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)" = "7b40677c7be09ae76218dc623efbf7b18e34bced3f38883af07bb75630a21bc4"
+"checksum rand_isaac 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "ded997c9d5f13925be2a6fd7e66bf1872597f759fd9dd93513dd7e92e5a5ee08"
+"checksum rand_os 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "f46fbd5550acf75b0c2730f5dd1873751daf9beb8f11b44027778fae50d7feca"
+"checksum rand_pcg 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "086bd09a33c7044e56bb44d5bdde5a60e7f119a9e95b0775f545de759a32fe05"
+"checksum rand_xorshift 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "cbf7e9e623549b0e21f6e97cf8ecf247c1a8fd2e8a992ae265314300b2455d5c"
+"checksum rdrand 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "678054eb77286b51581ba43620cc911abf02758c91f93f479767aed0f90458b2"
+"checksum regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)" = "37e7cbbd370869ce2e8dff25c7018702d10b21a20ef7135316f8daecd6c25b7f"
+"checksum regex-syntax 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)" = "4e47a2ed29da7a9e1960e1639e7a982e6edc6d49be308a3b02daf511504a16d1"
+"checksum rustc_version 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)" = "138e3e0acb6c9fb258b19b67cb8abd63c00679d2851805ea151465464fe9030a"
+"checksum same-file 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "8f20c4be53a8a1ff4c1f1b2bd14570d2f634628709752f0702ecdd2b3f9a5267"
+"checksum scopeguard 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "94258f53601af11e6a49f722422f6e3425c52b06245a5cf9bc09908b174f5e27"
+"checksum semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)" = "1d7eb9ef2c18661902cc47e535f9bc51b78acd254da71d375c2f6720d9a40403"
+"checksum semver-parser 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)" = "388a1df253eca08550bef6c72392cfe7c30914bf41df5269b68cbd6ff8f570a3"
+"checksum sha2 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)" = "7b4d8bfd0e469f417657573d8451fb33d16cfe0989359b93baf3a1ffc639543d"
+"checksum smallvec 0.6.7 (registry+https://github.com/rust-lang/crates.io-index)" = "b73ea3738b47563803ef814925e69be00799a8c07420be8b996f8e98fb2336db"
+"checksum stable_deref_trait 1.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "dba1a27d3efae4351c8051072d619e3ade2820635c3958d826bfea39d59b54c8"
+"checksum thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "c6b53e329000edc2b34dbe8545fd20e55a333362d0a321909685a19bd28c3f1b"
 "checksum typenum 1.10.0 (registry+https://github.com/rust-lang/crates.io-index)" = "612d636f949607bdf9b123b4a6f6d966dedf3ff669f7f045890d3a4a73948169"
-"checksum ucd-util 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "fd2be2d6639d0f8fe6cdda291ad456e23629558d466e2789d2c3e9892bda285d"
+"checksum ucd-util 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "535c204ee4d8434478593480b8f86ab45ec9aae0e83c568ca81abf0fd0e88f86"
 "checksum unreachable 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "382810877fe448991dfc7f0dd6e3ae5d58088fd0ea5e35189655f84e6814fa56"
-"checksum utf8-ranges 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "662fab6525a98beff2921d7f61a39e7d59e0b425ebc7d0d9e66d316e55124122"
+"checksum utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)" = "796f7e48bef87609f7ade7e06495a87d5cd06c7866e6a5cbfceffc558a243737"
+"checksum version_check 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)" = "914b1a6776c4c929a602fafd8bc742e06365d4bcbe48c30f9cca5824f70dc9dd"
 "checksum void 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)" = "6a02e4885ed3bc0f2de90ea6dd45ebcbb66dacffe03547fadbb0eeae2770887d"
-"checksum walkdir 2.1.4 (registry+https://github.com/rust-lang/crates.io-index)" = "63636bd0eb3d00ccb8b9036381b526efac53caf112b7783b730ab3f8e44da369"
-"checksum winapi 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)" = "773ef9dcc5f24b7d850d0ff101e542ff24c3b090a9768e03ff889fdef41f00fd"
+"checksum walkdir 2.2.7 (registry+https://github.com/rust-lang/crates.io-index)" = "9d9d7ed3431229a144296213105a390676cc49c9b6a72bd19f3176c98e129fa1"
+"checksum winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "92c1eb33641e276cfa214a0522acad57be5c56b10cb348b3c5117db75f3ac4b0"
 "checksum winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ac3b87c63620426dd9b991e5ce0329eff545bccbbb34f3be09ff6fb6ab51b7b6"
+"checksum winapi-util 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "afc5508759c5bf4285e61feb862b6083c8480aec864fa17a81fdec6f69b461ab"
 "checksum winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "712e227841d057c1ee1cd2fb22fa7e5a5461ae8e48fa2ca79ec42cfc1931183f"
diff --git a/lib-src/hashdir/Cargo.toml b/lib-src/hashdir/Cargo.toml
index 5d23048c86..789555b317 100644
--- a/lib-src/hashdir/Cargo.toml
+++ b/lib-src/hashdir/Cargo.toml
@@ -4,6 +4,6 @@ version = "0.1.0"
 authors = ["Daniel Brooks <db48x@db48x.net>"]
 
 [dependencies]
-ignore = "0.4.2"
-sha2 = "0.7.1"
-base16 = "0.1.1"
+ignore = "0.4"
+sha2 = "0.8"
+base16 = "0.1"
diff --git a/rust-toolchain b/rust-toolchain
index 6b277cc26b..48af0245bc 100644
--- a/rust-toolchain
+++ b/rust-toolchain
@@ -1 +1 @@
-nightly-2018-11-03
+nightly-2019-01-19
diff --git a/rust_src/Cargo.lock b/rust_src/Cargo.lock
index f2e956f035..1358a7fca6 100644
--- a/rust_src/Cargo.lock
+++ b/rust_src/Cargo.lock
@@ -5,66 +5,51 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "aho-corasick"
-version = "0.6.4"
+version = "0.6.9"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "alloc_unexecmacosx"
 version = "0.1.0"
 dependencies = [
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "ansi_term"
-version = "0.11.0"
+name = "base64"
+version = "0.10.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "winapi 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "backtrace"
-version = "0.3.8"
+name = "bitflags"
+version = "1.0.4"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "backtrace-sys 0.1.23 (registry+https://github.com/rust-lang/crates.io-index)",
- "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
- "rustc-demangle 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)",
-]
 
 [[package]]
-name = "backtrace-sys"
-version = "0.1.23"
+name = "block-buffer"
+version = "0.7.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "cc 1.0.17 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
+ "block-padding 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "byte-tools 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)",
+ "generic-array 0.12.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "base64"
-version = "0.10.0"
+name = "block-padding"
+version = "0.1.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)",
+ "byte-tools 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
-[[package]]
-name = "bitflags"
-version = "0.9.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "bitflags"
-version = "1.0.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
 [[package]]
 name = "build_const"
 version = "0.2.1"
@@ -72,7 +57,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "byte-tools"
-version = "0.1.3"
+version = "0.3.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -80,21 +65,9 @@ name = "byteorder"
 version = "1.2.7"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
-[[package]]
-name = "cargo_metadata"
-version = "0.5.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "error-chain 0.11.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "serde 1.0.65 (registry+https://github.com/rust-lang/crates.io-index)",
- "serde_derive 1.0.65 (registry+https://github.com/rust-lang/crates.io-index)",
- "serde_json 1.0.19 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
 [[package]]
 name = "cc"
-version = "1.0.17"
+version = "1.0.28"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -104,43 +77,26 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "clippy"
-version = "0.0.206"
+version = "0.0.302"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "ansi_term 0.11.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "clippy_lints 0.0.206 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "rustc_version 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "term 0.5.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "clippy_lints"
-version = "0.0.206"
+name = "crc"
+version = "1.8.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "cargo_metadata 0.5.5 (registry+https://github.com/rust-lang/crates.io-index)",
- "if_chain 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "itertools 0.7.8 (registry+https://github.com/rust-lang/crates.io-index)",
- "lazy_static 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "matches 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "pulldown-cmark 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "quine-mc_cluskey 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex-syntax 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "serde 1.0.65 (registry+https://github.com/rust-lang/crates.io-index)",
- "serde_derive 1.0.65 (registry+https://github.com/rust-lang/crates.io-index)",
- "toml 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "unicode-normalization 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)",
- "url 1.7.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "build_const 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "crc"
-version = "1.8.1"
+name = "crc32fast"
+version = "1.1.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "build_const 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -158,7 +114,7 @@ version = "0.2.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "lazy_static 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
  "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
@@ -175,47 +131,29 @@ dependencies = [
 
 [[package]]
 name = "digest"
-version = "0.4.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "generic-array 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "digest-buffer"
-version = "0.2.0"
+version = "0.8.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "byte-tools 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "generic-array 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "generic-array 0.12.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
-[[package]]
-name = "dtoa"
-version = "0.4.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "either"
-version = "1.5.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
 [[package]]
 name = "errno"
-version = "0.2.3"
+version = "0.2.4"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)",
+ "errno-dragonfly 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "error-chain"
-version = "0.11.0"
+name = "errno-dragonfly"
+version = "0.1.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "backtrace 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)",
+ "gcc 0.3.55 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -230,11 +168,12 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "flate2"
-version = "1.0.1"
+version = "1.0.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
- "miniz_oxide_c_api 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "crc32fast 1.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "miniz_oxide_c_api 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -242,7 +181,7 @@ name = "fuchsia-zircon"
 version = "0.3.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "bitflags 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
  "fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
@@ -251,75 +190,37 @@ name = "fuchsia-zircon-sys"
 version = "0.3.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
+[[package]]
+name = "gcc"
+version = "0.3.55"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
 [[package]]
 name = "generic-array"
-version = "0.6.0"
+version = "0.12.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "nodrop 0.1.12 (registry+https://github.com/rust-lang/crates.io-index)",
  "typenum 1.10.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
-[[package]]
-name = "getopts"
-version = "0.2.17"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
 [[package]]
 name = "ident_case"
 version = "1.0.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
-[[package]]
-name = "idna"
-version = "0.1.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "matches 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "unicode-bidi 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "unicode-normalization 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
 [[package]]
 name = "if_chain"
 version = "0.1.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
-[[package]]
-name = "itertools"
-version = "0.7.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "either 1.5.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "itoa"
-version = "0.4.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "kernel32-sys"
-version = "0.2.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi-build 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "lazy_static"
-version = "0.2.11"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
 [[package]]
 name = "lazy_static"
-version = "1.0.1"
+version = "1.2.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "libc"
-version = "0.2.42"
+version = "0.2.47"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -330,84 +231,53 @@ dependencies = [
  "safemem 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
-[[package]]
-name = "matches"
-version = "0.1.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
 [[package]]
 name = "md5"
-version = "0.3.7"
+version = "0.6.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "memchr"
-version = "2.0.1"
+version = "2.1.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
+ "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "version_check 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "miniz_oxide"
-version = "0.1.3"
+version = "0.2.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "adler32 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "miniz_oxide_c_api"
-version = "0.1.3"
+version = "0.2.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "cc 1.0.17 (registry+https://github.com/rust-lang/crates.io-index)",
+ "cc 1.0.28 (registry+https://github.com/rust-lang/crates.io-index)",
  "crc 1.8.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
- "miniz_oxide 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "miniz_oxide 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "nodrop"
-version = "0.1.12"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "percent-encoding"
-version = "1.0.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "proc-macro2"
-version = "0.3.5"
+name = "opaque-debug"
+version = "0.2.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "unicode-xid 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
 
 [[package]]
 name = "proc-macro2"
-version = "0.4.4"
+version = "0.3.8"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "unicode-xid 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
-[[package]]
-name = "pulldown-cmark"
-version = "0.1.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "bitflags 0.9.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "getopts 0.2.17 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "quine-mc_cluskey"
-version = "0.2.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
 [[package]]
 name = "quote"
 version = "0.3.15"
@@ -418,30 +288,37 @@ name = "quote"
 version = "0.5.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "proc-macro2 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "proc-macro2 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "quote"
-version = "0.6.3"
+name = "rand"
+version = "0.4.5"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "proc-macro2 0.4.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rdrand 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "rand"
-version = "0.4.3"
+name = "rand_core"
+version = "0.3.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
+[[package]]
+name = "rdrand"
+version = "0.4.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "redox_syscall"
-version = "0.1.40"
+version = "0.1.50"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -449,23 +326,23 @@ name = "regex"
 version = "0.2.11"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "aho-corasick 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)",
+ "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
  "regex-syntax 0.5.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "thread_local 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
- "utf8-ranges 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "regex"
-version = "1.0.0"
+version = "1.1.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "aho-corasick 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex-syntax 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "thread_local 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
- "utf8-ranges 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)",
+ "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "regex-syntax 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -473,15 +350,15 @@ name = "regex-syntax"
 version = "0.5.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "ucd-util 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "ucd-util 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "regex-syntax"
-version = "0.6.0"
+version = "0.6.4"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "ucd-util 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "ucd-util 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -491,21 +368,21 @@ dependencies = [
  "alloc_unexecmacosx 0.1.0",
  "base64 0.10.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "clippy 0.0.206 (registry+https://github.com/rust-lang/crates.io-index)",
- "errno 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "clippy 0.0.302 (registry+https://github.com/rust-lang/crates.io-index)",
+ "errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
  "field-offset 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "flate2 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "flate2 1.0.6 (registry+https://github.com/rust-lang/crates.io-index)",
  "if_chain 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "lazy_static 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
+ "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
  "line-wrap 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "md5 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)",
- "rand 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)",
+ "md5 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand 0.4.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "remacs-lib 0.1.0",
  "remacs-macros 0.1.0",
- "sha1 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "sha2 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "sha1 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "sha2 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -513,21 +390,21 @@ name = "remacs-lib"
 version = "0.1.0"
 dependencies = [
  "darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "errno 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "lazy_static 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
- "rand 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)",
+ "errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand 0.4.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "remacs-util 0.1.0",
  "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
- "time 0.1.40 (registry+https://github.com/rust-lang/crates.io-index)",
+ "time 0.1.42 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "remacs-macros"
 version = "0.1.0"
 dependencies = [
- "lazy_static 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "quote 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)",
  "regex 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)",
  "remacs-util 0.1.0",
@@ -539,84 +416,30 @@ name = "remacs-util"
 version = "0.1.0"
 dependencies = [
  "darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "errno 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
- "rand 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
  "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
-[[package]]
-name = "rustc-demangle"
-version = "0.1.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "rustc_version"
-version = "0.2.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
 [[package]]
 name = "safemem"
 version = "0.3.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
-[[package]]
-name = "semver"
-version = "0.9.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "semver-parser 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "serde 1.0.65 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "semver-parser"
-version = "0.7.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "serde"
-version = "1.0.65"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "serde_derive"
-version = "1.0.65"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "proc-macro2 0.4.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "quote 0.6.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "syn 0.14.1 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "serde_json"
-version = "1.0.19"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "dtoa 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "itoa 0.4.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "serde 1.0.65 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
 [[package]]
 name = "sha1"
-version = "0.2.0"
+version = "0.6.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "sha2"
-version = "0.4.2"
+version = "0.8.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "byte-tools 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "digest 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "digest-buffer 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "block-buffer 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "digest 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "fake-simd 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "generic-array 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "opaque-debug 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -634,21 +457,11 @@ name = "syn"
 version = "0.13.11"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "proc-macro2 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "proc-macro2 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)",
  "quote 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)",
  "unicode-xid 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
-[[package]]
-name = "syn"
-version = "0.14.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "proc-macro2 0.4.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "quote 0.6.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "unicode-xid 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
 [[package]]
 name = "synom"
 version = "0.11.3"
@@ -658,30 +471,30 @@ dependencies = [
 ]
 
 [[package]]
-name = "thread_local"
-version = "0.3.5"
+name = "term"
+version = "0.5.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "lazy_static 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "unreachable 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "time"
-version = "0.1.40"
+name = "thread_local"
+version = "0.3.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)",
- "redox_syscall 0.1.40 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "toml"
-version = "0.4.6"
+name = "time"
+version = "0.1.42"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "serde 1.0.65 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "redox_syscall 0.1.50 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -691,20 +504,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "ucd-util"
-version = "0.1.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "unicode-bidi"
-version = "0.3.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "matches 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "unicode-normalization"
-version = "0.1.7"
+version = "0.1.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -717,53 +517,25 @@ name = "unicode-xid"
 version = "0.1.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
-[[package]]
-name = "unreachable"
-version = "1.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "void 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "url"
-version = "1.7.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "idna 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "matches 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "percent-encoding 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
 [[package]]
 name = "utf8-ranges"
-version = "1.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "void"
 version = "1.0.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
-name = "winapi"
-version = "0.2.8"
+name = "version_check"
+version = "0.1.5"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "winapi"
-version = "0.3.4"
+version = "0.3.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
-[[package]]
-name = "winapi-build"
-version = "0.1.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
 [[package]]
 name = "winapi-i686-pc-windows-gnu"
 version = "0.4.0"
@@ -776,97 +548,68 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [metadata]
 "checksum adler32 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)" = "7e522997b529f05601e05166c07ed17789691f562762c7f3b987263d2dedee5c"
-"checksum aho-corasick 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)" = "d6531d44de723825aa81398a6415283229725a00fa30713812ab9323faa82fc4"
-"checksum ansi_term 0.11.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ee49baf6cb617b853aa8d93bf420db2383fab46d314482ca2803b40d5fde979b"
-"checksum backtrace 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)" = "dbdd17cd962b570302f5297aea8648d5923e22e555c2ed2d8b2e34eca646bf6d"
-"checksum backtrace-sys 0.1.23 (registry+https://github.com/rust-lang/crates.io-index)" = "bff67d0c06556c0b8e6b5f090f0eac52d950d9dfd1d35ba04e4ca3543eaf6a7e"
+"checksum aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)" = "1e9a933f4e58658d7b12defcf96dc5c720f20832deebe3e0a19efd3b6aaeeb9e"
 "checksum base64 0.10.0 (registry+https://github.com/rust-lang/crates.io-index)" = "621fc7ecb8008f86d7fb9b95356cd692ce9514b80a86d85b397f32a22da7b9e2"
-"checksum bitflags 0.9.1 (registry+https://github.com/rust-lang/crates.io-index)" = "4efd02e230a02e18f92fc2735f44597385ed02ad8f831e7c1c1156ee5e1ab3a5"
-"checksum bitflags 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)" = "d0c54bb8f454c567f21197eefcdbf5679d0bd99f2ddbe52e84c77061952e6789"
+"checksum bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "228047a76f468627ca71776ecdebd732a3423081fcf5125585bcd7c49886ce12"
+"checksum block-buffer 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)" = "49665c62e0e700857531fa5d3763e91b539ff1abeebd56808d378b495870d60d"
+"checksum block-padding 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "4fc4358306e344bf9775d0197fd00d2603e5afb0771bb353538630f022068ea3"
 "checksum build_const 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)" = "39092a32794787acd8525ee150305ff051b0aa6cc2abaf193924f5ab05425f39"
-"checksum byte-tools 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "0919189ba800c7ffe8778278116b7e0de3905ab81c72abb69c85cbfef7991279"
+"checksum byte-tools 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)" = "980479e6fde23246dfb54d47580d66b4e99202e7579c5eaa9fe10ecb5ebd2182"
 "checksum byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)" = "94f88df23a25417badc922ab0f5716cc1330e87f71ddd9203b3a3ccd9cedf75d"
-"checksum cargo_metadata 0.5.5 (registry+https://github.com/rust-lang/crates.io-index)" = "692a7aaca96b85973d7d92c5f633d75a399760ee61977db480ffdeadd497cbd2"
-"checksum cc 1.0.17 (registry+https://github.com/rust-lang/crates.io-index)" = "49ec142f5768efb5b7622aebc3fdbdbb8950a4b9ba996393cb76ef7466e8747d"
+"checksum cc 1.0.28 (registry+https://github.com/rust-lang/crates.io-index)" = "bb4a8b715cb4597106ea87c7c84b2f1d452c7492033765df7f32651e66fcf749"
 "checksum cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)" = "082bb9b28e00d3c9d39cc03e64ce4cea0f1bb9b3fde493f0cbc008472d22bdf4"
-"checksum clippy 0.0.206 (registry+https://github.com/rust-lang/crates.io-index)" = "f4ee3a52bb1a86cbd575205449951cb425c14afcebc4f1cb7a423cee1e9f7f1f"
-"checksum clippy_lints 0.0.206 (registry+https://github.com/rust-lang/crates.io-index)" = "9d936ee2f2a30d1421d57d653dba488f806f25e46e24a8fe667bcbfb9fa7cfee"
+"checksum clippy 0.0.302 (registry+https://github.com/rust-lang/crates.io-index)" = "d911ee15579a3f50880d8c1d59ef6e79f9533127a3bd342462f5d584f5e8c294"
 "checksum crc 1.8.1 (registry+https://github.com/rust-lang/crates.io-index)" = "d663548de7f5cca343f1e0a48d14dcfb0e9eb4e079ec58883b7251539fa10aeb"
+"checksum crc32fast 1.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "e91d5240c6975ef33aeb5f148f35275c25eda8e8a5f95abe421978b05b8bf192"
 "checksum darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "1630fdbe3554154a50624487c79b0140a424e87dc08061db1a2211359792acab"
 "checksum darling_core 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "d12d2eeb837786ace70b6bca9adfeaef4352cc68d6a42e8e3d0c4159bbca7ab2"
 "checksum darling_macro 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "01581bdeabb86f69970dbd9e6ee3c61963f9a7321169589e3dffa16033c0928c"
-"checksum digest 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "41a0f307b67d9f0e57edc00804d3146f9f889fe8b2422825566c8e8dd2b5733c"
-"checksum digest-buffer 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "79472b4b47364a1f1c23122d5b5e481b4657714c61617ea91daf6f57549b5f00"
-"checksum dtoa 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)" = "09c3753c3db574d215cba4ea76018483895d7bff25a31b49ba45db21c48e50ab"
-"checksum either 1.5.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3be565ca5c557d7f59e7cfcf1844f9e3033650c929c6566f511e8005f205c1d0"
-"checksum errno 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)" = "b2c858c42ac0b88532f48fca88b0ed947cad4f1f64d904bcd6c9f138f7b95d70"
-"checksum error-chain 0.11.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ff511d5dc435d703f4971bc399647c9bc38e20cb41452e3b9feb4765419ed3f3"
+"checksum digest 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)" = "05f47366984d3ad862010e22c7ce81a7dbcaebbdfb37241a620f8b6596ee135c"
+"checksum errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)" = "c2a071601ed01b988f896ab14b95e67335d1eeb50190932a1320f7fe3cadc84e"
+"checksum errno-dragonfly 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "14ca354e36190500e1e1fb267c647932382b54053c50b14970856c0b00a35067"
 "checksum fake-simd 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "e88a8acf291dafb59c2d96e8f59828f3838bb1a70398823ade51a84de6a6deed"
 "checksum field-offset 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "64e9bc339e426139e02601fa69d101e96a92aee71b58bc01697ec2a63a5c9e68"
-"checksum flate2 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)" = "9fac2277e84e5e858483756647a9d0aa8d9a2b7cba517fd84325a0aaa69a0909"
+"checksum flate2 1.0.6 (registry+https://github.com/rust-lang/crates.io-index)" = "2291c165c8e703ee54ef3055ad6188e3d51108e2ded18e9f2476e774fc5ad3d4"
 "checksum fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "2e9763c69ebaae630ba35f74888db465e49e259ba1bc0eda7d06f4a067615d82"
 "checksum fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "3dcaa9ae7725d12cdb85b3ad99a434db70b468c09ded17e012d86b5c1010f7a7"
-"checksum generic-array 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)" = "7229d82657e79be00d5f2a110a973ab5340681b945cf1bc022be7cfebf2dc00c"
-"checksum getopts 0.2.17 (registry+https://github.com/rust-lang/crates.io-index)" = "b900c08c1939860ce8b54dc6a89e26e00c04c380fd0e09796799bd7f12861e05"
+"checksum gcc 0.3.55 (registry+https://github.com/rust-lang/crates.io-index)" = "8f5f3913fa0bfe7ee1fd8248b6b9f42a5af4b9d65ec2dd2c3c26132b950ecfc2"
+"checksum generic-array 0.12.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3c0f28c2f5bfb5960175af447a2da7c18900693738343dc896ffbcabd9839592"
 "checksum ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3c9826188e666f2ed92071d2dadef6edc430b11b158b5b2b3f4babbcc891eaaa"
-"checksum idna 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)" = "014b298351066f1512874135335d62a789ffe78a9974f94b43ed5621951eaf7d"
 "checksum if_chain 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "4bac95d9aa0624e7b78187d6fb8ab012b41d9f6f54b1bcb61e61c4845f8357ec"
-"checksum itertools 0.7.8 (registry+https://github.com/rust-lang/crates.io-index)" = "f58856976b776fedd95533137617a02fb25719f40e7d9b01c7043cd65474f450"
-"checksum itoa 0.4.1 (registry+https://github.com/rust-lang/crates.io-index)" = "c069bbec61e1ca5a596166e55dfe4773ff745c3d16b700013bcaff9a6df2c682"
-"checksum kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "7507624b29483431c0ba2d82aece8ca6cdba9382bff4ddd0f7490560c056098d"
-"checksum lazy_static 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)" = "76f033c7ad61445c5b347c7382dd1237847eb1bce590fe50365dcb33d546be73"
-"checksum lazy_static 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)" = "e6412c5e2ad9584b0b8e979393122026cdd6d2a80b933f890dcd694ddbe73739"
-"checksum libc 0.2.42 (registry+https://github.com/rust-lang/crates.io-index)" = "b685088df2b950fccadf07a7187c8ef846a959c142338a48f9dc0b94517eb5f1"
+"checksum lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "a374c89b9db55895453a74c1e38861d9deec0b01b405a82516e9d5de4820dea1"
+"checksum libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)" = "48450664a984b25d5b479554c29cc04e3150c97aa4c01da5604a2d4ed9151476"
 "checksum line-wrap 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "f30344350a2a51da54c1d53be93fade8a237e545dbcc4bdbe635413f2117cab9"
-"checksum matches 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)" = "100aabe6b8ff4e4a7e32c1c13523379802df0772b82466207ac25b013f193376"
-"checksum md5 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)" = "daa1004633f76cdcd5a9d83ffcfe615e30ca7a2a638fcc8b8039a2dac21289d7"
-"checksum memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)" = "796fba70e76612589ed2ce7f45282f5af869e0fdd7cc6199fa1aa1f1d591ba9d"
-"checksum miniz_oxide 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "9ba430291c9d6cedae28bcd2d49d1c32fc57d60cd49086646c5dd5673a870eb5"
-"checksum miniz_oxide_c_api 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "5a5b8234d6103ebfba71e29786da4608540f862de5ce980a1c94f86a40ca0d51"
-"checksum nodrop 0.1.12 (registry+https://github.com/rust-lang/crates.io-index)" = "9a2228dca57108069a5262f2ed8bd2e82496d2e074a06d1ccc7ce1687b6ae0a2"
-"checksum percent-encoding 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)" = "31010dd2e1ac33d5b46a5b413495239882813e0369f8ed8a5e266f173602f831"
-"checksum proc-macro2 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)" = "77997c53ae6edd6d187fec07ec41b207063b5ee6f33680e9fa86d405cdd313d4"
-"checksum proc-macro2 0.4.4 (registry+https://github.com/rust-lang/crates.io-index)" = "1fa93823f53cfd0f5ac117b189aed6cfdfb2cfc0a9d82e956dd7927595ed7d46"
-"checksum pulldown-cmark 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "d6fdf85cda6cadfae5428a54661d431330b312bc767ddbc57adbedc24da66e32"
-"checksum quine-mc_cluskey 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)" = "07589615d719a60c8dd8a4622e7946465dfef20d1a428f969e3443e7386d5f45"
+"checksum md5 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)" = "7e6bcd6433cff03a4bfc3d9834d504467db1f1cf6d0ea765d37d330249ed629d"
+"checksum memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "db4c41318937f6e76648f42826b1d9ade5c09cafb5aef7e351240a70f39206e9"
+"checksum miniz_oxide 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "5ad30a47319c16cde58d0314f5d98202a80c9083b5f61178457403dfb14e509c"
+"checksum miniz_oxide_c_api 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "28edaef377517fd9fe3e085c37d892ce7acd1fbeab9239c5a36eec352d8a8b7e"
+"checksum opaque-debug 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)" = "51ecbcb821e1bd256d456fe858aaa7f380b63863eab2eb86eee1bd9f33dd6682"
+"checksum proc-macro2 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)" = "1b06e2f335f48d24442b35a19df506a835fb3547bc3c06ef27340da9acf5cae7"
 "checksum quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)" = "7a6e920b65c65f10b2ae65c831a81a073a89edd28c7cce89475bff467ab4167a"
 "checksum quote 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)" = "9949cfe66888ffe1d53e6ec9d9f3b70714083854be20fd5e271b232a017401e8"
-"checksum quote 0.6.3 (registry+https://github.com/rust-lang/crates.io-index)" = "e44651a0dc4cdd99f71c83b561e221f714912d11af1a4dff0631f923d53af035"
-"checksum rand 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)" = "8356f47b32624fef5b3301c1be97e5944ecdd595409cc5da11d05f211db6cfbd"
-"checksum redox_syscall 0.1.40 (registry+https://github.com/rust-lang/crates.io-index)" = "c214e91d3ecf43e9a4e41e578973adeb14b474f2bee858742d127af75a0112b1"
+"checksum rand 0.4.5 (registry+https://github.com/rust-lang/crates.io-index)" = "dee497e66d8d76bf08ce20c8d36e16f93749ab0bf89975b4f8ae5cee660c2da2"
+"checksum rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)" = "0905b6b7079ec73b314d4c748701f6931eb79fd97c668caa3f1899b22b32c6db"
+"checksum rdrand 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "678054eb77286b51581ba43620cc911abf02758c91f93f479767aed0f90458b2"
+"checksum redox_syscall 0.1.50 (registry+https://github.com/rust-lang/crates.io-index)" = "52ee9a534dc1301776eff45b4fa92d2c39b1d8c3d3357e6eb593e0d795506fc2"
 "checksum regex 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)" = "9329abc99e39129fcceabd24cf5d85b4671ef7c29c50e972bc5afe32438ec384"
-"checksum regex 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "75ecf88252dce580404a22444fc7d626c01815debba56a7f4f536772a5ff19d3"
+"checksum regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)" = "37e7cbbd370869ce2e8dff25c7018702d10b21a20ef7135316f8daecd6c25b7f"
 "checksum regex-syntax 0.5.6 (registry+https://github.com/rust-lang/crates.io-index)" = "7d707a4fa2637f2dca2ef9fd02225ec7661fe01a53623c1e6515b6916511f7a7"
-"checksum regex-syntax 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)" = "8f1ac0f60d675cc6cf13a20ec076568254472551051ad5dd050364d70671bf6b"
-"checksum rustc-demangle 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)" = "76d7ba1feafada44f2d38eed812bd2489a03c0f5abb975799251518b68848649"
-"checksum rustc_version 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "a54aa04a10c68c1c4eacb4337fd883b435997ede17a9385784b990777686b09a"
+"checksum regex-syntax 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)" = "4e47a2ed29da7a9e1960e1639e7a982e6edc6d49be308a3b02daf511504a16d1"
 "checksum safemem 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)" = "8dca453248a96cb0749e36ccdfe2b0b4e54a61bfef89fb97ec621eb8e0a93dd9"
-"checksum semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)" = "1d7eb9ef2c18661902cc47e535f9bc51b78acd254da71d375c2f6720d9a40403"
-"checksum semver-parser 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)" = "388a1df253eca08550bef6c72392cfe7c30914bf41df5269b68cbd6ff8f570a3"
-"checksum serde 1.0.65 (registry+https://github.com/rust-lang/crates.io-index)" = "5d47469df098fe8701d4da22680da5145e83801bdaaafea0cf91a180436fc343"
-"checksum serde_derive 1.0.65 (registry+https://github.com/rust-lang/crates.io-index)" = "35eff0f5f70b6a2e902a2bbf4b079be4aacb14afc9676ba4798e0486401cedcb"
-"checksum serde_json 1.0.19 (registry+https://github.com/rust-lang/crates.io-index)" = "93aee34bb692dde91e602871bc792dd319e489c7308cdbbe5f27cf27c64280f5"
-"checksum sha1 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "cc30b1e1e8c40c121ca33b86c23308a090d19974ef001b4bf6e61fd1a0fb095c"
-"checksum sha2 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)" = "25405172e8d8325cbbb72af68adc28931dacd1482d067facc46ac808f48df55c"
+"checksum sha1 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)" = "2579985fda508104f7587689507983eadd6a6e84dd35d6d115361f530916fa0d"
+"checksum sha2 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)" = "7b4d8bfd0e469f417657573d8451fb33d16cfe0989359b93baf3a1ffc639543d"
 "checksum syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)" = "d3b891b9015c88c576343b9b3e41c2c11a51c219ef067b264bd9c8aa9b441dad"
 "checksum syn 0.13.11 (registry+https://github.com/rust-lang/crates.io-index)" = "14f9bf6292f3a61d2c716723fdb789a41bbe104168e6f496dc6497e531ea1b9b"
-"checksum syn 0.14.1 (registry+https://github.com/rust-lang/crates.io-index)" = "6dfd71b2be5a58ee30a6f8ea355ba8290d397131c00dfa55c3d34e6e13db5101"
 "checksum synom 0.11.3 (registry+https://github.com/rust-lang/crates.io-index)" = "a393066ed9010ebaed60b9eafa373d4b1baac186dd7e008555b0f702b51945b6"
-"checksum thread_local 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)" = "279ef31c19ededf577bfd12dfae728040a21f635b06a24cd670ff510edd38963"
-"checksum time 0.1.40 (registry+https://github.com/rust-lang/crates.io-index)" = "d825be0eb33fda1a7e68012d51e9c7f451dc1a69391e7fdc197060bb8c56667b"
-"checksum toml 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)" = "a0263c6c02c4db6c8f7681f9fd35e90de799ebd4cfdeab77a38f4ff6b3d8c0d9"
+"checksum term 0.5.1 (registry+https://github.com/rust-lang/crates.io-index)" = "5e6b677dd1e8214ea1ef4297f85dbcbed8e8cdddb561040cc998ca2551c37561"
+"checksum thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "c6b53e329000edc2b34dbe8545fd20e55a333362d0a321909685a19bd28c3f1b"
+"checksum time 0.1.42 (registry+https://github.com/rust-lang/crates.io-index)" = "db8dcfca086c1143c9270ac42a2bbd8a7ee477b78ac8e45b19abfb0cbede4b6f"
 "checksum typenum 1.10.0 (registry+https://github.com/rust-lang/crates.io-index)" = "612d636f949607bdf9b123b4a6f6d966dedf3ff669f7f045890d3a4a73948169"
-"checksum ucd-util 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "fd2be2d6639d0f8fe6cdda291ad456e23629558d466e2789d2c3e9892bda285d"
-"checksum unicode-bidi 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)" = "49f2bd0c6468a8230e1db229cff8029217cf623c767ea5d60bfbd42729ea54d5"
-"checksum unicode-normalization 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)" = "6a0180bc61fc5a987082bfa111f4cc95c4caff7f9799f3e46df09163a937aa25"
+"checksum ucd-util 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "535c204ee4d8434478593480b8f86ab45ec9aae0e83c568ca81abf0fd0e88f86"
 "checksum unicode-xid 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "8c1f860d7d29cf02cb2f3f359fd35991af3d30bac52c57d265a3c461074cb4dc"
 "checksum unicode-xid 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)" = "fc72304796d0818e357ead4e000d19c9c174ab23dc11093ac919054d20a6a7fc"
-"checksum unreachable 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "382810877fe448991dfc7f0dd6e3ae5d58088fd0ea5e35189655f84e6814fa56"
-"checksum url 1.7.0 (registry+https://github.com/rust-lang/crates.io-index)" = "f808aadd8cfec6ef90e4a14eb46f24511824d1ac596b9682703c87056c8678b7"
-"checksum utf8-ranges 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "662fab6525a98beff2921d7f61a39e7d59e0b425ebc7d0d9e66d316e55124122"
-"checksum void 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)" = "6a02e4885ed3bc0f2de90ea6dd45ebcbb66dacffe03547fadbb0eeae2770887d"
-"checksum winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)" = "167dc9d6949a9b857f3451275e911c3f44255842c1f7a76f33c55103a909087a"
-"checksum winapi 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)" = "04e3bd221fcbe8a271359c04f21a76db7d0c6028862d1bb5512d85e1e2eb5bb3"
-"checksum winapi-build 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "2d315eee3b34aca4797b2da6b13ed88266e6d612562a0c46390af8299fc699bc"
+"checksum utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)" = "796f7e48bef87609f7ade7e06495a87d5cd06c7866e6a5cbfceffc558a243737"
+"checksum version_check 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)" = "914b1a6776c4c929a602fafd8bc742e06365d4bcbe48c30f9cca5824f70dc9dd"
+"checksum winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "92c1eb33641e276cfa214a0522acad57be5c56b10cb348b3c5117db75f3ac4b0"
 "checksum winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ac3b87c63620426dd9b991e5ce0329eff545bccbbb34f3be09ff6fb6ab51b7b6"
 "checksum winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "712e227841d057c1ee1cd2fb22fa7e5a5461ae8e48fa2ca79ec42cfc1931183f"
diff --git a/rust_src/Cargo.toml.in b/rust_src/Cargo.toml.in
index 5cc89feb3e..40c1675864 100644
--- a/rust_src/Cargo.toml.in
+++ b/rust_src/Cargo.toml.in
@@ -14,18 +14,18 @@ remacs-lib = { version = "0.1.0", path = "remacs-lib" }
 remacs-macros = { version = "0.1.0", path = "remacs-macros" }
 base64 = "0.10.0"
 clippy = { version = "*", optional = true }
-errno = "0.2.3"
-lazy_static = "0.2.2"
+cfg-if = "0.1"
+errno = "0.2"
+field-offset = "0.1"
+flate2 = { version = "1.0", features = ["rust_backend"], default-features = false }
+if_chain = "0.1"
+lazy_static = "1.2"
 libc = "0.2"
 line-wrap = "0.1.1"
-md5 = "0.3.5"
-rand = "0.4.3"
-sha1 = "0.2.0"
-sha2 = "0.4.2"
-field-offset = "0.1.1"
-flate2 = { version = "1.0.1", features = ["rust_backend"], default-features = false }
-if_chain = "0.1.3"
-cfg-if = "0.1.6"
+md5 = "0.6"
+rand = "0.4"
+sha1 = "0.6"
+sha2 = "0.8"
 
 # Only want this local crate as dependency on Mac OS X
 [target.'cfg(target_os = "macos")'.dependencies]
@@ -33,9 +33,9 @@ alloc_unexecmacosx = { version = "0.1.0", path = "alloc_unexecmacosx", optional
 
 [build-dependencies]
 clippy = { version = "*", optional = true }
-lazy_static = "0.2.2"
+lazy_static = "1.2"
 libc = "0.2"
-regex = "0.2"
+regex = "1.1"
 
 [lib]
 crate-type = ["staticlib"]
diff --git a/rust_src/alloc_unexecmacosx/Cargo.toml b/rust_src/alloc_unexecmacosx/Cargo.toml
index eee3be35d8..600bb42134 100644
--- a/rust_src/alloc_unexecmacosx/Cargo.toml
+++ b/rust_src/alloc_unexecmacosx/Cargo.toml
@@ -5,4 +5,4 @@ authors = ["Felix S. Klock II <pnkfelix@pnkfx.org>"]
 edition = "2018"
 
 [dependencies]
-libc = { version = "0.2.17", default-features = false }
+libc = { version = "0.2", default-features = false }
diff --git a/rust_src/build.rs b/rust_src/build.rs
index e014acc555..44184e1b39 100644
--- a/rust_src/build.rs
+++ b/rust_src/build.rs
@@ -326,7 +326,7 @@ fn handle_file(mod_path: &PathBuf) -> Result<Option<ModuleData>, BuildError> {
                     e.kind(),
                     format!("Failed to open {}: {}", mod_info.path.to_string_lossy(), e),
                 )
-                .into())
+                .into());
             }
         };
 
diff --git a/rust_src/remacs-bindings/Cargo.lock b/rust_src/remacs-bindings/Cargo.lock
index 81b4d21be8..211b10e1b5 100644
--- a/rust_src/remacs-bindings/Cargo.lock
+++ b/rust_src/remacs-bindings/Cargo.lock
@@ -19,29 +19,57 @@ name = "atty"
 version = "0.2.11"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "libc 0.2.45 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
  "termion 1.5.1 (registry+https://github.com/rust-lang/crates.io-index)",
  "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
+[[package]]
+name = "autocfg"
+version = "0.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
+[[package]]
+name = "backtrace"
+version = "0.3.13"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "autocfg 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "backtrace-sys 0.1.28 (registry+https://github.com/rust-lang/crates.io-index)",
+ "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rustc-demangle 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "backtrace-sys"
+version = "0.1.28"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "cc 1.0.28 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
 [[package]]
 name = "bindgen"
-version = "0.42.2"
-source = "git+https://github.com/rust-lang-nursery/rust-bindgen.git?rev=badb49277dddf1ea5d407075f9deea48897b52df#badb49277dddf1ea5d407075f9deea48897b52df"
+version = "0.46.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "cexpr 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "cexpr 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)",
  "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "clang-sys 0.26.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "clang-sys 0.26.4 (registry+https://github.com/rust-lang/crates.io-index)",
  "clap 2.32.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "env_logger 0.5.13 (registry+https://github.com/rust-lang/crates.io-index)",
+ "env_logger 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "hashbrown 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)",
  "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "log 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)",
  "peeking_take_while 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "proc-macro2 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
- "quote 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "proc-macro2 0.4.24 (registry+https://github.com/rust-lang/crates.io-index)",
+ "quote 0.6.10 (registry+https://github.com/rust-lang/crates.io-index)",
  "regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "which 1.0.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "which 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -49,6 +77,11 @@ name = "bitflags"
 version = "1.0.4"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
+[[package]]
+name = "byteorder"
+version = "1.2.7"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
 [[package]]
 name = "cc"
 version = "1.0.28"
@@ -56,7 +89,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "cexpr"
-version = "0.3.3"
+version = "0.3.4"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "nom 4.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -69,11 +102,11 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "clang-sys"
-version = "0.26.3"
+version = "0.26.4"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "glob 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.45 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
  "libloading 0.5.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
@@ -93,7 +126,7 @@ dependencies = [
 
 [[package]]
 name = "env_logger"
-version = "0.5.13"
+version = "0.6.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "atty 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -103,11 +136,28 @@ dependencies = [
  "termcolor 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
+[[package]]
+name = "failure"
+version = "0.1.5"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "backtrace 0.3.13 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
 [[package]]
 name = "glob"
 version = "0.2.11"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
+[[package]]
+name = "hashbrown"
+version = "0.1.8"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)",
+ "scopeguard 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
 [[package]]
 name = "humantime"
 version = "1.2.0"
@@ -123,7 +173,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "libc"
-version = "0.2.45"
+version = "0.2.47"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -149,7 +199,7 @@ version = "2.1.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.45 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
  "version_check 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
@@ -168,7 +218,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "proc-macro2"
-version = "0.3.5"
+version = "0.4.24"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "unicode-xid 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -181,15 +231,15 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "quote"
-version = "0.5.2"
+version = "0.6.10"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "proc-macro2 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "proc-macro2 0.4.24 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "redox_syscall"
-version = "0.1.44"
+version = "0.1.50"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -197,19 +247,7 @@ name = "redox_termios"
 version = "0.1.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "redox_syscall 0.1.44 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "regex"
-version = "0.2.11"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)",
- "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex-syntax 0.5.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "redox_syscall 0.1.50 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -224,14 +262,6 @@ dependencies = [
  "utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
-[[package]]
-name = "regex-syntax"
-version = "0.5.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "ucd-util 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
 [[package]]
 name = "regex-syntax"
 version = "0.6.4"
@@ -244,11 +274,21 @@ dependencies = [
 name = "remacs-bindings"
 version = "0.1.0"
 dependencies = [
- "bindgen 0.42.2 (git+https://github.com/rust-lang-nursery/rust-bindgen.git?rev=badb49277dddf1ea5d407075f9deea48897b52df)",
- "libc 0.2.45 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)",
+ "bindgen 0.46.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
+[[package]]
+name = "rustc-demangle"
+version = "0.1.13"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
+[[package]]
+name = "scopeguard"
+version = "0.3.3"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
 [[package]]
 name = "strsim"
 version = "0.7.0"
@@ -267,8 +307,8 @@ name = "termion"
 version = "1.5.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "libc 0.2.45 (registry+https://github.com/rust-lang/crates.io-index)",
- "redox_syscall 0.1.44 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "redox_syscall 0.1.50 (registry+https://github.com/rust-lang/crates.io-index)",
  "redox_termios 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
@@ -320,10 +360,11 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "which"
-version = "1.0.5"
+version = "2.0.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "libc 0.2.45 (registry+https://github.com/rust-lang/crates.io-index)",
+ "failure 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -366,32 +407,38 @@ dependencies = [
 "checksum aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)" = "1e9a933f4e58658d7b12defcf96dc5c720f20832deebe3e0a19efd3b6aaeeb9e"
 "checksum ansi_term 0.11.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ee49baf6cb617b853aa8d93bf420db2383fab46d314482ca2803b40d5fde979b"
 "checksum atty 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)" = "9a7d5b8723950951411ee34d271d99dddcc2035a16ab25310ea2c8cfd4369652"
-"checksum bindgen 0.42.2 (git+https://github.com/rust-lang-nursery/rust-bindgen.git?rev=badb49277dddf1ea5d407075f9deea48897b52df)" = "<none>"
+"checksum autocfg 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "4e5f34df7a019573fb8bdc7e24a2bfebe51a2a1d6bfdbaeccedb3c41fc574727"
+"checksum backtrace 0.3.13 (registry+https://github.com/rust-lang/crates.io-index)" = "b5b493b66e03090ebc4343eb02f94ff944e0cbc9ac6571491d170ba026741eb5"
+"checksum backtrace-sys 0.1.28 (registry+https://github.com/rust-lang/crates.io-index)" = "797c830ac25ccc92a7f8a7b9862bde440715531514594a6154e3d4a54dd769b6"
+"checksum bindgen 0.46.0 (registry+https://github.com/rust-lang/crates.io-index)" = "8f7f7f0701772b17de73e4f5cbcb1dd6926f4706cba4c1ab62c5367f8bdc94e1"
 "checksum bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "228047a76f468627ca71776ecdebd732a3423081fcf5125585bcd7c49886ce12"
+"checksum byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)" = "94f88df23a25417badc922ab0f5716cc1330e87f71ddd9203b3a3ccd9cedf75d"
 "checksum cc 1.0.28 (registry+https://github.com/rust-lang/crates.io-index)" = "bb4a8b715cb4597106ea87c7c84b2f1d452c7492033765df7f32651e66fcf749"
-"checksum cexpr 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "8fc0086be9ca82f7fc89fc873435531cb898b86e850005850de1f820e2db6e9b"
+"checksum cexpr 0.3.4 (registry+https://github.com/rust-lang/crates.io-index)" = "644d693ecfa91955ed32dcc7eda4914e1be97a641fb6f0645a37348e20b230da"
 "checksum cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)" = "082bb9b28e00d3c9d39cc03e64ce4cea0f1bb9b3fde493f0cbc008472d22bdf4"
-"checksum clang-sys 0.26.3 (registry+https://github.com/rust-lang/crates.io-index)" = "b5ca71038e58142b85c1b4f06a61f3b7a6e3ca035330a249f80164d37ea44de0"
+"checksum clang-sys 0.26.4 (registry+https://github.com/rust-lang/crates.io-index)" = "6ef0c1bcf2e99c649104bd7a7012d8f8802684400e03db0ec0af48583c6fa0e4"
 "checksum clap 2.32.0 (registry+https://github.com/rust-lang/crates.io-index)" = "b957d88f4b6a63b9d70d5f454ac8011819c6efa7727858f458ab71c756ce2d3e"
-"checksum env_logger 0.5.13 (registry+https://github.com/rust-lang/crates.io-index)" = "15b0a4d2e39f8420210be8b27eeda28029729e2fd4291019455016c348240c38"
+"checksum env_logger 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)" = "afb070faf94c85d17d50ca44f6ad076bce18ae92f0037d350947240a36e9d42e"
+"checksum failure 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)" = "795bd83d3abeb9220f257e597aa0080a508b27533824adf336529648f6abf7e2"
 "checksum glob 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)" = "8be18de09a56b60ed0edf84bc9df007e30040691af7acd1c41874faac5895bfb"
+"checksum hashbrown 0.1.8 (registry+https://github.com/rust-lang/crates.io-index)" = "3bae29b6653b3412c2e71e9d486db9f9df5d701941d86683005efb9f2d28e3da"
 "checksum humantime 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3ca7e5f2e110db35f93b837c81797f3714500b81d517bf20c431b16d3ca4f114"
 "checksum lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "a374c89b9db55895453a74c1e38861d9deec0b01b405a82516e9d5de4820dea1"
-"checksum libc 0.2.45 (registry+https://github.com/rust-lang/crates.io-index)" = "2d2857ec59fadc0773853c664d2d18e7198e83883e7060b63c924cb077bd5c74"
+"checksum libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)" = "48450664a984b25d5b479554c29cc04e3150c97aa4c01da5604a2d4ed9151476"
 "checksum libloading 0.5.0 (registry+https://github.com/rust-lang/crates.io-index)" = "9c3ad660d7cb8c5822cd83d10897b0f1f1526792737a179e73896152f85b88c2"
 "checksum log 0.4.6 (registry+https://github.com/rust-lang/crates.io-index)" = "c84ec4b527950aa83a329754b01dbe3f58361d1c5efacd1f6d68c494d08a17c6"
 "checksum memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "db4c41318937f6e76648f42826b1d9ade5c09cafb5aef7e351240a70f39206e9"
 "checksum nom 4.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "9c349f68f25f596b9f44cf0e7c69752a5c633b0550c3ff849518bfba0233774a"
 "checksum peeking_take_while 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "19b17cddbe7ec3f8bc800887bab5e717348c95ea2ca0b1bf0837fb964dc67099"
-"checksum proc-macro2 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)" = "77997c53ae6edd6d187fec07ec41b207063b5ee6f33680e9fa86d405cdd313d4"
+"checksum proc-macro2 0.4.24 (registry+https://github.com/rust-lang/crates.io-index)" = "77619697826f31a02ae974457af0b29b723e5619e113e9397b8b82c6bd253f09"
 "checksum quick-error 1.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "9274b940887ce9addde99c4eee6b5c44cc494b182b97e73dc8ffdcb3397fd3f0"
-"checksum quote 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)" = "9949cfe66888ffe1d53e6ec9d9f3b70714083854be20fd5e271b232a017401e8"
-"checksum redox_syscall 0.1.44 (registry+https://github.com/rust-lang/crates.io-index)" = "a84bcd297b87a545980a2d25a0beb72a1f490c31f0a9fde52fca35bfbb1ceb70"
+"checksum quote 0.6.10 (registry+https://github.com/rust-lang/crates.io-index)" = "53fa22a1994bd0f9372d7a816207d8a2677ad0325b073f5c5332760f0fb62b5c"
+"checksum redox_syscall 0.1.50 (registry+https://github.com/rust-lang/crates.io-index)" = "52ee9a534dc1301776eff45b4fa92d2c39b1d8c3d3357e6eb593e0d795506fc2"
 "checksum redox_termios 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "7e891cfe48e9100a70a3b6eb652fef28920c117d366339687bd5576160db0f76"
-"checksum regex 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)" = "9329abc99e39129fcceabd24cf5d85b4671ef7c29c50e972bc5afe32438ec384"
 "checksum regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)" = "37e7cbbd370869ce2e8dff25c7018702d10b21a20ef7135316f8daecd6c25b7f"
-"checksum regex-syntax 0.5.6 (registry+https://github.com/rust-lang/crates.io-index)" = "7d707a4fa2637f2dca2ef9fd02225ec7661fe01a53623c1e6515b6916511f7a7"
 "checksum regex-syntax 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)" = "4e47a2ed29da7a9e1960e1639e7a982e6edc6d49be308a3b02daf511504a16d1"
+"checksum rustc-demangle 0.1.13 (registry+https://github.com/rust-lang/crates.io-index)" = "adacaae16d02b6ec37fdc7acfcddf365978de76d1983d3ee22afc260e1ca9619"
+"checksum scopeguard 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "94258f53601af11e6a49f722422f6e3425c52b06245a5cf9bc09908b174f5e27"
 "checksum strsim 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)" = "bb4f380125926a99e52bc279241539c018323fab05ad6368b56f93d9369ff550"
 "checksum termcolor 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "4096add70612622289f2fdcdbd5086dc81c1e2675e6ae58d6c4f62a16c6d7f2f"
 "checksum termion 1.5.1 (registry+https://github.com/rust-lang/crates.io-index)" = "689a3bdfaab439fd92bc87df5c4c78417d3cbe537487274e9b0b2dce76e92096"
@@ -403,7 +450,7 @@ dependencies = [
 "checksum utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)" = "796f7e48bef87609f7ade7e06495a87d5cd06c7866e6a5cbfceffc558a243737"
 "checksum vec_map 0.8.1 (registry+https://github.com/rust-lang/crates.io-index)" = "05c78687fb1a80548ae3250346c3db86a80a7cdd77bda190189f2d0a0987c81a"
 "checksum version_check 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)" = "914b1a6776c4c929a602fafd8bc742e06365d4bcbe48c30f9cca5824f70dc9dd"
-"checksum which 1.0.5 (registry+https://github.com/rust-lang/crates.io-index)" = "e84a603e7e0b1ce1aa1ee2b109c7be00155ce52df5081590d1ffb93f4f515cb2"
+"checksum which 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)" = "b57acb10231b9493c8472b20cb57317d0679a49e0bdbee44b3b803a6473af164"
 "checksum winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "92c1eb33641e276cfa214a0522acad57be5c56b10cb348b3c5117db75f3ac4b0"
 "checksum winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ac3b87c63620426dd9b991e5ce0329eff545bccbbb34f3be09ff6fb6ab51b7b6"
 "checksum winapi-util 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "afc5508759c5bf4285e61feb862b6083c8480aec864fa17a81fdec6f69b461ab"
diff --git a/rust_src/remacs-bindings/Cargo.toml b/rust_src/remacs-bindings/Cargo.toml
index 78ce186bac..d53ca6663e 100644
--- a/rust_src/remacs-bindings/Cargo.toml
+++ b/rust_src/remacs-bindings/Cargo.toml
@@ -6,5 +6,5 @@ edition = "2018"
 
 [dependencies]
 libc = "0.2"
-regex = "0.2"
-bindgen = { git = "https://github.com/rust-lang-nursery/rust-bindgen.git", rev = "badb49277dddf1ea5d407075f9deea48897b52df" }
+regex = "1.1"
+bindgen = "0.46"
diff --git a/rust_src/remacs-lib/Cargo.lock b/rust_src/remacs-lib/Cargo.lock
index ec4894b3c8..f5da502d7d 100644
--- a/rust_src/remacs-lib/Cargo.lock
+++ b/rust_src/remacs-lib/Cargo.lock
@@ -1,9 +1,9 @@
 [[package]]
 name = "aho-corasick"
-version = "0.6.4"
+version = "0.6.9"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -11,44 +11,58 @@ name = "bitflags"
 version = "1.0.4"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
+[[package]]
+name = "cfg-if"
+version = "0.1.6"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
 [[package]]
 name = "darling"
-version = "0.2.0"
+version = "0.2.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "darling_core 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "darling_macro 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "darling_core 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "darling_macro 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "darling_core"
-version = "0.2.0"
+version = "0.2.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "lazy_static 0.2.10 (registry+https://github.com/rust-lang/crates.io-index)",
+ "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
  "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "darling_macro"
-version = "0.2.0"
+version = "0.2.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "darling_core 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "darling_core 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
  "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
  "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "errno"
-version = "0.2.3"
+version = "0.2.4"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.21 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)",
+ "errno-dragonfly 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "errno-dragonfly"
+version = "0.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "gcc 0.3.55 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -66,40 +80,33 @@ version = "0.3.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
-name = "ident_case"
-version = "1.0.0"
+name = "gcc"
+version = "0.3.55"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
-name = "kernel32-sys"
-version = "0.2.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi-build 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "lazy_static"
-version = "0.2.10"
+name = "ident_case"
+version = "1.0.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "lazy_static"
-version = "1.0.0"
+version = "1.2.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "libc"
-version = "0.2.21"
+version = "0.2.47"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "memchr"
-version = "2.0.1"
+version = "2.1.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "libc 0.2.21 (registry+https://github.com/rust-lang/crates.io-index)",
+ "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "version_check 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -109,59 +116,76 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "rand"
-version = "0.4.3"
+version = "0.4.5"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.21 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rdrand 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_core"
+version = "0.3.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
+[[package]]
+name = "rdrand"
+version = "0.4.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "redox_syscall"
-version = "0.1.32"
+version = "0.1.50"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "regex"
-version = "0.2.5"
+version = "1.1.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "aho-corasick 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex-syntax 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "thread_local 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
- "utf8-ranges 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)",
+ "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "regex-syntax 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+ "utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "regex-syntax"
-version = "0.4.2"
+version = "0.6.4"
 source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "ucd-util 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
+]
 
 [[package]]
 name = "remacs-lib"
 version = "0.1.0"
 dependencies = [
- "darling 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "errno 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "lazy_static 0.2.10 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.21 (registry+https://github.com/rust-lang/crates.io-index)",
- "rand 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex 0.2.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand 0.4.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "remacs-util 0.1.0",
  "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
- "time 0.1.38 (registry+https://github.com/rust-lang/crates.io-index)",
+ "time 0.1.42 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "remacs-util"
 version = "0.1.0"
 dependencies = [
- "darling 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "errno 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.21 (registry+https://github.com/rust-lang/crates.io-index)",
- "rand 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
  "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
@@ -185,66 +209,51 @@ dependencies = [
 
 [[package]]
 name = "thread_local"
-version = "0.3.5"
+version = "0.3.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "lazy_static 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "unreachable 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "time"
-version = "0.1.38"
+version = "0.1.42"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.21 (registry+https://github.com/rust-lang/crates.io-index)",
- "redox_syscall 0.1.32 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "redox_syscall 0.1.50 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "unicode-xid"
-version = "0.0.4"
+name = "ucd-util"
+version = "0.1.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
-name = "unreachable"
-version = "1.0.0"
+name = "unicode-xid"
+version = "0.0.4"
 source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "void 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
-]
 
 [[package]]
 name = "utf8-ranges"
-version = "1.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "void"
 version = "1.0.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
-name = "winapi"
-version = "0.2.8"
+name = "version_check"
+version = "0.1.5"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "winapi"
-version = "0.3.5"
+version = "0.3.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
-[[package]]
-name = "winapi-build"
-version = "0.1.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
 [[package]]
 name = "winapi-i686-pc-windows-gnu"
 version = "0.4.0"
@@ -256,35 +265,36 @@ version = "0.4.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [metadata]
-"checksum aho-corasick 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)" = "d6531d44de723825aa81398a6415283229725a00fa30713812ab9323faa82fc4"
+"checksum aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)" = "1e9a933f4e58658d7b12defcf96dc5c720f20832deebe3e0a19efd3b6aaeeb9e"
 "checksum bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "228047a76f468627ca71776ecdebd732a3423081fcf5125585bcd7c49886ce12"
-"checksum darling 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "9861a8495606435477df581bc858ccf15a3469747edf175b94a4704fd9aaedac"
-"checksum darling_core 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "1486a8b00b45062c997f767738178b43219133dd0c8c826cb811e60563810821"
-"checksum darling_macro 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "8a86ec160aa0c3dd492dd4a14ec8104ad8f1a9400a820624db857998cc1f80f9"
-"checksum errno 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)" = "b2c858c42ac0b88532f48fca88b0ed947cad4f1f64d904bcd6c9f138f7b95d70"
+"checksum cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)" = "082bb9b28e00d3c9d39cc03e64ce4cea0f1bb9b3fde493f0cbc008472d22bdf4"
+"checksum darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "1630fdbe3554154a50624487c79b0140a424e87dc08061db1a2211359792acab"
+"checksum darling_core 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "d12d2eeb837786ace70b6bca9adfeaef4352cc68d6a42e8e3d0c4159bbca7ab2"
+"checksum darling_macro 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "01581bdeabb86f69970dbd9e6ee3c61963f9a7321169589e3dffa16033c0928c"
+"checksum errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)" = "c2a071601ed01b988f896ab14b95e67335d1eeb50190932a1320f7fe3cadc84e"
+"checksum errno-dragonfly 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "14ca354e36190500e1e1fb267c647932382b54053c50b14970856c0b00a35067"
 "checksum fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "2e9763c69ebaae630ba35f74888db465e49e259ba1bc0eda7d06f4a067615d82"
 "checksum fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "3dcaa9ae7725d12cdb85b3ad99a434db70b468c09ded17e012d86b5c1010f7a7"
+"checksum gcc 0.3.55 (registry+https://github.com/rust-lang/crates.io-index)" = "8f5f3913fa0bfe7ee1fd8248b6b9f42a5af4b9d65ec2dd2c3c26132b950ecfc2"
 "checksum ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3c9826188e666f2ed92071d2dadef6edc430b11b158b5b2b3f4babbcc891eaaa"
-"checksum kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "7507624b29483431c0ba2d82aece8ca6cdba9382bff4ddd0f7490560c056098d"
-"checksum lazy_static 0.2.10 (registry+https://github.com/rust-lang/crates.io-index)" = "236eb37a62591d4a41a89b7763d7de3e06ca02d5ab2815446a8bae5d2f8c2d57"
-"checksum lazy_static 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "c8f31047daa365f19be14b47c29df4f7c3b581832407daabe6ae77397619237d"
-"checksum libc 0.2.21 (registry+https://github.com/rust-lang/crates.io-index)" = "88ee81885f9f04bff991e306fea7c1c60a5f0f9e409e99f6b40e3311a3363135"
-"checksum memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)" = "796fba70e76612589ed2ce7f45282f5af869e0fdd7cc6199fa1aa1f1d591ba9d"
+"checksum lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "a374c89b9db55895453a74c1e38861d9deec0b01b405a82516e9d5de4820dea1"
+"checksum libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)" = "48450664a984b25d5b479554c29cc04e3150c97aa4c01da5604a2d4ed9151476"
+"checksum memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "db4c41318937f6e76648f42826b1d9ade5c09cafb5aef7e351240a70f39206e9"
 "checksum quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)" = "7a6e920b65c65f10b2ae65c831a81a073a89edd28c7cce89475bff467ab4167a"
-"checksum rand 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)" = "8356f47b32624fef5b3301c1be97e5944ecdd595409cc5da11d05f211db6cfbd"
-"checksum redox_syscall 0.1.32 (registry+https://github.com/rust-lang/crates.io-index)" = "ab105df655884ede59d45b7070c8a65002d921461ee813a024558ca16030eea0"
-"checksum regex 0.2.5 (registry+https://github.com/rust-lang/crates.io-index)" = "744554e01ccbd98fff8c457c3b092cd67af62a555a43bfe97ae8a0451f7799fa"
-"checksum regex-syntax 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)" = "8e931c58b93d86f080c734bfd2bce7dd0079ae2331235818133c8be7f422e20e"
+"checksum rand 0.4.5 (registry+https://github.com/rust-lang/crates.io-index)" = "dee497e66d8d76bf08ce20c8d36e16f93749ab0bf89975b4f8ae5cee660c2da2"
+"checksum rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)" = "0905b6b7079ec73b314d4c748701f6931eb79fd97c668caa3f1899b22b32c6db"
+"checksum rdrand 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "678054eb77286b51581ba43620cc911abf02758c91f93f479767aed0f90458b2"
+"checksum redox_syscall 0.1.50 (registry+https://github.com/rust-lang/crates.io-index)" = "52ee9a534dc1301776eff45b4fa92d2c39b1d8c3d3357e6eb593e0d795506fc2"
+"checksum regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)" = "37e7cbbd370869ce2e8dff25c7018702d10b21a20ef7135316f8daecd6c25b7f"
+"checksum regex-syntax 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)" = "4e47a2ed29da7a9e1960e1639e7a982e6edc6d49be308a3b02daf511504a16d1"
 "checksum syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)" = "d3b891b9015c88c576343b9b3e41c2c11a51c219ef067b264bd9c8aa9b441dad"
 "checksum synom 0.11.3 (registry+https://github.com/rust-lang/crates.io-index)" = "a393066ed9010ebaed60b9eafa373d4b1baac186dd7e008555b0f702b51945b6"
-"checksum thread_local 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)" = "279ef31c19ededf577bfd12dfae728040a21f635b06a24cd670ff510edd38963"
-"checksum time 0.1.38 (registry+https://github.com/rust-lang/crates.io-index)" = "d5d788d3aa77bc0ef3e9621256885555368b47bd495c13dd2e7413c89f845520"
+"checksum thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "c6b53e329000edc2b34dbe8545fd20e55a333362d0a321909685a19bd28c3f1b"
+"checksum time 0.1.42 (registry+https://github.com/rust-lang/crates.io-index)" = "db8dcfca086c1143c9270ac42a2bbd8a7ee477b78ac8e45b19abfb0cbede4b6f"
+"checksum ucd-util 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "535c204ee4d8434478593480b8f86ab45ec9aae0e83c568ca81abf0fd0e88f86"
 "checksum unicode-xid 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "8c1f860d7d29cf02cb2f3f359fd35991af3d30bac52c57d265a3c461074cb4dc"
-"checksum unreachable 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "382810877fe448991dfc7f0dd6e3ae5d58088fd0ea5e35189655f84e6814fa56"
-"checksum utf8-ranges 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "662fab6525a98beff2921d7f61a39e7d59e0b425ebc7d0d9e66d316e55124122"
-"checksum void 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)" = "6a02e4885ed3bc0f2de90ea6dd45ebcbb66dacffe03547fadbb0eeae2770887d"
-"checksum winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)" = "167dc9d6949a9b857f3451275e911c3f44255842c1f7a76f33c55103a909087a"
-"checksum winapi 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)" = "773ef9dcc5f24b7d850d0ff101e542ff24c3b090a9768e03ff889fdef41f00fd"
-"checksum winapi-build 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "2d315eee3b34aca4797b2da6b13ed88266e6d612562a0c46390af8299fc699bc"
+"checksum utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)" = "796f7e48bef87609f7ade7e06495a87d5cd06c7866e6a5cbfceffc558a243737"
+"checksum version_check 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)" = "914b1a6776c4c929a602fafd8bc742e06365d4bcbe48c30f9cca5824f70dc9dd"
+"checksum winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "92c1eb33641e276cfa214a0522acad57be5c56b10cb348b3c5117db75f3ac4b0"
 "checksum winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ac3b87c63620426dd9b991e5ce0329eff545bccbbb34f3be09ff6fb6ab51b7b6"
 "checksum winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "712e227841d057c1ee1cd2fb22fa7e5a5461ae8e48fa2ca79ec42cfc1931183f"
diff --git a/rust_src/remacs-lib/Cargo.toml b/rust_src/remacs-lib/Cargo.toml
index 7a3eec70b9..211d72d617 100644
--- a/rust_src/remacs-lib/Cargo.toml
+++ b/rust_src/remacs-lib/Cargo.toml
@@ -6,12 +6,12 @@ edition = "2018"
 [dependencies]
 remacs-util = { version = "0.1.0", path = "../remacs-util" }
 darling = "0.2"
-errno = "0.2.3"
-lazy_static = "0.2.2"
+errno = "0.2"
+lazy_static = "1.2"
 libc = "0.2"
-rand = "0.4.3"
-regex = "0.2"
-syn = { version = "0.11.11", features = ["full"] }
+rand = "0.4"
+regex = "1.1"
+syn = { version = "0.11", features = ["full"] }
 time = "0.1"
 
 [lib]
diff --git a/rust_src/remacs-lib/docfile.rs b/rust_src/remacs-lib/docfile.rs
index 3b138d5e02..0fc53ffdd7 100644
--- a/rust_src/remacs-lib/docfile.rs
+++ b/rust_src/remacs-lib/docfile.rs
@@ -59,7 +59,7 @@ pub unsafe extern "C" fn scan_rust_file(
             }
             in_docstring = true;
             if line.starts_with("/// usage: (") {
-                docstring = format!("{}\n", docstring.trim_right());
+                docstring = format!("{}\n", docstring.trim_end());
                 let begin = &line[11..];
                 // Now find the first space after the function name. If there is a space
                 // capture the rest of the usage text.
@@ -69,7 +69,7 @@ pub unsafe extern "C" fn scan_rust_file(
                     docstring_usage.push_str(&line[pos..]);
                 }
             } else {
-                docstring.push_str(line[3..].trim_left());
+                docstring.push_str(line[3..].trim_start());
                 docstring.push('\n');
             }
         } else {
@@ -146,7 +146,7 @@ pub unsafe extern "C" fn scan_rust_file(
                         }
                         let argname = chunk[0]
                             .trim()
-                            .trim_left_matches("mut ")
+                            .trim_start_matches("mut ")
                             .trim()
                             .to_uppercase()
                             .replace("_", "-");
diff --git a/rust_src/remacs-macros/Cargo.lock b/rust_src/remacs-macros/Cargo.lock
deleted file mode 100644
index a363329d62..0000000000
--- a/rust_src/remacs-macros/Cargo.lock
+++ /dev/null
@@ -1,303 +0,0 @@
-[[package]]
-name = "aho-corasick"
-version = "0.6.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "bitflags"
-version = "1.0.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "darling"
-version = "0.2.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "darling_core 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "darling_macro 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "darling_core"
-version = "0.2.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "lazy_static 0.2.10 (registry+https://github.com/rust-lang/crates.io-index)",
- "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
- "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "darling_macro"
-version = "0.2.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "darling_core 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
- "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "errno"
-version = "0.2.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.33 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "fuchsia-zircon"
-version = "0.3.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "fuchsia-zircon-sys"
-version = "0.3.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "ident_case"
-version = "1.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "kernel32-sys"
-version = "0.2.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi-build 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "lazy_static"
-version = "0.2.10"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "lazy_static"
-version = "1.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "libc"
-version = "0.2.33"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "memchr"
-version = "2.0.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "libc 0.2.33 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "proc-macro2"
-version = "0.3.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "unicode-xid 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "quote"
-version = "0.3.15"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "quote"
-version = "0.5.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "proc-macro2 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "rand"
-version = "0.4.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.33 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "regex"
-version = "0.2.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "aho-corasick 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex-syntax 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "thread_local 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
- "utf8-ranges 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "regex-syntax"
-version = "0.4.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "remacs-macros"
-version = "0.1.0"
-dependencies = [
- "lazy_static 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "quote 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex 0.2.5 (registry+https://github.com/rust-lang/crates.io-index)",
- "remacs-util 0.1.0",
- "syn 0.13.11 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "remacs-util"
-version = "0.1.0"
-dependencies = [
- "darling 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "errno 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.33 (registry+https://github.com/rust-lang/crates.io-index)",
- "rand 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "syn"
-version = "0.11.11"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
- "synom 0.11.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "unicode-xid 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "syn"
-version = "0.13.11"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "proc-macro2 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)",
- "quote 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "unicode-xid 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "synom"
-version = "0.11.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "unicode-xid 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "thread_local"
-version = "0.3.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "lazy_static 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "unreachable 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "unicode-xid"
-version = "0.0.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "unicode-xid"
-version = "0.1.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "unreachable"
-version = "1.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "void 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "utf8-ranges"
-version = "1.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "void"
-version = "1.0.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "winapi"
-version = "0.2.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "winapi"
-version = "0.3.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "winapi-build"
-version = "0.1.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "winapi-i686-pc-windows-gnu"
-version = "0.4.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "winapi-x86_64-pc-windows-gnu"
-version = "0.4.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[metadata]
-"checksum aho-corasick 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)" = "d6531d44de723825aa81398a6415283229725a00fa30713812ab9323faa82fc4"
-"checksum bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "228047a76f468627ca71776ecdebd732a3423081fcf5125585bcd7c49886ce12"
-"checksum darling 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "9861a8495606435477df581bc858ccf15a3469747edf175b94a4704fd9aaedac"
-"checksum darling_core 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "1486a8b00b45062c997f767738178b43219133dd0c8c826cb811e60563810821"
-"checksum darling_macro 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "8a86ec160aa0c3dd492dd4a14ec8104ad8f1a9400a820624db857998cc1f80f9"
-"checksum errno 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)" = "b2c858c42ac0b88532f48fca88b0ed947cad4f1f64d904bcd6c9f138f7b95d70"
-"checksum fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "2e9763c69ebaae630ba35f74888db465e49e259ba1bc0eda7d06f4a067615d82"
-"checksum fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "3dcaa9ae7725d12cdb85b3ad99a434db70b468c09ded17e012d86b5c1010f7a7"
-"checksum ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3c9826188e666f2ed92071d2dadef6edc430b11b158b5b2b3f4babbcc891eaaa"
-"checksum kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "7507624b29483431c0ba2d82aece8ca6cdba9382bff4ddd0f7490560c056098d"
-"checksum lazy_static 0.2.10 (registry+https://github.com/rust-lang/crates.io-index)" = "236eb37a62591d4a41a89b7763d7de3e06ca02d5ab2815446a8bae5d2f8c2d57"
-"checksum lazy_static 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "c8f31047daa365f19be14b47c29df4f7c3b581832407daabe6ae77397619237d"
-"checksum libc 0.2.33 (registry+https://github.com/rust-lang/crates.io-index)" = "5ba3df4dcb460b9dfbd070d41c94c19209620c191b0340b929ce748a2bcd42d2"
-"checksum memchr 2.0.1 (registry+https://github.com/rust-lang/crates.io-index)" = "796fba70e76612589ed2ce7f45282f5af869e0fdd7cc6199fa1aa1f1d591ba9d"
-"checksum proc-macro2 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)" = "1b06e2f335f48d24442b35a19df506a835fb3547bc3c06ef27340da9acf5cae7"
-"checksum quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)" = "7a6e920b65c65f10b2ae65c831a81a073a89edd28c7cce89475bff467ab4167a"
-"checksum quote 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)" = "9949cfe66888ffe1d53e6ec9d9f3b70714083854be20fd5e271b232a017401e8"
-"checksum rand 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)" = "8356f47b32624fef5b3301c1be97e5944ecdd595409cc5da11d05f211db6cfbd"
-"checksum regex 0.2.5 (registry+https://github.com/rust-lang/crates.io-index)" = "744554e01ccbd98fff8c457c3b092cd67af62a555a43bfe97ae8a0451f7799fa"
-"checksum regex-syntax 0.4.2 (registry+https://github.com/rust-lang/crates.io-index)" = "8e931c58b93d86f080c734bfd2bce7dd0079ae2331235818133c8be7f422e20e"
-"checksum syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)" = "d3b891b9015c88c576343b9b3e41c2c11a51c219ef067b264bd9c8aa9b441dad"
-"checksum syn 0.13.11 (registry+https://github.com/rust-lang/crates.io-index)" = "14f9bf6292f3a61d2c716723fdb789a41bbe104168e6f496dc6497e531ea1b9b"
-"checksum synom 0.11.3 (registry+https://github.com/rust-lang/crates.io-index)" = "a393066ed9010ebaed60b9eafa373d4b1baac186dd7e008555b0f702b51945b6"
-"checksum thread_local 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)" = "279ef31c19ededf577bfd12dfae728040a21f635b06a24cd670ff510edd38963"
-"checksum unicode-xid 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "8c1f860d7d29cf02cb2f3f359fd35991af3d30bac52c57d265a3c461074cb4dc"
-"checksum unicode-xid 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)" = "fc72304796d0818e357ead4e000d19c9c174ab23dc11093ac919054d20a6a7fc"
-"checksum unreachable 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "382810877fe448991dfc7f0dd6e3ae5d58088fd0ea5e35189655f84e6814fa56"
-"checksum utf8-ranges 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "662fab6525a98beff2921d7f61a39e7d59e0b425ebc7d0d9e66d316e55124122"
-"checksum void 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)" = "6a02e4885ed3bc0f2de90ea6dd45ebcbb66dacffe03547fadbb0eeae2770887d"
-"checksum winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)" = "167dc9d6949a9b857f3451275e911c3f44255842c1f7a76f33c55103a909087a"
-"checksum winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "92c1eb33641e276cfa214a0522acad57be5c56b10cb348b3c5117db75f3ac4b0"
-"checksum winapi-build 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "2d315eee3b34aca4797b2da6b13ed88266e6d612562a0c46390af8299fc699bc"
-"checksum winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ac3b87c63620426dd9b991e5ce0329eff545bccbbb34f3be09ff6fb6ab51b7b6"
-"checksum winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "712e227841d057c1ee1cd2fb22fa7e5a5461ae8e48fa2ca79ec42cfc1931183f"
diff --git a/rust_src/remacs-macros/lib.rs b/rust_src/remacs-macros/lib.rs
index f260afeb43..40cc0fa28c 100644
--- a/rust_src/remacs-macros/lib.rs
+++ b/rust_src/remacs-macros/lib.rs
@@ -1,5 +1,4 @@
 #![recursion_limit = "128"]
-#![feature(extern_crate_item_prelude)]
 
 #[macro_use]
 extern crate lazy_static;
@@ -34,9 +33,9 @@ pub fn lisp_fn(attr_ts: TokenStream, fn_ts: TokenStream) -> TokenStream {
     let max_args = function.args.len() as i16;
     let intspec = if let Some(intspec) = lisp_fn_args.intspec {
         let cbyte_intspec = CByteLiteral(intspec.as_str());
-        quote!{ (#cbyte_intspec).as_ptr() as *const libc::c_char }
+        quote! { (#cbyte_intspec).as_ptr() as *const libc::c_char }
     } else {
-        quote!{ std::ptr::null() }
+        quote! { std::ptr::null() }
     };
 
     match function.fntype {
@@ -74,7 +73,7 @@ pub fn lisp_fn(attr_ts: TokenStream, fn_ts: TokenStream) -> TokenStream {
     let fname = concat_idents("F", &cname);
     let rname = function.name;
     let min_args = lisp_fn_args.min;
-    let mut windows_header = quote!{};
+    let mut windows_header = quote! {};
 
     let functype = if lisp_fn_args.unevalled {
         quote! { aUNEVALLED }
@@ -107,7 +106,7 @@ pub fn lisp_fn(attr_ts: TokenStream, fn_ts: TokenStream) -> TokenStream {
     let symbol_name = CByteLiteral(&lisp_fn_args.name);
 
     if cfg!(windows) {
-        windows_header = quote!{
+        windows_header = quote! {
             | (std::mem::size_of::<crate::remacs_sys::Lisp_Subr>()
                / std::mem::size_of::<crate::remacs_sys::EmacsInt>()) as libc::ptrdiff_t
         };
diff --git a/rust_src/remacs-util/Cargo.lock b/rust_src/remacs-util/Cargo.lock
index 196e0c09a5..c59bbc9b70 100644
--- a/rust_src/remacs-util/Cargo.lock
+++ b/rust_src/remacs-util/Cargo.lock
@@ -1,60 +1,55 @@
-[[package]]
-name = "bitflags"
-version = "1.0.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
 [[package]]
 name = "darling"
-version = "0.2.0"
+version = "0.2.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "darling_core 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "darling_macro 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "darling_core 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "darling_macro 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "darling_core"
-version = "0.2.0"
+version = "0.2.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "lazy_static 0.2.10 (registry+https://github.com/rust-lang/crates.io-index)",
+ "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
  "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "darling_macro"
-version = "0.2.0"
+version = "0.2.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "darling_core 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "darling_core 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
  "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
  "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "errno"
-version = "0.2.3"
+version = "0.2.4"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.21 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)",
+ "errno-dragonfly 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "fuchsia-zircon"
-version = "0.3.3"
+name = "errno-dragonfly"
+version = "0.1.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "gcc 0.3.55 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "fuchsia-zircon-sys"
-version = "0.3.3"
+name = "gcc"
+version = "0.3.55"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -62,23 +57,14 @@ name = "ident_case"
 version = "1.0.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
-[[package]]
-name = "kernel32-sys"
-version = "0.2.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi-build 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
 [[package]]
 name = "lazy_static"
-version = "0.2.10"
+version = "1.2.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "libc"
-version = "0.2.21"
+version = "0.2.47"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -86,24 +72,13 @@ name = "quote"
 version = "0.3.15"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
-[[package]]
-name = "rand"
-version = "0.4.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.21 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
 [[package]]
 name = "remacs-util"
 version = "0.1.0"
 dependencies = [
- "darling 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "errno 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.21 (registry+https://github.com/rust-lang/crates.io-index)",
- "rand 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
  "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
@@ -132,23 +107,13 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "winapi"
-version = "0.2.8"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "winapi"
-version = "0.3.5"
+version = "0.3.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
-[[package]]
-name = "winapi-build"
-version = "0.1.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
 [[package]]
 name = "winapi-i686-pc-windows-gnu"
 version = "0.4.0"
@@ -160,24 +125,19 @@ version = "0.4.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [metadata]
-"checksum bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "228047a76f468627ca71776ecdebd732a3423081fcf5125585bcd7c49886ce12"
-"checksum darling 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "9861a8495606435477df581bc858ccf15a3469747edf175b94a4704fd9aaedac"
-"checksum darling_core 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "1486a8b00b45062c997f767738178b43219133dd0c8c826cb811e60563810821"
-"checksum darling_macro 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "8a86ec160aa0c3dd492dd4a14ec8104ad8f1a9400a820624db857998cc1f80f9"
-"checksum errno 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)" = "b2c858c42ac0b88532f48fca88b0ed947cad4f1f64d904bcd6c9f138f7b95d70"
-"checksum fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "2e9763c69ebaae630ba35f74888db465e49e259ba1bc0eda7d06f4a067615d82"
-"checksum fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "3dcaa9ae7725d12cdb85b3ad99a434db70b468c09ded17e012d86b5c1010f7a7"
+"checksum darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "1630fdbe3554154a50624487c79b0140a424e87dc08061db1a2211359792acab"
+"checksum darling_core 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "d12d2eeb837786ace70b6bca9adfeaef4352cc68d6a42e8e3d0c4159bbca7ab2"
+"checksum darling_macro 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "01581bdeabb86f69970dbd9e6ee3c61963f9a7321169589e3dffa16033c0928c"
+"checksum errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)" = "c2a071601ed01b988f896ab14b95e67335d1eeb50190932a1320f7fe3cadc84e"
+"checksum errno-dragonfly 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "14ca354e36190500e1e1fb267c647932382b54053c50b14970856c0b00a35067"
+"checksum gcc 0.3.55 (registry+https://github.com/rust-lang/crates.io-index)" = "8f5f3913fa0bfe7ee1fd8248b6b9f42a5af4b9d65ec2dd2c3c26132b950ecfc2"
 "checksum ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3c9826188e666f2ed92071d2dadef6edc430b11b158b5b2b3f4babbcc891eaaa"
-"checksum kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "7507624b29483431c0ba2d82aece8ca6cdba9382bff4ddd0f7490560c056098d"
-"checksum lazy_static 0.2.10 (registry+https://github.com/rust-lang/crates.io-index)" = "236eb37a62591d4a41a89b7763d7de3e06ca02d5ab2815446a8bae5d2f8c2d57"
-"checksum libc 0.2.21 (registry+https://github.com/rust-lang/crates.io-index)" = "88ee81885f9f04bff991e306fea7c1c60a5f0f9e409e99f6b40e3311a3363135"
+"checksum lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "a374c89b9db55895453a74c1e38861d9deec0b01b405a82516e9d5de4820dea1"
+"checksum libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)" = "48450664a984b25d5b479554c29cc04e3150c97aa4c01da5604a2d4ed9151476"
 "checksum quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)" = "7a6e920b65c65f10b2ae65c831a81a073a89edd28c7cce89475bff467ab4167a"
-"checksum rand 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)" = "8356f47b32624fef5b3301c1be97e5944ecdd595409cc5da11d05f211db6cfbd"
 "checksum syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)" = "d3b891b9015c88c576343b9b3e41c2c11a51c219ef067b264bd9c8aa9b441dad"
 "checksum synom 0.11.3 (registry+https://github.com/rust-lang/crates.io-index)" = "a393066ed9010ebaed60b9eafa373d4b1baac186dd7e008555b0f702b51945b6"
 "checksum unicode-xid 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "8c1f860d7d29cf02cb2f3f359fd35991af3d30bac52c57d265a3c461074cb4dc"
-"checksum winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)" = "167dc9d6949a9b857f3451275e911c3f44255842c1f7a76f33c55103a909087a"
-"checksum winapi 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)" = "773ef9dcc5f24b7d850d0ff101e542ff24c3b090a9768e03ff889fdef41f00fd"
-"checksum winapi-build 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "2d315eee3b34aca4797b2da6b13ed88266e6d612562a0c46390af8299fc699bc"
+"checksum winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "92c1eb33641e276cfa214a0522acad57be5c56b10cb348b3c5117db75f3ac4b0"
 "checksum winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ac3b87c63620426dd9b991e5ce0329eff545bccbbb34f3be09ff6fb6ab51b7b6"
 "checksum winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "712e227841d057c1ee1cd2fb22fa7e5a5461ae8e48fa2ca79ec42cfc1931183f"
diff --git a/rust_src/remacs-util/Cargo.toml b/rust_src/remacs-util/Cargo.toml
index 59c86a2ff6..edf1fa00e0 100644
--- a/rust_src/remacs-util/Cargo.toml
+++ b/rust_src/remacs-util/Cargo.toml
@@ -5,9 +5,8 @@ description = "Common utility code linked by other remacs crates."
 edition = "2018"
 
 [dependencies]
-rand = "0.4.3"
 libc = "0.2"
-errno = "0.2.3"
+errno = "0.2"
 darling = "0.2"
 syn = { version = "0.11.11", features = ["full"] }
 
diff --git a/rust_src/remacs-util/lib.rs b/rust_src/remacs-util/lib.rs
index fc8dcf6496..be11138a87 100644
--- a/rust_src/remacs-util/lib.rs
+++ b/rust_src/remacs-util/lib.rs
@@ -1,10 +1,8 @@
 #![cfg_attr(feature = "strict", deny(warnings))]
 
-#[macro_use]
 extern crate darling;
 extern crate errno;
 extern crate libc;
-extern crate rand;
 extern crate syn;
 
 mod attributes;
diff --git a/rust_src/src/alloc.rs b/rust_src/src/alloc.rs
index f997afd0eb..eee336d236 100644
--- a/rust_src/src/alloc.rs
+++ b/rust_src/src/alloc.rs
@@ -3,7 +3,7 @@
 use remacs_macros::lisp_fn;
 
 use crate::{
-    lisp::{defsubr, ExternalPtr, LispObject},
+    lisp::{ExternalPtr, LispObject},
     remacs_sys::globals,
     remacs_sys::Lisp_Type::Lisp_Vectorlike,
     remacs_sys::{
diff --git a/rust_src/src/base64.rs b/rust_src/src/base64.rs
index b89497cbe5..0dc087153a 100644
--- a/rust_src/src/base64.rs
+++ b/rust_src/src/base64.rs
@@ -9,7 +9,6 @@ use remacs_macros::lisp_fn;
 use crate::{
     base64_crate,
     buffers::validate_region,
-    lisp::defsubr,
     lisp::LispObject,
     marker::buf_charpos_to_bytepos,
     multibyte::{multibyte_char_at, raw_byte_from_codepoint, LispStringRef, MAX_5_BYTE_CHAR},
diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 486252dd93..8812cae905 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -18,7 +18,6 @@ use crate::{
     fileio::{expand_file_name, find_file_name_handler},
     frames::LispFrameRef,
     hashtable::LispHashTableRef,
-    lisp::defsubr,
     lisp::{ExternalPtr, LispMiscRef, LispObject, LispStructuralEqual, LiveBufferIter},
     lists::{car, cdr, list, member},
     lists::{LispConsCircularChecks, LispConsEndChecks},
diff --git a/rust_src/src/bytecode.rs b/rust_src/src/bytecode.rs
index 62269fb6f0..2911eb6b0b 100644
--- a/rust_src/src/bytecode.rs
+++ b/rust_src/src/bytecode.rs
@@ -2,11 +2,7 @@
 
 use remacs_macros::lisp_fn;
 
-use crate::{
-    lisp::{defsubr, LispObject},
-    remacs_sys::exec_byte_code as c_exec_byte_code,
-    remacs_sys::Qnil,
-};
+use crate::{lisp::LispObject, remacs_sys::exec_byte_code as c_exec_byte_code, remacs_sys::Qnil};
 
 // Temporary Rust wrapper for C's exec_byte_code
 fn rust_exec_byte_code(
diff --git a/rust_src/src/callint.rs b/rust_src/src/callint.rs
index 9bad84bc9e..0cdd6296c8 100644
--- a/rust_src/src/callint.rs
+++ b/rust_src/src/callint.rs
@@ -2,7 +2,7 @@
 
 use crate::{
     eval::{funcall, unbind_to},
-    lisp::{defsubr, LispObject},
+    lisp::LispObject,
     remacs_macros::lisp_fn,
     remacs_sys::temporarily_switch_to_single_kboard,
     threads::c_specpdl_index,
diff --git a/rust_src/src/callproc.rs b/rust_src/src/callproc.rs
index 5d0ddef635..f6ec37ea9d 100644
--- a/rust_src/src/callproc.rs
+++ b/rust_src/src/callproc.rs
@@ -7,7 +7,7 @@ use crate::{
     coding::encode_file_name,
     eval::{record_unwind_protect_int, unbind_to},
     fileio::expand_file_name,
-    lisp::{defsubr, LispObject},
+    lisp::LispObject,
     remacs_macros::lisp_fn,
     remacs_sys::Fdelete_region,
     remacs_sys::NULL_DEVICE,
diff --git a/rust_src/src/casefiddle.rs b/rust_src/src/casefiddle.rs
index 2926dd59ad..4902845c63 100644
--- a/rust_src/src/casefiddle.rs
+++ b/rust_src/src/casefiddle.rs
@@ -5,7 +5,6 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     keymap::Ctl,
-    lisp::defsubr,
     lisp::LispObject,
     lists::put,
     lists::{LispConsCircularChecks, LispConsEndChecks},
diff --git a/rust_src/src/casetab.rs b/rust_src/src/casetab.rs
index 35463663f8..a629e60e87 100644
--- a/rust_src/src/casetab.rs
+++ b/rust_src/src/casetab.rs
@@ -3,7 +3,7 @@
 use remacs_macros::lisp_fn;
 
 use crate::{
-    lisp::{defsubr, LispObject},
+    lisp::LispObject,
     objects::eq,
     remacs_sys::{set_case_table, Qcase_table, Vascii_downcase_table},
     threads::ThreadState,
diff --git a/rust_src/src/category.rs b/rust_src/src/category.rs
index 2aa7e940f4..b8f59dee94 100644
--- a/rust_src/src/category.rs
+++ b/rust_src/src/category.rs
@@ -1,9 +1,7 @@
 //! Routines to deal with category tables.
 
 use crate::{
-    chartable::LispCharTableRef,
-    lisp::{defsubr, LispObject},
-    remacs_sys::Qcategory_table,
+    chartable::LispCharTableRef, lisp::LispObject, remacs_sys::Qcategory_table,
     threads::ThreadState,
 };
 
diff --git a/rust_src/src/character.rs b/rust_src/src/character.rs
index 3509538038..cd47587f62 100644
--- a/rust_src/src/character.rs
+++ b/rust_src/src/character.rs
@@ -5,7 +5,6 @@ use libc::{c_uchar, ptrdiff_t};
 use remacs_macros::lisp_fn;
 
 use crate::{
-    lisp::defsubr,
     lisp::LispObject,
     multibyte::{make_char_multibyte, raw_byte_from_codepoint_safe},
     multibyte::{Codepoint, MAX_CHAR},
diff --git a/rust_src/src/charset.rs b/rust_src/src/charset.rs
index 710d575503..6771ba3a39 100644
--- a/rust_src/src/charset.rs
+++ b/rust_src/src/charset.rs
@@ -4,7 +4,7 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     hashtable::{HashLookupResult, LispHashTableRef},
-    lisp::{defsubr, LispObject},
+    lisp::LispObject,
     remacs_sys::Vcharset_hash_table,
 };
 
diff --git a/rust_src/src/chartable.rs b/rust_src/src/chartable.rs
index 85df4a9914..514eb4b72a 100644
--- a/rust_src/src/chartable.rs
+++ b/rust_src/src/chartable.rs
@@ -6,7 +6,6 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     hashtable::LispHashTableRef,
-    lisp::defsubr,
     lisp::{ExternalPtr, LispObject, LispStructuralEqual},
     remacs_sys::uniprop_table_uncompress,
     remacs_sys::{
diff --git a/rust_src/src/cmds.rs b/rust_src/src/cmds.rs
index eea475b932..921eb990dd 100644
--- a/rust_src/src/cmds.rs
+++ b/rust_src/src/cmds.rs
@@ -13,7 +13,6 @@ use crate::{
     editfns::{line_beginning_position, line_end_position, preceding_char},
     frames::selected_frame,
     keymap::{current_global_map, Ctl},
-    lisp::defsubr,
     lisp::LispObject,
     lists::get,
     multibyte::{
@@ -520,7 +519,7 @@ pub extern "C" fn keys_of_cmds() {
 pub extern "C" fn syms_of_cmds() {
     def_lisp_sym!(Qinternal_auto_fill, "internal-auto-fill");
     def_lisp_sym!(Qundo_auto_amalgamate, "undo-auto-amalgamate");
-    #[cfg_attr(rustfmt, rustfmt_skip)]
+    #[rustfmt::skip]
     def_lisp_sym!(Qundo_auto__this_command_amalgamating, "undo-auto--this-command-amalgamating");
     def_lisp_sym!(Qkill_forward_chars, "kill-forward-chars");
     // A possible value for a buffer's overwrite-mode variable.
diff --git a/rust_src/src/coding.rs b/rust_src/src/coding.rs
index 2f36469a27..438b54b1e1 100644
--- a/rust_src/src/coding.rs
+++ b/rust_src/src/coding.rs
@@ -9,7 +9,6 @@ use crate::{
         HashLookupResult::{Found, Missing},
         LispHashTableRef,
     },
-    lisp::defsubr,
     lisp::LispObject,
     lists::{get, put},
     multibyte::LispStringRef,
diff --git a/rust_src/src/crypto/mod.rs b/rust_src/src/crypto/mod.rs
index 189bcc727a..eaf44b4c56 100755
--- a/rust_src/src/crypto/mod.rs
+++ b/rust_src/src/crypto/mod.rs
@@ -1,33 +1,22 @@
-#![allow(dead_code)] // XXX unused code belongs into translation of new extract_data_from_object fn
+use std;
+use std::slice;
 
 use libc::ptrdiff_t;
-use md5;
+
+use md5 as md5_crate;
 use sha1;
 use sha2::{Digest, Sha224, Sha256, Sha384, Sha512};
-use std;
-use std::slice;
 
 use remacs_macros::lisp_fn;
 
 use crate::{
-    buffers::{buffer_file_name, LispBufferOrName, LispBufferRef},
-    lisp::defsubr,
+    buffers::LispBufferOrName,
     lisp::LispObject,
     multibyte::LispStringRef,
-    remacs_sys::{
-        code_convert_string, extract_data_from_object, preferred_coding_system,
-        string_char_to_byte, validate_subarray, Fcoding_system_p,
-    },
-    remacs_sys::{
-        current_thread, make_buffer_string, record_unwind_current_buffer, set_buffer_internal,
-    },
-    remacs_sys::{globals, Ffind_operation_coding_system, Flocal_variable_p},
-    remacs_sys::{make_specified_string, make_uninit_string, EmacsInt},
-    remacs_sys::{
-        Qbuffer_file_coding_system, Qcoding_system_error, Qmd5, Qnil, Qraw_text, Qsha1, Qsha224,
-        Qsha256, Qsha384, Qsha512, Qstringp, Qwrite_region,
-    },
-    symbols::{fboundp, symbol_name, LispSymbolRef},
+    remacs_sys::EmacsInt,
+    remacs_sys::{extract_data_from_object, make_uninit_string},
+    remacs_sys::{Qmd5, Qnil, Qsha1, Qsha224, Qsha256, Qsha384, Qsha512},
+    symbols::{symbol_name, LispSymbolRef},
     threads::ThreadState,
 };
 
@@ -63,205 +52,6 @@ fn hash_alg(algorithm: LispSymbolRef) -> HashAlg {
     }
 }
 
-fn check_coding_system_or_error(coding_system: LispObject, noerror: LispObject) -> LispObject {
-    if unsafe { Fcoding_system_p(coding_system) }.is_nil() {
-        /* Invalid coding system. */
-        if noerror.is_not_nil() {
-            Qraw_text
-        } else {
-            xsignal!(Qcoding_system_error, coding_system);
-        }
-    } else {
-        coding_system
-    }
-}
-
-fn get_coding_system_for_string(string: LispStringRef, coding_system: LispObject) -> LispObject {
-    if coding_system.is_nil() {
-        /* Decide the coding-system to encode the data with. */
-        if string.is_multibyte() {
-            /* use default, we can't guess correct value */
-            unsafe { preferred_coding_system() }
-        } else {
-            Qraw_text
-        }
-    } else {
-        coding_system
-    }
-}
-
-fn get_coding_system_for_buffer(
-    object: LispObject,
-    buffer: LispBufferRef,
-    start: LispObject,
-    end: LispObject,
-    start_byte: ptrdiff_t,
-    end_byte: ptrdiff_t,
-    coding_system: LispObject,
-) -> LispObject {
-    /* Decide the coding-system to encode the data with.
-    See fileio.c:Fwrite-region */
-    if coding_system.is_not_nil() {
-        return coding_system;
-    }
-    if unsafe { globals.Vcoding_system_for_write }.is_not_nil() {
-        return unsafe { globals.Vcoding_system_for_write };
-    }
-    if (buffer.buffer_file_coding_system_.is_nil()
-        || unsafe { Flocal_variable_p(Qbuffer_file_coding_system, Qnil) }.is_nil())
-        && !buffer.multibyte_characters_enabled()
-    {
-        return Qraw_text;
-    }
-    let file_name = buffer_file_name(object.into());
-    if file_name.is_not_nil() {
-        // Check file-coding-system-alist.
-        let mut args = [Qwrite_region, start, end, file_name];
-        let val = unsafe { Ffind_operation_coding_system(4, args.as_mut_ptr()) };
-        if let Some((_, d)) = val.into() {
-            if d.is_not_nil() {
-                return d;
-            }
-        }
-    }
-    if buffer.buffer_file_coding_system_.is_not_nil() {
-        /* If we still have not decided a coding system, use the
-        default value of buffer-file-coding-system. */
-        return buffer.buffer_file_coding_system_;
-    }
-    let sscsf = unsafe { globals.Vselect_safe_coding_system_function };
-    if fboundp(sscsf.into()) {
-        /* Confirm that VAL can surely encode the current region. */
-        return call!(
-            sscsf,
-            start_byte.into(),
-            end_byte.into(),
-            coding_system,
-            Qnil
-        );
-    }
-    Qnil
-}
-
-fn get_input_from_string(
-    object: LispObject,
-    string: LispStringRef,
-    start: LispObject,
-    end: LispObject,
-) -> LispObject {
-    let size: ptrdiff_t;
-    let start_byte: ptrdiff_t;
-    let end_byte: ptrdiff_t;
-    let mut start_char: ptrdiff_t = 0;
-    let mut end_char: ptrdiff_t = 0;
-
-    size = string.len_bytes();
-    unsafe {
-        validate_subarray(object, start, end, size, &mut start_char, &mut end_char);
-    }
-    start_byte = if start_char == 0 {
-        0
-    } else {
-        unsafe { string_char_to_byte(object, start_char) }
-    };
-    end_byte = if end_char == size {
-        string.len_bytes()
-    } else {
-        unsafe { string_char_to_byte(object, end_char) }
-    };
-    if start_byte == 0 && end_byte == size {
-        object
-    } else {
-        unsafe {
-            make_specified_string(
-                string.const_sdata_ptr().offset(start_byte),
-                -1 as ptrdiff_t,
-                end_byte - start_byte,
-                string.is_multibyte(),
-            )
-        }
-    }
-}
-
-fn get_input_from_buffer(
-    mut buffer: LispBufferRef,
-    start: LispObject,
-    end: LispObject,
-    start_byte: &mut ptrdiff_t,
-    end_byte: &mut ptrdiff_t,
-) -> LispObject {
-    let prev_buffer = ThreadState::current_buffer_unchecked().as_mut();
-    unsafe { record_unwind_current_buffer() };
-    unsafe { set_buffer_internal(buffer.as_mut()) };
-
-    *start_byte = start.map_or(buffer.begv, |v| {
-        v.as_number_coerce_marker_or_error().to_fixnum() as ptrdiff_t
-    });
-    *end_byte = end.map_or(buffer.zv, |v| {
-        v.as_number_coerce_marker_or_error().to_fixnum() as ptrdiff_t
-    });
-
-    if start_byte > end_byte {
-        std::mem::swap(start_byte, end_byte);
-    }
-    if !(buffer.begv <= *start_byte && *end_byte <= buffer.zv) {
-        args_out_of_range!(start, end);
-    }
-    let string = unsafe { make_buffer_string(*start_byte, *end_byte, false) };
-    unsafe { set_buffer_internal(prev_buffer) };
-    // TODO: this needs to be std::mem::size_of<specbinding>()
-    unsafe { (*current_thread).m_specpdl_ptr = (*current_thread).m_specpdl_ptr.offset(-40) };
-    string
-}
-
-fn get_input(
-    object: LispObject,
-    string: &mut Option<LispStringRef>,
-    buffer: &Option<LispBufferRef>,
-    start: LispObject,
-    end: LispObject,
-    coding_system: LispObject,
-    noerror: LispObject,
-) -> LispStringRef {
-    if object.is_string() {
-        if string.unwrap().is_multibyte() {
-            let coding_system = check_coding_system_or_error(
-                get_coding_system_for_string(string.unwrap(), coding_system),
-                noerror,
-            );
-            *string = Some(
-                unsafe { code_convert_string(object, coding_system, Qnil, true, false, true) }
-                    .into(),
-            )
-        }
-        get_input_from_string(object, string.unwrap(), start, end).into()
-    } else if object.is_buffer() {
-        let mut start_byte: ptrdiff_t = 0;
-        let mut end_byte: ptrdiff_t = 0;
-        let s = get_input_from_buffer(buffer.unwrap(), start, end, &mut start_byte, &mut end_byte);
-        let ss: LispStringRef = s.into();
-        if ss.is_multibyte() {
-            let coding_system = check_coding_system_or_error(
-                get_coding_system_for_buffer(
-                    object,
-                    buffer.unwrap(),
-                    start,
-                    end,
-                    start_byte,
-                    end_byte,
-                    coding_system,
-                ),
-                noerror,
-            );
-            unsafe { code_convert_string(s, coding_system, Qnil, true, false, false) }.into()
-        } else {
-            ss
-        }
-    } else {
-        wrong_type!(Qstringp, object);
-    }
-}
-
 /// Return MD5 message digest of OBJECT, a buffer or string.
 ///
 /// A message digest is a cryptographic checksum of a document, and the
@@ -403,7 +193,7 @@ fn hexify_digest_string(buffer: &mut [u8], len: usize) {
 // digest.
 
 fn md5_buffer(buffer: &[u8], dest_buf: &mut [u8]) {
-    let output = md5::compute(buffer);
+    let output = md5_crate::compute(buffer);
     dest_buf[..output.len()].copy_from_slice(&*output)
 }
 
diff --git a/rust_src/src/data.rs b/rust_src/src/data.rs
index 1daba69fef..9994dd141d 100644
--- a/rust_src/src/data.rs
+++ b/rust_src/src/data.rs
@@ -9,7 +9,7 @@ use crate::{
     buffers::per_buffer_idx,
     frames::selected_frame,
     keymap::get_keymap,
-    lisp::{defsubr, is_autoload},
+    lisp::is_autoload,
     lisp::{LispObject, LispSubrRef, LiveBufferIter},
     lists::{get, member, memq, put},
     math::leq,
diff --git a/rust_src/src/decompress.rs b/rust_src/src/decompress.rs
index d399d763ec..5f817addc5 100644
--- a/rust_src/src/decompress.rs
+++ b/rust_src/src/decompress.rs
@@ -8,7 +8,6 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     buffers::validate_region,
-    lisp::defsubr,
     lisp::LispObject,
     remacs_sys::{
         buf_charpos_to_bytepos, del_range_2, insert_from_gap, make_gap, maybe_quit, modify_text,
diff --git a/rust_src/src/dired.rs b/rust_src/src/dired.rs
index 4d4513d368..65f1446384 100644
--- a/rust_src/src/dired.rs
+++ b/rust_src/src/dired.rs
@@ -9,12 +9,7 @@ use crate::dired_unix::{
 #[cfg(windows)]
 use dired_windows::{file_attributes_intro, get_users};
 
-use crate::{
-    lisp::{defsubr, LispObject},
-    lists::car,
-    multibyte::LispStringRef,
-    strings::string_lessp,
-};
+use crate::{lisp::LispObject, lists::car, multibyte::LispStringRef, strings::string_lessp};
 
 /// Return a list of names of files in DIRECTORY.
 /// There are three optional arguments:
diff --git a/rust_src/src/dispnew.rs b/rust_src/src/dispnew.rs
index 313a5cc771..a0b41e4276 100644
--- a/rust_src/src/dispnew.rs
+++ b/rust_src/src/dispnew.rs
@@ -9,7 +9,6 @@ use crate::{
     eval::unbind_to,
     frames::selected_frame,
     frames::{LispFrameOrSelected, LispFrameRef},
-    lisp::defsubr,
     lisp::{ExternalPtr, LispObject},
     lists::{LispConsCircularChecks, LispConsEndChecks},
     remacs_sys::{
@@ -58,7 +57,7 @@ pub fn sleep_for(seconds: EmacsDouble, milliseconds: Option<EmacsInt>) {
 }
 
 /**********************************************************************
-		    Redrawing Frames
+            Redrawing Frames
 **********************************************************************/
 
 /// Redraw frame FRAME.
@@ -120,7 +119,7 @@ pub extern "C" fn set_window_update_flags(w: LispWindowRef, on_p: bool) {
 }
 
 /***********************************************************************
-		   Blinking cursor
+           Blinking cursor
 ***********************************************************************/
 
 /// Set the cursor-visibility flag of WINDOW to SHOW.
diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index 0d0eccdcb0..47a504fdc0 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -16,7 +16,7 @@ use crate::{
     character::{char_head_p, dec_pos},
     eval::{progn, record_unwind_protect, unbind_to},
     indent::invalidate_current_column,
-    lisp::{defsubr, LispObject},
+    lisp::LispObject,
     marker::{
         buf_bytepos_to_charpos, buf_charpos_to_bytepos, marker_position_lisp, point_marker,
         set_point_from_marker,
diff --git a/rust_src/src/emacs.rs b/rust_src/src/emacs.rs
index 6b140df9b4..41121a99dd 100644
--- a/rust_src/src/emacs.rs
+++ b/rust_src/src/emacs.rs
@@ -4,11 +4,7 @@ use cfg_if::cfg_if;
 
 use remacs_macros::lisp_fn;
 
-use crate::{
-    lisp::{defsubr, LispObject},
-    remacs_sys::globals,
-    remacs_sys::Fcopy_sequence,
-};
+use crate::{lisp::LispObject, remacs_sys::globals, remacs_sys::Fcopy_sequence};
 
 /// Replaces IS_DAEMON
 cfg_if! {
diff --git a/rust_src/src/eval.rs b/rust_src/src/eval.rs
index f9db81125b..41bcb7c920 100644
--- a/rust_src/src/eval.rs
+++ b/rust_src/src/eval.rs
@@ -8,7 +8,7 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     data::{defalias, fset, indirect_function, indirect_function_lisp, set, set_default},
-    lisp::{defsubr, is_autoload},
+    lisp::is_autoload,
     lisp::{LispObject, LispSubrRef},
     lists::{assq, car, cdr, get, memq, nth, put},
     lists::{LispCons, LispConsCircularChecks, LispConsEndChecks},
diff --git a/rust_src/src/fileio.rs b/rust_src/src/fileio.rs
index f9157cf4de..8d9a101973 100644
--- a/rust_src/src/fileio.rs
+++ b/rust_src/src/fileio.rs
@@ -8,7 +8,7 @@ use remacs_macros::lisp_fn;
 use crate::{
     coding::encode_file_name,
     errno::errno,
-    lisp::{defsubr, LispObject},
+    lisp::LispObject,
     lists::LispCons,
     math::{arithcompare, ArithComparison},
     multibyte::LispStringRef,
diff --git a/rust_src/src/fns.rs b/rust_src/src/fns.rs
index 1f4cd17a21..35a29c824e 100644
--- a/rust_src/src/fns.rs
+++ b/rust_src/src/fns.rs
@@ -8,7 +8,6 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     eval::{record_unwind_protect, un_autoload, unbind_to},
-    lisp::defsubr,
     lisp::LispObject,
     lists::{assq, car, get, mapcar1, member, memq, put},
     lists::{LispCons, LispConsCircularChecks, LispConsEndChecks},
diff --git a/rust_src/src/fonts.rs b/rust_src/src/fonts.rs
index 21e96b5ad1..6dde26d5f1 100644
--- a/rust_src/src/fonts.rs
+++ b/rust_src/src/fonts.rs
@@ -9,7 +9,6 @@ use std::{ffi::CString, mem};
 use crate::{
     data,
     frames::{LispFrameLiveOrSelected, LispFrameRef},
-    lisp::defsubr,
     lisp::{ExternalPtr, LispObject},
     obarray::intern,
     remacs_sys::font_match_p as c_font_match_p,
diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index 9b24321607..733bc7eafa 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -5,7 +5,6 @@ use libc::c_int;
 use remacs_macros::lisp_fn;
 
 use crate::{
-    lisp::defsubr,
     lisp::{ExternalPtr, LispObject},
     lists::{LispConsCircularChecks, LispConsEndChecks},
     remacs_sys::Vframe_list,
@@ -44,14 +43,14 @@ impl LispFrameRef {
             match self.vertical_scroll_bar_type() {
                 vertical_scroll_bar_type::vertical_scroll_bar_left
                 | vertical_scroll_bar_type::vertical_scroll_bar_right => {
-                    return self.config_scroll_bar_width
+                    self.config_scroll_bar_width
                 }
-                _ => return 0,
+                _ => 0,
             }
         }
         #[cfg(not(feature = "window-system"))]
         {
-            return 0;
+            0
         }
     }
 
@@ -66,7 +65,7 @@ impl LispFrameRef {
         }
         #[cfg(not(feature = "window-system"))]
         {
-            return 0;
+            0
         }
     }
 }
@@ -507,13 +506,13 @@ pub fn next_frame(frame: LispFrameOrSelected, miniframe: LispObject) -> LispFram
     // a valid candidate will be returned regardless of its position.
     while passed < 2 {
         for_each_frame!(f => {
-	    if passed > 0 {
-	        let tmp = unsafe { candidate_frame(f.into(), frame_obj, miniframe) };
-	        if !tmp.is_nil() {
+            if passed > 0 {
+                let tmp = unsafe { candidate_frame(f.into(), frame_obj, miniframe) };
+                if !tmp.is_nil() {
                     // Found a valid candidate, stop looking.
-	            return f;
+                    return f;
                 }
-	    }
+            }
             if frame_ref == f {
                 // Count the number of times FRAME has been found in the list.
                 passed += 1;
diff --git a/rust_src/src/hashtable.rs b/rust_src/src/hashtable.rs
index 3dd86bb52a..c486914239 100644
--- a/rust_src/src/hashtable.rs
+++ b/rust_src/src/hashtable.rs
@@ -7,7 +7,6 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     data::aref,
-    lisp::defsubr,
     lisp::{ExternalPtr, LispObject},
     lists::{list, put},
     remacs_sys::{
diff --git a/rust_src/src/indent.rs b/rust_src/src/indent.rs
index 80e6432b56..8b9c984e45 100644
--- a/rust_src/src/indent.rs
+++ b/rust_src/src/indent.rs
@@ -7,7 +7,7 @@ use remacs_macros::lisp_fn;
 use crate::{
     buffers::{point_byte, point_min_byte},
     editfns::{insert_char, point, point_min},
-    lisp::{defsubr, LispObject},
+    lisp::LispObject,
     multibyte::Codepoint,
     remacs_sys::globals,
     remacs_sys::EmacsUint,
@@ -132,7 +132,8 @@ pub fn move_to_column(column: EmacsUint, force: LispObject) -> EmacsUint {
         last_known_column_point = buffer.pt;
         last_known_column_modified = buffer.modifications();
     }
-    col.into()
+
+    col
 }
 
 // Cancel any recorded value of the horizontal position.
@@ -149,7 +150,7 @@ pub extern "C" fn invalidate_current_column() {
 #[lisp_fn(min = "1", intspec = "NIndent to column: ")]
 pub fn indent_to(column: EmacsInt, minimum: Option<EmacsInt>) -> EmacsInt {
     let buffer = ThreadState::current_buffer_unchecked();
-    let tab_width = unsafe { sanitize_tab_width(buffer.tab_width_.force_fixnum()) } as EmacsInt;
+    let tab_width = EmacsInt::from(unsafe { sanitize_tab_width(buffer.tab_width_.force_fixnum()) });
     let arg_minimum = minimum.unwrap_or(0);
     let mut fromcol = current_column();
     let mincol = max(fromcol + arg_minimum, column);
diff --git a/rust_src/src/interactive.rs b/rust_src/src/interactive.rs
index 9f1a198a50..389c9644e4 100644
--- a/rust_src/src/interactive.rs
+++ b/rust_src/src/interactive.rs
@@ -3,7 +3,6 @@
 use remacs_macros::lisp_fn;
 
 use crate::{
-    lisp::defsubr,
     lisp::LispObject,
     remacs_sys::{EmacsInt, Qminus},
 };
diff --git a/rust_src/src/keyboard.rs b/rust_src/src/keyboard.rs
index 51d8c698f1..480f65a3ca 100644
--- a/rust_src/src/keyboard.rs
+++ b/rust_src/src/keyboard.rs
@@ -8,7 +8,6 @@ use crate::{
     emacs::is_daemon,
     eval::{record_unwind_protect, unbind_to},
     frames::{selected_frame, window_frame_live_or_selected_with_action},
-    lisp::defsubr,
     lisp::LispObject,
     lists::{LispCons, LispConsCircularChecks, LispConsEndChecks},
     multibyte::LispStringRef,
diff --git a/rust_src/src/keymap.rs b/rust_src/src/keymap.rs
index b1733fa85e..76c5be1b19 100644
--- a/rust_src/src/keymap.rs
+++ b/rust_src/src/keymap.rs
@@ -13,7 +13,7 @@ use crate::{
     eval::{autoload_do_load, unbind_to},
     indent::indent_to,
     keyboard::lucid_event_type_list_p,
-    lisp::{defsubr, LispObject},
+    lisp::LispObject,
     lists::{nth, setcdr},
     lists::{LispCons, LispConsCircularChecks, LispConsEndChecks},
     obarray::intern,
diff --git a/rust_src/src/lib.rs b/rust_src/src/lib.rs
index 1c0d6b3a44..896891097e 100644
--- a/rust_src/src/lib.rs
+++ b/rust_src/src/lib.rs
@@ -15,7 +15,6 @@
 #![feature(const_fn_union)]
 #![feature(never_type)]
 #![feature(ptr_offset_from)]
-#![feature(self_struct_ctor)]
 #![feature(slice_patterns)]
 #![feature(specialization)]
 #![feature(stmt_expr_attributes)]
diff --git a/rust_src/src/lisp.rs b/rust_src/src/lisp.rs
index 558872ce9f..18f43bdb91 100644
--- a/rust_src/src/lisp.rs
+++ b/rust_src/src/lisp.rs
@@ -750,7 +750,7 @@ macro_rules! export_lisp_fns {
         pub fn rust_init_syms() {
             unsafe {
                 $(
-                    defsubr(concat_idents!(S, $f).as_ptr());
+                    crate::lisp::defsubr(concat_idents!(S, $f).as_ptr());
                 )+
             }
         }
diff --git a/rust_src/src/lists.rs b/rust_src/src/lists.rs
index c985f12f6a..1671c473f2 100644
--- a/rust_src/src/lists.rs
+++ b/rust_src/src/lists.rs
@@ -9,7 +9,6 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     hashtable::LispHashTableRef,
-    lisp::defsubr,
     lisp::{LispObject, LispStructuralEqual},
     numbers::MOST_POSITIVE_FIXNUM,
     remacs_sys::{equal_kind, globals, EmacsInt, EmacsUint, Lisp_Cons, Lisp_Type},
diff --git a/rust_src/src/lread.rs b/rust_src/src/lread.rs
index dca2e55a28..e5d78dfb85 100644
--- a/rust_src/src/lread.rs
+++ b/rust_src/src/lread.rs
@@ -14,7 +14,7 @@ use crate::{
         Lisp_Objfwd,
     },
     eval::unbind_to,
-    lisp::{defsubr, LispObject},
+    lisp::LispObject,
     obarray::{intern, intern_c_string_1},
     remacs_sys,
     remacs_sys::{
diff --git a/rust_src/src/marker.rs b/rust_src/src/marker.rs
index dbdb118941..fbf49761b6 100644
--- a/rust_src/src/marker.rs
+++ b/rust_src/src/marker.rs
@@ -9,7 +9,7 @@ use remacs_macros::lisp_fn;
 use crate::{
     buffers::{current_buffer, LispBufferRef},
     hashtable::LispHashTableRef,
-    lisp::{defsubr, ExternalPtr, LispMiscRef, LispObject, LispStructuralEqual},
+    lisp::{ExternalPtr, LispMiscRef, LispObject, LispStructuralEqual},
     multibyte::multibyte_chars_in_text,
     remacs_sys::{allocate_misc, set_point_both, Fmake_marker},
     remacs_sys::{equal_kind, EmacsInt, Lisp_Buffer, Lisp_Marker, Lisp_Misc_Type, Lisp_Type},
diff --git a/rust_src/src/math.rs b/rust_src/src/math.rs
index 2219fbaf75..ca78918b45 100644
--- a/rust_src/src/math.rs
+++ b/rust_src/src/math.rs
@@ -4,11 +4,7 @@
 use crate::remacs_sys::{EmacsInt, Qnumberp};
 use remacs_macros::lisp_fn;
 
-use crate::{
-    floatfns,
-    lisp::{defsubr, LispObject},
-    numbers::LispNumber,
-};
+use crate::{floatfns, lisp::LispObject, numbers::LispNumber};
 
 /// Return X modulo Y.
 /// The result falls between zero (inclusive) and Y (exclusive).
diff --git a/rust_src/src/minibuf.rs b/rust_src/src/minibuf.rs
index 2b12b91f59..a0948f324c 100644
--- a/rust_src/src/minibuf.rs
+++ b/rust_src/src/minibuf.rs
@@ -7,7 +7,6 @@ use crate::{
     editfns::field_end,
     eval::unbind_to,
     keymap::get_keymap,
-    lisp::defsubr,
     lisp::LispObject,
     lists::{car_safe, cdr_safe, memq},
     multibyte::LispStringRef,
diff --git a/rust_src/src/numbers.rs b/rust_src/src/numbers.rs
index ec08f33196..c05f44a8a2 100644
--- a/rust_src/src/numbers.rs
+++ b/rust_src/src/numbers.rs
@@ -7,7 +7,6 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     hashtable::LispHashTableRef,
-    lisp::defsubr,
     lisp::{LispObject, LispStructuralEqual},
     remacs_sys::{
         equal_kind, EmacsDouble, EmacsInt, EmacsUint, Lisp_Bits, Lisp_Type, EMACS_INT_MAX, INTMASK,
diff --git a/rust_src/src/obarray.rs b/rust_src/src/obarray.rs
index 31f24c26db..6706a51f7c 100644
--- a/rust_src/src/obarray.rs
+++ b/rust_src/src/obarray.rs
@@ -4,7 +4,6 @@ use libc;
 use remacs_macros::lisp_fn;
 
 use crate::{
-    lisp::defsubr,
     lisp::LispObject,
     multibyte::LispStringRef,
     remacs_sys::{
diff --git a/rust_src/src/objects.rs b/rust_src/src/objects.rs
index bf22194da8..fd371d3dcc 100644
--- a/rust_src/src/objects.rs
+++ b/rust_src/src/objects.rs
@@ -2,11 +2,7 @@
 
 use remacs_macros::lisp_fn;
 
-use crate::{
-    hashtable::LispHashTableRef,
-    lisp::{defsubr, LispObject},
-    remacs_sys::equal_kind,
-};
+use crate::{hashtable::LispHashTableRef, lisp::LispObject, remacs_sys::equal_kind};
 
 /// Return t if OBJECT is nil, and return nil otherwise.
 #[lisp_fn]
diff --git a/rust_src/src/process.rs b/rust_src/src/process.rs
index 9387a6eb7f..69e89b4fee 100644
--- a/rust_src/src/process.rs
+++ b/rust_src/src/process.rs
@@ -6,7 +6,6 @@ use remacs_macros::lisp_fn;
 use crate::{
     buffers::{current_buffer, get_buffer, LispBufferOrName, LispBufferRef},
     eval::run_hook_with_args_until_success,
-    lisp::defsubr,
     lisp::{ExternalPtr, LispObject, ProcessIter},
     lists::{assoc, car, cdr, plist_put},
     multibyte::LispStringRef,
diff --git a/rust_src/src/profiler.rs b/rust_src/src/profiler.rs
index 46945ccf7e..5935c60a3c 100644
--- a/rust_src/src/profiler.rs
+++ b/rust_src/src/profiler.rs
@@ -4,7 +4,7 @@ use std::ffi::CString;
 use remacs_macros::lisp_fn;
 
 use crate::{
-    lisp::{defsubr, LispObject},
+    lisp::LispObject,
     remacs_sys::{error, globals, Qnil},
     remacs_sys::{make_log, memory_log, profiler_memory_running},
 };
diff --git a/rust_src/src/search.rs b/rust_src/src/search.rs
index 797966ba64..5a128dbbc3 100644
--- a/rust_src/src/search.rs
+++ b/rust_src/src/search.rs
@@ -3,7 +3,6 @@
 use remacs_macros::lisp_fn;
 
 use crate::{
-    lisp::defsubr,
     lisp::LispObject,
     remacs_sys::{looking_at_1, match_limit, search_command, string_match_1},
 };
diff --git a/rust_src/src/strings.rs b/rust_src/src/strings.rs
index c9fd5a005f..150a0e64a1 100644
--- a/rust_src/src/strings.rs
+++ b/rust_src/src/strings.rs
@@ -7,7 +7,6 @@ use libc;
 use remacs_macros::lisp_fn;
 
 use crate::{
-    lisp::defsubr,
     lisp::LispObject,
     multibyte,
     multibyte::LispStringRef,
diff --git a/rust_src/src/symbols.rs b/rust_src/src/symbols.rs
index 718fb46aae..28d3dfcbbb 100644
--- a/rust_src/src/symbols.rs
+++ b/rust_src/src/symbols.rs
@@ -10,7 +10,6 @@ use crate::{
     data::Lisp_Fwd,
     data::{indirect_function, set},
     hashtable::LispHashTableRef,
-    lisp::defsubr,
     lisp::{ExternalPtr, LispObject, LispStructuralEqual},
     multibyte::LispStringRef,
     remacs_sys::{equal_kind, lispsym, EmacsInt, Lisp_Symbol, Lisp_Type, USE_LSB_TAG},
diff --git a/rust_src/src/syntax.rs b/rust_src/src/syntax.rs
index ec6f07a1bb..27152d71a4 100644
--- a/rust_src/src/syntax.rs
+++ b/rust_src/src/syntax.rs
@@ -5,7 +5,6 @@ use remacs_macros::lisp_fn;
 use crate::{
     chartable::LispCharTableRef,
     editfns::constrain_to_field,
-    lisp::defsubr,
     lisp::LispObject,
     numbers::LispNumber,
     remacs_sys::{
diff --git a/rust_src/src/terminal.rs b/rust_src/src/terminal.rs
index 63550cd31f..9c08a204d6 100644
--- a/rust_src/src/terminal.rs
+++ b/rust_src/src/terminal.rs
@@ -10,7 +10,6 @@ use crate::{
     dispnew::LispGlyphRef,
     frames::Fselected_frame,
     frames::LispFrameRef,
-    lisp::defsubr,
     lisp::{ExternalPtr, LispObject},
     remacs_sys::build_string,
     remacs_sys::{pvec_type, Lisp_Terminal},
diff --git a/rust_src/src/textprop.rs b/rust_src/src/textprop.rs
index 810895354a..a05f57ffae 100644
--- a/rust_src/src/textprop.rs
+++ b/rust_src/src/textprop.rs
@@ -4,11 +4,7 @@ use std::ptr;
 
 use remacs_macros::lisp_fn;
 
-use crate::{
-    lisp::{defsubr, LispObject},
-    remacs_sys::get_char_property_and_overlay,
-    remacs_sys::EmacsInt,
-};
+use crate::{lisp::LispObject, remacs_sys::get_char_property_and_overlay, remacs_sys::EmacsInt};
 
 /// Return the value of POSITION's property PROP, in OBJECT.
 /// Both overlay properties and text properties are checked.
diff --git a/rust_src/src/threads.rs b/rust_src/src/threads.rs
index 3d02878555..5961ef66a3 100644
--- a/rust_src/src/threads.rs
+++ b/rust_src/src/threads.rs
@@ -8,7 +8,6 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     buffers::LispBufferRef,
-    lisp::defsubr,
     lisp::{ExternalPtr, LispObject},
     remacs_sys::Qthreadp,
     remacs_sys::{
diff --git a/rust_src/src/time.rs b/rust_src/src/time.rs
index 5e3d910cee..992f28932f 100644
--- a/rust_src/src/time.rs
+++ b/rust_src/src/time.rs
@@ -11,7 +11,6 @@ use remacs_lib::current_timespec;
 use remacs_macros::lisp_fn;
 
 use crate::{
-    lisp::defsubr,
     lisp::LispObject,
     numbers::MOST_NEGATIVE_FIXNUM,
     remacs_sys::{lisp_time, EmacsDouble, EmacsInt},
diff --git a/rust_src/src/vectors.rs b/rust_src/src/vectors.rs
index 036d06e71f..d63496d4e2 100644
--- a/rust_src/src/vectors.rs
+++ b/rust_src/src/vectors.rs
@@ -16,7 +16,6 @@ use crate::{
     data::aref,
     frames::LispFrameRef,
     hashtable::LispHashTableRef,
-    lisp::defsubr,
     lisp::{ExternalPtr, LispObject, LispStructuralEqual, LispSubrRef},
     lists::{inorder, nth, sort_list},
     multibyte::MAX_CHAR,
diff --git a/rust_src/src/window_configuration.rs b/rust_src/src/window_configuration.rs
index 3acbfcc670..3ca95b0ef2 100644
--- a/rust_src/src/window_configuration.rs
+++ b/rust_src/src/window_configuration.rs
@@ -4,7 +4,6 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     frames::LispFrameRef,
-    lisp::defsubr,
     lisp::{ExternalPtr, LispObject},
     objects::equal,
     remacs_sys::Qwindow_configuration_p,
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 58580b613f..d61542b93c 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -11,7 +11,6 @@ use crate::{
     editfns::{goto_char, point},
     frames::{LispFrameOrSelected, LispFrameRef},
     interactive::prefix_numeric_value,
-    lisp::defsubr,
     lisp::{ExternalPtr, LispObject},
     lists::{assq, setcdr},
     marker::{marker_position_lisp, set_marker_restricted},
diff --git a/rust_src/src/xfaces.rs b/rust_src/src/xfaces.rs
index fa9365f1c4..434dcf4420 100644
--- a/rust_src/src/xfaces.rs
+++ b/rust_src/src/xfaces.rs
@@ -2,10 +2,7 @@
 
 use remacs_macros::lisp_fn;
 
-use crate::{
-    lisp::defsubr,
-    remacs_sys::{clear_face_cache, set_face_change, windows_or_buffers_changed},
-};
+use crate::remacs_sys::{clear_face_cache, set_face_change, windows_or_buffers_changed};
 
 /// Clear face caches on all frames.
 /// Optional THOROUGHLY non-nil means try to free unused fonts, too.
diff --git a/rust_src/src/xml.rs b/rust_src/src/xml.rs
index f92fe76d9a..31265b2dfb 100644
--- a/rust_src/src/xml.rs
+++ b/rust_src/src/xml.rs
@@ -2,7 +2,7 @@
 
 use remacs_macros::lisp_fn;
 
-use crate::{lisp::defsubr, lisp::LispObject, remacs_sys::Qnil};
+use crate::{lisp::LispObject, remacs_sys::Qnil};
 
 #[cfg(feature = "use-xml2")]
 use crate::remacs_sys::{init_libxml2_functions, parse_region};
-- 
2.21.0


From 696434c3c99951e6965b0f5bcf993407670701da Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Wed, 23 Jan 2019 17:35:49 +0100
Subject: [PATCH 235/297] Port window-body-height and window-body-width (#1272)

---
 rust_src/src/frames.rs  |  17 ++
 rust_src/src/windows.rs | 344 +++++++++++++++++++++++++++++++++++++++-
 src/window.c            |  90 -----------
 3 files changed, 354 insertions(+), 97 deletions(-)

diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index 733bc7eafa..eb156fcf7d 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -20,10 +20,18 @@ use crate::remacs_sys::vertical_scroll_bar_type;
 pub type LispFrameRef = ExternalPtr<Lisp_Frame>;
 
 impl LispFrameRef {
+    pub fn root_window(self) -> LispWindowRef {
+        self.root_window.into()
+    }
     pub fn is_live(self) -> bool {
         !self.terminal.is_null()
     }
 
+    // Awaiting Wilfred#1264
+    pub fn is_gui_window(self) -> bool {
+        cfg!(feature = "window_system")
+    }
+
     // Pixel-width of internal border lines.
     pub fn internal_border_width(self) -> i32 {
         unsafe { frame_dimension(self.internal_border_width) }
@@ -37,6 +45,15 @@ impl LispFrameRef {
         self.left_fringe_width + self.right_fringe_width
     }
 
+    pub fn vertical_scroll_bar_type(self) -> u32 {
+        #[cfg(feature = "window-system")]
+        {
+            (*self).vertical_scroll_bar_type()
+        }
+        #[cfg(not(feature = "window-system"))]
+        0
+    }
+
     pub fn scroll_bar_area_width(self) -> i32 {
         #[cfg(feature = "window-system")]
         {
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index d61542b93c..8c5f01c519 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -1,6 +1,6 @@
 //! Functions operating on windows.
 
-use std::ptr;
+use std::{cmp, ptr};
 
 use libc::c_int;
 
@@ -14,19 +14,22 @@ use crate::{
     lisp::{ExternalPtr, LispObject},
     lists::{assq, setcdr},
     marker::{marker_position_lisp, set_marker_restricted},
+    remacs_sys::face_id::HEADER_LINE_FACE_ID,
     remacs_sys::globals,
     remacs_sys::Fcopy_alist,
     remacs_sys::{
         estimate_mode_line_height, minibuf_level,
         minibuf_selected_window as current_minibuf_window, scroll_command, select_window,
         selected_window as current_window, set_buffer_internal, set_window_hscroll,
-        update_mode_lines, window_body_width, window_list_1, window_menu_bar_p, window_tool_bar_p,
-        wset_redisplay,
+        update_mode_lines, window_list_1, window_menu_bar_p, window_tool_bar_p, wset_redisplay,
     },
-    remacs_sys::{face_id, glyph_matrix, pvec_type, EmacsInt, Lisp_Type, Lisp_Window},
     remacs_sys::{
-        Qceiling, Qfloor, Qheader_line_format, Qmode_line_format, Qnil, Qnone, Qwindow_live_p,
-        Qwindow_valid_p, Qwindowp,
+        face_id, glyph_matrix, pvec_type, vertical_scroll_bar_type, EmacsInt, Lisp_Type,
+        Lisp_Window,
+    },
+    remacs_sys::{
+        Qceiling, Qfloor, Qheader_line_format, Qleft, Qmode_line_format, Qnil, Qnone, Qright, Qt,
+        Qwindow_live_p, Qwindow_valid_p, Qwindowp,
     },
     threads::ThreadState,
 };
@@ -50,10 +53,36 @@ impl LispWindowRef {
         self.contents.is_not_nil()
     }
 
+    // Equivalent to WINDOW_RIGHTMOST_P
+    /// True if window W has no other windows to its right on its frame.
+    pub fn is_rightmost(self) -> bool {
+        self.right_pixel_edge() == self.get_frame().root_window().right_pixel_edge()
+    }
+
+    // Equivalent to WINDOW_BOTTOMMOST_P
+    /// True if window W has no other windows below it on its frame (the
+    /// minibuffer window is not counted in this respect unless W itself is a
+    /// minibuffer window).
+    pub fn is_bottommost(self) -> bool {
+        self.bottom_pixel_edge() == self.get_frame().root_window().bottom_pixel_edge()
+    }
+
     pub fn get_frame(self) -> LispFrameRef {
         self.frame.into()
     }
 
+    pub fn get_matrix(self) -> LispGlyphMatrixRef {
+        LispGlyphMatrixRef::new(self.current_matrix)
+    }
+
+    pub fn prev(self) -> Self {
+        self.prev.into()
+    }
+
+    pub fn next(self) -> Self {
+        self.next.into()
+    }
+
     /// Return the current height of the mode line of window W. If not known
     /// from W->mode_line_height, look at W's current glyph matrix, or return
     /// a default based on the height of the font of the face `mode-line'.
@@ -78,6 +107,17 @@ impl LispWindowRef {
         }
     }
 
+    // Equivalent to WINDOW_MODE_LINE_HEIGHT
+    /// Height in pixels of the mode line.
+    /// May be zero if W doesn't have a mode line.
+    pub fn mode_line_height(mut self) -> i32 {
+        if self.wants_header_line() {
+            self.current_mode_line_height()
+        } else {
+            0
+        }
+    }
+
     pub fn start_marker(self) -> LispObject {
         self.start
     }
@@ -90,6 +130,19 @@ impl LispWindowRef {
         self.mini()
     }
 
+    // Equivalent to MINI_NON_ONLY_P
+    /// True if W is a minibuffer window on a frame that contains at least
+    /// one other window
+    pub fn is_minibuffer_non_only(self) -> bool {
+        self.is_minibuffer() && self.prev.is_not_nil()
+    }
+
+    // Equivalent to MINI_ONLY_WINDOW_P
+    /// True if W is a minibuffer window that is alone on its frame.
+    pub fn is_minibuffer_only(self) -> bool {
+        self.is_minibuffer() && self.prev.is_nil()
+    }
+
     pub fn is_menu_bar(mut self) -> bool {
         unsafe { window_menu_bar_p(self.as_mut()) }
     }
@@ -134,6 +187,59 @@ impl LispWindowRef {
         }
     }
 
+    /// Return the number of lines/pixels of W's body. Don't count any mode
+    /// or header line or horizontal divider of W. Rounds down to nearest
+    /// integer when not working pixelwise.
+    pub fn body_height(self, pixelwise: bool) -> i32 {
+        let height = self.pixel_height
+            - self.header_line_height()
+            - if self.has_horizontal_scroll_bar() {
+                self.scroll_bar_area_height()
+            } else {
+                0
+            }
+            - self.mode_line_height()
+            - self.bottom_divider_width();
+
+        if pixelwise {
+            cmp::max(height, 0)
+        } else {
+            cmp::max(height / self.get_frame().line_height, 0)
+        }
+    }
+
+    /// Return the number of columns/pixels of W's body.  Don't count columns
+    /// occupied by the scroll bar or the divider/vertical bar separating W
+    /// from its right sibling or margins.  On window-systems don't count
+    /// fringes either.  Round down to nearest integer when not working
+    /// pixelwise.
+    pub fn body_width(self, pixelwise: bool) -> i32 {
+        let width = self.pixel_width
+            - self.right_divider_width()
+            - self.margins_width()
+            - if self.has_vertical_scroll_bar() {
+                self.scroll_bar_area_width()
+            } else if !self.get_frame().is_gui_window()
+                && !self.is_rightmost()
+                && self.right_divider_width() == 0
+            {
+                1
+            } else {
+                0
+            }
+            - if self.get_frame().is_gui_window() {
+                self.fringes_width()
+            } else {
+                0
+            };
+
+        if pixelwise {
+            cmp::max(width, 0)
+        } else {
+            cmp::max(width / self.get_frame().column_width, 0)
+        }
+    }
+
     /// The frame x-position at which the text (or left fringe) in
     /// window starts. This does not include a left-hand scroll bar
     /// if any.
@@ -161,6 +267,18 @@ impl LispWindowRef {
         self.pixel_top
     }
 
+    /// Return the bottom pixel edge before which window W ends.
+    /// This includes a mode line, if any.
+    pub fn bottom_pixel_edge(self) -> i32 {
+        self.top_pixel_edge() + self.pixel_height
+    }
+
+    /// Return the right pixel edge before which window W ends.
+    /// This includes a right-hand scroll bar, if any.
+    pub fn right_pixel_edge(self) -> i32 {
+        self.left_pixel_edge() + self.pixel_width
+    }
+
     /// Convert window relative pixel Y to frame pixel coordinates.
     pub fn frame_pixel_y(self, y: i32) -> i32 {
         y + self.top_edge_y()
@@ -216,6 +334,63 @@ impl LispWindowRef {
             && self.pixel_height > height
     }
 
+    pub fn current_header_line_height(mut self) -> i32 {
+        let matrix = self.get_matrix();
+        if self.header_line_height >= 0 {
+            self.header_line_height
+        } else {
+            self.header_line_height = if matrix.header_line_height() != 0 {
+                matrix.header_line_height()
+            } else {
+                unsafe { estimate_mode_line_height(self.get_frame().as_mut(), HEADER_LINE_FACE_ID) }
+            };
+            self.header_line_height
+        }
+    }
+
+    // Equivalent to WINDOW_HEADER_LINE_HEIGHT
+    /// Height in pixels of the header line.
+    /// Zero if the window doesn't have a header line.
+    pub fn header_line_height(self) -> i32 {
+        if self.wants_header_line() {
+            self.current_header_line_height()
+        } else {
+            0
+        }
+    }
+
+    pub fn left_fringe_width(self) -> i32 {
+        if self.left_fringe_width >= 0 {
+            self.left_fringe_width
+        } else {
+            self.get_frame().left_fringe_width
+        }
+    }
+
+    pub fn right_fringe_width(self) -> i32 {
+        if self.right_fringe_width >= 0 {
+            self.right_fringe_width
+        } else {
+            self.get_frame().left_fringe_width
+        }
+    }
+
+    pub fn fringes_width(self) -> i32 {
+        self.left_fringe_width() + self.right_fringe_width()
+    }
+
+    pub fn left_margin_width(self) -> i32 {
+        self.left_margin_cols * self.get_frame().column_width
+    }
+
+    pub fn right_margin_width(self) -> i32 {
+        self.right_margin_cols * self.get_frame().column_width
+    }
+
+    pub fn margins_width(self) -> i32 {
+        self.left_margin_width() + self.right_margin_width()
+    }
+
     /// True if window W is a vertical combination of windows.
     pub fn is_vertical_combination(self) -> bool {
         self.is_internal() && !self.horizontal()
@@ -227,6 +402,114 @@ impl LispWindowRef {
             None => Qnil,
         }
     }
+
+    pub fn vertical_scroll_bar_type(self) -> u32 {
+        use crate::remacs_sys::vertical_scroll_bar_type as scroll;
+        if self.is_pseudo() {
+            scroll::vertical_scroll_bar_none
+        } else {
+            match self.vertical_scroll_bar_type {
+                Qt => self.get_frame().vertical_scroll_bar_type(),
+                Qleft => scroll::vertical_scroll_bar_left,
+                Qright => scroll::vertical_scroll_bar_right,
+                _ => scroll::vertical_scroll_bar_none,
+            }
+        }
+    }
+
+    pub fn has_vertical_scroll_bar_left(self) -> bool {
+        self.vertical_scroll_bar_type() == vertical_scroll_bar_type::vertical_scroll_bar_left
+    }
+
+    pub fn has_vertical_scroll_bar_right(self) -> bool {
+        self.vertical_scroll_bar_type() == vertical_scroll_bar_type::vertical_scroll_bar_right
+    }
+
+    pub fn has_vertical_scroll_bar(self) -> bool {
+        self.has_vertical_scroll_bar_left() || self.has_vertical_scroll_bar_right()
+    }
+
+    // Equivalent to WINDOW_HAS_HORIZONTAL_SCROLL_BAR
+    /// True if horizontal scroll bars are currently enabled for the window.
+    /// Horizontal scrollbars only exist when a toolkit is enabled.
+    #[cfg(feature = "window-system")]
+    pub fn has_horizontal_scroll_bar(self) -> bool {
+        use crate::remacs_sys::Qbottom;
+        if self.is_pseudo() || self.is_minibuffer_non_only() {
+            false
+        } else {
+            match self.horizontal_scroll_bar_type {
+                Qt => self.get_frame().horizontal_scroll_bars(),
+                Qbottom => true,
+                _ => false,
+            }
+        }
+    }
+    #[cfg(not(feature = "window-system"))]
+    pub fn has_horizontal_scroll_bar(self) -> bool {
+        false
+    }
+
+    /// Width of the scroll bar area of the window, measured in pixels.
+    pub fn scroll_bar_area_width(self) -> i32 {
+        if self.has_vertical_scroll_bar() {
+            self.config_scroll_bar_width()
+        } else {
+            0
+        }
+    }
+
+    /// Height of scroll bar area in the window, measured in pixels.
+    pub fn scroll_bar_area_height(self) -> i32 {
+        if self.has_horizontal_scroll_bar() {
+            self.config_scroll_bar_height()
+        } else {
+            0
+        }
+    }
+
+    /// Width of the bottom divider of the window
+    pub fn right_divider_width(self) -> i32 {
+        if !self.is_rightmost() {
+            self.get_frame().right_divider_width
+        } else {
+            0
+        }
+    }
+
+    /// Width of the window's bottom divider
+    pub fn bottom_divider_width(self) -> i32 {
+        if self.is_bottommost() && self.get_frame().root_window().next.is_not_nil()
+            || self.prev() == self.get_frame().root_window()
+            || self.is_pseudo()
+        {
+            0
+        } else {
+            self.get_frame().bottom_divider_width
+        }
+    }
+
+    /// Width that a scroll bar in window W should have, if there is one.
+    /// Measured in pixels.  If scroll bars are turned off, this is still
+    /// nonzero.
+    pub fn config_scroll_bar_width(self) -> i32 {
+        if self.scroll_bar_width >= 0 {
+            self.scroll_bar_width
+        } else {
+            self.get_frame().config_scroll_bar_width
+        }
+    }
+
+    /// Height that a scroll bar in window W should have, if there is one.
+    /// Measured in pixels.  If scroll bars are turned off, this is still
+    /// nonzero.
+    pub fn config_scroll_bar_height(self) -> i32 {
+        if self.scroll_bar_height >= 0 {
+            self.scroll_bar_height
+        } else {
+            self.get_frame().config_scroll_bar_height
+        }
+    }
 }
 
 impl From<LispObject> for LispWindowRef {
@@ -298,6 +581,13 @@ impl LispGlyphMatrixRef {
             unsafe { (*self.rows.offset((self.nrows - 1) as isize)).height }
         }
     }
+    pub fn header_line_height(self) -> i32 {
+        if self.is_null() || self.rows.is_null() {
+            0
+        } else {
+            unsafe { (*self.rows).height }
+        }
+    }
 }
 
 pub struct LispWindowOrSelected(LispObject);
@@ -356,6 +646,11 @@ impl From<LispWindowValidOrSelected> for LispWindowRef {
     }
 }
 
+#[no_mangle]
+pub extern "C" fn window_body_width(window: *mut Lisp_Window, pixelwise: bool) -> i32 {
+    LispWindowRef::new(window).body_width(pixelwise)
+}
+
 #[no_mangle]
 pub extern "C" fn decode_any_window(window: LispObject) -> LispWindowRef {
     LispWindowOrSelected::from(window).into()
@@ -981,7 +1276,7 @@ pub fn window_top_child(window: LispWindowValidOrSelected) -> Option<LispWindowR
 pub fn scroll_horizontally(arg: LispObject, set_minimum: LispObject, left: bool) -> LispObject {
     let mut w: LispWindowRef = selected_window().into();
     let requested_arg = if arg.is_nil() {
-        unsafe { EmacsInt::from(window_body_width(w.as_mut(), false)) - 2 }
+        EmacsInt::from(w.body_width(false)) - 2
     } else if left {
         prefix_numeric_value(arg)
     } else {
@@ -1205,4 +1500,39 @@ pub fn set_window_redisplay_end_trigger(
     value
 }
 
+/// Return the height of WINDOW's text area.
+/// WINDOW must be a live window and defaults to the selected one.  Optional
+/// argument PIXELWISE non-nil means return the height of WINDOW's text area
+/// in pixels.  The return value does not include the mode line or header
+/// line or any horizontal divider.
+///
+/// If PIXELWISE is nil, return the largest integer smaller than WINDOW's
+/// pixel height divided by the character height of WINDOW's frame.  This
+/// means that if a line at the bottom of the text area is only partially
+/// visible, that line is not counted.
+#[lisp_fn(min = "0")]
+pub fn window_body_height(window: LispWindowLiveOrSelected, pixelwise: bool) -> EmacsInt {
+    let window: LispWindowRef = window.into();
+    window.body_height(pixelwise).into()
+}
+
+/// Return the width of WINDOW's text area.
+/// WINDOW must be a live window and defaults to the selected one.  Optional
+/// argument PIXELWISE non-nil means return the width in pixels.  The return
+/// value does not include any vertical dividers, fringes or marginal areas,
+/// or scroll bars.
+///
+/// If PIXELWISE is nil, return the largest integer smaller than WINDOW's
+/// pixel width divided by the character width of WINDOW's frame.  This
+/// means that if a column at the right of the text area is only partially
+/// visible, that column is not counted.
+///
+/// Note that the returned value includes the column reserved for the
+/// continuation glyph.
+#[lisp_fn(name = "window-body-width", c_name = "window_body_width", min = "0")]
+pub fn window_body_width_lisp(window: LispWindowLiveOrSelected, pixelwise: bool) -> EmacsInt {
+    let window: LispWindowRef = window.into();
+    window.body_width(pixelwise).into()
+}
+
 include!(concat!(env!("OUT_DIR"), "/windows_exports.rs"));
diff --git a/src/window.c b/src/window.c
index aef079b9d5..a9a1a60fa1 100644
--- a/src/window.c
+++ b/src/window.c
@@ -551,94 +551,6 @@ WINDOW must be a valid window and defaults to the selected one.  */)
   return make_number (decode_valid_window (window)->left_col);
 }
 
-/* Return the number of lines/pixels of W's body.  Don't count any mode
-   or header line or horizontal divider of W.  Rounds down to nearest
-   integer when not working pixelwise. */
-static int
-window_body_height (struct window *w, bool pixelwise)
-{
-  int height = (w->pixel_height
-		- WINDOW_HEADER_LINE_HEIGHT (w)
-		- (WINDOW_HAS_HORIZONTAL_SCROLL_BAR (w)
-		   ? WINDOW_SCROLL_BAR_AREA_HEIGHT (w)
-		   : 0)
-		- WINDOW_MODE_LINE_HEIGHT (w)
-		- WINDOW_BOTTOM_DIVIDER_WIDTH (w));
-
-  /* Don't return a negative value.  */
-  return max (pixelwise
-	      ? height
-	      : height / FRAME_LINE_HEIGHT (WINDOW_XFRAME (w)),
-	      0);
-}
-
-/* Return the number of columns/pixels of W's body.  Don't count columns
-   occupied by the scroll bar or the divider/vertical bar separating W
-   from its right sibling or margins.  On window-systems don't count
-   fringes either.  Round down to nearest integer when not working
-   pixelwise.  */
-int
-window_body_width (struct window *w, bool pixelwise)
-{
-  struct frame *f = XFRAME (WINDOW_FRAME (w));
-
-  int width = (w->pixel_width
-	       - WINDOW_RIGHT_DIVIDER_WIDTH (w)
-	       - (WINDOW_HAS_VERTICAL_SCROLL_BAR (w)
-		  ? WINDOW_SCROLL_BAR_AREA_WIDTH (w)
-		  : (/* A vertical bar is either 1 or 0.  */
-		     !FRAME_WINDOW_P (f)
-		     && !WINDOW_RIGHTMOST_P (w)
-		     && !WINDOW_RIGHT_DIVIDER_WIDTH (w)))
-		- WINDOW_MARGINS_WIDTH (w)
-		- (FRAME_WINDOW_P (f)
-		   ? WINDOW_FRINGES_WIDTH (w)
-		   : 0));
-
-  /* Don't return a negative value.  */
-  return max (pixelwise
-	      ? width
-	      : width / FRAME_COLUMN_WIDTH (WINDOW_XFRAME (w)),
-	      0);
-}
-
-DEFUN ("window-body-height", Fwindow_body_height, Swindow_body_height, 0, 2, 0,
-       doc: /* Return the height of WINDOW's text area.
-WINDOW must be a live window and defaults to the selected one.  Optional
-argument PIXELWISE non-nil means return the height of WINDOW's text area
-in pixels.  The return value does not include the mode line or header
-line or any horizontal divider.
-
-If PIXELWISE is nil, return the largest integer smaller than WINDOW's
-pixel height divided by the character height of WINDOW's frame.  This
-means that if a line at the bottom of the text area is only partially
-visible, that line is not counted.  */)
-  (Lisp_Object window, Lisp_Object pixelwise)
-{
-  return make_number (window_body_height (decode_live_window (window),
-					  !NILP (pixelwise)));
-}
-
-DEFUN ("window-body-width", Fwindow_body_width, Swindow_body_width, 0, 2, 0,
-       doc: /* Return the width of WINDOW's text area.
-WINDOW must be a live window and defaults to the selected one.  Optional
-argument PIXELWISE non-nil means return the width in pixels.  The return
-value does not include any vertical dividers, fringes or marginal areas,
-or scroll bars.
-
-If PIXELWISE is nil, return the largest integer smaller than WINDOW's
-pixel width divided by the character width of WINDOW's frame.  This
-means that if a column at the right of the text area is only partially
-visible, that column is not counted.
-
-Note that the returned value includes the column reserved for the
-continuation glyph.  */)
-  (Lisp_Object window, Lisp_Object pixelwise)
-{
-  return make_number (window_body_width (decode_live_window (window),
-					 !NILP (pixelwise)));
-}
-
 DEFUN ("window-mode-line-height", Fwindow_mode_line_height,
        Swindow_mode_line_height, 0, 1, 0,
        doc: /* Return the height in pixels of WINDOW's mode-line.
@@ -6662,8 +6574,6 @@ displayed after a scrolling operation to be somewhat inaccurate.  */);
   defsubr (&Sset_window_new_normal);
   defsubr (&Swindow_resize_apply);
   defsubr (&Swindow_resize_apply_total);
-  defsubr (&Swindow_body_height);
-  defsubr (&Swindow_body_width);
   defsubr (&Sset_window_hscroll);
   defsubr (&Swindow_mode_line_height);
   defsubr (&Swindow_header_line_height);
-- 
2.21.0


From b103d0b7f39f21cec5272852ff02a9991872ccb2 Mon Sep 17 00:00:00 2001
From: Daichi Mukai <mukai.daichi.37e@kyoto-u.jp>
Date: Fri, 25 Jan 2019 00:36:04 +0900
Subject: [PATCH 236/297] Set up 'workspace' section in cargo config (#1281)

remacs-lib, remacs-util and remacs-macros are now members of the remacs workspace. These crates share the same Cargo.lock, output directory and profiles. We drop lto = true option until we start to self-host this project as a Rust crate.

Closes #1254.
---
 lib-src/Makefile.in               |   2 +-
 rust_src/Cargo.toml.in            |   4 +
 rust_src/remacs-lib/Cargo.lock    | 300 ------------------------------
 rust_src/remacs-lib/Cargo.toml    |   8 -
 rust_src/remacs-macros/Cargo.toml |   6 -
 rust_src/remacs-util/Cargo.lock   | 143 --------------
 rust_src/remacs-util/Cargo.toml   |   8 -
 7 files changed, 5 insertions(+), 466 deletions(-)
 delete mode 100644 rust_src/remacs-lib/Cargo.lock
 delete mode 100644 rust_src/remacs-util/Cargo.lock

diff --git a/lib-src/Makefile.in b/lib-src/Makefile.in
index 6d9d56702b..89aea9aac3 100644
--- a/lib-src/Makefile.in
+++ b/lib-src/Makefile.in
@@ -193,7 +193,7 @@ SCRIPTS= rcs2log
 EXE_FILES = ${INSTALLABLES} ${UTILITIES} ${DONT_INSTALL}
 
 # Rust files to be linked as part of the executables
-RUST_ARCHIVE = ../rust_src/remacs-lib/target/$(CARGO_BUILD_DIR)/$(REMACSLIB_NAME)
+RUST_ARCHIVE = ../rust_src/target/$(CARGO_BUILD_DIR)/$(REMACSLIB_NAME)
 RUST_LIB = $(RUST_ARCHIVE) @RUST_DEPS@
 
 # Specify additional -D flags for movemail. Options:
diff --git a/rust_src/Cargo.toml.in b/rust_src/Cargo.toml.in
index 40c1675864..5901574c6f 100644
--- a/rust_src/Cargo.toml.in
+++ b/rust_src/Cargo.toml.in
@@ -9,6 +9,10 @@ version = "0.1.0"
 build = "build.rs"
 edition = "2018"
 
+[workspace]
+members = ["remacs-lib", "remacs-macros", "remacs-util"]
+exclude = ["remacs-bindings", "alloc_unexecmacosx"]
+
 [dependencies]
 remacs-lib = { version = "0.1.0", path = "remacs-lib" }
 remacs-macros = { version = "0.1.0", path = "remacs-macros" }
diff --git a/rust_src/remacs-lib/Cargo.lock b/rust_src/remacs-lib/Cargo.lock
deleted file mode 100644
index f5da502d7d..0000000000
--- a/rust_src/remacs-lib/Cargo.lock
+++ /dev/null
@@ -1,300 +0,0 @@
-[[package]]
-name = "aho-corasick"
-version = "0.6.9"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "bitflags"
-version = "1.0.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "cfg-if"
-version = "0.1.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "darling"
-version = "0.2.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "darling_core 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "darling_macro 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "darling_core"
-version = "0.2.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
- "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "darling_macro"
-version = "0.2.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "darling_core 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
- "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "errno"
-version = "0.2.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "errno-dragonfly 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "errno-dragonfly"
-version = "0.1.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "gcc 0.3.55 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "fuchsia-zircon"
-version = "0.3.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "fuchsia-zircon-sys"
-version = "0.3.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "gcc"
-version = "0.3.55"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "ident_case"
-version = "1.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "lazy_static"
-version = "1.2.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "libc"
-version = "0.2.47"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "memchr"
-version = "2.1.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "version_check 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "quote"
-version = "0.3.15"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "rand"
-version = "0.4.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "rdrand 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "rand_core"
-version = "0.3.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "rdrand"
-version = "0.4.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "redox_syscall"
-version = "0.1.50"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "regex"
-version = "1.1.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)",
- "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex-syntax 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "regex-syntax"
-version = "0.6.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "ucd-util 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "remacs-lib"
-version = "0.1.0"
-dependencies = [
- "darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "rand 0.4.5 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "remacs-util 0.1.0",
- "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
- "time 0.1.42 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "remacs-util"
-version = "0.1.0"
-dependencies = [
- "darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "syn"
-version = "0.11.11"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
- "synom 0.11.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "unicode-xid 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "synom"
-version = "0.11.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "unicode-xid 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "thread_local"
-version = "0.3.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "time"
-version = "0.1.42"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "redox_syscall 0.1.50 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "ucd-util"
-version = "0.1.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "unicode-xid"
-version = "0.0.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "utf8-ranges"
-version = "1.0.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "version_check"
-version = "0.1.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "winapi"
-version = "0.3.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "winapi-i686-pc-windows-gnu"
-version = "0.4.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "winapi-x86_64-pc-windows-gnu"
-version = "0.4.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[metadata]
-"checksum aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)" = "1e9a933f4e58658d7b12defcf96dc5c720f20832deebe3e0a19efd3b6aaeeb9e"
-"checksum bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "228047a76f468627ca71776ecdebd732a3423081fcf5125585bcd7c49886ce12"
-"checksum cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)" = "082bb9b28e00d3c9d39cc03e64ce4cea0f1bb9b3fde493f0cbc008472d22bdf4"
-"checksum darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "1630fdbe3554154a50624487c79b0140a424e87dc08061db1a2211359792acab"
-"checksum darling_core 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "d12d2eeb837786ace70b6bca9adfeaef4352cc68d6a42e8e3d0c4159bbca7ab2"
-"checksum darling_macro 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "01581bdeabb86f69970dbd9e6ee3c61963f9a7321169589e3dffa16033c0928c"
-"checksum errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)" = "c2a071601ed01b988f896ab14b95e67335d1eeb50190932a1320f7fe3cadc84e"
-"checksum errno-dragonfly 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "14ca354e36190500e1e1fb267c647932382b54053c50b14970856c0b00a35067"
-"checksum fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "2e9763c69ebaae630ba35f74888db465e49e259ba1bc0eda7d06f4a067615d82"
-"checksum fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "3dcaa9ae7725d12cdb85b3ad99a434db70b468c09ded17e012d86b5c1010f7a7"
-"checksum gcc 0.3.55 (registry+https://github.com/rust-lang/crates.io-index)" = "8f5f3913fa0bfe7ee1fd8248b6b9f42a5af4b9d65ec2dd2c3c26132b950ecfc2"
-"checksum ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3c9826188e666f2ed92071d2dadef6edc430b11b158b5b2b3f4babbcc891eaaa"
-"checksum lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "a374c89b9db55895453a74c1e38861d9deec0b01b405a82516e9d5de4820dea1"
-"checksum libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)" = "48450664a984b25d5b479554c29cc04e3150c97aa4c01da5604a2d4ed9151476"
-"checksum memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "db4c41318937f6e76648f42826b1d9ade5c09cafb5aef7e351240a70f39206e9"
-"checksum quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)" = "7a6e920b65c65f10b2ae65c831a81a073a89edd28c7cce89475bff467ab4167a"
-"checksum rand 0.4.5 (registry+https://github.com/rust-lang/crates.io-index)" = "dee497e66d8d76bf08ce20c8d36e16f93749ab0bf89975b4f8ae5cee660c2da2"
-"checksum rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)" = "0905b6b7079ec73b314d4c748701f6931eb79fd97c668caa3f1899b22b32c6db"
-"checksum rdrand 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "678054eb77286b51581ba43620cc911abf02758c91f93f479767aed0f90458b2"
-"checksum redox_syscall 0.1.50 (registry+https://github.com/rust-lang/crates.io-index)" = "52ee9a534dc1301776eff45b4fa92d2c39b1d8c3d3357e6eb593e0d795506fc2"
-"checksum regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)" = "37e7cbbd370869ce2e8dff25c7018702d10b21a20ef7135316f8daecd6c25b7f"
-"checksum regex-syntax 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)" = "4e47a2ed29da7a9e1960e1639e7a982e6edc6d49be308a3b02daf511504a16d1"
-"checksum syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)" = "d3b891b9015c88c576343b9b3e41c2c11a51c219ef067b264bd9c8aa9b441dad"
-"checksum synom 0.11.3 (registry+https://github.com/rust-lang/crates.io-index)" = "a393066ed9010ebaed60b9eafa373d4b1baac186dd7e008555b0f702b51945b6"
-"checksum thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "c6b53e329000edc2b34dbe8545fd20e55a333362d0a321909685a19bd28c3f1b"
-"checksum time 0.1.42 (registry+https://github.com/rust-lang/crates.io-index)" = "db8dcfca086c1143c9270ac42a2bbd8a7ee477b78ac8e45b19abfb0cbede4b6f"
-"checksum ucd-util 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "535c204ee4d8434478593480b8f86ab45ec9aae0e83c568ca81abf0fd0e88f86"
-"checksum unicode-xid 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "8c1f860d7d29cf02cb2f3f359fd35991af3d30bac52c57d265a3c461074cb4dc"
-"checksum utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)" = "796f7e48bef87609f7ade7e06495a87d5cd06c7866e6a5cbfceffc558a243737"
-"checksum version_check 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)" = "914b1a6776c4c929a602fafd8bc742e06365d4bcbe48c30f9cca5824f70dc9dd"
-"checksum winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "92c1eb33641e276cfa214a0522acad57be5c56b10cb348b3c5117db75f3ac4b0"
-"checksum winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ac3b87c63620426dd9b991e5ce0329eff545bccbbb34f3be09ff6fb6ab51b7b6"
-"checksum winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "712e227841d057c1ee1cd2fb22fa7e5a5461ae8e48fa2ca79ec42cfc1931183f"
diff --git a/rust_src/remacs-lib/Cargo.toml b/rust_src/remacs-lib/Cargo.toml
index 211d72d617..7dec235876 100644
--- a/rust_src/remacs-lib/Cargo.toml
+++ b/rust_src/remacs-lib/Cargo.toml
@@ -21,11 +21,3 @@ crate-type = ["staticlib", "rlib"]
 [features]
 # Treat warnings as a build error on Travis.
 strict = []
-
-[profile.release]
-panic = "abort"
-lto = true
-
-[profile.dev]
-panic = "abort"
-lto = true
diff --git a/rust_src/remacs-macros/Cargo.toml b/rust_src/remacs-macros/Cargo.toml
index 8ae6c5ed12..d9683584dd 100644
--- a/rust_src/remacs-macros/Cargo.toml
+++ b/rust_src/remacs-macros/Cargo.toml
@@ -17,9 +17,3 @@ lazy_static = "1.0"
 
 [dev-dependencies]
 syn = { version = "0.13.1", features = ["full"] }
-
-[profile.release]
-panic = "abort"
-
-[profile.dev]
-panic = "abort"
diff --git a/rust_src/remacs-util/Cargo.lock b/rust_src/remacs-util/Cargo.lock
deleted file mode 100644
index c59bbc9b70..0000000000
--- a/rust_src/remacs-util/Cargo.lock
+++ /dev/null
@@ -1,143 +0,0 @@
-[[package]]
-name = "darling"
-version = "0.2.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "darling_core 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "darling_macro 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "darling_core"
-version = "0.2.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
- "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "darling_macro"
-version = "0.2.2"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "darling_core 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
- "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "errno"
-version = "0.2.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "errno-dragonfly 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "errno-dragonfly"
-version = "0.1.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "gcc 0.3.55 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "gcc"
-version = "0.3.55"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "ident_case"
-version = "1.0.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "lazy_static"
-version = "1.2.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "libc"
-version = "0.2.47"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "quote"
-version = "0.3.15"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "remacs-util"
-version = "0.1.0"
-dependencies = [
- "darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "syn"
-version = "0.11.11"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)",
- "synom 0.11.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "unicode-xid 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "synom"
-version = "0.11.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "unicode-xid 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "unicode-xid"
-version = "0.0.4"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "winapi"
-version = "0.3.6"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "winapi-i686-pc-windows-gnu"
-version = "0.4.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[[package]]
-name = "winapi-x86_64-pc-windows-gnu"
-version = "0.4.0"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
-[metadata]
-"checksum darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "1630fdbe3554154a50624487c79b0140a424e87dc08061db1a2211359792acab"
-"checksum darling_core 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "d12d2eeb837786ace70b6bca9adfeaef4352cc68d6a42e8e3d0c4159bbca7ab2"
-"checksum darling_macro 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "01581bdeabb86f69970dbd9e6ee3c61963f9a7321169589e3dffa16033c0928c"
-"checksum errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)" = "c2a071601ed01b988f896ab14b95e67335d1eeb50190932a1320f7fe3cadc84e"
-"checksum errno-dragonfly 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "14ca354e36190500e1e1fb267c647932382b54053c50b14970856c0b00a35067"
-"checksum gcc 0.3.55 (registry+https://github.com/rust-lang/crates.io-index)" = "8f5f3913fa0bfe7ee1fd8248b6b9f42a5af4b9d65ec2dd2c3c26132b950ecfc2"
-"checksum ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3c9826188e666f2ed92071d2dadef6edc430b11b158b5b2b3f4babbcc891eaaa"
-"checksum lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "a374c89b9db55895453a74c1e38861d9deec0b01b405a82516e9d5de4820dea1"
-"checksum libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)" = "48450664a984b25d5b479554c29cc04e3150c97aa4c01da5604a2d4ed9151476"
-"checksum quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)" = "7a6e920b65c65f10b2ae65c831a81a073a89edd28c7cce89475bff467ab4167a"
-"checksum syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)" = "d3b891b9015c88c576343b9b3e41c2c11a51c219ef067b264bd9c8aa9b441dad"
-"checksum synom 0.11.3 (registry+https://github.com/rust-lang/crates.io-index)" = "a393066ed9010ebaed60b9eafa373d4b1baac186dd7e008555b0f702b51945b6"
-"checksum unicode-xid 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "8c1f860d7d29cf02cb2f3f359fd35991af3d30bac52c57d265a3c461074cb4dc"
-"checksum winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "92c1eb33641e276cfa214a0522acad57be5c56b10cb348b3c5117db75f3ac4b0"
-"checksum winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ac3b87c63620426dd9b991e5ce0329eff545bccbbb34f3be09ff6fb6ab51b7b6"
-"checksum winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "712e227841d057c1ee1cd2fb22fa7e5a5461ae8e48fa2ca79ec42cfc1931183f"
diff --git a/rust_src/remacs-util/Cargo.toml b/rust_src/remacs-util/Cargo.toml
index edf1fa00e0..330126ddb0 100644
--- a/rust_src/remacs-util/Cargo.toml
+++ b/rust_src/remacs-util/Cargo.toml
@@ -16,11 +16,3 @@ path = "lib.rs"
 [features]
 # Treat warnings as a build error on Travis.
 strict = []
-
-[profile.release]
-panic = "abort"
-lto = true
-
-[profile.dev]
-panic = "abort"
-lto = true
-- 
2.21.0


From cf3199270661048c15c476c8e1a538d4133be09d Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Thu, 24 Jan 2019 07:37:34 -0800
Subject: [PATCH 237/297] Handle invalid byte sequence better. (#1275)

Refactor while we are here.

Closes: #1267
---
 rust_src/src/dired_unix.rs | 48 +++++++++++++++++++++++---------------
 1 file changed, 29 insertions(+), 19 deletions(-)

diff --git a/rust_src/src/dired_unix.rs b/rust_src/src/dired_unix.rs
index 6e3bc85a2f..d5cc702352 100644
--- a/rust_src/src/dired_unix.rs
+++ b/rust_src/src/dired_unix.rs
@@ -215,41 +215,51 @@ fn fattrs_from_os(
 }
 
 fn fnames_from_os(fnames: &mut Vec<String>, dname: &str, match_re: Option<LispObject>) {
-    let res = read_dir(dname, fnames, match_re);
-    if res.is_err() {
-        xsignal!(
-            Qfile_missing,
-            format!("Opening directory: {}", res.unwrap_err()).to_bstring(),
-            dname
-        );
+    match read_dir(dname, fnames, match_re) {
+        Ok(_) => {}
+        Err(err) => {
+            xsignal!(
+                Qfile_missing,
+                format!("Opening directory: {}", err).to_bstring(),
+                dname
+            );
+        }
     }
 }
 
 fn read_dir(dname: &str, fnames: &mut Vec<String>, match_re: Option<LispObject>) -> io::Result<()> {
     let dir_p = Path::new(dname);
 
-    let mut re = RegEx::new(String::from("").to_bstring());
-    if let Some(x) = match_re {
-        re = RegEx::new(x);
-    }
+    let re = match match_re {
+        Some(x) => Some(RegEx::new(x)),
+        None => None,
+    };
 
     let dot = String::from(".");
-    if match_re_maybe(dot.to_owned(), match_re, &re).is_some() {
+    if match_re_maybe(dot.to_owned(), &re).is_some() {
         fnames.push(dot);
     }
     let dotdot = String::from("..");
-    if match_re_maybe(dotdot.to_owned(), match_re, &re).is_some() {
+    if match_re_maybe(dotdot.to_owned(), &re).is_some() {
         fnames.push(dotdot);
     }
 
     for fname in fs::read_dir(dir_p)? {
         let fname = fname?;
-        let f_enc = fname.file_name().into_string().unwrap();
+        let f_enc = match fname.file_name().into_string() {
+            Ok(file_name) => file_name,
+            Err(err) => {
+                return Err(io::Error::new(
+                    io::ErrorKind::InvalidInput,
+                    format!("Could not decode {:?}", err),
+                ));
+            }
+        };
         let f_enc_lo = LispObject::from(f_enc.as_str()); // encoded
         let f_dec_lo = unsafe { decode_file_name(f_enc_lo) }; // decoded
         let f = f_dec_lo.to_stdstring();
 
-        if match_re_maybe(f.to_owned(), match_re, &re).is_some() {
+        if match_re_maybe(f.to_owned(), &re).is_some() {
             fnames.push(f);
         }
     }
@@ -257,10 +267,10 @@ fn read_dir(dname: &str, fnames: &mut Vec<String>, match_re: Option<LispObject>)
     Ok(())
 }
 
-fn match_re_maybe(f: String, match_re: Option<LispObject>, re: &RegEx) -> Option<String> {
-    match match_re {
-        Some(_) => {
-            if re.is_match(f.as_str()) {
+fn match_re_maybe(f: String, re: &Option<RegEx>) -> Option<String> {
+    match re {
+        Some(re_value) => {
+            if re_value.is_match(f.as_str()) {
                 Some(f)
             } else {
                 None
-- 
2.21.0


From af431fb87119572c52055b01340c9c7b899d3788 Mon Sep 17 00:00:00 2001
From: Georgy Komarov <jubnzv@gmail.com>
Date: Fri, 25 Jan 2019 03:39:29 +0300
Subject: [PATCH 238/297] Port x_focus_frame (#1269)

---
 rust_src/src/frames.rs | 20 +++++++++++++++++++-
 src/frame.c            | 16 ----------------
 2 files changed, 19 insertions(+), 17 deletions(-)

diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index eb156fcf7d..dbc6b0da19 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -15,7 +15,7 @@ use crate::{
 };
 
 #[cfg(feature = "window-system")]
-use crate::remacs_sys::vertical_scroll_bar_type;
+use crate::{remacs_sys::vertical_scroll_bar_type, remacs_sys::x_focus_frame as c_x_focus_frame};
 
 pub type LispFrameRef = ExternalPtr<Lisp_Frame>;
 
@@ -609,4 +609,22 @@ pub fn frame_focus(frame: LispFrameLiveOrSelected) -> LispObject {
     frame_ref.focus_frame
 }
 
+/// Set the input focus to FRAME.
+/// FRAME nil means use the selected frame. Optional argument NOACTIVATE
+/// means do not activate FRAME.
+///
+/// If there is no window system support, this function does nothing.
+#[lisp_fn(min = "1")]
+pub fn x_focus_frame(_frame: LispFrameLiveOrSelected, _noactivate: bool) -> LispObject {
+    #[cfg(feature = "window-system")]
+    {
+        let mut frame_ref: LispFrameRef = _frame.into();
+        unsafe {
+            c_x_focus_frame(frame_ref.as_mut(), _noactivate);
+        }
+    }
+
+    Qnil
+}
+
 include!(concat!(env!("OUT_DIR"), "/frames_exports.rs"));
diff --git a/src/frame.c b/src/frame.c
index 35ea4a2740..edd3e2afce 100644
--- a/src/frame.c
+++ b/src/frame.c
@@ -2477,21 +2477,6 @@ The redirection lasts until `redirect-frame-focus' is called to change it.  */)
   return Qnil;
 }
 
-
-DEFUN ("x-focus-frame", Fx_focus_frame, Sx_focus_frame, 1, 2, 0,
-       doc: /* Set the input focus to FRAME.
-FRAME nil means use the selected frame.  Optional argument NOACTIVATE
-means do not activate FRAME.
-
-If there is no window system support, this function does nothing.  */)
-     (Lisp_Object frame, Lisp_Object noactivate)
-{
-#ifdef HAVE_WINDOW_SYSTEM
-  x_focus_frame (decode_window_system_frame (frame), !NILP (noactivate));
-#endif
-  return Qnil;
-}
-
 
 /* Discard BUFFER from the buffer-list and buried-buffer-list of each frame.  */
 
@@ -5673,7 +5658,6 @@ iconify the top level frame instead.  */);
   defsubr (&Svisible_frame_list);
   defsubr (&Sraise_frame);
   defsubr (&Slower_frame);
-  defsubr (&Sx_focus_frame);
   defsubr (&Sredirect_frame_focus);
   defsubr (&Sframe_parameters);
   defsubr (&Sframe_parameter);
-- 
2.21.0


From 636937876f5f0ea0e134ded95f43bdcadcf362c2 Mon Sep 17 00:00:00 2001
From: Daichi Mukai <mukai.daichi.37e@kyoto-u.jp>
Date: Fri, 25 Jan 2019 11:43:50 +0900
Subject: [PATCH 239/297] Fix mistake in porting
 `error-command-default-function` (#1285)

We dropped `!` at the beginning of if clause.
---
 rust_src/src/keyboard.rs | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/rust_src/src/keyboard.rs b/rust_src/src/keyboard.rs
index 480f65a3ca..624797d64a 100644
--- a/rust_src/src/keyboard.rs
+++ b/rust_src/src/keyboard.rs
@@ -237,7 +237,7 @@ pub fn command_error_default_function(
     // If the window system or terminal frame hasn't been initialized
     // yet, or we're not interactive, write the message to stderr and
     // exit.
-    if selected_frame.glyphs_initialized_p()
+    if !selected_frame.glyphs_initialized_p()
         // The initial frame is a special non-displaying frame. It
         // will be current in daemon mode when there are no frames to
         // display, and in non-daemon mode before the real frame has
-- 
2.21.0


From d4e7bcef41809514e05ac1fc2bb4d398df9d6213 Mon Sep 17 00:00:00 2001
From: Nick Drozd <nicholasdrozd@gmail.com>
Date: Fri, 25 Jan 2019 08:26:01 -0600
Subject: [PATCH 240/297] Use impl notation for generics (#1277)

---
 rust_src/build.rs          |  5 +---
 rust_src/src/crypto/mod.rs |  5 +---
 rust_src/src/editfns.rs    |  9 ++++---
 rust_src/src/eval.rs       |  9 ++++---
 rust_src/src/floatfns.rs   |  9 +++----
 rust_src/src/frames.rs     |  4 +--
 rust_src/src/lisp.rs       | 28 ++++++-------------
 rust_src/src/lists.rs      | 55 ++++++++++++++++++--------------------
 8 files changed, 51 insertions(+), 73 deletions(-)

diff --git a/rust_src/build.rs b/rust_src/build.rs
index 44184e1b39..08956292f4 100644
--- a/rust_src/build.rs
+++ b/rust_src/build.rs
@@ -126,10 +126,7 @@ impl<'a> ModuleParser<'a> {
         }
     }
 
-    pub fn run<R>(&mut self, in_file: R) -> Result<ModuleData, BuildError>
-    where
-        R: BufRead,
-    {
+    pub fn run(&mut self, in_file: impl BufRead) -> Result<ModuleData, BuildError> {
         let mut mod_data = ModuleData::new(self.info.clone());
         let mut reader = in_file.lines();
         let mut has_include = false;
diff --git a/rust_src/src/crypto/mod.rs b/rust_src/src/crypto/mod.rs
index eaf44b4c56..5e86ae72ef 100755
--- a/rust_src/src/crypto/mod.rs
+++ b/rust_src/src/crypto/mod.rs
@@ -205,10 +205,7 @@ fn sha1_buffer(buffer: &[u8], dest_buf: &mut [u8]) {
 }
 
 /// Given an instance of `Digest`, and `buffer` write its hash to `dest_buf`.
-fn sha2_hash_buffer<D>(hasher: D, buffer: &[u8], dest_buf: &mut [u8])
-where
-    D: Digest,
-{
+fn sha2_hash_buffer(hasher: impl Digest, buffer: &[u8], dest_buf: &mut [u8]) {
     let mut hasher = hasher;
     hasher.input(buffer);
     let output = hasher.result();
diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index 47a504fdc0..4b1a23b1a3 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -1385,10 +1385,11 @@ pub fn delete_and_extract_region(
     }
 }
 
-fn time_arith<F>(a: LispObject, b: LispObject, op: F) -> Vec<EmacsInt>
-where
-    F: FnOnce(LispTime, LispTime) -> LispTime,
-{
+fn time_arith(
+    a: LispObject,
+    b: LispObject,
+    op: impl FnOnce(LispTime, LispTime) -> LispTime,
+) -> Vec<EmacsInt> {
     let mut alen: c_int = 0;
     let mut blen: c_int = 0;
     let ta = unsafe { lisp_time_struct(a, &mut alen) };
diff --git a/rust_src/src/eval.rs b/rust_src/src/eval.rs
index 41bcb7c920..3e3424bec1 100644
--- a/rust_src/src/eval.rs
+++ b/rust_src/src/eval.rs
@@ -114,10 +114,11 @@ pub fn and(args: LispObject) -> LispObject {
 
 /// Eval each item in ARGS and then compare it using CMP.
 /// INITIAL is returned if the list has no cons cells.
-fn eval_and_compare_all<CmpFunc>(args: LispObject, initial: LispObject, cmp: CmpFunc) -> LispObject
-where
-    CmpFunc: Fn(LispObject, LispObject) -> bool,
-{
+fn eval_and_compare_all(
+    args: LispObject,
+    initial: LispObject,
+    cmp: impl Fn(LispObject, LispObject) -> bool,
+) -> LispObject {
     let mut val = initial;
 
     for elt in args.iter_cars(LispConsEndChecks::off, LispConsCircularChecks::off) {
diff --git a/rust_src/src/floatfns.rs b/rust_src/src/floatfns.rs
index bce8172f5c..347125aac7 100644
--- a/rust_src/src/floatfns.rs
+++ b/rust_src/src/floatfns.rs
@@ -400,16 +400,13 @@ pub fn truncate(arg: LispObject, divisor: LispObject) -> EmacsInt {
     rounding_driver(arg, divisor, |x| x.trunc(), truncate2, "truncate")
 }
 
-fn rounding_driver<F>(
+fn rounding_driver(
     arg: LispObject,
     divisor: LispObject,
-    double_round: F,
+    double_round: impl Fn(f64) -> f64,
     int_round2: fn(EmacsInt, EmacsInt) -> EmacsInt,
     name: &str,
-) -> EmacsInt
-where
-    F: Fn(f64) -> f64,
-{
+) -> EmacsInt {
     let d;
     if divisor.is_nil() {
         if arg.is_fixnum() {
diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index dbc6b0da19..c82774accf 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -207,9 +207,9 @@ pub fn window_frame_live_or_selected(object: LispObject) -> LispFrameRef {
 /// Get the live frame either from the passed in object directly, from the object
 /// as a window, or by using the selected window when object is nil.
 /// When the object is a window the provided `window_action` is called.
-pub fn window_frame_live_or_selected_with_action<W: FnMut(LispWindowRef) -> ()>(
+pub fn window_frame_live_or_selected_with_action(
     mut object: LispObject,
-    mut window_action: W,
+    mut window_action: impl FnMut(LispWindowRef) -> (),
 ) -> LispFrameRef {
     if object.is_nil() {
         object = selected_window();
diff --git a/rust_src/src/lisp.rs b/rust_src/src/lisp.rs
index 18f43bdb91..3b94fef273 100644
--- a/rust_src/src/lisp.rs
+++ b/rust_src/src/lisp.rs
@@ -558,17 +558,11 @@ impl LispObject {
 
     // The three Emacs Lisp comparison functions.
 
-    pub fn eq<T>(self, other: T) -> bool
-    where
-        T: Into<LispObject>,
-    {
+    pub fn eq(self, other: impl Into<LispObject>) -> bool {
         self == other.into()
     }
 
-    pub fn eql<T>(self, other: T) -> bool
-    where
-        T: Into<LispObject>,
-    {
+    pub fn eql(self, other: impl Into<LispObject>) -> bool {
         if self.is_float() {
             self.equal_no_quit(other)
         } else {
@@ -576,10 +570,7 @@ impl LispObject {
         }
     }
 
-    pub fn equal<T>(self, other: T) -> bool
-    where
-        T: Into<LispObject>,
-    {
+    pub fn equal(self, other: impl Into<LispObject>) -> bool {
         let mut ht = LispHashTableRef::empty();
         self.equal_internal(other.into(), equal_kind::EQUAL_PLAIN, 0, &mut ht)
     }
@@ -671,10 +662,7 @@ impl LispObject {
         }
     }
 
-    pub fn equal_no_quit<T>(self, other: T) -> bool
-    where
-        T: Into<LispObject>,
-    {
+    pub fn equal_no_quit(self, other: impl Into<LispObject>) -> bool {
         let mut ht = LispHashTableRef::empty();
         self.equal_internal(other.into(), equal_kind::EQUAL_NO_QUIT, 0, &mut ht)
     }
@@ -683,7 +671,7 @@ impl LispObject {
         FUNCTIONP(self)
     }
 
-    pub fn map_or<T, F: FnOnce(LispObject) -> T>(self, default: T, action: F) -> T {
+    pub fn map_or<T>(self, default: T, action: impl FnOnce(LispObject) -> T) -> T {
         if self.is_nil() {
             default
         } else {
@@ -691,10 +679,10 @@ impl LispObject {
         }
     }
 
-    pub fn map_or_else<T, F: FnOnce() -> T, F1: FnOnce(LispObject) -> T>(
+    pub fn map_or_else<T>(
         self,
-        default: F,
-        action: F1,
+        default: impl FnOnce() -> T,
+        action: impl FnOnce(LispObject) -> T,
     ) -> T {
         if self.is_nil() {
             default()
diff --git a/rust_src/src/lists.rs b/rust_src/src/lists.rs
index 1671c473f2..d78e2240a2 100644
--- a/rust_src/src/lists.rs
+++ b/rust_src/src/lists.rs
@@ -70,7 +70,7 @@ impl Debug for LispCons {
 }
 
 impl LispObject {
-    pub fn cons<A: Into<LispObject>, D: Into<LispObject>>(car: A, cdr: D) -> Self {
+    pub fn cons(car: impl Into<LispObject>, cdr: impl Into<LispObject>) -> Self {
         unsafe { Fcons(car.into(), cdr.into()) }
     }
 
@@ -324,14 +324,14 @@ impl LispCons {
     }
 
     /// Set the car of the cons cell.
-    pub fn set_car<T: Into<LispObject>>(self, n: T) {
+    pub fn set_car(self, n: impl Into<LispObject>) {
         unsafe {
             (*self._extract()).u.s.as_mut().car = n.into();
         }
     }
 
     /// Set the car of the cons cell.
-    pub fn set_cdr<T: Into<LispObject>>(self, n: T) {
+    pub fn set_cdr(self, n: impl Into<LispObject>) {
         unsafe {
             (*self._extract()).u.s.as_mut().u.cdr = n.into();
         }
@@ -532,10 +532,11 @@ pub fn nth(n: EmacsInt, list: LispObject) -> LispObject {
     car(nthcdr(n, list))
 }
 
-fn lookup_member<CmpFunc>(elt: LispObject, list: LispObject, cmp: CmpFunc) -> LispObject
-where
-    CmpFunc: Fn(LispObject, LispObject) -> bool,
-{
+fn lookup_member(
+    elt: LispObject,
+    list: LispObject,
+    cmp: impl Fn(LispObject, LispObject) -> bool,
+) -> LispObject {
     list.iter_tails(LispConsEndChecks::on, LispConsCircularChecks::on)
         .find(|item| cmp(elt, item.car()))
         .into()
@@ -565,10 +566,11 @@ pub fn member(elt: LispObject, list: LispObject) -> LispObject {
     lookup_member(elt, list, LispObject::equal)
 }
 
-fn assoc_impl<CmpFunc>(key: LispObject, list: LispObject, cmp: CmpFunc) -> LispObject
-where
-    CmpFunc: Fn(LispObject, LispObject) -> bool,
-{
+fn assoc_impl(
+    key: LispObject,
+    list: LispObject,
+    cmp: impl Fn(LispObject, LispObject) -> bool,
+) -> LispObject {
     list.iter_cars(LispConsEndChecks::on, LispConsCircularChecks::on)
         .find(|item| item.as_cons().map_or(false, |cons| cmp(key, cons.car())))
         .unwrap_or(Qnil)
@@ -595,10 +597,11 @@ pub fn assoc(key: LispObject, list: LispObject, testfn: LispObject) -> LispObjec
     }
 }
 
-fn rassoc_impl<CmpFunc>(key: LispObject, list: LispObject, cmp: CmpFunc) -> LispObject
-where
-    CmpFunc: Fn(LispObject, LispObject) -> bool,
-{
+fn rassoc_impl(
+    key: LispObject,
+    list: LispObject,
+    cmp: impl Fn(LispObject, LispObject) -> bool,
+) -> LispObject {
     list.iter_cars(LispConsEndChecks::on, LispConsCircularChecks::on)
         .find(|item| item.as_cons().map_or(false, |cons| cmp(key, cons.cdr())))
         .unwrap_or(Qnil)
@@ -679,16 +682,13 @@ pub fn lax_plist_get(plist: LispObject, prop: LispObject) -> LispObject {
     )
 }
 
-fn internal_plist_get<CmpFunc>(
+fn internal_plist_get(
     plist: LispObject,
     prop: LispObject,
-    cmp: CmpFunc,
+    cmp: impl Fn(LispObject, LispObject) -> bool,
     end_checks: LispConsEndChecks,
     circular_checks: LispConsCircularChecks,
-) -> LispObject
-where
-    CmpFunc: Fn(LispObject, LispObject) -> bool,
-{
+) -> LispObject {
     for tail in plist
         .iter_tails_plist(end_checks, circular_checks)
         .step_by(2)
@@ -727,15 +727,12 @@ pub fn plist_member(plist: LispObject, prop: LispObject) -> Option<LispCons> {
         .find(|tail| prop.eq(tail.car()))
 }
 
-fn internal_plist_put<CmpFunc>(
+fn internal_plist_put(
     plist: LispObject,
     prop: LispObject,
     val: LispObject,
-    cmp: CmpFunc,
-) -> LispObject
-where
-    CmpFunc: Fn(LispObject, LispObject) -> bool,
-{
+    cmp: impl Fn(LispObject, LispObject) -> bool,
+) -> LispObject {
     let mut last_cons = None;
     for tail in plist
         .iter_tails_plist(LispConsEndChecks::on, LispConsCircularChecks::on)
@@ -913,10 +910,10 @@ pub fn circular_list(obj: LispObject) -> ! {
     xsignal!(Qcircular_list, obj);
 }
 
-fn mapcar_over_iterator<I: Iterator<Item = LispObject>>(
+fn mapcar_over_iterator(
     output: &mut [LispObject],
     fun: LispObject,
-    it: I,
+    it: impl Iterator<Item = LispObject>,
 ) -> EmacsInt {
     let mut mapped = 0;
 
-- 
2.21.0


From d8cf4af14c2f16f6cc91ff3e82bb0856a3442ff7 Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Sat, 26 Jan 2019 11:00:50 +0100
Subject: [PATCH 241/297] port daemonp (#1284)

port daemonp
---
 rust_src/src/emacs.rs | 19 ++++++++++++++++++-
 src/emacs.c           | 17 +----------------
 src/lisp.h            |  2 ++
 3 files changed, 21 insertions(+), 17 deletions(-)

diff --git a/rust_src/src/emacs.rs b/rust_src/src/emacs.rs
index 41121a99dd..771066a6e2 100644
--- a/rust_src/src/emacs.rs
+++ b/rust_src/src/emacs.rs
@@ -4,7 +4,11 @@ use cfg_if::cfg_if;
 
 use remacs_macros::lisp_fn;
 
-use crate::{lisp::LispObject, remacs_sys::globals, remacs_sys::Fcopy_sequence};
+use crate::{
+    lisp::LispObject,
+    remacs_sys::{build_string, Fcopy_sequence},
+    remacs_sys::{daemon_name, globals},
+};
 
 /// Replaces IS_DAEMON
 cfg_if! {
@@ -34,4 +38,17 @@ pub fn invocation_directory() -> LispObject {
     unsafe { Fcopy_sequence(globals.Vinvocation_directory) }
 }
 
+/// Return non-nil if the current emacs process is a daemon.
+/// If the daemon was given a name argument, return that name.
+#[lisp_fn]
+pub fn daemonp() -> LispObject {
+    unsafe {
+        if is_daemon() && !daemon_name.is_null() {
+            return build_string(daemon_name);
+        }
+
+        is_daemon().into()
+    }
+}
+
 include!(concat!(env!("OUT_DIR"), "/emacs_exports.rs"));
diff --git a/src/emacs.c b/src/emacs.c
index 89622dfd5f..990b675554 100644
--- a/src/emacs.c
+++ b/src/emacs.c
@@ -177,7 +177,7 @@ bool no_site_lisp;
 bool build_details;
 
 /* Name for the server started by the daemon.*/
-static char *daemon_name;
+char *daemon_name;
 
 /* 0 not a daemon, 1 new-style (foreground), 2 old-style (background).  */
 int daemon_type;
@@ -2370,20 +2370,6 @@ decode_env_path (const char *evarname, const char *defalt, bool empty)
   return Fnreverse (lpath);
 }
 
-DEFUN ("daemonp", Fdaemonp, Sdaemonp, 0, 0, 0,
-       doc: /* Return non-nil if the current emacs process is a daemon.
-If the daemon was given a name argument, return that name. */)
-  (void)
-{
-  if (IS_DAEMON)
-    if (daemon_name)
-      return build_string (daemon_name);
-    else
-      return Qt;
-  else
-    return Qnil;
-}
-
 DEFUN ("daemon-initialized", Fdaemon_initialized, Sdaemon_initialized, 0, 0, 0,
        doc: /* Mark the Emacs daemon as being initialized.
 This finishes the daemonization process by doing the other half of detaching
@@ -2455,7 +2441,6 @@ syms_of_emacs (void)
 
   defsubr (&Skill_emacs);
 
-  defsubr (&Sdaemonp);
   defsubr (&Sdaemon_initialized);
 
   DEFVAR_LISP ("command-line-args", Vcommand_line_args,
diff --git a/src/lisp.h b/src/lisp.h
index 66d769cc94..32e239acce 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -4913,6 +4913,8 @@ void do_debug_on_call (Lisp_Object code, ptrdiff_t count);
 
 enum equal_kind { EQUAL_NO_QUIT, EQUAL_PLAIN, EQUAL_INCLUDING_PROPERTIES };
 
+extern char *daemon_name;
+
 INLINE_HEADER_END
 
 #endif /* EMACS_LISP_H */
-- 
2.21.0


From c5c7ddf79307a0e75ce56fdbe5d013d28898d112 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Carlos=20Mart=C3=ADn=20Nieto?= <carlosmn@github.com>
Date: Sat, 26 Jan 2019 17:55:57 +0100
Subject: [PATCH 242/297] Port yes-or-no-p (#1232)

The first commit changes some `LispObjects` to `bool` which I noticed as I was porting many `Qnil`s. Then we port `yes-or-no-p`. The C version checks the length of the input but it just seems like a microoptimisation we probably don't care about.

We compare the strings as byte slices and it seems like it'd be a good follow-up to allow comparison of `LispStringRef` and strings or byte slice via `PartialEq`.

Annoyingly, the parameter is allowed to be `nil` upstream which is treated as an empty string but we don't do that here.
---
 rust_src/src/fns.rs     | 71 +++++++++++++++++++++++++++++++++++++++--
 rust_src/src/minibuf.rs | 12 +++----
 src/fns.c               | 50 -----------------------------
 3 files changed, 74 insertions(+), 59 deletions(-)

diff --git a/rust_src/src/fns.rs b/rust_src/src/fns.rs
index 35a29c824e..0d7c963b58 100644
--- a/rust_src/src/fns.rs
+++ b/rust_src/src/fns.rs
@@ -7,18 +7,24 @@ use libc;
 use remacs_macros::lisp_fn;
 
 use crate::{
+    casefiddle::downcase,
+    dispnew::{ding, sleep_for},
     eval::{record_unwind_protect, un_autoload, unbind_to},
     lisp::LispObject,
     lists::{assq, car, get, mapcar1, member, memq, put},
     lists::{LispCons, LispConsCircularChecks, LispConsEndChecks},
+    minibuf::read_from_minibuffer,
+    multibyte::LispStringRef,
     numbers::LispNumber,
     obarray::loadhist_attach,
     objects::equal,
-    remacs_sys::Fload,
     remacs_sys::Vautoload_queue,
-    remacs_sys::{concat as lisp_concat, globals},
+    remacs_sys::{concat as lisp_concat, globals, message1, redisplay_preserve_echo_area},
     remacs_sys::{EmacsInt, Lisp_Type},
-    remacs_sys::{Qfuncall, Qlistp, Qnil, Qprovide, Qquote, Qrequire, Qsubfeatures, Qt},
+    remacs_sys::{Fdiscard_input, Fload, Fx_popup_dialog},
+    remacs_sys::{
+        Qfuncall, Qlistp, Qnil, Qprovide, Qquote, Qrequire, Qsubfeatures, Qt, Qyes_or_no_p_history,
+    },
     symbols::LispSymbolRef,
     threads::c_specpdl_index,
     vectors::length,
@@ -321,4 +327,63 @@ pub fn load_average(use_floats: bool) -> Vec<LispNumber> {
         .collect()
 }
 
+/// Ask user a yes-or-no question.
+///
+/// Return t if answer is yes, and nil if the answer is no.  PROMPT is
+/// the string to display to ask the question.  It should end in a
+/// space; `yes-or-no-p' adds \"(yes or no) \" to it.
+///
+/// The user must confirm the answer with RET, and can edit it until
+/// it has been confirmed.
+///
+/// If dialog boxes are supported, a dialog box will be used if
+/// `last-nonmenu-event' is nil, and `use-dialog-box' is non-nil.
+#[lisp_fn]
+pub fn yes_or_no_p(prompt: LispStringRef) -> bool {
+    let use_popup = unsafe {
+        (globals.last_nonmenu_event.is_nil() || globals.last_nonmenu_event.is_cons())
+            && globals.use_dialog_box
+            && globals.last_input_event.is_not_nil()
+    };
+
+    if use_popup {
+        unsafe { redisplay_preserve_echo_area(4) };
+        let menu = (prompt, (("Yes", true), ("No", false)));
+        return unsafe { Fx_popup_dialog(Qt, menu.into(), Qnil) }.into();
+    }
+
+    let yes_or_no: LispObject = "(yes or no) ".into();
+    let prompt = concat(&mut vec![prompt.into(), yes_or_no]).into();
+
+    loop {
+        let ans: LispStringRef = downcase(read_from_minibuffer(
+            prompt,
+            Qnil,
+            Qnil,
+            false,
+            Qyes_or_no_p_history,
+            Qnil,
+            false,
+        ))
+        .into();
+
+        match ans.as_slice() {
+            b"yes" => {
+                return true;
+            }
+            b"no" => {
+                return false;
+            }
+            _ => {
+                ding(Qnil);
+                unsafe {
+                    Fdiscard_input();
+                    message1("Please answer yes or no.\0".as_ptr() as *const i8);
+                }
+                sleep_for(2.0, None);
+            }
+        }
+    }
+}
+
 include!(concat!(env!("OUT_DIR"), "/fns_exports.rs"));
diff --git a/rust_src/src/minibuf.rs b/rust_src/src/minibuf.rs
index a0948f324c..19234d0708 100644
--- a/rust_src/src/minibuf.rs
+++ b/rust_src/src/minibuf.rs
@@ -168,10 +168,10 @@ pub fn read_from_minibuffer(
     prompt: LispStringRef,
     initial_contents: LispObject,
     mut keymap: LispObject,
-    read: LispObject,
+    read: bool,
     hist: LispObject,
     default_value: LispObject,
-    inherit_input_method: LispObject,
+    inherit_input_method: bool,
 ) -> LispObject {
     keymap = if keymap.is_nil() {
         unsafe { globals.Vminibuffer_local_map }
@@ -197,12 +197,12 @@ pub fn read_from_minibuffer(
             keymap,
             initial_contents,
             prompt.into(),
-            read.is_not_nil(),
+            read,
             histvar,
             histpos,
             default_value,
             globals.minibuffer_allow_text_properties,
-            inherit_input_method.is_not_nil(),
+            inherit_input_method,
         )
     }
 }
@@ -312,7 +312,7 @@ pub fn read_string(
     initial_input: LispObject,
     history: LispObject,
     default_value: LispObject,
-    inherit_input_method: LispObject,
+    inherit_input_method: bool,
 ) -> LispObject {
     let count = c_specpdl_index();
 
@@ -327,7 +327,7 @@ pub fn read_string(
         prompt,
         initial_input,
         Qnil,
-        Qnil,
+        false,
         history,
         default_value,
         inherit_input_method,
diff --git a/src/fns.c b/src/fns.c
index 6af08e7e5b..e651b230b7 100644
--- a/src/fns.c
+++ b/src/fns.c
@@ -1478,55 +1478,6 @@ do_yes_or_no_p (Lisp_Object prompt)
 {
   return call1 (intern ("yes-or-no-p"), prompt);
 }
-
-DEFUN ("yes-or-no-p", Fyes_or_no_p, Syes_or_no_p, 1, 1, 0,
-       doc: /* Ask user a yes-or-no question.
-Return t if answer is yes, and nil if the answer is no.
-PROMPT is the string to display to ask the question.  It should end in
-a space; `yes-or-no-p' adds \"(yes or no) \" to it.
-
-The user must confirm the answer with RET, and can edit it until it
-has been confirmed.
-
-If dialog boxes are supported, a dialog box will be used
-if `last-nonmenu-event' is nil, and `use-dialog-box' is non-nil.  */)
-  (Lisp_Object prompt)
-{
-  Lisp_Object ans;
-
-  CHECK_STRING (prompt);
-
-  if ((NILP (last_nonmenu_event) || CONSP (last_nonmenu_event))
-      && use_dialog_box && ! NILP (last_input_event))
-    {
-      Lisp_Object pane, menu, obj;
-      redisplay_preserve_echo_area (4);
-      pane = list2 (Fcons (build_string ("Yes"), Qt),
-		    Fcons (build_string ("No"), Qnil));
-      menu = Fcons (prompt, pane);
-      obj = Fx_popup_dialog (Qt, menu, Qnil);
-      return obj;
-    }
-
-  AUTO_STRING (yes_or_no, "(yes or no) ");
-  prompt = CALLN (Fconcat, prompt, yes_or_no);
-
-  while (1)
-    {
-      ans = Fdowncase (Fread_from_minibuffer (prompt, Qnil, Qnil, Qnil,
-					      Qyes_or_no_p_history, Qnil,
-					      Qnil));
-      if (SCHARS (ans) == 3 && !strcmp (SSDATA (ans), "yes"))
-	return Qt;
-      if (SCHARS (ans) == 2 && !strcmp (SSDATA (ans), "no"))
-	return Qnil;
-
-      Fding (Qnil);
-      Fdiscard_input ();
-      message1 ("Please answer yes or no.");
-      Fsleep_for (make_number (2), Qnil);
-    }
-}
 
 /* Primitives for work of the "widget" library.
    In an ideal world, this section would not have been necessary.
@@ -3070,7 +3021,6 @@ this variable.  */);
   defsubr (&Smapcar);
   defsubr (&Smapcan);
   defsubr (&Smapconcat);
-  defsubr (&Syes_or_no_p);
   defsubr (&Swidget_put);
   defsubr (&Swidget_get);
   defsubr (&Swidget_apply);
-- 
2.21.0


From fb3e3dbc7d15745f76ef11d97dd22ad9166e9e4c Mon Sep 17 00:00:00 2001
From: Georgy Komarov <jubnzv@gmail.com>
Date: Sat, 26 Jan 2019 19:59:11 +0300
Subject: [PATCH 243/297] Drop live_or_error to use LispFrameLiveOrSelected
 where it possible (#1270)

Fix #1266
---
 rust_src/src/dispnew.rs |  6 +++---
 rust_src/src/frames.rs  | 31 ++++++++++---------------------
 rust_src/src/windows.rs |  6 +++---
 3 files changed, 16 insertions(+), 27 deletions(-)

diff --git a/rust_src/src/dispnew.rs b/rust_src/src/dispnew.rs
index a0b41e4276..fa26da0208 100644
--- a/rust_src/src/dispnew.rs
+++ b/rust_src/src/dispnew.rs
@@ -8,7 +8,7 @@ use remacs_macros::lisp_fn;
 use crate::{
     eval::unbind_to,
     frames::selected_frame,
-    frames::{LispFrameOrSelected, LispFrameRef},
+    frames::{LispFrameLiveOrSelected, LispFrameRef},
     lisp::{ExternalPtr, LispObject},
     lists::{LispConsCircularChecks, LispConsEndChecks},
     remacs_sys::{
@@ -82,8 +82,8 @@ pub extern "C" fn redraw_frame(mut frame: LispFrameRef) {
 /// Clear frame FRAME and output again what is supposed to appear on it.
 /// If FRAME is omitted or nil, the selected frame is used.
 #[lisp_fn(c_name = "redraw_frame", name = "redraw-frame", min = "0")]
-pub fn redraw_frame_lisp(frame: LispFrameOrSelected) {
-    redraw_frame(frame.live_or_error());
+pub fn redraw_frame_lisp(frame: LispFrameLiveOrSelected) {
+    redraw_frame(frame.into());
 }
 
 /// Clear and redisplay all visible frames.
diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index c82774accf..e00fd31121 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -165,17 +165,6 @@ impl From<LispFrameOrSelected> for LispFrameRef {
     }
 }
 
-impl LispFrameOrSelected {
-    pub fn live_or_error(self) -> LispFrameRef {
-        let frame = LispFrameRef::from(self);
-        if frame.is_live() {
-            frame
-        } else {
-            wrong_type!(Qframe_live_p, self);
-        }
-    }
-}
-
 #[derive(Clone, Copy)]
 pub struct LispFrameLiveOrSelected(LispFrameRef);
 
@@ -281,11 +270,11 @@ pub fn frame_selected_window(frame_or_window: LispObject) -> LispWindowRef {
 /// Return WINDOW.
 #[lisp_fn(min = "2")]
 pub fn set_frame_selected_window(
-    frame: LispFrameOrSelected,
+    frame: LispFrameLiveOrSelected,
     window: LispObject,
     norecord: LispObject,
 ) -> LispWindowRef {
-    let mut frame_ref = frame.live_or_error();
+    let mut frame_ref: LispFrameRef = frame.into();
     let w = window.as_live_window_or_error();
 
     if frame_ref != w.frame.as_frame().unwrap() {
@@ -350,8 +339,8 @@ pub fn frame_visible_p(frame: LispFrameRef) -> LispObject {
 /// FRAME's outer frame, in pixels relative to an origin (0, 0) of FRAME's
 /// display.
 #[lisp_fn(min = "0")]
-pub fn frame_position(frame: LispFrameOrSelected) -> (c_int, c_int) {
-    let frame_ref = frame.live_or_error();
+pub fn frame_position(frame: LispFrameLiveOrSelected) -> (c_int, c_int) {
+    let frame_ref: LispFrameRef = frame.into();
     (frame_ref.left_pos, frame_ref.top_pos)
 }
 
@@ -510,8 +499,8 @@ pub fn delete_frame_lisp(frame: LispObject, force: bool) {
 /// If MINIFRAME is 0, include all visible and iconified frames.
 /// Otherwise, include all frames.
 #[lisp_fn(min = "0")]
-pub fn next_frame(frame: LispFrameOrSelected, miniframe: LispObject) -> LispFrameRef {
-    let frame_ref = frame.live_or_error();
+pub fn next_frame(frame: LispFrameLiveOrSelected, miniframe: LispObject) -> LispFrameRef {
+    let frame_ref: LispFrameRef = frame.into();
     let frame_obj = frame_ref.into();
 
     // Track how many times have we passed FRAME in the list.
@@ -551,8 +540,8 @@ pub fn next_frame(frame: LispFrameOrSelected, miniframe: LispObject) -> LispFram
 /// If MINIFRAME is 0, include all visible and iconified frames.
 /// Otherwise, include all frames.
 #[lisp_fn(min = "0")]
-pub fn previous_frame(frame: LispFrameOrSelected, miniframe: LispObject) -> LispFrameRef {
-    let frame_ref = frame.live_or_error();
+pub fn previous_frame(frame: LispFrameLiveOrSelected, miniframe: LispObject) -> LispFrameRef {
+    let frame_ref: LispFrameRef = frame.into();
     let frame_obj: LispObject = frame_ref.into();
     let mut prev = Qnil;
 
@@ -591,8 +580,8 @@ pub fn previous_frame(frame: LispFrameOrSelected, miniframe: LispObject) -> Lisp
 /// otherwise used with utter care to avoid that running functions on
 /// `window-configuration-change-hook' is impeded forever.
 #[lisp_fn]
-pub fn frame_after_make_frame(frame: LispFrameOrSelected, made: LispObject) -> LispObject {
-    let mut frame_ref = frame.live_or_error();
+pub fn frame_after_make_frame(frame: LispFrameLiveOrSelected, made: LispObject) -> LispObject {
+    let mut frame_ref: LispFrameRef = frame.into();
     frame_ref.set_after_make_frame(made.is_not_nil());
     frame_ref.set_inhibit_horizontal_resize(false);
     frame_ref.set_inhibit_vertical_resize(false);
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 8c5f01c519..f024422efd 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -9,7 +9,7 @@ use remacs_macros::lisp_fn;
 use crate::{
     buffers::LispBufferRef,
     editfns::{goto_char, point},
-    frames::{LispFrameOrSelected, LispFrameRef},
+    frames::{LispFrameLiveOrSelected, LispFrameOrSelected, LispFrameRef},
     interactive::prefix_numeric_value,
     lisp::{ExternalPtr, LispObject},
     lists::{assq, setcdr},
@@ -906,8 +906,8 @@ pub fn window_frame(window: LispWindowValidOrSelected) -> LispObject {
 /// Return the minibuffer window for frame FRAME.
 /// If FRAME is omitted or nil, it defaults to the selected frame.
 #[lisp_fn(min = "0")]
-pub fn minibuffer_window(frame: LispFrameOrSelected) -> LispObject {
-    let frame = frame.live_or_error();
+pub fn minibuffer_window(frame: LispFrameLiveOrSelected) -> LispObject {
+    let frame: LispFrameRef = frame.into();
     frame.minibuffer_window
 }
 
-- 
2.21.0


From 10e94d250a2eb98037e1e18a8db0a36224680ed7 Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Sun, 27 Jan 2019 20:59:14 +0100
Subject: [PATCH 244/297] fix x-focus-frame names

---
 rust_src/src/frames.rs | 10 ++++------
 1 file changed, 4 insertions(+), 6 deletions(-)

diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index c82774accf..571d99a338 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -15,7 +15,7 @@ use crate::{
 };
 
 #[cfg(feature = "window-system")]
-use crate::{remacs_sys::vertical_scroll_bar_type, remacs_sys::x_focus_frame as c_x_focus_frame};
+use crate::remacs_sys::{vertical_scroll_bar_type, x_focus_frame};
 
 pub type LispFrameRef = ExternalPtr<Lisp_Frame>;
 
@@ -614,17 +614,15 @@ pub fn frame_focus(frame: LispFrameLiveOrSelected) -> LispObject {
 /// means do not activate FRAME.
 ///
 /// If there is no window system support, this function does nothing.
-#[lisp_fn(min = "1")]
-pub fn x_focus_frame(_frame: LispFrameLiveOrSelected, _noactivate: bool) -> LispObject {
+#[lisp_fn(min = "1", name = "x-focus-frame", c_name = "x_focus_frame")]
+pub fn x_focus_frame_lisp(_frame: LispFrameLiveOrSelected, _noactivate: bool) {
     #[cfg(feature = "window-system")]
     {
         let mut frame_ref: LispFrameRef = _frame.into();
         unsafe {
-            c_x_focus_frame(frame_ref.as_mut(), _noactivate);
+            x_focus_frame(frame_ref.as_mut(), _noactivate);
         }
     }
-
-    Qnil
 }
 
 include!(concat!(env!("OUT_DIR"), "/frames_exports.rs"));
-- 
2.21.0


From 28d23a428f4905da0767096ded963c0bc1ec8c8e Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Sun, 27 Jan 2019 21:18:41 +0100
Subject: [PATCH 245/297] Fix window-buffer error (#1294)

---
 rust_src/src/windows.rs | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index f024422efd..140111269f 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -593,6 +593,7 @@ impl LispGlyphMatrixRef {
 pub struct LispWindowOrSelected(LispObject);
 
 impl From<LispObject> for LispWindowOrSelected {
+    /// Same as `decode_any_window`
     fn from(obj: LispObject) -> Self {
         Self(obj.map_or_else(selected_window, |w| w))
     }
@@ -703,7 +704,7 @@ pub fn selected_window() -> LispObject {
 /// If WINDOW is omitted or nil, it defaults to the selected window.
 /// Return nil for an internal window or a deleted window.
 #[lisp_fn(min = "0")]
-pub fn window_buffer(window: LispWindowValidOrSelected) -> LispObject {
+pub fn window_buffer(window: LispWindowOrSelected) -> LispObject {
     let win: LispWindowRef = window.into();
     if win.is_live() {
         win.contents
-- 
2.21.0


From 873f0f88ca5d8604fae01cdc6c6a52ca5e658d4e Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Mon, 28 Jan 2019 21:00:19 +0100
Subject: [PATCH 246/297] port frame-list and visible-frame-list

---
 rust_src/src/frames.rs | 48 +++++++++++++++++++++++++++++++++++++++++-
 src/frame.c            | 36 -------------------------------
 2 files changed, 47 insertions(+), 37 deletions(-)

diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index 5b5930b6d1..36322ccf63 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -15,7 +15,10 @@ use crate::{
 };
 
 #[cfg(feature = "window-system")]
-use crate::remacs_sys::{vertical_scroll_bar_type, x_focus_frame};
+use crate::remacs_sys::{vertical_scroll_bar_type, x_focus_frame, Fnreverse};
+
+#[cfg(not(feature = "window-system"))]
+use crate::remacs_sys::Fcopy_sequence;
 
 pub type LispFrameRef = ExternalPtr<Lisp_Frame>;
 
@@ -41,6 +44,17 @@ impl LispFrameRef {
         self.visible() != 0
     }
 
+    pub fn has_tooltip(self) -> bool {
+        #[cfg(feature = "window-system")]
+        {
+            self.tooltip()
+        }
+        #[cfg(not(feature = "window-system"))]
+        {
+            false
+        }
+    }
+
     pub fn total_fringe_width(self) -> i32 {
         self.left_fringe_width + self.right_fringe_width
     }
@@ -614,4 +628,36 @@ pub fn x_focus_frame_lisp(_frame: LispFrameLiveOrSelected, _noactivate: bool) {
     }
 }
 
+fn filter_frame_list(predicate: impl Fn(LispFrameRef) -> bool) -> LispObject {
+    let mut list: LispObject = Qnil;
+    for_each_frame!(f => {
+        if predicate(f) {
+            list = (f, list).into();
+        }
+    });
+    list
+}
+
+/// Return a list of all live frames.
+/// The return value does not include any tooltip frame.
+#[lisp_fn]
+pub fn frame_list() -> LispObject {
+    #[cfg(feature = "window-system")]
+    {
+        let list = filter_frame_list(|f| !f.has_tooltip());
+        // Reverse list for consistency with the !HAVE_WINDOW_SYSTEM case.
+        unsafe { Fnreverse(list) }
+    }
+    #[cfg(not(feature = "window-system"))]
+    {
+        unsafe { Fcopy_sequence(Vframe_list) }
+    }
+}
+
+/// Return a list of all frames now \"visible\" (being updated).
+#[lisp_fn]
+pub fn visible_frame_list() -> LispObject {
+    filter_frame_list(|f| f.is_visible())
+}
+
 include!(concat!(env!("OUT_DIR"), "/frames_exports.rs"));
diff --git a/src/frame.c b/src/frame.c
index edd3e2afce..1a3082f048 100644
--- a/src/frame.c
+++ b/src/frame.c
@@ -1370,25 +1370,6 @@ to that frame.  */)
   call1 (intern ("handle-focus-in"), event);
   return value;
 }
-
-DEFUN ("frame-list", Fframe_list, Sframe_list,
-       0, 0, 0,
-       doc: /* Return a list of all live frames.
-The return value does not include any tooltip frame.  */)
-  (void)
-{
-#ifdef HAVE_WINDOW_SYSTEM
-  Lisp_Object list = Qnil, tail, frame;
-
-  FOR_EACH_FRAME (tail, frame)
-    if (!FRAME_TOOLTIP_P (XFRAME (frame)))
-      list = Fcons (frame, list);
-  /* Reverse list for consistency with the !HAVE_WINDOW_SYSTEM case.  */
-  return Fnreverse (list);
-#else /* !HAVE_WINDOW_SYSTEM */
-  return Fcopy_sequence (Vframe_list);
-#endif /* HAVE_WINDOW_SYSTEM */
-}
 
 DEFUN ("frame-parent", Fframe_parent, Sframe_parent,
        0, 1, 0,
@@ -2377,21 +2358,6 @@ for how to proceed.  */)
   return Qnil;
 }
 
-DEFUN ("visible-frame-list", Fvisible_frame_list, Svisible_frame_list,
-       0, 0, 0,
-       doc: /* Return a list of all frames now \"visible\" (being updated).  */)
-  (void)
-{
-  Lisp_Object tail, frame, value = Qnil;
-
-  FOR_EACH_FRAME (tail, frame)
-    if (FRAME_VISIBLE_P (XFRAME (frame)))
-      value = Fcons (frame, value);
-
-  return value;
-}
-
-
 DEFUN ("raise-frame", Fraise_frame, Sraise_frame, 0, 1, "",
        doc: /* Bring FRAME to the front, so it occludes any frames it overlaps.
 If FRAME is invisible or iconified, make it visible.
@@ -5640,7 +5606,6 @@ iconify the top level frame instead.  */);
   defsubr (&Smake_terminal_frame);
   defsubr (&Shandle_switch_frame);
   defsubr (&Sselect_frame);
-  defsubr (&Sframe_list);
   defsubr (&Sframe_parent);
   defsubr (&Sframe_ancestor_p);
   defsubr (&Slast_nonminibuf_frame);
@@ -5655,7 +5620,6 @@ iconify the top level frame instead.  */);
   defsubr (&Smake_frame_visible);
   defsubr (&Smake_frame_invisible);
   defsubr (&Siconify_frame);
-  defsubr (&Svisible_frame_list);
   defsubr (&Sraise_frame);
   defsubr (&Slower_frame);
   defsubr (&Sredirect_frame_focus);
-- 
2.21.0


From 10ec9f8fa8d6acd43a12d0f56cd0827513259fbd Mon Sep 17 00:00:00 2001
From: Maxim Novikov <mnovikov.main@gmail.com>
Date: Tue, 29 Jan 2019 13:30:31 +0100
Subject: [PATCH 247/297] Port file-directory-p (#1295)

---
 rust_src/src/fileio.rs | 25 ++++++++++++++++++++++---
 src/fileio.c           | 20 --------------------
 2 files changed, 22 insertions(+), 23 deletions(-)

diff --git a/rust_src/src/fileio.rs b/rust_src/src/fileio.rs
index 8d9a101973..cb5eacbc92 100644
--- a/rust_src/src/fileio.rs
+++ b/rust_src/src/fileio.rs
@@ -13,11 +13,13 @@ use crate::{
     math::{arithcompare, ArithComparison},
     multibyte::LispStringRef,
     remacs_sys::{
-        check_executable, check_existing, file_name_absolute_p, file_name_case_insensitive_p,
-        report_file_errno,
+        check_executable, check_existing, expand_and_dir_to_file, file_directory_p,
+        file_name_absolute_p, file_name_case_insensitive_p, report_file_errno,
     },
     remacs_sys::{Fexpand_file_name, Ffind_file_name_handler},
-    remacs_sys::{Qfile_executable_p, Qfile_exists_p, Qfile_name_case_insensitive_p},
+    remacs_sys::{
+        Qfile_directory_p, Qfile_executable_p, Qfile_exists_p, Qfile_name_case_insensitive_p,
+    },
     threads::ThreadState,
 };
 
@@ -117,6 +119,23 @@ pub fn file_exists_p(filename: LispStringRef) -> bool {
     }
 }
 
+/// Return t if FILENAME names an existing directory.
+/// Symbolic links to directories count as directories.
+/// See `file-symlink-p' to distinguish symlinks.
+#[lisp_fn(name = "file-directory-p", c_name = "file_directory_p")]
+pub fn file_directory_p_lisp(filename: LispStringRef) -> bool {
+    let absname = unsafe { expand_and_dir_to_file(filename.into()) };
+    let handler = find_file_name_handler(absname.into(), Qfile_directory_p);
+
+    if handler.is_not_nil() {
+        call!(handler, Qfile_directory_p, absname.into()).into()
+    } else {
+        unsafe { file_directory_p(encode_file_name(absname.into()).into()) }
+    }
+}
+
+def_lisp_sym!(Qfile_directory_p, "file-directory-p");
+
 /// Return t if FILENAME can be executed by you.
 /// For a directory, this means you can access files in that directory.
 /// (It is generally better to use `file-accessible-directory-p' for that purpose, though.)
diff --git a/src/fileio.c b/src/fileio.c
index da39fe526a..3d9eb51487 100644
--- a/src/fileio.c
+++ b/src/fileio.c
@@ -2544,24 +2544,6 @@ This function does not check whether the link target exists.  */)
   return emacs_readlinkat (AT_FDCWD, SSDATA (filename));
 }
 
-DEFUN ("file-directory-p", Ffile_directory_p, Sfile_directory_p, 1, 1, 0,
-       doc: /* Return t if FILENAME names an existing directory.
-Symbolic links to directories count as directories.
-See `file-symlink-p' to distinguish symlinks.  */)
-  (Lisp_Object filename)
-{
-  Lisp_Object absname = expand_and_dir_to_file (filename);
-
-  /* If the file name has special constructs in it,
-     call the corresponding file handler.  */
-  Lisp_Object handler = Ffind_file_name_handler (absname, Qfile_directory_p);
-  if (!NILP (handler))
-    return call2 (handler, Qfile_directory_p, absname);
-
-  absname = ENCODE_FILE (absname);
-
-  return file_directory_p (absname) ? Qt : Qnil;
-}
 
 /* Return true if FILE is a directory or a symlink to a directory.
    Otherwise return false and set errno.  */
@@ -5765,7 +5747,6 @@ syms_of_fileio (void)
   DEFSYM (Qfile_writable_p, "file-writable-p");
   DEFSYM (Qfile_symlink_p, "file-symlink-p");
   DEFSYM (Qaccess_file, "access-file");
-  DEFSYM (Qfile_directory_p, "file-directory-p");
   DEFSYM (Qfile_regular_p, "file-regular-p");
   DEFSYM (Qfile_accessible_directory_p, "file-accessible-directory-p");
   DEFSYM (Qfile_modes, "file-modes");
@@ -6026,7 +6007,6 @@ This includes interactive calls to `delete-file' and
   defsubr (&Sfile_writable_p);
   defsubr (&Saccess_file);
   defsubr (&Sfile_symlink_p);
-  defsubr (&Sfile_directory_p);
   defsubr (&Sfile_accessible_directory_p);
   defsubr (&Sfile_regular_p);
   defsubr (&Sfile_modes);
-- 
2.21.0


From d5141e5d49190f9cfe091e899ee894bf5ab6c7e5 Mon Sep 17 00:00:00 2001
From: Shanavas M <shanavas.m2@gmail.com>
Date: Mon, 28 Jan 2019 20:23:20 +0530
Subject: [PATCH 248/297] port nconc

code mostly belongs to @shaleh
---
 rust_src/src/fns.rs | 41 +++++++++++++++++++++++++++++++++++++++++
 src/fns.c           | 33 ---------------------------------
 2 files changed, 41 insertions(+), 33 deletions(-)

diff --git a/rust_src/src/fns.rs b/rust_src/src/fns.rs
index 0d7c963b58..147ed39091 100644
--- a/rust_src/src/fns.rs
+++ b/rust_src/src/fns.rs
@@ -386,4 +386,45 @@ pub fn yes_or_no_p(prompt: LispStringRef) -> bool {
     }
 }
 
+/// Concatenate any number of lists by altering them.
+/// Only the last argument is not altered, and need not be a list.
+/// usage: (nconc &rest LISTS)
+#[lisp_fn]
+pub fn nconc(args: &mut [LispObject]) -> LispObject {
+    let mut val = Qnil;
+
+    let len = args.len();
+
+    for i in 0..len {
+        let elt = args[i];
+
+        if elt.is_nil() {
+            continue;
+        }
+
+        if val.is_nil() {
+            val = elt;
+        }
+
+        if (i + 1) == len {
+            break;
+        }
+
+        let cons: LispCons = elt.into();
+
+        let tail = cons
+            .iter_tails(LispConsEndChecks::off, LispConsCircularChecks::on)
+            .last()
+            .unwrap();
+
+        let next = args[i + 1];
+        tail.set_cdr(next);
+        if next.is_nil() {
+            args[i + 1] = tail.into();
+        }
+    }
+
+    val
+}
+
 include!(concat!(env!("OUT_DIR"), "/fns_exports.rs"));
diff --git a/src/fns.c b/src/fns.c
index e651b230b7..414ac8c69b 100644
--- a/src/fns.c
+++ b/src/fns.c
@@ -1371,38 +1371,6 @@ nconc2 (Lisp_Object s1, Lisp_Object s2)
   return CALLN (Fnconc, s1, s2);
 }
 
-DEFUN ("nconc", Fnconc, Snconc, 0, MANY, 0,
-       doc: /* Concatenate any number of lists by altering them.
-Only the last argument is not altered, and need not be a list.
-usage: (nconc &rest LISTS)  */)
-  (ptrdiff_t nargs, Lisp_Object *args)
-{
-  Lisp_Object val = Qnil;
-
-  for (ptrdiff_t argnum = 0; argnum < nargs; argnum++)
-    {
-      Lisp_Object tem = args[argnum];
-      if (NILP (tem)) continue;
-
-      if (NILP (val))
-	val = tem;
-
-      if (argnum + 1 == nargs) break;
-
-      CHECK_CONS (tem);
-
-      Lisp_Object tail;
-      FOR_EACH_TAIL (tem)
-	tail = tem;
-
-      tem = args[argnum + 1];
-      Fsetcdr (tail, tem);
-      if (NILP (tem))
-	args[argnum + 1] = tail;
-    }
-
-  return val;
-}
 
 DEFUN ("mapconcat", Fmapconcat, Smapconcat, 3, 3, 0,
        doc: /* Apply FUNCTION to each element of SEQUENCE, and concat the results as strings.
@@ -3017,7 +2985,6 @@ this variable.  */);
   defsubr (&Snreverse);
   defsubr (&Sreverse);
   defsubr (&Sfillarray);
-  defsubr (&Snconc);
   defsubr (&Smapcar);
   defsubr (&Smapcan);
   defsubr (&Smapconcat);
-- 
2.21.0


From e369133e0307c55395b07cf0253acc057b1df3d0 Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Wed, 30 Jan 2019 15:37:54 -0800
Subject: [PATCH 249/297] Fix translation of nils to windows. (#1301)

Closes: #1287
---
 rust_src/src/windows.rs | 22 +++++++++++-----------
 1 file changed, 11 insertions(+), 11 deletions(-)

diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 140111269f..27d8d98acd 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -1,6 +1,6 @@
 //! Functions operating on windows.
 
-use std::{cmp, ptr};
+use std::{cmp, fmt, ptr};
 
 use libc::c_int;
 
@@ -75,14 +75,6 @@ impl LispWindowRef {
         LispGlyphMatrixRef::new(self.current_matrix)
     }
 
-    pub fn prev(self) -> Self {
-        self.prev.into()
-    }
-
-    pub fn next(self) -> Self {
-        self.next.into()
-    }
-
     /// Return the current height of the mode line of window W. If not known
     /// from W->mode_line_height, look at W's current glyph matrix, or return
     /// a default based on the height of the font of the face `mode-line'.
@@ -480,7 +472,7 @@ impl LispWindowRef {
     /// Width of the window's bottom divider
     pub fn bottom_divider_width(self) -> i32 {
         if self.is_bottommost() && self.get_frame().root_window().next.is_not_nil()
-            || self.prev() == self.get_frame().root_window()
+            || self.prev.eq(self.get_frame().root_window)
             || self.is_pseudo()
         {
             0
@@ -530,6 +522,12 @@ impl From<LispObject> for Option<LispWindowRef> {
     }
 }
 
+impl fmt::Debug for LispWindowRef {
+    fn fmt(&self, f: &mut fmt::Formatter) -> Result<(), fmt::Error> {
+        write!(f, "window({:?})", self.as_ptr())
+    }
+}
+
 impl LispObject {
     pub fn is_window(self) -> bool {
         self.as_vectorlike()
@@ -590,6 +588,7 @@ impl LispGlyphMatrixRef {
     }
 }
 
+#[derive(Debug)]
 pub struct LispWindowOrSelected(LispObject);
 
 impl From<LispObject> for LispWindowOrSelected {
@@ -611,13 +610,14 @@ impl From<LispWindowOrSelected> for LispWindowRef {
     }
 }
 
+#[derive(Debug)]
 pub struct LispWindowLiveOrSelected(LispWindowRef);
 
 impl From<LispObject> for LispWindowLiveOrSelected {
     /// Same as the `decode_live_window` function
     fn from(obj: LispObject) -> Self {
         Self(obj.map_or_else(
-            || LispWindowRef::from(selected_window()),
+            || LispWindowRef::from(unsafe { current_window }),
             |w| w.as_live_window_or_error(),
         ))
     }
-- 
2.21.0


From ead965a8e78ad923ecb3712fc7cf1e038d3b7803 Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Thu, 31 Jan 2019 17:56:02 +0100
Subject: [PATCH 250/297] port input-pending-p (#1305)

port input-pending-p
---
 rust_src/src/keyboard.rs | 40 ++++++++++++++++++++++++++++++++++++----
 src/keyboard.c           | 29 +++--------------------------
 src/lisp.h               |  2 ++
 3 files changed, 41 insertions(+), 30 deletions(-)

diff --git a/rust_src/src/keyboard.rs b/rust_src/src/keyboard.rs
index 624797d64a..6edf20b9ec 100644
--- a/rust_src/src/keyboard.rs
+++ b/rust_src/src/keyboard.rs
@@ -14,10 +14,11 @@ use crate::{
     numbers::IsLispNatnum,
     remacs_sys::globals,
     remacs_sys::{
-        clear_message, command_loop_level, glyph_row_area, interrupt_input_blocked,
-        make_lispy_position, message_log_maybe_newline, minibuf_level, output_method,
-        print_error_message, recursive_edit_1, recursive_edit_unwind,
-        temporarily_switch_to_single_kboard, update_mode_lines, window_box_left_offset,
+        clear_message, command_loop_level, get_input_pending, glyph_row_area,
+        interrupt_input_blocked, make_lispy_position, message_log_maybe_newline, minibuf_level,
+        output_method, print_error_message, process_special_events, recursive_edit_1,
+        recursive_edit_unwind, temporarily_switch_to_single_kboard, update_mode_lines,
+        window_box_left_offset,
     },
     remacs_sys::{Fdiscard_input, Fkill_emacs, Fpos_visible_in_window_p, Fterpri, Fthrow},
     remacs_sys::{
@@ -271,4 +272,35 @@ pub fn command_error_default_function(
     }
 }
 
+const READABLE_EVENTS_DO_TIMERS_NOW: i32 = 1;
+const READABLE_EVENTS_FILTER_EVENTS: i32 = 2;
+
+/// Return t if command input is currently available with no wait.
+/// Actually, the value is nil only if we can be sure that no input is available;
+/// if there is a doubt, the value is t.
+///
+/// If CHECK-TIMERS is non-nil, timers that are ready to run will do so.
+#[lisp_fn(min = "0")]
+pub fn input_pending_p(check_timers: bool) -> bool {
+    unsafe {
+        if globals.Vunread_command_events.is_cons()
+            || globals.Vunread_post_input_method_events.is_not_nil()
+            || globals.Vunread_input_method_events.is_not_nil()
+        {
+            return true;
+        }
+
+        // Process non-user-visible events (Bug#10195).
+        process_special_events();
+
+        let val = if !check_timers {
+            0
+        } else {
+            READABLE_EVENTS_DO_TIMERS_NOW
+        };
+
+        get_input_pending(val | READABLE_EVENTS_FILTER_EVENTS)
+    }
+}
+
 include!(concat!(env!("OUT_DIR"), "/keyboard_exports.rs"));
diff --git a/src/keyboard.c b/src/keyboard.c
index 3f3cf2bf09..35f9452658 100644
--- a/src/keyboard.c
+++ b/src/keyboard.c
@@ -339,7 +339,7 @@ static struct timespec timer_last_idleness_start_time;
 /* Function for init_keyboard to call with no args (if nonzero).  */
 static void (*keyboard_init_hook) (void);
 
-static bool get_input_pending (int);
+
 static bool readable_events (int);
 static Lisp_Object read_char_x_menu_prompt (Lisp_Object,
                                             Lisp_Object, bool *);
@@ -3927,7 +3927,7 @@ kbd_buffer_get_event (KBOARD **kbp,
 /* Process any non-user-visible events (currently X selection events),
    without reading any user-visible events.  */
 
-static void
+void
 process_special_events (void)
 {
   union buffered_input_event *event;
@@ -6628,7 +6628,7 @@ parse_solitary_modifier (Lisp_Object symbol)
    If READABLE_EVENTS_IGNORE_SQUEEZABLES is set in FLAGS, ignore mouse
    movements and toolkit scroll bar thumb drags.  */
 
-static bool
+bool
 get_input_pending (int flags)
 {
   /* First of all, have we already counted some input?  */
@@ -9784,28 +9784,6 @@ requeued_events_pending_p (void)
   return (CONSP (Vunread_command_events));
 }
 
-DEFUN ("input-pending-p", Finput_pending_p, Sinput_pending_p, 0, 1, 0,
-       doc: /* Return t if command input is currently available with no wait.
-Actually, the value is nil only if we can be sure that no input is available;
-if there is a doubt, the value is t.
-
-If CHECK-TIMERS is non-nil, timers that are ready to run will do so.  */)
-  (Lisp_Object check_timers)
-{
-  if (CONSP (Vunread_command_events)
-      || !NILP (Vunread_post_input_method_events)
-      || !NILP (Vunread_input_method_events))
-    return (Qt);
-
-  /* Process non-user-visible events (Bug#10195).  */
-  process_special_events ();
-
-  return (get_input_pending ((NILP (check_timers)
-                              ? 0 : READABLE_EVENTS_DO_TIMERS_NOW)
-			     | READABLE_EVENTS_FILTER_EVENTS)
-	  ? Qt : Qnil);
-}
-
 DEFUN ("recent-keys", Frecent_keys, Srecent_keys, 0, 1, 0,
        doc: /* Return vector of last few events, not counting those from keyboard macros.
 If INCLUDE-CMDS is non-nil, include the commands that were run,
@@ -11008,7 +10986,6 @@ syms_of_keyboard (void)
   defsubr (&Sread_key_sequence);
   defsubr (&Sread_key_sequence_vector);
   defsubr (&Strack_mouse);
-  defsubr (&Sinput_pending_p);
   defsubr (&Srecent_keys);
   defsubr (&Sthis_command_keys);
   defsubr (&Sthis_command_keys_vector);
diff --git a/src/lisp.h b/src/lisp.h
index 32e239acce..b6936c9fe9 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -4256,6 +4256,8 @@ extern void init_casetab_once (void);
 extern void syms_of_casetab (void);
 
 /* Defined in keyboard.c.  */
+extern bool get_input_pending (int);
+extern void process_special_events (void);
 
 extern void recursive_edit_unwind (Lisp_Object buffer);
 extern Lisp_Object echo_message_buffer;
-- 
2.21.0


From 4954b13f94da068543e669c46a3b6af0dbc88e31 Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Thu, 31 Jan 2019 19:01:33 +0100
Subject: [PATCH 251/297] update readme

---
 README.md | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/README.md b/README.md
index 5328849317..6a43287fc7 100644
--- a/README.md
+++ b/README.md
@@ -235,11 +235,11 @@ different.
 # Progress
 
 At this point we focus on porting lisp functions from C to Rust.
-Currently there are 555 functions in Rust and 911 in C (January 2019).
+Currently there are 580 functions in Rust and 879 in C (February 2019).
 
 We have a [progress section](https://github.com/Wilfred/remacs/wiki/Progress) in our wiki
 and there's also a list of [long-term goals](https://github.com/Wilfred/remacs/projects/1) 
-in the project section.
+under projects.
 
 # Porting Elisp Primitive Functions
 
-- 
2.21.0


From 1b57b303ed2e78c4b84cddde09776e5cf9c6e1da Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Fri, 1 Feb 2019 17:08:07 +0100
Subject: [PATCH 252/297] Throw an error if pkg-config is missing (#1298)

---
 configure.ac | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/configure.ac b/configure.ac
index 5899c0f0a3..f7a10bfea8 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1592,6 +1592,9 @@ pre_PKG_CONFIG_CFLAGS=$CFLAGS
 pre_PKG_CONFIG_LIBS=$LIBS
 
 PKG_PROG_PKG_CONFIG(0.9.0)
+if test x$PKG_CONFIG = x ; then
+  AC_MSG_ERROR([pkg-config not found.])
+fi
 
 dnl EMACS_CHECK_MODULES(GSTUFF, gtk+-2.0 >= 1.3 glib = 1.3.4)
 dnl acts like PKG_CHECK_MODULES(GSTUFF, gtk+-2.0 >= 1.3 glib = 1.3.4,
-- 
2.21.0


From 82733f5262eac83c6f7d9a06b1ccbfcf5ca40f55 Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Fri, 1 Feb 2019 17:50:20 +0100
Subject: [PATCH 253/297] Port window-lines-pixel-dimensions (#1296)

* Various fixes, glyphs module

check_range changed to be a function using generics. Some if let
statements were replaced with matches, and cons conversion to lisp
object was made nicer.

Additionally, types and functions handing glyphs were moved to a
new module.

* use more expressiveness, fix min arguments

* Undo glyphs module
---
 rust_src/src/buffers.rs |   4 +
 rust_src/src/numbers.rs |  22 ++++-
 rust_src/src/windows.rs | 198 ++++++++++++++++++++++++++++++++++++++--
 src/window.c            | 124 -------------------------
 4 files changed, 216 insertions(+), 132 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 8812cae905..14f22f6e9f 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -352,6 +352,10 @@ impl LispBufferRef {
         unsafe { (*self.text).chars_modiff }
     }
 
+    pub fn overlay_modifications(self) -> EmacsInt {
+        unsafe { (*self.text).overlay_modiff }
+    }
+
     pub fn z_byte(self) -> ptrdiff_t {
         unsafe { (*self.text).z_byte }
     }
diff --git a/rust_src/src/numbers.rs b/rust_src/src/numbers.rs
index c05f44a8a2..f3ada5eea2 100644
--- a/rust_src/src/numbers.rs
+++ b/rust_src/src/numbers.rs
@@ -1,8 +1,10 @@
 //! Functions operating on numbers.
 
-use rand::{Rng, SeedableRng, StdRng};
+use std::cmp;
 use std::sync::Mutex;
 
+use rand::{Rng, SeedableRng, StdRng};
+
 use remacs_macros::lisp_fn;
 
 use crate::{
@@ -158,6 +160,24 @@ impl IsLispNatnum for EmacsInt {
     }
 }
 
+/// Check if NUM is within range [FROM..TO]
+pub fn check_range(num: impl Into<EmacsInt>, from: impl Into<EmacsInt>, to: impl Into<EmacsInt>) {
+    let num: EmacsInt = num.into();
+    let from: EmacsInt = from.into();
+    let to: EmacsInt = to.into();
+    if !(from <= num && num <= to) {
+        args_out_of_range!(
+            num,
+            if from < 0 && from < MOST_NEGATIVE_FIXNUM {
+                MOST_NEGATIVE_FIXNUM
+            } else {
+                from
+            },
+            cmp::min(to, MOST_POSITIVE_FIXNUM)
+        )
+    }
+}
+
 impl LispNumber {
     pub fn to_fixnum(&self) -> EmacsInt {
         match *self {
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 27d8d98acd..3627330ac7 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -14,19 +14,22 @@ use crate::{
     lisp::{ExternalPtr, LispObject},
     lists::{assq, setcdr},
     marker::{marker_position_lisp, set_marker_restricted},
+    numbers::{check_range, LispNumber},
     remacs_sys::face_id::HEADER_LINE_FACE_ID,
     remacs_sys::globals,
-    remacs_sys::Fcopy_alist,
+    remacs_sys::glyph_row_area::TEXT_AREA,
     remacs_sys::{
         estimate_mode_line_height, minibuf_level,
-        minibuf_selected_window as current_minibuf_window, scroll_command, select_window,
-        selected_window as current_window, set_buffer_internal, set_window_hscroll,
-        update_mode_lines, window_list_1, window_menu_bar_p, window_tool_bar_p, wset_redisplay,
+        minibuf_selected_window as current_minibuf_window, noninteractive, scroll_command,
+        select_window, selected_window as current_window, set_buffer_internal, set_window_hscroll,
+        update_mode_lines, window_list_1, window_menu_bar_p, window_tool_bar_p,
+        windows_or_buffers_changed, wset_redisplay,
     },
     remacs_sys::{
-        face_id, glyph_matrix, pvec_type, vertical_scroll_bar_type, EmacsInt, Lisp_Type,
+        face_id, glyph_matrix, glyph_row, pvec_type, vertical_scroll_bar_type, EmacsInt, Lisp_Type,
         Lisp_Window,
     },
+    remacs_sys::{Fcopy_alist, Fnreverse},
     remacs_sys::{
         Qceiling, Qfloor, Qheader_line_format, Qleft, Qmode_line_format, Qnil, Qnone, Qright, Qt,
         Qwindow_live_p, Qwindow_valid_p, Qwindowp,
@@ -47,6 +50,12 @@ impl LispWindowRef {
         self.pseudo_window_p()
     }
 
+    pub fn is_outdated(self) -> bool {
+        let buffer: LispBufferRef = self.contents.into();
+        self.last_modified < buffer.modifications()
+            || self.last_overlay_modified < buffer.overlay_modifications()
+    }
+
     /// A window of any sort, leaf or interior, is "valid" if its
     /// contents slot is non-nil.
     pub fn is_valid(self) -> bool {
@@ -80,8 +89,7 @@ impl LispWindowRef {
     /// a default based on the height of the font of the face `mode-line'.
     pub fn current_mode_line_height(&mut self) -> i32 {
         let mode_line_height = self.mode_line_height;
-        let matrix_mode_line_height =
-            LispGlyphMatrixRef::new(self.current_matrix).mode_line_height();
+        let matrix_mode_line_height = self.get_matrix().mode_line_height();
 
         if mode_line_height >= 0 {
             mode_line_height
@@ -502,6 +510,22 @@ impl LispWindowRef {
             self.get_frame().config_scroll_bar_height
         }
     }
+
+    /// Return the bottom boundary y-position for text lines in window W.
+    /// This is the first y position at which a line cannot start.
+    /// It is relative to the top of the window.
+    ///
+    /// This is the height of W minus the height of a mode line, if any.
+    pub fn text_bottom_y(mut self) -> i32 {
+        self.pixel_height
+            - self.bottom_divider_width()
+            - self.scroll_bar_area_height()
+            - if self.wants_mode_line() {
+                self.current_mode_line_height()
+            } else {
+                0
+            }
+    }
 }
 
 impl From<LispObject> for LispWindowRef {
@@ -572,6 +596,17 @@ impl LispObject {
 pub type LispGlyphMatrixRef = ExternalPtr<glyph_matrix>;
 
 impl LispGlyphMatrixRef {
+    /// Get a pointer to row number ROW.
+    pub unsafe fn row_unchecked(self, row: usize) -> LispGlyphRowRef {
+        LispGlyphRowRef::new(self.rows.add(row))
+    }
+
+    /// Get a pointer to row number ROW. Throws an error if out of range.
+    pub fn row(self, row: usize) -> LispGlyphRowRef {
+        check_range(row as EmacsInt, 0, self.nrows);
+        unsafe { self.row_unchecked(row) }
+    }
+
     pub fn mode_line_height(self) -> i32 {
         if self.is_null() || self.rows.is_null() {
             0
@@ -586,8 +621,29 @@ impl LispGlyphMatrixRef {
             unsafe { (*self.rows).height }
         }
     }
+
+    /// Return a pointer to the first row used for text display
+    pub fn first_text_row(self) -> LispGlyphRowRef {
+        unsafe {
+            if (*self.rows).mode_line_p() {
+                LispGlyphRowRef::new(self.rows.offset(1))
+            } else {
+                LispGlyphRowRef::new(self.rows)
+            }
+        }
+    }
+
+    pub fn bottom_text_row(self, window: LispWindowRef) -> LispGlyphRowRef {
+        let ptr = unsafe {
+            self.rows
+                .offset((self.nrows - if window.wants_mode_line() { 1 } else { 0 }) as isize)
+        };
+        LispGlyphRowRef::new(ptr)
+    }
 }
 
+pub type LispGlyphRowRef = ExternalPtr<glyph_row>;
+
 #[derive(Debug)]
 pub struct LispWindowOrSelected(LispObject);
 
@@ -1536,4 +1592,132 @@ pub fn window_body_width_lisp(window: LispWindowLiveOrSelected, pixelwise: bool)
     window.body_width(pixelwise).into()
 }
 
+/// Return pixel dimensions of WINDOW's lines.
+/// The return value is a list of the x- and y-coordinates of the lower
+/// right corner of the last character of each line.  Return nil if the
+/// current glyph matrix of WINDOW is not up-to-date.
+///
+/// Optional argument WINDOW specifies the window whose lines' dimensions
+/// shall be returned.  Nil or omitted means to return the dimensions for
+/// the selected window.
+///
+/// FIRST, if non-nil, specifies the index of the first line whose
+/// dimensions shall be returned.  If FIRST is nil and BODY is non-nil,
+/// start with the first text line of WINDOW.  Otherwise, start with the
+/// first line of WINDOW.
+///
+/// LAST, if non-nil, specifies the last line whose dimensions shall be
+/// returned.  If LAST is nil and BODY is non-nil, the last line is the last
+/// line of the body (text area) of WINDOW.  Otherwise, last is the last
+/// line of WINDOW.
+///
+/// INVERSE, if nil, means that the y-pixel value returned for a specific
+/// line specifies the distance in pixels from the left edge (body edge if
+/// BODY is non-nil) of WINDOW to the right edge of the last glyph of that
+/// line.  INVERSE non-nil means that the y-pixel value returned for a
+/// specific line specifies the distance in pixels from the right edge of
+/// the last glyph of that line to the right edge (body edge if BODY is
+/// non-nil) of WINDOW.
+///
+/// LEFT non-nil means to return the x- and y-coordinates of the lower left
+/// corner of the leftmost character on each line.  This is the value that
+/// should be used for buffers that mostly display text from right to left.
+///
+/// If LEFT is non-nil and INVERSE is nil, this means that the y-pixel value
+/// returned for a specific line specifies the distance in pixels from the
+/// left edge of the last (leftmost) glyph of that line to the right edge
+/// (body edge if BODY is non-nil) of WINDOW.  If LEFT and INVERSE are both
+/// non-nil, the y-pixel value returned for a specific line specifies the
+/// distance in pixels from the left edge (body edge if BODY is non-nil) of
+/// WINDOW to the left edge of the last (leftmost) glyph of that line.
+///
+/// Normally, the value of this function is not available while Emacs is
+/// busy, for example, when processing a command.  It should be retrievable
+/// though when run from an idle timer with a delay of zero seconds.
+#[lisp_fn(min = "0")]
+pub fn window_lines_pixel_dimensions(
+    window: LispWindowLiveOrSelected,
+    first: Option<LispNumber>,
+    last: Option<LispNumber>,
+    body: bool,
+    inverse: bool,
+    left: bool,
+) -> LispObject {
+    let window: LispWindowRef = window.into();
+    let buffer: LispBufferRef = window.contents.into();
+    let max_y = if body {
+        window.text_bottom_y()
+    } else {
+        window.pixel_height
+    };
+    let window_width = if body {
+        window.body_width(true)
+    } else {
+        window.pixel_width
+    };
+    let header_line_height = window.header_line_height();
+    let subtract = if body { header_line_height } else { 0 };
+    let matrix = window.get_matrix();
+
+    if unsafe { noninteractive } || window.is_pseudo() {
+        return Qnil;
+    }
+
+    // Fail if current matrix is not up to date.
+    unsafe {
+        if !window.window_end_valid()
+            || windows_or_buffers_changed > 0
+            || buffer.clip_changed()
+            || buffer.prevent_redisplay_optimizations_p()
+            || window.is_outdated()
+        {
+            return Qnil;
+        }
+    }
+
+    let mut row = match first {
+        Some(first) => matrix.row(first.to_fixnum() as usize),
+        None => {
+            if body {
+                matrix.first_text_row()
+            } else {
+                matrix.row(0)
+            }
+        }
+    };
+
+    let end_row = match last {
+        Some(last) => matrix.row(last.to_fixnum() as usize),
+        None => {
+            if body {
+                matrix.bottom_text_row(window)
+            } else {
+                unsafe { matrix.row_unchecked(matrix.nrows as usize) }
+            }
+        }
+    };
+
+    let mut rows = Qnil;
+    while row.as_ptr() <= end_row.as_ptr() && row.enabled_p() && row.y + row.height < max_y {
+        let width = if left {
+            let glyph = unsafe { &*row.glyphs[TEXT_AREA as usize] };
+            if inverse {
+                glyph.pixel_width as i32
+            } else {
+                window_width - glyph.pixel_width as i32
+            }
+        } else {
+            if inverse {
+                window_width - row.pixel_width
+            } else {
+                row.pixel_width
+            }
+        };
+        rows = ((width, row.y + row.height - subtract), rows).into();
+        let ptr = unsafe { row.as_mut().add(1) };
+        row.replace_ptr(ptr);
+    }
+    unsafe { Fnreverse(rows) }
+}
+
 include!(concat!(env!("OUT_DIR"), "/windows_exports.rs"));
diff --git a/src/window.c b/src/window.c
index a9a1a60fa1..8ddaf118c0 100644
--- a/src/window.c
+++ b/src/window.c
@@ -1299,129 +1299,6 @@ Return nil if window display is not up-to-date.  In that case, use
   return list4i (row->height + min (0, row->y) - crop, i, row->y, crop);
 }
 
-DEFUN ("window-lines-pixel-dimensions", Fwindow_lines_pixel_dimensions, Swindow_lines_pixel_dimensions, 0, 6, 0,
-       doc: /* Return pixel dimensions of WINDOW's lines.
-The return value is a list of the x- and y-coordinates of the lower
-right corner of the last character of each line.  Return nil if the
-current glyph matrix of WINDOW is not up-to-date.
-
-Optional argument WINDOW specifies the window whose lines' dimensions
-shall be returned.  Nil or omitted means to return the dimensions for
-the selected window.
-
-FIRST, if non-nil, specifies the index of the first line whose
-dimensions shall be returned.  If FIRST is nil and BODY is non-nil,
-start with the first text line of WINDOW.  Otherwise, start with the
-first line of WINDOW.
-
-LAST, if non-nil, specifies the last line whose dimensions shall be
-returned.  If LAST is nil and BODY is non-nil, the last line is the last
-line of the body (text area) of WINDOW.  Otherwise, last is the last
-line of WINDOW.
-
-INVERSE, if nil, means that the y-pixel value returned for a specific
-line specifies the distance in pixels from the left edge (body edge if
-BODY is non-nil) of WINDOW to the right edge of the last glyph of that
-line.  INVERSE non-nil means that the y-pixel value returned for a
-specific line specifies the distance in pixels from the right edge of
-the last glyph of that line to the right edge (body edge if BODY is
-non-nil) of WINDOW.
-
-LEFT non-nil means to return the x- and y-coordinates of the lower left
-corner of the leftmost character on each line.  This is the value that
-should be used for buffers that mostly display text from right to left.
-
-If LEFT is non-nil and INVERSE is nil, this means that the y-pixel value
-returned for a specific line specifies the distance in pixels from the
-left edge of the last (leftmost) glyph of that line to the right edge
-(body edge if BODY is non-nil) of WINDOW.  If LEFT and INVERSE are both
-non-nil, the y-pixel value returned for a specific line specifies the
-distance in pixels from the left edge (body edge if BODY is non-nil) of
-WINDOW to the left edge of the last (leftmost) glyph of that line.
-
-Normally, the value of this function is not available while Emacs is
-busy, for example, when processing a command.  It should be retrievable
-though when run from an idle timer with a delay of zero seconds.  */)
-  (Lisp_Object window, Lisp_Object first, Lisp_Object last, Lisp_Object body, Lisp_Object inverse, Lisp_Object left)
-{
-  struct window *w = decode_live_window (window);
-  struct buffer *b;
-  struct glyph_row *row, *end_row;
-  int max_y = NILP (body) ? WINDOW_PIXEL_HEIGHT (w) : window_text_bottom_y (w);
-  Lisp_Object rows = Qnil;
-  int window_width = NILP (body) ? w->pixel_width : window_body_width (w, true);
-  int header_line_height = WINDOW_HEADER_LINE_HEIGHT (w);
-  int subtract = NILP (body) ? 0 : header_line_height;
-  bool invert = !NILP (inverse);
-  bool left_flag = !NILP (left);
-
-  if (noninteractive || w->pseudo_window_p)
-    return Qnil;
-
-  CHECK_BUFFER (w->contents);
-  b = XBUFFER (w->contents);
-
-  /* Fail if current matrix is not up-to-date.  */
-  if (!w->window_end_valid
-      || windows_or_buffers_changed
-      || b->clip_changed
-      || b->prevent_redisplay_optimizations_p
-      || window_outdated (w))
-    return Qnil;
-
-  if (NILP (first))
-    row = (NILP (body)
-	   ? MATRIX_ROW (w->current_matrix, 0)
-	   : MATRIX_FIRST_TEXT_ROW (w->current_matrix));
-  else if (NUMBERP (first))
-    {
-      CHECK_RANGED_INTEGER (first, 0, w->current_matrix->nrows);
-      row = MATRIX_ROW (w->current_matrix, XINT (first));
-    }
-  else
-    error ("Invalid specification of first line");
-
-  if (NILP (last))
-
-    end_row = (NILP (body)
-	       ? MATRIX_ROW (w->current_matrix, w->current_matrix->nrows)
-	       : MATRIX_BOTTOM_TEXT_ROW (w->current_matrix, w));
-  else if (NUMBERP (last))
-    {
-      CHECK_RANGED_INTEGER (last, 0, w->current_matrix->nrows);
-      end_row = MATRIX_ROW (w->current_matrix, XINT (last));
-    }
-  else
-    error ("Invalid specification of last line");
-
-  while (row <= end_row && row->enabled_p
-	 && row->y + row->height < max_y)
-    {
-
-      if (left_flag)
-	{
-	  struct glyph *glyph = row->glyphs[TEXT_AREA];
-
-	  rows = Fcons (Fcons (make_number
-			       (invert
-				? glyph->pixel_width
-				: window_width - glyph->pixel_width),
-			       make_number (row->y + row->height - subtract)),
-			rows);
-	}
-      else
-	rows = Fcons (Fcons (make_number
-			     (invert
-			      ? window_width - row->pixel_width
-			      : row->pixel_width),
-			     make_number (row->y + row->height - subtract)),
-		      rows);
-      row++;
-    }
-
-  return Fnreverse (rows);
-}
-
 struct Lisp_Char_Table *
 window_display_table (struct window *w)
 {
@@ -6584,7 +6461,6 @@ displayed after a scrolling operation to be somewhat inaccurate.  */);
   defsubr (&Scoordinates_in_window_p);
   defsubr (&Swindow_at);
   defsubr (&Swindow_end);
-  defsubr (&Swindow_lines_pixel_dimensions);
   defsubr (&Snext_window);
   defsubr (&Sprevious_window);
   defsubr (&Sget_buffer_window);
-- 
2.21.0


From dc815226c5dec685808df44a2c5ceccea1cd62e1 Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Fri, 1 Feb 2019 09:17:37 -0800
Subject: [PATCH 254/297] Refactor buffer_objfwd support. (#1304)

Adds `as_buffer_objfwd()` which returns an `Option<Lisp_Buffer_Objfwd>`.
This simplifies the common use of the object. Remove `if_chain` now
that the code is simpler.
---
 rust_src/Cargo.lock     |  7 -------
 rust_src/Cargo.toml.in  |  1 -
 rust_src/src/buffers.rs | 14 ++++++++++---
 rust_src/src/data.rs    | 44 ++++++++++++++++++++---------------------
 rust_src/src/lib.rs     |  2 --
 5 files changed, 33 insertions(+), 35 deletions(-)

diff --git a/rust_src/Cargo.lock b/rust_src/Cargo.lock
index 1358a7fca6..28bdafc829 100644
--- a/rust_src/Cargo.lock
+++ b/rust_src/Cargo.lock
@@ -208,11 +208,6 @@ name = "ident_case"
 version = "1.0.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
-[[package]]
-name = "if_chain"
-version = "0.1.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
 [[package]]
 name = "lazy_static"
 version = "1.2.0"
@@ -372,7 +367,6 @@ dependencies = [
  "errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
  "field-offset 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
  "flate2 1.0.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "if_chain 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
  "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
  "line-wrap 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -575,7 +569,6 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 "checksum gcc 0.3.55 (registry+https://github.com/rust-lang/crates.io-index)" = "8f5f3913fa0bfe7ee1fd8248b6b9f42a5af4b9d65ec2dd2c3c26132b950ecfc2"
 "checksum generic-array 0.12.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3c0f28c2f5bfb5960175af447a2da7c18900693738343dc896ffbcabd9839592"
 "checksum ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3c9826188e666f2ed92071d2dadef6edc430b11b158b5b2b3f4babbcc891eaaa"
-"checksum if_chain 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "4bac95d9aa0624e7b78187d6fb8ab012b41d9f6f54b1bcb61e61c4845f8357ec"
 "checksum lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "a374c89b9db55895453a74c1e38861d9deec0b01b405a82516e9d5de4820dea1"
 "checksum libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)" = "48450664a984b25d5b479554c29cc04e3150c97aa4c01da5604a2d4ed9151476"
 "checksum line-wrap 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "f30344350a2a51da54c1d53be93fade8a237e545dbcc4bdbe635413f2117cab9"
diff --git a/rust_src/Cargo.toml.in b/rust_src/Cargo.toml.in
index 5901574c6f..b35c2cae98 100644
--- a/rust_src/Cargo.toml.in
+++ b/rust_src/Cargo.toml.in
@@ -22,7 +22,6 @@ cfg-if = "0.1"
 errno = "0.2"
 field-offset = "0.1"
 flate2 = { version = "1.0", features = ["rust_backend"], default-features = false }
-if_chain = "0.1"
 lazy_static = "1.2"
 libc = "0.2"
 line-wrap = "0.1.1"
diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 14f22f6e9f..bf93359887 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -3,6 +3,7 @@
 use std::sync::Mutex;
 use std::{self, mem, ptr};
 
+use field_offset::FieldOffset;
 use libc::{self, c_char, c_int, c_uchar, c_void, ptrdiff_t};
 
 use rand::{Rng, StdRng};
@@ -1157,10 +1158,17 @@ pub fn generate_new_buffer_name(name: LispStringRef, ignore: LispObject) -> Lisp
     }
 }
 
-pub unsafe fn per_buffer_idx(offset: isize) -> isize {
+pub unsafe fn per_buffer_idx_from_field_offset(
+    offset: FieldOffset<Lisp_Buffer, LispObject>,
+) -> isize {
+    let obj = *offset.apply_ptr_mut(&mut buffer_local_flags);
+    obj.to_fixnum_unchecked() as isize
+}
+
+pub unsafe fn per_buffer_idx(count: isize) -> isize {
     let flags = &mut buffer_local_flags as *mut Lisp_Buffer as *mut LispObject;
-    let obj = flags.offset(offset);
-    (*obj).as_fixnum_or_error() as isize
+    let obj = flags.offset(count);
+    (*obj).to_fixnum_unchecked() as isize
 }
 
 /// Return a list of overlays which is a copy of the overlay list
diff --git a/rust_src/src/data.rs b/rust_src/src/data.rs
index 9994dd141d..ff49985191 100644
--- a/rust_src/src/data.rs
+++ b/rust_src/src/data.rs
@@ -6,7 +6,7 @@ use libc::{c_char, c_int};
 use remacs_macros::lisp_fn;
 
 use crate::{
-    buffers::per_buffer_idx,
+    buffers::{per_buffer_idx, per_buffer_idx_from_field_offset},
     frames::selected_frame,
     keymap::get_keymap,
     lisp::is_autoload,
@@ -23,7 +23,7 @@ use crate::{
         symbol_trapped_write, valid_lisp_object_p, wrong_choice, wrong_range, CHAR_TABLE_SET,
         CHECK_IMPURE,
     },
-    remacs_sys::{buffer_local_flags, per_buffer_default, symbol_redirect},
+    remacs_sys::{per_buffer_default, symbol_redirect},
     remacs_sys::{pvec_type, BoolVectorOp, EmacsInt, Lisp_Misc_Type, Lisp_Type, Set_Internal_Bind},
     remacs_sys::{Fdelete, Fpurecopy},
     remacs_sys::{Lisp_Buffer, Lisp_Subr_Lang},
@@ -40,14 +40,21 @@ use crate::{
 };
 
 // Lisp_Fwd predicates which can go away as the callers are ported to Rust
+
 #[no_mangle]
 pub unsafe extern "C" fn KBOARD_OBJFWDP(a: *const Lisp_Fwd) -> bool {
+    is_kboard_objfwd(a)
+}
+
+pub unsafe fn is_kboard_objfwd(a: *const Lisp_Fwd) -> bool {
     (*a).u_intfwd.ty == Lisp_Fwd_Kboard_Obj
 }
 
-#[no_mangle]
-pub unsafe extern "C" fn OBJFWDP(a: *const Lisp_Fwd) -> bool {
-    (*a).u_intfwd.ty == Lisp_Fwd_Obj
+pub unsafe fn as_buffer_objfwd(a: *const Lisp_Fwd) -> Option<Lisp_Buffer_Objfwd> {
+    match (*a).u_intfwd.ty {
+        Lisp_Fwd_Buffer_Obj => Some((*a).u_buffer_objfwd),
+        _ => None,
+    }
 }
 
 /// Find the function at the end of a chain of symbol function indirections.
@@ -376,28 +383,21 @@ fn default_value(mut symbol: LispSymbolRef) -> LispObject {
                 d
             }
         }
-        symbol_redirect::SYMBOL_FORWARDED => {
-            let valcontents = unsafe { symbol.get_fwd() };
+        symbol_redirect::SYMBOL_FORWARDED => unsafe {
+            let valcontents = symbol.get_fwd();
 
             // For a built-in buffer-local variable, get the default value
             // rather than letting do_symval_forwarding get the current value.
-            if_chain! {
-                // if_chain! builds up a series of conditions and contitional assignments into one
-                // big pair of then/else arms. This should be converted into idiomatic Option-based
-                // code eventually.
-                if unsafe { (*valcontents).u_intfwd.ty } == Lisp_Fwd_Buffer_Obj;
-                let offset = unsafe { (*valcontents).u_buffer_objfwd.offset };
-                if unsafe {
-                    *offset.apply_ptr_mut(&mut buffer_local_flags)
-                }.as_fixnum_or_error() != 0;
-                then {
-                    unsafe { per_buffer_default(offset.get_byte_offset() as i32) }
-                } else {
-                    // For other variables, get the current value.
-                    unsafe { do_symval_forwarding(valcontents) }
+            if let Some(buffer_objfwd) = as_buffer_objfwd(valcontents) {
+                let offset = buffer_objfwd.offset;
+
+                if per_buffer_idx_from_field_offset(offset) != 0 {
+                    return per_buffer_default(offset.get_byte_offset() as i32);
                 }
             }
-        }
+            // For other variables, get the current value.
+            do_symval_forwarding(valcontents)
+        },
         _ => panic!("Symbol type has no default value"),
     }
 }
diff --git a/rust_src/src/lib.rs b/rust_src/src/lib.rs
index 896891097e..761127ed82 100644
--- a/rust_src/src/lib.rs
+++ b/rust_src/src/lib.rs
@@ -22,8 +22,6 @@
 
 extern crate errno;
 #[macro_use]
-extern crate if_chain;
-#[macro_use]
 extern crate lazy_static;
 
 extern crate base64 as base64_crate;
-- 
2.21.0


From ed22d939b1000b79367de24749de3153358bd61e Mon Sep 17 00:00:00 2001
From: Ashton Kemerling <ashtonkemerling@gmail.com>
Date: Sat, 2 Feb 2019 04:56:46 -0800
Subject: [PATCH 255/297] Port window-new-pixel. (#1314)

Port window-new-pixel
---
 rust_src/src/windows.rs | 13 +++++++++++++
 src/window.c            | 14 --------------
 2 files changed, 13 insertions(+), 14 deletions(-)

diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 3627330ac7..e128b5b34a 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -728,6 +728,19 @@ pub fn window_live_p(object: Option<LispWindowRef>) -> bool {
     object.map_or(false, |m| m.is_live())
 }
 
+/// Return new pixel size of window WINDOW.
+/// WINDOW must be a valid window and defaults to the selected one.
+///
+/// The new pixel size of WINDOW is the value set by the last call of
+/// `set-window-new-pixel' for WINDOW.  If it is valid, it will be shortly
+/// installed as WINDOW's pixel height (see `window-pixel-height') or pixel
+/// width (see `window-pixel-width').
+#[lisp_fn(min = "0")]
+pub fn window_new_pixel(window: LispWindowValidOrSelected) -> EmacsInt {
+    let win: LispWindowRef = window.into();
+    win.new_pixel.into()
+}
+
 /// Return current value of point in WINDOW.
 /// WINDOW must be a live window and defaults to the selected one.
 ///
diff --git a/src/window.c b/src/window.c
index 8ddaf118c0..e2540aaf40 100644
--- a/src/window.c
+++ b/src/window.c
@@ -510,19 +510,6 @@ re-enlarged to its previous size.  */)
   return NILP (horizontal) ? w->normal_lines : w->normal_cols;
 }
 
-DEFUN ("window-new-pixel", Fwindow_new_pixel, Swindow_new_pixel, 0, 1, 0,
-       doc: /* Return new pixel size of window WINDOW.
-WINDOW must be a valid window and defaults to the selected one.
-
-The new pixel size of WINDOW is the value set by the last call of
-`set-window-new-pixel' for WINDOW.  If it is valid, it will be shortly
-installed as WINDOW's pixel height (see `window-pixel-height') or pixel
-width (see `window-pixel-width').  */)
-  (Lisp_Object window)
-{
-  return decode_valid_window (window)->new_pixel;
-}
-
 DEFUN ("window-pixel-left", Fwindow_pixel_left, Swindow_pixel_left, 0, 1, 0,
        doc: /* Return left pixel edge of window WINDOW.
 WINDOW must be a valid window and defaults to the selected one.  */)
@@ -6443,7 +6430,6 @@ displayed after a scrolling operation to be somewhat inaccurate.  */);
   defsubr (&Swindow_pixel_width_before_size_change);
   defsubr (&Swindow_pixel_height_before_size_change);
   defsubr (&Swindow_normal_size);
-  defsubr (&Swindow_new_pixel); 
   defsubr (&Swindow_pixel_left);
   defsubr (&Swindow_pixel_top);
   defsubr (&Swindow_left_column);
-- 
2.21.0


From ae12c7a3faadbc034cdae7813fabd4da6f96dce2 Mon Sep 17 00:00:00 2001
From: Ashton Kemerling <ashtonkemerling@gmail.com>
Date: Sat, 2 Feb 2019 17:10:32 -0800
Subject: [PATCH 256/297] Add autoconf and rustup to default.nix. (#1316)

Probably overkill since most Nix devs will have it pre-installed, but
it doesn't hurt to be thorough.
---
 default.nix | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/default.nix b/default.nix
index bd4fe5865b..dac1b7fded 100644
--- a/default.nix
+++ b/default.nix
@@ -10,7 +10,7 @@ stdenv.mkDerivation rec {
   buildInputs = [
     systemd texinfo libjpeg libtiff giflib xorg.libXpm gtk3
     gnutls ncurses libxml2 xorg.libXt imagemagick librsvg gpm dbus
-    libotf clang_6 pkgconfig
+    libotf clang_6 pkgconfig autoconf rustup
   ];
 
   shellHook = ''
-- 
2.21.0


From 1006142ba5c8f4f3de8156f2b904cd45537b9a07 Mon Sep 17 00:00:00 2001
From: Jacob MacDonald <jaccarmac@gmail.com>
Date: Sat, 2 Feb 2019 20:48:53 -0600
Subject: [PATCH 257/297] [Close #1299] Port rename-buffer.

---
 rust_src/src/buffers.rs | 70 ++++++++++++++++++++++++++++++++++++++---
 src/buffer.c            | 57 ---------------------------------
 2 files changed, 66 insertions(+), 61 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index bf93359887..90d9749d2c 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -20,12 +20,13 @@ use crate::{
     frames::LispFrameRef,
     hashtable::LispHashTableRef,
     lisp::{ExternalPtr, LispMiscRef, LispObject, LispStructuralEqual, LiveBufferIter},
-    lists::{car, cdr, list, member},
+    lists::{car, cdr, list, member, rassq, setcar},
     lists::{LispConsCircularChecks, LispConsEndChecks},
     marker::{build_marker, marker_buffer, marker_position_lisp, set_marker_both, LispMarkerRef},
     multibyte::LispStringRef,
     multibyte::{multibyte_length_by_head, string_char},
     numbers::MOST_POSITIVE_FIXNUM,
+    obarray::intern,
     remacs_sys::{
         allocate_misc, bset_update_mode_line, buffer_local_flags, buffer_local_value,
         buffer_window_count, concat2, del_range, delete_all_overlays, globals, last_per_buffer_idx,
@@ -35,12 +36,13 @@ use crate::{
     },
     remacs_sys::{
         buffer_defaults, equal_kind, pvec_type, EmacsInt, Lisp_Buffer, Lisp_Buffer_Local_Value,
-        Lisp_Misc_Type, Lisp_Overlay, Lisp_Type, Vbuffer_alist,
+        Lisp_Misc_Type, Lisp_Overlay, Lisp_Type, Vbuffer_alist, Vrun_hooks,
     },
     remacs_sys::{Fcopy_sequence, Fget_text_property, Fnconc, Fnreverse},
     remacs_sys::{
-        Qafter_string, Qbefore_string, Qbuffer_read_only, Qbufferp, Qget_file_buffer,
-        Qinhibit_quit, Qinhibit_read_only, Qnil, Qoverlayp, Qt, Qunbound, UNKNOWN_MODTIME_NSECS,
+        Qafter_string, Qbefore_string, Qbuffer_list_update_hook, Qbuffer_read_only, Qbufferp,
+        Qget_file_buffer, Qinhibit_quit, Qinhibit_read_only, Qnil, Qoverlayp, Qt, Qunbound,
+        UNKNOWN_MODTIME_NSECS,
     },
     strings::string_equal,
     threads::{c_specpdl_index, ThreadState},
@@ -1228,4 +1230,64 @@ pub extern "C" fn rust_syms_of_buffer() {
     defvar_per_buffer!(header_line_format_, "header-line-format", Qnil);
 }
 
+/// Change current buffer's name to NEWNAME (a string).  If second arg
+/// UNIQUE is nil or omitted, it is an error if a buffer named NEWNAME
+/// already exists.  If UNIQUE is non-nil, come up with a new name
+/// using `generate-new-buffer-name'.  Interactively, you can set
+/// UNIQUE with a prefix argument.  We return the name we actually
+/// gave the buffer.  This does not change the name of the visited
+/// file (if any).
+#[lisp_fn(
+    min = "1",
+    intspec = "(list (read-string \"Rename buffer (to new name): \" nil 'buffer-name-history (buffer-name (current-buffer))) current-prefix-arg)"
+)]
+pub fn rename_buffer(newname: LispStringRef, unique: LispObject) -> LispStringRef {
+    if newname.is_empty() {
+        error!("Empty string is invalid as a buffer name")
+    }
+
+    let mut current_buffer = ThreadState::current_buffer_unchecked();
+
+    let newname = get_buffer(LispBufferOrName::Name(newname.into())).map_or(newname, |tem| {
+        // Don't short-circuit if UNIQUE is t.  That is a useful
+        // way to rename the buffer automatically so you can
+        // create another with the original name.  It makes UNIQUE
+        // equivalent to
+        // (rename-buffer (generate-new-buffer-name NEWNAME)).
+        if unique.is_nil() {
+            if tem == current_buffer {
+                return current_buffer.name_.into();
+            }
+            error!("Buffer name `{}' is in use", newname)
+        } else {
+            generate_new_buffer_name(newname, current_buffer.name_)
+        }
+    });
+
+    current_buffer.name_ = newname.into();
+
+    // Catch redisplay's attention.  Unless we do this, the mode lines
+    // for any windows displaying current_buffer will stay unchanged.
+    unsafe {
+        update_mode_lines = 11;
+    }
+
+    let buf: LispBufferRef = current_buffer;
+    unsafe {
+        setcar(rassq(buf.into(), Vbuffer_alist).into(), newname.into());
+    }
+    if current_buffer.filename_.is_nil() && current_buffer.auto_save_file_name_.is_not_nil() {
+        call!(intern("rename-auto-save-file").into());
+    }
+
+    unsafe {
+        if Vrun_hooks.is_not_nil() {
+            call!(Vrun_hooks, Qbuffer_list_update_hook);
+        }
+    }
+
+    // Refetch since that last call may have done GC.
+    ThreadState::current_buffer_unchecked().name_.into()
+}
+
 include!(concat!(env!("OUT_DIR"), "/buffers_exports.rs"));
diff --git a/src/buffer.c b/src/buffer.c
index 2d219b185c..3a13d67f11 100644
--- a/src/buffer.c
+++ b/src/buffer.c
@@ -1016,62 +1016,6 @@ state of the current buffer.  Use with care.  */)
 }
 
 
-DEFUN ("rename-buffer", Frename_buffer, Srename_buffer, 1, 2,
-       "(list (read-string \"Rename buffer (to new name): \" \
-	      nil 'buffer-name-history (buffer-name (current-buffer))) \
-	      current-prefix-arg)",
-       doc: /* Change current buffer's name to NEWNAME (a string).
-If second arg UNIQUE is nil or omitted, it is an error if a
-buffer named NEWNAME already exists.
-If UNIQUE is non-nil, come up with a new name using
-`generate-new-buffer-name'.
-Interactively, you can set UNIQUE with a prefix argument.
-We return the name we actually gave the buffer.
-This does not change the name of the visited file (if any).  */)
-  (register Lisp_Object newname, Lisp_Object unique)
-{
-  register Lisp_Object tem, buf;
-
-  CHECK_STRING (newname);
-
-  if (SCHARS (newname) == 0)
-    error ("Empty string is invalid as a buffer name");
-
-  tem = Fget_buffer (newname);
-  if (!NILP (tem))
-    {
-      /* Don't short-circuit if UNIQUE is t.  That is a useful way to
-	 rename the buffer automatically so you can create another
-	 with the original name.  It makes UNIQUE equivalent to
-	 (rename-buffer (generate-new-buffer-name NEWNAME)).  */
-      if (NILP (unique) && XBUFFER (tem) == current_buffer)
-	return BVAR (current_buffer, name);
-      if (!NILP (unique))
-	newname = Fgenerate_new_buffer_name (newname, BVAR (current_buffer, name));
-      else
-	error ("Buffer name `%s' is in use", SDATA (newname));
-    }
-
-  bset_name (current_buffer, newname);
-
-  /* Catch redisplay's attention.  Unless we do this, the mode lines for
-     any windows displaying current_buffer will stay unchanged.  */
-  update_mode_lines = 11;
-
-  XSETBUFFER (buf, current_buffer);
-  Fsetcar (Frassq (buf, Vbuffer_alist), newname);
-  if (NILP (BVAR (current_buffer, filename))
-      && !NILP (BVAR (current_buffer, auto_save_file_name)))
-    call0 (intern ("rename-auto-save-file"));
-
-  /* Run buffer-list-update-hook.  */
-  if (!NILP (Vrun_hooks))
-    call1 (Vrun_hooks, Qbuffer_list_update_hook);
-
-  /* Refetch since that last call may have done GC.  */
-  return BVAR (current_buffer, name);
-}
-
 /* True if B can be used as 'other-than-BUFFER' buffer.  */
 
 static bool
@@ -5661,7 +5605,6 @@ Functions running this hook are, `get-buffer-create',
   defsubr (&Smake_indirect_buffer);
   defsubr (&Sbuffer_local_variables);
   defsubr (&Sset_buffer_modified_p);
-  defsubr (&Srename_buffer);
   defsubr (&Sother_buffer);
   defsubr (&Sbuffer_enable_undo);
   defsubr (&Skill_buffer);
-- 
2.21.0


From 10e72045e83ee23a3862e5164742c7f71c969e68 Mon Sep 17 00:00:00 2001
From: Jacob MacDonald <jaccarmac@gmail.com>
Date: Sat, 2 Feb 2019 20:49:18 -0600
Subject: [PATCH 258/297] Add tests for rename-buffer behavior.

---
 test/rust_src/src/buffers-tests.el | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)

diff --git a/test/rust_src/src/buffers-tests.el b/test/rust_src/src/buffers-tests.el
index 2591163a3e..6e8056c0e7 100644
--- a/test/rust_src/src/buffers-tests.el
+++ b/test/rust_src/src/buffers-tests.el
@@ -63,6 +63,28 @@
     (should (equal (delq nil (delete-dups the-buffers))
                    the-buffers))))
 
+(ert-deftest test-rename-buffer ()
+    (let ((buf (get-buffer-create "test-rename-buffer")))
+      (with-current-buffer buf
+        (rename-buffer "test-rename-buffer-foo")
+        (should (string= (buffer-name buf) "test-rename-buffer-foo")))))
+
+(ert-deftest test-rename-buffer-empty ()
+    (let ((buf (get-buffer-create "test-rename-buffer-empty")))
+      (with-current-buffer buf
+        (should-error (rename-buffer "")))))
+
+(ert-deftest test-rename-buffer-existing ()
+    (let ((buf (get-buffer-create "test-rename-buffer-existing")))
+      (with-current-buffer buf
+        (should-error (rename-buffer "test-rename-buffer-foo")))))
+
+(ert-deftest test-rename-buffer-unique ()
+    (let ((buf (get-buffer-create "test-rename-buffer")))
+      (with-current-buffer buf
+        (rename-buffer "test-rename-buffer-foo" t)
+        (should (string= (buffer-name buf) "test-rename-buffer-foo<2>")))))
+
 (provide 'buffers-tests)
 
 ;;; buffers-tests.el ends here
-- 
2.21.0


From c9edde024abebea44950226c6bc7c720b8148d8f Mon Sep 17 00:00:00 2001
From: Daichi Mukai <mukai.daichi.37e@kyoto-u.jp>
Date: Sun, 3 Feb 2019 17:37:40 +0900
Subject: [PATCH 259/297] Fix error on describe-function for adviced builtin
 function (#1319)

`subr-lang` gets `wrong-type-argument` for adviced builtin function
because `subr-lang` expects an argument is a subroutine but adviced
function is no longer regarded as subroutine.

Without this change, `describe-function` signals an error if the
argument is an adviced subroutine such as `rename-buffer`.
Fortunately, in help-fns.el there is an analyzer of such functions
which enables us to get real definition and to call `subr-lang`.
---
 lisp/help-fns.el                | 2 +-
 test/rust_src/src/data-tests.el | 4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/lisp/help-fns.el b/lisp/help-fns.el
index 70c00154be..de3d10db48 100644
--- a/lisp/help-fns.el
+++ b/lisp/help-fns.el
@@ -677,7 +677,7 @@ Returns a list of the form (REAL-FUNCTION DEF ALIASED REAL-DEF)."
 	;; but that's completely wrong when the user used load-file.
 	(princ (format-message " in `%s'"
                                (if (eq file-name 'C-source)
-                                   (concat (subr-lang (indirect-function function)) " source code")
+                                   (concat (subr-lang def) " source code")
                                  (help-fns-short-filename file-name))))
 	;; Make a hyperlink to the library.
 	(with-current-buffer standard-output
diff --git a/test/rust_src/src/data-tests.el b/test/rust_src/src/data-tests.el
index 17ffe8738b..0b445a547c 100644
--- a/test/rust_src/src/data-tests.el
+++ b/test/rust_src/src/data-tests.el
@@ -112,10 +112,10 @@
   :expected-result :failed
   (should (equal "C" (subr-lang (symbol-function 'rename-buffer)))))
 
-(ert-deftest data-test--describe-function-smoke-fail ()
+(ert-deftest data-test--describe-function ()
   ;; `describe-function' relies on `subr-lang' in its implementation,
   ;; so run it here to make sure that it works.
-  :expected-result :failed
+  (describe-function 'car)
   (describe-function 'rename-buffer))
 
 (ert-deftest data-test--get-variable-documentation ()
-- 
2.21.0


From c2bda7fe9275ccd470a7f8f9b7a5e82e6890a4fa Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Sun, 3 Feb 2019 12:58:05 -0800
Subject: [PATCH 260/297] Clippy suggestions. (#1322)

---
 rust_src/src/dired_unix.rs | 19 +++++++++----------
 rust_src/src/fileio.rs     |  2 +-
 rust_src/src/fns.rs        |  2 +-
 rust_src/src/lib.rs        |  1 -
 rust_src/src/windows.rs    |  5 +++--
 5 files changed, 14 insertions(+), 15 deletions(-)

diff --git a/rust_src/src/dired_unix.rs b/rust_src/src/dired_unix.rs
index d5cc702352..a301187cfe 100644
--- a/rust_src/src/dired_unix.rs
+++ b/rust_src/src/dired_unix.rs
@@ -169,7 +169,7 @@ enum DirData {
 }
 
 impl DirData {
-    fn from_os(&mut self, dr: &DirReq) {
+    fn load(&mut self, dr: &DirReq) {
         match *self {
             DirData::Files { ref mut fnames } => {
                 fnames_from_os(fnames, &dr.dname, dr.match_re);
@@ -191,12 +191,12 @@ impl DirData {
         }
     }
 
-    fn to_list(&mut self, dr: &DirReq) -> LispObject {
+    fn to_list(&self, dr: &DirReq) -> LispObject {
         match *self {
-            DirData::Files { ref mut fnames } => fnames_to_list(fnames, &dr.dname, &dr.full),
+            DirData::Files { ref fnames } => fnames_to_list(fnames, &dr.dname, &dr.full),
             DirData::FilesAttrs {
-                ref mut fnames,
-                ref mut fattrs,
+                ref fnames,
+                ref fattrs,
             } => fattrs_to_list(fattrs, fnames, &dr.dname, &dr.full),
         }
     }
@@ -280,7 +280,7 @@ fn match_re_maybe(f: String, re: &Option<RegEx>) -> Option<String> {
     }
 }
 
-fn fnames_to_list(fnames: &mut Vec<String>, dname: &str, full: &FullPath) -> LispObject {
+fn fnames_to_list(fnames: &[String], dname: &str, full: &FullPath) -> LispObject {
     match *full {
         FullPath::No => list(&fnames.iter().map(|x| x.to_bstring()).collect::<Vec<_>>()),
         FullPath::Yes => list(
@@ -294,8 +294,8 @@ fn fnames_to_list(fnames: &mut Vec<String>, dname: &str, full: &FullPath) -> Lis
 }
 
 fn fattrs_to_list(
-    fattrs: &mut Vec<LispObject>,
-    fnames: &mut Vec<String>,
+    fattrs: &[LispObject],
+    fnames: &[String],
     dname: &str,
     full: &FullPath,
 ) -> LispObject {
@@ -321,8 +321,7 @@ fn fattrs_to_list(
 }
 
 fn directory_files_core(dr: &DirReq, dd: &mut DirData) -> LispObject {
-    dd.from_os(dr);
-
+    dd.load(dr);
     dd.to_list(dr)
 }
 
diff --git a/rust_src/src/fileio.rs b/rust_src/src/fileio.rs
index cb5eacbc92..a088719e0a 100644
--- a/rust_src/src/fileio.rs
+++ b/rust_src/src/fileio.rs
@@ -128,7 +128,7 @@ pub fn file_directory_p_lisp(filename: LispStringRef) -> bool {
     let handler = find_file_name_handler(absname.into(), Qfile_directory_p);
 
     if handler.is_not_nil() {
-        call!(handler, Qfile_directory_p, absname.into()).into()
+        call!(handler, Qfile_directory_p, absname).into()
     } else {
         unsafe { file_directory_p(encode_file_name(absname.into()).into()) }
     }
diff --git a/rust_src/src/fns.rs b/rust_src/src/fns.rs
index 147ed39091..a49550d721 100644
--- a/rust_src/src/fns.rs
+++ b/rust_src/src/fns.rs
@@ -353,7 +353,7 @@ pub fn yes_or_no_p(prompt: LispStringRef) -> bool {
     }
 
     let yes_or_no: LispObject = "(yes or no) ".into();
-    let prompt = concat(&mut vec![prompt.into(), yes_or_no]).into();
+    let prompt = concat(&mut [prompt.into(), yes_or_no]).into();
 
     loop {
         let ans: LispStringRef = downcase(read_from_minibuffer(
diff --git a/rust_src/src/lib.rs b/rust_src/src/lib.rs
index 761127ed82..ad49037ad0 100644
--- a/rust_src/src/lib.rs
+++ b/rust_src/src/lib.rs
@@ -1,5 +1,4 @@
 #![allow(clippy::cyclomatic_complexity)]
-#![allow(clippy::wrong_self_convention)]
 #![allow(clippy::too_many_arguments)]
 #![allow(clippy::not_unsafe_ptr_arg_deref)]
 #![allow(non_upper_case_globals)]
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index e128b5b34a..4f610d4d82 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -1712,12 +1712,13 @@ pub fn window_lines_pixel_dimensions(
 
     let mut rows = Qnil;
     while row.as_ptr() <= end_row.as_ptr() && row.enabled_p() && row.y + row.height < max_y {
+        #[allow(clippy::collapsible_if)] // The symmetry is worth ignoring this.
         let width = if left {
             let glyph = unsafe { &*row.glyphs[TEXT_AREA as usize] };
             if inverse {
-                glyph.pixel_width as i32
+                i32::from(glyph.pixel_width)
             } else {
-                window_width - glyph.pixel_width as i32
+                window_width - i32::from(glyph.pixel_width)
             }
         } else {
             if inverse {
-- 
2.21.0


From c6c547dced9691e8cd6c24823d8fbca91e81f03b Mon Sep 17 00:00:00 2001
From: Georgy Komarov <jubnzv@gmail.com>
Date: Sun, 3 Feb 2019 23:59:06 +0300
Subject: [PATCH 261/297] Port condition-case (#1323)

Fix #1306
---
 rust_src/src/eval.rs | 37 +++++++++++++++++++++++++++++++++++--
 src/eval.c           | 36 ------------------------------------
 2 files changed, 35 insertions(+), 38 deletions(-)

diff --git a/rust_src/src/eval.rs b/rust_src/src/eval.rs
index 3e3424bec1..e7e7d4ddd6 100644
--- a/rust_src/src/eval.rs
+++ b/rust_src/src/eval.rs
@@ -21,8 +21,9 @@ use crate::{
     remacs_sys::{
         backtrace_debug_on_exit, build_string, call_debugger, check_cons_list, do_debug_on_call,
         do_one_unbind, eval_sub, find_symbol_value, funcall_lambda, funcall_subr, globals,
-        grow_specpdl, internal_catch, list2, maybe_gc, maybe_quit, record_in_backtrace,
-        record_unwind_save_match_data, signal_or_quit, specbind, COMPILEDP, MODULE_FUNCTIONP,
+        grow_specpdl, internal_catch, internal_lisp_condition_case, list2, maybe_gc, maybe_quit,
+        record_in_backtrace, record_unwind_save_match_data, signal_or_quit, specbind, COMPILEDP,
+        MODULE_FUNCTIONP,
     },
     remacs_sys::{pvec_type, EmacsInt, Lisp_Compiled, Set_Internal_Bind},
     remacs_sys::{Fapply, Fdefault_value, Fload, Fpurecopy},
@@ -1301,4 +1302,36 @@ pub fn signal(error_symbol: LispObject, data: LispObject) -> ! {
     }
 }
 
+/// Regain control when an error is signaled.
+/// Executes BODYFORM and returns its value if no error happens.
+/// Each element of HANDLERS looks like (CONDITION-NAME BODY...)
+/// where the BODY is made of Lisp expressions.
+///
+/// A handler is applicable to an error
+/// if CONDITION-NAME is one of the error's condition names.
+/// If an error happens, the first applicable handler is run.
+///
+/// The car of a handler may be a list of condition names instead of a
+/// single condition name; then it handles all of them.  If the special
+/// condition name `debug' is present in this list, it allows another
+/// condition in the list to run the debugger if `debug-on-error' and the
+/// other usual mechanisms says it should (otherwise, `condition-case'
+/// suppresses the debugger).
+///
+/// When a handler handles an error, control returns to the `condition-case'
+/// and it executes the handler's BODY...
+/// with VAR bound to (ERROR-SYMBOL . SIGNAL-DATA) from the error.
+/// \(If VAR is nil, the handler can't access that information.)
+/// Then the value of the last BODY form is returned from the `condition-case'
+/// expression.
+///
+/// See also the function `signal' for more info.
+/// usage: (condition-case VAR BODYFORM &rest HANDLERS)
+#[lisp_fn(min = "2", unevalled = "true")]
+pub fn condition_case(args: LispCons) -> LispObject {
+    let (var, consq) = args.into();
+    let (bodyform, handlers) = consq.into();
+    unsafe { internal_lisp_condition_case(var, bodyform, handlers) }
+}
+
 include!(concat!(env!("OUT_DIR"), "/eval_exports.rs"));
diff --git a/src/eval.c b/src/eval.c
index 89cb43e0d7..d701e42843 100644
--- a/src/eval.c
+++ b/src/eval.c
@@ -654,41 +654,6 @@ Both TAG and VALUE are evalled.  */
   xsignal2 (Qno_catch, tag, value);
 }
 
-DEFUN ("condition-case", Fcondition_case, Scondition_case, 2, UNEVALLED, 0,
-       doc: /* Regain control when an error is signaled.
-Executes BODYFORM and returns its value if no error happens.
-Each element of HANDLERS looks like (CONDITION-NAME BODY...)
-where the BODY is made of Lisp expressions.
-
-A handler is applicable to an error
-if CONDITION-NAME is one of the error's condition names.
-If an error happens, the first applicable handler is run.
-
-The car of a handler may be a list of condition names instead of a
-single condition name; then it handles all of them.  If the special
-condition name `debug' is present in this list, it allows another
-condition in the list to run the debugger if `debug-on-error' and the
-other usual mechanisms says it should (otherwise, `condition-case'
-suppresses the debugger).
-
-When a handler handles an error, control returns to the `condition-case'
-and it executes the handler's BODY...
-with VAR bound to (ERROR-SYMBOL . SIGNAL-DATA) from the error.
-\(If VAR is nil, the handler can't access that information.)
-Then the value of the last BODY form is returned from the `condition-case'
-expression.
-
-See also the function `signal' for more info.
-usage: (condition-case VAR BODYFORM &rest HANDLERS)  */)
-  (Lisp_Object args)
-{
-  Lisp_Object var = XCAR (args);
-  Lisp_Object bodyform = XCAR (XCDR (args));
-  Lisp_Object handlers = XCDR (XCDR (args));
-
-  return internal_lisp_condition_case (var, bodyform, handlers);
-}
-
 /* Like Fcondition_case, but the args are separate
    rather than passed in a list.  Used by Fbyte_code.  */
 
@@ -3037,7 +3002,6 @@ alist of active lexical bindings.  */);
   defsubr (&Sdefvaralias);
   DEFSYM (Qdefvaralias, "defvaralias");
   defsubr (&Sthrow);
-  defsubr (&Scondition_case);
   defsubr (&Sapply);
   defsubr (&Sfunc_arity);
   defsubr (&Sfetch_bytecode);
-- 
2.21.0


From 60fa8fe609d389288a1b0ede58784719eb179f30 Mon Sep 17 00:00:00 2001
From: Shanavas M <shanavas.m2@gmail.com>
Date: Fri, 25 Jan 2019 20:45:07 +0530
Subject: [PATCH 262/297] Port local-variable-p

---
 rust_src/src/buffers.rs |  7 +++++-
 rust_src/src/symbols.rs | 44 ++++++++++++++++++++++++++++++----
 src/data.c              | 52 -----------------------------------------
 3 files changed, 45 insertions(+), 58 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 90d9749d2c..1c9bbce9a1 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -21,7 +21,7 @@ use crate::{
     hashtable::LispHashTableRef,
     lisp::{ExternalPtr, LispMiscRef, LispObject, LispStructuralEqual, LiveBufferIter},
     lists::{car, cdr, list, member, rassq, setcar},
-    lists::{LispConsCircularChecks, LispConsEndChecks},
+    lists::{CarIter, LispConsCircularChecks, LispConsEndChecks},
     marker::{build_marker, marker_buffer, marker_position_lisp, set_marker_both, LispMarkerRef},
     multibyte::LispStringRef,
     multibyte::{multibyte_length_by_head, string_char},
@@ -367,6 +367,11 @@ impl LispBufferRef {
         unsafe { (*self.text).z }
     }
 
+    pub fn local_vars_iter(self) -> CarIter {
+        let vars = self.local_var_alist_;
+        vars.iter_cars(LispConsEndChecks::off, LispConsCircularChecks::off)
+    }
+
     pub fn overlays_before(self) -> Option<LispOverlayRef> {
         unsafe { self.overlays_before.as_ref().map(|m| mem::transmute(m)) }
     }
diff --git a/rust_src/src/symbols.rs b/rust_src/src/symbols.rs
index 28d3dfcbbb..3987954cdb 100644
--- a/rust_src/src/symbols.rs
+++ b/rust_src/src/symbols.rs
@@ -6,9 +6,10 @@ use std::fmt::{Debug, Formatter};
 use remacs_macros::lisp_fn;
 
 use crate::{
-    buffers::LispBufferLocalValueRef,
+    buffers::per_buffer_idx_from_field_offset,
+    buffers::{LispBufferLocalValueRef, LispBufferOrCurrent, LispBufferRef},
     data::Lisp_Fwd,
-    data::{indirect_function, set},
+    data::{as_buffer_objfwd, indirect_function, set},
     hashtable::LispHashTableRef,
     lisp::{ExternalPtr, LispObject, LispStructuralEqual},
     multibyte::LispStringRef,
@@ -277,9 +278,7 @@ pub fn symbol_name(symbol: LispSymbolRef) -> LispObject {
 /// global value outside of any lexical scope.
 #[lisp_fn]
 pub fn boundp(mut symbol: LispSymbolRef) -> bool {
-    while symbol.get_redirect() == symbol_redirect::SYMBOL_VARALIAS {
-        symbol = symbol.get_indirect_variable();
-    }
+    symbol = symbol.get_indirect_variable();
 
     let valcontents = match symbol.get_redirect() {
         symbol_redirect::SYMBOL_PLAINVAL => unsafe { symbol.get_value() },
@@ -404,5 +403,40 @@ pub fn symbol_value(symbol: LispSymbolRef) -> LispObject {
     }
     val
 }
+/// Non-nil if VARIABLE has a local binding in buffer BUFFER.
+/// BUFFER defaults to the current buffer.
+#[lisp_fn(min = "1")]
+pub fn local_variable_p(mut symbol: LispSymbolRef, buffer: LispBufferOrCurrent) -> bool {
+    let buf: LispBufferRef = buffer.into();
+
+    symbol = symbol.get_indirect_variable();
+
+    match symbol.get_redirect() {
+        symbol_redirect::SYMBOL_PLAINVAL => false,
+        symbol_redirect::SYMBOL_LOCALIZED => {
+            let blv = unsafe { symbol.get_blv() };
+            if blv.where_.eq(buf) {
+                blv.found()
+            } else {
+                let variable: LispObject = symbol.into();
+                buf.local_vars_iter().any(|local_var| {
+                    let (car, _) = local_var.into();
+                    variable.eq(car)
+                })
+            }
+        }
+        symbol_redirect::SYMBOL_FORWARDED => unsafe {
+            let contents = symbol.get_fwd();
+            match as_buffer_objfwd(contents) {
+                Some(buffer_objfwd) => {
+                    let idx = per_buffer_idx_from_field_offset(buffer_objfwd.offset);
+                    idx == -1 || buf.value_p(idx as isize)
+                }
+                None => false,
+            }
+        },
+        _ => unreachable!(),
+    }
+}
 
 include!(concat!(env!("OUT_DIR"), "/symbols_exports.rs"));
diff --git a/src/data.c b/src/data.c
index 738fc0958f..2215ccb137 100644
--- a/src/data.c
+++ b/src/data.c
@@ -943,57 +943,6 @@ From now on the default value will apply in this buffer.  Return VARIABLE.  */)
 
 /* Lisp functions for creating and removing buffer-local variables.  */
 
-DEFUN ("local-variable-p", Flocal_variable_p, Slocal_variable_p,
-       1, 2, 0,
-       doc: /* Non-nil if VARIABLE has a local binding in buffer BUFFER.
-BUFFER defaults to the current buffer.  */)
-  (Lisp_Object variable, Lisp_Object buffer)
-{
-  struct buffer *buf = decode_buffer (buffer);
-  struct Lisp_Symbol *sym;
-
-  CHECK_SYMBOL (variable);
-  sym = XSYMBOL (variable);
-
- start:
-  switch (sym->u.s.redirect)
-    {
-    case SYMBOL_VARALIAS: sym = indirect_variable (sym); goto start;
-    case SYMBOL_PLAINVAL: return Qnil;
-    case SYMBOL_LOCALIZED:
-      {
-	Lisp_Object tail, elt, tmp;
-	struct Lisp_Buffer_Local_Value *blv = SYMBOL_BLV (sym);
-	XSETBUFFER (tmp, buf);
-	XSETSYMBOL (variable, sym); /* Update in case of aliasing.  */
-
-	if (EQ (blv->where, tmp)) /* The binding is already loaded.  */
-	  return blv_found (blv) ? Qt : Qnil;
-	else
-	  for (tail = BVAR (buf, local_var_alist); CONSP (tail); tail = XCDR (tail))
-	    {
-	      elt = XCAR (tail);
-	      if (EQ (variable, XCAR (elt)))
-		return Qt;
-	    }
-	return Qnil;
-      }
-    case SYMBOL_FORWARDED:
-      {
-	union Lisp_Fwd *valcontents = SYMBOL_FWD (sym);
-	if (BUFFER_OBJFWDP (valcontents))
-	  {
-	    int offset = XBUFFER_OBJFWD (valcontents)->offset;
-	    int idx = PER_BUFFER_IDX (offset);
-	    if (idx == -1 || PER_BUFFER_VALUE_P (buf, idx))
-	      return Qt;
-	  }
-	return Qnil;
-      }
-    default: emacs_abort ();
-    }
-}
-
 DEFUN ("local-variable-if-set-p", Flocal_variable_if_set_p, Slocal_variable_if_set_p,
        1, 2, 0,
        doc: /* Non-nil if VARIABLE is local in buffer BUFFER when set there.
@@ -1774,7 +1723,6 @@ syms_of_data (void)
   defsubr (&Smake_variable_buffer_local);
   defsubr (&Smake_local_variable);
   defsubr (&Skill_local_variable);
-  defsubr (&Slocal_variable_p);
   defsubr (&Slocal_variable_if_set_p);
   defsubr (&Svariable_binding_locus);
 #if 0                           /* XXX Remove this. --lorentey */
-- 
2.21.0


From 841ab87935cbcd27e38ceb304275f0ef8e3ace98 Mon Sep 17 00:00:00 2001
From: Daichi Mukai <mukai.daichi.37e@kyoto-u.jp>
Date: Tue, 5 Feb 2019 15:49:23 +0900
Subject: [PATCH 263/297] Sync Rust version of Dockerized environment (#1324)

---
 docker/fedora/Dockerfile        | 4 ++--
 docker/ubuntu/32bit/Dockerfile  | 4 ++--
 docker/ubuntu/Dockerfile        | 4 ++--
 docker/ubuntu/cosmic/Dockerfile | 4 ++--
 4 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/docker/fedora/Dockerfile b/docker/fedora/Dockerfile
index 9d0a104729..546a8ed490 100644
--- a/docker/fedora/Dockerfile
+++ b/docker/fedora/Dockerfile
@@ -23,6 +23,6 @@ ENV PATH "/root/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sb
 RUN curl https://sh.rustup.rs -o rustup.sh && \
     sh rustup.sh \
         --default-host x86_64-unknown-linux-gnu \
-        --default-toolchain nightly-2018-11-03 -y && \
-    rustup default nightly-2018-11-03
+        --default-toolchain nightly-2019-01-19 -y && \
+    rustup default nightly-2019-01-19
 
diff --git a/docker/ubuntu/32bit/Dockerfile b/docker/ubuntu/32bit/Dockerfile
index 32b703a2f7..96ace59937 100644
--- a/docker/ubuntu/32bit/Dockerfile
+++ b/docker/ubuntu/32bit/Dockerfile
@@ -44,6 +44,6 @@ ENV PATH "/root/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sb
 RUN curl https://sh.rustup.rs -o rustup.sh && \
     sh rustup.sh \
         --default-host i686-unknown-linux-gnu \
-        --default-toolchain nightly-2018-11-03 -y && \
-    rustup default nightly-2018-11-03
+        --default-toolchain nightly-2019-01-19 -y && \
+    rustup default nightly-2019-01-19
 
diff --git a/docker/ubuntu/Dockerfile b/docker/ubuntu/Dockerfile
index 2d93192cf6..3fa1a44dcc 100644
--- a/docker/ubuntu/Dockerfile
+++ b/docker/ubuntu/Dockerfile
@@ -23,6 +23,6 @@ ENV PATH "/root/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sb
 RUN curl https://sh.rustup.rs -o rustup.sh && \
     sh rustup.sh \
         --default-host x86_64-unknown-linux-gnu \
-        --default-toolchain nightly-2018-11-03 -y && \
-    rustup default nightly-2018-11-03
+        --default-toolchain nightly-2019-01-19 -y && \
+    rustup default nightly-2019-01-19
 
diff --git a/docker/ubuntu/cosmic/Dockerfile b/docker/ubuntu/cosmic/Dockerfile
index 5f66e61933..9aaec19fd0 100644
--- a/docker/ubuntu/cosmic/Dockerfile
+++ b/docker/ubuntu/cosmic/Dockerfile
@@ -25,6 +25,6 @@ ENV PATH "/root/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sb
 RUN curl https://sh.rustup.rs -o rustup.sh && \
     sh rustup.sh \
         --default-host x86_64-unknown-linux-gnu \
-        --default-toolchain nightly-2018-11-03 -y && \
-    rustup default nightly-2018-11-03
+        --default-toolchain nightly-2019-01-19 -y && \
+    rustup default nightly-2019-01-19
 
-- 
2.21.0


From 95a4bc5e708b5824dcf0eb34a327b2ba7a144f1e Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Tue, 5 Feb 2019 16:54:21 +0100
Subject: [PATCH 264/297] Add transformation methods to ExternalPtr (#1325)

* Mark methods as unsafe
---
 rust_src/src/lisp.rs    | 15 +++++++++++++++
 rust_src/src/windows.rs |  3 +--
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/rust_src/src/lisp.rs b/rust_src/src/lisp.rs
index 3b94fef273..978d7bd3d5 100644
--- a/rust_src/src/lisp.rs
+++ b/rust_src/src/lisp.rs
@@ -124,6 +124,21 @@ impl<T> ExternalPtr<T> {
     pub fn replace_ptr(&mut self, ptr: *mut T) {
         self.0 = ptr;
     }
+
+    pub unsafe fn ptr_offset(&mut self, size: isize) {
+        let ptr = self.0.offset(size);
+        self.replace_ptr(ptr);
+    }
+
+    pub unsafe fn ptr_add(&mut self, size: usize) {
+        let ptr = self.0.add(size);
+        self.replace_ptr(ptr);
+    }
+
+    pub unsafe fn ptr_sub(&mut self, size: usize) {
+        let ptr = self.0.sub(size);
+        self.replace_ptr(ptr);
+    }
 }
 
 impl<T> Deref for ExternalPtr<T> {
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 4f610d4d82..328a42da23 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -1728,8 +1728,7 @@ pub fn window_lines_pixel_dimensions(
             }
         };
         rows = ((width, row.y + row.height - subtract), rows).into();
-        let ptr = unsafe { row.as_mut().add(1) };
-        row.replace_ptr(ptr);
+        unsafe { row.ptr_add(1) };
     }
     unsafe { Fnreverse(rows) }
 }
-- 
2.21.0


From 4c9bbde86e549e879ef746436ec1f7bf100a6e0e Mon Sep 17 00:00:00 2001
From: Jacob MacDonald <jaccarmac@gmail.com>
Date: Tue, 5 Feb 2019 20:33:08 -0600
Subject: [PATCH 265/297] Make the type guarantees in LispBufferOrName a little
 stronger. (#1321)

This did require removing the derivation of `Eq` on the type, but no
changes outside the `buffers` module and trivial changes inside.

Maybe useful to the discussion in #1302 re: the benefits of wrapper
types vs. enums of various specificity.
---
 rust_src/src/buffers.rs | 61 ++++++++++++++++++++++++-----------------
 1 file changed, 36 insertions(+), 25 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 1c9bbce9a1..beea11b6b3 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -563,10 +563,10 @@ impl LispBufferLocalValueRef {
     }
 }
 
-#[derive(Clone, Copy, PartialEq, Eq)]
+#[derive(Clone, Copy, PartialEq)]
 pub enum LispBufferOrName {
-    Buffer(LispObject),
-    Name(LispObject),
+    Buffer(LispBufferRef),
+    Name(LispStringRef),
 }
 
 impl LispBufferOrName {
@@ -582,32 +582,46 @@ impl LispBufferOrName {
 impl From<LispBufferOrName> for LispObject {
     fn from(buffer_or_name: LispBufferOrName) -> Self {
         match buffer_or_name {
-            LispBufferOrName::Buffer(b) => b,
-            LispBufferOrName::Name(n) => n,
+            LispBufferOrName::Buffer(b) => b.into(),
+            LispBufferOrName::Name(n) => n.into(),
         }
     }
 }
 
 impl From<LispObject> for LispBufferOrName {
     fn from(v: LispObject) -> Self {
-        if v.is_string() {
-            LispBufferOrName::Name(v)
-        } else if v.is_buffer() {
-            LispBufferOrName::Buffer(v)
+        if let Some(s) = v.as_string() {
+            LispBufferOrName::Name(s)
+        } else if let Some(b) = v.as_buffer() {
+            LispBufferOrName::Buffer(b)
         } else {
             wrong_type!(Qbufferp, v);
         }
     }
 }
 
+impl From<LispBufferRef> for LispBufferOrName {
+    #[inline(always)]
+    fn from(b: LispBufferRef) -> Self {
+        LispBufferOrName::Buffer(b)
+    }
+}
+
+impl From<LispStringRef> for LispBufferOrName {
+    #[inline(always)]
+    fn from(n: LispStringRef) -> Self {
+        LispBufferOrName::Name(n)
+    }
+}
+
 impl From<LispObject> for Option<LispBufferOrName> {
     fn from(v: LispObject) -> Self {
         if v.is_nil() {
             None
-        } else if v.is_string() {
-            Some(LispBufferOrName::Name(v))
-        } else if v.is_buffer() {
-            Some(LispBufferOrName::Buffer(v))
+        } else if let Some(s) = v.as_string() {
+            Some(LispBufferOrName::Name(s))
+        } else if let Some(b) = v.as_buffer() {
+            Some(LispBufferOrName::Buffer(b))
         } else {
             None
         }
@@ -616,17 +630,16 @@ impl From<LispObject> for Option<LispBufferOrName> {
 
 impl From<LispBufferOrName> for Option<LispBufferRef> {
     fn from(v: LispBufferOrName) -> Self {
-        let buffer = match v {
-            LispBufferOrName::Buffer(b) => b,
+        match v {
+            LispBufferOrName::Buffer(b) => Some(b),
             LispBufferOrName::Name(name) => {
                 let tem = unsafe { Vbuffer_alist }
                     .iter_cars(LispConsEndChecks::off, LispConsCircularChecks::off)
-                    .find(|&item| string_equal(car(item), name));
+                    .find(|&item| string_equal(car(item), name.into()));
 
-                cdr(tem.into())
+                cdr(tem.into()).as_buffer()
             }
-        };
-        buffer.as_buffer()
+        }
     }
 }
 
@@ -1130,7 +1143,7 @@ pub fn erase_buffer() {
 #[lisp_fn(min = "1")]
 pub fn generate_new_buffer_name(name: LispStringRef, ignore: LispObject) -> LispStringRef {
     if (ignore.is_not_nil() && string_equal(name.into(), ignore))
-        || get_buffer(LispBufferOrName::Name(name.into())).is_none()
+        || get_buffer(name.into()).is_none()
     {
         return name;
     }
@@ -1143,7 +1156,7 @@ pub fn generate_new_buffer_name(name: LispStringRef, ignore: LispObject) -> Lisp
         let mut s = format!("-{}", rng.gen_range(0, 1_000_000));
         local_unibyte_string!(suffix, s);
         let genname = unsafe { concat2(name.into(), suffix) };
-        if get_buffer(LispBufferOrName::Name(genname)).is_none() {
+        if get_buffer(genname.into()).is_none() {
             return genname.into();
         }
         genname
@@ -1156,9 +1169,7 @@ pub fn generate_new_buffer_name(name: LispStringRef, ignore: LispObject) -> Lisp
         let mut s = format!("<{}>", suffix_count);
         local_unibyte_string!(suffix, s);
         let candidate = unsafe { concat2(basename, suffix) };
-        if string_equal(candidate, ignore)
-            || get_buffer(LispBufferOrName::Name(candidate)).is_none()
-        {
+        if string_equal(candidate, ignore) || get_buffer(candidate.into()).is_none() {
             return candidate.into();
         }
         suffix_count += 1;
@@ -1253,7 +1264,7 @@ pub fn rename_buffer(newname: LispStringRef, unique: LispObject) -> LispStringRe
 
     let mut current_buffer = ThreadState::current_buffer_unchecked();
 
-    let newname = get_buffer(LispBufferOrName::Name(newname.into())).map_or(newname, |tem| {
+    let newname = get_buffer(newname.into()).map_or(newname, |tem| {
         // Don't short-circuit if UNIQUE is t.  That is a useful
         // way to rename the buffer automatically so you can
         // create another with the original name.  It makes UNIQUE
-- 
2.21.0


From 6242be61073af8bc647874094c00486df43277cd Mon Sep 17 00:00:00 2001
From: Daichi Mukai <mukai.daichi.37e@kyoto-u.jp>
Date: Thu, 31 Jan 2019 21:05:53 +0900
Subject: [PATCH 266/297] Update to latest rand crate

---
 configure.ac                   |   5 +
 rust_src/Cargo.lock            | 271 +++++++++++++++++++++++----------
 rust_src/Cargo.toml.in         |   2 +-
 rust_src/remacs-lib/Cargo.toml |   2 +-
 rust_src/remacs-lib/files.rs   |  14 +-
 rust_src/src/buffers.rs        |   9 +-
 rust_src/src/numbers.rs        |  13 +-
 7 files changed, 210 insertions(+), 106 deletions(-)

diff --git a/configure.ac b/configure.ac
index f7a10bfea8..ec8e0492ce 100644
--- a/configure.ac
+++ b/configure.ac
@@ -5116,6 +5116,11 @@ LIB_REMACS="$RUST_DEPS"
 
 LDFLAGS_REMACS="-L../$srcdir/rust_src/target/\${CARGO_BUILD_DIR}"
 
+# On macOS, rand crate needs '_SecRandomCopyBytes' symbol in Security framework.
+if test "${opsys}" = "darwin"; then
+LDFLAGS_REMACS="$LDFLAGS_REMACS -framework Security"
+fi
+
 LDFLAGS="$LDFLAGS $LDFLAGS_REMACS"
 
 AC_SUBST(LIB_REMACS)
diff --git a/rust_src/Cargo.lock b/rust_src/Cargo.lock
index 28bdafc829..6756fc7d32 100644
--- a/rust_src/Cargo.lock
+++ b/rust_src/Cargo.lock
@@ -8,22 +8,27 @@ name = "aho-corasick"
 version = "0.6.9"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "memchr 2.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "alloc_unexecmacosx"
 version = "0.1.0"
 dependencies = [
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
+[[package]]
+name = "autocfg"
+version = "0.1.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
 [[package]]
 name = "base64"
-version = "0.10.0"
+version = "0.10.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)",
+ "byteorder 1.3.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -33,21 +38,21 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "block-buffer"
-version = "0.7.0"
+version = "0.7.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "block-padding 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "byte-tools 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)",
+ "block-padding 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "byte-tools 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "byteorder 1.3.1 (registry+https://github.com/rust-lang/crates.io-index)",
  "generic-array 0.12.0 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "block-padding"
-version = "0.1.2"
+version = "0.1.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "byte-tools 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "byte-tools 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -57,12 +62,12 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "byte-tools"
-version = "0.3.0"
+version = "0.3.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "byteorder"
-version = "1.2.7"
+version = "1.3.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -83,6 +88,14 @@ dependencies = [
  "term 0.5.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
+[[package]]
+name = "cloudabi"
+version = "0.0.3"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
 [[package]]
 name = "crc"
 version = "1.8.1"
@@ -143,7 +156,7 @@ version = "0.2.4"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "errno-dragonfly 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)",
  "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
@@ -153,7 +166,7 @@ version = "0.1.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "gcc 0.3.55 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -172,22 +185,13 @@ version = "1.0.6"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "crc32fast 1.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "miniz_oxide_c_api 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
-]
-
-[[package]]
-name = "fuchsia-zircon"
-version = "0.3.3"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-dependencies = [
- "bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)",
+ "miniz_oxide_c_api 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "fuchsia-zircon-sys"
-version = "0.3.3"
+name = "fuchsia-cprng"
+version = "0.1.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -215,7 +219,7 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "libc"
-version = "0.2.47"
+version = "0.2.48"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -233,17 +237,16 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
 name = "memchr"
-version = "2.1.2"
+version = "2.1.3"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "version_check 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "miniz_oxide"
-version = "0.2.0"
+version = "0.2.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "adler32 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -251,18 +254,18 @@ dependencies = [
 
 [[package]]
 name = "miniz_oxide_c_api"
-version = "0.2.0"
+version = "0.2.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "cc 1.0.28 (registry+https://github.com/rust-lang/crates.io-index)",
  "crc 1.8.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "miniz_oxide 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)",
+ "miniz_oxide 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "opaque-debug"
-version = "0.2.1"
+version = "0.2.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -288,32 +291,111 @@ dependencies = [
 
 [[package]]
 name = "rand"
-version = "0.4.5"
+version = "0.6.5"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "autocfg 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_chacha 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_core 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_hc 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_isaac 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_jitter 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_os 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_pcg 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_xorshift 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_chacha"
+version = "0.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "autocfg 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_core 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_core"
+version = "0.3.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "rand_core 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_core"
+version = "0.4.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
+[[package]]
+name = "rand_hc"
+version = "0.1.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_core 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_isaac"
+version = "0.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "rand_core 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_jitter"
+version = "0.1.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_core 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_os"
+version = "0.1.2"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "cloudabi 0.0.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "fuchsia-cprng 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_core 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "rdrand 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
-name = "rand_core"
-version = "0.3.0"
+name = "rand_pcg"
+version = "0.1.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "rand_core 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rustc_version 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "rand_xorshift"
+version = "0.1.1"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "rand_core 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)",
+]
 
 [[package]]
 name = "rdrand"
 version = "0.4.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand_core 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
 name = "redox_syscall"
-version = "0.1.50"
+version = "0.1.51"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
 [[package]]
@@ -322,7 +404,7 @@ version = "0.2.11"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)",
- "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
+ "memchr 2.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
  "regex-syntax 0.5.6 (registry+https://github.com/rust-lang/crates.io-index)",
  "thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
  "utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -334,8 +416,8 @@ version = "1.1.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)",
- "memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "regex-syntax 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)",
+ "memchr 2.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
+ "regex-syntax 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)",
  "thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
  "utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
@@ -350,7 +432,7 @@ dependencies = [
 
 [[package]]
 name = "regex-syntax"
-version = "0.6.4"
+version = "0.6.5"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
  "ucd-util 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -361,17 +443,17 @@ name = "remacs"
 version = "0.1.0"
 dependencies = [
  "alloc_unexecmacosx 0.1.0",
- "base64 0.10.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "base64 0.10.1 (registry+https://github.com/rust-lang/crates.io-index)",
  "cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)",
  "clippy 0.0.302 (registry+https://github.com/rust-lang/crates.io-index)",
  "errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
  "field-offset 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
  "flate2 1.0.6 (registry+https://github.com/rust-lang/crates.io-index)",
  "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)",
  "line-wrap 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)",
  "md5 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)",
- "rand 0.4.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)",
  "regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "remacs-lib 0.1.0",
  "remacs-macros 0.1.0",
@@ -386,8 +468,8 @@ dependencies = [
  "darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
  "errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
  "lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "rand 0.4.5 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)",
+ "rand 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)",
  "regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "remacs-util 0.1.0",
  "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
@@ -411,15 +493,36 @@ version = "0.1.0"
 dependencies = [
  "darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
  "errno 0.2.4 (registry+https://github.com/rust-lang/crates.io-index)",
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)",
  "syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
+[[package]]
+name = "rustc_version"
+version = "0.2.3"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
 [[package]]
 name = "safemem"
 version = "0.3.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
+[[package]]
+name = "semver"
+version = "0.9.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+dependencies = [
+ "semver-parser 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)",
+]
+
+[[package]]
+name = "semver-parser"
+version = "0.7.0"
+source = "registry+https://github.com/rust-lang/crates.io-index"
+
 [[package]]
 name = "sha1"
 version = "0.6.0"
@@ -430,10 +533,10 @@ name = "sha2"
 version = "0.8.0"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "block-buffer 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)",
+ "block-buffer 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)",
  "digest 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)",
  "fake-simd 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)",
- "opaque-debug 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)",
+ "opaque-debug 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
 [[package]]
@@ -469,7 +572,7 @@ name = "term"
 version = "0.5.1"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)",
+ "byteorder 1.3.1 (registry+https://github.com/rust-lang/crates.io-index)",
  "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
@@ -486,8 +589,8 @@ name = "time"
 version = "0.1.42"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 dependencies = [
- "libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)",
- "redox_syscall 0.1.50 (registry+https://github.com/rust-lang/crates.io-index)",
+ "libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)",
+ "redox_syscall 0.1.51 (registry+https://github.com/rust-lang/crates.io-index)",
  "winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)",
 ]
 
@@ -516,11 +619,6 @@ name = "utf8-ranges"
 version = "1.0.2"
 source = "registry+https://github.com/rust-lang/crates.io-index"
 
-[[package]]
-name = "version_check"
-version = "0.1.5"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-
 [[package]]
 name = "winapi"
 version = "0.3.6"
@@ -543,16 +641,18 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 [metadata]
 "checksum adler32 1.0.3 (registry+https://github.com/rust-lang/crates.io-index)" = "7e522997b529f05601e05166c07ed17789691f562762c7f3b987263d2dedee5c"
 "checksum aho-corasick 0.6.9 (registry+https://github.com/rust-lang/crates.io-index)" = "1e9a933f4e58658d7b12defcf96dc5c720f20832deebe3e0a19efd3b6aaeeb9e"
-"checksum base64 0.10.0 (registry+https://github.com/rust-lang/crates.io-index)" = "621fc7ecb8008f86d7fb9b95356cd692ce9514b80a86d85b397f32a22da7b9e2"
+"checksum autocfg 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "a6d640bee2da49f60a4068a7fae53acde8982514ab7bae8b8cea9e88cbcfd799"
+"checksum base64 0.10.1 (registry+https://github.com/rust-lang/crates.io-index)" = "0b25d992356d2eb0ed82172f5248873db5560c4721f564b13cb5193bda5e668e"
 "checksum bitflags 1.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "228047a76f468627ca71776ecdebd732a3423081fcf5125585bcd7c49886ce12"
-"checksum block-buffer 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)" = "49665c62e0e700857531fa5d3763e91b539ff1abeebd56808d378b495870d60d"
-"checksum block-padding 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "4fc4358306e344bf9775d0197fd00d2603e5afb0771bb353538630f022068ea3"
+"checksum block-buffer 0.7.2 (registry+https://github.com/rust-lang/crates.io-index)" = "509de513cca6d92b6aacf9c61acfe7eaa160837323a81068d690cc1f8e5740da"
+"checksum block-padding 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "d75255892aeb580d3c566f213a2b6fdc1c66667839f45719ee1d30ebf2aea591"
 "checksum build_const 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)" = "39092a32794787acd8525ee150305ff051b0aa6cc2abaf193924f5ab05425f39"
-"checksum byte-tools 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)" = "980479e6fde23246dfb54d47580d66b4e99202e7579c5eaa9fe10ecb5ebd2182"
-"checksum byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)" = "94f88df23a25417badc922ab0f5716cc1330e87f71ddd9203b3a3ccd9cedf75d"
+"checksum byte-tools 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)" = "e3b5ca7a04898ad4bcd41c90c5285445ff5b791899bb1b0abdd2a2aa791211d7"
+"checksum byteorder 1.3.1 (registry+https://github.com/rust-lang/crates.io-index)" = "a019b10a2a7cdeb292db131fc8113e57ea2a908f6e7894b0c3c671893b65dbeb"
 "checksum cc 1.0.28 (registry+https://github.com/rust-lang/crates.io-index)" = "bb4a8b715cb4597106ea87c7c84b2f1d452c7492033765df7f32651e66fcf749"
 "checksum cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)" = "082bb9b28e00d3c9d39cc03e64ce4cea0f1bb9b3fde493f0cbc008472d22bdf4"
 "checksum clippy 0.0.302 (registry+https://github.com/rust-lang/crates.io-index)" = "d911ee15579a3f50880d8c1d59ef6e79f9533127a3bd342462f5d584f5e8c294"
+"checksum cloudabi 0.0.3 (registry+https://github.com/rust-lang/crates.io-index)" = "ddfc5b9aa5d4507acaf872de71051dfd0e309860e88966e1051e462a077aac4f"
 "checksum crc 1.8.1 (registry+https://github.com/rust-lang/crates.io-index)" = "d663548de7f5cca343f1e0a48d14dcfb0e9eb4e079ec58883b7251539fa10aeb"
 "checksum crc32fast 1.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "e91d5240c6975ef33aeb5f148f35275c25eda8e8a5f95abe421978b05b8bf192"
 "checksum darling 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "1630fdbe3554154a50624487c79b0140a424e87dc08061db1a2211359792acab"
@@ -564,31 +664,41 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 "checksum fake-simd 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "e88a8acf291dafb59c2d96e8f59828f3838bb1a70398823ade51a84de6a6deed"
 "checksum field-offset 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "64e9bc339e426139e02601fa69d101e96a92aee71b58bc01697ec2a63a5c9e68"
 "checksum flate2 1.0.6 (registry+https://github.com/rust-lang/crates.io-index)" = "2291c165c8e703ee54ef3055ad6188e3d51108e2ded18e9f2476e774fc5ad3d4"
-"checksum fuchsia-zircon 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "2e9763c69ebaae630ba35f74888db465e49e259ba1bc0eda7d06f4a067615d82"
-"checksum fuchsia-zircon-sys 0.3.3 (registry+https://github.com/rust-lang/crates.io-index)" = "3dcaa9ae7725d12cdb85b3ad99a434db70b468c09ded17e012d86b5c1010f7a7"
+"checksum fuchsia-cprng 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)" = "81f7f8eb465745ea9b02e2704612a9946a59fa40572086c6fd49d6ddcf30bf31"
 "checksum gcc 0.3.55 (registry+https://github.com/rust-lang/crates.io-index)" = "8f5f3913fa0bfe7ee1fd8248b6b9f42a5af4b9d65ec2dd2c3c26132b950ecfc2"
 "checksum generic-array 0.12.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3c0f28c2f5bfb5960175af447a2da7c18900693738343dc896ffbcabd9839592"
 "checksum ident_case 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)" = "3c9826188e666f2ed92071d2dadef6edc430b11b158b5b2b3f4babbcc891eaaa"
 "checksum lazy_static 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "a374c89b9db55895453a74c1e38861d9deec0b01b405a82516e9d5de4820dea1"
-"checksum libc 0.2.47 (registry+https://github.com/rust-lang/crates.io-index)" = "48450664a984b25d5b479554c29cc04e3150c97aa4c01da5604a2d4ed9151476"
+"checksum libc 0.2.48 (registry+https://github.com/rust-lang/crates.io-index)" = "e962c7641008ac010fa60a7dfdc1712449f29c44ef2d4702394aea943ee75047"
 "checksum line-wrap 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "f30344350a2a51da54c1d53be93fade8a237e545dbcc4bdbe635413f2117cab9"
 "checksum md5 0.6.1 (registry+https://github.com/rust-lang/crates.io-index)" = "7e6bcd6433cff03a4bfc3d9834d504467db1f1cf6d0ea765d37d330249ed629d"
-"checksum memchr 2.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "db4c41318937f6e76648f42826b1d9ade5c09cafb5aef7e351240a70f39206e9"
-"checksum miniz_oxide 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "5ad30a47319c16cde58d0314f5d98202a80c9083b5f61178457403dfb14e509c"
-"checksum miniz_oxide_c_api 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)" = "28edaef377517fd9fe3e085c37d892ce7acd1fbeab9239c5a36eec352d8a8b7e"
-"checksum opaque-debug 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)" = "51ecbcb821e1bd256d456fe858aaa7f380b63863eab2eb86eee1bd9f33dd6682"
+"checksum memchr 2.1.3 (registry+https://github.com/rust-lang/crates.io-index)" = "e1dd4eaac298c32ce07eb6ed9242eda7d82955b9170b7d6db59b2e02cc63fcb8"
+"checksum miniz_oxide 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)" = "c468f2369f07d651a5d0bb2c9079f8488a66d5466efe42d0c5c6466edcb7f71e"
+"checksum miniz_oxide_c_api 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)" = "b7fe927a42e3807ef71defb191dc87d4e24479b221e67015fe38ae2b7b447bab"
+"checksum opaque-debug 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)" = "93f5bb2e8e8dec81642920ccff6b61f1eb94fa3020c5a325c9851ff604152409"
 "checksum proc-macro2 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)" = "1b06e2f335f48d24442b35a19df506a835fb3547bc3c06ef27340da9acf5cae7"
 "checksum quote 0.3.15 (registry+https://github.com/rust-lang/crates.io-index)" = "7a6e920b65c65f10b2ae65c831a81a073a89edd28c7cce89475bff467ab4167a"
 "checksum quote 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)" = "9949cfe66888ffe1d53e6ec9d9f3b70714083854be20fd5e271b232a017401e8"
-"checksum rand 0.4.5 (registry+https://github.com/rust-lang/crates.io-index)" = "dee497e66d8d76bf08ce20c8d36e16f93749ab0bf89975b4f8ae5cee660c2da2"
-"checksum rand_core 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)" = "0905b6b7079ec73b314d4c748701f6931eb79fd97c668caa3f1899b22b32c6db"
+"checksum rand 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)" = "6d71dacdc3c88c1fde3885a3be3fbab9f35724e6ce99467f7d9c5026132184ca"
+"checksum rand_chacha 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "556d3a1ca6600bfcbab7c7c91ccb085ac7fbbcd70e008a98742e7847f4f7bcef"
+"checksum rand_core 0.3.1 (registry+https://github.com/rust-lang/crates.io-index)" = "7a6fdeb83b075e8266dcc8762c22776f6877a63111121f5f8c7411e5be7eed4b"
+"checksum rand_core 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "d0e7a549d590831370895ab7ba4ea0c1b6b011d106b5ff2da6eee112615e6dc0"
+"checksum rand_hc 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)" = "7b40677c7be09ae76218dc623efbf7b18e34bced3f38883af07bb75630a21bc4"
+"checksum rand_isaac 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "ded997c9d5f13925be2a6fd7e66bf1872597f759fd9dd93513dd7e92e5a5ee08"
+"checksum rand_jitter 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "080723c6145e37503a2224f801f252e14ac5531cb450f4502698542d188cb3c0"
+"checksum rand_os 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)" = "b7c690732391ae0abafced5015ffb53656abfaec61b342290e5eb56b286a679d"
+"checksum rand_pcg 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "086bd09a33c7044e56bb44d5bdde5a60e7f119a9e95b0775f545de759a32fe05"
+"checksum rand_xorshift 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)" = "cbf7e9e623549b0e21f6e97cf8ecf247c1a8fd2e8a992ae265314300b2455d5c"
 "checksum rdrand 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "678054eb77286b51581ba43620cc911abf02758c91f93f479767aed0f90458b2"
-"checksum redox_syscall 0.1.50 (registry+https://github.com/rust-lang/crates.io-index)" = "52ee9a534dc1301776eff45b4fa92d2c39b1d8c3d3357e6eb593e0d795506fc2"
+"checksum redox_syscall 0.1.51 (registry+https://github.com/rust-lang/crates.io-index)" = "423e376fffca3dfa06c9e9790a9ccd282fafb3cc6e6397d01dbf64f9bacc6b85"
 "checksum regex 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)" = "9329abc99e39129fcceabd24cf5d85b4671ef7c29c50e972bc5afe32438ec384"
 "checksum regex 1.1.0 (registry+https://github.com/rust-lang/crates.io-index)" = "37e7cbbd370869ce2e8dff25c7018702d10b21a20ef7135316f8daecd6c25b7f"
 "checksum regex-syntax 0.5.6 (registry+https://github.com/rust-lang/crates.io-index)" = "7d707a4fa2637f2dca2ef9fd02225ec7661fe01a53623c1e6515b6916511f7a7"
-"checksum regex-syntax 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)" = "4e47a2ed29da7a9e1960e1639e7a982e6edc6d49be308a3b02daf511504a16d1"
+"checksum regex-syntax 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)" = "8c2f35eedad5295fdf00a63d7d4b238135723f92b434ec06774dad15c7ab0861"
+"checksum rustc_version 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)" = "138e3e0acb6c9fb258b19b67cb8abd63c00679d2851805ea151465464fe9030a"
 "checksum safemem 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)" = "8dca453248a96cb0749e36ccdfe2b0b4e54a61bfef89fb97ec621eb8e0a93dd9"
+"checksum semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)" = "1d7eb9ef2c18661902cc47e535f9bc51b78acd254da71d375c2f6720d9a40403"
+"checksum semver-parser 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)" = "388a1df253eca08550bef6c72392cfe7c30914bf41df5269b68cbd6ff8f570a3"
 "checksum sha1 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)" = "2579985fda508104f7587689507983eadd6a6e84dd35d6d115361f530916fa0d"
 "checksum sha2 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)" = "7b4d8bfd0e469f417657573d8451fb33d16cfe0989359b93baf3a1ffc639543d"
 "checksum syn 0.11.11 (registry+https://github.com/rust-lang/crates.io-index)" = "d3b891b9015c88c576343b9b3e41c2c11a51c219ef067b264bd9c8aa9b441dad"
@@ -602,7 +712,6 @@ source = "registry+https://github.com/rust-lang/crates.io-index"
 "checksum unicode-xid 0.0.4 (registry+https://github.com/rust-lang/crates.io-index)" = "8c1f860d7d29cf02cb2f3f359fd35991af3d30bac52c57d265a3c461074cb4dc"
 "checksum unicode-xid 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)" = "fc72304796d0818e357ead4e000d19c9c174ab23dc11093ac919054d20a6a7fc"
 "checksum utf8-ranges 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)" = "796f7e48bef87609f7ade7e06495a87d5cd06c7866e6a5cbfceffc558a243737"
-"checksum version_check 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)" = "914b1a6776c4c929a602fafd8bc742e06365d4bcbe48c30f9cca5824f70dc9dd"
 "checksum winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)" = "92c1eb33641e276cfa214a0522acad57be5c56b10cb348b3c5117db75f3ac4b0"
 "checksum winapi-i686-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "ac3b87c63620426dd9b991e5ce0329eff545bccbbb34f3be09ff6fb6ab51b7b6"
 "checksum winapi-x86_64-pc-windows-gnu 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)" = "712e227841d057c1ee1cd2fb22fa7e5a5461ae8e48fa2ca79ec42cfc1931183f"
diff --git a/rust_src/Cargo.toml.in b/rust_src/Cargo.toml.in
index b35c2cae98..03e0f783c8 100644
--- a/rust_src/Cargo.toml.in
+++ b/rust_src/Cargo.toml.in
@@ -26,7 +26,7 @@ lazy_static = "1.2"
 libc = "0.2"
 line-wrap = "0.1.1"
 md5 = "0.6"
-rand = "0.4"
+rand = "0.6.5"
 sha1 = "0.6"
 sha2 = "0.8"
 
diff --git a/rust_src/remacs-lib/Cargo.toml b/rust_src/remacs-lib/Cargo.toml
index 7dec235876..683739437b 100644
--- a/rust_src/remacs-lib/Cargo.toml
+++ b/rust_src/remacs-lib/Cargo.toml
@@ -9,7 +9,7 @@ darling = "0.2"
 errno = "0.2"
 lazy_static = "1.2"
 libc = "0.2"
-rand = "0.4"
+rand = "0.6.5"
 regex = "1.1"
 syn = { version = "0.11", features = ["full"] }
 time = "0.1"
diff --git a/rust_src/remacs-lib/files.rs b/rust_src/remacs-lib/files.rs
index b2c28684b4..7a6fcb3ccc 100644
--- a/rust_src/remacs-lib/files.rs
+++ b/rust_src/remacs-lib/files.rs
@@ -1,8 +1,5 @@
 use errno;
 
-use rand::{Rng, StdRng};
-use std::sync::Mutex;
-
 use std::ffi::{CStr, CString};
 use std::io;
 
@@ -11,6 +8,8 @@ use libc::{self, c_char, c_int, EEXIST, EINVAL};
 #[cfg(unix)]
 use libc::{open, O_CLOEXEC, O_CREAT, O_EXCL, O_RDWR};
 
+use rand::{thread_rng, RngCore};
+
 #[cfg(windows)]
 extern "C" {
     fn sys_open(filename: *const c_char, flags: c_int, mode: c_int) -> c_int;
@@ -66,20 +65,13 @@ fn validate_template(template: String) -> Result<String, i32> {
 }
 
 fn generate_temporary_filename(name: &mut String) {
-    // Note: rand::thread_rng causes a segfault on mac when used here,
-    //  as of nightly-09-15
-    lazy_static! {
-        static ref shared_rng: Mutex<StdRng> = Mutex::new(StdRng::new().unwrap());
-    }
-
     let len = name.len();
     assert!(len >= 6);
     let name_vec = unsafe { &mut name.as_mut_vec() };
 
     let bytes = &mut name_vec[len - 6..len];
     {
-        let mut rng = shared_rng.lock().unwrap();
-        rng.fill_bytes(bytes);
+        thread_rng().fill_bytes(bytes);
     }
     for byte in bytes.iter_mut() {
         *byte = match *byte % 62 {
diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index beea11b6b3..934a1b40ef 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -1,12 +1,11 @@
 //! Functions operating on buffers.
 
-use std::sync::Mutex;
 use std::{self, mem, ptr};
 
 use field_offset::FieldOffset;
 use libc::{self, c_char, c_int, c_uchar, c_void, ptrdiff_t};
 
-use rand::{Rng, StdRng};
+use rand::{thread_rng, Rng};
 
 use remacs_macros::lisp_fn;
 
@@ -1149,11 +1148,7 @@ pub fn generate_new_buffer_name(name: LispStringRef, ignore: LispObject) -> Lisp
     }
 
     let basename = if name.byte_at(0) == b' ' {
-        lazy_static! {
-            static ref shared_rng: Mutex<StdRng> = Mutex::new(StdRng::new().unwrap());
-        }
-        let mut rng = shared_rng.lock().unwrap();
-        let mut s = format!("-{}", rng.gen_range(0, 1_000_000));
+        let mut s = format!("-{}", thread_rng().gen_range(0, 1_000_000));
         local_unibyte_string!(suffix, s);
         let genname = unsafe { concat2(name.into(), suffix) };
         if get_buffer(genname.into()).is_none() {
diff --git a/rust_src/src/numbers.rs b/rust_src/src/numbers.rs
index f3ada5eea2..a6a7628759 100644
--- a/rust_src/src/numbers.rs
+++ b/rust_src/src/numbers.rs
@@ -3,7 +3,7 @@
 use std::cmp;
 use std::sync::Mutex;
 
-use rand::{Rng, SeedableRng, StdRng};
+use rand::{rngs::StdRng, FromEntropy, Rng, SeedableRng};
 
 use remacs_macros::lisp_fn;
 
@@ -18,7 +18,7 @@ use crate::{
 };
 
 lazy_static! {
-    static ref RNG: Mutex<StdRng> = Mutex::new(StdRng::new().unwrap());
+    static ref RNG: Mutex<StdRng> = Mutex::new(StdRng::from_entropy());
 }
 
 // Largest and smallest numbers that can be represented as fixnums in
@@ -314,10 +314,13 @@ pub fn number_or_marker_p(object: LispObject) -> bool {
 pub fn random(limit: LispObject) -> LispObject {
     let mut rng = RNG.lock().unwrap();
     if limit.is_t() {
-        *rng = StdRng::new().unwrap();
+        *rng = StdRng::from_entropy();
     } else if let Some(s) = limit.as_string() {
-        let values: Vec<usize> = s.as_slice().iter().map(|&x| x as usize).collect();
-        rng.reseed(&values);
+        let mut seed = [0; 32];
+        let mut values: Vec<u8> = s.as_slice().to_vec();
+        values.resize(32, 0);
+        seed.copy_from_slice(&values.as_slice());
+        *rng = StdRng::from_seed(seed);
     }
 
     if let Some(limit) = limit.as_fixnum() {
-- 
2.21.0


From a8282ec641f952de8bc9140475343398c5fe968b Mon Sep 17 00:00:00 2001
From: Daichi Mukai <mukai.daichi.37e@kyoto-u.jp>
Date: Wed, 6 Feb 2019 17:14:32 +0900
Subject: [PATCH 267/297] Add tests for generate-new-buffer-name

---
 test/rust_src/src/buffers-tests.el | 21 +++++++++++++++++++++
 1 file changed, 21 insertions(+)

diff --git a/test/rust_src/src/buffers-tests.el b/test/rust_src/src/buffers-tests.el
index 6e8056c0e7..e4ffe83ca1 100644
--- a/test/rust_src/src/buffers-tests.el
+++ b/test/rust_src/src/buffers-tests.el
@@ -85,6 +85,27 @@
         (rename-buffer "test-rename-buffer-foo" t)
         (should (string= (buffer-name buf) "test-rename-buffer-foo<2>")))))
 
+(ert-deftest test-generate-new-buffer-name ()
+  (let ((buf-name "test-generate-new-buffer-name"))
+    (get-buffer-create buf-name)
+    (should (string= (generate-new-buffer-name buf-name) (concat buf-name "<2>")))))
+
+(ert-deftest test-generate-new-buffer-name-ignore ()
+  (let ((buf-name "test-generate-new-buffer-name"))
+    (get-buffer-create buf-name)
+    (should (string= (generate-new-buffer-name buf-name buf-name) buf-name))))
+
+(ert-deftest test-generate-new-buffer-name-space ()
+  (let ((buf-name " test-generate-new-buffer-name"))
+    (get-buffer-create buf-name)
+    (let*((random-name (generate-new-buffer-name buf-name))
+          ;; 'random-name' should have the format like " test-generate-new-buffer-name-XXXXXX"
+          ;; For present implementation "XXXXXXX" is a random number greater than or equal to 0
+          ;; and less than 1_000_000.
+          (random-number (string-to-number (substring random-name (1+ (length buf-name))))))
+      (should-not (string= random-name buf-name))
+      (should (< 0 random-number 999999)))))
+
 (provide 'buffers-tests)
 
 ;;; buffers-tests.el ends here
-- 
2.21.0


From 0a1c280f6ee0cb552248150cb85f3e1527912949 Mon Sep 17 00:00:00 2001
From: Daichi Mukai <mukai.daichi.37e@kyoto-u.jp>
Date: Wed, 6 Feb 2019 17:25:39 +0900
Subject: [PATCH 268/297] Add tests for random

---
 test/rust_src/src/numbers-tests.el | 25 +++++++++++++++++++++++++
 1 file changed, 25 insertions(+)
 create mode 100644 test/rust_src/src/numbers-tests.el

diff --git a/test/rust_src/src/numbers-tests.el b/test/rust_src/src/numbers-tests.el
new file mode 100644
index 0000000000..a8d3b7cf99
--- /dev/null
+++ b/test/rust_src/src/numbers-tests.el
@@ -0,0 +1,25 @@
+;;; numbers-tests.el --- tests for numbers.rs functions -*- lexical-binding: t -*-
+
+;;; Code:
+
+(require 'ert)
+
+(ert-deftest test-random ()
+  (should (numberp (random))))
+
+(ert-deftest test-random-t ()
+  (should (numberp (random t))))
+
+(ert-deftest test-random-seed ()
+  (let* ((seed "test-seed")
+         (value1 (random seed))
+         (value2 (random)))
+    (should (numberp value1))
+    (should (= value1 (random seed)))
+    (should (= value2 (random)))))
+
+(ert-deftest test-random-range ()
+  (should (< 0 (random 10000) 10000)))
+
+(provide 'numbers-tests)
+;;; numbers-tests.el ends here
-- 
2.21.0


From fb1d0c4d48bf65c812db18e0c2e9d30259e68bb6 Mon Sep 17 00:00:00 2001
From: Shanavas M <shanavas.m2@gmail.com>
Date: Wed, 6 Feb 2019 16:10:57 +0530
Subject: [PATCH 269/297] Port find_symbol_value

---
 rust_src/src/data.rs    |  6 ++++++
 rust_src/src/symbols.rs | 28 +++++++++++++++++++++++++++-
 src/data.c              | 31 -------------------------------
 src/lisp.h              |  2 ++
 4 files changed, 35 insertions(+), 32 deletions(-)

diff --git a/rust_src/src/data.rs b/rust_src/src/data.rs
index ff49985191..6130623774 100644
--- a/rust_src/src/data.rs
+++ b/rust_src/src/data.rs
@@ -604,6 +604,12 @@ pub unsafe extern "C" fn store_symval_forwarding(
     }
 }
 
+#[no_mangle]
+pub unsafe extern "C" fn find_symbol_value(sym: LispObject) -> LispObject {
+    let symbol: LispSymbolRef = sym.into();
+    symbol.find_value()
+}
+
 unsafe fn update_buffer_defaults(objvar: *const LispObject, newval: LispObject) {
     // If this variable is a default for something stored
     // in the buffer itself, such as default-fill-column,
diff --git a/rust_src/src/symbols.rs b/rust_src/src/symbols.rs
index 3987954cdb..82a3898815 100644
--- a/rust_src/src/symbols.rs
+++ b/rust_src/src/symbols.rs
@@ -9,7 +9,7 @@ use crate::{
     buffers::per_buffer_idx_from_field_offset,
     buffers::{LispBufferLocalValueRef, LispBufferOrCurrent, LispBufferRef},
     data::Lisp_Fwd,
-    data::{as_buffer_objfwd, indirect_function, set},
+    data::{as_buffer_objfwd, do_symval_forwarding, indirect_function, set},
     hashtable::LispHashTableRef,
     lisp::{ExternalPtr, LispObject, LispStructuralEqual},
     multibyte::LispStringRef,
@@ -134,6 +134,32 @@ impl LispSymbolRef {
         s.val.value
     }
 
+    // Find the value of a symbol, returning Qunbound if it's not bound.
+    // This is helpful for code which just wants to get a variable's value
+    // if it has one, without signaling an error.
+    // Note that it must not be possible to quit
+    // within this function.  Great care is required for this.
+    pub unsafe fn find_value(self) -> LispObject {
+        let mut symbol = self.get_indirect_variable();
+
+        match symbol.get_redirect() {
+            symbol_redirect::SYMBOL_PLAINVAL => symbol.get_value(),
+            symbol_redirect::SYMBOL_LOCALIZED => {
+                let mut blv = symbol.get_blv();
+                swap_in_symval_forwarding(symbol.as_mut(), blv.as_mut());
+
+                let fwd = blv.get_fwd();
+                if fwd.is_null() {
+                    blv.get_value()
+                } else {
+                    do_symval_forwarding(fwd)
+                }
+            }
+            symbol_redirect::SYMBOL_FORWARDED => do_symval_forwarding(symbol.get_fwd()),
+            _ => unreachable!(),
+        }
+    }
+
     pub unsafe fn get_blv(self) -> LispBufferLocalValueRef {
         let s = self.u.s.as_ref();
         LispBufferLocalValueRef::new(s.val.blv)
diff --git a/src/data.c b/src/data.c
index 2215ccb137..3b16ae6bb0 100644
--- a/src/data.c
+++ b/src/data.c
@@ -304,37 +304,6 @@ swap_in_symval_forwarding (struct Lisp_Symbol *symbol, struct Lisp_Buffer_Local_
     }
 }
 
-/* Find the value of a symbol, returning Qunbound if it's not bound.
-   This is helpful for code which just wants to get a variable's value
-   if it has one, without signaling an error.
-   Note that it must not be possible to quit
-   within this function.  Great care is required for this.  */
-
-Lisp_Object
-find_symbol_value (Lisp_Object symbol)
-{
-  struct Lisp_Symbol *sym;
-
-  CHECK_SYMBOL (symbol);
-  sym = XSYMBOL (symbol);
-
- start:
-  switch (sym->u.s.redirect)
-    {
-    case SYMBOL_VARALIAS: sym = indirect_variable (sym); goto start;
-    case SYMBOL_PLAINVAL: return SYMBOL_VAL (sym);
-    case SYMBOL_LOCALIZED:
-      {
-	struct Lisp_Buffer_Local_Value *blv = SYMBOL_BLV (sym);
-	swap_in_symval_forwarding (sym, blv);
-	return blv->fwd ? do_symval_forwarding (blv->fwd) : get_blv_value (blv);
-      }
-      /* FALLTHROUGH */
-    case SYMBOL_FORWARDED:
-      return do_symval_forwarding (SYMBOL_FWD (sym));
-    default: emacs_abort ();
-    }
-}
 
 /* Store the value NEWVAL into SYMBOL.
    If buffer-locality is an issue, WHERE specifies which context to use.
diff --git a/src/lisp.h b/src/lisp.h
index ce681ccc72..727f867a30 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -3481,6 +3481,8 @@ extern _Noreturn void args_out_of_range_3 (Lisp_Object, Lisp_Object,
 					   Lisp_Object);
 extern _Noreturn void circular_list (Lisp_Object);
 extern Lisp_Object do_symval_forwarding (union Lisp_Fwd *);
+extern Lisp_Object find_symbol_value (Lisp_Object symbol);
+
 enum Set_Internal_Bind {
   SET_INTERNAL_SET,
   SET_INTERNAL_BIND,
-- 
2.21.0


From 200ef681a7a9cf421198cab6a9c87d44708aa10c Mon Sep 17 00:00:00 2001
From: Shanavas M <shanavas.m2@gmail.com>
Date: Wed, 6 Feb 2019 17:41:51 +0530
Subject: [PATCH 270/297] Port rust usages of find_symbol_value

---
 rust_src/src/eval.rs    | 6 +++---
 rust_src/src/symbols.rs | 4 ++--
 2 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/rust_src/src/eval.rs b/rust_src/src/eval.rs
index e7e7d4ddd6..f078d24ed4 100644
--- a/rust_src/src/eval.rs
+++ b/rust_src/src/eval.rs
@@ -20,8 +20,8 @@ use crate::{
     },
     remacs_sys::{
         backtrace_debug_on_exit, build_string, call_debugger, check_cons_list, do_debug_on_call,
-        do_one_unbind, eval_sub, find_symbol_value, funcall_lambda, funcall_subr, globals,
-        grow_specpdl, internal_catch, internal_lisp_condition_case, list2, maybe_gc, maybe_quit,
+        do_one_unbind, eval_sub, funcall_lambda, funcall_subr, globals, grow_specpdl,
+        internal_catch, internal_lisp_condition_case, list2, maybe_gc, maybe_quit,
         record_in_backtrace, record_unwind_save_match_data, signal_or_quit, specbind, COMPILEDP,
         MODULE_FUNCTIONP,
     },
@@ -1025,7 +1025,7 @@ fn run_hook_with_args_internal(
 
     let mut ret = Qnil;
     let sym = args[0];
-    let val = unsafe { find_symbol_value(sym) };
+    let val = unsafe { LispSymbolRef::from(sym).find_value() };
 
     if val.eq(Qunbound) || val.is_nil() {
         Qnil
diff --git a/rust_src/src/symbols.rs b/rust_src/src/symbols.rs
index 82a3898815..c2e8861d49 100644
--- a/rust_src/src/symbols.rs
+++ b/rust_src/src/symbols.rs
@@ -15,7 +15,7 @@ use crate::{
     multibyte::LispStringRef,
     remacs_sys::{equal_kind, lispsym, EmacsInt, Lisp_Symbol, Lisp_Type, USE_LSB_TAG},
     remacs_sys::{
-        find_symbol_value, get_symbol_declared_special, get_symbol_redirect, make_lisp_symbol,
+        get_symbol_declared_special, get_symbol_redirect, make_lisp_symbol,
         set_symbol_declared_special, set_symbol_redirect, swap_in_symval_forwarding,
         symbol_interned, symbol_redirect, symbol_trapped_write,
     },
@@ -423,7 +423,7 @@ pub fn makunbound(symbol: LispSymbolRef) -> LispSymbolRef {
 /// outside of any lexical scope.
 #[lisp_fn]
 pub fn symbol_value(symbol: LispSymbolRef) -> LispObject {
-    let val = unsafe { find_symbol_value(symbol.into()) };
+    let val = unsafe { symbol.find_value() };
     if val == Qunbound {
         void_variable!(symbol);
     }
-- 
2.21.0


From 1d4e731c015996cdabb5545484b100c1f64fd861 Mon Sep 17 00:00:00 2001
From: Barry Roberts <manithree@gmail.com>
Date: Thu, 7 Feb 2019 03:13:58 -0700
Subject: [PATCH 271/297] Added necessary libraries for fedora (#1332)

Also, yum is deprecated and may be removed in Fedora 30, so change to
dnf.
---
 docker/fedora/Dockerfile  | 4 +++-
 docker/fedora/config.yaml | 4 +++-
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/docker/fedora/Dockerfile b/docker/fedora/Dockerfile
index 546a8ed490..470647e034 100644
--- a/docker/fedora/Dockerfile
+++ b/docker/fedora/Dockerfile
@@ -1,6 +1,6 @@
 FROM fedora:latest
 
-RUN yum install -y \
+RUN dnf install -y \
     git \
     gcc gcc-c++ \
     kernel-devel \
@@ -14,6 +14,8 @@ RUN yum install -y \
     libxml2-devel \
     libXpm-devel \
     gnutls-devel \
+    clang-devel \
+    libXt-devel \
     curl \
     texinfo
 
diff --git a/docker/fedora/config.yaml b/docker/fedora/config.yaml
index 020c102d32..32fb1a48b9 100644
--- a/docker/fedora/config.yaml
+++ b/docker/fedora/config.yaml
@@ -2,7 +2,7 @@
 arch: x86_64
 distro: fedora:latest
 base_config: |
-    RUN yum install -y \
+    RUN dnf install -y \
         git \
         gcc gcc-c++ \
         kernel-devel \
@@ -16,5 +16,7 @@ base_config: |
         libxml2-devel \
         libXpm-devel \
         gnutls-devel \
+        clang-devel \
+        libXt-devel \
         curl \
         texinfo
-- 
2.21.0


From f1f92bb47b5d1523fc15d34c3eb77792669b2978 Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Thu, 7 Feb 2019 16:28:07 +0100
Subject: [PATCH 272/297] Port get-file-char (#1328)

---
 rust_src/src/lread.rs | 53 ++++++++++++++++++++++++++++++++++++++++++-
 src/buffer.h          |  1 +
 src/lread.c           | 36 -----------------------------
 3 files changed, 53 insertions(+), 37 deletions(-)

diff --git a/rust_src/src/lread.rs b/rust_src/src/lread.rs
index e5d78dfb85..d675cacf7b 100644
--- a/rust_src/src/lread.rs
+++ b/rust_src/src/lread.rs
@@ -5,6 +5,8 @@ use libc;
 use std::ffi::CString;
 use std::ptr;
 
+use errno::errno;
+
 use remacs_macros::lisp_fn;
 
 use crate::{
@@ -17,8 +19,10 @@ use crate::{
     lisp::LispObject,
     obarray::{intern, intern_c_string_1},
     remacs_sys,
+    remacs_sys::infile,
     remacs_sys::{
-        build_string, read_internal_start, readevalloop, specbind, staticpro, symbol_redirect,
+        block_input, build_string, clearerr_unlocked, ferror_unlocked, getc_unlocked, maybe_quit,
+        read_internal_start, readevalloop, specbind, staticpro, symbol_redirect, unblock_input,
     },
     remacs_sys::{globals, EmacsInt},
     remacs_sys::{Qeval_buffer_list, Qnil, Qread_char, Qstandard_output, Qsymbolp},
@@ -155,6 +159,44 @@ pub unsafe fn defvar_per_buffer_offset(
     }
 }
 
+/// Read a byte from stdio. If it has lookahead, use the stored value.
+/// If read over network is interrupted, keep trying until read succeeds.
+#[no_mangle]
+pub unsafe extern "C" fn readbyte_from_stdio() -> i32 {
+    let file = &mut *infile;
+
+    // If infile has lookahead, use stored value
+    if file.lookahead > 0 {
+        file.lookahead -= 1;
+        return file.buf[file.lookahead as usize].into();
+    }
+
+    let instream = file.stream;
+
+    block_input();
+
+    // Interrupted read have been observed while reading over the network.
+    let c = loop {
+        let c = getc_unlocked(instream);
+        if c == libc::EOF && errno().0 == libc::EINTR && ferror_unlocked(instream) > 0 {
+            unblock_input();
+            maybe_quit();
+            block_input();
+            clearerr_unlocked(instream);
+        } else {
+            break c;
+        }
+    };
+
+    unblock_input();
+
+    if c != libc::EOF {
+        c
+    } else {
+        -1
+    }
+}
+
 /// Read one Lisp expression as text from STREAM, return as Lisp object.
 /// If STREAM is nil, use the value of `standard-input' (which see).
 /// STREAM or the value of `standard-input' may be:
@@ -192,6 +234,15 @@ pub fn read(stream: LispObject) -> LispObject {
     }
 }
 
+/// Don't use this yourself.
+#[lisp_fn]
+pub fn get_file_char() -> EmacsInt {
+    if unsafe { infile }.is_null() {
+        error!("get-file-char misused");
+    }
+    unsafe { readbyte_from_stdio().into() }
+}
+
 /// Execute the region as Lisp code.
 /// When called from programs, expects two arguments,
 /// giving starting and ending indices in the current buffer
diff --git a/src/buffer.h b/src/buffer.h
index 92a877f93b..558d7a9953 100644
--- a/src/buffer.h
+++ b/src/buffer.h
@@ -1442,6 +1442,7 @@ extern struct infile* infile;
 extern void readevalloop (Lisp_Object, struct infile *, Lisp_Object, bool,
                           Lisp_Object, Lisp_Object,
                           Lisp_Object, Lisp_Object);
+extern int readbyte_from_stdio(void);
 
 INLINE_HEADER_END
 
diff --git a/src/lread.c b/src/lread.c
index 5b1bbc9394..6ddf1aa1df 100644
--- a/src/lread.c
+++ b/src/lread.c
@@ -446,32 +446,6 @@ readbyte_for_lambda (int c, Lisp_Object readcharfun)
 }
 
 
-static int
-readbyte_from_stdio (void)
-{
-  if (infile->lookahead)
-    return infile->buf[--infile->lookahead];
-
-  int c;
-  FILE *instream = infile->stream;
-
-  block_input ();
-
-  /* Interrupted reads have been observed while reading over the network.  */
-  while ((c = getc_unlocked (instream)) == EOF && errno == EINTR
-	 && ferror_unlocked (instream))
-    {
-      unblock_input ();
-      maybe_quit ();
-      block_input ();
-      clearerr_unlocked (instream);
-    }
-
-  unblock_input ();
-
-  return (c == EOF ? -1 : c);
-}
-
 static int
 readbyte_from_file (int c, Lisp_Object readcharfun)
 {
@@ -784,15 +758,6 @@ floating-point value.  */)
 	  : make_number (char_resolve_modifier_mask (XINT (val))));
 }
 
-DEFUN ("get-file-char", Fget_file_char, Sget_file_char, 0, 0, 0,
-       doc: /* Don't use this yourself.  */)
-  (void)
-{
-  if (!infile)
-    error ("get-file-char misused");
-  return make_number (readbyte_from_stdio ());
-}
-
 
 
 
@@ -4462,7 +4427,6 @@ syms_of_lread (void)
   defsubr (&Sread_char);
   defsubr (&Sread_char_exclusive);
   defsubr (&Sread_event);
-  defsubr (&Sget_file_char);
   defsubr (&Slocate_file_internal);
 
   DEFVAR_LISP ("obarray", Vobarray,
-- 
2.21.0


From 9ed91a01d8242b2c96c336e85b67f1dab5c88038 Mon Sep 17 00:00:00 2001
From: Shanavas M <shanavas.m2@gmail.com>
Date: Fri, 8 Feb 2019 21:33:59 +0530
Subject: [PATCH 273/297] Remove duplicate declaration

---
 src/lisp.h | 1 -
 1 file changed, 1 deletion(-)

diff --git a/src/lisp.h b/src/lisp.h
index 727f867a30..6b068f43c2 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -3481,7 +3481,6 @@ extern _Noreturn void args_out_of_range_3 (Lisp_Object, Lisp_Object,
 					   Lisp_Object);
 extern _Noreturn void circular_list (Lisp_Object);
 extern Lisp_Object do_symval_forwarding (union Lisp_Fwd *);
-extern Lisp_Object find_symbol_value (Lisp_Object symbol);
 
 enum Set_Internal_Bind {
   SET_INTERNAL_SET,
-- 
2.21.0


From 70d3fdf5b819f3a5c492c1654fa650d54eb6d9ff Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Fri, 8 Feb 2019 21:05:53 +0100
Subject: [PATCH 274/297] Port reverse (#1335)

---
 rust_src/src/fns.rs            | 69 ++++++++++++++++++++++++++++++++--
 rust_src/src/multibyte.rs      | 28 ++++++++++++++
 rust_src/src/vectors.rs        | 12 ++++++
 src/fns.c                      | 67 ---------------------------------
 test/rust_src/src/fns-tests.el | 50 ++++++++++++++++++++++++
 test/src/fns-tests.el          | 23 ------------
 6 files changed, 155 insertions(+), 94 deletions(-)

diff --git a/rust_src/src/fns.rs b/rust_src/src/fns.rs
index a49550d721..57849b6c67 100644
--- a/rust_src/src/fns.rs
+++ b/rust_src/src/fns.rs
@@ -1,6 +1,6 @@
 //! Random utility Lisp functions.
 
-use std::ptr;
+use std::{ptr, slice};
 
 use libc;
 
@@ -14,16 +14,20 @@ use crate::{
     lists::{assq, car, get, mapcar1, member, memq, put},
     lists::{LispCons, LispConsCircularChecks, LispConsEndChecks},
     minibuf::read_from_minibuffer,
-    multibyte::LispStringRef,
+    multibyte::{string_char_and_length, write_codepoint, LispStringRef},
     numbers::LispNumber,
     obarray::loadhist_attach,
     objects::equal,
     remacs_sys::Vautoload_queue,
-    remacs_sys::{concat as lisp_concat, globals, message1, redisplay_preserve_echo_area},
+    remacs_sys::{
+        concat as lisp_concat, globals, make_uninit_bool_vector, make_uninit_multibyte_string,
+        make_uninit_string, make_uninit_vector, message1, redisplay_preserve_echo_area,
+    },
     remacs_sys::{EmacsInt, Lisp_Type},
     remacs_sys::{Fdiscard_input, Fload, Fx_popup_dialog},
     remacs_sys::{
-        Qfuncall, Qlistp, Qnil, Qprovide, Qquote, Qrequire, Qsubfeatures, Qt, Qyes_or_no_p_history,
+        Qfuncall, Qlistp, Qnil, Qprovide, Qquote, Qrequire, Qsequencep, Qsubfeatures, Qt,
+        Qyes_or_no_p_history,
     },
     symbols::LispSymbolRef,
     threads::c_specpdl_index,
@@ -274,6 +278,63 @@ pub fn concat(args: &mut [LispObject]) -> LispObject {
     }
 }
 
+/// Return the reversed copy of list, vector, or string SEQ.
+/// See also the function `nreverse', which is used more often.
+#[lisp_fn]
+pub fn reverse(seq: LispObject) -> LispObject {
+    if seq.is_nil() {
+        Qnil
+    } else if let Some(cons) = seq.as_cons() {
+        cons.iter_cars(LispConsEndChecks::on, LispConsCircularChecks::on)
+            .fold(Qnil, |cons, elt| LispObject::cons(elt, cons))
+    } else if let Some(vector) = seq.as_vector() {
+        let size = vector.len();
+        let mut new = unsafe { make_uninit_vector(size as isize) }.force_vector();
+
+        for (i, item) in vector.iter().enumerate() {
+            unsafe { new.set_unchecked(size - 1 - i, item) };
+        }
+        new.into()
+    } else if let Some(boolvec) = seq.as_bool_vector() {
+        let nbits = boolvec.len();
+        let mut new = unsafe { make_uninit_bool_vector(nbits as i64) }.force_bool_vector();
+
+        for (i, item) in boolvec.iter().enumerate() {
+            unsafe { new.set_unchecked(nbits - 1 - i, item.into()) }
+        }
+        new.into()
+    } else if let Some(string) = seq.as_string() {
+        let size = string.len_chars();
+        let bytes = string.len_bytes();
+
+        if !string.is_multibyte() {
+            let mut new = unsafe { make_uninit_string(size as i64) }.force_string();
+
+            for (i, c) in string.as_slice().iter().enumerate() {
+                new.set_byte(size - i as isize - 1, *c);
+            }
+            new.into()
+        } else {
+            let mut new =
+                unsafe { make_uninit_multibyte_string(size as i64, bytes as i64) }.force_string();
+            let mut p = string.const_data_ptr();
+            let mut q = unsafe { new.data_ptr().add(bytes as usize) };
+            let end = new.data_ptr();
+            while q > end {
+                unsafe {
+                    let (c, len) = string_char_and_length(p);
+                    p = p.add(len);
+                    q = q.sub(len);
+                    write_codepoint(slice::from_raw_parts_mut(q, len), c);
+                }
+            }
+            new.into()
+        }
+    } else {
+        wrong_type!(Qsequencep, seq);
+    }
+}
+
 // Return true if O1 and O2 are equal.  Do not quit or check for cycles.
 // Use this only on arguments that are cycle-free and not too large and
 // are not window configurations.
diff --git a/rust_src/src/multibyte.rs b/rust_src/src/multibyte.rs
index 791ceec017..23b3119173 100644
--- a/rust_src/src/multibyte.rs
+++ b/rust_src/src/multibyte.rs
@@ -583,6 +583,34 @@ pub fn multibyte_char_at(slice: &[c_uchar]) -> (Codepoint, usize) {
     }
 }
 
+/// Same as STRING_CHAR_AND_LENGTH
+pub unsafe fn string_char_and_length(ptr: *const u8) -> (Codepoint, usize) {
+    let head = *ptr;
+    // using multibyte_length_by_head is slightly more expnsive, as it also
+    // checks if head & 0x08 == 0. Since this is function is going to be used
+    // pretty often as invocations of the original macro gets replaced, it may
+    // be worth it to directly make the bitwise comparisons.
+    match multibyte_length_by_head(head) {
+        1 => (head.into(), 1),
+        2 => {
+            let cp = (Codepoint::from((head & 0x1F) << 6) | Codepoint::from(*ptr.add(1) & 0x3F))
+                + if head < 0xC2 { 0x3F_FF_80 } else { 0 };
+            (cp, 2)
+        }
+        3 => {
+            let cp = (Codepoint::from(head & 0x0F) << 12)
+                | ((Codepoint::from(*ptr.add(1) & 0x3F)) << 6)
+                | Codepoint::from(*ptr.add(2) & 0x3F);
+            (cp, 3)
+        }
+        _ => {
+            let mut len = 0;
+            let cp = string_char(ptr, ptr::null_mut(), &mut len);
+            (cp as Codepoint, len as usize)
+        }
+    }
+}
+
 /// Same as `BYTES_BY_CHAR_HEAD` macro in C.
 pub fn multibyte_length_by_head(byte: c_uchar) -> usize {
     if byte & 0x80 == 0 {
diff --git a/rust_src/src/vectors.rs b/rust_src/src/vectors.rs
index d63496d4e2..f0a1fd8ac8 100644
--- a/rust_src/src/vectors.rs
+++ b/rust_src/src/vectors.rs
@@ -86,6 +86,18 @@ impl LispObject {
         self.as_vectorlike_unchecked().as_vector_unchecked()
     }
 
+    pub fn force_vector(self) -> LispVectorRef {
+        unsafe { self.as_vector_unchecked() }
+    }
+
+    pub unsafe fn as_bool_vector_unchecked(self) -> LispBoolVecRef {
+        LispBoolVecRef::new(self.get_untaggedptr() as *mut Lisp_Bool_Vector)
+    }
+
+    pub fn force_bool_vector(self) -> LispBoolVecRef {
+        unsafe { self.as_bool_vector_unchecked() }
+    }
+
     pub fn as_vector_or_string_length(self) -> isize {
         if let Some(s) = self.as_string() {
             return s.len_chars();
diff --git a/src/fns.c b/src/fns.c
index 414ac8c69b..4b3c04df76 100644
--- a/src/fns.c
+++ b/src/fns.c
@@ -1248,72 +1248,6 @@ This function may destructively modify SEQ to produce the value.  */)
   return seq;
 }
 
-DEFUN ("reverse", Freverse, Sreverse, 1, 1, 0,
-       doc: /* Return the reversed copy of list, vector, or string SEQ.
-See also the function `nreverse', which is used more often.  */)
-  (Lisp_Object seq)
-{
-  Lisp_Object new;
-
-  if (NILP (seq))
-    return Qnil;
-  else if (CONSP (seq))
-    {
-      new = Qnil;
-      FOR_EACH_TAIL (seq)
-	new = Fcons (XCAR (seq), new);
-      CHECK_LIST_END (seq, seq);
-    }
-  else if (VECTORP (seq))
-    {
-      ptrdiff_t i, size = ASIZE (seq);
-
-      new = make_uninit_vector (size);
-      for (i = 0; i < size; i++)
-	ASET (new, i, AREF (seq, size - i - 1));
-    }
-  else if (BOOL_VECTOR_P (seq))
-    {
-      ptrdiff_t i;
-      EMACS_INT nbits = bool_vector_size (seq);
-
-      new = make_uninit_bool_vector (nbits);
-      for (i = 0; i < nbits; i++)
-	bool_vector_set (new, i, bool_vector_bitref (seq, nbits - i - 1));
-    }
-  else if (STRINGP (seq))
-    {
-      ptrdiff_t size = SCHARS (seq), bytes = SBYTES (seq);
-
-      if (size == bytes)
-	{
-	  ptrdiff_t i;
-
-	  new = make_uninit_string (size);
-	  for (i = 0; i < size; i++)
-	    SSET (new, i, SREF (seq, size - i - 1));
-	}
-      else
-	{
-	  unsigned char *p, *q;
-
-	  new = make_uninit_multibyte_string (size, bytes);
-	  p = SDATA (seq), q = SDATA (new) + bytes;
-	  while (q > SDATA (new))
-	    {
-	      int ch, len;
-
-	      ch = STRING_CHAR_AND_LENGTH (p, len);
-	      p += len, q -= len;
-	      CHAR_STRING (ch, q);
-	    }
-	}
-    }
-  else
-    wrong_type_argument (Qsequencep, seq);
-  return new;
-}
-
 
 DEFUN ("fillarray", Ffillarray, Sfillarray, 2, 2, 0,
        doc: /* Store each element of ARRAY with ITEM.
@@ -2983,7 +2917,6 @@ this variable.  */);
   defsubr (&Ssubstring_no_properties);
   defsubr (&Sdelete);
   defsubr (&Snreverse);
-  defsubr (&Sreverse);
   defsubr (&Sfillarray);
   defsubr (&Smapcar);
   defsubr (&Smapcan);
diff --git a/test/rust_src/src/fns-tests.el b/test/rust_src/src/fns-tests.el
index f8e68533c9..934fe8b696 100644
--- a/test/rust_src/src/fns-tests.el
+++ b/test/rust_src/src/fns-tests.el
@@ -47,3 +47,53 @@
   (should (floatp (car (load-average 42))))
   (should (floatp (car (load-average "asdf"))))
   (should (floatp (car (load-average '(gimme floats))))))
+
+(ert-deftest test-reverse ()
+  (should-error (reverse))
+  (should-error (reverse 1))
+  (should-error (reverse (make-char-table 'foo)))
+  (should (equal [] (reverse [])))
+  (should (equal [0] (reverse [0])))
+  (should (equal [1 2 3 4] (reverse (reverse [1 2 3 4]))))
+  (should (equal '(a b c d) (reverse (reverse '(a b c d)))))
+  (should (equal "xyzzy" (reverse (reverse "xyzzy"))))
+  (should (equal "こんにちは / ｺﾝﾆﾁﾊ" (reverse (reverse "こんにちは / ｺﾝﾆﾁﾊ")))))
+
+(ert-deftest test-reverse-bool-vector ()
+  (let ((A (make-bool-vector 10 nil)))
+    (dotimes (i 5) (aset A i t))
+    (should (equal [nil nil nil nil nil t t t t t] (vconcat (reverse A))))
+    (should (equal A (reverse (reverse A))))))
+
+;; Test handling of cyclic and dotted lists.
+
+(defun cyc1 (a)
+  (let ((ls (make-list 10 a)))
+    (nconc ls ls)
+    ls))
+
+(defun cyc2 (a b)
+  (let ((ls1 (make-list 10 a))
+        (ls2 (make-list 1000 b)))
+    (nconc ls2 ls2)
+    (nconc ls1 ls2)
+    ls1))
+
+(defun dot1 (a)
+  (let ((ls (make-list 10 a)))
+    (nconc ls 'tail)
+    ls))
+
+(defun dot2 (a b)
+  (let ((ls1 (make-list 10 a))
+        (ls2 (make-list 10 b)))
+    (nconc ls1 ls2)
+    (nconc ls2 'tail)
+    ls1))
+
+(ert-deftest test-cycle-reverse ()
+  "Tests reverse errors on a circular list"
+  (should-error (reverse (cyc1 1)) :type 'circular-list)
+  (should-error (reverse (cyc2 1 2)) :type 'circular-list)
+  (should-error (reverse (dot1 1)) :type 'wrong-type-argument)
+  (should-error (reverse (dot2 1 2)) :type 'wrong-type-argument))
diff --git a/test/src/fns-tests.el b/test/src/fns-tests.el
index 3810a7a679..3f8181b4b8 100644
--- a/test/src/fns-tests.el
+++ b/test/src/fns-tests.el
@@ -23,17 +23,6 @@
 
 (require 'cl-lib)
 
-(ert-deftest fns-tests-reverse ()
-  (should-error (reverse))
-  (should-error (reverse 1))
-  (should-error (reverse (make-char-table 'foo)))
-  (should (equal [] (reverse [])))
-  (should (equal [0] (reverse [0])))
-  (should (equal [1 2 3 4] (reverse (reverse [1 2 3 4]))))
-  (should (equal '(a b c d) (reverse (reverse '(a b c d)))))
-  (should (equal "xyzzy" (reverse (reverse "xyzzy"))))
-  (should (equal "こんにちは / ｺﾝﾆﾁﾊ" (reverse (reverse "こんにちは / ｺﾝﾆﾁﾊ")))))
-
 (ert-deftest fns-tests-nreverse ()
   (should-error (nreverse))
   (should-error (nreverse 1))
@@ -56,12 +45,6 @@
 	 (B (nreverse (nreverse A))))
     (should (equal A B))))
 
-(ert-deftest fns-tests-reverse-bool-vector ()
-  (let ((A (make-bool-vector 10 nil)))
-    (dotimes (i 5) (aset A i t))
-    (should (equal [nil nil nil nil nil t t t t t] (vconcat (reverse A))))
-    (should (equal A (reverse (reverse A))))))
-
 (ert-deftest fns-tests-nreverse-bool-vector ()
   (let ((A (make-bool-vector 10 nil)))
     (dotimes (i 5) (aset A i t))
@@ -443,12 +426,6 @@
   (should-error (delete 3 (dot1 1)) :type 'wrong-type-argument)
   (should-error (delete 3 (dot2 1 2)) :type 'wrong-type-argument))
 
-(ert-deftest test-cycle-reverse ()
-  (should-error (reverse (cyc1 1)) :type 'circular-list)
-  (should-error (reverse (cyc2 1 2)) :type 'circular-list)
-  (should-error (reverse (dot1 1)) :type 'wrong-type-argument)
-  (should-error (reverse (dot2 1 2)) :type 'wrong-type-argument))
-
 (ert-deftest test-cycle-equal ()
   (should-error (equal (cyc1 1) (cyc1 1)))
   (should-error (equal (cyc2 1 2) (cyc2 1 2))))
-- 
2.21.0


From 659c2d900fb91d71544ab6c3f82840d85155df85 Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Fri, 8 Feb 2019 21:29:50 +0100
Subject: [PATCH 275/297] Temporary fix for #1333 (#1334)

Includes @shaleh's temporary fix for #1333.
---
 rust_src/src/lread.rs | 19 +++++++++++++++++--
 1 file changed, 17 insertions(+), 2 deletions(-)

diff --git a/rust_src/src/lread.rs b/rust_src/src/lread.rs
index d675cacf7b..7abb9eea02 100644
--- a/rust_src/src/lread.rs
+++ b/rust_src/src/lread.rs
@@ -21,8 +21,8 @@ use crate::{
     remacs_sys,
     remacs_sys::infile,
     remacs_sys::{
-        block_input, build_string, clearerr_unlocked, ferror_unlocked, getc_unlocked, maybe_quit,
-        read_internal_start, readevalloop, specbind, staticpro, symbol_redirect, unblock_input,
+        block_input, build_string, getc_unlocked, maybe_quit, read_internal_start, readevalloop,
+        specbind, staticpro, symbol_redirect, unblock_input,
     },
     remacs_sys::{globals, EmacsInt},
     remacs_sys::{Qeval_buffer_list, Qnil, Qread_char, Qstandard_output, Qsymbolp},
@@ -30,6 +30,21 @@ use crate::{
     threads::{c_specpdl_index, ThreadState},
 };
 
+#[cfg(target_os = "macos")]
+extern "C" {
+    #[link_name = "\u{1}_clearerr_unlocked"]
+    pub fn clearerr_unlocked(arg1: *mut crate::remacs_sys::FILE);
+}
+
+#[cfg(target_os = "macos")]
+extern "C" {
+    #[link_name = "\u{1}_ferror_unlocked"]
+    pub fn ferror_unlocked(arg1: *mut crate::remacs_sys::FILE) -> ::libc::c_int;
+}
+
+#[cfg(not(target_os = "macos"))]
+use crate::remacs_sys::{clearerr_unlocked, ferror_unlocked};
+
 // Define an "integer variable"; a symbol whose value is forwarded to a
 // C variable of type EMACS_INT.  Sample call (with "xx" to fool make-docfile):
 // DEFxxVAR_INT ("emacs-priority", &emacs_priority, "Documentation");
-- 
2.21.0


From 6fd66ce8d0675f27648a287b19255472ac949c1a Mon Sep 17 00:00:00 2001
From: Amanda Graven <amanda@amandag.net>
Date: Fri, 8 Feb 2019 23:43:10 +0100
Subject: [PATCH 276/297] Add LispSymbolOrString type (#1302)

---
 rust_src/src/buffers.rs    | 18 ++++----
 rust_src/src/dired_unix.rs |  2 +-
 rust_src/src/lib.rs        |  1 +
 rust_src/src/multibyte.rs  | 87 ++++++++++++++++++++++++++++++++++++++
 rust_src/src/obarray.rs    | 25 ++++++-----
 rust_src/src/strings.rs    | 39 +++++++++++------
 rust_src/src/symbols.rs    | 10 -----
 7 files changed, 136 insertions(+), 46 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index beea11b6b3..7e71267643 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -23,8 +23,8 @@ use crate::{
     lists::{car, cdr, list, member, rassq, setcar},
     lists::{CarIter, LispConsCircularChecks, LispConsEndChecks},
     marker::{build_marker, marker_buffer, marker_position_lisp, set_marker_both, LispMarkerRef},
-    multibyte::LispStringRef,
     multibyte::{multibyte_length_by_head, string_char},
+    multibyte::{LispStringRef, LispSymbolOrString},
     numbers::MOST_POSITIVE_FIXNUM,
     obarray::intern,
     remacs_sys::{
@@ -635,7 +635,7 @@ impl From<LispBufferOrName> for Option<LispBufferRef> {
             LispBufferOrName::Name(name) => {
                 let tem = unsafe { Vbuffer_alist }
                     .iter_cars(LispConsEndChecks::off, LispConsCircularChecks::off)
-                    .find(|&item| string_equal(car(item), name.into()));
+                    .find(|&item| string_equal(car(item), name));
 
                 cdr(tem.into()).as_buffer()
             }
@@ -897,7 +897,7 @@ pub fn overlay_lists() -> LispObject {
     unsafe { (Fnreverse(before), Fnreverse(after)).into() }
 }
 
-fn get_truename_buffer_1(filename: LispObject) -> LispObject {
+fn get_truename_buffer_1(filename: LispSymbolOrString) -> LispObject {
     LiveBufferIter::new()
         .find(|buf| {
             let buf_truename = buf.truename();
@@ -908,7 +908,7 @@ fn get_truename_buffer_1(filename: LispObject) -> LispObject {
 
 #[no_mangle]
 pub extern "C" fn get_truename_buffer(filename: LispObject) -> LispObject {
-    get_truename_buffer_1(filename)
+    get_truename_buffer_1(filename.into())
 }
 
 /// If buffer B has markers to record PT, BEGV and ZV when it is not
@@ -975,7 +975,7 @@ pub fn get_file_buffer(filename: LispStringRef) -> Option<LispBufferRef> {
     } else {
         LiveBufferIter::new().find(|buf| {
             let buf_filename = buf.filename();
-            buf_filename.is_string() && string_equal(buf_filename, filename.into())
+            buf_filename.is_string() && string_equal(buf_filename, filename)
         })
     }
 }
@@ -1142,9 +1142,7 @@ pub fn erase_buffer() {
 /// is first appended to NAME, to speed up finding a non-existent buffer.
 #[lisp_fn(min = "1")]
 pub fn generate_new_buffer_name(name: LispStringRef, ignore: LispObject) -> LispStringRef {
-    if (ignore.is_not_nil() && string_equal(name.into(), ignore))
-        || get_buffer(name.into()).is_none()
-    {
+    if (ignore.is_not_nil() && string_equal(name, ignore)) || get_buffer(name.into()).is_none() {
         return name;
     }
 
@@ -1168,9 +1166,9 @@ pub fn generate_new_buffer_name(name: LispStringRef, ignore: LispObject) -> Lisp
     loop {
         let mut s = format!("<{}>", suffix_count);
         local_unibyte_string!(suffix, s);
-        let candidate = unsafe { concat2(basename, suffix) };
+        let candidate = unsafe { concat2(basename, suffix) }.force_string();
         if string_equal(candidate, ignore) || get_buffer(candidate.into()).is_none() {
-            return candidate.into();
+            return candidate;
         }
         suffix_count += 1;
     }
diff --git a/rust_src/src/dired_unix.rs b/rust_src/src/dired_unix.rs
index a301187cfe..33cb229077 100644
--- a/rust_src/src/dired_unix.rs
+++ b/rust_src/src/dired_unix.rs
@@ -108,7 +108,7 @@ impl LispObjectExt for LispObject {
         if self.is_nil() {
             "NOTstring".to_string()
         } else {
-            let idf_sym_s = self.symbol_or_string_as_string();
+            let idf_sym_s: LispStringRef = self.as_symbol_or_string().into();
             idf_sym_s.to_string().to_lowercase()
         }
     }
diff --git a/rust_src/src/lib.rs b/rust_src/src/lib.rs
index ad49037ad0..c2eb6bc94f 100644
--- a/rust_src/src/lib.rs
+++ b/rust_src/src/lib.rs
@@ -17,6 +17,7 @@
 #![feature(slice_patterns)]
 #![feature(specialization)]
 #![feature(stmt_expr_attributes)]
+#![feature(type_alias_enum_variants)]
 #![feature(untagged_unions)]
 
 extern crate errno;
diff --git a/rust_src/src/multibyte.rs b/rust_src/src/multibyte.rs
index 23b3119173..f496548a66 100644
--- a/rust_src/src/multibyte.rs
+++ b/rust_src/src/multibyte.rs
@@ -41,9 +41,11 @@ use libc::{c_char, c_int, c_uchar, c_uint, c_void, memset, ptrdiff_t, size_t};
 use crate::{
     hashtable::LispHashTableRef,
     lisp::{ExternalPtr, LispObject, LispStructuralEqual},
+    obarray::LispObarrayRef,
     remacs_sys::Qstringp,
     remacs_sys::{char_bits, equal_kind, EmacsDouble, EmacsInt, Lisp_String, Lisp_Type},
     remacs_sys::{compare_string_intervals, empty_unibyte_string, lisp_string_width},
+    symbols::LispSymbolRef,
 };
 
 pub type LispStringRef = ExternalPtr<Lisp_String>;
@@ -310,6 +312,91 @@ impl LispObject {
     pub fn empty_unibyte_string() -> LispStringRef {
         LispStringRef::from(unsafe { empty_unibyte_string })
     }
+
+    // We can excuse not using an option here because extracting the value checks the type
+    // TODO: this is false with the enum model, change this
+    pub fn as_symbol_or_string(self) -> LispSymbolOrString {
+        self.into()
+    }
+}
+
+#[derive(Copy, Clone, PartialEq)]
+pub enum LispSymbolOrString {
+    String(LispStringRef),
+    Symbol(LispSymbolRef),
+}
+
+impl LispSymbolOrString {
+    pub fn is_string(self) -> bool {
+        match self {
+            LispSymbolOrString::String(_) => true,
+            _ => false,
+        }
+    }
+
+    pub fn is_symbol(self) -> bool {
+        match self {
+            LispSymbolOrString::Symbol(_) => true,
+            _ => false,
+        }
+    }
+}
+
+impl From<LispSymbolOrString> for LispObject {
+    fn from(s: LispSymbolOrString) -> Self {
+        match s {
+            LispSymbolOrString::String(s) => s.into(),
+            LispSymbolOrString::Symbol(sym) => sym.into(),
+        }
+    }
+}
+
+impl From<LispSymbolOrString> for LispStringRef {
+    fn from(s: LispSymbolOrString) -> Self {
+        match s {
+            LispSymbolOrString::String(s) => s,
+            LispSymbolOrString::Symbol(sym) => sym.symbol_name().into(),
+        }
+    }
+}
+
+impl From<LispStringRef> for LispSymbolOrString {
+    fn from(s: LispStringRef) -> Self {
+        Self::String(s)
+    }
+}
+
+impl From<LispSymbolOrString> for LispSymbolRef {
+    fn from(s: LispSymbolOrString) -> Self {
+        match s {
+            LispSymbolOrString::String(s) => LispObarrayRef::global().intern(s).into(),
+            LispSymbolOrString::Symbol(sym) => sym,
+        }
+    }
+}
+
+impl From<LispSymbolRef> for LispSymbolOrString {
+    fn from(s: LispSymbolRef) -> Self {
+        Self::Symbol(s)
+    }
+}
+
+impl From<LispObject> for LispSymbolOrString {
+    fn from(o: LispObject) -> Self {
+        if let Some(s) = o.as_string() {
+            Self::String(s)
+        } else if let Some(sym) = o.as_symbol() {
+            Self::Symbol(sym)
+        } else {
+            wrong_type!(Qstringp, o)
+        }
+    }
+}
+
+impl PartialEq<LispObject> for LispSymbolOrString {
+    fn eq(&self, other: &LispObject) -> bool {
+        (*other).eq(LispObject::from(*self))
+    }
 }
 
 pub fn is_ascii(c: Codepoint) -> bool {
diff --git a/rust_src/src/obarray.rs b/rust_src/src/obarray.rs
index 6706a51f7c..fe633badb5 100644
--- a/rust_src/src/obarray.rs
+++ b/rust_src/src/obarray.rs
@@ -5,7 +5,7 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     lisp::LispObject,
-    multibyte::LispStringRef,
+    multibyte::{LispStringRef, LispSymbolOrString},
     remacs_sys::{
         fatal_error_in_progress, globals, initial_obarray, initialized, intern_sym,
         make_pure_c_string, make_unibyte_string, oblookup,
@@ -44,8 +44,8 @@ impl LispObarrayRef {
     /// Return the symbol that matches NAME (either a symbol or string). If
     /// there is no such symbol, return the integer bucket number of where the
     /// symbol would be if it were present.
-    pub fn lookup(&self, name: LispObject) -> LispObject {
-        let string = name.symbol_or_string_as_string();
+    pub fn lookup(&self, name: LispSymbolOrString) -> LispObject {
+        let string: LispStringRef = name.into();
         unsafe {
             oblookup(
                 self.into(),
@@ -60,17 +60,20 @@ impl LispObarrayRef {
     /// symbol with that name in this `LispObarrayRef`. If Emacs is loading Lisp
     /// code to dump to an executable (ie. `purify-flag` is `t`), the symbol
     /// name will be transferred to pure storage.
-    pub fn intern(&self, string: LispStringRef) -> LispObject {
+    pub fn intern(&self, string: impl Into<LispSymbolOrString>) -> LispObject {
         let string = string.into();
         let tem = self.lookup(string);
         if tem.is_symbol() {
             tem
-        } else if unsafe { globals.Vpurify_flag }.is_not_nil() {
-            // When Emacs is running lisp code to dump to an executable, make
-            // use of pure storage.
-            intern_driver(unsafe { Fpurecopy(string) }, self.into(), tem)
         } else {
-            intern_driver(string, self.into(), tem)
+            let string_copy: LispObject = if unsafe { globals.Vpurify_flag }.is_not_nil() {
+                // When Emacs is running lisp code to dump to an executable, make
+                // use of pure storage.
+                unsafe { Fpurecopy(string.into()) }
+            } else {
+                string.into()
+            };
+            intern_driver(string_copy, self.into(), tem)
         }
     }
 }
@@ -204,11 +207,11 @@ pub extern "C" fn intern_driver(
 /// A second optional argument specifies the obarray to use;
 /// it defaults to the value of `obarray'.
 #[lisp_fn(min = "1")]
-pub fn intern_soft(name: LispObject, obarray: Option<LispObarrayRef>) -> LispObject {
+pub fn intern_soft(name: LispSymbolOrString, obarray: Option<LispObarrayRef>) -> LispObject {
     let obarray = obarray.unwrap_or_else(LispObarrayRef::global);
     let tem = obarray.lookup(name);
 
-    if tem.is_integer() || (name.is_symbol() && !name.eq(tem)) {
+    if tem.is_integer() || (name.is_symbol() && !name.eq(&tem)) {
         Qnil
     } else {
         tem
diff --git a/rust_src/src/strings.rs b/rust_src/src/strings.rs
index 150a0e64a1..0120279cbe 100644
--- a/rust_src/src/strings.rs
+++ b/rust_src/src/strings.rs
@@ -9,7 +9,7 @@ use remacs_macros::lisp_fn;
 use crate::{
     lisp::LispObject,
     multibyte,
-    multibyte::LispStringRef,
+    multibyte::{LispStringRef, LispSymbolOrString},
     remacs_sys::EmacsInt,
     remacs_sys::{
         make_unibyte_string, make_uninit_multibyte_string,
@@ -30,19 +30,23 @@ pub fn string_bytes(string: LispStringRef) -> EmacsInt {
     string.len_bytes() as EmacsInt
 }
 
-/// Return t if two strings have identical contents.
-/// Case is significant, but text properties are ignored.
-/// Symbols are also allowed; their print names are used instead.
-#[lisp_fn]
-pub fn string_equal(s1: LispObject, s2: LispObject) -> bool {
-    let s1 = LispObject::symbol_or_string_as_string(s1);
-    let s2 = LispObject::symbol_or_string_as_string(s2);
+pub fn string_equal(s1: impl Into<LispSymbolOrString>, s2: impl Into<LispSymbolOrString>) -> bool {
+    let s1 = LispStringRef::from(s1.into());
+    let s2 = LispStringRef::from(s2.into());
 
     s1.len_chars() == s2.len_chars()
         && s1.len_bytes() == s2.len_bytes()
         && s1.as_slice() == s2.as_slice()
 }
 
+/// Return t if two strings have identical contents.
+/// Case is significant, but text properties are ignored.
+/// Symbols are also allowed; their print names are used instead.
+#[lisp_fn(name = "string-equal", c_name = "string_equal")]
+pub fn string_equal_lisp(s1: LispSymbolOrString, s2: LispSymbolOrString) -> bool {
+    string_equal(s1, s2)
+}
+
 /// Return a multibyte string with the same individual bytes as STRING.
 /// If STRING is multibyte, the result is STRING itself.
 /// Otherwise it is a newly created string, with no text properties.
@@ -136,16 +140,23 @@ pub fn string_to_unibyte(string: LispStringRef) -> LispObject {
     }
 }
 
-/// Return non-nil if STRING1 is less than STRING2 in lexicographic order.
-/// Case is significant.
-#[lisp_fn]
-pub fn string_lessp(string1: LispObject, string2: LispObject) -> bool {
-    let s1 = LispObject::symbol_or_string_as_string(string1);
-    let s2 = LispObject::symbol_or_string_as_string(string2);
+pub fn string_lessp(
+    string1: impl Into<LispSymbolOrString>,
+    string2: impl Into<LispSymbolOrString>,
+) -> bool {
+    let s1 = LispStringRef::from(string1.into());
+    let s2 = LispStringRef::from(string2.into());
 
     s1.as_slice() < s2.as_slice()
 }
 
+/// Return non-nil if STRING1 is less than STRING2 in lexicographic order.
+/// Case is significant.
+#[lisp_fn(name = "string-lessp", c_name = "string_lessp")]
+pub fn string_lessp_lisp(string1: LispSymbolOrString, string2: LispSymbolOrString) -> bool {
+    string_lessp(string1, string2)
+}
+
 /// Return t if OBJECT is a multibyte string.
 /// Return nil if OBJECT is either a unibyte string, or not a string.
 #[lisp_fn]
diff --git a/rust_src/src/symbols.rs b/rust_src/src/symbols.rs
index c2e8861d49..07b90a0dbd 100644
--- a/rust_src/src/symbols.rs
+++ b/rust_src/src/symbols.rs
@@ -233,16 +233,6 @@ impl LispObject {
         self.into()
     }
 
-    pub fn symbol_or_string_as_string(self) -> LispStringRef {
-        match self.as_symbol() {
-            Some(sym) => sym
-                .symbol_name()
-                .as_string()
-                .expect("Expected a symbol name?"),
-            None => self.into(),
-        }
-    }
-
     fn symbol_ptr_value(self) -> EmacsInt {
         let ptr_value = if USE_LSB_TAG {
             self.to_C()
-- 
2.21.0


From d04a0a278ff816c4fa935c9d30c6db048641f787 Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Sun, 10 Feb 2019 14:45:53 +0100
Subject: [PATCH 277/297] port top-level (#1318)

port top-level
---
 rust_src/src/keyboard.rs | 29 ++++++++++++++++++++++++++---
 src/keyboard.c           | 19 -------------------
 2 files changed, 26 insertions(+), 22 deletions(-)

diff --git a/rust_src/src/keyboard.rs b/rust_src/src/keyboard.rs
index 6edf20b9ec..1159fbcf2c 100644
--- a/rust_src/src/keyboard.rs
+++ b/rust_src/src/keyboard.rs
@@ -17,18 +17,21 @@ use crate::{
         clear_message, command_loop_level, get_input_pending, glyph_row_area,
         interrupt_input_blocked, make_lispy_position, message_log_maybe_newline, minibuf_level,
         output_method, print_error_message, process_special_events, recursive_edit_1,
-        recursive_edit_unwind, temporarily_switch_to_single_kboard, update_mode_lines,
-        window_box_left_offset,
+        recursive_edit_unwind, temporarily_switch_to_single_kboard, totally_unblock_input,
+        update_mode_lines, window_box_left_offset,
     },
     remacs_sys::{Fdiscard_input, Fkill_emacs, Fpos_visible_in_window_p, Fterpri, Fthrow},
     remacs_sys::{
         Qexit, Qexternal_debugging_output, Qheader_line, Qhelp_echo, Qmode_line, Qnil, Qt,
-        Qvertical_line,
+        Qtop_level, Qvertical_line,
     },
     threads::c_specpdl_index,
     windows::{selected_window, LispWindowOrSelected},
 };
 
+#[cfg(feature = "window-system")]
+use crate::remacs_sys::cancel_hourglass;
+
 /// Return position information for buffer position POS in WINDOW.
 /// POS defaults to point in WINDOW; WINDOW defaults to the selected window.
 ///
@@ -303,4 +306,24 @@ pub fn input_pending_p(check_timers: bool) -> bool {
     }
 }
 
+/// Exit all recursive editing levels.
+/// This also exits all active minibuffers.
+#[lisp_fn(intspec = "")]
+pub fn top_level() {
+    unsafe {
+        #[cfg(feature = "window-system")]
+        {
+            if globals.display_hourglass_p {
+                cancel_hourglass();
+            }
+        }
+
+        // Unblock input if we enter with input blocked.  This may happen if
+        // redisplay traps e.g. during tool-bar update with input blocked.
+        totally_unblock_input();
+
+        Fthrow(Qtop_level, Qnil);
+    }
+}
+
 include!(concat!(env!("OUT_DIR"), "/keyboard_exports.rs"));
diff --git a/src/keyboard.c b/src/keyboard.c
index 35f9452658..5937646517 100644
--- a/src/keyboard.c
+++ b/src/keyboard.c
@@ -1041,24 +1041,6 @@ top_level_1 (Lisp_Object ignore)
   return Qnil;
 }
 
-DEFUN ("top-level", Ftop_level, Stop_level, 0, 0, "",
-       doc: /* Exit all recursive editing levels.
-This also exits all active minibuffers.  */
-       attributes: noreturn)
-  (void)
-{
-#ifdef HAVE_WINDOW_SYSTEM
-  if (display_hourglass_p)
-    cancel_hourglass ();
-#endif
-
-  /* Unblock input if we enter with input blocked.  This may happen if
-     redisplay traps e.g. during tool-bar update with input blocked.  */
-  totally_unblock_input ();
-
-  Fthrow (Qtop_level, Qnil);
-}
-
 
 /* Restore mouse tracking enablement.  See Ftrack_mouse for the only use
    of this function.  */
@@ -10995,7 +10977,6 @@ syms_of_keyboard (void)
   defsubr (&Sclear_this_command_keys);
   defsubr (&Ssuspend_emacs);
   defsubr (&Srecursion_depth);
-  defsubr (&Stop_level);
   defsubr (&Sdiscard_input);
   defsubr (&Sopen_dribble_file);
   defsubr (&Sset_input_interrupt_mode);
-- 
2.21.0


From a7692fe355c0174854750cafff511b20eba240b0 Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Mon, 11 Feb 2019 14:44:14 +0100
Subject: [PATCH 278/297] port copy-alist (#1191)

port copy-alist
---
 rust_src/src/fns.rs            | 25 +++++++++++++++++++++++++
 src/fns.c                      | 22 ----------------------
 test/rust_src/src/fns-tests.el |  4 ++++
 3 files changed, 29 insertions(+), 22 deletions(-)

diff --git a/rust_src/src/fns.rs b/rust_src/src/fns.rs
index 57849b6c67..77811332a7 100644
--- a/rust_src/src/fns.rs
+++ b/rust_src/src/fns.rs
@@ -388,6 +388,31 @@ pub fn load_average(use_floats: bool) -> Vec<LispNumber> {
         .collect()
 }
 
+/// Return a copy of ALIST.
+/// This is an alist which represents the same mapping from objects to objects,
+/// but does not share the alist structure with ALIST.
+/// The objects mapped (cars and cdrs of elements of the alist)
+/// are shared, however.
+/// Elements of ALIST that are not conses are also shared.
+#[lisp_fn]
+pub fn copy_alist(mut alist: LispObject) -> LispObject {
+    if alist.is_nil() {
+        return alist;
+    }
+
+    let new_alist = unsafe { lisp_concat(1, &mut alist, Lisp_Type::Lisp_Cons, false) };
+
+    for elt in new_alist.iter_tails(LispConsEndChecks::off, LispConsCircularChecks::off) {
+        let front = elt.car();
+        // To make a copy, unpack the cons and then make a new one while re-using the car and cdr.
+        if let Some((car, cdr)) = front.into() {
+            elt.set_car((car, cdr));
+        }
+    }
+
+    new_alist
+}
+
 /// Ask user a yes-or-no question.
 ///
 /// Return t if answer is yes, and nil if the answer is no.  PROMPT is
diff --git a/src/fns.c b/src/fns.c
index 4b3c04df76..5d0ab39b8a 100644
--- a/src/fns.c
+++ b/src/fns.c
@@ -887,27 +887,6 @@ If STRING is multibyte and contains a character of charset
   return string;
 }
 
-DEFUN ("copy-alist", Fcopy_alist, Scopy_alist, 1, 1, 0,
-       doc: /* Return a copy of ALIST.
-This is an alist which represents the same mapping from objects to objects,
-but does not share the alist structure with ALIST.
-The objects mapped (cars and cdrs of elements of the alist)
-are shared, however.
-Elements of ALIST that are not conses are also shared.  */)
-  (Lisp_Object alist)
-{
-  if (NILP (alist))
-    return alist;
-  alist = concat (1, &alist, Lisp_Cons, false);
-  for (Lisp_Object tem = alist; !NILP (tem); tem = XCDR (tem))
-    {
-      Lisp_Object car = XCAR (tem);
-      if (CONSP (car))
-	XSETCAR (tem, Fcons (XCAR (car), XCDR (car)));
-    }
-  return alist;
-}
-
 /* Check that ARRAY can have a valid subarray [FROM..TO),
    given that its size is SIZE.
    If FROM is nil, use 0; if TO is nil, use SIZE.
@@ -2912,7 +2891,6 @@ this variable.  */);
   defsubr (&Sstring_make_multibyte);
   defsubr (&Sstring_make_unibyte);
   defsubr (&Sstring_as_unibyte);
-  defsubr (&Scopy_alist);
   defsubr (&Ssubstring);
   defsubr (&Ssubstring_no_properties);
   defsubr (&Sdelete);
diff --git a/test/rust_src/src/fns-tests.el b/test/rust_src/src/fns-tests.el
index 934fe8b696..4444b33c08 100644
--- a/test/rust_src/src/fns-tests.el
+++ b/test/rust_src/src/fns-tests.el
@@ -48,6 +48,10 @@
   (should (floatp (car (load-average "asdf"))))
   (should (floatp (car (load-average '(gimme floats))))))
 
+(ert-deftest test-copy-alist ()
+  (let ((alist '(("foo" . "bar") ("foo" . "bar"))))
+    (should (equal alist (copy-alist alist)))))
+
 (ert-deftest test-reverse ()
   (should-error (reverse))
   (should-error (reverse 1))
-- 
2.21.0


From a8b202e0069e6d8582822ea4d22ec81730cb2584 Mon Sep 17 00:00:00 2001
From: Simon <mehakun1@gmail.com>
Date: Mon, 11 Feb 2019 16:48:59 +0300
Subject: [PATCH 279/297] Port window_next_sibling and window_prev_sibling
 (#1340)

Port window-next-sibling and window-prev-sibling
---
 rust_src/src/windows.rs | 18 ++++++++++++++++++
 src/window.c            | 20 --------------------
 2 files changed, 18 insertions(+), 20 deletions(-)

diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 328a42da23..6d66187be7 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -1252,6 +1252,24 @@ pub fn window_next_buffers(window: LispWindowLiveOrSelected) -> LispObject {
     win.next_buffers
 }
 
+/// Return the next sibling window of window WINDOW.
+/// WINDOW must be a valid window and defaults to the selected one.
+/// Return nil if WINDOW has no next sibling.
+#[lisp_fn(min = "0")]
+pub fn window_next_sibling(window: LispWindowValidOrSelected) -> Option<LispWindowRef> {
+    let win: LispWindowRef = window.into();
+    win.next.as_window()
+}
+
+/// Return the previous sibling window of window WINDOW.
+/// WINDOW must be a valid window and defaults to the selected one.
+/// Return nil if WINDOW has no previous sibling.
+#[lisp_fn(min = "0")]
+pub fn window_prev_sibling(window: LispWindowValidOrSelected) -> Option<LispWindowRef> {
+    let win: LispWindowRef = window.into();
+    win.prev.as_window()
+}
+
 /// Set WINDOW's next buffers to NEXT-BUFFERS.
 /// WINDOW must be a live window and defaults to the selected one.
 /// NEXT-BUFFERS should be a list of buffers.
diff --git a/src/window.c b/src/window.c
index e2540aaf40..2128d58f22 100644
--- a/src/window.c
+++ b/src/window.c
@@ -433,24 +433,6 @@ vertical combination.  */)
   return WINDOW_HORIZONTAL_COMBINATION_P (w) ? w->contents : Qnil;
 }
 
-DEFUN ("window-next-sibling", Fwindow_next_sibling, Swindow_next_sibling, 0, 1, 0,
-       doc: /* Return the next sibling window of window WINDOW.
-WINDOW must be a valid window and defaults to the selected one.
-Return nil if WINDOW has no next sibling.  */)
-  (Lisp_Object window)
-{
-  return decode_valid_window (window)->next;
-}
-
-DEFUN ("window-prev-sibling", Fwindow_prev_sibling, Swindow_prev_sibling, 0, 1, 0,
-       doc: /* Return the previous sibling window of window WINDOW.
-WINDOW must be a valid window and defaults to the selected one.
-Return nil if WINDOW has no previous sibling.  */)
-  (Lisp_Object window)
-{
-  return decode_valid_window (window)->prev;
-}
-
 DEFUN ("window-pixel-width-before-size-change",
        Fwindow_pixel_width_before_size_change,
        Swindow_pixel_width_before_size_change, 0, 1, 0,
@@ -6425,8 +6407,6 @@ displayed after a scrolling operation to be somewhat inaccurate.  */);
   defsubr (&Spos_visible_in_window_p);
   defsubr (&Swindow_line_height);
   defsubr (&Swindow_left_child);
-  defsubr (&Swindow_next_sibling);
-  defsubr (&Swindow_prev_sibling);
   defsubr (&Swindow_pixel_width_before_size_change);
   defsubr (&Swindow_pixel_height_before_size_change);
   defsubr (&Swindow_normal_size);
-- 
2.21.0


From 41e7a16ba7c08538e5c77ea9826e80d39966e4f8 Mon Sep 17 00:00:00 2001
From: Georgy Komarov <jubnzv@gmail.com>
Date: Mon, 11 Feb 2019 18:12:38 +0300
Subject: [PATCH 280/297] Port internal_default_interrupt_process (#1339)

---
 rust_src/src/process.rs | 39 +++++++++++++++++++++++++++++++++------
 src/process.c           | 27 ++++-----------------------
 src/process.h           |  3 +++
 3 files changed, 40 insertions(+), 29 deletions(-)

diff --git a/rust_src/src/process.rs b/rust_src/src/process.rs
index 69e89b4fee..a3d3d77262 100644
--- a/rust_src/src/process.rs
+++ b/rust_src/src/process.rs
@@ -10,15 +10,16 @@ use crate::{
     lists::{assoc, car, cdr, plist_put},
     multibyte::LispStringRef,
     remacs_sys::{
-        add_process_read_fd, current_thread, delete_read_fd, emacs_get_tty_pgrp,
-        list_system_processes, send_process, setup_process_coding_systems, update_status, Fmapcar,
-        STRING_BYTES,
+        add_process_read_fd, current_thread, delete_read_fd, emacs_get_tty_pgrp, list1,
+        list_system_processes, process_send_signal, send_process, setup_process_coding_systems,
+        update_status, Fmapcar, STRING_BYTES,
     },
     remacs_sys::{pvec_type, EmacsInt, Lisp_Process, Lisp_Type, Vprocess_alist},
     remacs_sys::{
-        QCbuffer, QCfilter, QCsentinel, Qcdr, Qclosed, Qexit, Qinternal_default_process_filter,
-        Qinternal_default_process_sentinel, Qinterrupt_process_functions, Qlisten, Qlistp,
-        Qnetwork, Qnil, Qopen, Qpipe, Qprocessp, Qreal, Qrun, Qserial, Qstop, Qt,
+        QCbuffer, QCfilter, QCsentinel, Qcdr, Qclosed, Qexit, Qinternal_default_interrupt_process,
+        Qinternal_default_process_filter, Qinternal_default_process_sentinel,
+        Qinterrupt_process_functions, Qlisten, Qlistp, Qnetwork, Qnil, Qopen, Qpipe, Qprocessp,
+        Qreal, Qrun, Qserial, Qstop, Qt,
     },
 };
 
@@ -539,4 +540,30 @@ pub fn interrupt_process(process: LispObject, current_group: LispObject) -> Lisp
 }
 def_lisp_sym!(Qinterrupt_process_functions, "interrupt-process-functions");
 
+/// Default function to interrupt process PROCESS.
+/// It shall be the last element in list `interrupt-process-functions'.
+/// See function `interrupt-process' for more details on usage.
+#[lisp_fn(min = "0")]
+pub fn internal_default_interrupt_process(
+    process: LispObject,
+    current_group: LispObject,
+) -> LispObject {
+    unsafe {
+        process_send_signal(process, libc::SIGINT, current_group, false);
+    }
+    process
+}
+#[rustfmt::skip]
+def_lisp_sym!(Qinternal_default_interrupt_process, "internal-default-interrupt-process");
+
+#[no_mangle]
+pub extern "C" fn rust_syms_of_process() {
+    /// List of functions to be called for `interrupt-process'.
+    /// The arguments of the functions are the same as for `interrupt-process'.
+    /// These functions are called in the order of the list, until one of them
+    /// returns non-`nil'.
+    #[rustfmt::skip]
+    defvar_lisp!(Vinterrupt_process_functions, "interrupt-process-functions", list1(Qinternal_default_interrupt_process));
+}
+
 include!(concat!(env!("OUT_DIR"), "/process_exports.rs"));
diff --git a/src/process.c b/src/process.c
index e20b06a85b..69cdce44e2 100644
--- a/src/process.c
+++ b/src/process.c
@@ -6145,7 +6145,7 @@ emacs_get_tty_pgrp (struct Lisp_Process *p)
    down the pty.  This allows us to signal inferiors who have changed
    their uid, for which kill would return an EPERM error.  */
 
-static void
+void
 process_send_signal (Lisp_Object process, int signo, Lisp_Object current_group,
 		     bool nomsg)
 {
@@ -6281,18 +6281,6 @@ process_send_signal (Lisp_Object process, int signo, Lisp_Object current_group,
   unblock_child_signal (&oldset);
 }
 
-DEFUN ("internal-default-interrupt-process",
-       Finternal_default_interrupt_process,
-       Sinternal_default_interrupt_process, 0, 2, 0,
-       doc: /* Default function to interrupt process PROCESS.
-It shall be the last element in list `interrupt-process-functions'.
-See function `interrupt-process' for more details on usage.  */)
-  (Lisp_Object process, Lisp_Object current_group)
-{
-  process_send_signal (process, SIGINT, current_group, 0);
-  return process;
-}
-
 DEFUN ("kill-process", Fkill_process, Skill_process, 0, 2, 0,
        doc: /* Kill process PROCESS.  May be process or name of one.
 See function `interrupt-process' for more details on usage.  */)
@@ -7342,6 +7330,8 @@ init_process_emacs (int sockfd)
   kbd_is_on_hold = 0;
 }
 
+extern void rust_syms_of_process(void);
+
 void
 syms_of_process (void)
 {
@@ -7475,19 +7465,11 @@ non-nil value means that the delay is not reset on write.
 The variable takes effect when `start-process' is called.  */);
   Vprocess_adaptive_read_buffering = Qt;
 
-  DEFVAR_LISP ("interrupt-process-functions", Vinterrupt_process_functions,
-	       doc: /* List of functions to be called for `interrupt-process'.
-The arguments of the functions are the same as for `interrupt-process'.
-These functions are called in the order of the list, until one of them
-returns non-`nil'.  */);
-  Vinterrupt_process_functions = list1 (Qinternal_default_interrupt_process);
-
   DEFVAR_LISP ("internal--daemon-sockname", Vinternal__daemon_sockname,
 	       doc: /* Name of external socket passed to Emacs, or nil if none.  */);
   Vinternal__daemon_sockname = Qnil;
 
-  DEFSYM (Qinternal_default_interrupt_process,
-	  "internal-default-interrupt-process");
+  rust_syms_of_process();
 
   defsubr (&Sdelete_process);
   defsubr (&Sset_process_thread);
@@ -7509,7 +7491,6 @@ returns non-`nil'.  */);
 #endif
   defsubr (&Saccept_process_output);
   defsubr (&Sprocess_send_region);
-  defsubr (&Sinternal_default_interrupt_process);
   defsubr (&Skill_process);
   defsubr (&Squit_process);
   defsubr (&Sstop_process);
diff --git a/src/process.h b/src/process.h
index e10682d982..271ee6aba4 100644
--- a/src/process.h
+++ b/src/process.h
@@ -311,6 +311,9 @@ update_status (struct Lisp_Process *p);
 void
 send_process (Lisp_Object proc, const char *buf, ptrdiff_t len,
 	      Lisp_Object object);
+void
+process_send_signal (Lisp_Object process, int signo, Lisp_Object current_group,
+		     bool nomsg);
 
 void pset_filter (struct Lisp_Process *, Lisp_Object);
 void pset_sentinel (struct Lisp_Process *, Lisp_Object);
-- 
2.21.0


From ad267c2a0c24a1d4ea8703a3f00dd99d5da88f91 Mon Sep 17 00:00:00 2001
From: Daichi Mukai <mukai.daichi.37e@kyoto-u.jp>
Date: Tue, 12 Feb 2019 23:44:34 +0900
Subject: [PATCH 281/297] Merge emacs Mojave support (#1338)

---
 src/nsterm.m | 865 ++++++++++++++++++++++++++-------------------------
 src/xdisp.c  |  15 +-
 2 files changed, 446 insertions(+), 434 deletions(-)

diff --git a/src/nsterm.m b/src/nsterm.m
index b171a37567..48c18ffe2f 100644
--- a/src/nsterm.m
+++ b/src/nsterm.m
@@ -278,13 +278,7 @@ - (NSColor *)colorUsingDefaultColorSpace
 long context_menu_value = 0;
 
 /* display update */
-static struct frame *ns_updating_frame;
-static NSView *focus_view = NULL;
 static int ns_window_num = 0;
-#ifdef NS_IMPL_GNUSTEP
-static NSRect uRect;            // TODO: This is dead, remove it?
-#endif
-static BOOL gsaved = NO;
 static BOOL ns_fake_keydown = NO;
 #ifdef NS_IMPL_COCOA
 static BOOL ns_menu_bar_is_hidden = NO;
@@ -856,6 +850,27 @@ Free a pool and temporary objects it refers to (callable from C)
 }
 
 
+static NSRect
+ns_row_rect (struct window *w, struct glyph_row *row,
+               enum glyph_row_area area)
+/* Get the row as an NSRect.  */
+{
+  struct frame *f = XFRAME (WINDOW_FRAME (w));
+  NSRect rect;
+  int window_x, window_y, window_width;
+
+  window_box (w, area, &window_x, &window_y, &window_width, 0);
+
+  rect.origin.x = window_x;
+  rect.origin.y = WINDOW_TO_FRAME_PIXEL_Y (w, max (0, row->y));
+  rect.origin.y = max (rect.origin.y, window_y);
+  rect.size.width = window_width;
+  rect.size.height = row->visible_height;
+
+  return rect;
+}
+
+
 /* ==========================================================================
 
     Focus (clipping) and screen update
@@ -1093,12 +1108,13 @@ static NSRect constrain_frame_rect(NSRect frameRect, bool isFullscreen)
    external (RIF) call; whole frame, called before update_window_begin
    -------------------------------------------------------------------------- */
 {
+#ifdef NS_IMPL_COCOA
   EmacsView *view = FRAME_NS_VIEW (f);
+
   NSTRACE_WHEN (NSTRACE_GROUP_UPDATES, "ns_update_begin");
 
   ns_update_auto_hide_menu_bar ();
 
-#ifdef NS_IMPL_COCOA
   if ([view isFullscreen] && [view fsIsNative])
   {
     // Fix reappearing tool bar in fullscreen for Mac OS X 10.7
@@ -1108,36 +1124,6 @@ static NSRect constrain_frame_rect(NSRect frameRect, bool isFullscreen)
       [toolbar setVisible: tbar_visible];
   }
 #endif
-
-  ns_updating_frame = f;
-  [view lockFocus];
-
-  /* drawRect may have been called for say the minibuffer, and then clip path
-     is for the minibuffer.  But the display engine may draw more because
-     we have set the frame as garbaged.  So reset clip path to the whole
-     view.  */
-#ifdef NS_IMPL_COCOA
-  {
-    NSBezierPath *bp;
-    NSRect r = [view frame];
-    NSRect cr = [[view window] frame];
-    /* If a large frame size is set, r may be larger than the window frame
-       before constrained.  In that case don't change the clip path, as we
-       will clear in to the tool bar and title bar.  */
-    if (r.size.height
-        + FRAME_NS_TITLEBAR_HEIGHT (f)
-        + FRAME_TOOLBAR_HEIGHT (f) <= cr.size.height)
-      {
-        bp = [[NSBezierPath bezierPathWithRect: r] retain];
-        [bp setClip];
-        [bp release];
-      }
-  }
-#endif
-
-#ifdef NS_IMPL_GNUSTEP
-  uRect = NSMakeRect (0, 0, 0, 0);
-#endif
 }
 
 
@@ -1218,118 +1204,57 @@ static NSRect constrain_frame_rect(NSRect frameRect, bool isFullscreen)
    external (RIF) call; for whole frame, called after update_window_end
    -------------------------------------------------------------------------- */
 {
-  EmacsView *view = FRAME_NS_VIEW (f);
-
   NSTRACE_WHEN (NSTRACE_GROUP_UPDATES, "ns_update_end");
 
 /*   if (f == MOUSE_HL_INFO (f)->mouse_face_mouse_frame) */
   MOUSE_HL_INFO (f)->mouse_face_defer = 0;
-
-  block_input ();
-
-  [view unlockFocus];
-  [[view window] flushWindow];
-
-  unblock_input ();
-  ns_updating_frame = NULL;
 }
 
-static void
-ns_focus (struct frame *f, NSRect *r, int n)
+
+static BOOL
+ns_clip_to_rect (struct frame *f, NSRect *r, int n)
 /* --------------------------------------------------------------------------
-   Internal: Focus on given frame.  During small local updates this is used to
-     draw, however during large updates, ns_update_begin and ns_update_end are
-     called to wrap the whole thing, in which case these calls are stubbed out.
-     Except, on GNUstep, we accumulate the rectangle being drawn into, because
-     the back end won't do this automatically, and will just end up flushing
-     the entire window.
+   Clip the drawing area to rectangle r in frame f.  If drawing is not
+   currently possible mark r as dirty and return NO, otherwise return
+   YES.
    -------------------------------------------------------------------------- */
 {
-  NSTRACE_WHEN (NSTRACE_GROUP_FOCUS, "ns_focus");
-  if (r != NULL)
+  NSTRACE_WHEN (NSTRACE_GROUP_FOCUS, "ns_clip_to_rect");
+  if (r)
     {
       NSTRACE_RECT ("r", *r);
-    }
 
-  if (f != ns_updating_frame)
-    {
-      NSView *view = FRAME_NS_VIEW (f);
-      if (view != focus_view)
+      if ([NSView focusView] == FRAME_NS_VIEW (f))
         {
-          if (focus_view != NULL)
-            {
-              [focus_view unlockFocus];
-              [[focus_view window] flushWindow];
-/*debug_lock--; */
-            }
+          [[NSGraphicsContext currentContext] saveGraphicsState];
+          if (n == 2)
+            NSRectClipList (r, 2);
+          else
+            NSRectClip (*r);
 
-          if (view)
-            [view lockFocus];
-          focus_view = view;
-/*if (view) debug_lock++; */
+          return YES;
         }
-    }
-
-  /* clipping */
-  if (r)
-    {
-      [[NSGraphicsContext currentContext] saveGraphicsState];
-      if (n == 2)
-        NSRectClipList (r, 2);
       else
-        NSRectClip (*r);
-      gsaved = YES;
-    }
-}
-
-
-static void
-ns_unfocus (struct frame *f)
-/* --------------------------------------------------------------------------
-     Internal: Remove focus on given frame
-   -------------------------------------------------------------------------- */
-{
-  NSTRACE_WHEN (NSTRACE_GROUP_FOCUS, "ns_unfocus");
-
-  if (gsaved)
-    {
-      [[NSGraphicsContext currentContext] restoreGraphicsState];
-      gsaved = NO;
-    }
-
-  if (f != ns_updating_frame)
-    {
-      if (focus_view != NULL)
         {
-          [focus_view unlockFocus];
-          [[focus_view window] flushWindow];
-          focus_view = NULL;
-/*debug_lock--; */
+          NSView *view = FRAME_NS_VIEW (f);
+          int i;
+          for (i = 0 ; i < n ; i++)
+            [view setNeedsDisplayInRect:r[i]];
         }
     }
+
+  return NO;
 }
 
 
 static void
-ns_clip_to_row (struct window *w, struct glyph_row *row,
-		enum glyph_row_area area, BOOL gc)
-/* --------------------------------------------------------------------------
-     Internal (but parallels other terms): Focus drawing on given row
-   -------------------------------------------------------------------------- */
+ns_reset_clipping (struct frame *f)
+/* Internal: Restore the previous graphics state, unsetting any
+   clipping areas.  */
 {
-  struct frame *f = XFRAME (WINDOW_FRAME (w));
-  NSRect clip_rect;
-  int window_x, window_y, window_width;
-
-  window_box (w, area, &window_x, &window_y, &window_width, 0);
+  NSTRACE_WHEN (NSTRACE_GROUP_FOCUS, "ns_reset_clipping");
 
-  clip_rect.origin.x = window_x;
-  clip_rect.origin.y = WINDOW_TO_FRAME_PIXEL_Y (w, max (0, row->y));
-  clip_rect.origin.y = max (clip_rect.origin.y, window_y);
-  clip_rect.size.width = window_width;
-  clip_rect.size.height = row->visible_height;
-
-  ns_focus (f, &clip_rect, 1);
+  [[NSGraphicsContext currentContext] restoreGraphicsState];
 }
 
 
@@ -2797,14 +2722,16 @@ so some key presses (TAB) are swallowed by the system. */
   r = [view bounds];
 
   block_input ();
-  ns_focus (f, &r, 1);
-  [ns_lookup_indexed_color (NS_FACE_BACKGROUND
-			    (FACE_FROM_ID (f, DEFAULT_FACE_ID)), f) set];
-  NSRectFill (r);
-  ns_unfocus (f);
-
-  /* as of 2006/11 or so this is now needed */
-  ns_redraw_scroll_bars (f);
+  if (ns_clip_to_rect (f, &r, 1))
+    {
+      [ns_lookup_indexed_color (NS_FACE_BACKGROUND
+                                (FACE_FROM_ID (f, DEFAULT_FACE_ID)), f) set];
+      NSRectFill (r);
+      ns_reset_clipping (f);
+
+      /* as of 2006/11 or so this is now needed */
+      ns_redraw_scroll_bars (f);
+    }
   unblock_input ();
 }
 
@@ -2825,29 +2752,44 @@ so some key presses (TAB) are swallowed by the system. */
   NSTRACE_WHEN (NSTRACE_GROUP_UPDATES, "ns_clear_frame_area");
 
   r = NSIntersectionRect (r, [view frame]);
-  ns_focus (f, &r, 1);
-  [ns_lookup_indexed_color (NS_FACE_BACKGROUND (face), f) set];
+  if (ns_clip_to_rect (f, &r, 1))
+    {
+      [ns_lookup_indexed_color (NS_FACE_BACKGROUND (face), f) set];
 
-  NSRectFill (r);
+      NSRectFill (r);
 
-  ns_unfocus (f);
-  return;
+      ns_reset_clipping (f);
+    }
 }
 
 static void
 ns_copy_bits (struct frame *f, NSRect src, NSRect dest)
 {
+  NSSize delta = NSMakeSize (dest.origin.x - src.origin.x,
+                             dest.origin.y - src.origin.y);
   NSTRACE ("ns_copy_bits");
 
   if (FRAME_NS_VIEW (f))
     {
       hide_bell();              // Ensure the bell image isn't scrolled.
 
-      ns_focus (f, &dest, 1);
-      [FRAME_NS_VIEW (f) scrollRect: src
-                                 by: NSMakeSize (dest.origin.x - src.origin.x,
-                                                 dest.origin.y - src.origin.y)];
-      ns_unfocus (f);
+      /* FIXME: scrollRect:by: is deprecated in macOS 10.14.  There is
+         no obvious replacement so we may have to come up with our own.  */
+      [FRAME_NS_VIEW (f) scrollRect: src by: delta];
+
+#ifdef NS_IMPL_COCOA
+      /* As far as I can tell from the documentation, scrollRect:by:,
+         above, should copy the dirty rectangles from our source
+         rectangle to our destination, however it appears it clips the
+         operation to src.  As a result we need to use
+         translateRectsNeedingDisplayInRect:by: below, and we have to
+         union src and dest so it can pick up the dirty rectangles,
+         and place them, as it also clips to the rectangle.
+
+         FIXME: We need a GNUstep equivalent.  */
+      [FRAME_NS_VIEW (f) translateRectsNeedingDisplayInRect:NSUnionRect (src, dest)
+                                                         by:delta];
+#endif
     }
 }
 
@@ -2957,12 +2899,20 @@ so some key presses (TAB) are swallowed by the system. */
     External (RIF): copy an area horizontally, don't worry about clearing src
    -------------------------------------------------------------------------- */
 {
-  NSRect srcRect = NSMakeRect (x, y, width, height);
+  //NSRect srcRect = NSMakeRect (x, y, width, height);
   NSRect dstRect = NSMakeRect (x+shift_by, y, width, height);
 
   NSTRACE ("ns_shift_glyphs_for_insert");
 
-  ns_copy_bits (f, srcRect, dstRect);
+  /* This doesn't work now as we copy the "bits" before we've had a
+     chance to actually draw any changes to the screen.  This means in
+     certain circumstances we end up with copies of the cursor all
+     over the place.  Just mark the area dirty so it is redrawn later.
+
+     FIXME: Work out how to do this properly.  */
+  // ns_copy_bits (f, srcRect, dstRect);
+
+  [FRAME_NS_VIEW (f) setNeedsDisplayInRect:dstRect];
 }
 
 
@@ -3043,6 +2993,9 @@ so some key presses (TAB) are swallowed by the system. */
   struct face *face = p->face;
   static EmacsImage **bimgs = NULL;
   static int nBimgs = 0;
+  NSRect clearRect = NSZeroRect;
+  NSRect imageRect = NSZeroRect;
+  NSRect rowRect = ns_row_rect (w, row, ANY_AREA);
 
   NSTRACE_WHEN (NSTRACE_GROUP_FRINGE, "ns_draw_fringe_bitmap");
   NSTRACE_MSG ("which:%d cursor:%d overlay:%d width:%d height:%d period:%d",
@@ -3057,86 +3010,95 @@ so some key presses (TAB) are swallowed by the system. */
       nBimgs = max_used_fringe_bitmap;
     }
 
-  /* Must clip because of partially visible lines.  */
-  ns_clip_to_row (w, row, ANY_AREA, YES);
+  /* Work out the rectangle we will composite into.  */
+  if (p->which)
+    imageRect = NSMakeRect (p->x, p->y, p->wd, p->h);
 
+  /* Work out the rectangle we will need to clear.  Because we're
+     compositing rather than blitting, we need to clear the area under
+     the image regardless of anything else.  */
   if (!p->overlay_p)
     {
-      int bx = p->bx, by = p->by, nx = p->nx, ny = p->ny;
-
-      if (bx >= 0 && nx > 0)
-        {
-          NSRect r = NSMakeRect (bx, by, nx, ny);
-          NSRectClip (r);
-          [ns_lookup_indexed_color (face->background, f) set];
-          NSRectFill (r);
-        }
+      clearRect = NSMakeRect (p->bx, p->by, p->nx, p->ny);
+      clearRect = NSUnionRect (clearRect, imageRect);
     }
-
-  if (p->which)
+  else
     {
-      NSRect r = NSMakeRect (p->x, p->y, p->wd, p->h);
-      EmacsImage *img = bimgs[p->which - 1];
+      clearRect = imageRect;
+    }
+
+  /* Handle partially visible rows.  */
+  clearRect = NSIntersectionRect (clearRect, rowRect);
 
-      if (!img)
+  /* The visible portion of imageRect will always be contained within
+     clearRect.  */
+  if (ns_clip_to_rect (f, &clearRect, 1))
+    {
+      if (! NSIsEmptyRect (clearRect))
         {
-          // Note: For "periodic" images, allocate one EmacsImage for
-          // the base image, and use it for all dh:s.
-          unsigned short *bits = p->bits;
-          int full_height = p->h + p->dh;
-          int i;
-          unsigned char *cbits = xmalloc (full_height);
-
-          for (i = 0; i < full_height; i++)
-            cbits[i] = bits[i];
-          img = [[EmacsImage alloc] initFromXBM: cbits width: 8
-                                         height: full_height
-                                             fg: 0 bg: 0];
-          bimgs[p->which - 1] = img;
-          xfree (cbits);
-        }
+          NSTRACE_RECT ("clearRect", clearRect);
 
-      NSTRACE_RECT ("r", r);
+          [ns_lookup_indexed_color(face->background, f) set];
+          NSRectFill (clearRect);
+        }
 
-      NSRectClip (r);
-      /* Since we composite the bitmap instead of just blitting it, we need
-         to erase the whole background. */
-      [ns_lookup_indexed_color(face->background, f) set];
-      NSRectFill (r);
+      if (p->which)
+        {
+          EmacsImage *img = bimgs[p->which - 1];
 
-      {
-        NSColor *bm_color;
-        if (!p->cursor_p)
-          bm_color = ns_lookup_indexed_color(face->foreground, f);
-        else if (p->overlay_p)
-          bm_color = ns_lookup_indexed_color(face->background, f);
-        else
-          bm_color = f->output_data.ns->cursor_color;
-        [img setXBMColor: bm_color];
-      }
+          if (!img)
+            {
+              // Note: For "periodic" images, allocate one EmacsImage for
+              // the base image, and use it for all dh:s.
+              unsigned short *bits = p->bits;
+              int full_height = p->h + p->dh;
+              int i;
+              unsigned char *cbits = xmalloc (full_height);
+
+              for (i = 0; i < full_height; i++)
+                cbits[i] = bits[i];
+              img = [[EmacsImage alloc] initFromXBM: cbits width: 8
+                                             height: full_height
+                                                 fg: 0 bg: 0];
+              bimgs[p->which - 1] = img;
+              xfree (cbits);
+            }
 
-#ifdef NS_IMPL_COCOA
-      // Note: For periodic images, the full image height is "h + hd".
-      // By using the height h, a suitable part of the image is used.
-      NSRect fromRect = NSMakeRect(0, 0, p->wd, p->h);
 
-      NSTRACE_RECT ("fromRect", fromRect);
+          {
+            NSColor *bm_color;
+            if (!p->cursor_p)
+              bm_color = ns_lookup_indexed_color(face->foreground, f);
+            else if (p->overlay_p)
+              bm_color = ns_lookup_indexed_color(face->background, f);
+            else
+              bm_color = f->output_data.ns->cursor_color;
+            [img setXBMColor: bm_color];
+          }
 
-      [img drawInRect: r
-              fromRect: fromRect
-             operation: NSCompositingOperationSourceOver
-              fraction: 1.0
-           respectFlipped: YES
-                hints: nil];
+#ifdef NS_IMPL_COCOA
+          // Note: For periodic images, the full image height is "h + hd".
+          // By using the height h, a suitable part of the image is used.
+          NSRect fromRect = NSMakeRect(0, 0, p->wd, p->h);
+
+          NSTRACE_RECT ("fromRect", fromRect);
+
+          [img drawInRect: imageRect
+                 fromRect: fromRect
+                operation: NSCompositingOperationSourceOver
+                 fraction: 1.0
+               respectFlipped: YES
+                    hints: nil];
 #else
-      {
-        NSPoint pt = r.origin;
-        pt.y += p->h;
-        [img compositeToPoint: pt operation: NSCompositingOperationSourceOver];
-      }
+          {
+            NSPoint pt = imageRect.origin;
+            pt.y += p->h;
+            [img compositeToPoint: pt operation: NSCompositingOperationSourceOver];
+          }
 #endif
+        }
+      ns_reset_clipping (f);
     }
-  ns_unfocus (f);
 }
 
 
@@ -3218,67 +3180,62 @@ Note that CURSOR_WIDTH is meaningful only for (h)bar cursors.
   r.size.height = h;
   r.size.width = w->phys_cursor_width;
 
-  /* Prevent the cursor from being drawn outside the text area. */
-  ns_clip_to_row (w, glyph_row, TEXT_AREA, NO); /* do ns_focus(f, &r, 1); if remove */
+  /* Prevent the cursor from being drawn outside the text area.  */
+  r = NSIntersectionRect (r, ns_row_rect (w, glyph_row, TEXT_AREA));
 
-
-  face = FACE_FROM_ID_OR_NULL (f, phys_cursor_glyph->face_id);
-  if (face && NS_FACE_BACKGROUND (face)
-      == ns_index_color (FRAME_CURSOR_COLOR (f), f))
+  if (ns_clip_to_rect (f, &r, 1))
     {
-      [ns_lookup_indexed_color (NS_FACE_FOREGROUND (face), f) set];
-      hollow_color = FRAME_CURSOR_COLOR (f);
-    }
-  else
-    [FRAME_CURSOR_COLOR (f) set];
+      face = FACE_FROM_ID_OR_NULL (f, phys_cursor_glyph->face_id);
+      if (face && NS_FACE_BACKGROUND (face)
+          == ns_index_color (FRAME_CURSOR_COLOR (f), f))
+        {
+          [ns_lookup_indexed_color (NS_FACE_FOREGROUND (face), f) set];
+          hollow_color = FRAME_CURSOR_COLOR (f);
+        }
+      else
+        [FRAME_CURSOR_COLOR (f) set];
 
-#ifdef NS_IMPL_COCOA
-  /* TODO: This makes drawing of cursor plus that of phys_cursor_glyph
-           atomic.  Cleaner ways of doing this should be investigated.
-           One way would be to set a global variable DRAWING_CURSOR
-  	   when making the call to draw_phys..(), don't focus in that
-  	   case, then move the ns_unfocus() here after that call. */
-  NSDisableScreenUpdates ();
-#endif
+      switch (cursor_type)
+        {
+        case DEFAULT_CURSOR:
+        case NO_CURSOR:
+          break;
+        case FILLED_BOX_CURSOR:
+          NSRectFill (r);
+          break;
+        case HOLLOW_BOX_CURSOR:
+          NSRectFill (r);
+          [hollow_color set];
+          NSRectFill (NSInsetRect (r, 1, 1));
+          [FRAME_CURSOR_COLOR (f) set];
+          break;
+        case HBAR_CURSOR:
+          NSRectFill (r);
+          break;
+        case BAR_CURSOR:
+          s = r;
+          /* If the character under cursor is R2L, draw the bar cursor
+             on the right of its glyph, rather than on the left.  */
+          cursor_glyph = get_phys_cursor_glyph (w);
+          if ((cursor_glyph->resolved_level & 1) != 0)
+            s.origin.x += cursor_glyph->pixel_width - s.size.width;
+
+          NSRectFill (s);
+          break;
+        }
 
-  switch (cursor_type)
-    {
-    case DEFAULT_CURSOR:
-    case NO_CURSOR:
-      break;
-    case FILLED_BOX_CURSOR:
-      NSRectFill (r);
-      break;
-    case HOLLOW_BOX_CURSOR:
-      NSRectFill (r);
-      [hollow_color set];
-      NSRectFill (NSInsetRect (r, 1, 1));
-      [FRAME_CURSOR_COLOR (f) set];
-      break;
-    case HBAR_CURSOR:
-      NSRectFill (r);
-      break;
-    case BAR_CURSOR:
-      s = r;
-      /* If the character under cursor is R2L, draw the bar cursor
-         on the right of its glyph, rather than on the left.  */
-      cursor_glyph = get_phys_cursor_glyph (w);
-      if ((cursor_glyph->resolved_level & 1) != 0)
-        s.origin.x += cursor_glyph->pixel_width - s.size.width;
+      /* draw the character under the cursor */
+      if (cursor_type != NO_CURSOR)
+        draw_phys_cursor_glyph (w, glyph_row, DRAW_CURSOR);
 
-      NSRectFill (s);
-      break;
+      ns_reset_clipping (f);
+    }
+  else if (! redisplaying_p)
+    {
+      /* If this function is called outside redisplay, it probably
+         means we need an immediate update.  */
+      [FRAME_NS_VIEW (f) display];
     }
-  ns_unfocus (f);
-
-  /* draw the character under the cursor */
-  if (cursor_type != NO_CURSOR)
-    draw_phys_cursor_glyph (w, glyph_row, DRAW_CURSOR);
-
-#ifdef NS_IMPL_COCOA
-  NSEnableScreenUpdates ();
-#endif
-
 }
 
 
@@ -3296,12 +3253,14 @@ Note that CURSOR_WIDTH is meaningful only for (h)bar cursors.
 
   face = FACE_FROM_ID_OR_NULL (f, VERTICAL_BORDER_FACE_ID);
 
-  ns_focus (f, &r, 1);
-  if (face)
-    [ns_lookup_indexed_color(face->foreground, f) set];
+  if (ns_clip_to_rect (f, &r, 1))
+    {
+      if (face)
+        [ns_lookup_indexed_color(face->foreground, f) set];
 
-  NSRectFill(r);
-  ns_unfocus (f);
+      NSRectFill(r);
+      ns_reset_clipping (f);
+    }
 }
 
 
@@ -3328,39 +3287,40 @@ Note that CURSOR_WIDTH is meaningful only for (h)bar cursors.
 
   NSTRACE ("ns_draw_window_divider");
 
-  ns_focus (f, &divider, 1);
-
-  if ((y1 - y0 > x1 - x0) && (x1 - x0 >= 3))
-    /* A vertical divider, at least three pixels wide: Draw first and
-       last pixels differently.  */
-    {
-      [ns_lookup_indexed_color(color_first, f) set];
-      NSRectFill(NSMakeRect (x0, y0, 1, y1 - y0));
-      [ns_lookup_indexed_color(color, f) set];
-      NSRectFill(NSMakeRect (x0 + 1, y0, x1 - x0 - 2, y1 - y0));
-      [ns_lookup_indexed_color(color_last, f) set];
-      NSRectFill(NSMakeRect (x1 - 1, y0, 1, y1 - y0));
-    }
-  else if ((x1 - x0 > y1 - y0) && (y1 - y0 >= 3))
-    /* A horizontal divider, at least three pixels high: Draw first and
-       last pixels differently.  */
-    {
-      [ns_lookup_indexed_color(color_first, f) set];
-      NSRectFill(NSMakeRect (x0, y0, x1 - x0, 1));
-      [ns_lookup_indexed_color(color, f) set];
-      NSRectFill(NSMakeRect (x0, y0 + 1, x1 - x0, y1 - y0 - 2));
-      [ns_lookup_indexed_color(color_last, f) set];
-      NSRectFill(NSMakeRect (x0, y1 - 1, x1 - x0, 1));
-    }
-  else
+  if (ns_clip_to_rect (f, &divider, 1))
     {
-      /* In any other case do not draw the first and last pixels
-         differently.  */
-      [ns_lookup_indexed_color(color, f) set];
-      NSRectFill(divider);
-    }
+      if ((y1 - y0 > x1 - x0) && (x1 - x0 >= 3))
+        /* A vertical divider, at least three pixels wide: Draw first and
+           last pixels differently.  */
+        {
+          [ns_lookup_indexed_color(color_first, f) set];
+          NSRectFill(NSMakeRect (x0, y0, 1, y1 - y0));
+          [ns_lookup_indexed_color(color, f) set];
+          NSRectFill(NSMakeRect (x0 + 1, y0, x1 - x0 - 2, y1 - y0));
+          [ns_lookup_indexed_color(color_last, f) set];
+          NSRectFill(NSMakeRect (x1 - 1, y0, 1, y1 - y0));
+        }
+      else if ((x1 - x0 > y1 - y0) && (y1 - y0 >= 3))
+        /* A horizontal divider, at least three pixels high: Draw first and
+           last pixels differently.  */
+        {
+          [ns_lookup_indexed_color(color_first, f) set];
+          NSRectFill(NSMakeRect (x0, y0, x1 - x0, 1));
+          [ns_lookup_indexed_color(color, f) set];
+          NSRectFill(NSMakeRect (x0, y0 + 1, x1 - x0, y1 - y0 - 2));
+          [ns_lookup_indexed_color(color_last, f) set];
+          NSRectFill(NSMakeRect (x0, y1 - 1, x1 - x0, 1));
+        }
+      else
+        {
+          /* In any other case do not draw the first and last pixels
+             differently.  */
+          [ns_lookup_indexed_color(color, f) set];
+          NSRectFill(divider);
+        }
 
-  ns_unfocus (f);
+      ns_reset_clipping (f);
+    }
 }
 
 static void
@@ -3959,83 +3919,84 @@ Function modeled after x_draw_glyph_string_box ().
       n = ns_get_glyph_string_clip_rect (s, r);
       *r = NSMakeRect (s->x, s->y, s->background_width, s->height);
 
-      ns_focus (s->f, r, n);
-
-      if (s->hl == DRAW_MOUSE_FACE)
-       {
-         face = FACE_FROM_ID_OR_NULL (s->f,
-				      MOUSE_HL_INFO (s->f)->mouse_face_face_id);
-         if (!face)
-           face = FACE_FROM_ID (s->f, MOUSE_FACE_ID);
-       }
-      else
-       face = FACE_FROM_ID (s->f, s->first_glyph->face_id);
-
-      bgCol = ns_lookup_indexed_color (NS_FACE_BACKGROUND (face), s->f);
-      fgCol = ns_lookup_indexed_color (NS_FACE_FOREGROUND (face), s->f);
-
-      for (i = 0; i < n; ++i)
+      if (ns_clip_to_rect (s->f, r, n))
         {
-          if (!s->row->full_width_p)
+          if (s->hl == DRAW_MOUSE_FACE)
             {
-	      int overrun, leftoverrun;
-
-              /* truncate to avoid overwriting fringe and/or scrollbar */
-	      overrun = max (0, (s->x + s->background_width)
-			     - (WINDOW_BOX_RIGHT_EDGE_X (s->w)
-				- WINDOW_RIGHT_FRINGE_WIDTH (s->w)));
-              r[i].size.width -= overrun;
-
-	      /* truncate to avoid overwriting to left of the window box */
-	      leftoverrun = (WINDOW_BOX_LEFT_EDGE_X (s->w)
-			     + WINDOW_LEFT_FRINGE_WIDTH (s->w)) - s->x;
-
-	      if (leftoverrun > 0)
-		{
-		  r[i].origin.x += leftoverrun;
-		  r[i].size.width -= leftoverrun;
-		}
-
-              /* XXX: Try to work between problem where a stretch glyph on
-                 a partially-visible bottom row will clear part of the
-                 modeline, and another where list-buffers headers and similar
-                 rows erroneously have visible_height set to 0.  Not sure
-                 where this is coming from as other terms seem not to show. */
-              r[i].size.height = min (s->height, s->row->visible_height);
+              face = FACE_FROM_ID_OR_NULL (s->f,
+                                           MOUSE_HL_INFO (s->f)->mouse_face_face_id);
+              if (!face)
+                face = FACE_FROM_ID (s->f, MOUSE_FACE_ID);
             }
+          else
+            face = FACE_FROM_ID (s->f, s->first_glyph->face_id);
 
-          [bgCol set];
+          bgCol = ns_lookup_indexed_color (NS_FACE_BACKGROUND (face), s->f);
+          fgCol = ns_lookup_indexed_color (NS_FACE_FOREGROUND (face), s->f);
 
-          /* NOTE: under NS this is NOT used to draw cursors, but we must avoid
-             overwriting cursor (usually when cursor on a tab) */
-          if (s->hl == DRAW_CURSOR)
+          for (i = 0; i < n; ++i)
             {
-              CGFloat x, width;
+              if (!s->row->full_width_p)
+                {
+                  int overrun, leftoverrun;
+
+                  /* truncate to avoid overwriting fringe and/or scrollbar */
+                  overrun = max (0, (s->x + s->background_width)
+                                 - (WINDOW_BOX_RIGHT_EDGE_X (s->w)
+                                    - WINDOW_RIGHT_FRINGE_WIDTH (s->w)));
+                  r[i].size.width -= overrun;
+
+                  /* truncate to avoid overwriting to left of the window box */
+                  leftoverrun = (WINDOW_BOX_LEFT_EDGE_X (s->w)
+                                 + WINDOW_LEFT_FRINGE_WIDTH (s->w)) - s->x;
+
+                    if (leftoverrun > 0)
+                      {
+                        r[i].origin.x += leftoverrun;
+                        r[i].size.width -= leftoverrun;
+                      }
+
+                    /* XXX: Try to work between problem where a stretch glyph on
+                       a partially-visible bottom row will clear part of the
+                       modeline, and another where list-buffers headers and similar
+                       rows erroneously have visible_height set to 0.  Not sure
+                       where this is coming from as other terms seem not to show.  */
+                    r[i].size.height = min (s->height, s->row->visible_height);
+                }
+
+              [bgCol set];
+
+              /* NOTE: under NS this is NOT used to draw cursors, but we must avoid
+                 overwriting cursor (usually when cursor on a tab).  */
+              if (s->hl == DRAW_CURSOR)
+                {
+                  CGFloat x, width;
 
-              x = r[i].origin.x;
-              width = s->w->phys_cursor_width;
-              r[i].size.width -= width;
-              r[i].origin.x += width;
+                  x = r[i].origin.x;
+                  width = s->w->phys_cursor_width;
+                  r[i].size.width -= width;
+                  r[i].origin.x += width;
 
-              NSRectFill (r[i]);
+                  NSRectFill (r[i]);
 
-              /* Draw overlining, etc. on the cursor. */
-              if (s->w->phys_cursor_type == FILLED_BOX_CURSOR)
-                ns_draw_text_decoration (s, face, bgCol, width, x);
+                  /* Draw overlining, etc. on the cursor.  */
+                  if (s->w->phys_cursor_type == FILLED_BOX_CURSOR)
+                    ns_draw_text_decoration (s, face, bgCol, width, x);
+                  else
+                    ns_draw_text_decoration (s, face, fgCol, width, x);
+                }
               else
-                ns_draw_text_decoration (s, face, fgCol, width, x);
-            }
-          else
-            {
-              NSRectFill (r[i]);
-            }
+                {
+                  NSRectFill (r[i]);
+                }
 
-          /* Draw overlining, etc. on the stretch glyph (or the part
-             of the stretch glyph after the cursor). */
-          ns_draw_text_decoration (s, face, fgCol, r[i].size.width,
-                                   r[i].origin.x);
+              /* Draw overlining, etc. on the stretch glyph (or the part
+                 of the stretch glyph after the cursor).  */
+              ns_draw_text_decoration (s, face, fgCol, r[i].size.width,
+                                       r[i].origin.x);
+            }
+          ns_reset_clipping (s->f);
         }
-      ns_unfocus (s->f);
       s->background_filled_p = 1;
     }
 }
@@ -4185,9 +4146,11 @@ overwriting cursor (usually when cursor on a tab) */
             if (next->first_glyph->type != STRETCH_GLYPH)
               {
                 n = ns_get_glyph_string_clip_rect (s->next, r);
-                ns_focus (s->f, r, n);
-                ns_maybe_dumpglyphs_background (s->next, 1);
-                ns_unfocus (s->f);
+                if (ns_clip_to_rect (s->f, r, n))
+                  {
+                    ns_maybe_dumpglyphs_background (s->next, 1);
+                    ns_reset_clipping (s->f);
+                  }
               }
             else
               {
@@ -4202,10 +4165,12 @@ overwriting cursor (usually when cursor on a tab) */
 	    || s->first_glyph->type == COMPOSITE_GLYPH))
     {
       n = ns_get_glyph_string_clip_rect (s, r);
-      ns_focus (s->f, r, n);
-      ns_maybe_dumpglyphs_background (s, 1);
-      ns_dumpglyphs_box_or_relief (s);
-      ns_unfocus (s->f);
+      if (ns_clip_to_rect (s->f, r, n))
+        {
+          ns_maybe_dumpglyphs_background (s, 1);
+          ns_dumpglyphs_box_or_relief (s);
+          ns_reset_clipping (s->f);
+        }
       box_drawn_p = 1;
     }
 
@@ -4214,9 +4179,11 @@ overwriting cursor (usually when cursor on a tab) */
 
     case IMAGE_GLYPH:
       n = ns_get_glyph_string_clip_rect (s, r);
-      ns_focus (s->f, r, n);
-      ns_dumpglyphs_image (s, r[0]);
-      ns_unfocus (s->f);
+      if (ns_clip_to_rect (s->f, r, n))
+        {
+          ns_dumpglyphs_image (s, r[0]);
+          ns_reset_clipping (s->f);
+        }
       break;
 
     case STRETCH_GLYPH:
@@ -4226,66 +4193,68 @@ overwriting cursor (usually when cursor on a tab) */
     case CHAR_GLYPH:
     case COMPOSITE_GLYPH:
       n = ns_get_glyph_string_clip_rect (s, r);
-      ns_focus (s->f, r, n);
+      if (ns_clip_to_rect (s->f, r, n))
+        {
+          if (s->for_overlaps || (s->cmp_from > 0
+                                  && ! s->first_glyph->u.cmp.automatic))
+            s->background_filled_p = 1;
+          else
+            ns_maybe_dumpglyphs_background
+              (s, s->first_glyph->type == COMPOSITE_GLYPH);
 
-      if (s->for_overlaps || (s->cmp_from > 0
-			      && ! s->first_glyph->u.cmp.automatic))
-        s->background_filled_p = 1;
-      else
-        ns_maybe_dumpglyphs_background
-          (s, s->first_glyph->type == COMPOSITE_GLYPH);
+          if (s->hl == DRAW_CURSOR && s->w->phys_cursor_type == FILLED_BOX_CURSOR)
+            {
+              unsigned long tmp = NS_FACE_BACKGROUND (s->face);
+              NS_FACE_BACKGROUND (s->face) = NS_FACE_FOREGROUND (s->face);
+              NS_FACE_FOREGROUND (s->face) = tmp;
+            }
 
-      if (s->hl == DRAW_CURSOR && s->w->phys_cursor_type == FILLED_BOX_CURSOR)
-        {
-          unsigned long tmp = NS_FACE_BACKGROUND (s->face);
-          NS_FACE_BACKGROUND (s->face) = NS_FACE_FOREGROUND (s->face);
-          NS_FACE_FOREGROUND (s->face) = tmp;
-        }
+          {
+            BOOL isComposite = s->first_glyph->type == COMPOSITE_GLYPH;
 
-      {
-        BOOL isComposite = s->first_glyph->type == COMPOSITE_GLYPH;
+            if (isComposite)
+              ns_draw_composite_glyph_string_foreground (s);
+            else
+              ns_draw_glyph_string_foreground (s);
+          }
 
-        if (isComposite)
-          ns_draw_composite_glyph_string_foreground (s);
-        else
-          ns_draw_glyph_string_foreground (s);
-      }
+          {
+            NSColor *col = (NS_FACE_FOREGROUND (s->face) != 0
+                            ? ns_lookup_indexed_color (NS_FACE_FOREGROUND (s->face),
+                                                       s->f)
+                            : FRAME_FOREGROUND_COLOR (s->f));
+            [col set];
+
+            /* Draw underline, overline, strike-through.  */
+            ns_draw_text_decoration (s, s->face, col, s->width, s->x);
+          }
 
-      {
-        NSColor *col = (NS_FACE_FOREGROUND (s->face) != 0
-                        ? ns_lookup_indexed_color (NS_FACE_FOREGROUND (s->face),
-                                                   s->f)
-                        : FRAME_FOREGROUND_COLOR (s->f));
-        [col set];
-
-        /* Draw underline, overline, strike-through. */
-        ns_draw_text_decoration (s, s->face, col, s->width, s->x);
-      }
+          if (s->hl == DRAW_CURSOR && s->w->phys_cursor_type == FILLED_BOX_CURSOR)
+            {
+              unsigned long tmp = NS_FACE_BACKGROUND (s->face);
+              NS_FACE_BACKGROUND (s->face) = NS_FACE_FOREGROUND (s->face);
+              NS_FACE_FOREGROUND (s->face) = tmp;
+            }
 
-      if (s->hl == DRAW_CURSOR && s->w->phys_cursor_type == FILLED_BOX_CURSOR)
-        {
-          unsigned long tmp = NS_FACE_BACKGROUND (s->face);
-          NS_FACE_BACKGROUND (s->face) = NS_FACE_FOREGROUND (s->face);
-          NS_FACE_FOREGROUND (s->face) = tmp;
+          ns_reset_clipping (s->f);
         }
-
-      ns_unfocus (s->f);
       break;
 
     case GLYPHLESS_GLYPH:
       n = ns_get_glyph_string_clip_rect (s, r);
-      ns_focus (s->f, r, n);
-
-      if (s->for_overlaps || (s->cmp_from > 0
-			      && ! s->first_glyph->u.cmp.automatic))
-        s->background_filled_p = 1;
-      else
-        ns_maybe_dumpglyphs_background
-          (s, s->first_glyph->type == COMPOSITE_GLYPH);
-      /* ... */
-      /* Not yet implemented.  */
-      /* ... */
-      ns_unfocus (s->f);
+      if (ns_clip_to_rect (s->f, r, n))
+        {
+          if (s->for_overlaps || (s->cmp_from > 0
+                                  && ! s->first_glyph->u.cmp.automatic))
+            s->background_filled_p = 1;
+          else
+            ns_maybe_dumpglyphs_background
+              (s, s->first_glyph->type == COMPOSITE_GLYPH);
+          /* ... */
+          /* Not yet implemented.  */
+          /* ... */
+          ns_reset_clipping (s->f);
+        }
       break;
 
     default:
@@ -4296,9 +4265,11 @@ overwriting cursor (usually when cursor on a tab) */
   if (!s->for_overlaps && !box_drawn_p && s->face->box != FACE_NO_BOX)
     {
       n = ns_get_glyph_string_clip_rect (s, r);
-      ns_focus (s->f, r, n);
-      ns_dumpglyphs_box_or_relief (s);
-      ns_unfocus (s->f);
+      if (ns_clip_to_rect (s->f, r, n))
+        {
+          ns_dumpglyphs_box_or_relief (s);
+          ns_reset_clipping (s->f);
+        }
     }
 
   s->num_clips = 0;
@@ -5321,7 +5292,21 @@ Needs to be here because ns_initialize_display_info () uses AppKit classes.
                                       alpha: 1.0]
                   forKey: [NSString stringWithUTF8String: name]];
           }
-        [cl writeToFile: nil];
+
+        /* FIXME: Report any errors writing the color file below.  */
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 101100
+#if MAC_OS_X_VERSION_MIN_REQUIRED < 101100
+        if ([cl respondsToSelector:@selector(writeToURL:error:)])
+#endif
+          [cl writeToURL:nil error:nil];
+#if MAC_OS_X_VERSION_MIN_REQUIRED < 101100
+        else
+#endif
+#endif /* MAC_OS_X_VERSION_MAX_ALLOWED >= 101100 */
+#if MAC_OS_X_VERSION_MIN_REQUIRED < 101100 \
+  || defined (NS_IMPL_GNUSTEP)
+          [cl writeToFile: nil];
+#endif
       }
   }
 
@@ -7103,7 +7088,6 @@ - (NSSize)windowWillResize: (NSWindow *)sender toSize: (NSSize)frameSize
         size_title = xmalloc (strlen (old_title) + 40);
 	esprintf (size_title, "%s  —  (%d x %d)", old_title, cols, rows);
         [window setTitle: [NSString stringWithUTF8String: size_title]];
-        [window display];
         xfree (size_title);
       }
   }
@@ -8152,8 +8136,8 @@ - (instancetype)toggleToolbar: (id)sender
 
 - (void)drawRect: (NSRect)rect
 {
-  int x = NSMinX (rect), y = NSMinY (rect);
-  int width = NSWidth (rect), height = NSHeight (rect);
+  const NSRect *rectList;
+  NSInteger numRects;
 
   NSTRACE ("[EmacsView drawRect:" NSTRACE_FMT_RECT "]",
            NSTRACE_ARG_RECT(rect));
@@ -8161,9 +8145,26 @@ - (void)drawRect: (NSRect)rect
   if (!emacsframe || !emacsframe->output_data.ns)
     return;
 
-  ns_clear_frame_area (emacsframe, x, y, width, height);
   block_input ();
-  expose_frame (emacsframe, x, y, width, height);
+
+  /* Get only the precise dirty rectangles to avoid redrawing
+     potentially large areas of the frame that haven't changed.
+
+     I'm not sure this actually provides much of a performance benefit
+     as it's hard to benchmark, but it certainly doesn't seem to
+     hurt.  */
+  [self getRectsBeingDrawn:&rectList count:&numRects];
+  for (int i = 0 ; i < numRects ; i++)
+    {
+      NSRect r = rectList[i];
+
+      NSTRACE_RECT ("r", r);
+
+      expose_frame (emacsframe,
+                    NSMinX (r), NSMinY (r),
+                    NSWidth (r), NSHeight (r));
+    }
+
   unblock_input ();
 
   /*
diff --git a/src/xdisp.c b/src/xdisp.c
index 4e7ee0b8fb..21378a64de 100644
--- a/src/xdisp.c
+++ b/src/xdisp.c
@@ -32188,7 +32188,14 @@ expose_window_tree (struct window *w, XRectangle *r)
   struct frame *f = XFRAME (w->frame);
   bool mouse_face_overwritten_p = false;
 
-  while (w && !FRAME_GARBAGED_P (f))
+  /* NS toolkits may have aleady modified the frame in expectation of
+     a successful redraw, so don't bail out here if the frame is
+     garbaged.  */
+  while (w
+#if !defined (HAVE_NS)
+         && !FRAME_GARBAGED_P (f)
+#endif
+         )
     {
       mouse_face_overwritten_p
 	|= (WINDOWP (w->contents)
@@ -32216,12 +32223,16 @@ expose_frame (struct frame *f, int x, int y, int w, int h)
 
   TRACE ((stderr, "expose_frame "));
 
-  /* No need to redraw if frame will be redrawn soon.  */
+#if !defined (HAVE_NS)
+  /* No need to redraw if frame will be redrawn soon except under NS
+     where the toolkit may have already modified the frame in
+     expectation of us redrawing it.  */
   if (FRAME_GARBAGED_P (f))
     {
       TRACE ((stderr, " garbaged\n"));
       return;
     }
+#endif
 
   /* If basic faces haven't been realized yet, there is no point in
      trying to redraw anything.  This can happen when we get an expose
-- 
2.21.0


From 0e3fd0ca5706535669174f8f0018d941c5320c27 Mon Sep 17 00:00:00 2001
From: Wilfred Hughes <me@wilfred.me.uk>
Date: Wed, 13 Feb 2019 09:15:03 -0800
Subject: [PATCH 282/297] Update Travis badge for new GitHub URL (#1348)

Now that Remacs is a separate organisation, the README needs updating.
---
 README.md | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/README.md b/README.md
index 6a43287fc7..6de1d3f973 100644
--- a/README.md
+++ b/README.md
@@ -1,7 +1,7 @@
 # Rust :heart: Emacs
 
 [![Join the chat at https://gitter.im/remacs-discuss/Lobby](https://badges.gitter.im/remacs-discuss/Lobby.svg)](https://gitter.im/remacs-discuss/Lobby?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge&utm_content=badge)
-[![Build Status](https://travis-ci.org/Wilfred/remacs.svg?branch=master)](https://travis-ci.org/Wilfred/remacs)
+[![Build Status](https://travis-ci.org/remacs/remacs.svg?branch=master)](https://travis-ci.org/remacs/remacs)
 
 A community-driven port of [Emacs](https://www.gnu.org/software/emacs/) to [Rust](https://www.rust-lang.org).
 
-- 
2.21.0


From a037cc2016f076012e5f1ae82e8926f4b1796511 Mon Sep 17 00:00:00 2001
From: Christian Johansson <christian@cvj.se>
Date: Thu, 14 Feb 2019 11:07:04 +0100
Subject: [PATCH 283/297] Added intspec for eval_region

---
 rust_src/src/lread.rs | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/rust_src/src/lread.rs b/rust_src/src/lread.rs
index 7abb9eea02..2c36d310dd 100644
--- a/rust_src/src/lread.rs
+++ b/rust_src/src/lread.rs
@@ -270,7 +270,7 @@ pub fn get_file_char() -> EmacsInt {
 /// which is the input stream for reading characters.
 ///
 /// This function does not move point.
-#[lisp_fn(min = "2")]
+#[lisp_fn(min = "2", intspec = "r")]
 pub fn eval_region(
     start: LispObject,
     end: LispObject,
-- 
2.21.0


From 9bca4a055ccd36d7da1edd47304e656f390f8c9d Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Thu, 14 Feb 2019 18:21:10 -0800
Subject: [PATCH 284/297] Refactor validate-region. (#1344)

Add `validate_region_rust`. This returns a tuple instead of
updating its arguments.

The original function exported to C now calls the new function.
---
 rust_src/src/base64.rs     | 52 ++++++++++++++++----------------------
 rust_src/src/buffers.rs    | 20 ++++++++-------
 rust_src/src/callproc.rs   | 13 ++++++----
 rust_src/src/decompress.rs | 38 ++++++++++++----------------
 rust_src/src/editfns.rs    | 51 ++++++++++---------------------------
 5 files changed, 71 insertions(+), 103 deletions(-)

diff --git a/rust_src/src/base64.rs b/rust_src/src/base64.rs
index 0dc087153a..6de9122324 100644
--- a/rust_src/src/base64.rs
+++ b/rust_src/src/base64.rs
@@ -8,7 +8,7 @@ use remacs_macros::lisp_fn;
 
 use crate::{
     base64_crate,
-    buffers::validate_region,
+    buffers::validate_region_rust,
     lisp::LispObject,
     marker::buf_charpos_to_bytepos,
     multibyte::{multibyte_char_at, raw_byte_from_codepoint, LispStringRef, MAX_5_BYTE_CHAR},
@@ -269,21 +269,15 @@ pub fn base64_decode_string(string: LispStringRef) -> LispObject {
 /// Base64-encode the region between BEG and END. Return the length of the encoded text. Optional
 /// third argument NO-LINE-BREAK means do not break long lines into shorter lines.
 #[lisp_fn(min = "2", intspec = "r")]
-pub fn base64_encode_region(
-    mut beg: LispObject,
-    mut end: LispObject,
-    no_line_break: bool,
-) -> EmacsInt {
-    unsafe { validate_region(&mut beg, &mut end) };
+pub fn base64_encode_region(beg: LispObject, end: LispObject, no_line_break: bool) -> EmacsInt {
+    let (beg, end) = validate_region_rust(beg, end);
     let mut current_buffer = ThreadState::current_buffer_unchecked();
     let old_pos = current_buffer.pt;
 
-    let ibeg = beg.as_natnum_or_error() as isize;
-    let begpos = buf_charpos_to_bytepos(current_buffer.as_mut(), ibeg);
-    let iend = end.as_natnum_or_error() as isize;
-    let endpos = buf_charpos_to_bytepos(current_buffer.as_mut(), iend);
+    let begpos = buf_charpos_to_bytepos(current_buffer.as_mut(), beg);
+    let endpos = buf_charpos_to_bytepos(current_buffer.as_mut(), end);
 
-    unsafe { move_gap_both(ibeg, begpos) };
+    unsafe { move_gap_both(beg, begpos) };
 
     // Allocate room for the extra 33% plus newlines
     let length = (endpos - begpos) as usize;
@@ -298,15 +292,15 @@ pub fn base64_encode_region(
 
     // We now insert the new contents and delete the old in the region
     unsafe {
-        set_point_both(begpos, ibeg);
+        set_point_both(begpos, beg);
         insert(encoded.as_ptr() as *const c_char, encoded_length);
         del_range_byte(begpos + encoded_length, endpos + encoded_length);
     }
 
-    let pos_to_set = if old_pos >= iend {
-        old_pos + encoded_length - (iend - ibeg)
-    } else if old_pos > ibeg {
-        old_pos - ibeg
+    let pos_to_set = if old_pos >= end {
+        old_pos + encoded_length - (end - beg)
+    } else if old_pos > beg {
+        old_pos - beg
     } else {
         old_pos
     };
@@ -316,16 +310,14 @@ pub fn base64_encode_region(
 }
 
 #[lisp_fn(intspec = "r")]
-pub fn base64_decode_region(mut beg: LispObject, mut end: LispObject) -> EmacsInt {
-    unsafe { validate_region(&mut beg, &mut end) };
+pub fn base64_decode_region(beg: LispObject, end: LispObject) -> EmacsInt {
+    let (beg, end) = validate_region_rust(beg, end);
 
     let mut current_buffer = ThreadState::current_buffer_unchecked();
     let mut old_pos = current_buffer.pt;
 
-    let ibeg = beg.as_natnum_or_error() as isize;
-    let begpos = buf_charpos_to_bytepos(current_buffer.as_mut(), ibeg);
-    let iend = end.as_natnum_or_error() as isize;
-    let endpos = buf_charpos_to_bytepos(current_buffer.as_mut(), iend);
+    let begpos = buf_charpos_to_bytepos(current_buffer.as_mut(), beg);
+    let endpos = buf_charpos_to_bytepos(current_buffer.as_mut(), end);
 
     let multibyte = current_buffer.multibyte_characters_enabled();
     let length = (endpos - begpos) as usize;
@@ -341,7 +333,7 @@ pub fn base64_decode_region(mut beg: LispObject, mut end: LispObject) -> EmacsIn
 
     // We've decoded it so insert the new contents and delete the old.
     unsafe {
-        temp_set_point_both(current_buffer.as_mut(), ibeg, begpos);
+        temp_set_point_both(current_buffer.as_mut(), beg, begpos);
         insert_1_both(
             decoded.as_ptr() as *const c_char,
             inserted_chars,
@@ -350,20 +342,20 @@ pub fn base64_decode_region(mut beg: LispObject, mut end: LispObject) -> EmacsIn
             true,
             false,
         );
-        signal_after_change(ibeg, 0, inserted_chars);
+        signal_after_change(beg, 0, inserted_chars);
         del_range_both(
             current_buffer.pt,
             current_buffer.pt_byte,
-            iend + inserted_chars,
+            end + inserted_chars,
             endpos + decoded_length,
             true,
         );
     }
 
-    if old_pos >= iend {
-        old_pos += inserted_chars - (iend - ibeg);
-    } else if old_pos > ibeg {
-        old_pos = ibeg;
+    if old_pos >= end {
+        old_pos += inserted_chars - (end - beg);
+    } else if old_pos > beg {
+        old_pos = beg;
     }
     unsafe { set_point(max(current_buffer.zv, old_pos)) };
 
diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 09b997ef60..6f833b3b85 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -813,26 +813,28 @@ pub fn overlay_properties(overlay: LispOverlayRef) -> LispObject {
 
 #[no_mangle]
 pub unsafe extern "C" fn validate_region(b: *mut LispObject, e: *mut LispObject) {
-    let start = *b;
-    let stop = *e;
+    let (begin, end) = validate_region_rust(*b, *e);
+    *b = begin.into();
+    *e = end.into();
+}
 
-    let mut beg = start.as_fixnum_coerce_marker_or_error();
+pub fn validate_region_rust(start: LispObject, stop: LispObject) -> (isize, isize) {
+    let mut begin = start.as_fixnum_coerce_marker_or_error();
     let mut end = stop.as_fixnum_coerce_marker_or_error();
 
-    if beg > end {
-        mem::swap(&mut beg, &mut end);
+    if begin > end {
+        mem::swap(&mut begin, &mut end);
     }
 
-    *b = LispObject::from(beg);
-    *e = LispObject::from(end);
-
     let buf = ThreadState::current_buffer_unchecked();
     let begv = buf.begv as EmacsInt;
     let zv = buf.zv as EmacsInt;
 
-    if !(begv <= beg && end <= zv) {
+    if !(begv <= begin && end <= zv) {
         args_out_of_range!(current_buffer(), start, stop);
     }
+
+    (begin as isize, end as isize)
 }
 
 /// Make buffer BUFFER-OR-NAME current for editing operations.
diff --git a/rust_src/src/callproc.rs b/rust_src/src/callproc.rs
index f6ec37ea9d..d3c7711373 100644
--- a/rust_src/src/callproc.rs
+++ b/rust_src/src/callproc.rs
@@ -10,12 +10,12 @@ use crate::{
     lisp::LispObject,
     remacs_macros::lisp_fn,
     remacs_sys::Fdelete_region,
+    remacs_sys::Qnil,
     remacs_sys::NULL_DEVICE,
     remacs_sys::{
         build_string, call_process, close_file_unwind, create_temp_file, emacs_open,
         report_file_error,
     },
-    remacs_sys::{EmacsInt, Qnil},
     threads::{c_specpdl_index, ThreadState},
 };
 
@@ -136,10 +136,13 @@ pub fn call_process_region(args: &mut [LispObject]) -> LispObject {
         let buffer = ThreadState::current_buffer_unchecked();
         buffer.beg() == buffer.z()
     } else {
-        unsafe { buffers::validate_region(&mut args[0], &mut args[1]) };
-        start = args[0];
-        end = args[1];
-        EmacsInt::from(start) == EmacsInt::from(end)
+        let (start_1, end_1) = buffers::validate_region_rust(args[0], args[1]);
+        start = start_1.into();
+        end = end_1.into();
+        args[0] = start;
+        args[1] = end;
+
+        start_1 == end_1
     };
 
     let fd = unsafe {
diff --git a/rust_src/src/decompress.rs b/rust_src/src/decompress.rs
index 5f817addc5..bf76ee1fcc 100644
--- a/rust_src/src/decompress.rs
+++ b/rust_src/src/decompress.rs
@@ -7,7 +7,7 @@ use flate2::read::{DeflateDecoder, GzDecoder, ZlibDecoder};
 use remacs_macros::lisp_fn;
 
 use crate::{
-    buffers::validate_region,
+    buffers::validate_region_rust,
     lisp::LispObject,
     remacs_sys::{
         buf_charpos_to_bytepos, del_range_2, insert_from_gap, make_gap, maybe_quit, modify_text,
@@ -40,8 +40,8 @@ fn create_buffer_decoder<'a>(buffer: &'a [u8]) -> Box<Read + 'a> {
 /// On failure, return nil and leave the data in place.
 /// This function can be called only in unibyte buffers.
 #[lisp_fn]
-pub fn zlib_decompress_region(mut start: LispObject, mut end: LispObject) -> bool {
-    unsafe { validate_region(&mut start, &mut end) };
+pub fn zlib_decompress_region(start: LispObject, end: LispObject) -> bool {
+    let (start, end) = validate_region_rust(start, end);
 
     let mut current_buffer = ThreadState::current_buffer_unchecked();
 
@@ -49,32 +49,26 @@ pub fn zlib_decompress_region(mut start: LispObject, mut end: LispObject) -> boo
         error!("This function can be called only in unibyte buffers");
     };
 
-    let istart = start.as_fixnum_or_error() as isize;
-    let iend = end.as_fixnum_or_error() as isize;
-
     // Empty region, decompress failed.
-    if istart == iend {
+    if start == end {
         return false;
     }
 
     unsafe {
         // Do the following before manipulating the gap.
-        modify_text(istart, iend);
+        modify_text(start, end);
 
-        move_gap_both(iend, iend);
+        move_gap_both(end, end);
     }
 
     // Insert the decompressed data at the end of the compressed data.
-    let charpos = iend;
-    let bytepos = unsafe { buf_charpos_to_bytepos(current_buffer.as_mut(), iend as isize) };
+    let charpos = end;
+    let bytepos = unsafe { buf_charpos_to_bytepos(current_buffer.as_mut(), end) };
     let old_pt = current_buffer.pt;
     current_buffer.set_pt_both(charpos, bytepos);
 
     let compressed_buffer = unsafe {
-        slice::from_raw_parts(
-            current_buffer.byte_pos_addr(istart),
-            (iend - istart) as usize,
-        )
+        slice::from_raw_parts(current_buffer.byte_pos_addr(start), (end - start) as usize)
     };
 
     // The decompressor
@@ -103,12 +97,12 @@ pub fn zlib_decompress_region(mut start: LispObject, mut end: LispObject) -> boo
                 // Delete the compressed data.
                 unsafe {
                     del_range_2(
-                        istart, istart, // byte, char offsets the same
-                        iend, iend, false,
+                        start, start, // byte, char offsets the same
+                        end, end, false,
                     );
-                    signal_after_change(istart, iend - istart, decompressed_bytes);
+                    signal_after_change(start, end - start, decompressed_bytes);
 
-                    update_compositions(istart, istart, CHECK_HEAD as i32);
+                    update_compositions(start, start, CHECK_HEAD as i32);
                 };
                 return true;
             }
@@ -129,9 +123,9 @@ pub fn zlib_decompress_region(mut start: LispObject, mut end: LispObject) -> boo
                 // Delete any uncompressed data already inserted on error, but
                 // without calling the change hooks.
 
-                let data_orig = istart;
-                let data_start = iend;
-                let data_end = iend + decompressed_bytes;
+                let data_orig = start;
+                let data_start = end;
+                let data_end = end + decompressed_bytes;
 
                 unsafe {
                     del_range_2(
diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index 8053f3ccf4..32b863d0a3 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -11,7 +11,7 @@ use libc::{c_char, c_int, c_uchar, ptrdiff_t};
 use remacs_macros::lisp_fn;
 
 use crate::{
-    buffers::{current_buffer, validate_region},
+    buffers::{current_buffer, validate_region_rust},
     buffers::{LispBufferOrCurrent, LispBufferOrName, LispBufferRef, BUF_BYTES_MAX},
     character::{char_head_p, dec_pos},
     eval::{progn, record_unwind_protect, unbind_to},
@@ -1093,22 +1093,18 @@ pub fn buffer_string() -> LispObject {
 /// into the result string; if you don't want the text properties,
 /// use `buffer-substring-no-properties' instead.
 #[lisp_fn]
-pub fn buffer_substring(mut beg: LispObject, mut end: LispObject) -> LispObject {
-    unsafe { validate_region(&mut beg, &mut end) };
-    let b = beg.as_fixnum_or_error();
-    let e = end.as_fixnum_or_error();
-    unsafe { make_buffer_string(b as isize, e as isize, true) }
+pub fn buffer_substring(beg: LispObject, end: LispObject) -> LispObject {
+    let (beg, end) = validate_region_rust(beg, end);
+    unsafe { make_buffer_string(beg, end, true) }
 }
 
 /// Return the characters of part of the buffer, without the text properties.
 /// The two arguments START and END are character positions;
 /// they can be in either order.
 #[lisp_fn]
-pub fn buffer_substring_no_properties(mut beg: LispObject, mut end: LispObject) -> LispObject {
-    unsafe { validate_region(&mut beg, &mut end) };
-    let b = beg.as_fixnum_or_error();
-    let e = end.as_fixnum_or_error();
-    unsafe { make_buffer_string(b as isize, e as isize, false) }
+pub fn buffer_substring_no_properties(beg: LispObject, end: LispObject) -> LispObject {
+    let (beg, end) = validate_region_rust(beg, end);
+    unsafe { make_buffer_string(beg, end, false) }
 }
 
 // Save current buffer state for `save-excursion' special form.
@@ -1349,42 +1345,23 @@ pub fn field_string_no_properties(pos: Option<LispNumber>) -> LispObject {
 /// called interactively, delete the region between point and mark. This command
 /// deletes buffer text without modifying the kill ring.
 #[lisp_fn(intspec = "r")]
-pub fn delete_region(mut start: LispObject, mut end: LispObject) {
+pub fn delete_region(start: LispObject, end: LispObject) {
     // Don't just call delete_and_extract_region and throw away the return value
     // to avoid doing the extra, unnecessary work of copying the region to
     // return it.
-    unsafe { validate_region(&mut start, &mut end) };
-    unsafe {
-        del_range(
-            start.as_fixnum_or_error() as ptrdiff_t,
-            end.as_fixnum_or_error() as ptrdiff_t,
-        )
-    };
+    let (start, end) = validate_region_rust(start, end);
+    unsafe { del_range(start as ptrdiff_t, end as ptrdiff_t) };
 }
 
 /// Delete the text between START and END, including START but excluding END, and
 /// return it.
 #[lisp_fn]
-pub fn delete_and_extract_region(
-    mut start: LispObject,
-    mut end: LispObject,
-) -> Option<LispStringRef> {
-    unsafe { validate_region(&mut start, &mut end) };
-
-    let start_fixnum = start.as_fixnum_or_error();
-    let end_fixnum = end.as_fixnum_or_error();
-    if start_fixnum == end_fixnum {
+pub fn delete_and_extract_region(start: LispObject, end: LispObject) -> Option<LispStringRef> {
+    let (start, end) = validate_region_rust(start, end);
+    if start == end {
         Some(LispObject::empty_unibyte_string())
     } else {
-        unsafe {
-            del_range_1(
-                start_fixnum as ptrdiff_t,
-                end_fixnum as ptrdiff_t,
-                true,
-                true,
-            )
-        }
-        .as_string()
+        unsafe { del_range_1(start as ptrdiff_t, end as ptrdiff_t, true, true) }.as_string()
     }
 }
 
-- 
2.21.0


From 0207a05ce4aa8e1531a986dc1cd9dcd23181db40 Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Sun, 17 Feb 2019 22:58:51 -0800
Subject: [PATCH 285/297] Complete the port of casetab.c (#1351)

Add a `LispCaseTable` which is a type wrapper around `LispCharTableRef`.
Implement the bare minimum of needed pass through methods.
---
 rust_src/src/casetab.rs     | 264 +++++++++++++++++++++++++++++++++---
 rust_src/src/chartable.rs   |  13 +-
 rust_src/src/eval_macros.rs |   4 +-
 rust_src/src/numbers.rs     |  11 +-
 src/Makefile.in             |   2 +-
 src/buffer.c                |  18 +--
 src/casetab.c               | 227 -------------------------------
 src/dired.c                 |   2 +-
 src/lisp.h                  |  18 ++-
 src/search.c                |   2 +-
 10 files changed, 289 insertions(+), 272 deletions(-)
 delete mode 100644 src/casetab.c

diff --git a/rust_src/src/casetab.rs b/rust_src/src/casetab.rs
index a629e60e87..b6ef1db38d 100644
--- a/rust_src/src/casetab.rs
+++ b/rust_src/src/casetab.rs
@@ -3,31 +3,188 @@
 use remacs_macros::lisp_fn;
 
 use crate::{
+    buffers::current_buffer,
+    buffers::LispBufferRef,
+    chartable::LispCharTableRef,
     lisp::LispObject,
+    lists::put,
     objects::eq,
-    remacs_sys::{set_case_table, Qcase_table, Vascii_downcase_table},
+    remacs_sys::EmacsInt,
+    remacs_sys::{
+        map_char_table, set_char_table_extras, set_char_table_purpose, staticpro, Fcopy_sequence,
+        Fmake_char_table, Fset_char_table_range, CHAR_TABLE_SET,
+    },
+    remacs_sys::{Qcase_table, Qcase_table_p, Qchar_table_extra_slots, Qnil},
     threads::ThreadState,
 };
 
+pub struct LispCaseTable(LispCharTableRef);
+
+impl LispCaseTable {
+    pub fn extras(&self) -> (LispObject, LispObject, LispObject) {
+        let extras = unsafe { self.0.extras.as_slice(3) };
+        (extras[0], extras[1], extras[2])
+    }
+
+    pub fn from_char_table(table: LispCharTableRef) -> Self {
+        Self(table)
+    }
+
+    pub fn get(&self, idx: isize) -> LispObject {
+        self.0.get(idx)
+    }
+}
+
+impl From<LispObject> for LispCaseTable {
+    fn from(obj: LispObject) -> Self {
+        let case_table: Option<LispCharTableRef> = obj.into();
+        if !case_table_p(case_table) {
+            wrong_type!(Qcase_table_p, obj);
+        }
+        Self(case_table.unwrap())
+    }
+}
+
+static mut Vascii_downcase_table: LispObject = Qnil;
+static mut Vascii_upcase_table: LispObject = Qnil;
+static mut Vascii_canon_table: LispObject = Qnil;
+static mut Vascii_eqv_table: LispObject = Qnil;
+
+fn set_case_table(table: LispObject, standard: bool) -> LispObject {
+    let case_table: LispCaseTable = table.into();
+    let (mut up, mut canon, mut eqv) = case_table.extras();
+
+    unsafe {
+        if up.is_nil() {
+            up = Fmake_char_table(Qcase_table, Qnil);
+            map_char_table(Some(set_identity), Qnil, table, up);
+            map_char_table(Some(shuffle), Qnil, table, up);
+            set_char_table_extras(table, 0, up);
+        }
+
+        if canon.is_nil() {
+            canon = Fmake_char_table(Qcase_table, Qnil);
+            set_char_table_extras(table, 1, canon);
+            map_char_table(Some(set_canon), Qnil, table, table);
+        }
+
+        if eqv.is_nil() {
+            eqv = Fmake_char_table(Qcase_table, Qnil);
+            map_char_table(Some(set_identity), Qnil, canon, eqv);
+            map_char_table(Some(shuffle), Qnil, canon, eqv);
+            set_char_table_extras(table, 2, eqv);
+        }
+
+        // This is so set_image_of_range_1 in regex.c can find the EQV table.
+        set_char_table_extras(canon, 2, eqv);
+    }
+
+    if standard {
+        unsafe {
+            Vascii_downcase_table = table;
+            Vascii_upcase_table = up;
+            Vascii_canon_table = canon;
+            Vascii_eqv_table = eqv;
+        }
+    } else {
+        let mut buffer: LispBufferRef = current_buffer().into();
+        buffer.downcase_table_ = table;
+        buffer.upcase_table_ = up;
+        buffer.case_canon_table_ = canon;
+        buffer.case_eqv_table_ = eqv;
+    }
+
+    table
+}
+
+// The following functions are called in map_char_table.
+
+// Set CANON char-table element for characters in RANGE to a
+// translated ELT by UP and DOWN char-tables.  This is done only when
+// ELT is a character.  The char-tables CANON, UP, and DOWN are in
+// TABLE.
+extern "C" fn set_canon(table: LispObject, range: LispObject, elt: LispObject) {
+    if let Some(idx) = elt.as_natnum() {
+        let case_table: LispCaseTable = table.into();
+
+        let (up, canon, _) = case_table.extras();
+
+        let up_table: LispCharTableRef = up.into();
+        let value: EmacsInt = up_table.get(idx as isize).into();
+
+        unsafe {
+            Fset_char_table_range(canon, range, case_table.get(value as isize));
+        }
+    }
+}
+
+// Set elements of char-table TABLE for C to C itself.  C may be a
+// cons specifying a character range.  In that case, set characters in
+// that range to themselves.  This is done only when ELT is a
+// character.  This is called in map_char_table.
+extern "C" fn set_identity(table: LispObject, c: LispObject, elt: LispObject) {
+    if !elt.is_natnum() {
+        return;
+    }
+
+    let char_table: LispCharTableRef = table.into();
+
+    let (from, to): (EmacsInt, EmacsInt) = match c.into() {
+        Some((car, cdr)) => (car.into(), cdr.into()),
+        None => {
+            let x = c.into();
+            (x, x)
+        }
+    };
+
+    for i in from..=to {
+        char_table.set_unchecked(i as isize, i.into());
+    }
+}
+
+// Permute the elements of TABLE (which is initially an identity
+// mapping) so that it has one cycle for each equivalence class
+// induced by the translation table on which map_char_table is
+// operated.
+extern "C" fn shuffle(table: LispObject, c: LispObject, elt: LispObject) {
+    if let Some(idx) = elt.as_natnum() {
+        let char_table: LispCharTableRef = table.into();
+
+        let (from, to): (EmacsInt, EmacsInt) = match c.into() {
+            Some((car, cdr)) => (car.into(), cdr.into()),
+            None => {
+                let x = c.into();
+                (x, x)
+            }
+        };
+
+        let idx = idx as isize;
+        for i in from..=to {
+            let tem = char_table.get(idx);
+            char_table.set(idx, i.into());
+            char_table.set(i as isize, tem);
+        }
+    }
+}
+
 /// Return t if OBJECT is a case table.
 /// See `set-case-table' for more information on these data structures.
 #[lisp_fn]
-pub fn case_table_p(object: LispObject) -> bool {
-    let char_table = match object.as_char_table() {
-        Some(ct) => ct,
+pub fn case_table_p(table: Option<LispCharTableRef>) -> bool {
+    let char_table = match table {
+        Some(ct) => {
+            if !eq(ct.purpose, Qcase_table) {
+                return false;
+            }
+            ct
+        }
         None => {
             return false;
         }
     };
 
-    if !eq(char_table.purpose, Qcase_table) {
-        return false;
-    }
-
-    let extras = unsafe { char_table.extras.as_slice(3) };
-    let up = extras[0];
-    let canon = extras[1];
-    let eqv = extras[2];
+    let case_table = LispCaseTable::from_char_table(char_table);
+    let (up, canon, eqv) = case_table.extras();
 
     (up.is_nil() || up.is_char_table())
         && ((canon.is_nil() && eqv.is_nil())
@@ -44,7 +201,19 @@ pub fn current_case_table() -> LispObject {
 /// This is the one used for new buffers.
 #[lisp_fn]
 pub fn standard_case_table() -> LispObject {
-    unsafe { Vascii_downcase_table }
+    unsafe { get_downcase_table() }
+}
+
+// These two need to be exposed to our parts of the project.
+
+#[no_mangle]
+pub unsafe extern "C" fn get_downcase_table() -> LispObject {
+    Vascii_downcase_table
+}
+
+#[no_mangle]
+pub unsafe extern "C" fn get_canonical_case_table() -> LispObject {
+    Vascii_canon_table
 }
 
 /// Select a new case table for the current buffer.
@@ -65,18 +234,81 @@ pub fn standard_case_table() -> LispObject {
 ///  in which case it is deduced from CANONICALIZE.
 #[lisp_fn(name = "set-case-table", c_name = "set_case_table")]
 pub fn set_case_table_lisp(table: LispObject) -> LispObject {
-    unsafe { set_case_table(table, false) }
+    set_case_table(table, false)
 }
 
 /// Select a new standard case table for new buffers.
 /// See `set-case-table' for more info on case tables.
 #[lisp_fn]
 pub fn set_standard_case_table(table: LispObject) -> LispObject {
-    unsafe { set_case_table(table, true) }
+    set_case_table(table, true)
 }
 
 #[no_mangle]
-pub extern "C" fn rust_syms_of_casetab() {
+pub unsafe extern "C" fn init_casetab_once() {
+    def_lisp_sym!(Qcase_table, "case-table");
+    put(Qcase_table.into(), Qchar_table_extra_slots, 3.into());
+
+    let down = Fmake_char_table(Qcase_table, Qnil);
+    set_char_table_purpose(down, Qcase_table);
+    Vascii_downcase_table = down;
+
+    for i in 0..128 {
+        // Set up a table for the lower 7 bits of ASCII.
+        // All upper case letters are mapped to lower case letters.
+        let c = if i >= 0x41 && i <= 0x5A {
+            i + 32 // 'a' - 'A'
+        } else {
+            i
+        };
+        CHAR_TABLE_SET(down, i, c.into());
+    }
+
+    set_char_table_extras(down, 1, Fcopy_sequence(down));
+
+    let up = Fmake_char_table(Qcase_table, Qnil);
+    set_char_table_extras(down, 0, up);
+
+    for i in 0..128 {
+        // Set up a table for the lower 7 bits of ASCII.
+        // All lower case letters are mapped to upper case letters.
+        let c = if i >= 0x61 && i <= 0x7A {
+            i - 32 // 'A' - 'a'
+        } else {
+            i
+        };
+        CHAR_TABLE_SET(up, i, c.into());
+    }
+
+    let eqv = Fmake_char_table(Qcase_table, Qnil);
+
+    for i in 0..128 {
+        // Set up a table for the lower 7 bits of ASCII.
+        // All upper case letters are mapped to lower case letters
+        // and vice versa.
+        let c = if i >= 0x41 && i <= 0x5A {
+            i + 32 // 'a' - 'A'
+        } else if i >= 0x61 && i <= 0x7A {
+            i - 32 // 'A' - 'a'
+        } else {
+            i
+        };
+        CHAR_TABLE_SET(eqv, i, c.into());
+    }
+
+    set_char_table_extras(down, 2, eqv);
+
+    // Fill in what isn't filled in.
+    set_case_table(down, true);
+}
+
+#[no_mangle]
+pub unsafe extern "C" fn syms_of_casetab() {
+    staticpro(&mut Vascii_canon_table as *mut LispObject);
+    staticpro(&mut Vascii_downcase_table as *mut LispObject);
+    staticpro(&mut Vascii_eqv_table as *mut LispObject);
+    staticpro(&mut Vascii_upcase_table as *mut LispObject);
+
     def_lisp_sym!(Qcase_table_p, "case-table-p");
 }
 
diff --git a/rust_src/src/chartable.rs b/rust_src/src/chartable.rs
index 514eb4b72a..1190d59cb9 100644
--- a/rust_src/src/chartable.rs
+++ b/rust_src/src/chartable.rs
@@ -7,11 +7,11 @@ use remacs_macros::lisp_fn;
 use crate::{
     hashtable::LispHashTableRef,
     lisp::{ExternalPtr, LispObject, LispStructuralEqual},
-    remacs_sys::uniprop_table_uncompress,
     remacs_sys::{
-        char_table_specials, equal_kind, pvec_type, Lisp_Char_Table, Lisp_Sub_Char_Table,
+        char_table_specials, equal_kind, pvec_type, EmacsInt, Lisp_Char_Table, Lisp_Sub_Char_Table,
         Lisp_Type, More_Lisp_Bits, CHARTAB_SIZE_BITS,
     },
+    remacs_sys::{uniprop_table_uncompress, CHAR_TABLE_SET},
     remacs_sys::{Qchar_code_property_table, Qchar_table_p},
 };
 
@@ -145,6 +145,15 @@ impl LispCharTableRef {
 
         val
     }
+
+    pub fn set(self, idx: isize, value: LispObject) {
+        verify_lisp_type!(idx as EmacsInt, Qcharacterp);
+        self.set_unchecked(idx, value);
+    }
+
+    pub fn set_unchecked(self, idx: isize, value: LispObject) {
+        unsafe { CHAR_TABLE_SET(self.into(), idx as i32, value) };
+    }
 }
 
 impl LispStructuralEqual for LispCharTableRef {
diff --git a/rust_src/src/eval_macros.rs b/rust_src/src/eval_macros.rs
index b25c5bdac3..3c2610f6d2 100644
--- a/rust_src/src/eval_macros.rs
+++ b/rust_src/src/eval_macros.rs
@@ -284,11 +284,11 @@ macro_rules! declare_GC_protected_static {
 macro_rules! verify_lisp_type {
     ($obj:expr, Qarrayp) => {
         if !$obj.is_array() {
-            wrong_type!(::remacs_sys::Qarrayp, $obj);
+            wrong_type!(crate::remacs_sys::Qarrayp, $obj);
         }
     };
     ($n:expr, Qcharacterp) => {
-        if $n < 0 || $n > (EmacsInt::from($crate::multibyte::MAX_CHAR)) {
+        if $n < 0 || $n > (crate::remacs_sys::EmacsInt::from($crate::multibyte::MAX_CHAR)) {
             wrong_type!(
                 crate::remacs_sys::Qcharacterp,
                 $crate::lisp::LispObject::from($n)
diff --git a/rust_src/src/numbers.rs b/rust_src/src/numbers.rs
index a6a7628759..582706903a 100644
--- a/rust_src/src/numbers.rs
+++ b/rust_src/src/numbers.rs
@@ -95,13 +95,18 @@ impl LispObject {
         self.as_fixnum().map_or(false, |i| i >= 0)
     }
 
-    pub fn as_natnum_or_error(self) -> EmacsUint {
+    pub fn as_natnum(self) -> Option<EmacsUint> {
         if self.is_natnum() {
-            unsafe { self.to_fixnum_unchecked() as EmacsUint }
+            Some(unsafe { self.to_fixnum_unchecked() as EmacsUint })
         } else {
-            wrong_type!(Qwholenump, self)
+            None
         }
     }
+
+    pub fn as_natnum_or_error(self) -> EmacsUint {
+        self.as_natnum()
+            .unwrap_or_else(|| wrong_type!(Qwholenump, self))
+    }
 }
 
 impl LispObject {
diff --git a/src/Makefile.in b/src/Makefile.in
index 0e345c4f3f..bf2eb27557 100644
--- a/src/Makefile.in
+++ b/src/Makefile.in
@@ -398,7 +398,7 @@ base_obj = dispnew.o frame.o scroll.o xdisp.o menu.o $(XMENU_OBJ) window.o \
 	emacs.o keyboard.o macros.o keymap.o sysdep.o \
 	buffer.o filelock.o insdel.o \
 	minibuf.o fileio.o dired.o \
-	casetab.o casefiddle.o indent.o search.o regex.o undo.o \
+	casefiddle.o indent.o search.o regex.o undo.o \
 	alloc.o data.o doc.o editfns.o callint.o \
 	eval.o fns.o font.o print.o lread.o $(MODULES_OBJ) \
 	syntax.o $(UNEXEC_OBJ) bytecode.o \
diff --git a/src/buffer.c b/src/buffer.c
index 3a13d67f11..52fca3d457 100644
--- a/src/buffer.c
+++ b/src/buffer.c
@@ -719,15 +719,15 @@ reset_buffer_local_variables (struct buffer *b, bool permanent_too)
 
   /* If the standard case table has been altered and invalidated,
      fix up its insides first.  */
-  if (! (CHAR_TABLE_P (XCHAR_TABLE (Vascii_downcase_table)->extras[0])
-	 && CHAR_TABLE_P (XCHAR_TABLE (Vascii_downcase_table)->extras[1])
-	 && CHAR_TABLE_P (XCHAR_TABLE (Vascii_downcase_table)->extras[2])))
-    Fset_standard_case_table (Vascii_downcase_table);
-
-  bset_downcase_table (b, Vascii_downcase_table);
-  bset_upcase_table (b, XCHAR_TABLE (Vascii_downcase_table)->extras[0]);
-  bset_case_canon_table (b, XCHAR_TABLE (Vascii_downcase_table)->extras[1]);
-  bset_case_eqv_table (b, XCHAR_TABLE (Vascii_downcase_table)->extras[2]);
+  if (! (CHAR_TABLE_P (XCHAR_TABLE (get_downcase_table ())->extras[0])
+	 && CHAR_TABLE_P (XCHAR_TABLE (get_downcase_table ())->extras[1])
+	 && CHAR_TABLE_P (XCHAR_TABLE (get_downcase_table ())->extras[2])))
+    Fset_standard_case_table (get_downcase_table ());
+
+  bset_downcase_table (b, get_downcase_table ());
+  bset_upcase_table (b, XCHAR_TABLE (get_downcase_table ())->extras[0]);
+  bset_case_canon_table (b, XCHAR_TABLE (get_downcase_table ())->extras[1]);
+  bset_case_eqv_table (b, XCHAR_TABLE (get_downcase_table ())->extras[2]);
   bset_invisibility_spec (b, Qt);
 
   /* Reset all (or most) per-buffer variables to their defaults.  */
diff --git a/src/casetab.c b/src/casetab.c
deleted file mode 100644
index 790b68538f..0000000000
--- a/src/casetab.c
+++ /dev/null
@@ -1,227 +0,0 @@
-/* GNU Emacs routines to deal with case tables.
-   Copyright (C) 1993-1994, 2001-2018 Free Software Foundation, Inc.
-
-Author: Howard Gayle
-
-This file is part of GNU Emacs.
-
-GNU Emacs is free software: you can redistribute it and/or modify
-it under the terms of the GNU General Public License as published by
-the Free Software Foundation, either version 3 of the License, or (at
-your option) any later version.
-
-GNU Emacs is distributed in the hope that it will be useful,
-but WITHOUT ANY WARRANTY; without even the implied warranty of
-MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-GNU General Public License for more details.
-
-You should have received a copy of the GNU General Public License
-along with GNU Emacs.  If not, see <https://www.gnu.org/licenses/>.  */
-
-#include <config.h>
-
-#include "lisp.h"
-#include "buffer.h"
-
-Lisp_Object Vascii_downcase_table;
-static Lisp_Object Vascii_upcase_table;
-Lisp_Object Vascii_canon_table;
-static Lisp_Object Vascii_eqv_table;
-
-static void set_canon (Lisp_Object case_table, Lisp_Object range, Lisp_Object elt);
-static void set_identity (Lisp_Object table, Lisp_Object c, Lisp_Object elt);
-static void shuffle (Lisp_Object table, Lisp_Object c, Lisp_Object elt);
-
-extern void rust_syms_of_casetab (void);
-
-static Lisp_Object
-check_case_table (Lisp_Object obj)
-{
-  CHECK_TYPE (!NILP (Fcase_table_p (obj)), Qcase_table_p, obj);
-  return (obj);
-}
-
-Lisp_Object
-set_case_table (Lisp_Object table, bool standard)
-{
-  Lisp_Object up, canon, eqv;
-
-  check_case_table (table);
-
-  up = XCHAR_TABLE (table)->extras[0];
-  canon = XCHAR_TABLE (table)->extras[1];
-  eqv = XCHAR_TABLE (table)->extras[2];
-
-  if (NILP (up))
-    {
-      up = Fmake_char_table (Qcase_table, Qnil);
-      map_char_table (set_identity, Qnil, table, up);
-      map_char_table (shuffle, Qnil, table, up);
-      set_char_table_extras (table, 0, up);
-    }
-
-  if (NILP (canon))
-    {
-      canon = Fmake_char_table (Qcase_table, Qnil);
-      set_char_table_extras (table, 1, canon);
-      map_char_table (set_canon, Qnil, table, table);
-    }
-
-  if (NILP (eqv))
-    {
-      eqv = Fmake_char_table (Qcase_table, Qnil);
-      map_char_table (set_identity, Qnil, canon, eqv);
-      map_char_table (shuffle, Qnil, canon, eqv);
-      set_char_table_extras (table, 2, eqv);
-    }
-
-  /* This is so set_image_of_range_1 in regex.c can find the EQV table.  */
-  set_char_table_extras (canon, 2, eqv);
-
-  if (standard)
-    {
-      Vascii_downcase_table = table;
-      Vascii_upcase_table = up;
-      Vascii_canon_table = canon;
-      Vascii_eqv_table = eqv;
-    }
-  else
-    {
-      bset_downcase_table (current_buffer, table);
-      bset_upcase_table (current_buffer, up);
-      bset_case_canon_table (current_buffer, canon);
-      bset_case_eqv_table (current_buffer, eqv);
-    }
-
-  return table;
-}
-
-/* The following functions are called in map_char_table.  */
-
-/* Set CANON char-table element for characters in RANGE to a
-   translated ELT by UP and DOWN char-tables.  This is done only when
-   ELT is a character.  The char-tables CANON, UP, and DOWN are in
-   CASE_TABLE.  */
-
-static void
-set_canon (Lisp_Object case_table, Lisp_Object range, Lisp_Object elt)
-{
-  Lisp_Object up = XCHAR_TABLE (case_table)->extras[0];
-  Lisp_Object canon = XCHAR_TABLE (case_table)->extras[1];
-
-  if (NATNUMP (elt))
-    Fset_char_table_range (canon, range, Faref (case_table, Faref (up, elt)));
-}
-
-/* Set elements of char-table TABLE for C to C itself.  C may be a
-   cons specifying a character range.  In that case, set characters in
-   that range to themselves.  This is done only when ELT is a
-   character.  This is called in map_char_table.  */
-
-static void
-set_identity (Lisp_Object table, Lisp_Object c, Lisp_Object elt)
-{
-  if (NATNUMP (elt))
-    {
-      int from, to;
-
-      if (CONSP (c))
-	{
-	  from = XINT (XCAR (c));
-	  to = XINT (XCDR (c));
-	}
-      else
-	from = to = XINT (c);
-
-      to++;
-      for (; from < to; from++)
-	CHAR_TABLE_SET (table, from, make_number (from));
-    }
-}
-
-/* Permute the elements of TABLE (which is initially an identity
-   mapping) so that it has one cycle for each equivalence class
-   induced by the translation table on which map_char_table is
-   operated.  */
-
-static void
-shuffle (Lisp_Object table, Lisp_Object c, Lisp_Object elt)
-{
-  if (NATNUMP (elt))
-    {
-      int from, to;
-
-      if (CONSP (c))
-	{
-	  from = XINT (XCAR (c));
-	  to = XINT (XCDR (c));
-	}
-      else
-	from = to = XINT (c);
-
-      to++;
-      for (; from < to; from++)
-	{
-	  Lisp_Object tem = Faref (table, elt);
-	  Faset (table, elt, make_number (from));
-	  Faset (table, make_number (from), tem);
-	}
-    }
-}
-
-void
-init_casetab_once (void)
-{
-  register int i;
-  Lisp_Object down, up, eqv;
-
-  DEFSYM (Qcase_table, "case-table");
-  Fput (Qcase_table, Qchar_table_extra_slots, make_number (3));
-
-  down = Fmake_char_table (Qcase_table, Qnil);
-  Vascii_downcase_table = down;
-  set_char_table_purpose (down, Qcase_table);
-
-  for (i = 0; i < 128; i++)
-    {
-      int c = (i >= 'A' && i <= 'Z') ? i + ('a' - 'A') : i;
-      CHAR_TABLE_SET (down, i, make_number (c));
-    }
-
-  set_char_table_extras (down, 1, Fcopy_sequence (down));
-
-  up = Fmake_char_table (Qcase_table, Qnil);
-  set_char_table_extras (down, 0, up);
-
-  for (i = 0; i < 128; i++)
-    {
-      int c = (i >= 'a' && i <= 'z') ? i + ('A' - 'a') : i;
-      CHAR_TABLE_SET (up, i, make_number (c));
-    }
-
-  eqv = Fmake_char_table (Qcase_table, Qnil);
-
-   for (i = 0; i < 128; i++)
-     {
-      int c = ((i >= 'A' && i <= 'Z') ? i + ('a' - 'A')
-	       : ((i >= 'a' && i <= 'z') ? i + ('A' - 'a')
-		  : i));
-      CHAR_TABLE_SET (eqv, i, make_number (c));
-    }
-
-  set_char_table_extras (down, 2, eqv);
-
-  /* Fill in what isn't filled in.  */
-  set_case_table (down, 1);
-}
-
-void
-syms_of_casetab (void)
-{
-  staticpro (&Vascii_canon_table);
-  staticpro (&Vascii_downcase_table);
-  staticpro (&Vascii_eqv_table);
-  staticpro (&Vascii_upcase_table);
-
-  rust_syms_of_casetab();
-}
diff --git a/src/dired.c b/src/dired.c
index fffccf4a03..452b49b886 100644
--- a/src/dired.c
+++ b/src/dired.c
@@ -666,7 +666,7 @@ file_name_completion (Lisp_Object file, Lisp_Object dirname, bool all_flag,
 
       {
 	Lisp_Object regexps, table = (completion_ignore_case
-				      ? Vascii_canon_table : Qnil);
+				      ? get_canonical_case_table() : Qnil);
 
 	/* Ignore this element if it fails to match all the regexps.  */
 	for (regexps = Vcompletion_regexp_list; CONSP (regexps);
diff --git a/src/lisp.h b/src/lisp.h
index 6b068f43c2..7350c534df 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -3269,9 +3269,6 @@ rarely_quit (unsigned short int count)
     maybe_quit ();
 }
 
-extern Lisp_Object Vascii_downcase_table;
-extern Lisp_Object Vascii_canon_table;
-
 /* Call staticpro (&var) to protect static variable `var'.  */
 
 void staticpro (Lisp_Object *);
@@ -4161,6 +4158,13 @@ extern Lisp_Object set_marker_both (Lisp_Object, Lisp_Object, ptrdiff_t, ptrdiff
 extern Lisp_Object set_marker_restricted_both (Lisp_Object, Lisp_Object,
                                                ptrdiff_t, ptrdiff_t);
 
+/* Defined in casetab.rs.  */
+
+extern void init_casetab_once (void);
+extern void syms_of_casetab (void);
+extern Lisp_Object get_downcase_table (void);
+extern Lisp_Object get_canonical_case_table (void);
+
 /* Defined in fileio.c.  */
 
 extern bool check_executable (char *);
@@ -4206,7 +4210,7 @@ fast_string_match (Lisp_Object regexp, Lisp_Object string)
 INLINE ptrdiff_t
 fast_string_match_ignore_case (Lisp_Object regexp, Lisp_Object string)
 {
-  return fast_string_match_internal (regexp, string, Vascii_canon_table);
+  return fast_string_match_internal (regexp, string, get_canonical_case_table());
 }
 
 extern ptrdiff_t fast_c_string_match_ignore_case (Lisp_Object, const char *,
@@ -4250,12 +4254,6 @@ ptrdiff_t casify_region (enum case_action flag, Lisp_Object b, Lisp_Object e);
 extern void syms_of_casefiddle (void);
 extern void keys_of_casefiddle (void);
 
-/* Defined in casetab.c.  */
-
-extern Lisp_Object set_case_table (Lisp_Object, bool);
-extern void init_casetab_once (void);
-extern void syms_of_casetab (void);
-
 /* Defined in keyboard.c.  */
 extern bool get_input_pending (int);
 extern void process_special_events (void);
diff --git a/src/search.c b/src/search.c
index cbfdb066e0..bbab29eb0f 100644
--- a/src/search.c
+++ b/src/search.c
@@ -454,7 +454,7 @@ fast_c_string_match_ignore_case (Lisp_Object regexp,
   regexp = string_make_unibyte (regexp);
   re_match_object = Qt;
   bufp = compile_pattern (regexp, 0,
-			  Vascii_canon_table, 0,
+			  get_canonical_case_table(), 0,
 			  0);
   val = re_search (bufp, string, len, 0, len, 0);
   return val;
-- 
2.21.0


From bd2ee9666d3a5ba78fb4106594045f0d9d8a9bba Mon Sep 17 00:00:00 2001
From: muku takeda <mukuact@users.noreply.github.com>
Date: Sun, 24 Feb 2019 21:09:12 +0900
Subject: [PATCH 286/297] port error-message-string (#1231)

port error-message-string
---
 rust_src/src/lib.rs   |  1 +
 rust_src/src/print.rs | 49 +++++++++++++++++++++++++++++++++++++++++++
 src/print.c           | 32 ----------------------------
 3 files changed, 50 insertions(+), 32 deletions(-)
 create mode 100644 rust_src/src/print.rs

diff --git a/rust_src/src/lib.rs b/rust_src/src/lib.rs
index c2eb6bc94f..4c8097d085 100644
--- a/rust_src/src/lib.rs
+++ b/rust_src/src/lib.rs
@@ -104,6 +104,7 @@ mod multibyte;
 mod numbers;
 mod obarray;
 mod objects;
+mod print;
 mod process;
 mod profiler;
 #[allow(clippy::all)]
diff --git a/rust_src/src/print.rs b/rust_src/src/print.rs
new file mode 100644
index 0000000000..76acba907c
--- /dev/null
+++ b/rust_src/src/print.rs
@@ -0,0 +1,49 @@
+//! Lisp object printing and output
+
+use remacs_macros::lisp_fn;
+
+use crate::{
+    buffers::LispBufferRef,
+    lisp::LispObject,
+    lists::LispCons,
+    remacs_sys::Vprin1_to_string_buffer,
+    remacs_sys::{print_error_message, set_buffer_internal, Fbuffer_string, Ferase_buffer},
+    remacs_sys::{Qerror, Qnil},
+    threads::ThreadState,
+};
+
+/// Convert an error value (ERROR-SYMBOL . DATA) to an error message.
+/// See Info anchor `(elisp)Definition of signal' for some details on how this
+/// error message is constructed.
+#[lisp_fn]
+pub fn error_message_string(obj: LispCons) -> LispObject {
+    let mut old = ThreadState::current_buffer_unchecked();
+    let value: LispObject;
+
+    // If OBJ is (error STRING), just return STRING.
+    // That is not only faster, it also avoids the need to allocate
+    // space here when the error is due to memory full.
+    match obj.into() {
+        (error, data) if error.eq(Qerror) => {
+            if let Some((string, nil)) = data.into() {
+                if string.is_string() && nil.is_nil() {
+                    return string;
+                }
+            }
+        }
+        _ => {}
+    }
+
+    unsafe {
+        print_error_message(obj.into(), Vprin1_to_string_buffer, std::ptr::null(), Qnil);
+
+        set_buffer_internal(LispBufferRef::from(Vprin1_to_string_buffer).as_mut());
+        value = Fbuffer_string();
+
+        Ferase_buffer();
+        set_buffer_internal(old.as_mut());
+    }
+    value
+}
+
+include!(concat!(env!("OUT_DIR"), "/print_exports.rs"));
diff --git a/src/print.c b/src/print.c
index a8bbb9d37a..a1f8582070 100644
--- a/src/print.c
+++ b/src/print.c
@@ -855,37 +855,6 @@ safe_debug_print (Lisp_Object arg)
     }
 }
 
-
-DEFUN ("error-message-string", Ferror_message_string, Serror_message_string,
-       1, 1, 0,
-       doc: /* Convert an error value (ERROR-SYMBOL . DATA) to an error message.
-See Info anchor `(elisp)Definition of signal' for some details on how this
-error message is constructed.  */)
-  (Lisp_Object obj)
-{
-  struct buffer *old = current_buffer;
-  Lisp_Object value;
-
-  /* If OBJ is (error STRING), just return STRING.
-     That is not only faster, it also avoids the need to allocate
-     space here when the error is due to memory full.  */
-  if (CONSP (obj) && EQ (XCAR (obj), Qerror)
-      && CONSP (XCDR (obj))
-      && STRINGP (XCAR (XCDR (obj)))
-      && NILP (XCDR (XCDR (obj))))
-    return XCAR (XCDR (obj));
-
-  print_error_message (obj, Vprin1_to_string_buffer, 0, Qnil);
-
-  set_buffer_internal (XBUFFER (Vprin1_to_string_buffer));
-  value = Fbuffer_string ();
-
-  Ferase_buffer ();
-  set_buffer_internal (old);
-
-  return value;
-}
-
 /* Print an error message for the error DATA onto Lisp output stream
    STREAM (suitable for the print functions).
    CONTEXT is a C string describing the context of the error.
@@ -2439,7 +2408,6 @@ priorities.  */);
 
   defsubr (&Sprin1);
   defsubr (&Sprin1_to_string);
-  defsubr (&Serror_message_string);
   defsubr (&Sprinc);
   defsubr (&Sprint);
   defsubr (&Sterpri);
-- 
2.21.0


From b2de14288591ab4e3af34a5045e22617760a39c1 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Saulius=20Menkevi=C4=8Dius?=
 <sauliusmenkevicius@fastmail.com>
Date: Sun, 24 Feb 2019 18:56:43 +0200
Subject: [PATCH 287/297] Port window-pixel-top

---
 rust_src/src/windows.rs | 8 ++++++++
 src/window.c            | 9 ---------
 2 files changed, 8 insertions(+), 9 deletions(-)

diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 6d66187be7..105c278de8 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -1751,4 +1751,12 @@ pub fn window_lines_pixel_dimensions(
     unsafe { Fnreverse(rows) }
 }
 
+/// Return top pixel edge of window WINDOW.
+/// WINDOW must be a valid window and defaults to the selected one.
+#[lisp_fn(min = "0")]
+pub fn window_pixel_top(window: LispWindowValidOrSelected) -> EmacsInt {
+    let window: LispWindowRef = window.into();
+    window.pixel_top.into()
+}
+
 include!(concat!(env!("OUT_DIR"), "/windows_exports.rs"));
diff --git a/src/window.c b/src/window.c
index 2128d58f22..16fe7637f3 100644
--- a/src/window.c
+++ b/src/window.c
@@ -500,14 +500,6 @@ WINDOW must be a valid window and defaults to the selected one.  */)
   return make_number (decode_valid_window (window)->pixel_left);
 }
 
-DEFUN ("window-pixel-top", Fwindow_pixel_top, Swindow_pixel_top, 0, 1, 0,
-       doc: /* Return top pixel edge of window WINDOW.
-WINDOW must be a valid window and defaults to the selected one.  */)
-  (Lisp_Object window)
-{
-  return make_number (decode_valid_window (window)->pixel_top);
-}
-
 DEFUN ("window-left-column", Fwindow_left_column, Swindow_left_column, 0, 1, 0,
        doc: /* Return left column of window WINDOW.
 This is the distance, in columns, between the left edge of WINDOW and
@@ -6411,7 +6403,6 @@ displayed after a scrolling operation to be somewhat inaccurate.  */);
   defsubr (&Swindow_pixel_height_before_size_change);
   defsubr (&Swindow_normal_size);
   defsubr (&Swindow_pixel_left);
-  defsubr (&Swindow_pixel_top);
   defsubr (&Swindow_left_column);
   defsubr (&Sset_window_new_pixel);
   defsubr (&Sset_window_new_normal);
-- 
2.21.0


From 950f488504cbf33977e5a3c7bd2852f6177f7bc8 Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Mon, 25 Feb 2019 09:49:33 -0800
Subject: [PATCH 288/297] Refactor charpos and bytepos functions. (#1353)

Convert the core logic to methods on `LispBufferRef`.
Update exported functions to use the methods.

This removes a few more unsafes. No logic was touched.
---
 rust_src/src/base64.rs     |  11 +-
 rust_src/src/buffers.rs    | 268 ++++++++++++++++++++++++++-
 rust_src/src/decompress.rs |   8 +-
 rust_src/src/editfns.rs    |  27 ++-
 rust_src/src/marker.rs     | 363 +++++--------------------------------
 5 files changed, 332 insertions(+), 345 deletions(-)

diff --git a/rust_src/src/base64.rs b/rust_src/src/base64.rs
index 6de9122324..2428a9538c 100644
--- a/rust_src/src/base64.rs
+++ b/rust_src/src/base64.rs
@@ -10,7 +10,6 @@ use crate::{
     base64_crate,
     buffers::validate_region_rust,
     lisp::LispObject,
-    marker::buf_charpos_to_bytepos,
     multibyte::{multibyte_char_at, raw_byte_from_codepoint, LispStringRef, MAX_5_BYTE_CHAR},
     remacs_sys::EmacsInt,
     remacs_sys::{
@@ -271,11 +270,11 @@ pub fn base64_decode_string(string: LispStringRef) -> LispObject {
 #[lisp_fn(min = "2", intspec = "r")]
 pub fn base64_encode_region(beg: LispObject, end: LispObject, no_line_break: bool) -> EmacsInt {
     let (beg, end) = validate_region_rust(beg, end);
-    let mut current_buffer = ThreadState::current_buffer_unchecked();
+    let current_buffer = ThreadState::current_buffer_unchecked();
     let old_pos = current_buffer.pt;
 
-    let begpos = buf_charpos_to_bytepos(current_buffer.as_mut(), beg);
-    let endpos = buf_charpos_to_bytepos(current_buffer.as_mut(), end);
+    let begpos = current_buffer.charpos_to_bytepos(beg);
+    let endpos = current_buffer.charpos_to_bytepos(end);
 
     unsafe { move_gap_both(beg, begpos) };
 
@@ -316,8 +315,8 @@ pub fn base64_decode_region(beg: LispObject, end: LispObject) -> EmacsInt {
     let mut current_buffer = ThreadState::current_buffer_unchecked();
     let mut old_pos = current_buffer.pt;
 
-    let begpos = buf_charpos_to_bytepos(current_buffer.as_mut(), beg);
-    let endpos = buf_charpos_to_bytepos(current_buffer.as_mut(), end);
+    let begpos = current_buffer.charpos_to_bytepos(beg);
+    let endpos = current_buffer.charpos_to_bytepos(end);
 
     let multibyte = current_buffer.multibyte_characters_enabled();
     let length = (endpos - begpos) as usize;
diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 6f833b3b85..a8ab00c061 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -21,8 +21,11 @@ use crate::{
     lisp::{ExternalPtr, LispMiscRef, LispObject, LispStructuralEqual, LiveBufferIter},
     lists::{car, cdr, list, member, rassq, setcar},
     lists::{CarIter, LispConsCircularChecks, LispConsEndChecks},
-    marker::{build_marker, marker_buffer, marker_position_lisp, set_marker_both, LispMarkerRef},
-    multibyte::{multibyte_length_by_head, string_char},
+    marker::{
+        build_marker, build_marker_rust, marker_buffer, marker_position_lisp, set_marker_both,
+        LispMarkerRef, MARKER_DEBUG,
+    },
+    multibyte::{multibyte_chars_in_text, multibyte_length_by_head, string_char},
     multibyte::{LispStringRef, LispSymbolOrString},
     numbers::MOST_POSITIVE_FIXNUM,
     obarray::intern,
@@ -366,6 +369,246 @@ impl LispBufferRef {
         unsafe { (*self.text).z }
     }
 
+    pub fn bytepos_to_charpos(mut self, bytepos: isize) -> isize {
+        assert!(self.beg_byte() <= bytepos && bytepos <= self.z_byte());
+
+        let mut best_above = self.z();
+        let mut best_above_byte = self.z_byte();
+
+        // If this buffer has as many characters as bytes,
+        // each character must be one byte.
+        // This takes care of the case where enable-multibyte-characters is nil.
+        if best_above == best_above_byte {
+            return bytepos;
+        }
+
+        let mut best_below = self.beg();
+        let mut best_below_byte = self.beg_byte();
+
+        macro_rules! consider_known {
+            ($bpos:expr, $cpos:expr) => {
+                let mut changed = false;
+                if $bpos == bytepos {
+                    if MARKER_DEBUG {
+                        byte_char_debug_check(self, $cpos, bytepos);
+                    }
+                    return $cpos;
+                } else if $bpos > bytepos {
+                    if $bpos < best_above_byte {
+                        best_above = $cpos;
+                        best_above_byte = $bpos;
+                        changed = true;
+                    }
+                } else if $bpos > best_below_byte {
+                    best_below = $cpos;
+                    best_below_byte = $bpos;
+                    changed = true;
+                }
+                if changed {
+                    if best_above - best_below == best_above_byte - best_below_byte {
+                        return best_below + (bytepos - best_below_byte);
+                    }
+                }
+            };
+        }
+
+        consider_known!(self.pt_byte, self.pt);
+        consider_known!(self.gpt_byte(), self.gpt());
+        consider_known!(self.begv_byte, self.begv);
+        consider_known!(self.zv_byte, self.zv);
+
+        if self.is_cached && self.modifications() == self.cached_modiff {
+            consider_known!(self.cached_bytepos, self.cached_charpos);
+        }
+
+        for m in self.markers().iter() {
+            consider_known!(m.bytepos_or_error(), m.charpos_or_error());
+            // If we are down to a range of 50 chars,
+            // don't bother checking any other markers;
+            // scan the intervening chars directly now.
+            if best_above - best_below < 50 {
+                break;
+            }
+        }
+
+        // We get here if we did not exactly hit one of the known places.
+        // We have one known above and one known below.
+        // Scan, counting characters, from whichever one is closer.
+
+        if bytepos - best_below_byte < best_above_byte - bytepos {
+            let record = bytepos - best_below_byte > 5000;
+
+            while best_below_byte < bytepos {
+                best_below += 1;
+                best_below_byte = self.inc_pos(best_below_byte);
+            }
+
+            // If this position is quite far from the nearest known position,
+            // cache the correspondence by creating a marker here.
+            // It will last until the next GC.
+            // But don't do it if BUF_MARKERS is nil;
+            // that is a signal from Fset_buffer_multibyte.
+            if record && self.markers().is_some() {
+                build_marker_rust(self, best_below, best_below_byte);
+            }
+            if MARKER_DEBUG {
+                byte_char_debug_check(self, best_below, best_below_byte);
+            }
+
+            self.is_cached = true;
+            self.cached_modiff = self.modifications();
+
+            self.cached_charpos = best_below;
+            self.cached_bytepos = best_below_byte;
+
+            best_below
+        } else {
+            let record = best_above_byte - bytepos > 5000;
+
+            while best_above_byte > bytepos {
+                best_above -= 1;
+                best_above_byte = self.dec_pos(best_above_byte);
+            }
+
+            // If this position is quite far from the nearest known position,
+            // cache the correspondence by creating a marker here.
+            // It will last until the next GC.
+            // But don't do it if BUF_MARKERS is nil;
+            // that is a signal from Fset_buffer_multibyte.
+            if record && self.markers().is_some() {
+                build_marker_rust(self, best_below, best_below_byte);
+            }
+            if MARKER_DEBUG {
+                byte_char_debug_check(self, best_below, best_below_byte);
+            }
+
+            self.is_cached = true;
+            self.cached_modiff = self.modifications();
+
+            self.cached_charpos = best_above;
+            self.cached_bytepos = best_above_byte;
+
+            best_above
+        }
+    }
+
+    pub fn charpos_to_bytepos(mut self, charpos: isize) -> isize {
+        assert!(self.beg() <= charpos && charpos <= self.z());
+
+        let mut best_above = self.z();
+        let mut best_above_byte = self.z_byte();
+
+        // If this buffer has as many characters as bytes,
+        // each character must be one byte.
+        // This takes care of the case where enable-multibyte-characters is nil.
+        if best_above == best_above_byte {
+            return charpos;
+        }
+
+        let mut best_below = self.beg();
+        let mut best_below_byte = self.beg_byte();
+
+        // We find in best_above and best_above_byte
+        // the closest known point above CHARPOS,
+        // and in best_below and best_below_byte
+        // the closest known point below CHARPOS,
+        //
+        // If at any point we can tell that the space between those
+        // two best approximations is all single-byte,
+        // we interpolate the result immediately.
+
+        macro_rules! consider_known {
+            ($cpos:expr, $bpos:expr) => {
+                let mut changed = false;
+                if $cpos == charpos {
+                    if MARKER_DEBUG {
+                        byte_char_debug_check(self, charpos, $bpos);
+                    }
+                    return $bpos;
+                } else if $cpos > charpos {
+                    if $cpos < best_above {
+                        best_above = $cpos;
+                        best_above_byte = $bpos;
+                        changed = true;
+                    }
+                } else if $cpos > best_below {
+                    best_below = $cpos;
+                    best_below_byte = $bpos;
+                    changed = true;
+                }
+                if changed {
+                    if best_above - best_below == best_above_byte - best_below_byte {
+                        return best_below_byte + (charpos - best_below);
+                    }
+                }
+            };
+        }
+
+        consider_known!(self.pt, self.pt_byte);
+        consider_known!(self.gpt(), self.gpt_byte());
+        consider_known!(self.begv, self.begv_byte);
+        consider_known!(self.zv, self.zv_byte);
+
+        if self.is_cached && self.modifications() == self.cached_modiff {
+            consider_known!(self.cached_charpos, self.cached_bytepos);
+        }
+
+        for m in self.markers().iter() {
+            consider_known!(m.charpos_or_error(), m.bytepos_or_error());
+            // If we are down to a range of 50 chars,
+            // don't bother checking any other markers;
+            // scan the intervening chars directly now.
+            if best_above - best_below < 50 {
+                break;
+            }
+        }
+
+        if charpos - best_below < best_above - charpos {
+            let record = charpos - best_below > 5000;
+
+            while best_below != charpos {
+                best_below += 1;
+                best_below_byte = self.inc_pos(best_below_byte);
+            }
+            if record {
+                build_marker_rust(self, best_below, best_below_byte);
+            }
+            if MARKER_DEBUG {
+                byte_char_debug_check(self, best_below, best_below_byte);
+            }
+
+            self.is_cached = true;
+            self.cached_modiff = self.modifications();
+
+            self.cached_charpos = best_below;
+            self.cached_bytepos = best_below_byte;
+
+            best_below_byte
+        } else {
+            let record = best_above - charpos > 5000;
+
+            while best_above != charpos {
+                best_above -= 1;
+                best_above_byte = self.dec_pos(best_above_byte);
+            }
+
+            if record {
+                build_marker_rust(self, best_above, best_above_byte);
+            }
+            if MARKER_DEBUG {
+                byte_char_debug_check(self, best_below, best_below_byte);
+            }
+
+            self.is_cached = true;
+            self.cached_modiff = self.modifications();
+
+            self.cached_charpos = best_above;
+            self.cached_bytepos = best_above_byte;
+
+            best_above_byte
+        }
+    }
+
     pub fn local_vars_iter(self) -> CarIter {
         let vars = self.local_var_alist_;
         vars.iter_cars(LispConsEndChecks::off, LispConsCircularChecks::off)
@@ -1301,4 +1544,25 @@ pub fn rename_buffer(newname: LispStringRef, unique: LispObject) -> LispStringRe
     ThreadState::current_buffer_unchecked().name_.into()
 }
 
+// Debugging
+
+pub fn byte_char_debug_check(b: LispBufferRef, charpos: isize, bytepos: isize) {
+    if !b.multibyte_characters_enabled() {
+        return;
+    }
+
+    let nchars = unsafe {
+        if bytepos > b.gpt_byte() {
+            multibyte_chars_in_text(b.beg_addr(), b.gpt_byte() - b.beg_byte())
+                + multibyte_chars_in_text(b.gap_end_addr(), bytepos - b.gpt_byte())
+        } else {
+            multibyte_chars_in_text(b.beg_addr(), bytepos - b.beg_byte())
+        }
+    };
+
+    if charpos - 1 != nchars {
+        panic!("byte_char_debug_check failed.")
+    }
+}
+
 include!(concat!(env!("OUT_DIR"), "/buffers_exports.rs"));
diff --git a/rust_src/src/decompress.rs b/rust_src/src/decompress.rs
index bf76ee1fcc..c7f4a9fabb 100644
--- a/rust_src/src/decompress.rs
+++ b/rust_src/src/decompress.rs
@@ -10,8 +10,8 @@ use crate::{
     buffers::validate_region_rust,
     lisp::LispObject,
     remacs_sys::{
-        buf_charpos_to_bytepos, del_range_2, insert_from_gap, make_gap, maybe_quit, modify_text,
-        move_gap_both, signal_after_change, update_compositions, CHECK_HEAD,
+        del_range_2, insert_from_gap, make_gap, maybe_quit, modify_text, move_gap_both,
+        signal_after_change, update_compositions, CHECK_HEAD,
     },
     threads::ThreadState,
 };
@@ -63,7 +63,7 @@ pub fn zlib_decompress_region(start: LispObject, end: LispObject) -> bool {
 
     // Insert the decompressed data at the end of the compressed data.
     let charpos = end;
-    let bytepos = unsafe { buf_charpos_to_bytepos(current_buffer.as_mut(), end) };
+    let bytepos = current_buffer.charpos_to_bytepos(end);
     let old_pt = current_buffer.pt;
     current_buffer.set_pt_both(charpos, bytepos);
 
@@ -142,7 +142,7 @@ pub fn zlib_decompress_region(start: LispObject, end: LispObject) -> bool {
                 // compressed data is bigger than the uncompressed, at
                 // point-max.
                 let charpos = min(old_pt, current_buffer.zv);
-                let bytepos = unsafe { buf_charpos_to_bytepos(current_buffer.as_mut(), charpos) };
+                let bytepos = current_buffer.charpos_to_bytepos(charpos);
                 current_buffer.set_pt_both(charpos, bytepos);
 
                 return false;
diff --git a/rust_src/src/editfns.rs b/rust_src/src/editfns.rs
index 32b863d0a3..b9fda3583b 100644
--- a/rust_src/src/editfns.rs
+++ b/rust_src/src/editfns.rs
@@ -17,10 +17,7 @@ use crate::{
     eval::{progn, record_unwind_protect, unbind_to},
     indent::invalidate_current_column,
     lisp::LispObject,
-    marker::{
-        buf_bytepos_to_charpos, buf_charpos_to_bytepos, marker_position_lisp, point_marker,
-        set_point_from_marker,
-    },
+    marker::{marker_position_lisp, point_marker, set_point_from_marker},
     multibyte::{
         is_single_byte_char, multibyte_char_at, raw_byte_codepoint, raw_byte_from_codepoint,
         unibyte_to_char, write_codepoint, MAX_MULTIBYTE_LENGTH,
@@ -190,9 +187,9 @@ pub fn goto_char(position: LispObject) -> LispObject {
     if position.is_marker() {
         set_point_from_marker(position);
     } else if let Some(num) = position.as_fixnum() {
-        let mut cur_buf = ThreadState::current_buffer_unchecked();
+        let cur_buf = ThreadState::current_buffer_unchecked();
         let pos = clip_to_bounds(cur_buf.begv, num, cur_buf.zv);
-        let bytepos = buf_charpos_to_bytepos(cur_buf.as_mut(), pos);
+        let bytepos = cur_buf.charpos_to_bytepos(pos);
         unsafe { set_point_both(pos, bytepos) };
     } else {
         wrong_type!(Qinteger_or_marker_p, position)
@@ -205,10 +202,10 @@ pub fn goto_char(position: LispObject) -> LispObject {
 #[lisp_fn]
 pub fn position_bytes(position: LispNumber) -> Option<EmacsInt> {
     let pos = position.to_fixnum() as ptrdiff_t;
-    let mut cur_buf = ThreadState::current_buffer_unchecked();
+    let cur_buf = ThreadState::current_buffer_unchecked();
 
     if pos >= cur_buf.begv && pos <= cur_buf.zv {
-        let bytepos = buf_charpos_to_bytepos(cur_buf.as_mut(), pos);
+        let bytepos = cur_buf.charpos_to_bytepos(pos);
         Some(bytepos as EmacsInt)
     } else {
         None
@@ -345,7 +342,7 @@ pub fn preceding_char() -> EmacsInt {
 /// If POS is out of range, the value is nil.
 #[lisp_fn(min = "0")]
 pub fn char_before(pos: LispObject) -> Option<EmacsInt> {
-    let mut buffer_ref = ThreadState::current_buffer_unchecked();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
     let pos_byte: isize;
 
     if pos.is_nil() {
@@ -366,7 +363,7 @@ pub fn char_before(pos: LispObject) -> Option<EmacsInt> {
         if p <= buffer_ref.begv || p > buffer_ref.zv {
             return None;
         }
-        pos_byte = buf_charpos_to_bytepos(buffer_ref.as_mut(), p);
+        pos_byte = buffer_ref.charpos_to_bytepos(p);
     }
 
     let pos_before = if buffer_ref.multibyte_characters_enabled() {
@@ -382,7 +379,7 @@ pub fn char_before(pos: LispObject) -> Option<EmacsInt> {
 /// If POS is out of range, the value is nil.
 #[lisp_fn(min = "0")]
 pub fn char_after(mut pos: LispObject) -> Option<EmacsInt> {
-    let mut buffer_ref = ThreadState::current_buffer_unchecked();
+    let buffer_ref = ThreadState::current_buffer_unchecked();
     if pos.is_nil() {
         pos = point().into();
     }
@@ -400,7 +397,7 @@ pub fn char_after(mut pos: LispObject) -> Option<EmacsInt> {
         if p < buffer_ref.begv || p >= buffer_ref.zv {
             None
         } else {
-            let pos_byte = buf_charpos_to_bytepos(buffer_ref.as_mut(), p);
+            let pos_byte = buffer_ref.charpos_to_bytepos(p);
             Some(EmacsInt::from(buffer_ref.fetch_char(pos_byte)))
         }
     }
@@ -741,7 +738,7 @@ pub fn constrain_to_field(
 /// If BYTEPOS is out of range, the value is nil.
 #[lisp_fn]
 pub fn byte_to_position(bytepos: EmacsInt) -> Option<EmacsInt> {
-    let mut cur_buf = ThreadState::current_buffer_unchecked();
+    let cur_buf = ThreadState::current_buffer_unchecked();
     let mut pos_byte = bytepos as isize;
     if pos_byte < cur_buf.beg_byte() || pos_byte > cur_buf.z_byte() {
         return None;
@@ -756,7 +753,7 @@ pub fn byte_to_position(bytepos: EmacsInt) -> Option<EmacsInt> {
         }
     }
 
-    Some(unsafe { buf_bytepos_to_charpos(cur_buf.as_mut(), pos_byte) } as EmacsInt)
+    Some(cur_buf.bytepos_to_charpos(pos_byte) as EmacsInt)
 }
 
 /// Return t if two characters match, optionally ignoring case.
@@ -1116,7 +1113,7 @@ pub extern "C" fn save_excursion_save() -> LispObject {
 
     unsafe {
         make_save_obj_obj_obj_obj(
-            point_marker(),
+            point_marker().into(),
             Qnil,
             // Selected window if current buffer is shown in it, nil otherwise.
             if window.contents.eq(current_buffer()) {
diff --git a/rust_src/src/marker.rs b/rust_src/src/marker.rs
index fbf49761b6..d089bc876c 100644
--- a/rust_src/src/marker.rs
+++ b/rust_src/src/marker.rs
@@ -10,7 +10,6 @@ use crate::{
     buffers::{current_buffer, LispBufferRef},
     hashtable::LispHashTableRef,
     lisp::{ExternalPtr, LispMiscRef, LispObject, LispStructuralEqual},
-    multibyte::multibyte_chars_in_text,
     remacs_sys::{allocate_misc, set_point_both, Fmake_marker},
     remacs_sys::{equal_kind, EmacsInt, Lisp_Buffer, Lisp_Marker, Lisp_Misc_Type, Lisp_Type},
     remacs_sys::{Qinteger_or_marker_p, Qmarkerp},
@@ -20,11 +19,7 @@ use crate::{
 
 pub type LispMarkerRef = ExternalPtr<Lisp_Marker>;
 
-#[cfg(MARKER_DEBUG)]
-const MARKER_DEBUG: bool = true;
-
-#[cfg(not(MARKER_DEBUG))]
-const MARKER_DEBUG: bool = false;
+pub const MARKER_DEBUG: bool = cfg!(MARKER_DEBUG);
 
 impl LispMarkerRef {
     pub fn charpos(self) -> Option<isize> {
@@ -193,70 +188,81 @@ pub extern "C" fn build_marker(
     charpos: ptrdiff_t,
     bytepos: ptrdiff_t,
 ) -> LispObject {
-    debug_assert!(unsafe { (*buf).name_.is_not_nil() });
-    debug_assert!(charpos <= bytepos);
+    let buffer = LispBufferRef::from_ptr(buf as *mut c_void)
+        .unwrap_or_else(|| panic!("Invalid buffer reference."));
+    build_marker_rust(buffer, charpos as isize, bytepos as isize).into()
+}
 
-    let obj = unsafe { allocate_misc(Lisp_Misc_Type::Lisp_Misc_Marker) };
-    let mut m: LispMarkerRef = obj.into();
+pub fn build_marker_rust(
+    mut buffer: LispBufferRef,
+    charpos: isize,
+    bytepos: isize,
+) -> LispMarkerRef {
+    debug_assert!(buffer.name_.is_not_nil());
+    debug_assert!(charpos <= bytepos);
 
-    m.set_buffer(buf);
-    m.set_charpos(charpos);
-    m.set_bytepos(bytepos);
-    m.set_insertion_type(false);
-    m.set_need_adjustment(false);
+    let mut marker: LispMarkerRef =
+        unsafe { allocate_misc(Lisp_Misc_Type::Lisp_Misc_Marker) }.into();
 
-    let mut buffer_ref = LispBufferRef::from_ptr(buf as *mut c_void)
-        .unwrap_or_else(|| panic!("Invalid buffer reference."));
+    marker.set_buffer(buffer.as_mut());
+    marker.set_charpos(charpos);
+    marker.set_bytepos(bytepos);
+    marker.set_insertion_type(false);
+    marker.set_need_adjustment(false);
 
     unsafe {
-        m.set_next((*buffer_ref.text).markers);
-        (*buffer_ref.text).markers = m.as_mut();
+        marker.set_next((*buffer.text).markers);
+        (*buffer.text).markers = marker.as_mut();
     }
 
-    obj
+    marker
 }
 
 /// Return value of point, as a marker object.
 #[lisp_fn]
-pub fn point_marker() -> LispObject {
-    let mut cur_buf = ThreadState::current_buffer_unchecked();
-    build_marker(cur_buf.as_mut(), cur_buf.pt, cur_buf.pt_byte)
+pub fn point_marker() -> LispMarkerRef {
+    let cur_buf = ThreadState::current_buffer_unchecked();
+    build_marker_rust(cur_buf, cur_buf.pt, cur_buf.pt_byte)
 }
 
 /// Return a marker to the minimum permissible value of point in this buffer.
 /// This is the beginning, unless narrowing (a buffer restriction) is in effect.
 #[lisp_fn]
-pub fn point_min_marker() -> LispObject {
-    let mut cur_buf = ThreadState::current_buffer_unchecked();
-    build_marker(cur_buf.as_mut(), cur_buf.begv, cur_buf.begv_byte)
+pub fn point_min_marker() -> LispMarkerRef {
+    let cur_buf = ThreadState::current_buffer_unchecked();
+    build_marker_rust(cur_buf, cur_buf.begv, cur_buf.begv_byte)
 }
 
 /// Return a marker to the maximum permissible value of point in this buffer.
 /// This is (1+ (buffer-size)), unless narrowing (a buffer restriction)
 /// is in effect, in which case it is less.
 #[lisp_fn]
-pub fn point_max_marker() -> LispObject {
-    let mut cur_buf = ThreadState::current_buffer_unchecked();
-    build_marker(cur_buf.as_mut(), cur_buf.zv, cur_buf.zv_byte)
+pub fn point_max_marker() -> LispMarkerRef {
+    let cur_buf = ThreadState::current_buffer_unchecked();
+    build_marker_rust(cur_buf, cur_buf.zv, cur_buf.zv_byte)
 }
 
 /// Set PT from MARKER's clipped position.
 #[no_mangle]
 pub extern "C" fn set_point_from_marker(marker: LispObject) {
     let marker: LispMarkerRef = marker.into();
-    let mut cur_buf = ThreadState::current_buffer_unchecked();
+    let cur_buf = ThreadState::current_buffer_unchecked();
     let charpos = clip_to_bounds(
         cur_buf.begv,
         marker.charpos_or_error() as EmacsInt,
         cur_buf.zv,
     );
-    let mut bytepos = marker.bytepos_or_error();
+
     // Don't trust the byte position if the marker belongs to a
     // different buffer.
-    if marker.buffer().map_or(false, |b| b != cur_buf) {
-        bytepos = buf_charpos_to_bytepos(cur_buf.as_mut(), charpos);
+    let bytepos = if marker.buffer().map_or(false, |b| b != cur_buf) {
+        cur_buf.charpos_to_bytepos(charpos)
     } else {
-        bytepos = clip_to_bounds(cur_buf.begv_byte, bytepos as EmacsInt, cur_buf.zv_byte);
+        clip_to_bounds(
+            cur_buf.begv_byte,
+            marker.bytepos_or_error() as EmacsInt,
+            cur_buf.zv_byte,
+        )
     };
     unsafe { set_point_both(charpos, bytepos) };
 }
@@ -552,7 +558,7 @@ fn set_marker_internal_else(
             .as_marker()
             .map_or(false, |m| m.buffer() == Some(buf))
     {
-        bytepos = buf_charpos_to_bytepos(buf.as_mut(), charpos);
+        bytepos = buf.charpos_to_bytepos(charpos);
     } else {
         let beg = buf.buffer_beg_byte(restricted);
         let end = buf.buffer_end_byte(restricted);
@@ -605,248 +611,14 @@ impl LispBufferRef {
 /// Return the byte position corresponding to CHARPOS in B.
 #[no_mangle]
 pub extern "C" fn buf_charpos_to_bytepos(b: *mut Lisp_Buffer, charpos: isize) -> isize {
-    let mut buffer_ref = LispBufferRef::from_ptr(b as *mut c_void).unwrap();
-
-    assert!(buffer_ref.beg() <= charpos && charpos <= buffer_ref.z());
-
-    let mut best_above = buffer_ref.z();
-    let mut best_above_byte = buffer_ref.z_byte();
-
-    // If this buffer has as many characters as bytes,
-    // each character must be one byte.
-    // This takes care of the case where enable-multibyte-characters is nil.
-    if best_above == best_above_byte {
-        return charpos;
-    }
-
-    let mut best_below = buffer_ref.beg();
-    let mut best_below_byte = buffer_ref.beg_byte();
-
-    // We find in best_above and best_above_byte
-    // the closest known point above CHARPOS,
-    // and in best_below and best_below_byte
-    // the closest known point below CHARPOS,
-    //
-    // If at any point we can tell that the space between those
-    // two best approximations is all single-byte,
-    // we interpolate the result immediately.
-
-    macro_rules! consider_known {
-        ($cpos:expr, $bpos:expr) => {
-            let mut changed = false;
-            if $cpos == charpos {
-                if MARKER_DEBUG {
-                    byte_char_debug_check(buffer_ref, charpos, $bpos);
-                }
-                return $bpos;
-            } else if $cpos > charpos {
-                if $cpos < best_above {
-                    best_above = $cpos;
-                    best_above_byte = $bpos;
-                    changed = true;
-                }
-            } else if $cpos > best_below {
-                best_below = $cpos;
-                best_below_byte = $bpos;
-                changed = true;
-            }
-            if changed {
-                if best_above - best_below == best_above_byte - best_below_byte {
-                    return best_below_byte + (charpos - best_below);
-                }
-            }
-        };
-    }
-
-    consider_known!(buffer_ref.pt, buffer_ref.pt_byte);
-    consider_known!(buffer_ref.gpt(), buffer_ref.gpt_byte());
-    consider_known!(buffer_ref.begv, buffer_ref.begv_byte);
-    consider_known!(buffer_ref.zv, buffer_ref.zv_byte);
-
-    if buffer_ref.is_cached && buffer_ref.modifications() == buffer_ref.cached_modiff {
-        consider_known!(buffer_ref.cached_charpos, buffer_ref.cached_bytepos);
-    }
-
-    for m in buffer_ref.markers().iter() {
-        consider_known!(m.charpos_or_error(), m.bytepos_or_error());
-        // If we are down to a range of 50 chars,
-        // don't bother checking any other markers;
-        // scan the intervening chars directly now.
-        if best_above - best_below < 50 {
-            break;
-        }
-    }
-
-    if charpos - best_below < best_above - charpos {
-        let record = charpos - best_below > 5000;
-
-        while best_below != charpos {
-            best_below += 1;
-            best_below_byte = buffer_ref.inc_pos(best_below_byte);
-        }
-        if record {
-            build_marker(b, best_below, best_below_byte);
-        }
-        if MARKER_DEBUG {
-            byte_char_debug_check(buffer_ref, best_below, best_below_byte);
-        }
-
-        buffer_ref.is_cached = true;
-        buffer_ref.cached_modiff = buffer_ref.modifications();
-
-        buffer_ref.cached_charpos = best_below;
-        buffer_ref.cached_bytepos = best_below_byte;
-
-        best_below_byte
-    } else {
-        let record = best_above - charpos > 5000;
-
-        while best_above != charpos {
-            best_above -= 1;
-            best_above_byte = buffer_ref.dec_pos(best_above_byte);
-        }
-
-        if record {
-            build_marker(b, best_above, best_above_byte);
-        }
-        if MARKER_DEBUG {
-            byte_char_debug_check(buffer_ref, best_below, best_below_byte);
-        }
-
-        buffer_ref.is_cached = true;
-        buffer_ref.cached_modiff = buffer_ref.modifications();
-
-        buffer_ref.cached_charpos = best_above;
-        buffer_ref.cached_bytepos = best_above_byte;
-
-        best_above_byte
-    }
+    let buffer = LispBufferRef::from_ptr(b as *mut c_void).unwrap();
+    buffer.charpos_to_bytepos(charpos)
 }
 
 #[no_mangle]
 pub unsafe extern "C" fn buf_bytepos_to_charpos(b: *mut Lisp_Buffer, bytepos: isize) -> isize {
-    let mut buffer_ref = LispBufferRef::from_ptr(b as *mut c_void).unwrap();
-
-    assert!(buffer_ref.beg_byte() <= bytepos && bytepos <= buffer_ref.z_byte());
-
-    let mut best_above = buffer_ref.z();
-    let mut best_above_byte = buffer_ref.z_byte();
-
-    // If this buffer has as many characters as bytes,
-    // each character must be one byte.
-    // This takes care of the case where enable-multibyte-characters is nil.
-    if best_above == best_above_byte {
-        return bytepos;
-    }
-
-    let mut best_below = buffer_ref.beg();
-    let mut best_below_byte = buffer_ref.beg_byte();
-
-    macro_rules! consider_known {
-        ($bpos:expr, $cpos:expr) => {
-            let mut changed = false;
-            if $bpos == bytepos {
-                if MARKER_DEBUG {
-                    byte_char_debug_check(buffer_ref, $cpos, bytepos);
-                }
-                return $cpos;
-            } else if $bpos > bytepos {
-                if $bpos < best_above_byte {
-                    best_above = $cpos;
-                    best_above_byte = $bpos;
-                    changed = true;
-                }
-            } else if $bpos > best_below_byte {
-                best_below = $cpos;
-                best_below_byte = $bpos;
-                changed = true;
-            }
-            if changed {
-                if best_above - best_below == best_above_byte - best_below_byte {
-                    return best_below + (bytepos - best_below_byte);
-                }
-            }
-        };
-    }
-
-    consider_known!(buffer_ref.pt_byte, buffer_ref.pt);
-    consider_known!(buffer_ref.gpt_byte(), buffer_ref.gpt());
-    consider_known!(buffer_ref.begv_byte, buffer_ref.begv);
-    consider_known!(buffer_ref.zv_byte, buffer_ref.zv);
-
-    if buffer_ref.is_cached && buffer_ref.modifications() == buffer_ref.cached_modiff {
-        consider_known!(buffer_ref.cached_bytepos, buffer_ref.cached_charpos);
-    }
-
-    for m in buffer_ref.markers().iter() {
-        consider_known!(m.bytepos_or_error(), m.charpos_or_error());
-        // If we are down to a range of 50 chars,
-        // don't bother checking any other markers;
-        // scan the intervening chars directly now.
-        if best_above - best_below < 50 {
-            break;
-        }
-    }
-
-    // We get here if we did not exactly hit one of the known places.
-    // We have one known above and one known below.
-    // Scan, counting characters, from whichever one is closer.
-
-    if bytepos - best_below_byte < best_above_byte - bytepos {
-        let record = bytepos - best_below_byte > 5000;
-
-        while best_below_byte < bytepos {
-            best_below += 1;
-            best_below_byte = buffer_ref.inc_pos(best_below_byte);
-        }
-
-        // If this position is quite far from the nearest known position,
-        // cache the correspondence by creating a marker here.
-        // It will last until the next GC.
-        // But don't do it if BUF_MARKERS is nil;
-        // that is a signal from Fset_buffer_multibyte.
-        if record && buffer_ref.markers().is_some() {
-            build_marker(b, best_below, best_below_byte);
-        }
-        if MARKER_DEBUG {
-            byte_char_debug_check(buffer_ref, best_below, best_below_byte);
-        }
-
-        buffer_ref.is_cached = true;
-        buffer_ref.cached_modiff = buffer_ref.modifications();
-
-        buffer_ref.cached_charpos = best_below;
-        buffer_ref.cached_bytepos = best_below_byte;
-
-        best_below
-    } else {
-        let record = best_above_byte - bytepos > 5000;
-
-        while best_above_byte > bytepos {
-            best_above -= 1;
-            best_above_byte = buffer_ref.dec_pos(best_above_byte);
-        }
-
-        // If this position is quite far from the nearest known position,
-        // cache the correspondence by creating a marker here.
-        // It will last until the next GC.
-        // But don't do it if BUF_MARKERS is nil;
-        // that is a signal from Fset_buffer_multibyte.
-        if record && buffer_ref.markers().is_some() {
-            build_marker(b, best_below, best_below_byte);
-        }
-        if MARKER_DEBUG {
-            byte_char_debug_check(buffer_ref, best_below, best_below_byte);
-        }
-
-        buffer_ref.is_cached = true;
-        buffer_ref.cached_modiff = buffer_ref.modifications();
-
-        buffer_ref.cached_charpos = best_above;
-        buffer_ref.cached_bytepos = best_above_byte;
-
-        best_above
-    }
+    let buffer = LispBufferRef::from_ptr(b as *mut c_void).unwrap();
+    buffer.bytepos_to_charpos(bytepos)
 }
 
 #[no_mangle]
@@ -856,49 +628,4 @@ pub extern "C" fn clear_charpos_cache(b: *mut Lisp_Buffer) {
     buf_ref.is_cached = false;
 }
 
-// Debugging
-
-fn byte_char_debug_check(b: LispBufferRef, charpos: isize, bytepos: isize) {
-    if !b.multibyte_characters_enabled() {
-        return;
-    }
-
-    let nchars = unsafe {
-        if bytepos > b.gpt_byte() {
-            multibyte_chars_in_text(b.beg_addr(), b.gpt_byte() - b.beg_byte())
-                + multibyte_chars_in_text(b.gap_end_addr(), bytepos - b.gpt_byte())
-        } else {
-            multibyte_chars_in_text(b.beg_addr(), bytepos - b.beg_byte())
-        }
-    };
-
-    if charpos - 1 != nchars {
-        panic!("byte_char_debug_check failed.")
-    }
-}
-
-/// Count the markers in buffer BUF.
-#[cfg(MARKER_DEBUG)]
-fn count_markers(buf: LispBufferRef) -> u8 {
-    let mut total = 0;
-    for _m in buf.markers().iter() {
-        total += 1;
-    }
-    total
-}
-
-/// Recompute the bytepos corresponding to CHARPOS in the simplest, most reliable way.
-#[cfg(MARKER_DEBUG)]
-fn verify_bytepos(charpos: isize) -> isize {
-    let mut below: isize = 1;
-    let mut below_byte: isize = 1;
-    let cur_buf = ThreadState::current_buffer_unchecked();
-
-    while below != charpos {
-        below += 1;
-        below_byte = cur_buf.inc_pos(below_byte);
-    }
-    below_byte
-}
-
 include!(concat!(env!("OUT_DIR"), "/marker_exports.rs"));
-- 
2.21.0


From c477e35b83c1db75cbababe7226bd7ce3751584a Mon Sep 17 00:00:00 2001
From: shanavas <shanavas.m2@gmail.com>
Date: Thu, 28 Feb 2019 10:33:13 +0530
Subject: [PATCH 289/297] Update rust to nightly-2019-02-27

---
 lib-src/hashdir/Cargo.lock          | 2 ++
 rust-toolchain                      | 2 +-
 rust_src/Cargo.lock                 | 2 ++
 rust_src/remacs-bindings/Cargo.lock | 2 ++
 4 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/lib-src/hashdir/Cargo.lock b/lib-src/hashdir/Cargo.lock
index 14a4ce327e..8ff8fe1831 100644
--- a/lib-src/hashdir/Cargo.lock
+++ b/lib-src/hashdir/Cargo.lock
@@ -1,3 +1,5 @@
+# This file is automatically @generated by Cargo.
+# It is not intended for manual editing.
 [[package]]
 name = "aho-corasick"
 version = "0.6.9"
diff --git a/rust-toolchain b/rust-toolchain
index 48af0245bc..57240b1f8d 100644
--- a/rust-toolchain
+++ b/rust-toolchain
@@ -1 +1 @@
-nightly-2019-01-19
+nightly-2019-02-27
diff --git a/rust_src/Cargo.lock b/rust_src/Cargo.lock
index 6756fc7d32..770160093a 100644
--- a/rust_src/Cargo.lock
+++ b/rust_src/Cargo.lock
@@ -1,3 +1,5 @@
+# This file is automatically @generated by Cargo.
+# It is not intended for manual editing.
 [[package]]
 name = "adler32"
 version = "1.0.3"
diff --git a/rust_src/remacs-bindings/Cargo.lock b/rust_src/remacs-bindings/Cargo.lock
index 211b10e1b5..3d8cd83bf0 100644
--- a/rust_src/remacs-bindings/Cargo.lock
+++ b/rust_src/remacs-bindings/Cargo.lock
@@ -1,3 +1,5 @@
+# This file is automatically @generated by Cargo.
+# It is not intended for manual editing.
 [[package]]
 name = "aho-corasick"
 version = "0.6.9"
-- 
2.21.0


From c7932aba39775370b0373f0b1ba921b254303314 Mon Sep 17 00:00:00 2001
From: Shanavas M <shanavas.m2@gmail.com>
Date: Fri, 1 Mar 2019 11:16:04 +0530
Subject: [PATCH 290/297] Fix clippy warnings

---
 rust_src/src/buffers.rs              | 11 ++++++-----
 rust_src/src/chartable.rs            |  8 +++++---
 rust_src/src/crypto/mod.rs           |  4 ++--
 rust_src/src/dired_unix.rs           |  4 ++--
 rust_src/src/eval.rs                 |  2 +-
 rust_src/src/frames.rs               |  7 ++++---
 rust_src/src/keyboard.rs             |  6 +++---
 rust_src/src/lisp.rs                 | 12 ++++++------
 rust_src/src/lists.rs                |  2 +-
 rust_src/src/marker.rs               |  4 ++--
 rust_src/src/obarray.rs              |  3 ++-
 rust_src/src/process.rs              |  6 ++++--
 rust_src/src/strings.rs              |  4 +++-
 rust_src/src/terminal.rs             |  3 ++-
 rust_src/src/threads.rs              |  3 ++-
 rust_src/src/vectors.rs              | 10 ++++++----
 rust_src/src/window_configuration.rs |  3 ++-
 rust_src/src/windows.rs              | 11 ++++++-----
 18 files changed, 59 insertions(+), 44 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index a8ab00c061..23cf91680d 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -48,6 +48,7 @@ use crate::{
     },
     strings::string_equal,
     threads::{c_specpdl_index, ThreadState},
+    vectors::LispVectorlikeRef,
 };
 
 pub const BEG: ptrdiff_t = 1;
@@ -690,7 +691,7 @@ impl LispObject {
     }
 
     pub fn as_live_buffer(self) -> Option<LispBufferRef> {
-        self.as_buffer().and_then(|b| b.as_live())
+        self.as_buffer().and_then(LispBufferRef::as_live)
     }
 }
 
@@ -708,7 +709,7 @@ impl From<LispBufferRef> for LispObject {
 
 impl From<LispObject> for Option<LispBufferRef> {
     fn from(o: LispObject) -> Self {
-        o.as_vectorlike().and_then(|v| v.as_buffer())
+        o.as_vectorlike().and_then(LispVectorlikeRef::as_buffer)
     }
 }
 
@@ -737,7 +738,7 @@ impl From<LispOverlayRef> for LispObject {
 
 impl From<LispObject> for Option<LispOverlayRef> {
     fn from(o: LispObject) -> Self {
-        o.as_misc().and_then(|m| m.as_overlay())
+        o.as_misc().and_then(LispMiscRef::as_overlay)
     }
 }
 
@@ -816,7 +817,7 @@ impl LispBufferOrName {
         let obj = LispObject::from(self);
         obj.map_or_else(
             || Some(ThreadState::current_buffer_unchecked()),
-            |o| o.as_buffer(),
+            LispObject::as_buffer,
         )
     }
 }
@@ -959,7 +960,7 @@ pub fn overlayp(object: LispObject) -> bool {
 /// Value is nil if OBJECT is not a buffer or if it has been killed.
 #[lisp_fn]
 pub fn buffer_live_p(object: Option<LispBufferRef>) -> bool {
-    object.map_or(false, |m| m.is_live())
+    object.map_or(false, LispBufferRef::is_live)
 }
 
 /// Return the buffer named BUFFER-OR-NAME.
diff --git a/rust_src/src/chartable.rs b/rust_src/src/chartable.rs
index 1190d59cb9..04904b1e56 100644
--- a/rust_src/src/chartable.rs
+++ b/rust_src/src/chartable.rs
@@ -13,6 +13,7 @@ use crate::{
     },
     remacs_sys::{uniprop_table_uncompress, CHAR_TABLE_SET},
     remacs_sys::{Qchar_code_property_table, Qchar_table_p},
+    vectors::LispVectorlikeRef,
 };
 
 pub type LispCharTableRef = ExternalPtr<Lisp_Char_Table>;
@@ -43,7 +44,7 @@ impl From<LispObject> for LispCharTableRef {
 
 impl From<LispObject> for Option<LispCharTableRef> {
     fn from(o: LispObject) -> Self {
-        o.as_vectorlike().and_then(|v| v.as_char_table())
+        o.as_vectorlike().and_then(LispVectorlikeRef::as_char_table)
     }
 }
 
@@ -55,12 +56,13 @@ impl From<LispCharTableRef> for LispObject {
 
 impl LispObject {
     pub fn as_sub_char_table(self) -> Option<LispSubCharTableRef> {
-        self.as_vectorlike().and_then(|v| v.as_sub_char_table())
+        self.as_vectorlike()
+            .and_then(LispVectorlikeRef::as_sub_char_table)
     }
 
     pub fn as_sub_char_table_ascii(self) -> Option<LispSubCharTableAsciiRef> {
         self.as_vectorlike()
-            .and_then(|v| v.as_sub_char_table_ascii())
+            .and_then(LispVectorlikeRef::as_sub_char_table_ascii)
     }
 }
 
diff --git a/rust_src/src/crypto/mod.rs b/rust_src/src/crypto/mod.rs
index 5e86ae72ef..13f7de2d97 100755
--- a/rust_src/src/crypto/mod.rs
+++ b/rust_src/src/crypto/mod.rs
@@ -10,7 +10,7 @@ use sha2::{Digest, Sha224, Sha256, Sha384, Sha512};
 use remacs_macros::lisp_fn;
 
 use crate::{
-    buffers::LispBufferOrName,
+    buffers::{LispBufferOrName, LispBufferRef},
     lisp::LispObject,
     multibyte::LispStringRef,
     remacs_sys::EmacsInt,
@@ -233,7 +233,7 @@ fn sha512_buffer(buffer: &[u8], dest_buf: &mut [u8]) {
 /// disregarding any coding systems.  If nil, use the current buffer.
 #[lisp_fn(min = "0")]
 pub fn buffer_hash(buffer_or_name: Option<LispBufferOrName>) -> LispObject {
-    let b = buffer_or_name.map_or_else(ThreadState::current_buffer_unchecked, |b| b.into());
+    let b = buffer_or_name.map_or_else(ThreadState::current_buffer_unchecked, LispBufferRef::from);
     let mut ctx = sha1::Sha1::new();
 
     ctx.update(unsafe {
diff --git a/rust_src/src/dired_unix.rs b/rust_src/src/dired_unix.rs
index 33cb229077..0bde3a7f5d 100644
--- a/rust_src/src/dired_unix.rs
+++ b/rust_src/src/dired_unix.rs
@@ -282,7 +282,7 @@ fn match_re_maybe(f: String, re: &Option<RegEx>) -> Option<String> {
 
 fn fnames_to_list(fnames: &[String], dname: &str, full: &FullPath) -> LispObject {
     match *full {
-        FullPath::No => list(&fnames.iter().map(|x| x.to_bstring()).collect::<Vec<_>>()),
+        FullPath::No => list(&fnames.iter().map(StringExt::to_bstring).collect::<Vec<_>>()),
         FullPath::Yes => list(
             &fnames
                 .iter()
@@ -303,7 +303,7 @@ fn fattrs_to_list(
         FullPath::No => list(
             &fnames
                 .iter()
-                .map(|x| x.to_bstring())
+                .map(StringExt::to_bstring)
                 .zip(fattrs.to_owned())
                 .map(|x| LispObject::cons(x.0, x.1))
                 .collect::<Vec<_>>(),
diff --git a/rust_src/src/eval.rs b/rust_src/src/eval.rs
index f078d24ed4..f9363b2b40 100644
--- a/rust_src/src/eval.rs
+++ b/rust_src/src/eval.rs
@@ -1096,7 +1096,7 @@ fn resolve_fun(fun: LispObject) -> Result<LispFun, LispFunError> {
         // Optimize for no indirection.
         let fun = original_fun
             .as_symbol()
-            .map_or_else(|| original_fun, |f| f.get_indirect_function());
+            .map_or_else(|| original_fun, LispSymbolRef::get_indirect_function);
 
         if fun.is_nil() {
             return Err(LispFunError::VoidFun);
diff --git a/rust_src/src/frames.rs b/rust_src/src/frames.rs
index 36322ccf63..b5cfd3bfe0 100644
--- a/rust_src/src/frames.rs
+++ b/rust_src/src/frames.rs
@@ -11,6 +11,7 @@ use crate::{
     remacs_sys::{candidate_frame, delete_frame as c_delete_frame, frame_dimension, output_method},
     remacs_sys::{pvec_type, selected_frame as current_frame, Lisp_Frame, Lisp_Type},
     remacs_sys::{Qframe_live_p, Qframep, Qicon, Qnil, Qns, Qpc, Qt, Qw32, Qx},
+    vectors::LispVectorlikeRef,
     windows::{select_window_lisp, selected_window, LispWindowRef},
 };
 
@@ -115,7 +116,7 @@ impl From<LispFrameRef> for LispObject {
 
 impl From<LispObject> for Option<LispFrameRef> {
     fn from(o: LispObject) -> Self {
-        o.as_vectorlike().and_then(|v| v.as_frame())
+        o.as_vectorlike().and_then(LispVectorlikeRef::as_frame)
     }
 }
 
@@ -184,7 +185,7 @@ pub struct LispFrameLiveOrSelected(LispFrameRef);
 
 impl From<LispObject> for LispFrameLiveOrSelected {
     fn from(obj: LispObject) -> Self {
-        LispFrameLiveOrSelected(obj.map_or_else(selected_frame, |f| f.as_live_frame_or_error()))
+        LispFrameLiveOrSelected(obj.map_or_else(selected_frame, LispObject::as_live_frame_or_error))
     }
 }
 
@@ -657,7 +658,7 @@ pub fn frame_list() -> LispObject {
 /// Return a list of all frames now \"visible\" (being updated).
 #[lisp_fn]
 pub fn visible_frame_list() -> LispObject {
-    filter_frame_list(|f| f.is_visible())
+    filter_frame_list(LispFrameRef::is_visible)
 }
 
 include!(concat!(env!("OUT_DIR"), "/frames_exports.rs"));
diff --git a/rust_src/src/keyboard.rs b/rust_src/src/keyboard.rs
index 1159fbcf2c..28db9a7835 100644
--- a/rust_src/src/keyboard.rs
+++ b/rust_src/src/keyboard.rs
@@ -52,8 +52,8 @@ pub fn posn_at_point(pos: LispObject, window: LispWindowOrSelected) -> LispObjec
     }
 
     let mut it = tem.iter_cars(LispConsEndChecks::off, LispConsCircularChecks::off);
-    let x = it.next().map_or(0, |coord| coord.as_fixnum_or_error());
-    let mut y = it.next().map_or(0, |coord| coord.as_fixnum_or_error());
+    let x = it.next().map_or(0, LispObject::as_fixnum_or_error);
+    let mut y = it.next().map_or(0, LispObject::as_fixnum_or_error);
 
     // Point invisible due to hscrolling?  X can be -1 when a
     // newline in a R2L line overflows into the left fringe.
@@ -62,7 +62,7 @@ pub fn posn_at_point(pos: LispObject, window: LispWindowOrSelected) -> LispObjec
     }
     let aux_info = it.rest();
     if aux_info.is_not_nil() && y < 0 {
-        let rtop = it.next().map_or(0, |v| v.as_fixnum_or_error());
+        let rtop = it.next().map_or(0, LispObject::as_fixnum_or_error);
 
         y += rtop;
     }
diff --git a/rust_src/src/lisp.rs b/rust_src/src/lisp.rs
index 978d7bd3d5..73fc1710f4 100644
--- a/rust_src/src/lisp.rs
+++ b/rust_src/src/lisp.rs
@@ -1,7 +1,7 @@
 //! This module contains Rust definitions whose C equivalents live in
 //! lisp.h.
 
-use std::convert::From;
+use std::convert::{From, Into};
 use std::ffi::CString;
 use std::fmt;
 use std::fmt::{Debug, Display, Error, Formatter};
@@ -17,7 +17,7 @@ use crate::{
         HashLookupResult::{Found, Missing},
         LispHashTableRef,
     },
-    lists::{list, memq, CarIter, LispConsCircularChecks, LispConsEndChecks},
+    lists::{list, memq, CarIter, LispCons, LispConsCircularChecks, LispConsEndChecks},
     multibyte::LispStringRef,
     process::LispProcessRef,
     remacs_sys::{build_string, make_float, Fmake_hash_table},
@@ -275,7 +275,7 @@ impl From<LispObject> for LispSubrRef {
 
 impl From<LispObject> for Option<LispSubrRef> {
     fn from(o: LispObject) -> Self {
-        o.as_vectorlike().and_then(|v| v.as_subr())
+        o.as_vectorlike().and_then(ExternalPtr::as_subr)
     }
 }
 
@@ -530,9 +530,9 @@ macro_rules! impl_alistval_iter {
             fn next(&mut self) -> Option<Self::Item> {
                 self.0
                     .next()
-                    .and_then(|o| o.as_cons())
-                    .map(|p| p.cdr())
-                    .and_then(|q| q.into())
+                    .and_then(LispObject::as_cons)
+                    .map(LispCons::cdr)
+                    .and_then(Into::into)
             }
         }
     };
diff --git a/rust_src/src/lists.rs b/rust_src/src/lists.rs
index d78e2240a2..44e2e6cc75 100644
--- a/rust_src/src/lists.rs
+++ b/rust_src/src/lists.rs
@@ -254,7 +254,7 @@ impl Iterator for CarIter {
     type Item = LispObject;
 
     fn next(&mut self) -> Option<Self::Item> {
-        self.0.next().map(|cons| cons.car())
+        self.0.next().map(LispCons::car)
     }
 }
 
diff --git a/rust_src/src/marker.rs b/rust_src/src/marker.rs
index d089bc876c..46f032b068 100644
--- a/rust_src/src/marker.rs
+++ b/rust_src/src/marker.rs
@@ -113,7 +113,7 @@ impl From<LispMarkerRef> for LispObject {
 
 impl From<LispObject> for Option<LispMarkerRef> {
     fn from(o: LispObject) -> Self {
-        o.as_misc().and_then(|m| m.as_marker())
+        o.as_misc().and_then(LispMiscRef::as_marker)
     }
 }
 
@@ -308,7 +308,7 @@ pub fn copy_marker(marker: LispObject, itype: LispObject) -> LispObject {
         marker.as_fixnum_coerce_marker_or_error();
     }
     let new = unsafe { Fmake_marker() };
-    let buffer_or_nil = marker.as_marker().and_then(|m| m.buffer());
+    let buffer_or_nil = marker.as_marker().and_then(LispMarkerRef::buffer);
 
     set_marker(new.into(), marker, buffer_or_nil.into());
 
diff --git a/rust_src/src/obarray.rs b/rust_src/src/obarray.rs
index fe633badb5..92dd70cf11 100644
--- a/rust_src/src/obarray.rs
+++ b/rust_src/src/obarray.rs
@@ -13,6 +13,7 @@ use crate::{
     remacs_sys::{Fmake_symbol, Fpurecopy},
     remacs_sys::{Qnil, Qvectorp},
     symbols::LispSymbolRef,
+    vectors::LispVectorRef,
 };
 
 /// A lisp object containing an `obarray`.
@@ -128,7 +129,7 @@ pub extern "C" fn check_obarray(obarray: LispObject) -> LispObject {
 
     // A valid obarray is a non-empty vector.
     let v = obarray.as_vector();
-    if v.map_or(0, |v_1| v_1.len()) == 0 {
+    if v.map_or(0, LispVectorRef::len) == 0 {
         // If Vobarray is now invalid, force it to be valid.
         if unsafe { globals.Vobarray }.eq(obarray) {
             unsafe { globals.Vobarray = initial_obarray };
diff --git a/rust_src/src/process.rs b/rust_src/src/process.rs
index a3d3d77262..75a43e4b4b 100644
--- a/rust_src/src/process.rs
+++ b/rust_src/src/process.rs
@@ -2,6 +2,7 @@
 use libc;
 
 use remacs_macros::lisp_fn;
+use std::convert::Into;
 
 use crate::{
     buffers::{current_buffer, get_buffer, LispBufferOrName, LispBufferRef},
@@ -21,6 +22,7 @@ use crate::{
         Qinterrupt_process_functions, Qlisten, Qlistp, Qnetwork, Qnil, Qopen, Qpipe, Qprocessp,
         Qreal, Qrun, Qserial, Qstop, Qt,
     },
+    vectors::LispVectorlikeRef,
 };
 
 pub type LispProcessRef = ExternalPtr<Lisp_Process>;
@@ -68,7 +70,7 @@ impl From<LispProcessRef> for LispObject {
 
 impl From<LispObject> for Option<LispProcessRef> {
     fn from(o: LispObject) -> Self {
-        o.as_vectorlike().and_then(|v| v.as_process())
+        o.as_vectorlike().and_then(LispVectorlikeRef::as_process)
     }
 }
 
@@ -169,7 +171,7 @@ pub fn process_id(process: LispProcessRef) -> Option<EmacsInt> {
 /// deleted or killed.
 #[lisp_fn]
 pub fn get_buffer_process(buffer_or_name: Option<LispBufferOrName>) -> Option<LispProcessRef> {
-    get_buffer_process_internal(buffer_or_name.and_then(|b| b.into()))
+    get_buffer_process_internal(buffer_or_name.and_then(Into::into))
 }
 
 pub fn get_buffer_process_internal(buffer: Option<LispBufferRef>) -> Option<LispProcessRef> {
diff --git a/rust_src/src/strings.rs b/rust_src/src/strings.rs
index 0120279cbe..af0787770c 100644
--- a/rust_src/src/strings.rs
+++ b/rust_src/src/strings.rs
@@ -161,7 +161,9 @@ pub fn string_lessp_lisp(string1: LispSymbolOrString, string2: LispSymbolOrStrin
 /// Return nil if OBJECT is either a unibyte string, or not a string.
 #[lisp_fn]
 pub fn multibyte_string_p(object: LispObject) -> bool {
-    object.as_string().map_or(false, |s| s.is_multibyte())
+    object
+        .as_string()
+        .map_or(false, LispStringRef::is_multibyte)
 }
 
 /// Clear the contents of STRING.
diff --git a/rust_src/src/terminal.rs b/rust_src/src/terminal.rs
index 9c08a204d6..c54f6a5465 100644
--- a/rust_src/src/terminal.rs
+++ b/rust_src/src/terminal.rs
@@ -50,7 +50,8 @@ impl LispObject {
     }
 
     pub fn as_terminal(self) -> Option<LispTerminalRef> {
-        self.as_vectorlike().and_then(|v| v.as_terminal())
+        self.as_vectorlike()
+            .and_then(LispVectorlikeRef::as_terminal)
     }
 }
 
diff --git a/rust_src/src/threads.rs b/rust_src/src/threads.rs
index 5961ef66a3..1315fb8976 100644
--- a/rust_src/src/threads.rs
+++ b/rust_src/src/threads.rs
@@ -13,6 +13,7 @@ use crate::{
     remacs_sys::{
         current_thread as current_thread_pointer, pvec_type, thread_state, Lisp_Type, SPECPDL_INDEX,
     },
+    vectors::LispVectorlikeRef,
 };
 
 pub type ThreadStateRef = ExternalPtr<thread_state>;
@@ -64,7 +65,7 @@ impl LispObject {
     }
 
     pub fn as_thread(self) -> Option<ThreadStateRef> {
-        self.as_vectorlike().and_then(|v| v.as_thread())
+        self.as_vectorlike().and_then(LispVectorlikeRef::as_thread)
     }
 }
 
diff --git a/rust_src/src/vectors.rs b/rust_src/src/vectors.rs
index f0a1fd8ac8..d549f63f6f 100644
--- a/rust_src/src/vectors.rs
+++ b/rust_src/src/vectors.rs
@@ -44,7 +44,8 @@ impl LispObject {
     }
 
     pub fn is_vector(self) -> bool {
-        self.as_vectorlike().map_or(false, |v| v.is_vector())
+        self.as_vectorlike()
+            .map_or(false, LispVectorlikeRef::is_vector)
     }
 
     pub fn force_vectorlike(self) -> LispVectorlikeRef {
@@ -74,7 +75,7 @@ impl LispObject {
     }
 
     pub fn as_vector(self) -> Option<LispVectorRef> {
-        self.as_vectorlike().and_then(|v| v.as_vector())
+        self.as_vectorlike().and_then(LispVectorlikeRef::as_vector)
     }
 
     pub fn as_vector_or_error(self) -> LispVectorRef {
@@ -548,7 +549,8 @@ impl LispObject {
     }
 
     pub fn as_bool_vector(self) -> Option<LispBoolVecRef> {
-        self.as_vectorlike().and_then(|v| v.as_bool_vector())
+        self.as_vectorlike()
+            .and_then(LispVectorlikeRef::as_bool_vector)
     }
 }
 
@@ -637,7 +639,7 @@ pub fn elt(sequence: LispObject, n: EmacsInt) -> LispObject {
 pub fn sort(seq: LispObject, predicate: LispObject) -> LispObject {
     if seq.is_cons() {
         sort_list(seq, predicate)
-    } else if let Some(mut vec) = seq.as_vectorlike().and_then(|v| v.as_vector()) {
+    } else if let Some(mut vec) = seq.as_vectorlike().and_then(LispVectorlikeRef::as_vector) {
         vec.as_mut_slice().sort_by(|&a, &b| {
             // XXX: since the `sort' predicate is a two-outcome comparison
             // Less/!Less, and slice::sort_by() uses Greater/!Greater
diff --git a/rust_src/src/window_configuration.rs b/rust_src/src/window_configuration.rs
index 3ca95b0ef2..21269c5d3c 100644
--- a/rust_src/src/window_configuration.rs
+++ b/rust_src/src/window_configuration.rs
@@ -8,6 +8,7 @@ use crate::{
     objects::equal,
     remacs_sys::Qwindow_configuration_p,
     remacs_sys::{save_window_data, saved_window},
+    vectors::LispVectorlikeRef,
     windows::LispWindowRef,
 };
 
@@ -111,7 +112,7 @@ impl From<LispObject> for SaveWindowDataRef {
 impl LispObject {
     pub fn as_window_configuration(self) -> Option<SaveWindowDataRef> {
         self.as_vectorlike()
-            .and_then(|v| v.as_window_configuration())
+            .and_then(LispVectorlikeRef::as_window_configuration)
     }
 }
 
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 105c278de8..04eac36f45 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -35,6 +35,7 @@ use crate::{
         Qwindow_live_p, Qwindow_valid_p, Qwindowp,
     },
     threads::ThreadState,
+    vectors::LispVectorlikeRef,
 };
 
 pub type LispWindowRef = ExternalPtr<Lisp_Window>;
@@ -542,7 +543,7 @@ impl From<LispWindowRef> for LispObject {
 
 impl From<LispObject> for Option<LispWindowRef> {
     fn from(o: LispObject) -> Self {
-        o.as_vectorlike().and_then(|v| v.as_window())
+        o.as_vectorlike().and_then(LispVectorlikeRef::as_window)
     }
 }
 
@@ -674,7 +675,7 @@ impl From<LispObject> for LispWindowLiveOrSelected {
     fn from(obj: LispObject) -> Self {
         Self(obj.map_or_else(
             || LispWindowRef::from(unsafe { current_window }),
-            |w| w.as_live_window_or_error(),
+            LispObject::as_live_window_or_error,
         ))
     }
 }
@@ -692,7 +693,7 @@ impl From<LispObject> for LispWindowValidOrSelected {
     fn from(obj: LispObject) -> Self {
         Self(obj.map_or_else(
             || LispWindowRef::from(selected_window()),
-            |w| w.as_valid_window_or_error(),
+            LispObject::as_valid_window_or_error,
         ))
     }
 }
@@ -725,7 +726,7 @@ pub fn windowp(object: LispObject) -> bool {
 /// Internal windows and deleted windows are not live.
 #[lisp_fn]
 pub fn window_live_p(object: Option<LispWindowRef>) -> bool {
-    object.map_or(false, |m| m.is_live())
+    object.map_or(false, LispWindowRef::is_live)
 }
 
 /// Return new pixel size of window WINDOW.
@@ -787,7 +788,7 @@ pub fn window_buffer(window: LispWindowOrSelected) -> LispObject {
 /// window.  Windows that have been deleted are not valid.
 #[lisp_fn]
 pub fn window_valid_p(object: Option<LispWindowRef>) -> bool {
-    object.map_or(false, |w| w.is_valid())
+    object.map_or(false, LispWindowRef::is_valid)
 }
 
 /// Return position at which display currently starts in WINDOW.
-- 
2.21.0


From d319ea097ec0a45a336ff3d7ccf81f32ac847ef5 Mon Sep 17 00:00:00 2001
From: Tim Holland <tim@blockapps.net>
Date: Thu, 28 Feb 2019 23:18:37 -0500
Subject: [PATCH 291/297] Port window-normal-size

---
 rust_src/src/windows.rs            | 38 ++++++++++++++++++++++++++----
 src/window.c                       | 30 -----------------------
 test/rust_src/src/windows-tests.el | 10 ++++++++
 3 files changed, 44 insertions(+), 34 deletions(-)

diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 105c278de8..f82a594347 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -25,10 +25,8 @@ use crate::{
         update_mode_lines, window_list_1, window_menu_bar_p, window_tool_bar_p,
         windows_or_buffers_changed, wset_redisplay,
     },
-    remacs_sys::{
-        face_id, glyph_matrix, glyph_row, pvec_type, vertical_scroll_bar_type, EmacsInt, Lisp_Type,
-        Lisp_Window,
-    },
+    remacs_sys::{face_id, glyph_matrix, glyph_row, pvec_type, vertical_scroll_bar_type},
+    remacs_sys::{EmacsDouble, EmacsInt, Lisp_Type, Lisp_Window},
     remacs_sys::{Fcopy_alist, Fnreverse},
     remacs_sys::{
         Qceiling, Qfloor, Qheader_line_format, Qleft, Qmode_line_format, Qnil, Qnone, Qright, Qt,
@@ -713,6 +711,38 @@ pub extern "C" fn decode_any_window(window: LispObject) -> LispWindowRef {
     LispWindowOrSelected::from(window).into()
 }
 
+/// Return the normal height of window WINDOW.
+/// WINDOW must be a valid window and defaults to the selected one.
+/// If HORIZONTAL is non-nil, return the normal width of WINDOW.
+///
+/// The normal height of a frame's root window or a window that is
+/// horizontally combined (a window that has a left or right sibling) is
+/// 1.0.  The normal height of a window that is vertically combined (has a
+/// sibling above or below) is the fraction of the window's height with
+/// respect to its parent.  The sum of the normal heights of all windows in a
+/// vertical combination equals 1.0.
+///
+/// Similarly, the normal width of a frame's root window or a window that is
+/// vertically combined equals 1.0.  The normal width of a window that is
+/// horizontally combined is the fraction of the window's width with respect
+/// to its parent.  The sum of the normal widths of all windows in a
+/// horizontal combination equals 1.0.
+///
+/// The normal sizes of windows are used to restore the proportional sizes
+/// of windows after they have been shrunk to their minimum sizes; for
+/// example when a frame is temporarily made very small and afterwards gets
+/// re-enlarged to its previous size.
+#[lisp_fn(min = "0")]
+pub fn window_normal_size(window: LispWindowValidOrSelected, horizontal: bool) -> EmacsDouble {
+    let win: LispWindowRef = window.into();
+    let frac = if !horizontal {
+        win.normal_lines
+    } else {
+        win.normal_cols
+    };
+    EmacsDouble::from(frac)
+}
+
 /// Return t if OBJECT is a window and nil otherwise.
 #[lisp_fn]
 pub fn windowp(object: LispObject) -> bool {
diff --git a/src/window.c b/src/window.c
index 16fe7637f3..588f7c6441 100644
--- a/src/window.c
+++ b/src/window.c
@@ -463,35 +463,6 @@ after that.  */)
 	  (decode_valid_window (window)->pixel_height_before_size_change));
 }
 
-DEFUN ("window-normal-size", Fwindow_normal_size, Swindow_normal_size, 0, 2, 0,
-       doc: /* Return the normal height of window WINDOW.
-WINDOW must be a valid window and defaults to the selected one.
-If HORIZONTAL is non-nil, return the normal width of WINDOW.
-
-The normal height of a frame's root window or a window that is
-horizontally combined (a window that has a left or right sibling) is
-1.0.  The normal height of a window that is vertically combined (has a
-sibling above or below) is the fraction of the window's height with
-respect to its parent.  The sum of the normal heights of all windows in a
-vertical combination equals 1.0.
-
-Similarly, the normal width of a frame's root window or a window that is
-vertically combined equals 1.0.  The normal width of a window that is
-horizontally combined is the fraction of the window's width with respect
-to its parent.  The sum of the normal widths of all windows in a
-horizontal combination equals 1.0.
-
-The normal sizes of windows are used to restore the proportional sizes
-of windows after they have been shrunk to their minimum sizes; for
-example when a frame is temporarily made very small and afterwards gets
-re-enlarged to its previous size.  */)
-  (Lisp_Object window, Lisp_Object horizontal)
-{
-  struct window *w = decode_valid_window (window);
-
-  return NILP (horizontal) ? w->normal_lines : w->normal_cols;
-}
-
 DEFUN ("window-pixel-left", Fwindow_pixel_left, Swindow_pixel_left, 0, 1, 0,
        doc: /* Return left pixel edge of window WINDOW.
 WINDOW must be a valid window and defaults to the selected one.  */)
@@ -6401,7 +6372,6 @@ displayed after a scrolling operation to be somewhat inaccurate.  */);
   defsubr (&Swindow_left_child);
   defsubr (&Swindow_pixel_width_before_size_change);
   defsubr (&Swindow_pixel_height_before_size_change);
-  defsubr (&Swindow_normal_size);
   defsubr (&Swindow_pixel_left);
   defsubr (&Swindow_left_column);
   defsubr (&Sset_window_new_pixel);
diff --git a/test/rust_src/src/windows-tests.el b/test/rust_src/src/windows-tests.el
index 937ba9c072..b9c5d1d07c 100644
--- a/test/rust_src/src/windows-tests.el
+++ b/test/rust_src/src/windows-tests.el
@@ -95,3 +95,13 @@
   (set-window-parameter (selected-window) 'test 'test)
   (should (consp (window-parameters)))
   (should (consp (window-parameters (selected-window)))))
+
+(ert-deftest window-normal-size ()
+  (let ((w1 (selected-window))
+        (w2 (split-window)))
+  (should (= 0.5 (window-normal-size)))
+  (should (= 1.0 (window-normal-size nil 't)))
+  (should (= 0.5 (window-normal-size w1)))
+  (should (= 1.0 (window-normal-size w1 't)))
+  (should (= 0.5 (window-normal-size w2)))
+  (should (= 1.0 (window-normal-size w2 't)))))
-- 
2.21.0


From 8eb7420e8b54a45b154eb4a3d820a69f588b2a0e Mon Sep 17 00:00:00 2001
From: Shanavas M <shanavas.m2@gmail.com>
Date: Sat, 2 Mar 2019 15:13:30 +0530
Subject: [PATCH 292/297] Update toolchain in dockerfiles

---
 docker/fedora/Dockerfile        | 4 ++--
 docker/ubuntu/32bit/Dockerfile  | 4 ++--
 docker/ubuntu/Dockerfile        | 4 ++--
 docker/ubuntu/cosmic/Dockerfile | 4 ++--
 4 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/docker/fedora/Dockerfile b/docker/fedora/Dockerfile
index 470647e034..0dd5afd39d 100644
--- a/docker/fedora/Dockerfile
+++ b/docker/fedora/Dockerfile
@@ -25,6 +25,6 @@ ENV PATH "/root/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sb
 RUN curl https://sh.rustup.rs -o rustup.sh && \
     sh rustup.sh \
         --default-host x86_64-unknown-linux-gnu \
-        --default-toolchain nightly-2019-01-19 -y && \
-    rustup default nightly-2019-01-19
+        --default-toolchain nightly-2019-02-27 -y && \
+    rustup default nightly-2019-02-27
 
diff --git a/docker/ubuntu/32bit/Dockerfile b/docker/ubuntu/32bit/Dockerfile
index 96ace59937..106933e7c8 100644
--- a/docker/ubuntu/32bit/Dockerfile
+++ b/docker/ubuntu/32bit/Dockerfile
@@ -44,6 +44,6 @@ ENV PATH "/root/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sb
 RUN curl https://sh.rustup.rs -o rustup.sh && \
     sh rustup.sh \
         --default-host i686-unknown-linux-gnu \
-        --default-toolchain nightly-2019-01-19 -y && \
-    rustup default nightly-2019-01-19
+        --default-toolchain nightly-2019-02-27 -y && \
+    rustup default nightly-2019-02-27
 
diff --git a/docker/ubuntu/Dockerfile b/docker/ubuntu/Dockerfile
index 3fa1a44dcc..f85a0a4b80 100644
--- a/docker/ubuntu/Dockerfile
+++ b/docker/ubuntu/Dockerfile
@@ -23,6 +23,6 @@ ENV PATH "/root/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sb
 RUN curl https://sh.rustup.rs -o rustup.sh && \
     sh rustup.sh \
         --default-host x86_64-unknown-linux-gnu \
-        --default-toolchain nightly-2019-01-19 -y && \
-    rustup default nightly-2019-01-19
+        --default-toolchain nightly-2019-02-27 -y && \
+    rustup default nightly-2019-02-27
 
diff --git a/docker/ubuntu/cosmic/Dockerfile b/docker/ubuntu/cosmic/Dockerfile
index 9aaec19fd0..7cffd596da 100644
--- a/docker/ubuntu/cosmic/Dockerfile
+++ b/docker/ubuntu/cosmic/Dockerfile
@@ -25,6 +25,6 @@ ENV PATH "/root/.cargo/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sb
 RUN curl https://sh.rustup.rs -o rustup.sh && \
     sh rustup.sh \
         --default-host x86_64-unknown-linux-gnu \
-        --default-toolchain nightly-2019-01-19 -y && \
-    rustup default nightly-2019-01-19
+        --default-toolchain nightly-2019-02-27 -y && \
+    rustup default nightly-2019-02-27
 
-- 
2.21.0


From 466b0316a949351f64c9125744340556bbdeeedd Mon Sep 17 00:00:00 2001
From: 0xflotus <0xflotus@gmail.com>
Date: Sun, 3 Mar 2019 08:27:59 +0100
Subject: [PATCH 293/297] Fix typo in Readme (#1361)

---
 README.md | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/README.md b/README.md
index 6de1d3f973..2f01213d58 100644
--- a/README.md
+++ b/README.md
@@ -245,7 +245,7 @@ under projects.
 
 The first thing to look at is the C implementation for the `atan` function. It takes an optional second argument, which makes it interesting. The complicated mathematical bits, on the other hand, are handled by the standard library. This allows us to focus on the porting process without getting distracted by the math.
 
-The Lisp values we are given as arguments are tagged pointers; in this case they are pointers to doubles. The code has to check the tag and follow the pointer to retrieve the real values. Note that this code invokes a C macro (called `DEFUN`) that reduces some of the boilerplate. The macro declares a static varable called `Satan` that holds the metadata the Lisp compiler will need in order to successfully call this function, such as the docstring and the pointer to the `Fatan` function, which is what the C implementation is named:
+The Lisp values we are given as arguments are tagged pointers; in this case they are pointers to doubles. The code has to check the tag and follow the pointer to retrieve the real values. Note that this code invokes a C macro (called `DEFUN`) that reduces some of the boilerplate. The macro declares a static variable called `Satan` that holds the metadata the Lisp compiler will need in order to successfully call this function, such as the docstring and the pointer to the `Fatan` function, which is what the C implementation is named:
 
 ``` c
 DEFUN ("atan", Fatan, Satan, 1, 2, 0,
-- 
2.21.0


From 65d4184bd6d78fd6790c8ec1caf835b308748ce3 Mon Sep 17 00:00:00 2001
From: brotzeit <brotzeitmacher@gmail.com>
Date: Sun, 3 Mar 2019 12:45:27 +0100
Subject: [PATCH 294/297] update readme

---
 README.md | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/README.md b/README.md
index 2f01213d58..096bb22abb 100644
--- a/README.md
+++ b/README.md
@@ -235,7 +235,7 @@ different.
 # Progress
 
 At this point we focus on porting lisp functions from C to Rust.
-Currently there are 580 functions in Rust and 879 in C (February 2019).
+Currently there are 600 functions in Rust and 859 in C (March 2019).
 
 We have a [progress section](https://github.com/Wilfred/remacs/wiki/Progress) in our wiki
 and there's also a list of [long-term goals](https://github.com/Wilfred/remacs/projects/1) 
-- 
2.21.0


From dc2ea22ddfa1ba077178ffabeff8590aea910242 Mon Sep 17 00:00:00 2001
From: Sean Perry <shalehperry@gmail.com>
Date: Fri, 8 Mar 2019 11:59:39 -0800
Subject: [PATCH 295/297] Port scroll_command and add InteractiveNumericPrefix
 as a new helper type. (#1354)

Implement `InteractiveNumericPrefix` type.
This type represents when "p" or "P" is used as the interactive argument for a DEFUN.
---
 rust_src/src/interactive.rs | 78 +++++++++++++++++++++++++++-----
 rust_src/src/windows.rs     | 90 ++++++++++++++++++++++++++++---------
 src/lisp.h                  |  3 ++
 src/window.c                | 38 +---------------
 4 files changed, 140 insertions(+), 69 deletions(-)

diff --git a/rust_src/src/interactive.rs b/rust_src/src/interactive.rs
index 389c9644e4..b17b07de63 100644
--- a/rust_src/src/interactive.rs
+++ b/rust_src/src/interactive.rs
@@ -7,22 +7,76 @@ use crate::{
     remacs_sys::{EmacsInt, Qminus},
 };
 
+#[derive(Copy, Clone, Debug)]
+pub enum InteractiveNumericPrefix {
+    Object(LispObject),
+    Number(EmacsInt),
+}
+
+impl InteractiveNumericPrefix {
+    pub fn from_number(value: EmacsInt) -> Self {
+        Self::Number(value)
+    }
+
+    pub fn from_object(raw: LispObject) -> Self {
+        Self::Object(raw)
+    }
+
+    pub fn is_minus(self) -> bool {
+        match self {
+            Self::Number(_) => false,
+            Self::Object(raw) => raw.eq(Qminus),
+        }
+    }
+
+    pub fn unwrap(self) -> EmacsInt {
+        match self {
+            Self::Number(value) => value,
+            Self::Object(raw) => {
+                if raw.is_nil() {
+                    1
+                } else if raw.eq(Qminus) {
+                    -1
+                } else if raw.is_integer() {
+                    raw.into()
+                } else if let Some(number) = raw.as_cons().and_then(|v| v.car().as_fixnum()) {
+                    number
+                } else {
+                    1
+                }
+            }
+        }
+    }
+}
+
+impl From<LispObject> for InteractiveNumericPrefix {
+    fn from(obj: LispObject) -> Self {
+        Self::from_object(obj)
+    }
+}
+
+impl From<LispObject> for Option<InteractiveNumericPrefix> {
+    fn from(obj: LispObject) -> Self {
+        if obj.is_nil() {
+            None
+        } else {
+            Some(InteractiveNumericPrefix::from_object(obj))
+        }
+    }
+}
+
+impl From<EmacsInt> for InteractiveNumericPrefix {
+    fn from(n: EmacsInt) -> Self {
+        Self::from_number(n)
+    }
+}
+
 /// Return numeric meaning of raw prefix argument RAW.
 /// A raw prefix argument is what you get from `(interactive "P")'.
 /// Its numeric meaning is what you would get from `(interactive "p")'.
 #[lisp_fn]
-pub fn prefix_numeric_value(raw: LispObject) -> EmacsInt {
-    if raw.is_nil() {
-        1
-    } else if raw.eq(Qminus) {
-        -1
-    } else if raw.is_integer() {
-        raw.as_fixnum_or_error()
-    } else if let Some(number) = raw.as_cons().and_then(|v| v.car().as_fixnum()) {
-        number
-    } else {
-        1
-    }
+pub fn prefix_numeric_value(raw: InteractiveNumericPrefix) -> EmacsInt {
+    raw.unwrap()
 }
 
 include!(concat!(env!("OUT_DIR"), "/interactive_exports.rs"));
diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 1ed09143f6..2788c9c7eb 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -7,10 +7,11 @@ use libc::c_int;
 use remacs_macros::lisp_fn;
 
 use crate::{
-    buffers::LispBufferRef,
+    buffers::{set_buffer, LispBufferRef},
     editfns::{goto_char, point},
+    eval::unbind_to,
     frames::{LispFrameLiveOrSelected, LispFrameOrSelected, LispFrameRef},
-    interactive::prefix_numeric_value,
+    interactive::InteractiveNumericPrefix,
     lisp::{ExternalPtr, LispObject},
     lists::{assq, setcdr},
     marker::{marker_position_lisp, set_marker_restricted},
@@ -20,9 +21,10 @@ use crate::{
     remacs_sys::glyph_row_area::TEXT_AREA,
     remacs_sys::{
         estimate_mode_line_height, minibuf_level,
-        minibuf_selected_window as current_minibuf_window, noninteractive, scroll_command,
-        select_window, selected_window as current_window, set_buffer_internal, set_window_hscroll,
-        update_mode_lines, window_list_1, window_menu_bar_p, window_tool_bar_p,
+        minibuf_selected_window as current_minibuf_window, noninteractive, record_unwind_protect,
+        save_excursion_restore, save_excursion_save, select_window,
+        selected_window as current_window, set_buffer_internal, set_window_hscroll,
+        update_mode_lines, window_list_1, window_menu_bar_p, window_scroll, window_tool_bar_p,
         windows_or_buffers_changed, wset_redisplay,
     },
     remacs_sys::{face_id, glyph_matrix, glyph_row, pvec_type, vertical_scroll_bar_type},
@@ -32,7 +34,7 @@ use crate::{
         Qceiling, Qfloor, Qheader_line_format, Qleft, Qmode_line_format, Qnil, Qnone, Qright, Qt,
         Qwindow_live_p, Qwindow_valid_p, Qwindowp,
     },
-    threads::ThreadState,
+    threads::{c_specpdl_index, ThreadState},
     vectors::LispVectorlikeRef,
 };
 
@@ -1392,19 +1394,27 @@ pub fn window_top_child(window: LispWindowValidOrSelected) -> Option<LispWindowR
     }
 }
 
-pub fn scroll_horizontally(arg: LispObject, set_minimum: LispObject, left: bool) -> LispObject {
+fn scroll_horizontally(
+    arg: Option<InteractiveNumericPrefix>,
+    set_minimum: bool,
+    left: bool,
+) -> LispObject {
     let mut w: LispWindowRef = selected_window().into();
-    let requested_arg = if arg.is_nil() {
-        EmacsInt::from(w.body_width(false)) - 2
-    } else if left {
-        prefix_numeric_value(arg)
-    } else {
-        -prefix_numeric_value(arg)
+    let requested_arg = match arg {
+        None => EmacsInt::from(w.body_width(false)) - 2,
+        Some(value) => {
+            let tem = value.unwrap();
+            if left {
+                tem
+            } else {
+                -tem
+            }
+        }
     };
 
     let result = unsafe { set_window_hscroll(w.as_mut(), w.hscroll as EmacsInt + requested_arg) };
 
-    if set_minimum.is_not_nil() {
+    if set_minimum {
         w.min_hscroll = w.hscroll;
     }
 
@@ -1421,7 +1431,7 @@ pub fn scroll_horizontally(arg: LispObject, set_minimum: LispObject, left: bool)
 /// will not scroll a window to a column less than the value returned
 /// by this function.  This happens in an interactive call.
 #[lisp_fn(min = "0", intspec = "^P\np")]
-pub fn scroll_left(arg: LispObject, set_minimum: LispObject) -> LispObject {
+pub fn scroll_left(arg: Option<InteractiveNumericPrefix>, set_minimum: bool) -> LispObject {
     scroll_horizontally(arg, set_minimum, true)
 }
 
@@ -1434,7 +1444,7 @@ pub fn scroll_left(arg: LispObject, set_minimum: LispObject) -> LispObject {
 /// will not scroll a window to a column less than the value returned
 /// by this function.  This happens in an interactive call.
 #[lisp_fn(min = "0", intspec = "^P\np")]
-pub fn scroll_right(arg: LispObject, set_minimum: LispObject) -> LispObject {
+pub fn scroll_right(arg: Option<InteractiveNumericPrefix>, set_minimum: bool) -> LispObject {
     scroll_horizontally(arg, set_minimum, false)
 }
 
@@ -1445,8 +1455,8 @@ pub fn scroll_right(arg: LispObject, set_minimum: LispObject) -> LispObject {
 /// If ARG is the atom `-', scroll downward by nearly full screen.
 /// When calling from a program, supply as argument a number, nil, or `-'.
 #[lisp_fn(min = "0", intspec = "^P")]
-pub fn scroll_up(arg: LispObject) {
-    unsafe { scroll_command(arg, 1) };
+pub fn scroll_up(arg: Option<InteractiveNumericPrefix>) {
+    scroll_command(arg, 1);
 }
 
 /// Scroll text of selected window down ARG lines.
@@ -1456,8 +1466,48 @@ pub fn scroll_up(arg: LispObject) {
 /// If ARG is the atom `-', scroll upward by nearly full screen.
 /// When calling from a program, supply as argument a number, nil, or `-'.
 #[lisp_fn(min = "0", intspec = "^P")]
-pub fn scroll_down(arg: LispObject) {
-    unsafe { scroll_command(arg, -1) };
+pub fn scroll_down(arg: Option<InteractiveNumericPrefix>) {
+    scroll_command(arg, -1);
+}
+
+// Scroll selected window up or down.  If N is nil, scroll upward by a
+// screen-full which is defined as the height of the window minus
+// next_screen_context_lines.  If N is the symbol `-', scroll downward
+// by a screen-full.  DIRECTION may be 1 meaning to scroll down, or -1
+// meaning to scroll up.
+fn scroll_command(n: Option<InteractiveNumericPrefix>, direction: EmacsInt) {
+    let count = c_specpdl_index();
+
+    assert!(direction.abs() == 1);
+
+    let window: LispWindowRef = selected_window().into();
+    let current_buffer = ThreadState::current_buffer_unchecked();
+    let window_buffer = window.contents_as_buffer();
+    // If selected window's buffer isn't current, make it current for
+    // the moment.  But don't screw up if window_scroll gets an error.
+    if window_buffer != current_buffer {
+        unsafe {
+            record_unwind_protect(Some(save_excursion_restore), save_excursion_save());
+        }
+        set_buffer(window_buffer.into());
+    }
+
+    let (direction, whole_screen) = match n {
+        None => (direction, true),
+        Some(prefix) => {
+            if prefix.is_minus() {
+                (-direction, true)
+            } else {
+                let value = prefix.unwrap();
+                (value * direction, false)
+            }
+        }
+    };
+    unsafe {
+        window_scroll(current_window, direction, whole_screen, false);
+    }
+
+    unbind_to(count, Qnil);
 }
 
 /// Return new normal size of window WINDOW.
diff --git a/src/lisp.h b/src/lisp.h
index 7350c534df..081a0d0960 100644
--- a/src/lisp.h
+++ b/src/lisp.h
@@ -4628,6 +4628,9 @@ extern char *xstrdup (const char *) ATTRIBUTE_MALLOC;
 extern char *xlispstrdup (Lisp_Object) ATTRIBUTE_MALLOC;
 extern void dupstring (char **, char const *);
 
+extern void
+window_scroll (Lisp_Object window, EMACS_INT n, bool whole, bool noerror);
+
 /* Make DEST a copy of STRING's data.  Return a pointer to DEST's terminating
    null byte.  This is like stpcpy, except the source is a Lisp string.  */
 
diff --git a/src/window.c b/src/window.c
index 588f7c6441..c69c5e8e80 100644
--- a/src/window.c
+++ b/src/window.c
@@ -68,7 +68,6 @@ static void apply_window_adjustment (struct window *);
 void wset_window_parameters (struct window *, Lisp_Object);
 void wset_update_mode_line (struct window *);
 Lisp_Object set_window_hscroll (struct window *, EMACS_INT);
-void scroll_command (Lisp_Object, int);
 
 /* This is the window in which the terminal's cursor should
    be left when nothing is being done with it.  This must
@@ -3864,7 +3863,7 @@ window_internal_height (struct window *w)
    means don't signal an error if we try to move over BEGV or ZV,
    respectively.  */
 
-static void
+void
 window_scroll (Lisp_Object window, EMACS_INT n, bool whole, bool noerror)
 {
   ptrdiff_t count = SPECPDL_INDEX ();
@@ -4527,41 +4526,6 @@ window_scroll_line_based (Lisp_Object window, int n, bool whole, bool noerror)
 		  : Fmarker_position (w->pointm)),
 		 w->contents);
 }
-
-
-/* Scroll selected_window up or down.  If N is nil, scroll a
-   screen-full which is defined as the height of the window minus
-   next_screen_context_lines.  If N is the symbol `-', scroll.
-   DIRECTION may be 1 meaning to scroll down, or -1 meaning to scroll
-   up.  This is the guts of Fscroll_up and Fscroll_down.  */
-
-void
-scroll_command (Lisp_Object n, int direction)
-{
-  ptrdiff_t count = SPECPDL_INDEX ();
-
-  eassert (eabs (direction) == 1);
-
-  /* If selected window's buffer isn't current, make it current for
-     the moment.  But don't screw up if window_scroll gets an error.  */
-  if (XBUFFER (XWINDOW (selected_window)->contents) != current_buffer)
-    {
-      record_unwind_protect (save_excursion_restore, save_excursion_save ());
-      Fset_buffer (XWINDOW (selected_window)->contents);
-    }
-
-  if (NILP (n))
-    window_scroll (selected_window, direction, true, false);
-  else if (EQ (n, Qminus))
-    window_scroll (selected_window, -direction, true, false);
-  else
-    {
-      n = Fprefix_numeric_value (n);
-      window_scroll (selected_window, XINT (n) * direction, false, false);
-    }
-
-  unbind_to (count, Qnil);
-}
 
 DEFUN ("other-window-for-scrolling", Fother_window_for_scrolling, Sother_window_for_scrolling, 0, 0, 0,
        doc: /* Return the other window for \"other window scroll\" commands.
-- 
2.21.0


From aad67bd2f08ee74bfa7330fefdb660d24c8ca6f1 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Saulius=20Menkevi=C4=8Dius?=
 <sauliusmenkevicius@fastmail.com>
Date: Tue, 12 Mar 2019 18:53:50 +0200
Subject: [PATCH 296/297] Port window-fringes and set-window-fringes  (#1367)

---
 rust_src/src/windows.rs            | 72 ++++++++++++++++++++++++++++--
 src/window.c                       | 49 +-------------------
 src/window.h                       |  3 ++
 test/rust_src/src/windows-tests.el | 40 +++++++++++++++++
 4 files changed, 113 insertions(+), 51 deletions(-)

diff --git a/rust_src/src/windows.rs b/rust_src/src/windows.rs
index 2788c9c7eb..102bfb913c 100644
--- a/rust_src/src/windows.rs
+++ b/rust_src/src/windows.rs
@@ -20,12 +20,12 @@ use crate::{
     remacs_sys::globals,
     remacs_sys::glyph_row_area::TEXT_AREA,
     remacs_sys::{
-        estimate_mode_line_height, minibuf_level,
+        apply_window_adjustment, estimate_mode_line_height, minibuf_level,
         minibuf_selected_window as current_minibuf_window, noninteractive, record_unwind_protect,
         save_excursion_restore, save_excursion_save, select_window,
-        selected_window as current_window, set_buffer_internal, set_window_hscroll,
-        update_mode_lines, window_list_1, window_menu_bar_p, window_scroll, window_tool_bar_p,
-        windows_or_buffers_changed, wset_redisplay,
+        selected_window as current_window, set_buffer_internal, set_window_fringes,
+        set_window_hscroll, update_mode_lines, window_list_1, window_menu_bar_p, window_scroll,
+        window_tool_bar_p, windows_or_buffers_changed, wset_redisplay,
     },
     remacs_sys::{face_id, glyph_matrix, glyph_row, pvec_type, vertical_scroll_bar_type},
     remacs_sys::{EmacsDouble, EmacsInt, Lisp_Type, Lisp_Window},
@@ -527,6 +527,24 @@ impl LispWindowRef {
                 0
             }
     }
+
+    /// Equivalent to WINDOW_LEFT_FRINGE_WIDTH
+    pub fn get_left_fringe_width(self) -> i32 {
+        if self.left_fringe_width >= 0 {
+            self.left_fringe_width
+        } else {
+            self.get_frame().left_fringe_width
+        }
+    }
+
+    /// Equivalent to WINDOW_RIGHT_FRINGE_WIDTH
+    pub fn get_right_fringe_width(self) -> i32 {
+        if self.right_fringe_width >= 0 {
+            self.right_fringe_width
+        } else {
+            self.get_frame().right_fringe_width
+        }
+    }
 }
 
 impl From<LispObject> for LispWindowRef {
@@ -1840,4 +1858,50 @@ pub fn window_pixel_top(window: LispWindowValidOrSelected) -> EmacsInt {
     window.pixel_top.into()
 }
 
+/// Get width of fringes of window WINDOW.
+/// WINDOW must be a live window and defaults to the selected one.
+#[lisp_fn(min = "0")]
+pub fn window_fringes(window: LispWindowLiveOrSelected) -> LispObject {
+    let window: LispWindowRef = window.into();
+
+    list!(
+        window.get_left_fringe_width(),
+        window.get_right_fringe_width(),
+        window.fringes_outside_margins()
+    )
+}
+
+/// Set the fringe widths of window WINDOW.
+/// WINDOW must be a live window and defaults to the selected one.
+///
+/// Second arg LEFT-WIDTH specifies the number of pixels to reserve for
+/// the left fringe.  Optional third arg RIGHT-WIDTH specifies the right
+/// fringe width.  If a fringe width arg is nil, that means to use the
+/// frame's default fringe width.  Default fringe widths can be set with
+/// the command `set-fringe-style'.
+/// If optional fourth arg OUTSIDE-MARGINS is non-nil, draw the fringes
+/// outside of the display margins.  By default, fringes are drawn between
+/// display marginal areas and the text area.
+///
+/// Return t if any fringe was actually changed and nil otherwise.
+#[lisp_fn(name = "set-window-fringes", min = "2")]
+pub fn set_window_fringes_lisp(
+    window: LispWindowLiveOrSelected,
+    left_width: LispObject,
+    right_width: LispObject,
+    outside_margins: LispObject,
+) -> bool {
+    let mut window: LispWindowRef = window.into();
+
+    let updated_window =
+        unsafe { set_window_fringes(window.as_mut(), left_width, right_width, outside_margins) };
+
+    if !updated_window.is_null() {
+        unsafe { apply_window_adjustment(updated_window.into()) };
+        true
+    } else {
+        false
+    }
+}
+
 include!(concat!(env!("OUT_DIR"), "/windows_exports.rs"));
diff --git a/src/window.c b/src/window.c
index c69c5e8e80..0aa9ddafd3 100644
--- a/src/window.c
+++ b/src/window.c
@@ -56,14 +56,11 @@ static void window_resize_apply (struct window *, bool);
 static void select_window_1 (Lisp_Object, bool);
 static void run_window_configuration_change_hook (struct frame *);
 
-static struct window *set_window_fringes (struct window *, Lisp_Object,
-					  Lisp_Object, Lisp_Object);
 static struct window *set_window_margins (struct window *, Lisp_Object,
 					  Lisp_Object);
 static struct window *set_window_scroll_bars (struct window *, Lisp_Object,
 					      Lisp_Object, Lisp_Object,
 					      Lisp_Object);
-static void apply_window_adjustment (struct window *);
 
 void wset_window_parameters (struct window *, Lisp_Object);
 void wset_update_mode_line (struct window *);
@@ -5701,7 +5698,7 @@ saved by this function.  */)
 
 /* Called after W's margins, fringes or scroll bars was adjusted.  */
 
-static void
+void
 apply_window_adjustment (struct window *w)
 {
   eassert (w);
@@ -5778,7 +5775,7 @@ Return t if any margin was actually changed and nil otherwise.  */)
 			    Fringes
  ***********************************************************************/
 
-static struct window *
+struct window *
 set_window_fringes (struct window *w, Lisp_Object left_width,
 		    Lisp_Object right_width, Lisp_Object outside_margins)
 {
@@ -5813,46 +5810,6 @@ set_window_fringes (struct window *w, Lisp_Object left_width,
     return NULL;
 }
 
-DEFUN ("set-window-fringes", Fset_window_fringes, Sset_window_fringes,
-       2, 4, 0,
-       doc: /* Set the fringe widths of window WINDOW.
-WINDOW must be a live window and defaults to the selected one.
-
-Second arg LEFT-WIDTH specifies the number of pixels to reserve for
-the left fringe.  Optional third arg RIGHT-WIDTH specifies the right
-fringe width.  If a fringe width arg is nil, that means to use the
-frame's default fringe width.  Default fringe widths can be set with
-the command `set-fringe-style'.
-If optional fourth arg OUTSIDE-MARGINS is non-nil, draw the fringes
-outside of the display margins.  By default, fringes are drawn between
-display marginal areas and the text area.
-
-Return t if any fringe was actually changed and nil otherwise.  */)
-  (Lisp_Object window, Lisp_Object left_width,
-   Lisp_Object right_width, Lisp_Object outside_margins)
-{
-  struct window *w
-    = set_window_fringes (decode_live_window (window),
-			  left_width, right_width, outside_margins);
-  return w ? (apply_window_adjustment (w), Qt) : Qnil;
-}
-
-
-DEFUN ("window-fringes", Fwindow_fringes, Swindow_fringes,
-       0, 1, 0,
-       doc: /* Get width of fringes of window WINDOW.
-WINDOW must be a live window and defaults to the selected one.
-
-Value is a list of the form (LEFT-WIDTH RIGHT-WIDTH OUTSIDE-MARGINS).  */)
-  (Lisp_Object window)
-{
-  struct window *w = decode_live_window (window);
-
-  return list3 (make_number (WINDOW_LEFT_FRINGE_WIDTH (w)),
-		make_number (WINDOW_RIGHT_FRINGE_WIDTH (w)),
-		WINDOW_HAS_FRINGES_OUTSIDE_MARGINS (w) ? Qt : Qnil);
-}
-
 
 
 /***********************************************************************
@@ -6372,8 +6329,6 @@ displayed after a scrolling operation to be somewhat inaccurate.  */);
   defsubr (&Sset_window_configuration);
   defsubr (&Scurrent_window_configuration);
   defsubr (&Sset_window_margins);
-  defsubr (&Sset_window_fringes);
-  defsubr (&Swindow_fringes);
   defsubr (&Sset_window_scroll_bars);
   defsubr (&Swindow_scroll_bars);
   defsubr (&Swindow_vscroll);
diff --git a/src/window.h b/src/window.h
index b99107e783..2403d0a22e 100644
--- a/src/window.h
+++ b/src/window.h
@@ -1125,6 +1125,9 @@ extern void syms_of_window (void);
 extern void keys_of_window (void);
 extern Lisp_Object select_window (Lisp_Object window, Lisp_Object norecord,
                                   bool inhibit_point_swap);
+extern struct window *set_window_fringes (struct window *w, Lisp_Object left_width,
+                                          Lisp_Object right_width, Lisp_Object outside_margins);
+extern void apply_window_adjustment (struct window *);
 
 /* Move cursor to row/column position VPOS/HPOS, pixel coordinates
    Y/X. HPOS/VPOS are window-relative row and column numbers and X/Y
diff --git a/test/rust_src/src/windows-tests.el b/test/rust_src/src/windows-tests.el
index b9c5d1d07c..25da0aa7d9 100644
--- a/test/rust_src/src/windows-tests.el
+++ b/test/rust_src/src/windows-tests.el
@@ -105,3 +105,43 @@
   (should (= 1.0 (window-normal-size w1 't)))
   (should (= 0.5 (window-normal-size w2)))
   (should (= 1.0 (window-normal-size w2 't)))))
+
+(ert-deftest window-pixel-top ()
+  (skip-unless (display-graphic-p))
+  (let ((w1 (selected-window))
+        (w2 (split-window-vertically)))
+    (should (= (window-pixel-top) (window-pixel-top w1)))
+    (should-not (= (window-pixel-top w1) (window-pixel-top w2)))))
+
+(ert-deftest window-fringes ()
+  (skip-unless (display-graphic-p))
+  (let ((w1 (selected-window))
+        (w2 (split-window)))
+    (set-window-fringes w1 4 4 nil)
+    (set-window-fringes w2 16 16 t)
+    (should (equal `(4 4 nil) (window-fringes w1)))
+    (should (equal `(4 4 nil) (window-fringes nil)))
+    (should (equal `(16 16 t) (window-fringes w2)))))
+
+(ert-deftest set-window-fringes ()
+  (skip-unless (display-graphic-p))
+  (let ((w1 (selected-window))
+        (w2 (split-window)))
+    (set-window-fringes w1 4 4 nil)
+    (set-window-fringes w2 16 16 t)
+    (should (equal `(4 4 nil) (window-fringes w1)))
+    (should (equal `(4 4 nil) (window-fringes nil)))
+    (set-window-fringes nil 8 8 nil)
+    (should (equal `(8 8 nil) (window-fringes w1)))
+    (should (equal `(8 8 nil) (window-fringes nil)))
+    (should (equal `(16 16 t) (window-fringes w2)))
+    (set-window-fringes w2 15)
+    (should (equal `(15 8 nil) (window-fringes w2)))
+    (set-window-fringes w2 15 15)
+    (should (equal `(15 15 nil) (window-fringes w2)))
+
+    ;; invoking set-window-fringes with the same params would
+    ;; not change window fringe properties and should return nil
+    (should (set-window-fringes w1 1 1 nil))
+    (should-not (set-window-fringes w1 1 1 nil))
+    (should (set-window-fringes w1 1 2 nil))))
-- 
2.21.0


From fd432aee2286281e6b1b279388684288f3a82284 Mon Sep 17 00:00:00 2001
From: Jonathan Villemaire-Krajden <jonathan@j-vk.com>
Date: Sun, 10 Mar 2019 13:23:47 +0100
Subject: [PATCH 297/297] Port buffer-enable-undo

---
 rust_src/src/buffers.rs | 11 +++++++++++
 src/buffer.c            | 24 ------------------------
 2 files changed, 11 insertions(+), 24 deletions(-)

diff --git a/rust_src/src/buffers.rs b/rust_src/src/buffers.rs
index 23cf91680d..087fe245a2 100644
--- a/rust_src/src/buffers.rs
+++ b/rust_src/src/buffers.rs
@@ -924,6 +924,17 @@ impl From<LispBufferOrCurrent> for LispBufferRef {
     }
 }
 
+/// Return false.
+/// If the optional arg BUFFER is provided and not nil, enable undoes in that
+/// buffer, otherwise run on the current buffer.
+#[lisp_fn(min = "0", intspec = "")]
+pub fn buffer_enable_undo(buffer: LispBufferOrCurrent) {
+    let mut buf: LispBufferRef = buffer.into();
+    if buf.undo_list_.eq(Qt) {
+        buf.undo_list_ = Qnil;
+    }
+}
+
 /// Return a list of all live buffers.
 /// If the optional arg FRAME is a frame, return the buffer list in the
 /// proper order for that frame: the buffers shown in FRAME come first,
diff --git a/src/buffer.c b/src/buffer.c
index 52fca3d457..2aad84f427 100644
--- a/src/buffer.c
+++ b/src/buffer.c
@@ -1115,29 +1115,6 @@ other_buffer_safely (Lisp_Object buffer)
   return buf;
 }
 
-DEFUN ("buffer-enable-undo", Fbuffer_enable_undo, Sbuffer_enable_undo,
-       0, 1, "",
-       doc: /* Start keeping undo information for buffer BUFFER.
-No argument or nil as argument means do this for the current buffer.  */)
-  (register Lisp_Object buffer)
-{
-  Lisp_Object real_buffer;
-
-  if (NILP (buffer))
-    XSETBUFFER (real_buffer, current_buffer);
-  else
-    {
-      real_buffer = Fget_buffer (buffer);
-      if (NILP (real_buffer))
-	nsberror (buffer);
-    }
-
-  if (EQ (BVAR (XBUFFER (real_buffer), undo_list), Qt))
-    bset_undo_list (XBUFFER (real_buffer), Qnil);
-
-  return Qnil;
-}
-
 /* Truncate undo list and shrink the gap of BUFFER.  */
 
 void
@@ -5606,7 +5583,6 @@ Functions running this hook are, `get-buffer-create',
   defsubr (&Sbuffer_local_variables);
   defsubr (&Sset_buffer_modified_p);
   defsubr (&Sother_buffer);
-  defsubr (&Sbuffer_enable_undo);
   defsubr (&Skill_buffer);
   defsubr (&Sbury_buffer_internal);
   defsubr (&Sset_buffer_major_mode);
-- 
2.21.0

