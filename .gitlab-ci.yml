# Copyright (C) 2017-2018 Free Software Foundation, Inc.
#
#  This file is part of GNU Emacs.
#
#  GNU Emacs is free software: you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation, either version 3 of the License, or
#  (at your option) any later version.
#
#  GNU Emacs is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with GNU Emacs.  If not, see <https://www.gnu.org/licenses/>.

# GNU Emacs support for the GitLab protocol for CI

# The presence of this file does not imply any FSF/GNU endorsement of
# any particular service that uses that protocol.  Also, it is intended for
# evaluation purposes, thus possibly temporary.

# This version is based on <https://gitlab.com/emacs-ci/emacs>, modified
# to work with the Remacs additions

# based on Debian
image: rust:latest


stages:
  - build
  - test

build:
  stage: build
  image: rust:latest
  variables:
    GIT_STRATEGY: fetch
  cache:
    paths:
      - config.cache
  before_script:
    - apt update -qq
    - apt install --no-install-recommends -y -qq -o=Dpkg::Use-Pty=0 libc-dev gcc make autoconf automake libncurses-dev gnutls-dev build-essential clang libclang-dev texinfo libjpeg-dev libtiff-dev libgif-dev libxpm-dev libgtk-3-dev libgnutls30-dev libxml2-dev libxt-dev
  script:
    - rustc --version && cargo --version && gcc --version
    - ./autogen.sh
    # FIXME lots of errors coming from upstream
    # - RUST_BACKTRACE=1 RUSTFLAGS="-Dwarnings" WERROR_CFLAGS='-Werror -Wno-error=deprecated-declarations' ./configure --without-makeinfo --enable-rust-debug --with-x=no --with-ns=no --without-gconf --without-gsettings
    - RUST_BACKTRACE=1 RUSTFLAGS="-Dwarnings" WERROR_CFLAGS='-Wno-error=missing-prototypes -Wno-error=deprecated-declarations' ./configure --without-makeinfo --enable-rust-debug --with-x=no --with-ns=no --without-gconf --without-gsettings --cache-file=config.cache
    - make -j 3
  after_script:
    - if [ -x src/emacs ] ; then ./make-dist --tests --no-update --no-changelog ; fi
    - mv emacs-* emacs-dist
    - for f in src/emacs lib-src/*[^.]? {,**/}Makefile etc/charsets/* ; do [ -r emacs-dist/$f ] || ln $f emacs-dist/$f ; done
  artifacts:
    paths:
    - emacs-dist/
    expire_in: 1 day

test:
  stage: test
  image: rust:latest
  before_script:
    - apt update -qq
  script:
    - make -C emacs-dist/test check
